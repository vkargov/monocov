<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - mini/mini-trampolines.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">mini</a> - mini-trampolines.c<span style="font-size: 80%;"> (source / <a href="mini-trampolines.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">669</td>
            <td class="headerCovTableEntry">853</td>
            <td class="headerCovTableEntryMed">78.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntry">40</td>
            <td class="headerCovTableEntryMed">85.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * (C) 2003 Ximian, Inc.
<span class="lineNum">       3 </span>            :  * (C) 2003-2011 Novell, Inc.
<span class="lineNum">       4 </span>            :  * Copyright 2011 Xamarin, Inc (http://www.xamarin.com)
<span class="lineNum">       5 </span>            :  * Licensed under the MIT license. See LICENSE file in the project root for full license information.
<span class="lineNum">       6 </span>            :  */
<span class="lineNum">       7 </span>            : #include &lt;config.h&gt;
<span class="lineNum">       8 </span>            : #include &lt;glib.h&gt;
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : #include &lt;mono/metadata/appdomain.h&gt;
<span class="lineNum">      11 </span>            : #include &lt;mono/metadata/metadata-internals.h&gt;
<span class="lineNum">      12 </span>            : #include &lt;mono/metadata/marshal.h&gt;
<span class="lineNum">      13 </span>            : #include &lt;mono/metadata/tabledefs.h&gt;
<span class="lineNum">      14 </span>            : #include &lt;mono/utils/mono-counters.h&gt;
<span class="lineNum">      15 </span>            : #include &lt;mono/utils/mono-error-internals.h&gt;
<span class="lineNum">      16 </span>            : #include &lt;mono/utils/mono-membar.h&gt;
<span class="lineNum">      17 </span>            : #include &lt;mono/utils/mono-compiler.h&gt;
<span class="lineNum">      18 </span>            : #include &lt;mono/utils/mono-threads-coop.h&gt;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;mini.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;lldb.h&quot;
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : /*
<span class="lineNum">      24 </span>            :  * Address of the trampoline code.  This is used by the debugger to check
<span class="lineNum">      25 </span>            :  * whether a method is a trampoline.
<span class="lineNum">      26 </span>            :  */
<span class="lineNum">      27 </span>            : guint8* mono_trampoline_code [MONO_TRAMPOLINE_NUM];
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : static GHashTable *rgctx_lazy_fetch_trampoline_hash;
<span class="lineNum">      30 </span>            : static GHashTable *rgctx_lazy_fetch_trampoline_hash_addr;
<span class="lineNum">      31 </span>            : static guint32 trampoline_calls, jit_trampolines, unbox_trampolines, static_rgctx_trampolines;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #define mono_trampolines_lock() mono_os_mutex_lock (&amp;trampolines_mutex)
<span class="lineNum">      34 </span>            : #define mono_trampolines_unlock() mono_os_mutex_unlock (&amp;trampolines_mutex)
<span class="lineNum">      35 </span>            : static mono_mutex_t trampolines_mutex;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #ifdef MONO_ARCH_GSHARED_SUPPORTED
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : typedef struct {
<span class="lineNum">      40 </span>            :         MonoMethod *m;
<span class="lineNum">      41 </span>            :         gpointer addr;
<span class="lineNum">      42 </span>            : } RgctxTrampInfo;
<a name="43"><span class="lineNum">      43 </span>            : </a>
<span class="lineNum">      44 </span>            : static gint
<span class="lineNum">      45 </span>            : rgctx_tramp_info_equal (gconstpointer ka, gconstpointer kb)
<span class="lineNum">      46 </span>            : {
<span class="lineNum">      47 </span><span class="lineCov">    1535237 :         const RgctxTrampInfo *i1 = (const RgctxTrampInfo *)ka;</span>
<span class="lineNum">      48 </span><span class="lineCov">    1535237 :         const RgctxTrampInfo *i2 = (const RgctxTrampInfo *)kb;</span>
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span><span class="lineCov">    1628300 :         if (i1-&gt;m == i2-&gt;m &amp;&amp; i1-&gt;addr == i2-&gt;addr)</span>
<span class="lineNum">      51 </span><span class="lineCov">      92871 :                 return 1;</span>
<span class="lineNum">      52 </span>            :         else
<span class="lineNum">      53 </span><span class="lineCov">    1442366 :                 return 0;</span>
<span class="lineNum">      54 </span><span class="lineCov">    1535237 : }</span>
<a name="55"><span class="lineNum">      55 </span>            : </a>
<span class="lineNum">      56 </span>            : static guint
<span class="lineNum">      57 </span>            : rgctx_tramp_info_hash (gconstpointer data)
<span class="lineNum">      58 </span>            : {
<span class="lineNum">      59 </span><span class="lineCov">    1306303 :         const RgctxTrampInfo *info = (const RgctxTrampInfo *)data;</span>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span><span class="lineCov">    1306303 :         return GPOINTER_TO_UINT (info-&gt;m) ^ GPOINTER_TO_UINT (info-&gt;addr);</span>
<span class="lineNum">      62 </span>            : }
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : /**
<span class="lineNum">      65 </span>            :  * mono_create_static_rgctx_trampoline:
<span class="lineNum">      66 </span>            :  * @m: the mono method to create a trampoline for
<span class="lineNum">      67 </span>            :  * @addr: the address to jump to (where the compiled code for M lives)
<span class="lineNum">      68 </span>            :  *
<span class="lineNum">      69 </span>            :  * Creates a static rgctx trampoline for M which branches to ADDR which should
<span class="lineNum">      70 </span>            :  * point to the compiled code of M.
<span class="lineNum">      71 </span>            :  *
<span class="lineNum">      72 </span>            :  * Static rgctx trampolines are used when a shared generic method which doesn't
<span class="lineNum">      73 </span>            :  * have a this argument is called indirectly, ie. from code which can't pass in
<span class="lineNum">      74 </span>            :  * the rgctx argument. The trampoline sets the rgctx argument and jumps to the
<span class="lineNum">      75 </span>            :  * methods code. These trampolines are similar to the unbox trampolines, they
<span class="lineNum">      76 </span>            :  * perform the same task as the static rgctx wrappers, but they are smaller/faster,
<span class="lineNum">      77 </span>            :  * and can be made to work with full AOT.
<span class="lineNum">      78 </span>            :  *
<span class="lineNum">      79 </span>            :  * On PPC addr should be an ftnptr and the return value is an ftnptr too.
<span class="lineNum">      80 </span>            :  *
<span class="lineNum">      81 </span>            :  * Returns the generated static rgctx trampoline.
<a name="82"><span class="lineNum">      82 </span>            :  */</a>
<span class="lineNum">      83 </span>            : gpointer
<span class="lineNum">      84 </span>            : mono_create_static_rgctx_trampoline (MonoMethod *m, gpointer addr)
<span class="lineNum">      85 </span>            : {
<span class="lineNum">      86 </span>            :         gpointer ctx;
<span class="lineNum">      87 </span>            :         gpointer res;
<span class="lineNum">      88 </span>            :         MonoDomain *domain;
<span class="lineNum">      89 </span>            :         RgctxTrampInfo tmp_info;
<span class="lineNum">      90 </span>            :         RgctxTrampInfo *info;
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            : #ifdef PPC_USES_FUNCTION_DESCRIPTOR
<span class="lineNum">      93 </span>            :         g_assert (((gpointer*)addr) [2] == 0);
<span class="lineNum">      94 </span>            : #endif
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineCov">     570711 :         ctx = mini_method_get_rgctx (m);</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span><span class="lineCov">     570711 :         domain = mono_domain_get ();</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :         /* 
<span class="lineNum">     101 </span>            :          * In the AOT case, addr might point to either the method, or to an unbox trampoline,
<span class="lineNum">     102 </span>            :          * so make the hash keyed on the m+addr pair.
<span class="lineNum">     103 </span>            :          */
<span class="lineNum">     104 </span><span class="lineCov">     570711 :         mono_domain_lock (domain);</span>
<span class="lineNum">     105 </span><span class="lineCov">     570711 :         if (!domain_jit_info (domain)-&gt;static_rgctx_trampoline_hash)</span>
<span class="lineNum">     106 </span><span class="lineCov">       3518 :                 domain_jit_info (domain)-&gt;static_rgctx_trampoline_hash = g_hash_table_new (rgctx_tramp_info_hash, rgctx_tramp_info_equal);</span>
<span class="lineNum">     107 </span><span class="lineCov">     570711 :         tmp_info.m = m;</span>
<span class="lineNum">     108 </span><span class="lineCov">     570711 :         tmp_info.addr = addr;</span>
<span class="lineNum">     109 </span><span class="lineCov">    1141422 :         res = g_hash_table_lookup (domain_jit_info (domain)-&gt;static_rgctx_trampoline_hash,</span>
<span class="lineNum">     110 </span><span class="lineCov">     570711 :                                                            &amp;tmp_info);</span>
<span class="lineNum">     111 </span><span class="lineCov">     570711 :         mono_domain_unlock (domain);</span>
<span class="lineNum">     112 </span><span class="lineCov">     570711 :         if (res)</span>
<span class="lineNum">     113 </span><span class="lineCov">      91175 :                 return res;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">     479536 :         if (mono_aot_only)</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                 res = mono_aot_get_static_rgctx_trampoline (ctx, addr);</span>
<span class="lineNum">     117 </span>            :         else
<span class="lineNum">     118 </span><span class="lineCov">     479536 :                 res = mono_arch_get_static_rgctx_trampoline (m, (MonoMethodRuntimeGenericContext *)ctx, addr);</span>
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span><span class="lineCov">     479536 :         mono_domain_lock (domain);</span>
<span class="lineNum">     121 </span>            :         /* Duplicates inserted while we didn't hold the lock are OK */
<span class="lineNum">     122 </span><span class="lineCov">     479536 :         info = (RgctxTrampInfo *)mono_domain_alloc (domain, sizeof (RgctxTrampInfo));</span>
<span class="lineNum">     123 </span><span class="lineCov">     479536 :         info-&gt;m = m;</span>
<span class="lineNum">     124 </span><span class="lineCov">     479536 :         info-&gt;addr = addr;</span>
<span class="lineNum">     125 </span><span class="lineCov">     479536 :         g_hash_table_insert (domain_jit_info (domain)-&gt;static_rgctx_trampoline_hash, info, res);</span>
<span class="lineNum">     126 </span><span class="lineCov">     479536 :         mono_domain_unlock (domain);</span>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineCov">     479536 :         static_rgctx_trampolines ++;</span>
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineCov">     479536 :         return res;</span>
<span class="lineNum">     131 </span><span class="lineCov">     570711 : }</span>
<span class="lineNum">     132 </span>            : #else
<span class="lineNum">     133 </span>            : gpointer
<span class="lineNum">     134 </span>            : mono_create_static_rgctx_trampoline (MonoMethod *m, gpointer addr)
<span class="lineNum">     135 </span>            : {
<span class="lineNum">     136 </span>            :        /* 
<span class="lineNum">     137 </span>            :         * This shouldn't happen as all arches which support generic sharing support
<span class="lineNum">     138 </span>            :         * static rgctx trampolines as well.
<span class="lineNum">     139 </span>            :         */
<span class="lineNum">     140 </span>            :        g_assert_not_reached ();
<span class="lineNum">     141 </span>            : }
<span class="lineNum">     142 </span>            : #endif
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span>            : #if 0
<span class="lineNum">     145 </span>            : #define DEBUG_IMT(stmt) do { stmt; } while (0)
<span class="lineNum">     146 </span>            : #else
<span class="lineNum">     147 </span>            : #define DEBUG_IMT(stmt) do { } while (0)
<span class="lineNum">     148 </span>            : #endif
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span>            : /*
<span class="lineNum">     151 </span>            :  * mini_resolve_imt_method:
<span class="lineNum">     152 </span>            :  *
<span class="lineNum">     153 </span>            :  *   Resolve the actual method called when making an IMT call through VTABLE_SLOT with IMT_METHOD as the interface method.
<span class="lineNum">     154 </span>            :  *
<span class="lineNum">     155 </span>            :  * Either IMPL_METHOD or OUT_AOT_ADDR will be set on return.
<a name="156"><span class="lineNum">     156 </span>            :  */</a>
<span class="lineNum">     157 </span>            : gpointer*
<span class="lineNum">     158 </span>            : mini_resolve_imt_method (MonoVTable *vt, gpointer *vtable_slot, MonoMethod *imt_method, MonoMethod **impl_method, gpointer *out_aot_addr, gboolean *out_need_rgctx_tramp, MonoMethod **variant_iface, MonoError *error)
<span class="lineNum">     159 </span>            : {
<span class="lineNum">     160 </span><span class="lineCov">    1193737 :         MonoMethod *impl = NULL, *generic_virtual = NULL;</span>
<span class="lineNum">     161 </span><span class="lineCov">    1193737 :         gboolean lookup_aot, variance_used = FALSE, need_rgctx_tramp = FALSE;</span>
<span class="lineNum">     162 </span>            :         gpointer addr;
<span class="lineNum">     163 </span><span class="lineCov">    1193737 :         guint8 *aot_addr = NULL;</span>
<span class="lineNum">     164 </span><span class="lineCov">    1193737 :         int displacement = vtable_slot - ((gpointer*)vt);</span>
<span class="lineNum">     165 </span>            :         int interface_offset;
<span class="lineNum">     166 </span><span class="lineCov">    1193737 :         int imt_slot = MONO_IMT_SIZE + displacement;</span>
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineCov">    3581220 :         g_assert (imt_slot &lt; MONO_IMT_SIZE);</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineCov">    1193667 :         mono_error_init (error);</span>
<span class="lineNum">     171 </span>            :         /* This has to be variance aware since imt_method can be from an interface that vt-&gt;klass doesn't directly implement */
<span class="lineNum">     172 </span><span class="lineCov">    1193667 :         interface_offset = mono_class_interface_offset_with_variance (vt-&gt;klass, imt_method-&gt;klass, &amp;variance_used);</span>
<span class="lineNum">     173 </span><span class="lineCov">    1193667 :         if (interface_offset &lt; 0)</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :                 g_error (&quot;%s doesn't implement interface %s\n&quot;, mono_type_get_name_full (&amp;vt-&gt;klass-&gt;byval_arg, MONO_TYPE_NAME_FORMAT_IL), mono_type_get_name_full (&amp;imt_method-&gt;klass-&gt;byval_arg, MONO_TYPE_NAME_FORMAT_IL));</span>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineCov">    1193637 :         *variant_iface = NULL;</span>
<span class="lineNum">     177 </span><span class="lineCov">    1791502 :         if (imt_method-&gt;is_inflated &amp;&amp; ((MonoMethodInflated*)imt_method)-&gt;context.method_inst) {</span>
<span class="lineNum">     178 </span>            :                 /* Generic virtual method */
<span class="lineNum">     179 </span><span class="lineCov">       3650 :                 generic_virtual = imt_method;</span>
<span class="lineNum">     180 </span><span class="lineCov">       3650 :                 need_rgctx_tramp = TRUE;</span>
<span class="lineNum">     181 </span><span class="lineCov">    1415294 :         } else if (variance_used &amp;&amp; mono_class_has_variant_generic_params (imt_method-&gt;klass)) {</span>
<span class="lineNum">     182 </span><span class="lineCov">     221277 :                 *variant_iface = imt_method;</span>
<span class="lineNum">     183 </span><span class="lineCov">     221277 :         }</span>
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span><span class="lineCov">    1193699 :         addr = NULL;</span>
<span class="lineNum">     186 </span>            :         /* We can only use the AOT compiled code if we don't require further processing */
<span class="lineNum">     187 </span><span class="lineCov">    1193699 :         lookup_aot = !generic_virtual &amp; !variant_iface;</span>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">    1193699 :         if (!mono_llvm_only)</span>
<span class="lineNum">     190 </span><span class="lineCov">    1193707 :                 mono_vtable_build_imt_slot (vt, mono_method_get_imt_slot (imt_method));</span>
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineCov">    1791809 :         if (imt_method-&gt;is_inflated &amp;&amp; ((MonoMethodInflated*)imt_method)-&gt;context.method_inst) {</span>
<span class="lineNum">     193 </span><span class="lineCov">       3654 :                 MonoGenericContext context = { NULL, NULL };</span>
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :                 /*
<span class="lineNum">     196 </span>            :                  * Generic virtual method, imt_method contains the inflated interface
<span class="lineNum">     197 </span>            :                  * method, need to get the inflated impl method.
<span class="lineNum">     198 </span>            :                  */
<span class="lineNum">     199 </span>            :                 /* imt_method-&gt;slot might not be set */
<span class="lineNum">     200 </span><span class="lineCov">       3654 :                 impl = mono_class_get_vtable_entry (vt-&gt;klass, interface_offset + mono_method_get_declaring_generic_method (imt_method)-&gt;slot);</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineCov">       3654 :                 if (mono_class_is_ginst (impl-&gt;klass))</span>
<span class="lineNum">     203 </span><span class="lineCov">       3496 :                         context.class_inst = mono_class_get_generic_class (impl-&gt;klass)-&gt;context.class_inst;</span>
<span class="lineNum">     204 </span><span class="lineCov">       3654 :                 context.method_inst = ((MonoMethodInflated*)imt_method)-&gt;context.method_inst;</span>
<span class="lineNum">     205 </span><span class="lineCov">       3654 :                 impl = mono_class_inflate_generic_method_checked (impl, &amp;context, error);</span>
<span class="lineNum">     206 </span><span class="lineCov">       3654 :                 mono_error_assert_ok (error);</span>
<span class="lineNum">     207 </span><span class="lineCov">       3654 :         } else {</span>
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span>            :                 /* Avoid loading metadata or creating a generic vtable if possible */
<span class="lineNum">     210 </span><span class="lineCov">    1190176 :                 if (lookup_aot &amp;&amp; !vt-&gt;klass-&gt;valuetype) {</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :                         aot_addr = (guint8 *)mono_aot_get_method_from_vt_slot (mono_domain_get (), vt, interface_offset + mono_method_get_vtable_slot (imt_method), error);</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     214 </span><span class="lineCov">    1190177 :                         aot_addr = NULL;</span>
<span class="lineNum">     215 </span>            :                 }
<span class="lineNum">     216 </span><span class="lineCov">    1190178 :                 if (aot_addr)</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                         impl = NULL;</span>
<span class="lineNum">     218 </span>            :                 else
<span class="lineNum">     219 </span><span class="lineCov">    1190178 :                         impl = mono_class_get_vtable_entry (vt-&gt;klass, interface_offset + mono_method_get_vtable_slot (imt_method));</span>
<span class="lineNum">     220 </span>            :         }
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineCov">    2387659 :         if (impl &amp;&amp; mono_method_needs_static_rgctx_invoke (impl, FALSE))</span>
<span class="lineNum">     223 </span><span class="lineCov">     112597 :                 need_rgctx_tramp = TRUE;</span>
<span class="lineNum">     224 </span><span class="lineCov">    2387658 :         if (impl &amp;&amp; impl-&gt;wrapper_type == MONO_WRAPPER_MANAGED_TO_MANAGED) {</span>
<span class="lineNum">     225 </span><span class="lineCov">      17013 :                 WrapperInfo *info = mono_marshal_get_wrapper_info (impl);</span>
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span><span class="lineCov">      34026 :                 if (info &amp;&amp; info-&gt;subtype == WRAPPER_SUBTYPE_GENERIC_ARRAY_HELPER)</span>
<span class="lineNum">     228 </span><span class="lineCov">      17013 :                         need_rgctx_tramp = TRUE;</span>
<span class="lineNum">     229 </span><span class="lineCov">      17013 :         }</span>
<span class="lineNum">     230 </span><span class="lineCov">    1193826 :         *impl_method = impl;</span>
<span class="lineNum">     231 </span><span class="lineCov">    1193826 :         *out_need_rgctx_tramp = need_rgctx_tramp;</span>
<span class="lineNum">     232 </span><span class="lineCov">    1193826 :         *out_aot_addr = aot_addr;</span>
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span><span class="lineCov">    2387655 :         DEBUG_IMT (printf (&quot;mono_convert_imt_slot_to_vtable_slot: method = %s.%s.%s, imt_method = %s.%s.%s\n&quot;,</span>
<span class="lineNum">     235 </span>            :                                            method-&gt;klass-&gt;name_space, method-&gt;klass-&gt;name, method-&gt;name,
<span class="lineNum">     236 </span>            :                                            imt_method-&gt;klass-&gt;name_space, imt_method-&gt;klass-&gt;name, imt_method-&gt;name));
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineCov">    1193825 :         if (vt-&gt;imt_collisions_bitmap &amp; (1 &lt;&lt; imt_slot)) {</span>
<span class="lineNum">     239 </span><span class="lineCov">    1116816 :                 int slot = mono_method_get_vtable_index (imt_method);</span>
<span class="lineNum">     240 </span>            :                 int vtable_offset;
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineCov">    3350455 :                 g_assert (slot != -1);</span>
<span class="lineNum">     243 </span><span class="lineCov">    1116819 :                 vtable_offset = interface_offset + slot;</span>
<span class="lineNum">     244 </span><span class="lineCov">    1116819 :                 vtable_slot = &amp; (vt-&gt;vtable [vtable_offset]);</span>
<span class="lineNum">     245 </span><span class="lineCov">    2233638 :                 DEBUG_IMT (printf (&quot;mono_convert_imt_slot_to_vtable_slot: slot %p[%d] is in the IMT, and colliding becomes %p[%d] (interface_offset = %d, method-&gt;slot = %d)\n&quot;, slot, imt_slot, vtable_slot, vtable_offset, interface_offset, imt_method-&gt;slot));</span>
<span class="lineNum">     246 </span><span class="lineCov">    1116819 :                 return vtable_slot;</span>
<span class="lineNum">     247 </span>            :         } else {
<span class="lineNum">     248 </span><span class="lineCov">     154020 :                 DEBUG_IMT (printf (&quot;mono_convert_imt_slot_to_vtable_slot: slot %p[%d] is in the IMT, but not colliding\n&quot;, slot, imt_slot));</span>
<span class="lineNum">     249 </span><span class="lineCov">      77010 :                 return vtable_slot;</span>
<span class="lineNum">     250 </span>            :         }
<span class="lineNum">     251 </span><span class="lineCov">    1193829 : }</span>
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span>            : /*
<span class="lineNum">     254 </span>            :  * This is a super-ugly hack to fix bug #616463.
<span class="lineNum">     255 </span>            :  *
<span class="lineNum">     256 </span>            :  * The problem is that we don't always set is_generic for generic
<span class="lineNum">     257 </span>            :  * method definitions.  See the comment at the end of
<span class="lineNum">     258 </span>            :  * mono_class_inflate_generic_method_full_checked() in class.c.
<a name="259"><span class="lineNum">     259 </span>            :  */</a>
<span class="lineNum">     260 </span>            : static gboolean
<span class="lineNum">     261 </span>            : is_generic_method_definition (MonoMethod *m)
<span class="lineNum">     262 </span>            : {
<span class="lineNum">     263 </span>            :         MonoGenericContext *context;
<span class="lineNum">     264 </span><span class="lineCov">    3791632 :         if (m-&gt;is_generic)</span>
<span class="lineNum">     265 </span><span class="lineCov">     108679 :                 return TRUE;</span>
<span class="lineNum">     266 </span><span class="lineCov">    3682932 :         if (!m-&gt;is_inflated)</span>
<span class="lineNum">     267 </span><span class="lineCov">    3508511 :                 return FALSE;</span>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineCov">     174506 :         context = mono_method_get_context (m);</span>
<span class="lineNum">     270 </span><span class="lineCov">     174506 :         if (!context-&gt;method_inst)</span>
<span class="lineNum">     271 </span><span class="lineCov">     174506 :                 return FALSE;</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         if (context-&gt;method_inst == mono_method_get_generic_container (((MonoMethodInflated*)m)-&gt;declaring)-&gt;context.method_inst)</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                 return TRUE;</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     275 </span><span class="lineCov">    3791491 : }</span>
<a name="276"><span class="lineNum">     276 </span>            : </a>
<span class="lineNum">     277 </span>            : gboolean
<span class="lineNum">     278 </span>            : mini_jit_info_is_gsharedvt (MonoJitInfo *ji)
<span class="lineNum">     279 </span>            : {
<span class="lineNum">     280 </span><span class="lineCov">   68747267 :         if (ji &amp;&amp; ji-&gt;has_generic_jit_info &amp;&amp; (mono_jit_info_get_generic_sharing_context (ji)-&gt;is_gsharedvt))</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :                 return TRUE;</span>
<span class="lineNum">     282 </span>            :         else
<span class="lineNum">     283 </span><span class="lineCov">   31913703 :                 return FALSE;</span>
<span class="lineNum">     284 </span><span class="lineCov">   31913764 : }</span>
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            : /**
<span class="lineNum">     287 </span>            :  * mini_add_method_trampoline:
<span class="lineNum">     288 </span>            :  * @m: 
<span class="lineNum">     289 </span>            :  * @compiled_method:
<span class="lineNum">     290 </span>            :  * @add_static_rgctx_tramp: adds a static rgctx trampoline
<span class="lineNum">     291 </span>            :  * @add_unbox_tramp: adds an unboxing trampoline
<span class="lineNum">     292 </span>            :  *
<span class="lineNum">     293 </span>            :  * Add static rgctx/gsharedvt_in/unbox trampolines to
<span class="lineNum">     294 </span>            :  * M/COMPILED_METHOD if needed.
<span class="lineNum">     295 </span>            :  *
<span class="lineNum">     296 </span>            :  * Returns the trampoline address, or COMPILED_METHOD if no trampoline
<span class="lineNum">     297 </span>            :  * is needed.
<a name="298"><span class="lineNum">     298 </span>            :  */</a>
<span class="lineNum">     299 </span>            : gpointer
<span class="lineNum">     300 </span>            : mini_add_method_trampoline (MonoMethod *m, gpointer compiled_method, gboolean add_static_rgctx_tramp, gboolean add_unbox_tramp)
<span class="lineNum">     301 </span>            : {
<span class="lineNum">     302 </span><span class="lineCov">   31913595 :         gpointer addr = compiled_method;</span>
<span class="lineNum">     303 </span>            :         gboolean callee_gsharedvt, callee_array_helper;
<span class="lineNum">     304 </span><span class="lineCov">   31913595 :         MonoMethod *jmethod = NULL;</span>
<span class="lineNum">     305 </span>            :         MonoJitInfo *ji;
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span>            :         // FIXME: This loads information from AOT (perf problem)
<span class="lineNum">     308 </span><span class="lineCov">   31913595 :         ji = mini_jit_info_table_find (mono_domain_get (), (char *)mono_get_addr_from_ftnptr (compiled_method), NULL);</span>
<span class="lineNum">     309 </span><span class="lineCov">   31913595 :         callee_gsharedvt = mini_jit_info_is_gsharedvt (ji);</span>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span><span class="lineCov">   31913595 :         callee_array_helper = FALSE;</span>
<span class="lineNum">     312 </span><span class="lineCov">   31913595 :         if (m-&gt;wrapper_type == MONO_WRAPPER_MANAGED_TO_MANAGED) {</span>
<span class="lineNum">     313 </span><span class="lineCov">      20559 :                 WrapperInfo *info = mono_marshal_get_wrapper_info (m);</span>
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span>            :                 /*
<span class="lineNum">     316 </span>            :                  * generic array helpers.
<span class="lineNum">     317 </span>            :                  * Have to replace the wrappers with the original generic instances.
<span class="lineNum">     318 </span>            :                  */
<span class="lineNum">     319 </span><span class="lineCov">      41118 :                 if (info &amp;&amp; info-&gt;subtype == WRAPPER_SUBTYPE_GENERIC_ARRAY_HELPER) {</span>
<span class="lineNum">     320 </span><span class="lineCov">      18021 :                         callee_array_helper = TRUE;</span>
<span class="lineNum">     321 </span><span class="lineCov">      18021 :                         m = info-&gt;d.generic_array_helper.method;</span>
<span class="lineNum">     322 </span><span class="lineCov">      18021 :                 }</span>
<span class="lineNum">     323 </span><span class="lineCov">   31913206 :         } else if (m-&gt;wrapper_type == MONO_WRAPPER_UNKNOWN) {</span>
<span class="lineNum">     324 </span><span class="lineCov">       2034 :                 WrapperInfo *info = mono_marshal_get_wrapper_info (m);</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            :                 /* Same for synchronized inner wrappers */
<span class="lineNum">     327 </span><span class="lineCov">       4068 :                 if (info &amp;&amp; info-&gt;subtype == WRAPPER_SUBTYPE_SYNCHRONIZED_INNER) {</span>
<span class="lineNum">     328 </span><span class="lineCov">       1960 :                         m = info-&gt;d.synchronized_inner.method;</span>
<span class="lineNum">     329 </span><span class="lineCov">       1960 :                 }</span>
<span class="lineNum">     330 </span><span class="lineCov">       2034 :         }</span>
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span><span class="lineCov">   31913795 :         if (callee_gsharedvt)</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                 g_assert (m-&gt;is_inflated);</span>
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineCov">   31913608 :         addr = compiled_method;</span>
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineCov">   31913608 :         if (add_unbox_tramp) {</span>
<span class="lineNum">     338 </span>            :                 /*
<span class="lineNum">     339 </span>            :                  * The unbox trampolines call the method directly, so need to add
<span class="lineNum">     340 </span>            :                  * an rgctx tramp before them.
<span class="lineNum">     341 </span>            :                  */
<span class="lineNum">     342 </span><span class="lineCov">     170394 :                 if (mono_aot_only) {</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                         addr = mono_aot_get_unbox_trampoline (m);</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     345 </span><span class="lineCov">     170394 :                         unbox_trampolines ++;</span>
<span class="lineNum">     346 </span><span class="lineCov">     170394 :                         addr = mono_arch_get_unbox_trampoline (m, addr);</span>
<span class="lineNum">     347 </span>            :                 }
<span class="lineNum">     348 </span><span class="lineCov">     170394 :         }</span>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineCov">   63826565 :         if (ji &amp;&amp; !ji-&gt;is_trampoline)</span>
<span class="lineNum">     351 </span><span class="lineCov">   31913225 :                 jmethod = jinfo_get_method (ji);</span>
<span class="lineNum">     352 </span><span class="lineCov">   31913415 :         if (callee_gsharedvt &amp;&amp; mini_is_gsharedvt_variable_signature (mono_method_signature (jmethod))) {</span>
<span class="lineNum">     353 </span>            :                 MonoMethodSignature *sig, *gsig;
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :                 /* Here m is a generic instance, while ji-&gt;method is the gsharedvt method implementing it */
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            :                 /* Call from normal/gshared code to gsharedvt code with variable signature */
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :                 sig = mono_method_signature (m);</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :                 gsig = mono_method_signature (jmethod);</span>
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :                 addr = mini_get_gsharedvt_wrapper (TRUE, addr, sig, gsig, -1, FALSE);</span>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                 if (mono_llvm_only)</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                         g_assert_not_reached ();</span>
<span class="lineNum">     365 </span>            :                 //printf (&quot;IN: %s\n&quot;, mono_method_full_name (m, TRUE));
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineCov">   31913224 :         if (callee_array_helper) {</span>
<span class="lineNum">     369 </span><span class="lineCov">      18021 :                 add_static_rgctx_tramp = FALSE;</span>
<span class="lineNum">     370 </span>            :                 /* In AOT mode, compiled_method points to one of the InternalArray methods in Array. */
<span class="lineNum">     371 </span><span class="lineCov">      54063 :                 if (ji &amp;&amp; !mono_llvm_only &amp;&amp; mono_method_needs_static_rgctx_invoke (jinfo_get_method (ji), TRUE))</span>
<span class="lineNum">     372 </span><span class="lineCov">        180 :                         add_static_rgctx_tramp = TRUE;</span>
<span class="lineNum">     373 </span><span class="lineCov">      18021 :         }</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">   31912456 :         if (mono_llvm_only)</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :                 add_static_rgctx_tramp = FALSE;</span>
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineCov">   31913538 :         if (add_static_rgctx_tramp)</span>
<span class="lineNum">     379 </span><span class="lineCov">     570710 :                 addr = mono_create_static_rgctx_trampoline (m, addr);</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span><span class="lineCov">   31913575 :         return addr;</span>
<span class="lineNum">     382 </span>            : }
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span>            : /*
<span class="lineNum">     385 </span>            :  * mini_create_llvmonly_ftndesc:
<span class="lineNum">     386 </span>            :  *
<span class="lineNum">     387 </span>            :  *   Create a function descriptor of the form &lt;addr, arg&gt;, which
<span class="lineNum">     388 </span>            :  * represents a callee ADDR with ARG as the last argument.
<span class="lineNum">     389 </span>            :  * This is used for:
<span class="lineNum">     390 </span>            :  * - generic sharing (ARG is the rgctx)
<span class="lineNum">     391 </span>            :  * - gsharedvt signature wrappers (ARG is a function descriptor)
<a name="392"><span class="lineNum">     392 </span>            :  */</a>
<span class="lineNum">     393 </span>            : MonoFtnDesc*
<span class="lineNum">     394 </span>            : mini_create_llvmonly_ftndesc (MonoDomain *domain, gpointer addr, gpointer arg)
<span class="lineNum">     395 </span>            : {
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :         MonoFtnDesc *ftndesc = (MonoFtnDesc*)mono_domain_alloc0 (mono_domain_get (), 2 * sizeof (gpointer));</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         ftndesc-&gt;addr = addr;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         ftndesc-&gt;arg = arg;</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         return ftndesc;</span>
<span class="lineNum">     401 </span>            : }
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span>            : /**
<span class="lineNum">     404 </span>            :  * mini_add_method_wrappers_llvmonly:
<span class="lineNum">     405 </span>            :  *
<span class="lineNum">     406 </span>            :  *   Add unbox/gsharedvt wrappers around COMPILED_METHOD if needed. Return the wrapper address or COMPILED_METHOD
<span class="lineNum">     407 </span>            :  * if no wrapper is needed. Set OUT_ARG to the rgctx/extra argument needed to be passed to the returned method.
<a name="408"><span class="lineNum">     408 </span>            :  */</a>
<span class="lineNum">     409 </span>            : gpointer
<span class="lineNum">     410 </span>            : mini_add_method_wrappers_llvmonly (MonoMethod *m, gpointer compiled_method, gboolean caller_gsharedvt, gboolean add_unbox_tramp, gpointer *out_arg)
<span class="lineNum">     411 </span>            : {
<span class="lineNum">     412 </span>            :         gpointer addr;
<span class="lineNum">     413 </span>            :         gboolean callee_gsharedvt, callee_array_helper;
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :         MonoMethod *jmethod = NULL;</span>
<span class="lineNum">     415 </span>            :         MonoJitInfo *ji;
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            :         // FIXME: This loads information from AOT (perf problem)
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :         ji = mini_jit_info_table_find (mono_domain_get (), (char *)mono_get_addr_from_ftnptr (compiled_method), NULL);</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         callee_gsharedvt = mini_jit_info_is_gsharedvt (ji);</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         callee_array_helper = FALSE;</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :         if (m-&gt;wrapper_type == MONO_WRAPPER_MANAGED_TO_MANAGED) {</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                 WrapperInfo *info = mono_marshal_get_wrapper_info (m);</span>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span>            :                 /*
<span class="lineNum">     426 </span>            :                  * generic array helpers.
<span class="lineNum">     427 </span>            :                  * Have to replace the wrappers with the original generic instances.
<span class="lineNum">     428 </span>            :                  */
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :                 if (info &amp;&amp; info-&gt;subtype == WRAPPER_SUBTYPE_GENERIC_ARRAY_HELPER) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :                         callee_array_helper = TRUE;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                         m = info-&gt;d.generic_array_helper.method;</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :         } else if (m-&gt;wrapper_type == MONO_WRAPPER_UNKNOWN) {</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                 WrapperInfo *info = mono_marshal_get_wrapper_info (m);</span>
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            :                 /* Same for synchronized inner wrappers */
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 if (info &amp;&amp; info-&gt;subtype == WRAPPER_SUBTYPE_SYNCHRONIZED_INNER) {</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                         m = info-&gt;d.synchronized_inner.method;</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :         if (callee_gsharedvt)</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                 g_assert (m-&gt;is_inflated);</span>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :         addr = compiled_method;</span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         if (add_unbox_tramp) {</span>
<span class="lineNum">     448 </span>            :                 /* 
<span class="lineNum">     449 </span>            :                  * The unbox trampolines call the method directly, so need to add
<span class="lineNum">     450 </span>            :                  * an rgctx tramp before them.
<span class="lineNum">     451 </span>            :                  */
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                 if (mono_aot_only) {</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                         addr = mono_aot_get_unbox_trampoline (m);</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :                         unbox_trampolines ++;</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :                         addr = mono_arch_get_unbox_trampoline (m, addr);</span>
<span class="lineNum">     457 </span>            :                 }
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :         g_assert (mono_llvm_only);</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :         g_assert (out_arg);</span>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :         if (ji &amp;&amp; !ji-&gt;is_trampoline)</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                 jmethod = jinfo_get_method (ji);</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :         if (callee_gsharedvt)</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                 callee_gsharedvt = mini_is_gsharedvt_variable_signature (mono_method_signature (jmethod));</span>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         if (!caller_gsharedvt &amp;&amp; callee_gsharedvt) {</span>
<span class="lineNum">     470 </span>            :                 MonoMethodSignature *sig, *gsig;
<span class="lineNum">     471 </span>            :                 gpointer wrapper_addr;
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            :                 /* Here m is a generic instance, while ji-&gt;method is the gsharedvt method implementing it */
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span>            :                 /* Call from normal/gshared code to gsharedvt code with variable signature */
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                 sig = mono_method_signature (m);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                 gsig = mono_method_signature (jmethod);</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :                 wrapper_addr = mini_get_gsharedvt_wrapper (TRUE, addr, sig, gsig, -1, FALSE);</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            :                 /*
<span class="lineNum">     482 </span>            :                  * This is a gsharedvt in wrapper, it gets passed a ftndesc for the gsharedvt method as an argument.
<span class="lineNum">     483 </span>            :                  */
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                 *out_arg = mini_create_llvmonly_ftndesc (mono_domain_get (), addr, mini_method_get_rgctx (m));</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :                 addr = wrapper_addr;</span>
<span class="lineNum">     486 </span>            :                 //printf (&quot;IN: %s\n&quot;, mono_method_full_name (m, TRUE));
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :         if (!(*out_arg) &amp;&amp; mono_method_needs_static_rgctx_invoke (m, FALSE))</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :                 *out_arg = mini_method_get_rgctx (m);</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :         if (caller_gsharedvt &amp;&amp; !callee_gsharedvt) {</span>
<span class="lineNum">     493 </span>            :                 /*
<span class="lineNum">     494 </span>            :                  * The callee uses the gsharedvt calling convention, have to add an out wrapper.
<span class="lineNum">     495 </span>            :                  */
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 gpointer out_wrapper = mini_get_gsharedvt_wrapper (FALSE, NULL, mono_method_signature (m), NULL, -1, FALSE);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 MonoFtnDesc *out_wrapper_arg = mini_create_llvmonly_ftndesc (mono_domain_get (), addr, *out_arg);</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 addr = out_wrapper;</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                 *out_arg = out_wrapper_arg;</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :         return addr;</span>
<span class="lineNum">     504 </span>            : }
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            : /**
<span class="lineNum">     507 </span>            :  * common_call_trampoline:
<span class="lineNum">     508 </span>            :  *
<span class="lineNum">     509 </span>            :  *   The code to handle normal, virtual, and interface method calls and jumps, both
<span class="lineNum">     510 </span>            :  * from JITted and LLVM compiled code.
<a name="511"><span class="lineNum">     511 </span>            :  */</a>
<span class="lineNum">     512 </span>            : static gpointer
<span class="lineNum">     513 </span>            : common_call_trampoline (mgreg_t *regs, guint8 *code, MonoMethod *m, MonoVTable *vt, gpointer *vtable_slot, MonoError *error)
<span class="lineNum">     514 </span>            : {
<span class="lineNum">     515 </span>            :         gpointer addr, compiled_method;
<span class="lineNum">     516 </span><span class="lineCov">   30278109 :         gboolean generic_shared = FALSE;</span>
<span class="lineNum">     517 </span><span class="lineCov">   30278109 :         gboolean need_unbox_tramp = FALSE;</span>
<span class="lineNum">     518 </span><span class="lineCov">   30278109 :         gboolean need_rgctx_tramp = FALSE;</span>
<span class="lineNum">     519 </span><span class="lineCov">   30278109 :         MonoMethod *declaring = NULL;</span>
<span class="lineNum">     520 </span><span class="lineCov">   30278109 :         MonoMethod *generic_virtual = NULL, *variant_iface = NULL;</span>
<span class="lineNum">     521 </span>            :         int context_used;
<span class="lineNum">     522 </span>            :         gboolean imt_call, virtual_;
<span class="lineNum">     523 </span><span class="lineCov">   30278109 :         gpointer *orig_vtable_slot, *vtable_slot_to_patch = NULL;</span>
<span class="lineNum">     524 </span><span class="lineCov">   30278109 :         MonoJitInfo *ji = NULL;</span>
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineCov">   30278109 :         mono_error_init (error);</span>
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineCov">   65542372 :         virtual_ = vt &amp;&amp; (gpointer)vtable_slot &gt; (gpointer)vt;</span>
<span class="lineNum">     529 </span><span class="lineCov">   65542039 :         imt_call = vt &amp;&amp; (gpointer)vtable_slot &lt; (gpointer)vt;</span>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span>            :         /*
<span class="lineNum">     532 </span>            :          * rgctx trampolines are needed when the call is indirect so the caller can't pass
<span class="lineNum">     533 </span>            :          * the rgctx argument needed by the callee.
<span class="lineNum">     534 </span>            :          */
<span class="lineNum">     535 </span><span class="lineCov">   34070024 :         if (virtual_ &amp;&amp; m)</span>
<span class="lineNum">     536 </span><span class="lineCov">    3792280 :                 need_rgctx_tramp = mono_method_needs_static_rgctx_invoke (m, FALSE);</span>
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span><span class="lineCov">   30277163 :         orig_vtable_slot = vtable_slot;</span>
<span class="lineNum">     539 </span><span class="lineCov">   30277163 :         vtable_slot_to_patch = vtable_slot;</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span>            :         /* IMT call */
<span class="lineNum">     542 </span><span class="lineCov">   30277163 :         if (imt_call) {</span>
<span class="lineNum">     543 </span><span class="lineCov">    1193771 :                 MonoMethod *imt_method = NULL, *impl_method = NULL;</span>
<span class="lineNum">     544 </span>            :                 MonoObject *this_arg;
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineCov">    3581348 :                 g_assert (vtable_slot);</span>
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span><span class="lineCov">    1193711 :                 imt_method = mono_arch_find_imt_method (regs, code);</span>
<span class="lineNum">     549 </span><span class="lineCov">    1193711 :                 this_arg = (MonoObject *)mono_arch_get_this_arg_from_call (regs, code);</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineCov">    1193711 :                 if (mono_object_is_transparent_proxy (this_arg)) {</span>
<span class="lineNum">     552 </span>            :                         /* Use the slow path for now */
<span class="lineNum">     553 </span><span class="lineCov">          2 :                     m = mono_object_get_virtual_method (this_arg, imt_method);</span>
<span class="lineNum">     554 </span><span class="lineCov">          2 :                         vtable_slot_to_patch = NULL;</span>
<span class="lineNum">     555 </span><span class="lineCov">          2 :                 } else {</span>
<span class="lineNum">     556 </span><span class="lineCov">    1791612 :                         if (imt_method-&gt;is_inflated &amp;&amp; ((MonoMethodInflated*)imt_method)-&gt;context.method_inst) {</span>
<span class="lineNum">     557 </span>            :                                 /* Generic virtual method */
<span class="lineNum">     558 </span><span class="lineCov">       3651 :                                 generic_virtual = imt_method;</span>
<span class="lineNum">     559 </span><span class="lineCov">       3651 :                                 need_rgctx_tramp = TRUE;</span>
<span class="lineNum">     560 </span><span class="lineCov">       3651 :                         }</span>
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span><span class="lineCov">    1193766 :                         vtable_slot = mini_resolve_imt_method (vt, vtable_slot, imt_method, &amp;impl_method, &amp;addr, &amp;need_rgctx_tramp, &amp;variant_iface, error);</span>
<span class="lineNum">     563 </span><span class="lineCov">    3581423 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span>            :                         /* This is the vcall slot which gets called through the IMT trampoline */
<span class="lineNum">     566 </span><span class="lineCov">    1193832 :                         vtable_slot_to_patch = vtable_slot;</span>
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineCov">    1193832 :                         if (addr) {</span>
<span class="lineNum">     569 </span>            :                                 /*
<span class="lineNum">     570 </span>            :                                  * We found AOT compiled code for the method, skip the rest.
<span class="lineNum">     571 </span>            :                                  */
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :                                 if (mono_domain_owns_vtable_slot (mono_domain_get (), vtable_slot))</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                                         *vtable_slot = addr;</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                                 return mono_create_ftnptr (mono_domain_get (), addr);</span>
<span class="lineNum">     576 </span>            :                         }
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span><span class="lineCov">    1193832 :                         m = impl_method;</span>
<span class="lineNum">     579 </span>            :                 }
<span class="lineNum">     580 </span><span class="lineCov">    1193828 :         }</span>
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :         /*
<span class="lineNum">     583 </span>            :          * The virtual check is needed because is_generic_method_definition (m) could
<span class="lineNum">     584 </span>            :          * return TRUE for methods used in IMT calls too.
<span class="lineNum">     585 </span>            :          */
<span class="lineNum">     586 </span><span class="lineCov">   34068755 :         if (virtual_ &amp;&amp; is_generic_method_definition (m)) {</span>
<span class="lineNum">     587 </span><span class="lineCov">     108683 :                 MonoGenericContext context = { NULL, NULL };</span>
<span class="lineNum">     588 </span>            :                 MonoMethod *declaring;
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineCov">     108683 :                 if (m-&gt;is_inflated)</span>
<span class="lineNum">     591 </span><span class="lineCov">       6150 :                         declaring = mono_method_get_declaring_generic_method (m);</span>
<span class="lineNum">     592 </span>            :                 else
<span class="lineNum">     593 </span><span class="lineCov">     102520 :                         declaring = m;</span>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineCov">     108663 :                 if (mono_class_is_ginst (m-&gt;klass))</span>
<span class="lineNum">     596 </span><span class="lineCov">       6150 :                         context.class_inst = mono_class_get_generic_class (m-&gt;klass)-&gt;context.class_inst;</span>
<span class="lineNum">     597 </span>            :                 else
<span class="lineNum">     598 </span><span class="lineCov">     307528 :                         g_assert (!mono_class_is_gtd (m-&gt;klass));</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span><span class="lineCov">     108652 :                 generic_virtual = mono_arch_find_imt_method (regs, code);</span>
<span class="lineNum">     601 </span><span class="lineCov">     325971 :                 g_assert (generic_virtual);</span>
<span class="lineNum">     602 </span><span class="lineCov">     325929 :                 g_assert (generic_virtual-&gt;is_inflated);</span>
<span class="lineNum">     603 </span><span class="lineCov">     108640 :                 context.method_inst = ((MonoMethodInflated*)generic_virtual)-&gt;context.method_inst;</span>
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span><span class="lineCov">     108640 :                 m = mono_class_inflate_generic_method_checked (declaring, &amp;context, error);</span>
<span class="lineNum">     606 </span><span class="lineCov">     108640 :                 mono_error_assert_ok (error);</span>
<span class="lineNum">     607 </span>            :                 /* FIXME: only do this if the method is sharable */
<span class="lineNum">     608 </span><span class="lineCov">     108640 :                 need_rgctx_tramp = TRUE;</span>
<span class="lineNum">     609 </span><span class="lineCov">   30275340 :         } else if ((context_used = mono_method_check_context_used (m))) {</span>
<span class="lineNum">     610 </span><span class="lineCov">    1201502 :                 MonoClass *klass = NULL;</span>
<span class="lineNum">     611 </span><span class="lineCov">    1201502 :                 MonoMethod *actual_method = NULL;</span>
<span class="lineNum">     612 </span><span class="lineCov">    1201502 :                 MonoVTable *vt = NULL;</span>
<span class="lineNum">     613 </span><span class="lineCov">    1201502 :                 MonoGenericInst *method_inst = NULL;</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineCov">    1201502 :                 vtable_slot = NULL;</span>
<span class="lineNum">     616 </span><span class="lineCov">    1201502 :                 generic_shared = TRUE;</span>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineCov">    3604516 :                 g_assert (code);</span>
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span>            :                 /*
<span class="lineNum">     621 </span>            :                  * The caller is gshared code, compute the actual method to call from M and this/rgctx.
<span class="lineNum">     622 </span>            :                  */
<span class="lineNum">     623 </span><span class="lineCov">    2403015 :                 if (m-&gt;is_inflated &amp;&amp; mono_method_get_context (m)-&gt;method_inst) {</span>
<span class="lineNum">     624 </span><span class="lineCov">     210024 :                         MonoMethodRuntimeGenericContext *mrgctx = (MonoMethodRuntimeGenericContext*)mono_arch_find_static_call_vtable (regs, code);</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineCov">     210024 :                         klass = mrgctx-&gt;class_vtable-&gt;klass;</span>
<span class="lineNum">     627 </span><span class="lineCov">     210024 :                         method_inst = mrgctx-&gt;method_inst;</span>
<span class="lineNum">     628 </span><span class="lineCov">    2111233 :                 } else if ((m-&gt;flags &amp; METHOD_ATTRIBUTE_STATIC) || m-&gt;klass-&gt;valuetype) {</span>
<span class="lineNum">     629 </span><span class="lineCov">     288800 :                         MonoVTable *vtable = mono_arch_find_static_call_vtable (regs, code);</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineCov">     288800 :                         klass = vtable-&gt;klass;</span>
<span class="lineNum">     632 </span><span class="lineCov">     288800 :                 } else {</span>
<span class="lineNum">     633 </span><span class="lineCov">     702679 :                         MonoObject *this_argument = (MonoObject *)mono_arch_get_this_arg_from_call (regs, code);</span>
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span><span class="lineCov">     702679 :                         vt = this_argument-&gt;vtable;</span>
<span class="lineNum">     636 </span><span class="lineCov">     702679 :                         vtable_slot = orig_vtable_slot;</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span><span class="lineCov">    2108081 :                         g_assert (this_argument-&gt;vtable-&gt;klass-&gt;inited);</span>
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span><span class="lineCov">     702734 :                         if (!vtable_slot) {</span>
<span class="lineNum">     641 </span><span class="lineCov">     702739 :                                 mono_class_setup_supertypes (this_argument-&gt;vtable-&gt;klass);</span>
<span class="lineNum">     642 </span><span class="lineCov">     702739 :                                 klass = this_argument-&gt;vtable-&gt;klass-&gt;supertypes [m-&gt;klass-&gt;idepth - 1];</span>
<span class="lineNum">     643 </span><span class="lineCov">     702739 :                         }</span>
<span class="lineNum">     644 </span>            :                 }
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span><span class="lineCov">    6007526 :                 g_assert (vtable_slot || klass);</span>
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineCov">    1201537 :                 if (vtable_slot) {</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :                         int displacement = vtable_slot - ((gpointer*)vt);</span>
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :                         g_assert_not_reached ();</span>
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                         g_assert (displacement &gt; 0);</span>
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :                         actual_method = vt-&gt;klass-&gt;vtable [displacement];</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span><span class="lineCov">    2193048 :                 if (method_inst || m-&gt;wrapper_type) {</span>
<span class="lineNum">     659 </span><span class="lineCov">     210086 :                         MonoGenericContext context = { NULL, NULL };</span>
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineCov">     210086 :                         if (m-&gt;is_inflated)</span>
<span class="lineNum">     662 </span><span class="lineCov">     210057 :                                 declaring = mono_method_get_declaring_generic_method (m);</span>
<span class="lineNum">     663 </span>            :                         else
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :                                 declaring = m;</span>
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span><span class="lineCov">     210069 :                         if (mono_class_is_ginst (klass))</span>
<span class="lineNum">     667 </span><span class="lineCov">       5128 :                                 context.class_inst = mono_class_get_generic_class (klass)-&gt;context.class_inst;</span>
<span class="lineNum">     668 </span><span class="lineCov">     204908 :                         else if (mono_class_is_gtd (klass))</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :                                 context.class_inst = mono_class_get_generic_container (klass)-&gt;context.class_inst;</span>
<span class="lineNum">     670 </span><span class="lineCov">     210047 :                         context.method_inst = method_inst;</span>
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span><span class="lineCov">     210047 :                         actual_method = mono_class_inflate_generic_method_checked (declaring, &amp;context, error);</span>
<span class="lineNum">     673 </span><span class="lineCov">     210047 :                         mono_error_assert_ok (error);</span>
<span class="lineNum">     674 </span><span class="lineCov">     210047 :                 } else {</span>
<span class="lineNum">     675 </span><span class="lineCov">     991400 :                         actual_method = mono_class_get_method_generic (klass, m);</span>
<span class="lineNum">     676 </span>            :                 }
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span><span class="lineCov">    3604999 :                 g_assert (klass);</span>
<span class="lineNum">     679 </span><span class="lineCov">    3604959 :                 g_assert (actual_method);</span>
<span class="lineNum">     680 </span><span class="lineCov">    3604982 :                 g_assert (actual_method-&gt;klass == klass);</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineCov">    1201663 :                 if (actual_method-&gt;is_inflated)</span>
<span class="lineNum">     683 </span><span class="lineCov">    1201670 :                         declaring = mono_method_get_declaring_generic_method (actual_method);</span>
<span class="lineNum">     684 </span>            :                 else
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                         declaring = NULL;</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span><span class="lineCov">    1201672 :                 m = actual_method;</span>
<span class="lineNum">     688 </span><span class="lineCov">    1201672 :         }</span>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineCov">   30275737 :         if (m-&gt;iflags &amp; METHOD_IMPL_ATTRIBUTE_SYNCHRONIZED) {</span>
<span class="lineNum">     691 </span><span class="lineCov">       2015 :                 m = mono_marshal_get_synchronized_wrapper (m);</span>
<span class="lineNum">     692 </span><span class="lineCov">       2015 :                 need_rgctx_tramp = FALSE;</span>
<span class="lineNum">     693 </span><span class="lineCov">       2015 :         }</span>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span>            :         /* Calls made through delegates on platforms without delegate trampolines */
<span class="lineNum">     696 </span><span class="lineCov">   30276046 :         if (!code &amp;&amp; mono_method_needs_static_rgctx_invoke (m, FALSE))</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                 need_rgctx_tramp = TRUE;</span>
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span><span class="lineCov">   30276926 :         addr = compiled_method = mono_jit_compile_method (m, error);</span>
<span class="lineNum">     700 </span><span class="lineCov">   30276926 :         if (!addr)</span>
<span class="lineNum">     701 </span><span class="lineCov">        184 :                 return NULL;</span>
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span><span class="lineCov">   60441966 :         if (generic_virtual || variant_iface) {</span>
<span class="lineNum">     704 </span><span class="lineCov">     333672 :                 if (vt-&gt;klass-&gt;valuetype) /*FIXME is this required variant iface?*/</span>
<span class="lineNum">     705 </span><span class="lineCov">       8832 :                         need_unbox_tramp = TRUE;</span>
<span class="lineNum">     706 </span><span class="lineCov">   30277765 :         } else if (orig_vtable_slot) {</span>
<span class="lineNum">     707 </span><span class="lineCov">    4652501 :                 if (m-&gt;klass-&gt;valuetype)</span>
<span class="lineNum">     708 </span><span class="lineCov">     161563 :                         need_unbox_tramp = TRUE;</span>
<span class="lineNum">     709 </span><span class="lineCov">    4652504 :         }</span>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineCov">   30277939 :         addr = mini_add_method_trampoline (m, compiled_method, need_rgctx_tramp, need_unbox_tramp);</span>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span><span class="lineCov">   60443869 :         if (generic_virtual || variant_iface) {</span>
<span class="lineNum">     714 </span><span class="lineCov">    1001017 :                 MonoMethod *target = generic_virtual ? generic_virtual : variant_iface;</span>
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span><span class="lineCov">     333671 :                 vtable_slot = orig_vtable_slot;</span>
<span class="lineNum">     717 </span><span class="lineCov">    1001011 :                 g_assert (vtable_slot);</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineCov">     667340 :                 mono_method_add_generic_virtual_invocation (mono_domain_get (), </span>
<span class="lineNum">     720 </span><span class="lineCov">     333670 :                                                                                                         vt, vtable_slot,</span>
<span class="lineNum">     721 </span><span class="lineCov">     333670 :                                                                                                         target, addr);</span>
<span class="lineNum">     722 </span>            : 
<span class="lineNum">     723 </span><span class="lineCov">     333670 :                 return addr;</span>
<span class="lineNum">     724 </span>            :         }
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span>            :         /* the method was jumped to */
<span class="lineNum">     727 </span><span class="lineCov">   29944051 :         if (!code) {</span>
<span class="lineNum">     728 </span><span class="lineCov">        372 :                 MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">     729 </span>            : 
<span class="lineNum">     730 </span>            :                 /* Patch the got entries pointing to this method */
<span class="lineNum">     731 </span>            :                 /* 
<span class="lineNum">     732 </span>            :                  * We do this here instead of in mono_codegen () to cover the case when m
<span class="lineNum">     733 </span>            :                  * was loaded from an aot image.
<span class="lineNum">     734 </span>            :                  */
<span class="lineNum">     735 </span><span class="lineCov">        372 :                 if (domain_jit_info (domain)-&gt;jump_target_got_slot_hash) {</span>
<span class="lineNum">     736 </span>            :                         GSList *list, *tmp;
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                         mono_domain_lock (domain);</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :                         list = (GSList *)g_hash_table_lookup (domain_jit_info (domain)-&gt;jump_target_got_slot_hash, m);</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :                         if (list) {</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                                 for (tmp = list; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :                                         gpointer *got_slot = (gpointer *)tmp-&gt;data;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :                                         *got_slot = addr;</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :                                 g_hash_table_remove (domain_jit_info (domain)-&gt;jump_target_got_slot_hash, m);</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                                 g_slist_free (list);</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span><span class="lineCov">        372 :                 return addr;</span>
<span class="lineNum">     752 </span>            :         }
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span><span class="lineCov">   29943761 :         vtable_slot = orig_vtable_slot;</span>
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span><span class="lineCov">   29943761 :         if (vtable_slot) {</span>
<span class="lineNum">     757 </span><span class="lineCov">   13957693 :                 if (vtable_slot_to_patch &amp;&amp; (mono_aot_is_got_entry (code, (guint8*)vtable_slot_to_patch) || mono_domain_owns_vtable_slot (mono_domain_get (), vtable_slot_to_patch))) {</span>
<span class="lineNum">     758 </span><span class="lineCov">   13957756 :                         g_assert (*vtable_slot_to_patch);</span>
<span class="lineNum">     759 </span><span class="lineCov">    4652585 :                         *vtable_slot_to_patch = mono_get_addr_from_ftnptr (addr);</span>
<span class="lineNum">     760 </span><span class="lineCov">    4652585 :                 }</span>
<span class="lineNum">     761 </span><span class="lineCov">    4652581 :         } else {</span>
<span class="lineNum">     762 </span><span class="lineCov">   25290010 :                 guint8 *plt_entry = mono_aot_get_plt_entry (code);</span>
<span class="lineNum">     763 </span><span class="lineCov">   25290010 :                 gboolean no_patch = FALSE;</span>
<span class="lineNum">     764 </span>            :                 MonoJitInfo *target_ji;
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span><span class="lineCov">   25290010 :                 if (plt_entry) {</span>
<span class="lineNum">     767 </span><span class="lineCov">     424429 :                         if (generic_shared) {</span>
<span class="lineNum">     768 </span><span class="lineCov">     162561 :                                 target_ji =</span>
<span class="lineNum">     769 </span><span class="lineCov">     162561 :                                         mini_jit_info_table_find (mono_domain_get (), (char *)mono_get_addr_from_ftnptr (compiled_method), NULL);</span>
<span class="lineNum">     770 </span><span class="lineCov">     162561 :                                 if (!ji)</span>
<span class="lineNum">     771 </span><span class="lineCov">     162561 :                                         ji = mini_jit_info_table_find (mono_domain_get (), (char*)code, NULL);</span>
<span class="lineNum">     772 </span>            : 
<span class="lineNum">     773 </span><span class="lineCov">     812798 :                                 if (ji &amp;&amp; target_ji &amp;&amp; generic_shared &amp;&amp; ji-&gt;has_generic_jit_info &amp;&amp; !target_ji-&gt;has_generic_jit_info) {</span>
<span class="lineNum">     774 </span><span class="lineCov">      55423 :                                         no_patch = TRUE;</span>
<span class="lineNum">     775 </span><span class="lineCov">      55423 :                                 }</span>
<span class="lineNum">     776 </span><span class="lineCov">     162559 :                         }</span>
<span class="lineNum">     777 </span><span class="lineCov">     424426 :                         if (!no_patch)</span>
<span class="lineNum">     778 </span><span class="lineCov">     369003 :                                 mono_aot_patch_plt_entry (code, plt_entry, NULL, regs, (guint8 *)addr);</span>
<span class="lineNum">     779 </span><span class="lineCov">     424428 :                 } else {</span>
<span class="lineNum">     780 </span><span class="lineCov">   24865631 :                         if (generic_shared) {</span>
<span class="lineNum">     781 </span><span class="lineCov">    1039094 :                                 if (m-&gt;wrapper_type != MONO_WRAPPER_NONE)</span>
<span class="lineNum">     782 </span><span class="lineCov">         66 :                                         m = mono_marshal_method_from_wrapper (m);</span>
<span class="lineNum">     783 </span>            :                                 //g_assert (mono_method_is_generic_sharable (m, FALSE));
<span class="lineNum">     784 </span><span class="lineCov">    1039097 :                         }</span>
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            :                         /* Patch calling code */
<span class="lineNum">     787 </span><span class="lineCov">   24868272 :                         target_ji =</span>
<span class="lineNum">     788 </span><span class="lineCov">   24868272 :                                 mini_jit_info_table_find (mono_domain_get (), (char *)mono_get_addr_from_ftnptr (compiled_method), NULL);</span>
<span class="lineNum">     789 </span><span class="lineCov">   24868272 :                         if (!ji)</span>
<span class="lineNum">     790 </span><span class="lineCov">   24868288 :                                 ji = mini_jit_info_table_find (mono_domain_get (), (char*)code, NULL);</span>
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span><span class="lineCov">   76682769 :                         if (ji &amp;&amp; target_ji &amp;&amp; generic_shared &amp;&amp; ji-&gt;has_generic_jit_info &amp;&amp; !target_ji-&gt;has_generic_jit_info) {</span>
<span class="lineNum">     793 </span>            :                                 /* 
<span class="lineNum">     794 </span>            :                                  * Can't patch the call as the caller is gshared, but the callee is not. Happens when
<span class="lineNum">     795 </span>            :                                  * generic sharing fails.
<span class="lineNum">     796 </span>            :                                  * FIXME: Performance problem.
<span class="lineNum">     797 </span>            :                                  */
<span class="lineNum">     798 </span><span class="lineCov">     232066 :                                 no_patch = TRUE;</span>
<span class="lineNum">     799 </span><span class="lineCov">     232066 :                         }</span>
<span class="lineNum">     800 </span>            : #if LLVM_API_VERSION &gt; 100
<span class="lineNum">     801 </span>            :                         /* LLVM code doesn't make direct calls */
<span class="lineNum">     802 </span>            :                         if (ji &amp;&amp; ji-&gt;from_llvm)
<span class="lineNum">     803 </span>            :                                 no_patch = TRUE;
<span class="lineNum">     804 </span>            : #endif
<span class="lineNum">     805 </span><span class="lineCov">   49503776 :                         if (!no_patch &amp;&amp; mono_method_same_domain (ji, target_ji))</span>
<span class="lineNum">     806 </span><span class="lineCov">   24625112 :                                 mono_arch_patch_callsite ((guint8 *)ji-&gt;code_start, code, (guint8 *)addr);</span>
<span class="lineNum">     807 </span>            :                 }
<span class="lineNum">     808 </span>            :         }
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span><span class="lineCov">   29944557 :         return addr;</span>
<span class="lineNum">     811 </span><span class="lineCov">   30278759 : }</span>
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            : /**
<span class="lineNum">     814 </span>            :  * mono_magic_trampoline:
<span class="lineNum">     815 </span>            :  *
<span class="lineNum">     816 </span>            :  * This trampoline handles normal calls from JITted code.
<a name="817"><span class="lineNum">     817 </span>            :  */</a>
<span class="lineNum">     818 </span>            : gpointer
<span class="lineNum">     819 </span>            : mono_magic_trampoline (mgreg_t *regs, guint8 *code, gpointer arg, guint8* tramp)
<span class="lineNum">     820 </span>            : {
<span class="lineNum">     821 </span>            :         gpointer res;
<span class="lineNum">     822 </span>            : 
<span class="lineNum">     823 </span><span class="lineCov">   50580750 :         MONO_ENTER_GC_UNSAFE_UNBALANCED;</span>
<span class="lineNum">     824 </span>            : 
<span class="lineNum">     825 </span>            :         MonoError error;
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineCov">   25290374 :         trampoline_calls ++;</span>
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span><span class="lineCov">   25290374 :         res = common_call_trampoline (regs, code, (MonoMethod *)arg, NULL, NULL, &amp;error);</span>
<span class="lineNum">     830 </span><span class="lineCov">   25290374 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span><span class="lineCov">   25290374 :         mono_interruption_checkpoint_from_trampoline ();</span>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineCov">   25290374 :         MONO_EXIT_GC_UNSAFE_UNBALANCED;</span>
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span><span class="lineCov">   25291290 :         return res;</span>
<span class="lineNum">     837 </span>            : }
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span>            : /**
<span class="lineNum">     840 </span>            :  * mono_vcall_trampoline:
<span class="lineNum">     841 </span>            :  *
<span class="lineNum">     842 </span>            :  * This trampoline handles virtual calls.
<a name="843"><span class="lineNum">     843 </span>            :  */</a>
<span class="lineNum">     844 </span>            : static gpointer
<span class="lineNum">     845 </span>            : mono_vcall_trampoline (mgreg_t *regs, guint8 *code, int slot, guint8 *tramp)
<span class="lineNum">     846 </span>            : {
<span class="lineNum">     847 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     848 </span>            : 
<span class="lineNum">     849 </span>            :         MonoObject *this_arg;
<span class="lineNum">     850 </span>            :         MonoVTable *vt;
<span class="lineNum">     851 </span>            :         gpointer *vtable_slot;
<span class="lineNum">     852 </span>            :         MonoMethod *m;
<span class="lineNum">     853 </span>            :         MonoError error;
<span class="lineNum">     854 </span><span class="lineCov">    5071659 :         gpointer addr, res = NULL;</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineCov">    5071659 :         trampoline_calls ++;</span>
<span class="lineNum">     857 </span>            : 
<span class="lineNum">     858 </span>            :         /*
<span class="lineNum">     859 </span>            :          * We need to obtain the following pieces of information:
<span class="lineNum">     860 </span>            :          * - the method which needs to be compiled.
<span class="lineNum">     861 </span>            :          * - the vtable slot.
<span class="lineNum">     862 </span>            :          * We use one vtable trampoline per vtable slot index, so we need only the vtable,
<span class="lineNum">     863 </span>            :          * the other two can be computed from the vtable + the slot index.
<span class="lineNum">     864 </span>            :          */
<span class="lineNum">     865 </span>            : 
<span class="lineNum">     866 </span>            :         /*
<span class="lineNum">     867 </span>            :          * Obtain the vtable from the 'this' arg.
<span class="lineNum">     868 </span>            :          */
<span class="lineNum">     869 </span><span class="lineCov">    5071659 :         this_arg = (MonoObject *)mono_arch_get_this_arg_from_call (regs, code);</span>
<span class="lineNum">     870 </span><span class="lineCov">   15215111 :         g_assert (this_arg);</span>
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span><span class="lineCov">    5071779 :         vt = this_arg-&gt;vtable;</span>
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span><span class="lineCov">    5071779 :         if (slot &gt;= 0) {</span>
<span class="lineNum">     875 </span>            :                 /* Normal virtual call */
<span class="lineNum">     876 </span><span class="lineCov">    3878132 :                 vtable_slot = &amp;(vt-&gt;vtable [slot]);</span>
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span>            :                 /* Avoid loading metadata or creating a generic vtable if possible */
<span class="lineNum">     879 </span><span class="lineCov">    3878132 :                 addr = mono_aot_get_method_from_vt_slot (mono_domain_get (), vt, slot, &amp;error);</span>
<span class="lineNum">     880 </span><span class="lineCov">    3878132 :                 if (!is_ok (&amp;error))</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">     882 </span><span class="lineCov">    3965512 :                 if (addr &amp;&amp; !vt-&gt;klass-&gt;valuetype) {</span>
<span class="lineNum">     883 </span><span class="lineCov">      86457 :                         if (mono_domain_owns_vtable_slot (mono_domain_get (), vtable_slot))</span>
<span class="lineNum">     884 </span><span class="lineCov">      86457 :                                 *vtable_slot = addr;</span>
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span><span class="lineCov">      86457 :                         return mono_create_ftnptr (mono_domain_get (), addr);</span>
<span class="lineNum">     887 </span>            :                 }
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span>            :                 /*
<span class="lineNum">     890 </span>            :                  * Bug #616463 (see
<span class="lineNum">     891 </span>            :                  * is_generic_method_definition() above) also
<span class="lineNum">     892 </span>            :                  * goes away if we do a
<span class="lineNum">     893 </span>            :                  * mono_class_setup_vtable (vt-&gt;klass) here,
<span class="lineNum">     894 </span>            :                  * because we then inflate the method
<span class="lineNum">     895 </span>            :                  * correctly, put it in the cache, and the
<span class="lineNum">     896 </span>            :                  * &quot;wrong&quot; inflation invocation still looks up
<span class="lineNum">     897 </span>            :                  * the correctly inflated method.
<span class="lineNum">     898 </span>            :                  *
<span class="lineNum">     899 </span>            :                  * The hack above seems more stable and
<span class="lineNum">     900 </span>            :                  * trustworthy.
<span class="lineNum">     901 </span>            :                  */
<span class="lineNum">     902 </span><span class="lineCov">    3791478 :                 m = mono_class_get_vtable_entry (vt-&gt;klass, slot);</span>
<span class="lineNum">     903 </span><span class="lineCov">    3791478 :         } else {</span>
<span class="lineNum">     904 </span>            :                 /* IMT call */
<span class="lineNum">     905 </span><span class="lineCov">    1193703 :                 vtable_slot = &amp;(((gpointer*)vt) [slot]);</span>
<span class="lineNum">     906 </span>            : 
<span class="lineNum">     907 </span><span class="lineCov">    1193703 :                 m = NULL;</span>
<span class="lineNum">     908 </span>            :         }
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineCov">    4985624 :         res = common_call_trampoline (regs, code, m, vt, vtable_slot, &amp;error);</span>
<span class="lineNum">     911 </span>            : leave:
<span class="lineNum">     912 </span><span class="lineCov">    4986249 :         if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                 mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     915 </span>            :         }
<span class="lineNum">     916 </span><span class="lineCov">    4986248 :         return res;</span>
<span class="lineNum">     917 </span><span class="lineCov">    5072699 : }</span>
<span class="lineNum">     918 </span>            : 
<a name="919"><span class="lineNum">     919 </span>            : #ifndef DISABLE_REMOTING</a>
<span class="lineNum">     920 </span>            : gpointer
<span class="lineNum">     921 </span>            : mono_generic_virtual_remoting_trampoline (mgreg_t *regs, guint8 *code, MonoMethod *m, guint8 *tramp)
<span class="lineNum">     922 </span>            : {
<span class="lineNum">     923 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span>            :         MonoError error;
<span class="lineNum">     926 </span><span class="lineCov">          2 :         MonoGenericContext context = { NULL, NULL };</span>
<span class="lineNum">     927 </span>            :         MonoMethod *imt_method, *declaring;
<span class="lineNum">     928 </span>            :         gpointer addr;
<span class="lineNum">     929 </span>            : 
<span class="lineNum">     930 </span><span class="lineCov">          2 :         trampoline_calls ++;</span>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineCov">          6 :         g_assert (m-&gt;is_generic);</span>
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span><span class="lineCov">          2 :         if (m-&gt;is_inflated)</span>
<span class="lineNum">     935 </span><span class="lineCov">          2 :                 declaring = mono_method_get_declaring_generic_method (m);</span>
<span class="lineNum">     936 </span>            :         else
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :                 declaring = m;</span>
<span class="lineNum">     938 </span>            : 
<span class="lineNum">     939 </span><span class="lineCov">          2 :         if (mono_class_is_ginst (m-&gt;klass))</span>
<span class="lineNum">     940 </span><span class="lineCov">          2 :                 context.class_inst = mono_class_get_generic_class (m-&gt;klass)-&gt;context.class_inst;</span>
<span class="lineNum">     941 </span>            :         else
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :                 g_assert (!mono_class_is_gtd (m-&gt;klass));</span>
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span><span class="lineCov">          2 :         imt_method = mono_arch_find_imt_method (regs, code);</span>
<span class="lineNum">     945 </span><span class="lineCov">          2 :         if (imt_method-&gt;is_inflated)</span>
<span class="lineNum">     946 </span><span class="lineCov">          2 :                 context.method_inst = ((MonoMethodInflated*)imt_method)-&gt;context.method_inst;</span>
<span class="lineNum">     947 </span><span class="lineCov">          2 :         m = mono_class_inflate_generic_method_checked (declaring, &amp;context, &amp;error);</span>
<span class="lineNum">     948 </span><span class="lineCov">          6 :         g_assert (mono_error_ok (&amp;error)); /* FIXME don't swallow the error */;</span>
<span class="lineNum">     949 </span><span class="lineCov">          2 :         m = mono_marshal_get_remoting_invoke_with_check (m);</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineCov">          2 :         addr = mono_jit_compile_method (m, &amp;error);</span>
<span class="lineNum">     952 </span><span class="lineCov">          2 :         if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :                 mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     955 </span>            :         }
<span class="lineNum">     956 </span><span class="lineCov">          6 :         g_assert (addr);</span>
<span class="lineNum">     957 </span>            : 
<span class="lineNum">     958 </span><span class="lineCov">          2 :         return addr;</span>
<span class="lineNum">     959 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">     960 </span>            : #endif
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span>            : /**
<span class="lineNum">     963 </span>            :  * mono_aot_trampoline:
<span class="lineNum">     964 </span>            :  *
<span class="lineNum">     965 </span>            :  * This trampoline handles calls made from AOT code. We try to bypass the 
<span class="lineNum">     966 </span>            :  * normal JIT compilation logic to avoid loading the metadata for the method.
<span class="lineNum">     967 </span>            :  */
<a name="968"><span class="lineNum">     968 </span>            : #ifdef MONO_ARCH_AOT_SUPPORTED</a>
<span class="lineNum">     969 </span>            : gpointer
<span class="lineNum">     970 </span>            : mono_aot_trampoline (mgreg_t *regs, guint8 *code, guint8 *token_info, 
<span class="lineNum">     971 </span>            :                                          guint8* tramp)
<span class="lineNum">     972 </span>            : {
<span class="lineNum">     973 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     974 </span>            : 
<span class="lineNum">     975 </span>            :         MonoImage *image;
<span class="lineNum">     976 </span>            :         guint32 token;
<span class="lineNum">     977 </span><span class="lineCov">     290456 :         MonoMethod *method = NULL;</span>
<span class="lineNum">     978 </span>            :         gpointer addr;
<span class="lineNum">     979 </span>            :         guint8 *plt_entry;
<span class="lineNum">     980 </span>            :         MonoError error;
<span class="lineNum">     981 </span>            : 
<span class="lineNum">     982 </span><span class="lineCov">     290456 :         trampoline_calls ++;</span>
<span class="lineNum">     983 </span>            : 
<span class="lineNum">     984 </span><span class="lineCov">     290456 :         image = (MonoImage *)*(gpointer*)(gpointer)token_info;</span>
<span class="lineNum">     985 </span><span class="lineCov">     290456 :         token_info += sizeof (gpointer);</span>
<span class="lineNum">     986 </span><span class="lineCov">     290456 :         token = *(guint32*)(gpointer)token_info;</span>
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span><span class="lineCov">     290456 :         addr = mono_aot_get_method_from_token (mono_domain_get (), image, token, &amp;error);</span>
<span class="lineNum">     989 </span><span class="lineCov">     290456 :         if (!is_ok (&amp;error))</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                 mono_error_cleanup (&amp;error);</span>
<span class="lineNum">     991 </span><span class="lineCov">     290460 :         if (!addr) {</span>
<span class="lineNum">     992 </span><span class="lineCov">      93390 :                 method = mono_get_method_checked (image, token, NULL, NULL, &amp;error);</span>
<span class="lineNum">     993 </span><span class="lineCov">      93390 :                 if (!method)</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                         g_error (&quot;Could not load AOT trampoline due to %s&quot;, mono_error_get_message (&amp;error));</span>
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span>            :                 /* Use the generic code */
<span class="lineNum">     997 </span><span class="lineCov">      93390 :                 return mono_magic_trampoline (regs, code, method, tramp);</span>
<span class="lineNum">     998 </span>            :         }
<span class="lineNum">     999 </span>            : 
<span class="lineNum">    1000 </span><span class="lineCov">     197067 :         addr = mono_create_ftnptr (mono_domain_get (), addr);</span>
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span>            :         /* This is a normal call through a PLT entry */
<span class="lineNum">    1003 </span><span class="lineCov">     197067 :         plt_entry = mono_aot_get_plt_entry (code);</span>
<span class="lineNum">    1004 </span><span class="lineCov">     591226 :         g_assert (plt_entry);</span>
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span><span class="lineCov">     197083 :         mono_aot_patch_plt_entry (code, plt_entry, NULL, regs, (guint8 *)addr);</span>
<span class="lineNum">    1007 </span>            : 
<span class="lineNum">    1008 </span><span class="lineCov">     197083 :         return addr;</span>
<span class="lineNum">    1009 </span><span class="lineCov">     290468 : }</span>
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span>            : /*
<span class="lineNum">    1012 </span>            :  * mono_aot_plt_trampoline:
<span class="lineNum">    1013 </span>            :  *
<span class="lineNum">    1014 </span>            :  *   This trampoline handles calls made from AOT code through the PLT table.
<a name="1015"><span class="lineNum">    1015 </span>            :  */</a>
<span class="lineNum">    1016 </span>            : gpointer
<span class="lineNum">    1017 </span>            : mono_aot_plt_trampoline (mgreg_t *regs, guint8 *code, guint8 *aot_module, 
<span class="lineNum">    1018 </span>            :                                                  guint8* tramp)
<span class="lineNum">    1019 </span>            : {
<span class="lineNum">    1020 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineCov">     868412 :         guint32 plt_info_offset = mono_aot_get_plt_info_offset (regs, code);</span>
<span class="lineNum">    1023 </span>            :         gpointer res;
<span class="lineNum">    1024 </span>            :         MonoError error;
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineCov">     868412 :         trampoline_calls ++;</span>
<span class="lineNum">    1027 </span>            : 
<span class="lineNum">    1028 </span><span class="lineCov">     868412 :         res = mono_aot_plt_resolve (aot_module, plt_info_offset, code, &amp;error);</span>
<span class="lineNum">    1029 </span><span class="lineCov">     868412 :         if (!res) {</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                 if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :                         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1033 </span>            :                 }
<span class="lineNum">    1034 </span>            :                 // FIXME: Error handling (how ?)
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :                 g_assert (res);</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span><span class="lineCov">     868411 :         return res;</span>
<span class="lineNum">    1039 </span><span class="lineCov">     868410 : }</span>
<span class="lineNum">    1040 </span>            : #endif
<a name="1041"><span class="lineNum">    1041 </span>            : </a>
<span class="lineNum">    1042 </span>            : static gpointer
<span class="lineNum">    1043 </span>            : mono_rgctx_lazy_fetch_trampoline (mgreg_t *regs, guint8 *code, gpointer data, guint8 *tramp)
<span class="lineNum">    1044 </span>            : {
<span class="lineNum">    1045 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span>            :         static gboolean inited = FALSE;
<span class="lineNum">    1048 </span>            :         static int num_lookups = 0;
<span class="lineNum">    1049 </span><span class="lineCov">    4142318 :         guint32 slot = GPOINTER_TO_UINT (data);</span>
<span class="lineNum">    1050 </span><span class="lineCov">    4142318 :         mgreg_t *r = (mgreg_t*)regs;</span>
<span class="lineNum">    1051 </span><span class="lineCov">    4142318 :         gpointer arg = (gpointer)(gssize)r [MONO_ARCH_VTABLE_REG];</span>
<span class="lineNum">    1052 </span><span class="lineCov">    4142318 :         guint32 index = MONO_RGCTX_SLOT_INDEX (slot);</span>
<span class="lineNum">    1053 </span><span class="lineCov">    4142318 :         gboolean mrgctx = MONO_RGCTX_SLOT_IS_MRGCTX (slot);</span>
<span class="lineNum">    1054 </span>            :         MonoError error;
<span class="lineNum">    1055 </span>            :         gpointer res;
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineCov">    4142318 :         trampoline_calls ++;</span>
<span class="lineNum">    1058 </span>            : 
<span class="lineNum">    1059 </span><span class="lineCov">    4142318 :         if (!inited) {</span>
<span class="lineNum">    1060 </span><span class="lineCov">       3274 :                 mono_counters_register (&quot;RGCTX unmanaged lookups&quot;, MONO_COUNTER_GENERICS | MONO_COUNTER_INT, &amp;num_lookups);</span>
<span class="lineNum">    1061 </span><span class="lineCov">       3274 :                 inited = TRUE;</span>
<span class="lineNum">    1062 </span><span class="lineCov">       3274 :         }</span>
<span class="lineNum">    1063 </span>            : 
<span class="lineNum">    1064 </span><span class="lineCov">    4142538 :         num_lookups++;</span>
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span><span class="lineCov">    4142538 :         if (mrgctx)</span>
<span class="lineNum">    1067 </span><span class="lineCov">     882704 :                 res = mono_method_fill_runtime_generic_context ((MonoMethodRuntimeGenericContext *)arg, index, &amp;error);</span>
<span class="lineNum">    1068 </span>            :         else
<span class="lineNum">    1069 </span><span class="lineCov">    3259807 :                 res = mono_class_fill_runtime_generic_context ((MonoVTable *)arg, index, &amp;error);</span>
<span class="lineNum">    1070 </span><span class="lineCov">    4142937 :         if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :                 mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1073 </span>            :         }
<span class="lineNum">    1074 </span><span class="lineCov">    4142940 :         return res;</span>
<span class="lineNum">    1075 </span><span class="lineCov">    4142940 : }</span>
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span>            : /**
<span class="lineNum">    1078 </span>            :  * mono_delegate_trampoline:
<span class="lineNum">    1079 </span>            :  *
<span class="lineNum">    1080 </span>            :  *   This trampoline handles calls made to Delegate:Invoke ().
<span class="lineNum">    1081 </span>            :  * This is called once the first time a delegate is invoked, so it must be fast.
<a name="1082"><span class="lineNum">    1082 </span>            :  */</a>
<span class="lineNum">    1083 </span>            : gpointer
<span class="lineNum">    1084 </span>            : mono_delegate_trampoline (mgreg_t *regs, guint8 *code, gpointer *arg, guint8* tramp)
<span class="lineNum">    1085 </span>            : {
<span class="lineNum">    1086 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span><span class="lineCov">     629789 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    1089 </span>            :         MonoDelegate *delegate;
<span class="lineNum">    1090 </span>            :         MonoJitInfo *ji;
<span class="lineNum">    1091 </span>            :         MonoMethod *m;
<span class="lineNum">    1092 </span><span class="lineCov">     629789 :         MonoMethod *method = NULL;</span>
<span class="lineNum">    1093 </span>            :         MonoError error;
<span class="lineNum">    1094 </span><span class="lineCov">     629789 :         gboolean multicast, callvirt = FALSE, closed_over_null = FALSE;</span>
<span class="lineNum">    1095 </span><span class="lineCov">     629789 :         gboolean need_rgctx_tramp = FALSE;</span>
<span class="lineNum">    1096 </span><span class="lineCov">     629789 :         gboolean need_unbox_tramp = FALSE;</span>
<span class="lineNum">    1097 </span><span class="lineCov">     629789 :         gboolean enable_caching = TRUE;</span>
<span class="lineNum">    1098 </span><span class="lineCov">     629789 :         MonoDelegateTrampInfo *tramp_info = (MonoDelegateTrampInfo*)arg;</span>
<span class="lineNum">    1099 </span><span class="lineCov">     629789 :         MonoMethod *invoke = tramp_info-&gt;invoke;</span>
<span class="lineNum">    1100 </span><span class="lineCov">     629789 :         guint8 *impl_this = (guint8 *)tramp_info-&gt;impl_this;</span>
<span class="lineNum">    1101 </span><span class="lineCov">     629789 :         guint8 *impl_nothis = (guint8 *)tramp_info-&gt;impl_nothis;</span>
<span class="lineNum">    1102 </span>            :         MonoError err;
<span class="lineNum">    1103 </span>            :         MonoMethodSignature *sig;
<span class="lineNum">    1104 </span>            :         gpointer addr, compiled_method;
<span class="lineNum">    1105 </span><span class="lineCov">     629789 :         gboolean is_remote = FALSE;</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineCov">     629789 :         trampoline_calls ++;</span>
<span class="lineNum">    1108 </span>            : 
<span class="lineNum">    1109 </span>            :         /* Obtain the delegate object according to the calling convention */
<span class="lineNum">    1110 </span><span class="lineCov">     629789 :         delegate = (MonoDelegate *)mono_arch_get_this_arg_from_call (regs, code);</span>
<span class="lineNum">    1111 </span><span class="lineCov">    1889797 :         g_assert (mono_class_has_parent (mono_object_class (delegate), mono_defaults.multicastdelegate_class));</span>
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span><span class="lineCov">     629972 :         if (delegate-&gt;method) {</span>
<span class="lineNum">    1114 </span><span class="lineCov">     629911 :                 method = delegate-&gt;method;</span>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span>            :                 /*
<span class="lineNum">    1117 </span>            :                  * delegate-&gt;method_ptr == NULL means the delegate was initialized by 
<span class="lineNum">    1118 </span>            :                  * mini_delegate_ctor, while != NULL means it is initialized by 
<span class="lineNum">    1119 </span>            :                  * mono_delegate_ctor_with_method (). In both cases, we need to add wrappers
<span class="lineNum">    1120 </span>            :                  * (ctor_with_method () does this, but it doesn't store the wrapper back into
<span class="lineNum">    1121 </span>            :                  * delegate-&gt;method).
<span class="lineNum">    1122 </span>            :                  */
<span class="lineNum">    1123 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    1124 </span><span class="lineCov">    1236705 :                 if (delegate-&gt;target &amp;&amp; mono_object_is_transparent_proxy (delegate-&gt;target)) {</span>
<span class="lineNum">    1125 </span><span class="lineCov">         10 :                         is_remote = TRUE;</span>
<span class="lineNum">    1126 </span>            : #ifndef DISABLE_COM
<span class="lineNum">    1127 </span><span class="lineCov">         20 :                         if (((MonoTransparentProxy *)delegate-&gt;target)-&gt;remote_class-&gt;proxy_class != mono_class_get_com_object_class () &amp;&amp;</span>
<span class="lineNum">    1128 </span><span class="lineCov">         10 :                            !mono_class_is_com_object (((MonoTransparentProxy *)delegate-&gt;target)-&gt;remote_class-&gt;proxy_class))</span>
<span class="lineNum">    1129 </span>            : #endif
<span class="lineNum">    1130 </span><span class="lineCov">         10 :                                 method = mono_marshal_get_remoting_invoke (method);</span>
<span class="lineNum">    1131 </span><span class="lineCov">         10 :                 }</span>
<span class="lineNum">    1132 </span>            : #endif
<span class="lineNum">    1133 </span><span class="lineCov">     629766 :                 if (!is_remote) {</span>
<span class="lineNum">    1134 </span><span class="lineCov">     629931 :                         sig = tramp_info-&gt;sig;</span>
<span class="lineNum">    1135 </span><span class="lineCov">     838175 :                         if (!(sig &amp;&amp; method == tramp_info-&gt;method)) {</span>
<span class="lineNum">    1136 </span><span class="lineCov">     421686 :                                 mono_error_init (&amp;err);</span>
<span class="lineNum">    1137 </span><span class="lineCov">     421686 :                                 sig = mono_method_signature_checked (method, &amp;err);</span>
<span class="lineNum">    1138 </span><span class="lineCov">     421686 :                                 if (!sig) {</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :                                         mono_error_set_pending_exception (&amp;err);</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :                                         return NULL;</span>
<span class="lineNum">    1141 </span>            :                                 }
<span class="lineNum">    1142 </span><span class="lineCov">     421699 :                         }</span>
<span class="lineNum">    1143 </span>            : 
<span class="lineNum">    1144 </span><span class="lineCov">    1237853 :                         if (sig-&gt;hasthis &amp;&amp; method-&gt;klass-&gt;valuetype) {</span>
<span class="lineNum">    1145 </span><span class="lineCov">          6 :                                 gboolean need_unbox = TRUE;</span>
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span><span class="lineCov">          8 :                                 if (tramp_info-&gt;invoke_sig-&gt;param_count &gt; sig-&gt;param_count &amp;&amp; tramp_info-&gt;invoke_sig-&gt;params [0]-&gt;byref)</span>
<span class="lineNum">    1148 </span><span class="lineCov">          2 :                                         need_unbox = FALSE;</span>
<span class="lineNum">    1149 </span>            : 
<span class="lineNum">    1150 </span><span class="lineCov">          6 :                                 if (need_unbox) {</span>
<span class="lineNum">    1151 </span><span class="lineCov">          4 :                                         if (mono_aot_only)</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :                                                 need_unbox_tramp = TRUE;</span>
<span class="lineNum">    1153 </span>            :                                         else
<span class="lineNum">    1154 </span><span class="lineCov">          4 :                                                 method = mono_marshal_get_unbox_wrapper (method);</span>
<span class="lineNum">    1155 </span><span class="lineCov">          4 :                                 }</span>
<span class="lineNum">    1156 </span><span class="lineCov">          6 :                         }</span>
<span class="lineNum">    1157 </span><span class="lineCov">     629868 :                 }</span>
<span class="lineNum">    1158 </span>            :         // If &quot;delegate-&gt;method_ptr&quot; is null mono_get_addr_from_ftnptr will fail if
<span class="lineNum">    1159 </span>            :         // ftnptrs are being used.  &quot;method&quot; would end up null on archtitectures without
<span class="lineNum">    1160 </span>            :         // ftnptrs so we can just skip this.
<span class="lineNum">    1161 </span><span class="lineCov">     629964 :         } else if (delegate-&gt;method_ptr) {</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :                 ji = mono_jit_info_table_find (domain, (char *)mono_get_addr_from_ftnptr (delegate-&gt;method_ptr));</span>
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :                 if (ji)</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :                         method = jinfo_get_method (ji);</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineCov">     629988 :         if (method) {</span>
<span class="lineNum">    1168 </span><span class="lineCov">     629933 :                 sig = tramp_info-&gt;sig;</span>
<span class="lineNum">    1169 </span><span class="lineCov">     838190 :                 if (!(sig &amp;&amp; method == tramp_info-&gt;method)) {</span>
<span class="lineNum">    1170 </span><span class="lineCov">     421748 :                         mono_error_init (&amp;err);</span>
<span class="lineNum">    1171 </span><span class="lineCov">     421748 :                         sig = mono_method_signature_checked (method, &amp;err);</span>
<span class="lineNum">    1172 </span><span class="lineCov">     421748 :                         if (!sig) {</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :                                 mono_error_set_pending_exception (&amp;err);</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :                                 return NULL;</span>
<span class="lineNum">    1175 </span>            :                         }
<span class="lineNum">    1176 </span><span class="lineCov">     421707 :                 }</span>
<span class="lineNum">    1177 </span>            : 
<span class="lineNum">    1178 </span><span class="lineCov">    1282877 :                 callvirt = !delegate-&gt;target &amp;&amp; sig-&gt;hasthis;</span>
<span class="lineNum">    1179 </span><span class="lineCov">     629937 :                 if (callvirt)</span>
<span class="lineNum">    1180 </span><span class="lineCov">       1154 :                         closed_over_null = tramp_info-&gt;invoke_sig-&gt;param_count == sig-&gt;param_count;</span>
<span class="lineNum">    1181 </span>            : 
<span class="lineNum">    1182 </span><span class="lineCov">     631064 :                 if (callvirt &amp;&amp; !closed_over_null) {</span>
<span class="lineNum">    1183 </span>            :                         /*
<span class="lineNum">    1184 </span>            :                          * The delegate needs to make a virtual call to the target method using its
<span class="lineNum">    1185 </span>            :                          * first argument as the receiver. This is hard to support in full-aot, so
<span class="lineNum">    1186 </span>            :                          * optimize it in some cases if possible.
<span class="lineNum">    1187 </span>            :                          * If the target method is not virtual or is in a sealed class,
<span class="lineNum">    1188 </span>            :                          * the vcall will call it directly.
<span class="lineNum">    1189 </span>            :                          * If the call doesn't return a valuetype, then the vcall uses the same calling
<span class="lineNum">    1190 </span>            :                          * convention as a normal call.
<span class="lineNum">    1191 </span>            :                          */
<span class="lineNum">    1192 </span><span class="lineCov">       3360 :                         if ((mono_class_is_sealed (method-&gt;klass) || !(method-&gt;flags &amp; METHOD_ATTRIBUTE_VIRTUAL)) &amp;&amp; !MONO_TYPE_ISSTRUCT (sig-&gt;ret)) {</span>
<span class="lineNum">    1193 </span><span class="lineCov">       1154 :                                 callvirt = FALSE;</span>
<span class="lineNum">    1194 </span><span class="lineCov">       1154 :                                 enable_caching = FALSE;</span>
<span class="lineNum">    1195 </span><span class="lineCov">       1154 :                         }</span>
<span class="lineNum">    1196 </span><span class="lineCov">       1154 :                 }</span>
<span class="lineNum">    1197 </span>            : 
<span class="lineNum">    1198 </span><span class="lineCov">     629856 :                 if (delegate-&gt;target &amp;&amp; </span>
<span class="lineNum">    1199 </span><span class="lineCov">     606968 :                         method-&gt;flags &amp; METHOD_ATTRIBUTE_VIRTUAL &amp;&amp; </span>
<span class="lineNum">    1200 </span><span class="lineCov">      14184 :                         method-&gt;flags &amp; METHOD_ATTRIBUTE_ABSTRACT &amp;&amp;</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :                         mono_class_is_abstract (method-&gt;klass)) {</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :                         method = mono_object_get_virtual_method (delegate-&gt;target, method);</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :                         enable_caching = FALSE;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1205 </span>            : 
<span class="lineNum">    1206 </span><span class="lineCov">     629855 :                 if (method-&gt;iflags &amp; METHOD_IMPL_ATTRIBUTE_SYNCHRONIZED)</span>
<span class="lineNum">    1207 </span><span class="lineCov">         36 :                         method = mono_marshal_get_synchronized_wrapper (method);</span>
<span class="lineNum">    1208 </span>            : 
<span class="lineNum">    1209 </span><span class="lineCov">     629867 :                 if (method == tramp_info-&gt;method)</span>
<span class="lineNum">    1210 </span><span class="lineCov">     208145 :                         need_rgctx_tramp = tramp_info-&gt;need_rgctx_tramp;</span>
<span class="lineNum">    1211 </span><span class="lineCov">     421284 :                 else if (mono_method_needs_static_rgctx_invoke (method, FALSE))</span>
<span class="lineNum">    1212 </span><span class="lineCov">       2208 :                         need_rgctx_tramp = TRUE;</span>
<span class="lineNum">    1213 </span><span class="lineCov">     629468 :         }</span>
<span class="lineNum">    1214 </span>            : 
<span class="lineNum">    1215 </span>            :         /* 
<span class="lineNum">    1216 </span>            :          * If the called address is a trampoline, replace it with the compiled method so
<span class="lineNum">    1217 </span>            :          * further calls don't have to go through the trampoline.
<span class="lineNum">    1218 </span>            :          */
<span class="lineNum">    1219 </span><span class="lineCov">    1258970 :         if (method &amp;&amp; !callvirt) {</span>
<span class="lineNum">    1220 </span>            :                 /* Avoid the overhead of looking up an already compiled method if possible */
<span class="lineNum">    1221 </span><span class="lineCov">    1668695 :                 if (enable_caching &amp;&amp; delegate-&gt;method_code &amp;&amp; *delegate-&gt;method_code) {</span>
<span class="lineNum">    1222 </span><span class="lineCov">     213247 :                         delegate-&gt;method_ptr = *delegate-&gt;method_code;</span>
<span class="lineNum">    1223 </span><span class="lineCov">     213247 :                 } else {</span>
<span class="lineNum">    1224 </span><span class="lineCov">     416751 :                         compiled_method = addr = mono_jit_compile_method (method, &amp;error);</span>
<span class="lineNum">    1225 </span><span class="lineCov">     416751 :                         if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    1226 </span><span class="lineCov">         26 :                                 mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    1227 </span><span class="lineCov">         26 :                                 return NULL;</span>
<span class="lineNum">    1228 </span>            :                         }
<span class="lineNum">    1229 </span><span class="lineCov">     416715 :                         addr = mini_add_method_trampoline (method, compiled_method, need_rgctx_tramp, need_unbox_tramp);</span>
<span class="lineNum">    1230 </span><span class="lineCov">     416715 :                         delegate-&gt;method_ptr = addr;</span>
<span class="lineNum">    1231 </span><span class="lineCov">     832268 :                         if (enable_caching &amp;&amp; delegate-&gt;method_code)</span>
<span class="lineNum">    1232 </span><span class="lineCov">     197398 :                                 *delegate-&gt;method_code = (guint8 *)delegate-&gt;method_ptr;</span>
<span class="lineNum">    1233 </span>            :                 }
<span class="lineNum">    1234 </span><span class="lineCov">     629738 :         } else {</span>
<span class="lineNum">    1235 </span><span class="lineCov">         43 :                 if (need_rgctx_tramp)</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :                         delegate-&gt;method_ptr = mono_create_static_rgctx_trampoline (method, delegate-&gt;method_ptr);</span>
<span class="lineNum">    1237 </span>            :         }
<span class="lineNum">    1238 </span>            : 
<span class="lineNum">    1239 </span>            :         /* Necessary for !code condition to fallback to slow path */
<span class="lineNum">    1240 </span><span class="lineCov">     629768 :         code = NULL;</span>
<span class="lineNum">    1241 </span>            : 
<span class="lineNum">    1242 </span><span class="lineCov">     629768 :         multicast = ((MonoMulticastDelegate*)delegate)-&gt;delegates != NULL;</span>
<span class="lineNum">    1243 </span><span class="lineCov">    1259553 :         if (!multicast &amp;&amp; !callvirt) {</span>
<span class="lineNum">    1244 </span><span class="lineCov">    1281327 :                 if (method &amp;&amp; (method-&gt;flags &amp; METHOD_ATTRIBUTE_STATIC) &amp;&amp; mono_method_signature (method)-&gt;param_count == mono_method_signature (invoke)-&gt;param_count + 1)</span>
<span class="lineNum">    1245 </span>            :                         /* Closed static delegate */
<span class="lineNum">    1246 </span><span class="lineCov">          2 :                         code = impl_this;</span>
<span class="lineNum">    1247 </span>            :                 else
<span class="lineNum">    1248 </span><span class="lineCov">    1889293 :                         code = delegate-&gt;target ? impl_this : impl_nothis;</span>
<span class="lineNum">    1249 </span><span class="lineCov">     629775 :         }</span>
<span class="lineNum">    1250 </span>            : 
<span class="lineNum">    1251 </span><span class="lineCov">     629848 :         if (!code) {</span>
<span class="lineNum">    1252 </span>            :                 /* The general, unoptimized case */
<span class="lineNum">    1253 </span><span class="lineCov">      21571 :                 m = mono_marshal_get_delegate_invoke (invoke, delegate);</span>
<span class="lineNum">    1254 </span><span class="lineCov">      21571 :                 code = (guint8 *)mono_jit_compile_method (m, &amp;error);</span>
<span class="lineNum">    1255 </span><span class="lineCov">      21571 :                 if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :                         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1258 </span>            :                 }
<span class="lineNum">    1259 </span><span class="lineCov">      21571 :                 code = (guint8 *)mini_add_method_trampoline (m, code, mono_method_needs_static_rgctx_invoke (m, FALSE), FALSE);</span>
<span class="lineNum">    1260 </span><span class="lineCov">      21571 :         }</span>
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span><span class="lineCov">     629750 :         delegate-&gt;invoke_impl = mono_get_addr_from_ftnptr (code);</span>
<span class="lineNum">    1263 </span><span class="lineCov">    1886979 :         if (enable_caching &amp;&amp; !callvirt &amp;&amp; tramp_info-&gt;method) {</span>
<span class="lineNum">    1264 </span><span class="lineCov">     208263 :                 tramp_info-&gt;method_ptr = delegate-&gt;method_ptr;</span>
<span class="lineNum">    1265 </span><span class="lineCov">     208263 :                 tramp_info-&gt;invoke_impl = delegate-&gt;invoke_impl;</span>
<span class="lineNum">    1266 </span><span class="lineCov">     208263 :         }</span>
<span class="lineNum">    1267 </span>            : 
<span class="lineNum">    1268 </span><span class="lineCov">     629765 :         return code;</span>
<span class="lineNum">    1269 </span><span class="lineCov">     629796 : }</span>
<span class="lineNum">    1270 </span>            : 
<a name="1271"><span class="lineNum">    1271 </span>            : #ifdef MONO_ARCH_HAVE_HANDLER_BLOCK_GUARD</a>
<span class="lineNum">    1272 </span>            : static gpointer
<span class="lineNum">    1273 </span>            : mono_handler_block_guard_trampoline (mgreg_t *regs, guint8 *code, gpointer *tramp_info, guint8* tramp)
<span class="lineNum">    1274 </span>            : {
<span class="lineNum">    1275 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    1276 </span>            : 
<span class="lineNum">    1277 </span>            :         MonoContext ctx;
<span class="lineNum">    1278 </span>            :         MonoException *exc;
<span class="lineNum">    1279 </span><span class="lineCov">          8 :         MonoJitTlsData *jit_tls = (MonoJitTlsData *)mono_tls_get_jit_tls ();</span>
<span class="lineNum">    1280 </span><span class="lineCov">          8 :         gpointer resume_ip = jit_tls-&gt;handler_block_return_address;</span>
<span class="lineNum">    1281 </span>            : 
<span class="lineNum">    1282 </span><span class="lineCov">          8 :         memcpy (&amp;ctx, &amp;jit_tls-&gt;handler_block_context, sizeof (MonoContext));</span>
<span class="lineNum">    1283 </span><span class="lineCov">         16 :         MONO_CONTEXT_SET_IP (&amp;ctx, jit_tls-&gt;handler_block_return_address);</span>
<span class="lineNum">    1284 </span>            : 
<span class="lineNum">    1285 </span><span class="lineCov">          8 :         jit_tls-&gt;handler_block_return_address = NULL;</span>
<span class="lineNum">    1286 </span><span class="lineCov">          8 :         jit_tls-&gt;handler_block = NULL;</span>
<span class="lineNum">    1287 </span>            : 
<span class="lineNum">    1288 </span><span class="lineCov">          8 :         if (!resume_ip) /*this should not happen, but we should avoid crashing */</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :                 exc = mono_get_exception_execution_engine (&quot;Invalid internal state, resuming abort after handler block but no resume ip found&quot;);</span>
<span class="lineNum">    1290 </span>            :         else
<span class="lineNum">    1291 </span><span class="lineCov">          8 :                 exc = mono_thread_resume_interruption ();</span>
<span class="lineNum">    1292 </span>            : 
<span class="lineNum">    1293 </span><span class="lineCov">          8 :         if (exc) {</span>
<span class="lineNum">    1294 </span><span class="lineCov">          4 :                 mono_handle_exception (&amp;ctx, (MonoObject *)exc);</span>
<span class="lineNum">    1295 </span><span class="lineCov">          4 :                 mono_restore_context (&amp;ctx);</span>
<span class="lineNum">    1296 </span><span class="lineCov">          4 :         }</span>
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span><span class="lineCov">          4 :         return resume_ip;</span>
<span class="lineNum">    1299 </span>            : }
<a name="1300"><span class="lineNum">    1300 </span>            : </a>
<span class="lineNum">    1301 </span>            : gpointer
<span class="lineNum">    1302 </span>            : mono_create_handler_block_trampoline (void)
<span class="lineNum">    1303 </span>            : {
<span class="lineNum">    1304 </span>            :         static gpointer code;
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineCov">       3293 :         if (code)</span>
<span class="lineNum">    1307 </span><span class="lineCov">          8 :                 return code;</span>
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span><span class="lineCov">       3285 :         if (mono_aot_only) {</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :                 gpointer tmp = mono_aot_get_trampoline (&quot;handler_block_trampoline&quot;);</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                 g_assert (tmp);</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :                 mono_memory_barrier ();</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :                 code = tmp;</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :                 return code;</span>
<span class="lineNum">    1315 </span>            :         }
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span><span class="lineCov">       3285 :         mono_trampolines_lock ();</span>
<span class="lineNum">    1318 </span><span class="lineCov">       3285 :         if (!code) {</span>
<span class="lineNum">    1319 </span>            :                 MonoTrampInfo *info;
<span class="lineNum">    1320 </span>            :                 gpointer tmp;
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span><span class="lineCov">       3285 :                 tmp = mono_arch_create_handler_block_trampoline (&amp;info, FALSE);</span>
<span class="lineNum">    1323 </span><span class="lineCov">       3285 :                 mono_tramp_info_register (info, NULL);</span>
<span class="lineNum">    1324 </span><span class="lineCov">       3285 :                 mono_memory_barrier ();</span>
<span class="lineNum">    1325 </span><span class="lineCov">       3285 :                 code = tmp;</span>
<span class="lineNum">    1326 </span><span class="lineCov">       3285 :         }</span>
<span class="lineNum">    1327 </span><span class="lineCov">       3285 :         mono_trampolines_unlock ();</span>
<span class="lineNum">    1328 </span>            : 
<span class="lineNum">    1329 </span><span class="lineCov">       3285 :         return code;</span>
<span class="lineNum">    1330 </span><span class="lineCov">       3293 : }</span>
<span class="lineNum">    1331 </span>            : #endif
<span class="lineNum">    1332 </span>            : 
<span class="lineNum">    1333 </span>            : /*
<span class="lineNum">    1334 </span>            :  * mono_get_trampoline_func:
<span class="lineNum">    1335 </span>            :  *
<span class="lineNum">    1336 </span>            :  *   Return the C function which needs to be called by the generic trampoline of type
<span class="lineNum">    1337 </span>            :  * TRAMP_TYPE.
<a name="1338"><span class="lineNum">    1338 </span>            :  */</a>
<span class="lineNum">    1339 </span>            : gconstpointer
<span class="lineNum">    1340 </span>            : mono_get_trampoline_func (MonoTrampolineType tramp_type)
<span class="lineNum">    1341 </span>            : {
<span class="lineNum">    1342 </span><span class="lineCov">      42705 :         switch (tramp_type) {</span>
<span class="lineNum">    1343 </span>            :         case MONO_TRAMPOLINE_JIT:
<span class="lineNum">    1344 </span>            :         case MONO_TRAMPOLINE_JUMP:
<span class="lineNum">    1345 </span><span class="lineCov">       6570 :                 return mono_magic_trampoline;</span>
<span class="lineNum">    1346 </span>            :         case MONO_TRAMPOLINE_RGCTX_LAZY_FETCH:
<span class="lineNum">    1347 </span><span class="lineCov">       3285 :                 return mono_rgctx_lazy_fetch_trampoline;</span>
<span class="lineNum">    1348 </span>            : #ifdef MONO_ARCH_AOT_SUPPORTED
<span class="lineNum">    1349 </span>            :         case MONO_TRAMPOLINE_AOT:
<span class="lineNum">    1350 </span><span class="lineCov">       3285 :                 return mono_aot_trampoline;</span>
<span class="lineNum">    1351 </span>            :         case MONO_TRAMPOLINE_AOT_PLT:
<span class="lineNum">    1352 </span><span class="lineCov">       3285 :                 return mono_aot_plt_trampoline;</span>
<span class="lineNum">    1353 </span>            : #endif
<span class="lineNum">    1354 </span>            :         case MONO_TRAMPOLINE_DELEGATE:
<span class="lineNum">    1355 </span><span class="lineCov">       3285 :                 return mono_delegate_trampoline;</span>
<span class="lineNum">    1356 </span>            :         case MONO_TRAMPOLINE_RESTORE_STACK_PROT:
<span class="lineNum">    1357 </span><span class="lineCov">       3285 :                 return mono_altstack_restore_prot;</span>
<span class="lineNum">    1358 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    1359 </span>            :         case MONO_TRAMPOLINE_GENERIC_VIRTUAL_REMOTING:
<span class="lineNum">    1360 </span><span class="lineCov">       3285 :                 return mono_generic_virtual_remoting_trampoline;</span>
<span class="lineNum">    1361 </span>            : #endif
<span class="lineNum">    1362 </span>            :         case MONO_TRAMPOLINE_VCALL:
<span class="lineNum">    1363 </span><span class="lineCov">       3285 :                 return mono_vcall_trampoline;</span>
<span class="lineNum">    1364 </span>            : #ifdef MONO_ARCH_HAVE_HANDLER_BLOCK_GUARD
<span class="lineNum">    1365 </span>            :         case MONO_TRAMPOLINE_HANDLER_BLOCK_GUARD:
<span class="lineNum">    1366 </span><span class="lineCov">      13140 :                 return mono_handler_block_guard_trampoline;</span>
<span class="lineNum">    1367 </span>            : #endif
<span class="lineNum">    1368 </span>            :         default:
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :                 g_assert_not_reached ();</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1371 </span>            :         }
<span class="lineNum">    1372 </span><span class="lineCov">      42705 : }</span>
<a name="1373"><span class="lineNum">    1373 </span>            : </a>
<span class="lineNum">    1374 </span>            : static guchar*
<span class="lineNum">    1375 </span>            : create_trampoline_code (MonoTrampolineType tramp_type)
<span class="lineNum">    1376 </span>            : {
<span class="lineNum">    1377 </span>            :         MonoTrampInfo *info;
<span class="lineNum">    1378 </span>            :         guchar *code;
<span class="lineNum">    1379 </span>            : 
<span class="lineNum">    1380 </span><span class="lineCov">      32850 :         code = mono_arch_create_generic_trampoline (tramp_type, &amp;info, FALSE);</span>
<span class="lineNum">    1381 </span><span class="lineCov">      32850 :         mono_tramp_info_register (info, NULL);</span>
<span class="lineNum">    1382 </span>            : 
<span class="lineNum">    1383 </span><span class="lineCov">      32850 :         return code;</span>
<span class="lineNum">    1384 </span>            : }
<a name="1385"><span class="lineNum">    1385 </span>            : </a>
<span class="lineNum">    1386 </span>            : void
<span class="lineNum">    1387 </span>            : mono_trampolines_init (void)
<span class="lineNum">    1388 </span>            : {
<span class="lineNum">    1389 </span><span class="lineCov">       3285 :         mono_os_mutex_init_recursive (&amp;trampolines_mutex);</span>
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span><span class="lineCov">       3285 :         if (mono_aot_only)</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1393 </span>            : 
<span class="lineNum">    1394 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_JIT] = create_trampoline_code (MONO_TRAMPOLINE_JIT);</span>
<span class="lineNum">    1395 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_JUMP] = create_trampoline_code (MONO_TRAMPOLINE_JUMP);</span>
<span class="lineNum">    1396 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_RGCTX_LAZY_FETCH] = create_trampoline_code (MONO_TRAMPOLINE_RGCTX_LAZY_FETCH);</span>
<span class="lineNum">    1397 </span>            : #ifdef MONO_ARCH_AOT_SUPPORTED
<span class="lineNum">    1398 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_AOT] = create_trampoline_code (MONO_TRAMPOLINE_AOT);</span>
<span class="lineNum">    1399 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_AOT_PLT] = create_trampoline_code (MONO_TRAMPOLINE_AOT_PLT);</span>
<span class="lineNum">    1400 </span>            : #endif
<span class="lineNum">    1401 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_DELEGATE] = create_trampoline_code (MONO_TRAMPOLINE_DELEGATE);</span>
<span class="lineNum">    1402 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_RESTORE_STACK_PROT] = create_trampoline_code (MONO_TRAMPOLINE_RESTORE_STACK_PROT);</span>
<span class="lineNum">    1403 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    1404 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_GENERIC_VIRTUAL_REMOTING] = create_trampoline_code (MONO_TRAMPOLINE_GENERIC_VIRTUAL_REMOTING);</span>
<span class="lineNum">    1405 </span>            : #endif
<span class="lineNum">    1406 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_VCALL] = create_trampoline_code (MONO_TRAMPOLINE_VCALL);</span>
<span class="lineNum">    1407 </span>            : #ifdef MONO_ARCH_HAVE_HANDLER_BLOCK_GUARD
<span class="lineNum">    1408 </span><span class="lineCov">       3285 :         mono_trampoline_code [MONO_TRAMPOLINE_HANDLER_BLOCK_GUARD] = create_trampoline_code (MONO_TRAMPOLINE_HANDLER_BLOCK_GUARD);</span>
<span class="lineNum">    1409 </span><span class="lineCov">       3285 :         mono_create_handler_block_trampoline ();</span>
<span class="lineNum">    1410 </span>            : #endif
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;Calls to trampolines&quot;, MONO_COUNTER_JIT | MONO_COUNTER_INT, &amp;trampoline_calls);</span>
<span class="lineNum">    1413 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;JIT trampolines&quot;, MONO_COUNTER_JIT | MONO_COUNTER_INT, &amp;jit_trampolines);</span>
<span class="lineNum">    1414 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;Unbox trampolines&quot;, MONO_COUNTER_JIT | MONO_COUNTER_INT, &amp;unbox_trampolines);</span>
<span class="lineNum">    1415 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;Static rgctx trampolines&quot;, MONO_COUNTER_JIT | MONO_COUNTER_INT, &amp;static_rgctx_trampolines);</span>
<span class="lineNum">    1416 </span><span class="lineCov">       6570 : }</span>
<a name="1417"><span class="lineNum">    1417 </span>            : </a>
<span class="lineNum">    1418 </span>            : void
<span class="lineNum">    1419 </span>            : mono_trampolines_cleanup (void)
<span class="lineNum">    1420 </span>            : {
<span class="lineNum">    1421 </span><span class="lineCov">       3272 :         if (rgctx_lazy_fetch_trampoline_hash)</span>
<span class="lineNum">    1422 </span><span class="lineCov">       3263 :                 g_hash_table_destroy (rgctx_lazy_fetch_trampoline_hash);</span>
<span class="lineNum">    1423 </span><span class="lineCov">       3272 :         if (rgctx_lazy_fetch_trampoline_hash_addr)</span>
<span class="lineNum">    1424 </span><span class="lineCov">       3263 :                 g_hash_table_destroy (rgctx_lazy_fetch_trampoline_hash_addr);</span>
<span class="lineNum">    1425 </span>            : 
<span class="lineNum">    1426 </span><span class="lineCov">       3272 :         mono_os_mutex_destroy (&amp;trampolines_mutex);</span>
<span class="lineNum">    1427 </span><span class="lineCov">       3272 : }</span>
<a name="1428"><span class="lineNum">    1428 </span>            : </a>
<span class="lineNum">    1429 </span>            : guint8 *
<span class="lineNum">    1430 </span>            : mono_get_trampoline_code (MonoTrampolineType tramp_type)
<span class="lineNum">    1431 </span>            : {
<span class="lineNum">    1432 </span><span class="lineCov">   46389223 :         g_assert (mono_trampoline_code [tramp_type]);</span>
<span class="lineNum">    1433 </span>            : 
<span class="lineNum">    1434 </span><span class="lineCov">   15463077 :         return mono_trampoline_code [tramp_type];</span>
<span class="lineNum">    1435 </span>            : }
<a name="1436"><span class="lineNum">    1436 </span>            : </a>
<span class="lineNum">    1437 </span>            : gpointer
<span class="lineNum">    1438 </span>            : mono_create_specific_trampoline (gpointer arg1, MonoTrampolineType tramp_type, MonoDomain *domain, guint32 *code_len)
<span class="lineNum">    1439 </span>            : {
<span class="lineNum">    1440 </span>            :         gpointer code;
<span class="lineNum">    1441 </span>            :         guint32 len;
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span><span class="lineCov">   15347424 :         if (mono_aot_only)</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                 code = mono_aot_create_specific_trampoline (mono_defaults.corlib, arg1, tramp_type, domain, &amp;len);</span>
<span class="lineNum">    1445 </span>            :         else
<span class="lineNum">    1446 </span><span class="lineCov">   15347424 :                 code = mono_arch_create_specific_trampoline (arg1, tramp_type, domain, &amp;len);</span>
<span class="lineNum">    1447 </span><span class="lineCov">   15347241 :         mono_lldb_save_specific_trampoline_info (arg1, tramp_type, domain, code, len);</span>
<span class="lineNum">    1448 </span><span class="lineCov">   15347241 :         if (code_len)</span>
<span class="lineNum">    1449 </span><span class="lineCov">     537467 :                 *code_len = len;</span>
<span class="lineNum">    1450 </span><span class="lineCov">   15347250 :         return code;</span>
<span class="lineNum">    1451 </span>            : }
<a name="1452"><span class="lineNum">    1452 </span>            : </a>
<span class="lineNum">    1453 </span>            : gpointer
<span class="lineNum">    1454 </span>            : mono_create_jump_trampoline (MonoDomain *domain, MonoMethod *method, gboolean add_sync_wrapper, MonoError *error)
<span class="lineNum">    1455 </span>            : {
<span class="lineNum">    1456 </span>            :         MonoJitInfo *ji;
<span class="lineNum">    1457 </span>            :         gpointer code;
<span class="lineNum">    1458 </span><span class="lineCov">     255480 :         guint32 code_size = 0;</span>
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span><span class="lineCov">     255480 :         mono_error_init (error);</span>
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineCov">     255480 :         code = mono_jit_find_compiled_method_with_jit_info (domain, method, &amp;ji);</span>
<span class="lineNum">    1463 </span>            :         /*
<span class="lineNum">    1464 </span>            :          * We cannot recover the correct type of a shared generic
<span class="lineNum">    1465 </span>            :          * method from its native code address, so we use the
<span class="lineNum">    1466 </span>            :          * trampoline instead.
<span class="lineNum">    1467 </span>            :          * For synchronized methods, the trampoline adds the wrapper.
<span class="lineNum">    1468 </span>            :          */
<span class="lineNum">    1469 </span><span class="lineCov">     503958 :         if (code &amp;&amp; !ji-&gt;has_generic_jit_info &amp;&amp; !(method-&gt;iflags &amp; METHOD_IMPL_ATTRIBUTE_SYNCHRONIZED))</span>
<span class="lineNum">    1470 </span><span class="lineCov">      40514 :                 return code;</span>
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineCov">     214968 :         if (mono_llvm_only) {</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :                 code = mono_jit_compile_method (method, error);</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :                 if (!mono_error_ok (error))</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :                 return code;</span>
<span class="lineNum">    1477 </span>            :         }
<span class="lineNum">    1478 </span>            : 
<span class="lineNum">    1479 </span><span class="lineCov">     214967 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1480 </span><span class="lineCov">     214967 :         code = g_hash_table_lookup (domain_jit_info (domain)-&gt;jump_trampoline_hash, method);</span>
<span class="lineNum">    1481 </span><span class="lineCov">     214967 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1482 </span><span class="lineCov">     214967 :         if (code)</span>
<span class="lineNum">    1483 </span><span class="lineCov">     103842 :                 return code;</span>
<span class="lineNum">    1484 </span>            : 
<span class="lineNum">    1485 </span><span class="lineCov">     111127 :         code = mono_create_specific_trampoline (method, MONO_TRAMPOLINE_JUMP, mono_domain_get (), &amp;code_size);</span>
<span class="lineNum">    1486 </span><span class="lineCov">     333381 :         g_assert (code_size);</span>
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span><span class="lineCov">     111127 :         ji = (MonoJitInfo *)mono_domain_alloc0 (domain, MONO_SIZEOF_JIT_INFO);</span>
<span class="lineNum">    1489 </span><span class="lineCov">     111127 :         ji-&gt;code_start = code;</span>
<span class="lineNum">    1490 </span><span class="lineCov">     111127 :         ji-&gt;code_size = code_size;</span>
<span class="lineNum">    1491 </span><span class="lineCov">     111127 :         ji-&gt;d.method = method;</span>
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span>            :         /*
<span class="lineNum">    1494 </span>            :          * mono_delegate_ctor needs to find the method metadata from the 
<span class="lineNum">    1495 </span>            :          * trampoline address, so we save it here.
<span class="lineNum">    1496 </span>            :          */
<span class="lineNum">    1497 </span>            : 
<span class="lineNum">    1498 </span><span class="lineCov">     111127 :         mono_jit_info_table_add (domain, ji);</span>
<span class="lineNum">    1499 </span>            : 
<span class="lineNum">    1500 </span><span class="lineCov">     111127 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1501 </span><span class="lineCov">     111127 :         g_hash_table_insert (domain_jit_info (domain)-&gt;jump_trampoline_hash, method, ji-&gt;code_start);</span>
<span class="lineNum">    1502 </span><span class="lineCov">     111127 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1503 </span>            : 
<span class="lineNum">    1504 </span><span class="lineCov">     111127 :         return ji-&gt;code_start;</span>
<span class="lineNum">    1505 </span><span class="lineCov">     255481 : }</span>
<a name="1506"><span class="lineNum">    1506 </span>            : </a>
<span class="lineNum">    1507 </span>            : static void
<span class="lineNum">    1508 </span>            : method_not_found (void)
<span class="lineNum">    1509 </span>            : {
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :         g_assert_not_reached ();</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 : }</span>
<a name="1512"><span class="lineNum">    1512 </span>            : </a>
<span class="lineNum">    1513 </span>            : gpointer
<span class="lineNum">    1514 </span>            : mono_create_jit_trampoline (MonoDomain *domain, MonoMethod *method, MonoError *error)
<span class="lineNum">    1515 </span>            : {
<span class="lineNum">    1516 </span>            :         gpointer tramp;
<span class="lineNum">    1517 </span>            : 
<span class="lineNum">    1518 </span><span class="lineCov">   47134636 :         mono_error_init (error);</span>
<span class="lineNum">    1519 </span>            : 
<span class="lineNum">    1520 </span><span class="lineCov">   47134636 :         if (mono_aot_only) {</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :                 if (mono_llvm_only &amp;&amp; method-&gt;iflags &amp; METHOD_IMPL_ATTRIBUTE_SYNCHRONIZED)</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :                         method = mono_marshal_get_synchronized_wrapper (method);</span>
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span>            :                 /* Avoid creating trampolines if possible */
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :                 gpointer code = mono_jit_find_compiled_method (domain, method);</span>
<span class="lineNum">    1526 </span>            :                 
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :                 if (code)</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :                         return code;</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :                 if (mono_llvm_only) {</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :                         if (method-&gt;wrapper_type == MONO_WRAPPER_PROXY_ISINST)</span>
<span class="lineNum">    1531 </span>            :                                 /* These wrappers are not generated */
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                                 return method_not_found;</span>
<span class="lineNum">    1533 </span>            :                         /* Methods are lazily initialized on first call, so this can't lead recursion */
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :                         code = mono_jit_compile_method (method, error);</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :                         if (!mono_error_ok (error))</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :                                 return NULL;</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :                         return code;</span>
<span class="lineNum">    1538 </span>            :                 }
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1540 </span>            : 
<span class="lineNum">    1541 </span><span class="lineCov">   47139680 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1542 </span><span class="lineCov">   47139680 :         tramp = g_hash_table_lookup (domain_jit_info (domain)-&gt;jit_trampoline_hash, method);</span>
<span class="lineNum">    1543 </span><span class="lineCov">   47139680 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1544 </span><span class="lineCov">   47139680 :         if (tramp)</span>
<span class="lineNum">    1545 </span><span class="lineCov">   33573790 :                 return tramp;</span>
<span class="lineNum">    1546 </span>            : 
<span class="lineNum">    1547 </span><span class="lineCov">   13566034 :         tramp = mono_create_specific_trampoline (method, MONO_TRAMPOLINE_JIT, domain, NULL);</span>
<span class="lineNum">    1548 </span>            :         
<span class="lineNum">    1549 </span><span class="lineCov">   13566034 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1550 </span><span class="lineCov">   13566034 :         g_hash_table_insert (domain_jit_info (domain)-&gt;jit_trampoline_hash, method, tramp);</span>
<span class="lineNum">    1551 </span><span class="lineCov">   13566034 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1552 </span>            : 
<span class="lineNum">    1553 </span><span class="lineCov">   13566034 :         jit_trampolines++;</span>
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span><span class="lineCov">   13566034 :         return tramp;</span>
<span class="lineNum">    1556 </span><span class="lineCov">   47139712 : }       </span>
<a name="1557"><span class="lineNum">    1557 </span>            : </a>
<span class="lineNum">    1558 </span>            : gpointer
<span class="lineNum">    1559 </span>            : mono_create_jit_trampoline_from_token (MonoImage *image, guint32 token)
<span class="lineNum">    1560 </span>            : {
<span class="lineNum">    1561 </span>            :         gpointer tramp;
<span class="lineNum">    1562 </span>            : 
<span class="lineNum">    1563 </span><span class="lineCov">     285886 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    1564 </span>            :         guint8 *buf, *start;
<span class="lineNum">    1565 </span>            : 
<span class="lineNum">    1566 </span><span class="lineCov">     285886 :         buf = start = (guint8 *)mono_domain_alloc0 (domain, 2 * sizeof (gpointer));</span>
<span class="lineNum">    1567 </span>            : 
<span class="lineNum">    1568 </span><span class="lineCov">     285886 :         *(gpointer*)(gpointer)buf = image;</span>
<span class="lineNum">    1569 </span><span class="lineCov">     285886 :         buf += sizeof (gpointer);</span>
<span class="lineNum">    1570 </span><span class="lineCov">     285886 :         *(guint32*)(gpointer)buf = token;</span>
<span class="lineNum">    1571 </span>            : 
<span class="lineNum">    1572 </span><span class="lineCov">     285886 :         tramp = mono_create_specific_trampoline (start, MONO_TRAMPOLINE_AOT, domain, NULL);</span>
<span class="lineNum">    1573 </span>            : 
<span class="lineNum">    1574 </span><span class="lineCov">     285886 :         jit_trampolines++;</span>
<span class="lineNum">    1575 </span>            : 
<span class="lineNum">    1576 </span><span class="lineCov">     285886 :         return tramp;</span>
<span class="lineNum">    1577 </span>            : }       
<span class="lineNum">    1578 </span>            : 
<span class="lineNum">    1579 </span>            : 
<span class="lineNum">    1580 </span>            : /*
<span class="lineNum">    1581 </span>            :  * mono_create_delegate_trampoline_info:
<span class="lineNum">    1582 </span>            :  *
<span class="lineNum">    1583 </span>            :  *  Create a trampoline info structure for the KLASS+METHOD pair.
<a name="1584"><span class="lineNum">    1584 </span>            :  */</a>
<span class="lineNum">    1585 </span>            : MonoDelegateTrampInfo*
<span class="lineNum">    1586 </span>            : mono_create_delegate_trampoline_info (MonoDomain *domain, MonoClass *klass, MonoMethod *method)
<span class="lineNum">    1587 </span>            : {
<span class="lineNum">    1588 </span>            :         MonoMethod *invoke;
<span class="lineNum">    1589 </span>            :         MonoError error;
<span class="lineNum">    1590 </span>            :         MonoDelegateTrampInfo *tramp_info;
<span class="lineNum">    1591 </span>            :         MonoClassMethodPair pair, *dpair;
<span class="lineNum">    1592 </span><span class="lineCov">     605658 :         guint32 code_size = 0;</span>
<span class="lineNum">    1593 </span>            : 
<span class="lineNum">    1594 </span><span class="lineCov">     605658 :         pair.klass = klass;</span>
<span class="lineNum">    1595 </span><span class="lineCov">     605658 :         pair.method = method;</span>
<span class="lineNum">    1596 </span><span class="lineCov">     605658 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1597 </span><span class="lineCov">     605658 :         tramp_info = (MonoDelegateTrampInfo *)g_hash_table_lookup (domain_jit_info (domain)-&gt;delegate_trampoline_hash, &amp;pair);</span>
<span class="lineNum">    1598 </span><span class="lineCov">     605658 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1599 </span><span class="lineCov">     605658 :         if (tramp_info)</span>
<span class="lineNum">    1600 </span><span class="lineCov">     179313 :                 return tramp_info;</span>
<span class="lineNum">    1601 </span>            : 
<span class="lineNum">    1602 </span><span class="lineCov">     426346 :         invoke = mono_get_delegate_invoke (klass);</span>
<span class="lineNum">    1603 </span><span class="lineCov">    1279030 :         g_assert (invoke);</span>
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span><span class="lineCov">     426344 :         tramp_info = (MonoDelegateTrampInfo *)mono_domain_alloc0 (domain, sizeof (MonoDelegateTrampInfo));</span>
<span class="lineNum">    1606 </span><span class="lineCov">     426344 :         tramp_info-&gt;invoke = invoke;</span>
<span class="lineNum">    1607 </span><span class="lineCov">     426344 :         tramp_info-&gt;invoke_sig = mono_method_signature (invoke);</span>
<span class="lineNum">    1608 </span><span class="lineCov">     426344 :         tramp_info-&gt;impl_this = mono_arch_get_delegate_invoke_impl (mono_method_signature (invoke), TRUE);</span>
<span class="lineNum">    1609 </span><span class="lineCov">     426344 :         tramp_info-&gt;impl_nothis = mono_arch_get_delegate_invoke_impl (mono_method_signature (invoke), FALSE);</span>
<span class="lineNum">    1610 </span><span class="lineCov">     426344 :         tramp_info-&gt;method = method;</span>
<span class="lineNum">    1611 </span><span class="lineCov">     426344 :         if (method) {</span>
<span class="lineNum">    1612 </span><span class="lineCov">     308122 :                 mono_error_init (&amp;error);</span>
<span class="lineNum">    1613 </span><span class="lineCov">     308122 :                 tramp_info-&gt;sig = mono_method_signature_checked (method, &amp;error);</span>
<span class="lineNum">    1614 </span><span class="lineCov">     308122 :                 tramp_info-&gt;need_rgctx_tramp = mono_method_needs_static_rgctx_invoke (method, FALSE);</span>
<span class="lineNum">    1615 </span><span class="lineCov">     308122 :         }</span>
<span class="lineNum">    1616 </span><span class="lineCov">     426339 :         tramp_info-&gt;invoke_impl = mono_create_specific_trampoline (tramp_info, MONO_TRAMPOLINE_DELEGATE, domain, &amp;code_size);</span>
<span class="lineNum">    1617 </span><span class="lineCov">    1279019 :         g_assert (code_size);</span>
<span class="lineNum">    1618 </span>            : 
<span class="lineNum">    1619 </span><span class="lineCov">     426339 :         dpair = (MonoClassMethodPair *)mono_domain_alloc0 (domain, sizeof (MonoClassMethodPair));</span>
<span class="lineNum">    1620 </span><span class="lineCov">     426339 :         memcpy (dpair, &amp;pair, sizeof (MonoClassMethodPair));</span>
<span class="lineNum">    1621 </span>            : 
<span class="lineNum">    1622 </span>            :         /* store trampoline address */
<span class="lineNum">    1623 </span><span class="lineCov">     426339 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1624 </span><span class="lineCov">     426339 :         g_hash_table_insert (domain_jit_info (domain)-&gt;delegate_trampoline_hash, dpair, tramp_info);</span>
<span class="lineNum">    1625 </span><span class="lineCov">     426339 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1626 </span>            : 
<span class="lineNum">    1627 </span><span class="lineCov">     426339 :         return tramp_info;</span>
<span class="lineNum">    1628 </span><span class="lineCov">     605658 : }</span>
<a name="1629"><span class="lineNum">    1629 </span>            : </a>
<span class="lineNum">    1630 </span>            : static void
<span class="lineNum">    1631 </span>            : no_delegate_trampoline (void)
<span class="lineNum">    1632 </span>            : {
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :         g_assert_not_reached ();</span>
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 : }</span>
<a name="1635"><span class="lineNum">    1635 </span>            : </a>
<span class="lineNum">    1636 </span>            : gpointer
<span class="lineNum">    1637 </span>            : mono_create_delegate_trampoline (MonoDomain *domain, MonoClass *klass)
<span class="lineNum">    1638 </span>            : {
<span class="lineNum">    1639 </span><span class="lineCov">     265335 :         if (mono_llvm_only)</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :                 return no_delegate_trampoline;</span>
<span class="lineNum">    1641 </span>            : 
<span class="lineNum">    1642 </span><span class="lineCov">     265333 :         return mono_create_delegate_trampoline_info (domain, klass, NULL)-&gt;invoke_impl;</span>
<span class="lineNum">    1643 </span><span class="lineCov">     265382 : }</span>
<a name="1644"><span class="lineNum">    1644 </span>            : </a>
<span class="lineNum">    1645 </span>            : gpointer
<span class="lineNum">    1646 </span>            : mono_create_delegate_virtual_trampoline (MonoDomain *domain, MonoClass *klass, MonoMethod *method)
<span class="lineNum">    1647 </span>            : {
<span class="lineNum">    1648 </span><span class="lineCov">      14231 :         MonoMethod *invoke = mono_get_delegate_invoke (klass);</span>
<span class="lineNum">    1649 </span><span class="lineCov">      42693 :         g_assert (invoke);</span>
<span class="lineNum">    1650 </span>            : 
<span class="lineNum">    1651 </span><span class="lineCov">      14231 :         return mono_get_delegate_virtual_invoke_impl (mono_method_signature (invoke), method);</span>
<span class="lineNum">    1652 </span>            : }
<a name="1653"><span class="lineNum">    1653 </span>            : </a>
<span class="lineNum">    1654 </span>            : gpointer
<span class="lineNum">    1655 </span>            : mono_create_rgctx_lazy_fetch_trampoline (guint32 offset)
<span class="lineNum">    1656 </span>            : {
<span class="lineNum">    1657 </span>            :         static gboolean inited = FALSE;
<span class="lineNum">    1658 </span>            :         static int num_trampolines = 0;
<span class="lineNum">    1659 </span>            :         MonoTrampInfo *info;
<span class="lineNum">    1660 </span>            : 
<span class="lineNum">    1661 </span>            :         gpointer tramp, ptr;
<span class="lineNum">    1662 </span>            : 
<span class="lineNum">    1663 </span><span class="lineCov">    2293013 :         mono_trampolines_lock ();</span>
<span class="lineNum">    1664 </span><span class="lineCov">    2293013 :         if (rgctx_lazy_fetch_trampoline_hash)</span>
<span class="lineNum">    1665 </span><span class="lineCov">    2289739 :                 tramp = g_hash_table_lookup (rgctx_lazy_fetch_trampoline_hash, GUINT_TO_POINTER (offset));</span>
<span class="lineNum">    1666 </span>            :         else
<span class="lineNum">    1667 </span><span class="lineCov">       3274 :                 tramp = NULL;</span>
<span class="lineNum">    1668 </span><span class="lineCov">    2293012 :         mono_trampolines_unlock ();</span>
<span class="lineNum">    1669 </span><span class="lineCov">    2293012 :         if (tramp)</span>
<span class="lineNum">    1670 </span><span class="lineCov">    2177321 :                 return tramp;</span>
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span><span class="lineCov">     115692 :         if (mono_aot_only) {</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :                 ptr = mono_aot_get_lazy_fetch_trampoline (offset);</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1675 </span><span class="lineCov">     115692 :                 tramp = mono_arch_create_rgctx_lazy_fetch_trampoline (offset, &amp;info, FALSE);</span>
<span class="lineNum">    1676 </span><span class="lineCov">     115692 :                 mono_tramp_info_register (info, NULL);</span>
<span class="lineNum">    1677 </span><span class="lineCov">     115692 :                 ptr = mono_create_ftnptr (mono_get_root_domain (), tramp);</span>
<span class="lineNum">    1678 </span>            :         }
<span class="lineNum">    1679 </span>            : 
<span class="lineNum">    1680 </span><span class="lineCov">     115692 :         mono_trampolines_lock ();</span>
<span class="lineNum">    1681 </span><span class="lineCov">     115692 :         if (!rgctx_lazy_fetch_trampoline_hash) {</span>
<span class="lineNum">    1682 </span><span class="lineCov">       3274 :                 rgctx_lazy_fetch_trampoline_hash = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">    1683 </span><span class="lineCov">       3274 :                 rgctx_lazy_fetch_trampoline_hash_addr = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">    1684 </span><span class="lineCov">       3274 :         }</span>
<span class="lineNum">    1685 </span><span class="lineCov">     115692 :         g_hash_table_insert (rgctx_lazy_fetch_trampoline_hash, GUINT_TO_POINTER (offset), ptr);</span>
<span class="lineNum">    1686 </span><span class="lineCov">     347076 :         g_assert (offset != -1);</span>
<span class="lineNum">    1687 </span><span class="lineCov">     115692 :         g_hash_table_insert (rgctx_lazy_fetch_trampoline_hash_addr, ptr, GUINT_TO_POINTER (offset + 1));</span>
<span class="lineNum">    1688 </span><span class="lineCov">     115692 :         mono_trampolines_unlock ();</span>
<span class="lineNum">    1689 </span>            : 
<span class="lineNum">    1690 </span><span class="lineCov">     115692 :         if (!inited) {</span>
<span class="lineNum">    1691 </span><span class="lineCov">       3274 :                 mono_counters_register (&quot;RGCTX num lazy fetch trampolines&quot;,</span>
<span class="lineNum">    1692 </span>            :                                 MONO_COUNTER_GENERICS | MONO_COUNTER_INT, &amp;num_trampolines);
<span class="lineNum">    1693 </span><span class="lineCov">       3274 :                 inited = TRUE;</span>
<span class="lineNum">    1694 </span><span class="lineCov">       3274 :         }</span>
<span class="lineNum">    1695 </span><span class="lineCov">     115692 :         num_trampolines++;</span>
<span class="lineNum">    1696 </span>            : 
<span class="lineNum">    1697 </span><span class="lineCov">     115692 :         return ptr;</span>
<span class="lineNum">    1698 </span><span class="lineCov">    2293011 : }</span>
<a name="1699"><span class="lineNum">    1699 </span>            : </a>
<span class="lineNum">    1700 </span>            : guint32
<span class="lineNum">    1701 </span>            : mono_find_rgctx_lazy_fetch_trampoline_by_addr (gconstpointer addr)
<span class="lineNum">    1702 </span>            : {
<span class="lineNum">    1703 </span>            :         int offset;
<span class="lineNum">    1704 </span>            : 
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :         mono_trampolines_lock ();</span>
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :         if (rgctx_lazy_fetch_trampoline_hash_addr) {</span>
<span class="lineNum">    1707 </span>            :                 /* We store the real offset + 1 so we can detect when the lookup fails */
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :                 offset = GPOINTER_TO_INT (g_hash_table_lookup (rgctx_lazy_fetch_trampoline_hash_addr, addr));</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :                 if (offset)</span>
<span class="lineNum">    1710 </span><span class="lineNoCov">          0 :                         offset -= 1;</span>
<span class="lineNum">    1711 </span>            :                 else
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :                         offset = -1;</span>
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :                 offset = -1;</span>
<span class="lineNum">    1715 </span>            :         }
<span class="lineNum">    1716 </span><span class="lineNoCov">          0 :         mono_trampolines_unlock ();</span>
<span class="lineNum">    1717 </span><span class="lineNoCov">          0 :         return offset;</span>
<span class="lineNum">    1718 </span>            : }
<span class="lineNum">    1719 </span>            : 
<span class="lineNum">    1720 </span>            : static const char*tramp_names [MONO_TRAMPOLINE_NUM] = {
<span class="lineNum">    1721 </span>            :         &quot;jit&quot;,
<span class="lineNum">    1722 </span>            :         &quot;jump&quot;,
<span class="lineNum">    1723 </span>            :         &quot;rgctx_lazy_fetch&quot;,
<span class="lineNum">    1724 </span>            :         &quot;aot&quot;,
<span class="lineNum">    1725 </span>            :         &quot;aot_plt&quot;,
<span class="lineNum">    1726 </span>            :         &quot;delegate&quot;,
<span class="lineNum">    1727 </span>            :         &quot;restore_stack_prot&quot;,
<span class="lineNum">    1728 </span>            :         &quot;generic_virtual_remoting&quot;,
<span class="lineNum">    1729 </span>            :         &quot;vcall&quot;,
<span class="lineNum">    1730 </span>            :         &quot;handler_block_guard&quot;
<span class="lineNum">    1731 </span>            : };
<span class="lineNum">    1732 </span>            : 
<span class="lineNum">    1733 </span>            : /*
<span class="lineNum">    1734 </span>            :  * mono_get_generic_trampoline_simple_name:
<span class="lineNum">    1735 </span>            :  *
<a name="1736"><span class="lineNum">    1736 </span>            :  */</a>
<span class="lineNum">    1737 </span>            : const char*
<span class="lineNum">    1738 </span>            : mono_get_generic_trampoline_simple_name (MonoTrampolineType tramp_type)
<span class="lineNum">    1739 </span>            : {
<span class="lineNum">    1740 </span><span class="lineCov">   15463039 :         return tramp_names [tramp_type];</span>
<span class="lineNum">    1741 </span>            : }
<span class="lineNum">    1742 </span>            : 
<span class="lineNum">    1743 </span>            : /*
<span class="lineNum">    1744 </span>            :  * mono_get_generic_trampoline_name:
<span class="lineNum">    1745 </span>            :  *
<span class="lineNum">    1746 </span>            :  *   Returns a pointer to malloc-ed memory.
<a name="1747"><span class="lineNum">    1747 </span>            :  */</a>
<span class="lineNum">    1748 </span>            : char*
<span class="lineNum">    1749 </span>            : mono_get_generic_trampoline_name (MonoTrampolineType tramp_type)
<span class="lineNum">    1750 </span>            : {
<span class="lineNum">    1751 </span><span class="lineCov">      32850 :         return g_strdup_printf (&quot;generic_trampoline_%s&quot;, tramp_names [tramp_type]);</span>
<span class="lineNum">    1752 </span>            : }
<span class="lineNum">    1753 </span>            : 
<span class="lineNum">    1754 </span>            : /*
<span class="lineNum">    1755 </span>            :  * mono_get_rgctx_fetch_trampoline_name:
<span class="lineNum">    1756 </span>            :  *
<span class="lineNum">    1757 </span>            :  *   Returns a pointer to malloc-ed memory.
<a name="1758"><span class="lineNum">    1758 </span>            :  */</a>
<span class="lineNum">    1759 </span>            : char*
<span class="lineNum">    1760 </span>            : mono_get_rgctx_fetch_trampoline_name (int slot)
<span class="lineNum">    1761 </span>            : {
<span class="lineNum">    1762 </span>            :         gboolean mrgctx;
<span class="lineNum">    1763 </span>            :         int index;
<span class="lineNum">    1764 </span>            : 
<span class="lineNum">    1765 </span><span class="lineCov">     115692 :         mrgctx = MONO_RGCTX_SLOT_IS_MRGCTX (slot);</span>
<span class="lineNum">    1766 </span><span class="lineCov">     115692 :         index = MONO_RGCTX_SLOT_INDEX (slot);</span>
<span class="lineNum">    1767 </span>            : 
<span class="lineNum">    1768 </span><span class="lineCov">     115692 :         return g_strdup_printf (&quot;rgctx_fetch_trampoline_%s_%d&quot;, mrgctx ? &quot;mrgctx&quot; : &quot;rgctx&quot;, index);</span>
<span class="lineNum">    1769 </span>            : }
<span class="lineNum">    1770 </span>            : 
<span class="lineNum">    1771 </span>            : /*
<span class="lineNum">    1772 </span>            :  * mini_get_single_step_trampoline:
<span class="lineNum">    1773 </span>            :  *
<span class="lineNum">    1774 </span>            :  *   Return a trampoline which calls debugger_agent_single_step_from_context ().
<a name="1775"><span class="lineNum">    1775 </span>            :  */</a>
<span class="lineNum">    1776 </span>            : gpointer
<span class="lineNum">    1777 </span>            : mini_get_single_step_trampoline (void)
<span class="lineNum">    1778 </span>            : {
<span class="lineNum">    1779 </span>            :         static gpointer trampoline;
<span class="lineNum">    1780 </span>            : 
<span class="lineNum">    1781 </span><span class="lineNoCov">          0 :         if (!trampoline) {</span>
<span class="lineNum">    1782 </span>            :                 gpointer tramp;
<span class="lineNum">    1783 </span>            : 
<span class="lineNum">    1784 </span><span class="lineNoCov">          0 :                 if (mono_aot_only) {</span>
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :                         tramp = mono_aot_get_trampoline (&quot;sdb_single_step_trampoline&quot;);</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1787 </span>            : #ifdef MONO_ARCH_HAVE_SDB_TRAMPOLINES
<span class="lineNum">    1788 </span>            :                         MonoTrampInfo *info;
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :                         tramp = mono_arch_create_sdb_trampoline (TRUE, &amp;info, FALSE);</span>
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :                         mono_tramp_info_register (info, NULL);</span>
<span class="lineNum">    1791 </span>            : #else
<span class="lineNum">    1792 </span>            :                         tramp = NULL;
<span class="lineNum">    1793 </span>            :                         g_assert_not_reached ();
<span class="lineNum">    1794 </span>            : #endif
<span class="lineNum">    1795 </span>            :                 }
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :                 mono_memory_barrier ();</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :                 trampoline = tramp;</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1799 </span>            : 
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :         return trampoline;</span>
<span class="lineNum">    1801 </span>            : }
<span class="lineNum">    1802 </span>            : 
<span class="lineNum">    1803 </span>            : /*
<span class="lineNum">    1804 </span>            :  * mini_get_breakpoint_trampoline:
<span class="lineNum">    1805 </span>            :  *
<span class="lineNum">    1806 </span>            :  *   Return a trampoline which calls debugger_agent_breakpoint_from_context ().
<a name="1807"><span class="lineNum">    1807 </span>            :  */</a>
<span class="lineNum">    1808 </span>            : gpointer
<span class="lineNum">    1809 </span>            : mini_get_breakpoint_trampoline (void)
<span class="lineNum">    1810 </span>            : {
<span class="lineNum">    1811 </span>            :         static gpointer trampoline;
<span class="lineNum">    1812 </span>            : 
<span class="lineNum">    1813 </span><span class="lineCov">       3285 :         if (!trampoline) {</span>
<span class="lineNum">    1814 </span>            :                 gpointer tramp;
<span class="lineNum">    1815 </span>            : 
<span class="lineNum">    1816 </span><span class="lineCov">       3285 :                 if (mono_aot_only) {</span>
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :                         tramp = mono_aot_get_trampoline (&quot;sdb_breakpoint_trampoline&quot;);</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1819 </span>            : #ifdef MONO_ARCH_HAVE_SDB_TRAMPOLINES
<span class="lineNum">    1820 </span>            :                         MonoTrampInfo *info;
<span class="lineNum">    1821 </span><span class="lineCov">       3285 :                         tramp = mono_arch_create_sdb_trampoline (FALSE, &amp;info, FALSE);</span>
<span class="lineNum">    1822 </span><span class="lineCov">       3285 :                         mono_tramp_info_register (info, NULL);</span>
<span class="lineNum">    1823 </span>            : #else
<span class="lineNum">    1824 </span>            :                         tramp = NULL;
<span class="lineNum">    1825 </span>            :                         g_assert_not_reached ();
<span class="lineNum">    1826 </span>            : #endif
<span class="lineNum">    1827 </span>            :                 }
<span class="lineNum">    1828 </span><span class="lineCov">       3285 :                 mono_memory_barrier ();</span>
<span class="lineNum">    1829 </span><span class="lineCov">       3285 :                 trampoline = tramp;</span>
<span class="lineNum">    1830 </span><span class="lineCov">       3285 :         }</span>
<span class="lineNum">    1831 </span>            : 
<span class="lineNum">    1832 </span><span class="lineCov">       3285 :         return trampoline;</span>
<span class="lineNum">    1833 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
