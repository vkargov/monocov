<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - mini/lldb.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">mini</a> - lldb.c<span style="font-size: 80%;"> (source / <a href="lldb.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntry">247</td>
            <td class="headerCovTableEntryLo">5.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntryLo">21.1 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * lldb.c: Mono support for LLDB.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Author:
<span class="lineNum">       5 </span>            :  *   Zoltan Varga (vargaz@gmail.com)
<span class="lineNum">       6 </span>            :  *
<span class="lineNum">       7 </span>            :  * Copyright 2016 Xamarin, Inc (http://www.xamarin.com)
<span class="lineNum">       8 </span>            :  */
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : #include &quot;config.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;mini.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;lldb.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;seq-points.h&quot;
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &lt;mono/metadata/mono-debug.h&gt;
<span class="lineNum">      16 </span>            : #include &lt;mono/metadata/mono-debug-debugger.h&gt;
<span class="lineNum">      17 </span>            : #include &lt;mono/metadata/debug-mono-symfile.h&gt;
<span class="lineNum">      18 </span>            : #include &lt;mono/utils/mono-counters.h&gt;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #if !defined(DISABLE_JIT) &amp;&amp; !defined(DISABLE_LLDB)
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : typedef enum {
<span class="lineNum">      23 </span>            :         ENTRY_CODE_REGION = 1,
<span class="lineNum">      24 </span>            :         ENTRY_METHOD = 2,
<span class="lineNum">      25 </span>            :         ENTRY_TRAMPOLINE = 3,
<span class="lineNum">      26 </span>            :         ENTRY_UNLOAD_CODE_REGION = 4
<span class="lineNum">      27 </span>            : } EntryType;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : /*
<span class="lineNum">      30 </span>            :  * Need to make sure these structures have the same size and alignment on
<span class="lineNum">      31 </span>            :  * all platforms.
<span class="lineNum">      32 </span>            :  */
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : /* One data packet sent from the runtime to the debugger */
<span class="lineNum">      35 </span>            : typedef struct {
<span class="lineNum">      36 </span>            :         /* Pointer to the next entry */
<span class="lineNum">      37 </span>            :         guint64 next_addr;
<span class="lineNum">      38 </span>            :         /* The type of data pointed to by ADDR */
<span class="lineNum">      39 </span>            :         /* One of the ENTRY_ constants */
<span class="lineNum">      40 </span>            :         guint32 type;
<span class="lineNum">      41 </span>            :         /* Align */
<span class="lineNum">      42 </span>            :         guint32 dummy;
<span class="lineNum">      43 </span>            :         guint64 size;
<span class="lineNum">      44 </span>            :         guint64 addr;
<span class="lineNum">      45 </span>            : } DebugEntry;
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : typedef struct
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span>            :         /* (MAJOR &lt;&lt; 16) | MINOR */
<span class="lineNum">      50 </span>            :         guint32 version;
<span class="lineNum">      51 </span>            :         /* Align */
<span class="lineNum">      52 </span>            :         guint32 dummy;
<span class="lineNum">      53 </span>            :         DebugEntry *entry;
<span class="lineNum">      54 </span>            :         /* List of all entries */
<span class="lineNum">      55 </span>            :         /* Keep this as a pointer so accessing it is atomic */
<span class="lineNum">      56 </span>            :         DebugEntry *all_entries;
<span class="lineNum">      57 </span>            :         /* The current entry embedded here to reduce the amount of roundtrips */
<span class="lineNum">      58 </span>            :         guint32 type;
<span class="lineNum">      59 </span>            :         guint32 dummy2;
<span class="lineNum">      60 </span>            :         guint64 size;
<span class="lineNum">      61 </span>            :         guint64 addr;
<span class="lineNum">      62 </span>            : } JitDescriptor;
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : /*
<span class="lineNum">      65 </span>            :  * Represents a memory region used for code.
<span class="lineNum">      66 </span>            :  */
<span class="lineNum">      67 </span>            : typedef struct {
<span class="lineNum">      68 </span>            :         /*
<span class="lineNum">      69 </span>            :          * OBJFILE_MAGIC. This is needed to make it easier for lldb to
<span class="lineNum">      70 </span>            :          * create object files from this packet.
<span class="lineNum">      71 </span>            :          */
<span class="lineNum">      72 </span>            :         char magic [32];
<span class="lineNum">      73 </span>            :         guint64 start;
<span class="lineNum">      74 </span>            :         guint32 size;
<span class="lineNum">      75 </span>            :         int id;
<span class="lineNum">      76 </span>            : } CodeRegionEntry;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : typedef struct {
<span class="lineNum">      79 </span>            :         int id;
<span class="lineNum">      80 </span>            : } UnloadCodeRegionEntry;
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            : /*
<span class="lineNum">      83 </span>            :  * Represents a managed method
<span class="lineNum">      84 </span>            :  */
<span class="lineNum">      85 </span>            : typedef struct {
<span class="lineNum">      86 </span>            :         guint64 code;
<span class="lineNum">      87 </span>            :         int id;
<span class="lineNum">      88 </span>            :         /* The id of the codegen region which contains CODE */
<span class="lineNum">      89 </span>            :         int region_id;
<span class="lineNum">      90 </span>            :         int code_size;
<span class="lineNum">      91 </span>            :         /* Align */
<span class="lineNum">      92 </span>            :         guint32 dummy;
<span class="lineNum">      93 </span>            :         /* Followed by variable size data */
<span class="lineNum">      94 </span>            : } MethodEntry;
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            : /*
<span class="lineNum">      97 </span>            :  * Represents a trampoline
<span class="lineNum">      98 </span>            :  */
<span class="lineNum">      99 </span>            : typedef struct {
<span class="lineNum">     100 </span>            :         guint64 code;
<span class="lineNum">     101 </span>            :         int id;
<span class="lineNum">     102 </span>            :         /* The id of the codegen region which contains CODE */
<span class="lineNum">     103 </span>            :         int region_id;
<span class="lineNum">     104 </span>            :         int code_size;
<span class="lineNum">     105 </span>            :         /* Align */
<span class="lineNum">     106 </span>            :         guint32 dummy;
<span class="lineNum">     107 </span>            :         /* Followed by variable size data */
<span class="lineNum">     108 </span>            : } TrampolineEntry;
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            : #define MAJOR_VERSION 1
<span class="lineNum">     111 </span>            : #define MINOR_VERSION 0
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : static const char* OBJFILE_MAGIC = { &quot;MONO_JIT_OBJECT_FILE&quot; };
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span>            : JitDescriptor __mono_jit_debug_descriptor = { (MAJOR_VERSION &lt;&lt; 16) | MINOR_VERSION };
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            : static gboolean enabled;
<span class="lineNum">     118 </span>            : static int id_generator;
<span class="lineNum">     119 </span>            : static GHashTable *codegen_regions;
<span class="lineNum">     120 </span>            : static DebugEntry *last_entry;
<span class="lineNum">     121 </span>            : static mono_mutex_t mutex;
<span class="lineNum">     122 </span>            : static GHashTable *dyn_codegen_regions;
<span class="lineNum">     123 </span>            : static double register_time;
<span class="lineNum">     124 </span>            : static int num_entries;
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span>            : #define lldb_lock() mono_os_mutex_lock (&amp;mutex)
<span class="lineNum">     127 </span>            : #define lldb_unlock() mono_os_mutex_unlock (&amp;mutex)
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            : void MONO_NEVER_INLINE __mono_jit_debug_register_code (void);
<span class="lineNum">     130 </span>            : 
<a name="131"><span class="lineNum">     131 </span>            : /* The native debugger puts a breakpoint in this function. */</a>
<span class="lineNum">     132 </span>            : void MONO_NEVER_INLINE
<span class="lineNum">     133 </span>            : __mono_jit_debug_register_code (void)
<span class="lineNum">     134 </span>            : {
<span class="lineNum">     135 </span>            :         /* Make sure that even compilers that ignore __noinline__ don't inline this */
<span class="lineNum">     136 </span>            : #if defined(__GNUC__)
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         asm (&quot;&quot;);</span>
<span class="lineNum">     138 </span>            : #endif
<span class="lineNum">     139 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : /*
<span class="lineNum">     142 </span>            :  * Functions to encode protocol data
<span class="lineNum">     143 </span>            :  */
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            : typedef struct {
<span class="lineNum">     146 </span>            :         guint8 *buf, *p, *end;
<span class="lineNum">     147 </span>            : } Buffer;
<a name="148"><span class="lineNum">     148 </span>            : </a>
<span class="lineNum">     149 </span>            : static inline void
<span class="lineNum">     150 </span>            : buffer_init (Buffer *buf, int size)
<span class="lineNum">     151 </span>            : {
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :         buf-&gt;buf = (guint8 *)g_malloc (size);</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :         buf-&gt;p = buf-&gt;buf;</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         buf-&gt;end = buf-&gt;buf + size;</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 : }</span>
<a name="156"><span class="lineNum">     156 </span>            : </a>
<span class="lineNum">     157 </span>            : static inline int
<span class="lineNum">     158 </span>            : buffer_len (Buffer *buf)
<span class="lineNum">     159 </span>            : {
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :         return buf-&gt;p - buf-&gt;buf;</span>
<span class="lineNum">     161 </span>            : }
<a name="162"><span class="lineNum">     162 </span>            : </a>
<span class="lineNum">     163 </span>            : static inline void
<span class="lineNum">     164 </span>            : buffer_make_room (Buffer *buf, int size)
<span class="lineNum">     165 </span>            : {
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :         if (buf-&gt;end - buf-&gt;p &lt; size) {</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :                 int new_size = buf-&gt;end - buf-&gt;buf + size + 32;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                 guint8 *p = (guint8 *)g_realloc (buf-&gt;buf, new_size);</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                 size = buf-&gt;p - buf-&gt;buf;</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :                 buf-&gt;buf = p;</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :                 buf-&gt;p = p + size;</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :                 buf-&gt;end = buf-&gt;buf + new_size;</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 : }</span>
<a name="175"><span class="lineNum">     175 </span>            : </a>
<span class="lineNum">     176 </span>            : static inline void
<span class="lineNum">     177 </span>            : buffer_add_byte (Buffer *buf, guint8 val)
<span class="lineNum">     178 </span>            : {
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         buffer_make_room (buf, 1);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :         buf-&gt;p [0] = val;</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :         buf-&gt;p++;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            : static inline void
<span class="lineNum">     185 </span>            : buffer_add_short (Buffer *buf, guint32 val)
<span class="lineNum">     186 </span>            : {
<span class="lineNum">     187 </span>            :         buffer_make_room (buf, 2);
<span class="lineNum">     188 </span>            :         buf-&gt;p [0] = (val &gt;&gt; 8) &amp; 0xff;
<span class="lineNum">     189 </span>            :         buf-&gt;p [1] = (val &gt;&gt; 0) &amp; 0xff;
<span class="lineNum">     190 </span>            :         buf-&gt;p += 2;
<span class="lineNum">     191 </span>            : }
<a name="192"><span class="lineNum">     192 </span>            : </a>
<span class="lineNum">     193 </span>            : static inline void
<span class="lineNum">     194 </span>            : buffer_add_int (Buffer *buf, guint32 val)
<span class="lineNum">     195 </span>            : {
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :         buffer_make_room (buf, 4);</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :         buf-&gt;p [0] = (val &gt;&gt; 24) &amp; 0xff;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :         buf-&gt;p [1] = (val &gt;&gt; 16) &amp; 0xff;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :         buf-&gt;p [2] = (val &gt;&gt; 8) &amp; 0xff;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :         buf-&gt;p [3] = (val &gt;&gt; 0) &amp; 0xff;</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         buf-&gt;p += 4;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : static inline void
<span class="lineNum">     205 </span>            : buffer_add_long (Buffer *buf, guint64 l)
<span class="lineNum">     206 </span>            : {
<span class="lineNum">     207 </span>            :         buffer_add_int (buf, (l &gt;&gt; 32) &amp; 0xffffffff);
<span class="lineNum">     208 </span>            :         buffer_add_int (buf, (l &gt;&gt; 0) &amp; 0xffffffff);
<span class="lineNum">     209 </span>            : }
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span>            : static inline void
<span class="lineNum">     212 </span>            : buffer_add_id (Buffer *buf, int id)
<span class="lineNum">     213 </span>            : {
<span class="lineNum">     214 </span>            :         buffer_add_int (buf, (guint64)id);
<span class="lineNum">     215 </span>            : }
<a name="216"><span class="lineNum">     216 </span>            : </a>
<span class="lineNum">     217 </span>            : static inline void
<span class="lineNum">     218 </span>            : buffer_add_data (Buffer *buf, guint8 *data, int len)
<span class="lineNum">     219 </span>            : {
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         buffer_make_room (buf, len);</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         memcpy (buf-&gt;p, data, len);</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         buf-&gt;p += len;</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 : }</span>
<a name="224"><span class="lineNum">     224 </span>            : </a>
<span class="lineNum">     225 </span>            : static inline void
<span class="lineNum">     226 </span>            : buffer_add_string (Buffer *buf, const char *str)
<span class="lineNum">     227 </span>            : {
<span class="lineNum">     228 </span>            :         int len;
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :         if (str == NULL) {</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, 0);</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                 len = strlen (str);</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, len);</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :                 buffer_add_data (buf, (guint8*)str, len);</span>
<span class="lineNum">     236 </span>            :         }
<span class="lineNum">     237 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span>            : static inline void
<span class="lineNum">     240 </span>            : buffer_add_buffer (Buffer *buf, Buffer *data)
<span class="lineNum">     241 </span>            : {
<span class="lineNum">     242 </span>            :         buffer_add_data (buf, data-&gt;buf, buffer_len (data));
<span class="lineNum">     243 </span>            : }
<a name="244"><span class="lineNum">     244 </span>            : </a>
<span class="lineNum">     245 </span>            : static inline void
<span class="lineNum">     246 </span>            : buffer_free (Buffer *buf)
<span class="lineNum">     247 </span>            : {
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         g_free (buf-&gt;buf);</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            : typedef struct {
<span class="lineNum">     252 </span>            :         gpointer code;
<span class="lineNum">     253 </span>            :         gpointer region_start;
<span class="lineNum">     254 </span>            :         guint32 region_size;
<span class="lineNum">     255 </span>            :         gboolean found;
<span class="lineNum">     256 </span>            : } UserData;
<a name="257"><span class="lineNum">     257 </span>            : </a>
<span class="lineNum">     258 </span>            : static int
<span class="lineNum">     259 </span>            : find_code_region (void *data, int csize, int size, void *user_data)
<span class="lineNum">     260 </span>            : {
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :         UserData *ud = user_data;</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :         if ((char*)ud-&gt;code &gt;= (char*)data &amp;&amp; (char*)ud-&gt;code &lt; (char*)data + csize) {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                 ud-&gt;region_start = data;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                 ud-&gt;region_size = csize;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                 ud-&gt;found = TRUE;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     268 </span>            :         }
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 : }</span>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : static void
<span class="lineNum">     273 </span>            : add_entry (EntryType type, Buffer *buf)
<span class="lineNum">     274 </span>            : {
<span class="lineNum">     275 </span>            :         DebugEntry *entry;
<span class="lineNum">     276 </span>            :         guint8 *data;
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         int size = buffer_len (buf);</span>
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         data = g_malloc (size);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         memcpy (data, buf-&gt;buf, size);</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         entry = g_malloc0 (sizeof (DebugEntry));</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         entry-&gt;type = type;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         entry-&gt;addr = (guint64)(gsize)data;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         entry-&gt;size = size;</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         mono_memory_barrier ();</span>
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         lldb_lock ();</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :         /* The debugger can read the list of entries asynchronously, so this has to be async safe */
<span class="lineNum">     292 </span>            :         // FIXME: Make sure this is async safe
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :         if (last_entry) {</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                 last_entry-&gt;next_addr = (guint64)(gsize) (entry);</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :                 last_entry = entry;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :                 last_entry = entry;</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :                 __mono_jit_debug_descriptor.all_entries = entry;</span>
<span class="lineNum">     299 </span>            :         }
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         __mono_jit_debug_descriptor.entry = entry;</span>
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         __mono_jit_debug_descriptor.type = entry-&gt;type;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         __mono_jit_debug_descriptor.size = entry-&gt;size;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         __mono_jit_debug_descriptor.addr = entry-&gt;addr;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :         mono_memory_barrier ();</span>
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :         GTimer *timer = mono_time_track_start ();</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         __mono_jit_debug_register_code ();</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         mono_time_track_end (&amp;register_time, timer);</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         num_entries ++;</span>
<span class="lineNum">     312 </span>            :         //printf (&quot;%lf %d %d\n&quot;, register_time, num_entries, entry-&gt;type);
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         lldb_unlock ();</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            : /*
<span class="lineNum">     318 </span>            :  * register_codegen_region:
<span class="lineNum">     319 </span>            :  *
<span class="lineNum">     320 </span>            :  * Register a codegen region with the debugger if needed.
<span class="lineNum">     321 </span>            :  * Return a region id.
<a name="322"><span class="lineNum">     322 </span>            :  */</a>
<span class="lineNum">     323 </span>            : static int
<span class="lineNum">     324 </span>            : register_codegen_region (gpointer region_start, int region_size, gboolean dynamic)
<span class="lineNum">     325 </span>            : {
<span class="lineNum">     326 </span>            :         CodeRegionEntry *region_entry;
<span class="lineNum">     327 </span>            :         int id;
<span class="lineNum">     328 </span>            :         Buffer tmp_buf;
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :         Buffer *buf = &amp;tmp_buf;</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         if (dynamic) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :                 lldb_lock ();</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                 id = ++id_generator;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                 lldb_unlock ();</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                 lldb_lock ();</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                 if (!codegen_regions)</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                         codegen_regions = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                 id = GPOINTER_TO_INT (g_hash_table_lookup (codegen_regions, region_start));</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                 if (id) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                         lldb_unlock ();</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                         return id;</span>
<span class="lineNum">     343 </span>            :                 }
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                 id = ++id_generator;</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :                 g_hash_table_insert (codegen_regions, region_start, GINT_TO_POINTER (id));</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :                 lldb_unlock ();</span>
<span class="lineNum">     347 </span>            :         }
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :         buffer_init (buf, 128);</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :         region_entry = (CodeRegionEntry*)buf-&gt;p;</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         buf-&gt;p += sizeof (CodeRegionEntry);</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :         memset (region_entry, 0, sizeof (CodeRegionEntry));</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :         strcpy (region_entry-&gt;magic, OBJFILE_MAGIC);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :         region_entry-&gt;id = id;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         region_entry-&gt;start = (gsize)region_start;</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :         region_entry-&gt;size = (gsize)region_size;</span>
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         add_entry (ENTRY_CODE_REGION, buf);</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :         buffer_free (buf);</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :         return id;</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 : }</span>
<a name="363"><span class="lineNum">     363 </span>            : </a>
<span class="lineNum">     364 </span>            : static void
<span class="lineNum">     365 </span>            : emit_unwind_info (GSList *unwind_ops, Buffer *buf)
<span class="lineNum">     366 </span>            : {
<span class="lineNum">     367 </span>            :         int ret_reg;
<span class="lineNum">     368 </span>            :         int nunwind_ops;
<span class="lineNum">     369 </span>            :         GSList *l;
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :         ret_reg = mono_unwind_get_dwarf_pc_reg ();</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         g_assert (ret_reg &lt; 256);</span>
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span>            :         /* We use the unencoded version of the unwind info to make it easier to decode */
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :         nunwind_ops = 0;</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         for (l = unwind_ops; l; l = l-&gt;next) {</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                 MonoUnwindOp *op = l-&gt;data;</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span>            :                 /* lldb can't handle these */
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                 if (op-&gt;op == DW_CFA_mono_advance_loc)</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                 nunwind_ops ++;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :         buffer_add_byte (buf, ret_reg);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :         buffer_add_int (buf, nunwind_ops);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :         for (l = unwind_ops; l; l = l-&gt;next) {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                 MonoUnwindOp *op = l-&gt;data;</span>
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                 if (op-&gt;op == DW_CFA_mono_advance_loc)</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, op-&gt;op);</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, op-&gt;when);</span>
<span class="lineNum">     394 </span>            :                 int dreg;
<span class="lineNum">     395 </span>            : #if TARGET_X86
<span class="lineNum">     396 </span>            :                 // LLDB doesn't see to use the switched esp/ebp
<span class="lineNum">     397 </span>            :                 if (op-&gt;reg == X86_ESP)
<span class="lineNum">     398 </span>            :                         dreg = X86_ESP;
<span class="lineNum">     399 </span>            :                 else if (op-&gt;reg == X86_EBP)
<span class="lineNum">     400 </span>            :                         dreg = X86_EBP;
<span class="lineNum">     401 </span>            :                 else
<span class="lineNum">     402 </span>            :                         dreg = mono_hw_reg_to_dwarf_reg (op-&gt;reg);
<span class="lineNum">     403 </span>            : #else
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                 dreg = mono_hw_reg_to_dwarf_reg (op-&gt;reg);</span>
<span class="lineNum">     405 </span>            : #endif
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, dreg);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, op-&gt;val);</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 : }</span>
<a name="410"><span class="lineNum">     410 </span>            : </a>
<span class="lineNum">     411 </span>            : void
<span class="lineNum">     412 </span>            : mono_lldb_init (const char *options)
<span class="lineNum">     413 </span>            : {
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :         enabled = TRUE;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :         mono_os_mutex_init_recursive (&amp;mutex);</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :         mono_counters_register (&quot;Time spent in LLDB&quot;, MONO_COUNTER_JIT | MONO_COUNTER_DOUBLE, &amp;register_time);</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span>            : typedef struct
<span class="lineNum">     421 </span>            : {
<span class="lineNum">     422 </span>            :         MonoSymSeqPoint sp;
<span class="lineNum">     423 </span>            :         int native_offset;
<span class="lineNum">     424 </span>            : } FullSeqPoint;
<a name="425"><span class="lineNum">     425 </span>            : </a>
<span class="lineNum">     426 </span>            : static int
<span class="lineNum">     427 </span>            : compare_by_addr (const void *arg1, const void *arg2)
<span class="lineNum">     428 </span>            : {
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         const FullSeqPoint *sp1 = arg1;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         const FullSeqPoint *sp2 = arg2;</span>
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :         return sp1-&gt;native_offset - sp2-&gt;native_offset;</span>
<span class="lineNum">     433 </span>            : }
<a name="434"><span class="lineNum">     434 </span>            : </a>
<span class="lineNum">     435 </span>            : void
<span class="lineNum">     436 </span>            : mono_lldb_save_method_info (MonoCompile *cfg)
<span class="lineNum">     437 </span>            : {
<span class="lineNum">     438 </span>            :         MethodEntry *entry;
<span class="lineNum">     439 </span>            :         UserData udata;
<span class="lineNum">     440 </span>            :         int region_id;
<span class="lineNum">     441 </span>            :         Buffer tmpbuf;
<span class="lineNum">     442 </span><span class="lineCov">   14361827 :         Buffer *buf = &amp;tmpbuf;</span>
<span class="lineNum">     443 </span>            :         MonoDebugMethodInfo *minfo;
<span class="lineNum">     444 </span>            :         int i, j, n_il_offsets;
<span class="lineNum">     445 </span>            :         int *source_files;
<span class="lineNum">     446 </span>            :         GPtrArray *source_file_list;
<span class="lineNum">     447 </span>            :         MonoSymSeqPoint *sym_seq_points;
<span class="lineNum">     448 </span>            :         FullSeqPoint *locs;
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineCov">   14361827 :         if (!enabled)</span>
<span class="lineNum">     451 </span><span class="lineCov">   14361860 :                 return;</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            :         /* Find the codegen region which contains the code */
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         memset (&amp;udata, 0, sizeof (udata));</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :         udata.code = cfg-&gt;native_code;</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :         if (cfg-&gt;method-&gt;dynamic) {</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                 mono_code_manager_foreach (cfg-&gt;dynamic_info-&gt;code_mp, find_code_region, &amp;udata);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                 g_assert (udata.found);</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :                 region_id = register_codegen_region (udata.region_start, udata.region_size, TRUE);</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                 lldb_lock ();</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                 if (!dyn_codegen_regions)</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                         dyn_codegen_regions = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                 g_hash_table_insert (dyn_codegen_regions, cfg-&gt;method, GINT_TO_POINTER (region_id));</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 lldb_unlock ();</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                 mono_domain_code_foreach (cfg-&gt;domain, find_code_region, &amp;udata);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :                 g_assert (udata.found);</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :                 region_id = register_codegen_region (udata.region_start, udata.region_size, FALSE);</span>
<span class="lineNum">     472 </span>            :         }
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         buffer_init (buf, 256);</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         entry = (MethodEntry*)buf-&gt;p;</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         buf-&gt;p += sizeof (MethodEntry);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         entry-&gt;id = ++id_generator;</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :         entry-&gt;region_id = region_id;</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :         entry-&gt;code = (gsize)cfg-&gt;native_code;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :         entry-&gt;code_size = cfg-&gt;code_size;</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :         emit_unwind_info (cfg-&gt;unwind_ops, buf);</span>
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :         char *s = mono_method_full_name (cfg-&gt;method, TRUE);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :         buffer_add_string (buf, s);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :         g_free (s);</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :         minfo = mono_debug_lookup_method (cfg-&gt;method);</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :         MonoSeqPointInfo *seq_points = cfg-&gt;seq_point_info;</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         if (minfo &amp;&amp; seq_points) {</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                 mono_debug_get_seq_points (minfo, NULL, &amp;source_file_list, &amp;source_files, &amp;sym_seq_points, &amp;n_il_offsets);</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, source_file_list-&gt;len);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; source_file_list-&gt;len; ++i) {</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                         MonoDebugSourceInfo *sinfo = (MonoDebugSourceInfo *)g_ptr_array_index (source_file_list, i);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                         buffer_add_string (buf, sinfo-&gt;source_file);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                         for (j = 0; j &lt; 16; ++j)</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                                 buffer_add_byte (buf, sinfo-&gt;hash [j]);</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            :                 // The sym seq points are ordered by il offset, need to order them by address
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                 int skipped = 0;</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                 locs = g_new0 (FullSeqPoint, n_il_offsets);</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; n_il_offsets; ++i) {</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                         locs [i].sp = sym_seq_points [i];</span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span>            :                         // FIXME: O(n^2)
<span class="lineNum">     508 </span>            :                         SeqPoint seq_point;
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                         if (mono_seq_point_find_by_il_offset (seq_points, sym_seq_points [i].il_offset, &amp;seq_point)) {</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                                 locs [i].native_offset = seq_point.native_offset;</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :                                 locs [i].native_offset = 0xffffff;</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                                 skipped ++;</span>
<span class="lineNum">     514 </span>            :                         }
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                 qsort (locs, n_il_offsets, sizeof (FullSeqPoint), compare_by_addr);</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                 n_il_offsets -= skipped;</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, n_il_offsets);</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; n_il_offsets; ++i) {</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                         MonoSymSeqPoint *sp = &amp;locs [i].sp;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                         const char *srcfile = &quot;&quot;;</span>
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                         if (source_files [i] != -1) {</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :                                 MonoDebugSourceInfo *sinfo = (MonoDebugSourceInfo *)g_ptr_array_index (source_file_list, source_files [i]);</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                                 srcfile = sinfo-&gt;source_file;</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span>            :                         //printf (&quot;%s %x %d %d\n&quot;, cfg-&gt;method-&gt;name, locs [i].native_offset, sp-&gt;il_offset, sp-&gt;line);
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, locs [i].native_offset);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, sp-&gt;il_offset);</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, sp-&gt;line);</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, source_files [i]);</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, sp-&gt;column);</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, sp-&gt;end_line);</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :                         buffer_add_int (buf, sp-&gt;end_column);</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                 g_free (locs);</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                 g_free (source_files);</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :                 g_free (sym_seq_points);</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :                 g_ptr_array_free (source_file_list, TRUE);</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, 0);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 buffer_add_int (buf, 0);</span>
<span class="lineNum">     545 </span>            :         }
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :         add_entry (ENTRY_METHOD, buf);</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :         buffer_free (buf);</span>
<span class="lineNum">     549 </span><span class="lineCov">   14361789 : }</span>
<a name="550"><span class="lineNum">     550 </span>            : </a>
<span class="lineNum">     551 </span>            : void
<span class="lineNum">     552 </span>            : mono_lldb_remove_method (MonoDomain *domain, MonoMethod *method, MonoJitDynamicMethodInfo *info)
<span class="lineNum">     553 </span>            : {
<span class="lineNum">     554 </span>            :         int region_id;
<span class="lineNum">     555 </span>            :         UnloadCodeRegionEntry *entry;
<span class="lineNum">     556 </span>            :         Buffer tmpbuf;
<span class="lineNum">     557 </span><span class="lineCov">      10028 :         Buffer *buf = &amp;tmpbuf;</span>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineCov">      10028 :         if (!enabled)</span>
<span class="lineNum">     560 </span><span class="lineCov">      10028 :                 return;</span>
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :         g_assert (method-&gt;dynamic);</span>
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :         lldb_lock ();</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :         region_id = GPOINTER_TO_INT (g_hash_table_lookup (dyn_codegen_regions, method));</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :         g_hash_table_remove (dyn_codegen_regions, method);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :         lldb_unlock ();</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :         buffer_init (buf, 256);</span>
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :         entry = (UnloadCodeRegionEntry*)buf-&gt;p;</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :         buf-&gt;p += sizeof (UnloadCodeRegionEntry);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         entry-&gt;id = region_id;</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         add_entry (ENTRY_UNLOAD_CODE_REGION, buf);</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :         buffer_free (buf);</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            :         /* The method is associated with the code region, so it doesn't have to be unloaded */
<span class="lineNum">     579 </span><span class="lineCov">      10028 : }</span>
<a name="580"><span class="lineNum">     580 </span>            : </a>
<span class="lineNum">     581 </span>            : void
<span class="lineNum">     582 </span>            : mono_lldb_save_trampoline_info (MonoTrampInfo *info)
<span class="lineNum">     583 </span>            : {
<span class="lineNum">     584 </span>            :         TrampolineEntry *entry;
<span class="lineNum">     585 </span>            :         UserData udata;
<span class="lineNum">     586 </span>            :         int region_id;
<span class="lineNum">     587 </span>            :         Buffer tmpbuf;
<span class="lineNum">     588 </span><span class="lineCov">    1768493 :         Buffer *buf = &amp;tmpbuf;</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span><span class="lineCov">    1768493 :         if (!enabled)</span>
<span class="lineNum">     591 </span><span class="lineCov">    1768493 :                 return;</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span>            :         /* Find the codegen region which contains the code */
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         memset (&amp;udata, 0, sizeof (udata));</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         udata.code = info-&gt;code;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         mono_global_codeman_foreach (find_code_region, &amp;udata);</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :         if (!udata.found)</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                 mono_domain_code_foreach (mono_get_root_domain (), find_code_region, &amp;udata);</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :         g_assert (udata.found);</span>
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :         region_id = register_codegen_region (udata.region_start, udata.region_size, FALSE);</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :         buffer_init (buf, 1024);</span>
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :         entry = (TrampolineEntry*)buf-&gt;p;</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :         buf-&gt;p += sizeof (TrampolineEntry);</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :         entry-&gt;id = ++id_generator;</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :         entry-&gt;region_id = region_id;</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :         entry-&gt;code = (gsize)info-&gt;code;</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :         entry-&gt;code_size = info-&gt;code_size;</span>
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :         emit_unwind_info (info-&gt;unwind_ops, buf);</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :         buffer_add_string (buf, info-&gt;name);</span>
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :         add_entry (ENTRY_TRAMPOLINE, buf);</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :         buffer_free (buf);</span>
<span class="lineNum">     618 </span><span class="lineCov">    1768493 : }</span>
<a name="619"><span class="lineNum">     619 </span>            : </a>
<span class="lineNum">     620 </span>            : void
<span class="lineNum">     621 </span>            : mono_lldb_save_specific_trampoline_info (gpointer arg1, MonoTrampolineType tramp_type, MonoDomain *domain, gpointer code, guint32 code_len)
<span class="lineNum">     622 </span>            : {
<span class="lineNum">     623 </span>            :         /*
<span class="lineNum">     624 </span>            :          * Avoid emitting these for now,
<span class="lineNum">     625 </span>            :          * they slow down execution too much, and they are
<span class="lineNum">     626 </span>            :          * only needed during single stepping which doesn't
<span class="lineNum">     627 </span>            :          * work anyway.
<span class="lineNum">     628 </span>            :          */
<span class="lineNum">     629 </span>            : #if 0
<span class="lineNum">     630 </span>            :         TrampolineEntry *entry;
<span class="lineNum">     631 </span>            :         UserData udata;
<span class="lineNum">     632 </span>            :         int region_id;
<span class="lineNum">     633 </span>            :         Buffer tmpbuf;
<span class="lineNum">     634 </span>            :         Buffer *buf = &amp;tmpbuf;
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            :         if (!enabled)
<span class="lineNum">     637 </span>            :                 return;
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :         /* Find the codegen region which contains the code */
<span class="lineNum">     640 </span>            :         memset (&amp;udata, 0, sizeof (udata));
<span class="lineNum">     641 </span>            :         udata.code = code;
<span class="lineNum">     642 </span>            :         mono_global_codeman_foreach (find_code_region, &amp;udata);
<span class="lineNum">     643 </span>            :         if (!udata.found)
<span class="lineNum">     644 </span>            :                 mono_domain_code_foreach (mono_get_root_domain (), find_code_region, &amp;udata);
<span class="lineNum">     645 </span>            :         g_assert (udata.found);
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span>            :         region_id = register_codegen_region (udata.region_start, udata.region_size, FALSE);
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            :         buffer_init (buf, 1024);
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span>            :         entry = (TrampolineEntry*)buf-&gt;p;
<span class="lineNum">     652 </span>            :         buf-&gt;p += sizeof (TrampolineEntry);
<span class="lineNum">     653 </span>            :         entry-&gt;id = ++id_generator;
<span class="lineNum">     654 </span>            :         entry-&gt;region_id = region_id;
<span class="lineNum">     655 </span>            :         entry-&gt;code = (gsize)code;
<span class="lineNum">     656 </span>            :         entry-&gt;code_size = code_len;
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span>            :         GSList *unwind_ops = mono_unwind_get_cie_program ();
<span class="lineNum">     659 </span>            :         emit_unwind_info (unwind_ops, buf);
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            :         buffer_add_string (buf, &quot;&quot;);
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            :         add_entry (ENTRY_TRAMPOLINE, buf);
<span class="lineNum">     664 </span>            :         buffer_free (buf);
<span class="lineNum">     665 </span>            : #endif
<span class="lineNum">     666 </span><span class="lineCov">   15347222 : }</span>
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span>            : /*
<span class="lineNum">     669 </span>            : DESIGN:
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            : Communication:
<span class="lineNum">     672 </span>            : Similar to the gdb jit interface. The runtime communicates with a plugin running inside lldb.
<span class="lineNum">     673 </span>            : - The runtime allocates a data packet, points a symbol with a well known name at it.
<span class="lineNum">     674 </span>            : - It calls a dummy function with a well known name.
<span class="lineNum">     675 </span>            : - The plugin sets a breakpoint at this function, causing the runtime to be suspended.
<span class="lineNum">     676 </span>            : - The plugin reads the data pointed to by the other symbol and processes it.
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span>            : The data packets are kept in a list, so lldb can read all of them after attaching.
<span class="lineNum">     679 </span>            : Lldb will associate an object file with each mono codegen region.
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span>            : Packet design:
<span class="lineNum">     682 </span>            : - use a flat byte array so the whole data can be read in one operation.
<span class="lineNum">     683 </span>            : - use 64 bit ints for pointers.
<span class="lineNum">     684 </span>            : */
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span>            : #else
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            : void
<span class="lineNum">     689 </span>            : mono_lldb_init (const char *options)
<span class="lineNum">     690 </span>            : {
<span class="lineNum">     691 </span>            :         g_error (&quot;lldb support has been disabled at configure time.&quot;);
<span class="lineNum">     692 </span>            : }
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span>            : void
<span class="lineNum">     695 </span>            : mono_lldb_save_method_info (MonoCompile *cfg)
<span class="lineNum">     696 </span>            : {
<span class="lineNum">     697 </span>            : }
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span>            : void
<span class="lineNum">     700 </span>            : mono_lldb_save_trampoline_info (MonoTrampInfo *info)
<span class="lineNum">     701 </span>            : {
<span class="lineNum">     702 </span>            : }
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span>            : void
<span class="lineNum">     705 </span>            : mono_lldb_remove_method (MonoDomain *domain, MonoMethod *method, MonoJitDynamicMethodInfo *info)
<span class="lineNum">     706 </span>            : {
<span class="lineNum">     707 </span>            : }
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span>            : void
<span class="lineNum">     710 </span>            : mono_lldb_save_specific_trampoline_info (gpointer arg1, MonoTrampolineType tramp_type, MonoDomain *domain, gpointer code, guint32 code_len)
<span class="lineNum">     711 </span>            : {
<span class="lineNum">     712 </span>            : }
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span>            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
