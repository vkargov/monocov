<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - utils/monobitset.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">utils</a> - monobitset.c<span style="font-size: 80%;"> (source / <a href="monobitset.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">111</td>
            <td class="headerCovTableEntry">190</td>
            <td class="headerCovTableEntryLo">58.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntryLo">65.5 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : #include &lt;glib.h&gt;</a>
<span class="lineNum">       2 </span>            : #include &lt;string.h&gt;
<span class="lineNum">       3 </span>            : 
<span class="lineNum">       4 </span>            : #include &quot;monobitset.h&quot;
<span class="lineNum">       5 </span>            : #include &quot;config.h&quot;
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #define BITS_PER_CHUNK MONO_BITSET_BITS_PER_CHUNK
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : /*
<span class="lineNum">      10 </span>            :  * mono_bitset_alloc_size:
<span class="lineNum">      11 </span>            :  * @max_size: The number of bits you want to hold
<span class="lineNum">      12 </span>            :  * @flags: unused
<span class="lineNum">      13 </span>            :  *
<span class="lineNum">      14 </span>            :  * Return the number of bytes required to hold the bitset.
<span class="lineNum">      15 </span>            :  * Useful to allocate it on the stack or with mempool.
<span class="lineNum">      16 </span>            :  * Use with mono_bitset_mem_new ().
<a name="17"><span class="lineNum">      17 </span>            :  */</a>
<span class="lineNum">      18 </span>            : guint32
<span class="lineNum">      19 </span>            : mono_bitset_alloc_size (guint32 max_size, guint32 flags) {
<span class="lineNum">      20 </span><span class="lineCov">  156861243 :         guint32 real_size = (max_size + BITS_PER_CHUNK - 1) / BITS_PER_CHUNK;</span>
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span><span class="lineCov">  156861243 :         return sizeof (MonoBitSet) + sizeof (gsize) * (real_size - MONO_ZERO_LEN_ARRAY);</span>
<span class="lineNum">      23 </span>            : }
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : /*
<span class="lineNum">      26 </span>            :  * mono_bitset_new:
<span class="lineNum">      27 </span>            :  * @max_size: The numer of bits you want to hold
<span class="lineNum">      28 </span>            :  * @flags: bitfield of flags
<span class="lineNum">      29 </span>            :  *
<span class="lineNum">      30 </span>            :  * Return a bitset of size max_size. It must be freed using
<span class="lineNum">      31 </span>            :  * mono_bitset_free.
<a name="32"><span class="lineNum">      32 </span>            :  */</a>
<span class="lineNum">      33 </span>            : MonoBitSet *
<span class="lineNum">      34 </span>            : mono_bitset_new (guint32 max_size, guint32 flags) {
<span class="lineNum">      35 </span><span class="lineCov">   67512180 :         guint32 real_size = (max_size + BITS_PER_CHUNK - 1) / BITS_PER_CHUNK;</span>
<span class="lineNum">      36 </span>            :         MonoBitSet *result;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span><span class="lineCov">   67512180 :         result = (MonoBitSet *) g_malloc0 (sizeof (MonoBitSet) + sizeof (gsize) * (real_size - MONO_ZERO_LEN_ARRAY));</span>
<span class="lineNum">      39 </span><span class="lineCov">   67512180 :         result-&gt;size = real_size * BITS_PER_CHUNK;</span>
<span class="lineNum">      40 </span><span class="lineCov">   67512180 :         result-&gt;flags = flags;</span>
<span class="lineNum">      41 </span><span class="lineCov">   67512180 :         return result;</span>
<span class="lineNum">      42 </span>            : }
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : /*
<span class="lineNum">      45 </span>            :  * mono_bitset_mem_new:
<span class="lineNum">      46 </span>            :  * @mem: The location the bitset is stored
<span class="lineNum">      47 </span>            :  * @max_size: The number of bits you want to hold
<span class="lineNum">      48 </span>            :  * @flags: bitfield of flags
<span class="lineNum">      49 </span>            :  *
<span class="lineNum">      50 </span>            :  * Return mem, which is now a initialized bitset of size max_size. It is
<span class="lineNum">      51 </span>            :  * not freed even if called with mono_bitset_free. mem must be at least
<span class="lineNum">      52 </span>            :  * as big as mono_bitset_alloc_size returns for the same max_size.
<a name="53"><span class="lineNum">      53 </span>            :  */</a>
<span class="lineNum">      54 </span>            : MonoBitSet *
<span class="lineNum">      55 </span>            : mono_bitset_mem_new (gpointer mem, guint32 max_size, guint32 flags) {
<span class="lineNum">      56 </span><span class="lineCov"> 1283734112 :         guint32 real_size = (max_size + BITS_PER_CHUNK - 1) / BITS_PER_CHUNK;</span>
<span class="lineNum">      57 </span><span class="lineCov"> 1283734112 :         MonoBitSet *result = (MonoBitSet *) mem;</span>
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span><span class="lineCov"> 1283734112 :         result-&gt;size = real_size * BITS_PER_CHUNK;</span>
<span class="lineNum">      60 </span><span class="lineCov"> 1283734112 :         result-&gt;flags = flags | MONO_BITSET_DONT_FREE;</span>
<span class="lineNum">      61 </span><span class="lineCov"> 1283734112 :         return result;</span>
<span class="lineNum">      62 </span>            : }
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : /*
<span class="lineNum">      65 </span>            :  * mono_bitset_free:
<span class="lineNum">      66 </span>            :  * @set: bitset ptr to free
<span class="lineNum">      67 </span>            :  *
<span class="lineNum">      68 </span>            :  * Free bitset unless flags have MONO_BITSET_DONT_FREE set. Does not
<span class="lineNum">      69 </span>            :  * free anything if flag MONO_BITSET_DONT_FREE is set or bitset was
<span class="lineNum">      70 </span>            :  * made with mono_bitset_mem_new.
<a name="71"><span class="lineNum">      71 </span>            :  */</a>
<span class="lineNum">      72 </span>            : void
<span class="lineNum">      73 </span>            : mono_bitset_free (MonoBitSet *set) {
<span class="lineNum">      74 </span><span class="lineCov">   40928537 :         if (!(set-&gt;flags &amp; MONO_BITSET_DONT_FREE))</span>
<span class="lineNum">      75 </span><span class="lineCov">   40929585 :                 g_free (set);</span>
<span class="lineNum">      76 </span><span class="lineCov">   40933747 : }</span>
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : /*
<span class="lineNum">      79 </span>            :  * mono_bitset_set:
<span class="lineNum">      80 </span>            :  * @set: bitset ptr
<span class="lineNum">      81 </span>            :  * @pos: set bit at this pos
<span class="lineNum">      82 </span>            :  *
<span class="lineNum">      83 </span>            :  * Set bit at pos @pos, counting from 0.
<a name="84"><span class="lineNum">      84 </span>            :  */</a>
<span class="lineNum">      85 </span>            : void
<span class="lineNum">      86 </span>            : mono_bitset_set (MonoBitSet *set, guint32 pos) {
<span class="lineNum">      87 </span><span class="lineCov">    8017068 :         int j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">      88 </span><span class="lineCov">    8017068 :         int bit = pos % BITS_PER_CHUNK;</span>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineCov">   24051204 :         g_assert (pos &lt; set-&gt;size);</span>
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span><span class="lineCov">    8017068 :         set-&gt;data [j] |= (gsize)1 &lt;&lt; bit;</span>
<span class="lineNum">      93 </span><span class="lineCov">    8017068 : }</span>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : /*
<span class="lineNum">      96 </span>            :  * mono_bitset_test:
<span class="lineNum">      97 </span>            :  * @set: bitset ptr
<span class="lineNum">      98 </span>            :  * @pos: test bit at this pos
<span class="lineNum">      99 </span>            :  *
<span class="lineNum">     100 </span>            :  * Test bit at pos @pos, counting from 0.
<span class="lineNum">     101 </span>            :  * Returns a value != 0 if set, 0 otherwise.
<a name="102"><span class="lineNum">     102 </span>            :  */</a>
<span class="lineNum">     103 </span>            : int
<span class="lineNum">     104 </span>            : mono_bitset_test (const MonoBitSet *set, guint32 pos) {
<span class="lineNum">     105 </span><span class="lineCov"> 1171123468 :         int j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">     106 </span><span class="lineCov"> 1171123468 :         int bit = pos % BITS_PER_CHUNK;</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov"> 3513370537 :         g_return_val_if_fail (pos &lt; set-&gt;size, 0);</span>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineCov"> 1171123364 :         return (set-&gt;data [j] &amp; ((gsize)1 &lt;&lt; bit)) &gt; 0;</span>
<span class="lineNum">     111 </span><span class="lineCov"> 1171123565 : }</span>
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : /*
<span class="lineNum">     114 </span>            :  * mono_bitset_test_bulk:
<span class="lineNum">     115 </span>            :  * @set: bitset ptr
<span class="lineNum">     116 </span>            :  * @pos: test bit at this pos
<span class="lineNum">     117 </span>            :  *
<span class="lineNum">     118 </span>            :  * Return 32/64 bits from the bitset, starting from @pos, which must be 
<span class="lineNum">     119 </span>            :  * divisible with 32/64.
<a name="120"><span class="lineNum">     120 </span>            :  */</a>
<span class="lineNum">     121 </span>            : gsize
<span class="lineNum">     122 </span>            : mono_bitset_test_bulk (const MonoBitSet *set, guint32 pos) {
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :         int j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :         if (pos &gt;= set-&gt;size)</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     127 </span>            :         else
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                 return set-&gt;data [j];</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            : /*
<span class="lineNum">     132 </span>            :  * mono_bitset_clear:
<span class="lineNum">     133 </span>            :  * @set: bitset ptr
<span class="lineNum">     134 </span>            :  * @pos: unset bit at this pos
<span class="lineNum">     135 </span>            :  *
<span class="lineNum">     136 </span>            :  * Unset bit at pos 'pos', counting from 0.
<a name="137"><span class="lineNum">     137 </span>            :  */</a>
<span class="lineNum">     138 </span>            : void
<span class="lineNum">     139 </span>            : mono_bitset_clear (MonoBitSet *set, guint32 pos) {
<span class="lineNum">     140 </span><span class="lineCov">    7045189 :         int j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">     141 </span><span class="lineCov">    7045189 :         int bit = pos % BITS_PER_CHUNK;</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineCov">   21135567 :         g_assert (pos &lt; set-&gt;size);</span>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineCov">    7045189 :         set-&gt;data [j] &amp;= ~((gsize)1 &lt;&lt; bit);</span>
<span class="lineNum">     146 </span><span class="lineCov">    7045189 : }</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : /*
<span class="lineNum">     149 </span>            :  * mono_bitset_clear_all:
<span class="lineNum">     150 </span>            :  * @set: bitset ptr
<span class="lineNum">     151 </span>            :  *
<span class="lineNum">     152 </span>            :  * Unset all bits.
<a name="153"><span class="lineNum">     153 </span>            :  */</a>
<span class="lineNum">     154 </span>            : void
<span class="lineNum">     155 </span>            : mono_bitset_clear_all (MonoBitSet *set) {
<span class="lineNum">     156 </span><span class="lineCov">   30537553 :         memset (set-&gt;data, 0, set-&gt;size / 8);</span>
<span class="lineNum">     157 </span><span class="lineCov">   30537553 : }</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            : /*
<span class="lineNum">     160 </span>            :  * mono_bitset_set_all:
<span class="lineNum">     161 </span>            :  * @set: bitset ptr
<span class="lineNum">     162 </span>            :  *
<span class="lineNum">     163 </span>            :  * Set all bits.
<a name="164"><span class="lineNum">     164 </span>            :  */</a>
<span class="lineNum">     165 </span>            : void
<span class="lineNum">     166 </span>            : mono_bitset_set_all (MonoBitSet *set) {
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :         memset (set-&gt;data, -1, set-&gt;size / 8);</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span>            : /*
<span class="lineNum">     171 </span>            :  * mono_bitset_invert:
<span class="lineNum">     172 </span>            :  * @set: bitset ptr
<span class="lineNum">     173 </span>            :  *
<span class="lineNum">     174 </span>            :  * Flip all bits.
<a name="175"><span class="lineNum">     175 </span>            :  */</a>
<span class="lineNum">     176 </span>            : void
<span class="lineNum">     177 </span>            : mono_bitset_invert (MonoBitSet *set) {
<span class="lineNum">     178 </span>            :         int i;
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; set-&gt;size / BITS_PER_CHUNK; ++i)</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :                 set-&gt;data [i] = ~set-&gt;data [i];</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span>            : /*
<span class="lineNum">     184 </span>            :  * mono_bitset_size:
<span class="lineNum">     185 </span>            :  * @set: bitset ptr
<span class="lineNum">     186 </span>            :  *
<span class="lineNum">     187 </span>            :  * Returns the number of bits this bitset can hold.
<a name="188"><span class="lineNum">     188 </span>            :  */</a>
<span class="lineNum">     189 </span>            : guint32
<span class="lineNum">     190 </span>            : mono_bitset_size (const MonoBitSet *set) {
<span class="lineNum">     191 </span><span class="lineCov"> 1186677184 :         return set-&gt;size;</span>
<span class="lineNum">     192 </span>            : }
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : /* 
<span class="lineNum">     195 </span>            :  * should test wich version is faster.
<span class="lineNum">     196 </span>            :  */
<span class="lineNum">     197 </span>            : #if 1
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            : /*
<span class="lineNum">     200 </span>            :  * mono_bitset_count:
<span class="lineNum">     201 </span>            :  * @set: bitset ptr
<span class="lineNum">     202 </span>            :  *
<span class="lineNum">     203 </span>            :  * return number of bits that is set.
<a name="204"><span class="lineNum">     204 </span>            :  */</a>
<span class="lineNum">     205 </span>            : guint32
<span class="lineNum">     206 </span>            : mono_bitset_count (const MonoBitSet *set) {
<span class="lineNum">     207 </span>            :         guint32 i, count;
<span class="lineNum">     208 </span>            :         gsize d;
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span><span class="lineCov">   67181818 :         count = 0;</span>
<span class="lineNum">     211 </span><span class="lineCov">  282381707 :         for (i = 0; i &lt; set-&gt;size / BITS_PER_CHUNK; ++i) {</span>
<span class="lineNum">     212 </span><span class="lineCov">   74002737 :                 d = set-&gt;data [i];</span>
<span class="lineNum">     213 </span>            : #ifdef __GNUC__
<span class="lineNum">     214 </span>            :                 if (sizeof (gsize) == sizeof (unsigned long))
<span class="lineNum">     215 </span><span class="lineCov">   74002737 :                         count += __builtin_popcountl (d);</span>
<span class="lineNum">     216 </span>            :                 else
<span class="lineNum">     217 </span>            :                         count += __builtin_popcount (d);
<span class="lineNum">     218 </span>            : #else
<span class="lineNum">     219 </span>            :                 while (d) {
<span class="lineNum">     220 </span>            :                         count ++;
<span class="lineNum">     221 </span>            :                         d &amp;= (d - 1);
<span class="lineNum">     222 </span>            :                 }
<span class="lineNum">     223 </span>            : #endif
<span class="lineNum">     224 </span><span class="lineCov">   74002737 :         }</span>
<span class="lineNum">     225 </span><span class="lineCov">   67194622 :         return count;</span>
<span class="lineNum">     226 </span>            : }
<span class="lineNum">     227 </span>            : #else
<span class="lineNum">     228 </span>            : guint32
<span class="lineNum">     229 </span>            : mono_bitset_count (const MonoBitSet *set) {
<span class="lineNum">     230 </span>            :         static const guint32 table [] = {
<span class="lineNum">     231 </span>            :                 0x55555555, 0x33333333, 0x0F0F0F0F, 0x00FF00FF, 0x0000FFFF
<span class="lineNum">     232 </span>            :         };
<span class="lineNum">     233 </span>            :         guint32 i, count, val;
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :         count = 0;
<span class="lineNum">     236 </span>            :         for (i = 0; i &lt; set-&gt;size / BITS_PER_CHUNK;+i) {
<span class="lineNum">     237 </span>            :                 if (set-&gt;data [i]) {
<span class="lineNum">     238 </span>            :                         val = set-&gt;data [i];
<span class="lineNum">     239 </span>            :                         val = (val &amp; table [0]) ((val &gt;&gt; 1) &amp; table [0]);
<span class="lineNum">     240 </span>            :                         val = (val &amp; table [1]) ((val &gt;&gt; 2) &amp; table [1]);
<span class="lineNum">     241 </span>            :                         val = (val &amp; table [2]) ((val &gt;&gt; 4) &amp; table [2]);
<span class="lineNum">     242 </span>            :                         val = (val &amp; table [3]) ((val &gt;&gt; 8) &amp; table [3]);
<span class="lineNum">     243 </span>            :                         val = (val &amp; table [4]) ((val &gt;&gt; 16) &amp; table [4]);
<span class="lineNum">     244 </span>            :                         count += val;
<span class="lineNum">     245 </span>            :                 }
<span class="lineNum">     246 </span>            :         }
<span class="lineNum">     247 </span>            :         return count;
<span class="lineNum">     248 </span>            : }
<span class="lineNum">     249 </span>            : 
<span class="lineNum">     250 </span>            : #endif
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span>            : #if 0
<span class="lineNum">     253 </span>            : const static int 
<span class="lineNum">     254 </span>            : bitstart_mask [] = {
<span class="lineNum">     255 </span>            :         0xffffffff, 0xfffffffe, 0xfffffffc, 0xfffffff8,
<span class="lineNum">     256 </span>            :         0xfffffff0, 0xffffffe0, 0xffffffc0, 0xffffff80,
<span class="lineNum">     257 </span>            :         0xffffff00, 0xfffffe00, 0xfffffc00, 0xfffff800,
<span class="lineNum">     258 </span>            :         0xfffff000, 0xffffe000, 0xffffc000, 0xffff8000,
<span class="lineNum">     259 </span>            :         0xffff0000, 0xfffe0000, 0xfffc0000, 0xfff80000,
<span class="lineNum">     260 </span>            :         0xfff00000, 0xffe00000, 0xffc00000, 0xff800000,
<span class="lineNum">     261 </span>            :         0xff000000, 0xfe000000, 0xfc000000, 0xf8000000,
<span class="lineNum">     262 </span>            :         0xf0000000, 0xe0000000, 0xc0000000, 0x80000000,
<span class="lineNum">     263 </span>            :         0x00000000
<span class="lineNum">     264 </span>            : };
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            : #define my_g_bit_nth_lsf(m,n) (ffs((m) &amp; bitstart_mask [(n)+1])-1)
<span class="lineNum">     267 </span>            : #define my_g_bit_nth_lsf_nomask(m) (ffs((m))-1)
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            : #else
<a name="270"><span class="lineNum">     270 </span>            : </a>
<span class="lineNum">     271 </span>            : static inline gint
<span class="lineNum">     272 </span>            : my_g_bit_nth_lsf (gsize mask, gint nth_bit)
<span class="lineNum">     273 </span>            : {
<span class="lineNum">     274 </span><span class="lineCov">   76225968 :         nth_bit ++;</span>
<span class="lineNum">     275 </span><span class="lineCov">   76225968 :         mask &gt;&gt;= nth_bit;</span>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineCov">  122031912 :         if ((mask == 0) || (nth_bit == BITS_PER_CHUNK))</span>
<span class="lineNum">     278 </span><span class="lineCov">   30608861 :                 return -1;</span>
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span>            : #if defined(__native_client__) &amp;&amp; (defined(__i386__) || defined(__x86_64))
<span class="lineNum">     281 </span>            : #define USE_X86_32BIT_INSTRUCTIONS 1
<span class="lineNum">     282 </span>            : #endif
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span>            : #if (defined(__i386__) &amp;&amp; defined(__GNUC__)) || defined(USE_X86_32BIT_INSTRUCTIONS)
<span class="lineNum">     285 </span>            :  {
<span class="lineNum">     286 </span>            :          int r;
<span class="lineNum">     287 </span>            :          /* This depends on mask != 0 */
<span class="lineNum">     288 </span>            :          __asm__(&quot;bsfl %1,%0\n\t&quot;
<span class="lineNum">     289 </span>            :                          : &quot;=r&quot; (r) : &quot;g&quot; (mask)); 
<span class="lineNum">     290 </span>            :          return nth_bit + r;
<span class="lineNum">     291 </span>            :  }
<span class="lineNum">     292 </span>            : #elif defined(__x86_64) &amp;&amp; defined(__GNUC__)
<span class="lineNum">     293 </span>            :  {
<span class="lineNum">     294 </span>            :         guint64 r;
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineCov">   45623482 :         __asm__(&quot;bsfq %1,%0\n\t&quot;</span>
<span class="lineNum">     297 </span><span class="lineCov">   45623482 :                         : &quot;=r&quot; (r) : &quot;rm&quot; (mask));</span>
<span class="lineNum">     298 </span><span class="lineCov">   45623482 :         return nth_bit + r;</span>
<span class="lineNum">     299 </span>            :  }
<span class="lineNum">     300 </span>            : #else
<span class="lineNum">     301 </span>            :         while (! (mask &amp; 0x1)) {
<span class="lineNum">     302 </span>            :                 mask &gt;&gt;= 1;
<span class="lineNum">     303 </span>            :                 nth_bit ++;
<span class="lineNum">     304 </span>            :         }
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            :         return nth_bit;
<span class="lineNum">     307 </span>            : #endif
<span class="lineNum">     308 </span><span class="lineCov">   76209241 : }</span>
<a name="309"><span class="lineNum">     309 </span>            : </a>
<span class="lineNum">     310 </span>            : static inline gint
<span class="lineNum">     311 </span>            : my_g_bit_nth_lsf_nomask (gsize mask)
<span class="lineNum">     312 </span>            : {
<span class="lineNum">     313 </span>            :         /* Mask is expected to be != 0 */
<span class="lineNum">     314 </span>            : #if (defined(__i386__) &amp;&amp; defined(__GNUC__)) || defined(USE_X86_32BIT_INSTRUCTIONS)
<span class="lineNum">     315 </span>            :         int r;
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            :         __asm__(&quot;bsfl %1,%0\n\t&quot;
<span class="lineNum">     318 </span>            :                         : &quot;=r&quot; (r) : &quot;rm&quot; (mask));
<span class="lineNum">     319 </span>            :         return r;
<span class="lineNum">     320 </span>            : #elif defined(__x86_64) &amp;&amp; defined(__GNUC__)
<span class="lineNum">     321 </span>            :         guint64 r;
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineCov">   29353705 :         __asm__(&quot;bsfq %1,%0\n\t&quot;</span>
<span class="lineNum">     324 </span><span class="lineCov">   29353705 :                         : &quot;=r&quot; (r) : &quot;rm&quot; (mask));</span>
<span class="lineNum">     325 </span><span class="lineCov">   29353705 :         return r;</span>
<span class="lineNum">     326 </span>            : #else
<span class="lineNum">     327 </span>            :         int nth_bit = 0;
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :         while (! (mask &amp; 0x1)) {
<span class="lineNum">     330 </span>            :                 mask &gt;&gt;= 1;
<span class="lineNum">     331 </span>            :                 nth_bit ++;
<span class="lineNum">     332 </span>            :         }
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            :         return nth_bit;
<span class="lineNum">     335 </span>            : #endif
<span class="lineNum">     336 </span>            : }
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            : #endif
<a name="339"><span class="lineNum">     339 </span>            : </a>
<span class="lineNum">     340 </span>            : static inline int
<span class="lineNum">     341 </span>            : my_g_bit_nth_msf (gsize mask,
<span class="lineNum">     342 </span>            :                gint   nth_bit)
<span class="lineNum">     343 </span>            : {
<span class="lineNum">     344 </span>            :         int i;
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :         if (nth_bit == 0)</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :         mask &lt;&lt;= BITS_PER_CHUNK - nth_bit;</span>
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :         i = BITS_PER_CHUNK;</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :         while ((i &gt; 0) &amp;&amp; !(mask &gt;&gt; (BITS_PER_CHUNK - 8))) {</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                 mask &lt;&lt;= 8;</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                 i -= 8;</span>
<span class="lineNum">     355 </span>            :         }
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         if (mask == 0)</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         do {</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :                 i--;</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :                 if (mask &amp; ((gsize)1 &lt;&lt; (BITS_PER_CHUNK - 1)))</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :                         return i - (BITS_PER_CHUNK - nth_bit);</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                 mask &lt;&lt;= 1;</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :         while (mask);</span>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 : }</span>
<a name="369"><span class="lineNum">     369 </span>            : </a>
<span class="lineNum">     370 </span>            : static int
<span class="lineNum">     371 </span>            : find_first_unset (gsize mask, gint nth_bit)
<span class="lineNum">     372 </span>            : {
<span class="lineNum">     373 </span><span class="lineCov">    7771443 :         do {</span>
<span class="lineNum">     374 </span><span class="lineCov">  244394750 :                 nth_bit++;</span>
<span class="lineNum">     375 </span><span class="lineCov">  244394750 :                 if (!(mask &amp; ((gsize)1 &lt;&lt; nth_bit))) {</span>
<span class="lineNum">     376 </span><span class="lineCov">    7771443 :                         if (nth_bit == BITS_PER_CHUNK)</span>
<span class="lineNum">     377 </span>            :                                 /* On 64 bit platforms, 1 &lt;&lt; 64 == 1 */
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                                 return -1;</span>
<span class="lineNum">     379 </span>            :                         else
<span class="lineNum">     380 </span><span class="lineCov">    7771443 :                                 return nth_bit;</span>
<span class="lineNum">     381 </span>            :                 }
<span class="lineNum">     382 </span><span class="lineCov">  473246614 :         } while (nth_bit &lt; BITS_PER_CHUNK);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     384 </span><span class="lineCov">    7771443 : }</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            : /*
<span class="lineNum">     387 </span>            :  * mono_bitset_find_start:
<span class="lineNum">     388 </span>            :  * @set: bitset ptr
<span class="lineNum">     389 </span>            :  *
<span class="lineNum">     390 </span>            :  * Equivalent to mono_bitset_find_first (set, -1) but faster.
<a name="391"><span class="lineNum">     391 </span>            :  */</a>
<span class="lineNum">     392 </span>            : int
<span class="lineNum">     393 </span>            : mono_bitset_find_start   (const MonoBitSet *set)
<span class="lineNum">     394 </span>            : {
<span class="lineNum">     395 </span>            :         int i;
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineCov">   63013997 :         for (i = 0; i &lt; set-&gt;size / BITS_PER_CHUNK; ++i) {</span>
<span class="lineNum">     398 </span><span class="lineCov">   30601096 :                 if (set-&gt;data [i])</span>
<span class="lineNum">     399 </span><span class="lineCov">   29354510 :                         return my_g_bit_nth_lsf_nomask (set-&gt;data [i]) + i * BITS_PER_CHUNK;</span>
<span class="lineNum">     400 </span><span class="lineCov">    1246940 :         }</span>
<span class="lineNum">     401 </span><span class="lineCov">     907576 :         return -1;</span>
<span class="lineNum">     402 </span><span class="lineCov">   30261866 : }</span>
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span>            : /*
<span class="lineNum">     405 </span>            :  * mono_bitset_find_first:
<span class="lineNum">     406 </span>            :  * @set: bitset ptr
<span class="lineNum">     407 </span>            :  * @pos: pos to search _after_ (not including)
<span class="lineNum">     408 </span>            :  *
<span class="lineNum">     409 </span>            :  * Returns position of first set bit after @pos. If pos &lt; 0 begin search from
<span class="lineNum">     410 </span>            :  * start. Return -1 if no bit set is found.
<a name="411"><span class="lineNum">     411 </span>            :  */</a>
<span class="lineNum">     412 </span>            : int
<span class="lineNum">     413 </span>            : mono_bitset_find_first (const MonoBitSet *set, gint pos) {
<span class="lineNum">     414 </span>            :         int j;
<span class="lineNum">     415 </span>            :         int bit;
<span class="lineNum">     416 </span>            :         int result, i;
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineCov">   74944353 :         if (pos &lt; 0) {</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :                 j = 0;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :                 bit = -1;</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     422 </span><span class="lineCov">   74950924 :                 j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">     423 </span><span class="lineCov">   74950924 :                 bit = pos % BITS_PER_CHUNK;</span>
<span class="lineNum">     424 </span><span class="lineCov">  224877172 :                 g_assert (pos &lt; set-&gt;size);</span>
<span class="lineNum">     425 </span>            :         }
<span class="lineNum">     426 </span>            :         /*g_print (&quot;find first from %d (j: %d, bit: %d)\n&quot;, pos, j, bit);*/
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineCov">   74967655 :         if (set-&gt;data [j]) {</span>
<span class="lineNum">     429 </span><span class="lineCov">   74994160 :                 result = my_g_bit_nth_lsf (set-&gt;data [j], bit);</span>
<span class="lineNum">     430 </span><span class="lineCov">   74994160 :                 if (result != -1)</span>
<span class="lineNum">     431 </span><span class="lineCov">   44383157 :                         return result + j * BITS_PER_CHUNK;</span>
<span class="lineNum">     432 </span><span class="lineCov">   30607638 :         }</span>
<span class="lineNum">     433 </span><span class="lineCov">   68984076 :         for (i = ++j; i &lt; set-&gt;size / BITS_PER_CHUNK; ++i) {</span>
<span class="lineNum">     434 </span><span class="lineCov">    5123549 :                 if (set-&gt;data [i])</span>
<span class="lineNum">     435 </span><span class="lineCov">    1239396 :                         return my_g_bit_nth_lsf (set-&gt;data [i], -1) + i * BITS_PER_CHUNK;</span>
<span class="lineNum">     436 </span><span class="lineCov">    3884193 :         }</span>
<span class="lineNum">     437 </span><span class="lineCov">   29369667 :         return -1;</span>
<span class="lineNum">     438 </span><span class="lineCov">   74956348 : }</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span>            : /*
<span class="lineNum">     441 </span>            :  * mono_bitset_find_last:
<span class="lineNum">     442 </span>            :  * @set: bitset ptr
<span class="lineNum">     443 </span>            :  * @pos: pos to search _before_ (not including)
<span class="lineNum">     444 </span>            :  *
<span class="lineNum">     445 </span>            :  * Returns position of last set bit before pos. If pos &lt; 0 search is
<span class="lineNum">     446 </span>            :  * started from the end. Returns -1 if no set bit is found.
<a name="447"><span class="lineNum">     447 </span>            :  */</a>
<span class="lineNum">     448 </span>            : int
<span class="lineNum">     449 </span>            : mono_bitset_find_last (const MonoBitSet *set, gint pos) {
<span class="lineNum">     450 </span>            :         int j, bit, result, i;
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :         if (pos &lt; 0)</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                 pos = set-&gt;size - 1;</span>
<span class="lineNum">     454 </span>            :                 
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :         j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :         bit = pos % BITS_PER_CHUNK;</span>
<span class="lineNum">     457 </span>            : 
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         g_return_val_if_fail (pos &lt; set-&gt;size, -1);</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :         if (set-&gt;data [j]) {</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                 result = my_g_bit_nth_msf (set-&gt;data [j], bit);</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                 if (result != -1)</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                         return result + j * BITS_PER_CHUNK;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :         for (i = --j; i &gt;= 0; --i) {</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 if (set-&gt;data [i])</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                         return my_g_bit_nth_msf (set-&gt;data [i], BITS_PER_CHUNK) + i * BITS_PER_CHUNK;</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            : /*
<span class="lineNum">     473 </span>            :  * mono_bitset_find_first_unset:
<span class="lineNum">     474 </span>            :  * @set: bitset ptr
<span class="lineNum">     475 </span>            :  * @pos: pos to search _after_ (not including)
<span class="lineNum">     476 </span>            :  *
<span class="lineNum">     477 </span>            :  * Returns position of first unset bit after @pos. If pos &lt; 0 begin search from
<span class="lineNum">     478 </span>            :  * start. Return -1 if no bit set is found.
<a name="479"><span class="lineNum">     479 </span>            :  */</a>
<span class="lineNum">     480 </span>            : int
<span class="lineNum">     481 </span>            : mono_bitset_find_first_unset (const MonoBitSet *set, gint pos) {
<span class="lineNum">     482 </span>            :         int j;
<span class="lineNum">     483 </span>            :         int bit;
<span class="lineNum">     484 </span>            :         int result, i;
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span><span class="lineCov">    7787755 :         if (pos &lt; 0) {</span>
<span class="lineNum">     487 </span><span class="lineCov">    7556071 :                 j = 0;</span>
<span class="lineNum">     488 </span><span class="lineCov">    7556071 :                 bit = -1;</span>
<span class="lineNum">     489 </span><span class="lineCov">    7556071 :         } else {</span>
<span class="lineNum">     490 </span><span class="lineCov">     231684 :                 j = pos / BITS_PER_CHUNK;</span>
<span class="lineNum">     491 </span><span class="lineCov">     231684 :                 bit = pos % BITS_PER_CHUNK;</span>
<span class="lineNum">     492 </span><span class="lineCov">     695052 :                 g_return_val_if_fail (pos &lt; set-&gt;size, -1);</span>
<span class="lineNum">     493 </span>            :         }
<span class="lineNum">     494 </span>            :         /*g_print (&quot;find first from %d (j: %d, bit: %d)\n&quot;, pos, j, bit);*/
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineCov">    7787755 :         if (set-&gt;data [j] != -1) {</span>
<span class="lineNum">     497 </span><span class="lineCov">     422357 :                 result = find_first_unset (set-&gt;data [j], bit);</span>
<span class="lineNum">     498 </span><span class="lineCov">     422357 :                 if (result != -1)</span>
<span class="lineNum">     499 </span><span class="lineCov">     422357 :                         return result + j * BITS_PER_CHUNK;</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     501 </span><span class="lineCov">  727071692 :         for (i = ++j; i &lt; set-&gt;size / BITS_PER_CHUNK; ++i) {</span>
<span class="lineNum">     502 </span><span class="lineCov">  363519534 :                 if (set-&gt;data [i] != -1) {</span>
<span class="lineNum">     503 </span><span class="lineCov">    7349086 :                         return find_first_unset (set-&gt;data [i], -1) + i * BITS_PER_CHUNK;</span>
<span class="lineNum">     504 </span>            :                 }
<span class="lineNum">     505 </span><span class="lineCov">  356170448 :         }</span>
<span class="lineNum">     506 </span><span class="lineCov">      16312 :         return -1;</span>
<span class="lineNum">     507 </span><span class="lineCov">    7787755 : }</span>
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span>            : /*
<span class="lineNum">     510 </span>            :  * mono_bitset_clone:
<span class="lineNum">     511 </span>            :  * @set: bitset ptr to clone
<span class="lineNum">     512 </span>            :  * @new_size: number of bits the cloned bitset can hold
<span class="lineNum">     513 </span>            :  *
<span class="lineNum">     514 </span>            :  * Return a cloned bitset of size new_size. MONO_BITSET_DONT_FREE
<span class="lineNum">     515 </span>            :  * unset in cloned bitset. If new_size is 0, the cloned object is just
<span class="lineNum">     516 </span>            :  * as big.
<a name="517"><span class="lineNum">     517 </span>            :  */</a>
<span class="lineNum">     518 </span>            : MonoBitSet*
<span class="lineNum">     519 </span>            : mono_bitset_clone (const MonoBitSet *set, guint32 new_size) {
<span class="lineNum">     520 </span>            :         MonoBitSet *result;
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineCov">      70956 :         if (!new_size)</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                 new_size = set-&gt;size;</span>
<span class="lineNum">     524 </span><span class="lineCov">      70956 :         result = mono_bitset_new (new_size, set-&gt;flags);</span>
<span class="lineNum">     525 </span><span class="lineCov">      70956 :         result-&gt;flags &amp;= ~MONO_BITSET_DONT_FREE;</span>
<span class="lineNum">     526 </span><span class="lineCov">      70956 :         memcpy (result-&gt;data, set-&gt;data, set-&gt;size / 8);</span>
<span class="lineNum">     527 </span><span class="lineCov">      70956 :         return result;</span>
<span class="lineNum">     528 </span>            : }
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            : /*
<span class="lineNum">     531 </span>            :  * mono_bitset_copyto:
<span class="lineNum">     532 </span>            :  * @src: bitset ptr to copy from
<span class="lineNum">     533 </span>            :  * @dest: bitset ptr to copy to
<span class="lineNum">     534 </span>            :  *
<span class="lineNum">     535 </span>            :  * Copy one bitset to another.
<a name="536"><span class="lineNum">     536 </span>            :  */</a>
<span class="lineNum">     537 </span>            : void
<span class="lineNum">     538 </span>            : mono_bitset_copyto (const MonoBitSet *src, MonoBitSet *dest) {
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :         g_assert (dest-&gt;size &lt;= src-&gt;size);</span>
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         memcpy (&amp;dest-&gt;data, &amp;src-&gt;data, dest-&gt;size / 8);</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span>            : /*
<span class="lineNum">     545 </span>            :  * mono_bitset_union:
<span class="lineNum">     546 </span>            :  * @dest: bitset ptr to hold union
<span class="lineNum">     547 </span>            :  * @src: bitset ptr to copy
<span class="lineNum">     548 </span>            :  *
<span class="lineNum">     549 </span>            :  * Make union of one bitset and another.
<a name="550"><span class="lineNum">     550 </span>            :  */</a>
<span class="lineNum">     551 </span>            : void
<span class="lineNum">     552 </span>            : mono_bitset_union (MonoBitSet *dest, const MonoBitSet *src) {
<span class="lineNum">     553 </span>            :         int i, size;
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :         g_assert (src-&gt;size &lt;= dest-&gt;size);</span>
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :         size = dest-&gt;size / BITS_PER_CHUNK;</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; size; ++i)</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                 dest-&gt;data [i] |= src-&gt;data [i];</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     561 </span>            : 
<span class="lineNum">     562 </span>            : /*
<span class="lineNum">     563 </span>            :  * mono_bitset_intersection:
<span class="lineNum">     564 </span>            :  * @dest: bitset ptr to hold intersection
<span class="lineNum">     565 </span>            :  * @src: bitset ptr to copy
<span class="lineNum">     566 </span>            :  *
<span class="lineNum">     567 </span>            :  * Make intersection of one bitset and another.
<a name="568"><span class="lineNum">     568 </span>            :  */</a>
<span class="lineNum">     569 </span>            : void
<span class="lineNum">     570 </span>            : mono_bitset_intersection (MonoBitSet *dest, const MonoBitSet *src) {
<span class="lineNum">     571 </span>            :         int i, size;
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         g_assert (src-&gt;size &lt;= dest-&gt;size);</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         size = dest-&gt;size / BITS_PER_CHUNK;</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; size; ++i)</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :                 dest-&gt;data [i] &amp;= src-&gt;data [i];</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            : /*
<span class="lineNum">     581 </span>            :  * mono_bitset_intersection_2:
<span class="lineNum">     582 </span>            :  * @dest: bitset ptr to hold intersection
<span class="lineNum">     583 </span>            :  * @src1: first bitset
<span class="lineNum">     584 </span>            :  * @src2: second bitset
<span class="lineNum">     585 </span>            :  *
<span class="lineNum">     586 </span>            :  * Make intersection of two bitsets
<a name="587"><span class="lineNum">     587 </span>            :  */</a>
<span class="lineNum">     588 </span>            : void
<span class="lineNum">     589 </span>            : mono_bitset_intersection_2 (MonoBitSet *dest, const MonoBitSet *src1, const MonoBitSet *src2) {
<span class="lineNum">     590 </span>            :         int i, size;
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         g_assert (src1-&gt;size &lt;= dest-&gt;size);</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :         g_assert (src2-&gt;size &lt;= dest-&gt;size);</span>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         size = dest-&gt;size / BITS_PER_CHUNK;</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; size; ++i)</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                 dest-&gt;data [i] = src1-&gt;data [i] &amp; src2-&gt;data [i];</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span>            : /*
<span class="lineNum">     601 </span>            :  * mono_bitset_sub:
<span class="lineNum">     602 </span>            :  * @dest: bitset ptr to hold bitset - src
<span class="lineNum">     603 </span>            :  * @src: bitset ptr to copy
<span class="lineNum">     604 </span>            :  *
<span class="lineNum">     605 </span>            :  * Unset all bits in dest, which are set in src.
<a name="606"><span class="lineNum">     606 </span>            :  */</a>
<span class="lineNum">     607 </span>            : void
<span class="lineNum">     608 </span>            : mono_bitset_sub (MonoBitSet *dest, const MonoBitSet *src) {
<span class="lineNum">     609 </span>            :         int i, size;
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineCov">      32328 :         g_assert (src-&gt;size &lt;= dest-&gt;size);</span>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span><span class="lineCov">      10776 :         size = src-&gt;size / BITS_PER_CHUNK;</span>
<span class="lineNum">     614 </span><span class="lineCov">     850178 :         for (i = 0; i &lt; size; ++i)</span>
<span class="lineNum">     615 </span><span class="lineCov">     414313 :                 dest-&gt;data [i] &amp;= ~src-&gt;data [i];</span>
<span class="lineNum">     616 </span><span class="lineCov">      10776 : }</span>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span>            : /*
<span class="lineNum">     619 </span>            :  * mono_bitset_equal:
<span class="lineNum">     620 </span>            :  * @src: bitset ptr
<span class="lineNum">     621 </span>            :  * @src1: bitset ptr
<span class="lineNum">     622 </span>            :  *
<span class="lineNum">     623 </span>            :  * return TRUE if their size are the same and the same bits are set in
<span class="lineNum">     624 </span>            :  * both bitsets.
<a name="625"><span class="lineNum">     625 </span>            :  */</a>
<span class="lineNum">     626 </span>            : gboolean
<span class="lineNum">     627 </span>            : mono_bitset_equal (const MonoBitSet *src, const MonoBitSet *src1) {
<span class="lineNum">     628 </span>            :         int i;
<span class="lineNum">     629 </span><span class="lineCov">  118701917 :         if (src-&gt;size != src1-&gt;size)</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span><span class="lineCov">  339886898 :         for (i = 0; i &lt; src-&gt;size / BITS_PER_CHUNK; ++i)</span>
<span class="lineNum">     633 </span><span class="lineCov">  183334121 :                 if (src-&gt;data [i] != src1-&gt;data [i])</span>
<span class="lineNum">     634 </span><span class="lineCov">   80827088 :                         return FALSE;</span>
<span class="lineNum">     635 </span><span class="lineCov">   37925681 :         return TRUE;</span>
<span class="lineNum">     636 </span><span class="lineCov">  118676568 : }</span>
<span class="lineNum">     637 </span>            : 
<span class="lineNum">     638 </span>            : /*
<span class="lineNum">     639 </span>            :  * mono_bitset_foreach:
<span class="lineNum">     640 </span>            :  * @set: bitset ptr
<span class="lineNum">     641 </span>            :  * @func: Function to call for every set bit
<span class="lineNum">     642 </span>            :  * @data: pass this as second arg to func
<span class="lineNum">     643 </span>            :  *
<span class="lineNum">     644 </span>            :  * Calls func for every bit set in bitset. Argument 1 is the number of
<span class="lineNum">     645 </span>            :  * the bit set, argument 2 is data
<a name="646"><span class="lineNum">     646 </span>            :  */</a>
<span class="lineNum">     647 </span>            : void
<span class="lineNum">     648 </span>            : mono_bitset_foreach (MonoBitSet *set, MonoBitSetFunc func, gpointer data)
<span class="lineNum">     649 </span>            : {
<span class="lineNum">     650 </span>            :         int i, j;
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; set-&gt;size / BITS_PER_CHUNK; ++i) {</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :                 if (set-&gt;data [i]) {</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :                         for (j = 0; j &lt; BITS_PER_CHUNK; ++j)</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :                                 if (set-&gt;data [i] &amp; ((gsize)1 &lt;&lt; j))</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :                                         func (j + i * BITS_PER_CHUNK, data);</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span>            : #ifdef TEST_BITSET
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span>            : /*
<span class="lineNum">     663 </span>            :  * Compile with: 
<span class="lineNum">     664 </span>            :  * gcc -g -Wall -DTEST_BITSET -o monobitset monobitset.c `pkg-config --cflags --libs glib-2.0`
<span class="lineNum">     665 </span>            :  */
<span class="lineNum">     666 </span>            : int 
<span class="lineNum">     667 </span>            : main() {
<span class="lineNum">     668 </span>            :         MonoBitSet *set1, *set2, *set3, *set4;
<span class="lineNum">     669 </span>            :         int error = 1;
<span class="lineNum">     670 </span>            :         int count, i;
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span>            :         set1 = mono_bitset_new (60, 0);
<span class="lineNum">     673 </span>            :         set4 = mono_bitset_new (60, 0);
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span>            :         if (mono_bitset_count (set1) != 0)
<span class="lineNum">     676 </span>            :                 return error;
<span class="lineNum">     677 </span>            :         error++;
<span class="lineNum">     678 </span>            :         
<span class="lineNum">     679 </span>            :         mono_bitset_set (set1, 33);
<span class="lineNum">     680 </span>            :         if (mono_bitset_count (set1) != 1)
<span class="lineNum">     681 </span>            :                 return error;
<span class="lineNum">     682 </span>            :         error++;
<span class="lineNum">     683 </span>            : 
<span class="lineNum">     684 </span>            :         /* g_print(&quot;should be 33: %d\n&quot;, mono_bitset_find_first (set1, 0)); */
<span class="lineNum">     685 </span>            :         
<span class="lineNum">     686 </span>            :         if (mono_bitset_find_first (set1, 0) != 33)
<span class="lineNum">     687 </span>            :                 return error;
<span class="lineNum">     688 </span>            :         error++;
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span>            :         if (mono_bitset_find_first (set1, 33) != -1)
<span class="lineNum">     691 </span>            :                 return error;
<span class="lineNum">     692 </span>            :         error++;
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span>            :         /* test 5 */
<span class="lineNum">     695 </span>            :         if (mono_bitset_find_first (set1, -100) != 33)
<span class="lineNum">     696 </span>            :                 return error;
<span class="lineNum">     697 </span>            :         error++;
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span>            :         if (mono_bitset_find_last (set1, -1) != 33)
<span class="lineNum">     700 </span>            :                 return error;
<span class="lineNum">     701 </span>            :         error++;
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span>            :         if (mono_bitset_find_last (set1, 33) != -1)
<span class="lineNum">     704 </span>            :                 return error;
<span class="lineNum">     705 </span>            :         error++;
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :         if (mono_bitset_find_last (set1, -100) != 33)
<span class="lineNum">     708 </span>            :                 return error;
<span class="lineNum">     709 </span>            :         error++;
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span>            :         if (mono_bitset_find_last (set1, 34) != 33)
<span class="lineNum">     712 </span>            :                 return error;
<span class="lineNum">     713 </span>            :         error++;
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            :         /* test 10 */
<span class="lineNum">     716 </span>            :         if (!mono_bitset_test (set1, 33))
<span class="lineNum">     717 </span>            :                 return error;
<span class="lineNum">     718 </span>            :         error++;
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span>            :         if (mono_bitset_test (set1, 32) || mono_bitset_test (set1, 34))
<span class="lineNum">     721 </span>            :                 return error;
<span class="lineNum">     722 </span>            :         error++;
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span>            :         set2 = mono_bitset_clone (set1, 0);
<span class="lineNum">     725 </span>            :         if (mono_bitset_count (set2) != 1)
<span class="lineNum">     726 </span>            :                 return error;
<span class="lineNum">     727 </span>            :         error++;
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span>            :         mono_bitset_invert (set2);
<span class="lineNum">     730 </span>            :         if (mono_bitset_count (set2) != (mono_bitset_size (set2) - 1))
<span class="lineNum">     731 </span>            :                 return error;
<span class="lineNum">     732 </span>            :         error++;
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span>            :         mono_bitset_clear (set2, 10);
<span class="lineNum">     735 </span>            :         if (mono_bitset_count (set2) != (mono_bitset_size (set2) - 2))
<span class="lineNum">     736 </span>            :                 return error;
<span class="lineNum">     737 </span>            :         error++;
<span class="lineNum">     738 </span>            : 
<span class="lineNum">     739 </span>            :         /* test 15 */
<span class="lineNum">     740 </span>            :         set3 = mono_bitset_clone (set2, 0);
<span class="lineNum">     741 </span>            :         mono_bitset_union (set3, set1);
<span class="lineNum">     742 </span>            :         if (mono_bitset_count (set3) != (mono_bitset_size (set3) - 1))
<span class="lineNum">     743 </span>            :                 return error;
<span class="lineNum">     744 </span>            :         error++;
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span>            :         mono_bitset_clear_all (set2);
<span class="lineNum">     747 </span>            :         if (mono_bitset_count (set2) != 0)
<span class="lineNum">     748 </span>            :                 return error;
<span class="lineNum">     749 </span>            :         error++;
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            :         mono_bitset_invert (set2);
<span class="lineNum">     752 </span>            :         if (mono_bitset_count (set2) != mono_bitset_size (set2))
<span class="lineNum">     753 </span>            :                 return error;
<span class="lineNum">     754 </span>            :         error++;
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span>            :         mono_bitset_set (set4, 0);
<span class="lineNum">     757 </span>            :         mono_bitset_set (set4, 1);
<span class="lineNum">     758 </span>            :         mono_bitset_set (set4, 10);
<span class="lineNum">     759 </span>            :         if (mono_bitset_count (set4) != 3)
<span class="lineNum">     760 </span>            :                 return error;
<span class="lineNum">     761 </span>            :         error++;
<span class="lineNum">     762 </span>            : 
<span class="lineNum">     763 </span>            :         count = 0;
<span class="lineNum">     764 </span>            :         for (i = mono_bitset_find_first (set4, -1); i != -1; i = mono_bitset_find_first (set4, i)) {
<span class="lineNum">     765 </span>            :                 count ++;
<span class="lineNum">     766 </span>            :                 switch (count) {
<span class="lineNum">     767 </span>            :                 case 1:
<span class="lineNum">     768 </span>            :                   if (i != 0)
<span class="lineNum">     769 </span>            :                     return error;
<span class="lineNum">     770 </span>            :                   break;
<span class="lineNum">     771 </span>            :                 case 2:
<span class="lineNum">     772 </span>            :                   if (i != 1)
<span class="lineNum">     773 </span>            :                     return error;
<span class="lineNum">     774 </span>            :                   break;
<span class="lineNum">     775 </span>            :                 case 3:
<span class="lineNum">     776 </span>            :                   if (i != 10)
<span class="lineNum">     777 </span>            :                     return error;
<span class="lineNum">     778 </span>            :                   break;
<span class="lineNum">     779 </span>            :                 }
<span class="lineNum">     780 </span>            :                 /* g_print (&quot;count got: %d at %d\n&quot;, count, i); */
<span class="lineNum">     781 </span>            :         }
<span class="lineNum">     782 </span>            :         if (count != 3)
<span class="lineNum">     783 </span>            :                 return error;
<span class="lineNum">     784 </span>            :         error++;
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            :         if (mono_bitset_find_first (set4, -1) != 0)
<span class="lineNum">     787 </span>            :                 return error;
<span class="lineNum">     788 </span>            :         error++;
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :         /* 20 */
<span class="lineNum">     791 </span>            :         mono_bitset_set (set4, 31);
<span class="lineNum">     792 </span>            :         if (mono_bitset_find_first (set4, 10) != 31)
<span class="lineNum">     793 </span>            :                 return error;
<span class="lineNum">     794 </span>            :         error++;
<span class="lineNum">     795 </span>            : 
<span class="lineNum">     796 </span>            :         mono_bitset_free (set1);
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            :         set1 = mono_bitset_new (200, 0);
<span class="lineNum">     799 </span>            :         mono_bitset_set (set1, 0);
<span class="lineNum">     800 </span>            :         mono_bitset_set (set1, 1);
<span class="lineNum">     801 </span>            :         mono_bitset_set (set1, 10);
<span class="lineNum">     802 </span>            :         mono_bitset_set (set1, 31);
<span class="lineNum">     803 </span>            :         mono_bitset_set (set1, 150);
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span>            :         mono_bitset_free (set1);
<span class="lineNum">     806 </span>            :         mono_bitset_free (set2);
<span class="lineNum">     807 </span>            :         mono_bitset_free (set3);
<span class="lineNum">     808 </span>            :         mono_bitset_free (set4);
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span>            :         g_print (&quot;total tests passed: %d\n&quot;, error - 1);
<span class="lineNum">     811 </span>            :         
<span class="lineNum">     812 </span>            :         return 0;
<span class="lineNum">     813 </span>            : }
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span>            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
