<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - sgen/sgen-cardtable.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">sgen</a> - sgen-cardtable.c<span style="font-size: 80%;"> (source / <a href="sgen-cardtable.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">157</td>
            <td class="headerCovTableEntry">199</td>
            <td class="headerCovTableEntryMed">78.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">25</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntryMed">86.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * sgen-cardtable.c: Card table implementation for sgen
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Author:
<span class="lineNum">       5 </span>            :  *      Rodrigo Kumpera (rkumpera@novell.com)
<span class="lineNum">       6 </span>            :  *
<span class="lineNum">       7 </span>            :  * Copyright 2001-2003 Ximian, Inc
<span class="lineNum">       8 </span>            :  * Copyright 2003-2010 Novell, Inc.
<span class="lineNum">       9 </span>            :  * Copyright 2011 Xamarin Inc (http://www.xamarin.com)
<span class="lineNum">      10 </span>            :  * Copyright (C) 2012 Xamarin Inc
<span class="lineNum">      11 </span>            :  *
<span class="lineNum">      12 </span>            :  * Licensed under the MIT license. See LICENSE file in the project root for full license information.
<span class="lineNum">      13 </span>            :  */
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &quot;config.h&quot;
<span class="lineNum">      16 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;mono/sgen/sgen-gc.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;mono/sgen/sgen-cardtable.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;mono/sgen/sgen-memory-governor.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;mono/sgen/sgen-protocol.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;mono/sgen/sgen-layout-stats.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;mono/sgen/sgen-client.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;mono/sgen/gc-internal-agnostic.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;mono/utils/mono-memory-model.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : //#define CARDTABLE_STATS
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #ifdef HAVE_UNISTD_H
<span class="lineNum">      32 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      33 </span>            : #endif
<span class="lineNum">      34 </span>            : #ifdef HAVE_SYS_MMAN_H
<span class="lineNum">      35 </span>            : #include &lt;sys/mman.h&gt;
<span class="lineNum">      36 </span>            : #endif
<span class="lineNum">      37 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : guint8 *sgen_cardtable;
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : static gboolean need_mod_union;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : #ifdef HEAVY_STATISTICS
<span class="lineNum">      44 </span>            : guint64 marked_cards;
<span class="lineNum">      45 </span>            : guint64 scanned_cards;
<span class="lineNum">      46 </span>            : guint64 scanned_objects;
<span class="lineNum">      47 </span>            : guint64 remarked_cards;
<span class="lineNum">      48 </span>            : static guint64 large_objects;
<span class="lineNum">      49 </span>            : static guint64 bloby_objects;
<span class="lineNum">      50 </span>            : #endif
<span class="lineNum">      51 </span>            : static guint64 major_card_scan_time;
<span class="lineNum">      52 </span>            : static guint64 los_card_scan_time;
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : static guint64 last_major_scan_time;
<span class="lineNum">      55 </span>            : static guint64 last_los_scan_time;
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : static void sgen_card_tables_collect_stats (gboolean begin);
<a name="58"><span class="lineNum">      58 </span>            : </a>
<span class="lineNum">      59 </span>            : mword
<span class="lineNum">      60 </span>            : sgen_card_table_number_of_cards_in_range (mword address, mword size)
<span class="lineNum">      61 </span>            : {
<span class="lineNum">      62 </span><span class="lineCov">   79137203 :         mword end = address + MAX (1, size) - 1;</span>
<span class="lineNum">      63 </span><span class="lineCov">   26379067 :         return (end &gt;&gt; CARD_BITS) - (address &gt;&gt; CARD_BITS) + 1;</span>
<span class="lineNum">      64 </span>            : }
<a name="65"><span class="lineNum">      65 </span>            : </a>
<span class="lineNum">      66 </span>            : static void
<span class="lineNum">      67 </span>            : sgen_card_table_wbarrier_set_field (GCObject *obj, gpointer field_ptr, GCObject* value)
<span class="lineNum">      68 </span>            : {
<span class="lineNum">      69 </span><span class="lineCov">     455821 :         *(void**)field_ptr = value;</span>
<span class="lineNum">      70 </span><span class="lineCov">     455821 :         if (need_mod_union || sgen_ptr_in_nursery (value))</span>
<span class="lineNum">      71 </span><span class="lineCov">     455822 :                 sgen_card_table_mark_address ((mword)field_ptr);</span>
<span class="lineNum">      72 </span><span class="lineCov">     455822 :         sgen_dummy_use (value);</span>
<span class="lineNum">      73 </span><span class="lineCov">     455822 : }</span>
<a name="74"><span class="lineNum">      74 </span>            : </a>
<span class="lineNum">      75 </span>            : static void
<span class="lineNum">      76 </span>            : sgen_card_table_wbarrier_arrayref_copy (gpointer dest_ptr, gpointer src_ptr, int count)
<span class="lineNum">      77 </span>            : {
<span class="lineNum">      78 </span><span class="lineCov">    2913477 :         gpointer *dest = (gpointer *)dest_ptr;</span>
<span class="lineNum">      79 </span><span class="lineCov">    2913477 :         gpointer *src = (gpointer *)src_ptr;</span>
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            :         /*overlapping that required backward copying*/
<span class="lineNum">      82 </span><span class="lineCov">    5597216 :         if (src &lt; dest &amp;&amp; (src + count) &gt; dest) {</span>
<span class="lineNum">      83 </span><span class="lineCov">     317415 :                 gpointer *start = dest;</span>
<span class="lineNum">      84 </span><span class="lineCov">     317415 :                 dest += count - 1;</span>
<span class="lineNum">      85 </span><span class="lineCov">     317415 :                 src += count - 1;</span>
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span><span class="lineCov">    3047021 :                 for (; dest &gt;= start; --src, --dest) {</span>
<span class="lineNum">      88 </span><span class="lineCov">    1206116 :                         gpointer value = *src;</span>
<span class="lineNum">      89 </span><span class="lineCov">    1206116 :                         SGEN_UPDATE_REFERENCE_ALLOW_NULL (dest, value);</span>
<span class="lineNum">      90 </span><span class="lineCov">    1206116 :                         if (need_mod_union || sgen_ptr_in_nursery (value))</span>
<span class="lineNum">      91 </span><span class="lineCov">    1206117 :                                 sgen_card_table_mark_address ((mword)dest);</span>
<span class="lineNum">      92 </span><span class="lineCov">    1206102 :                         sgen_dummy_use (value);</span>
<span class="lineNum">      93 </span><span class="lineCov">    1206102 :                 }</span>
<span class="lineNum">      94 </span><span class="lineCov">     317429 :         } else {</span>
<span class="lineNum">      95 </span><span class="lineCov">    2596319 :                 gpointer *end = dest + count;</span>
<span class="lineNum">      96 </span><span class="lineCov">   37899416 :                 for (; dest &lt; end; ++src, ++dest) {</span>
<span class="lineNum">      97 </span><span class="lineCov">   16355053 :                         gpointer value = *src;</span>
<span class="lineNum">      98 </span><span class="lineCov">   16355053 :                         SGEN_UPDATE_REFERENCE_ALLOW_NULL (dest, value);</span>
<span class="lineNum">      99 </span><span class="lineCov">   16355053 :                         if (need_mod_union || sgen_ptr_in_nursery (value))</span>
<span class="lineNum">     100 </span><span class="lineCov">   16355469 :                                 sgen_card_table_mark_address ((mword)dest);</span>
<span class="lineNum">     101 </span><span class="lineCov">   16354298 :                         sgen_dummy_use (value);</span>
<span class="lineNum">     102 </span><span class="lineCov">   16354298 :                 }</span>
<span class="lineNum">     103 </span>            :         }       
<span class="lineNum">     104 </span><span class="lineCov">    2912698 : }</span>
<a name="105"><span class="lineNum">     105 </span>            : </a>
<span class="lineNum">     106 </span>            : static void
<span class="lineNum">     107 </span>            : sgen_card_table_wbarrier_value_copy (gpointer dest, gpointer src, int count, size_t element_size)
<span class="lineNum">     108 </span>            : {
<span class="lineNum">     109 </span><span class="lineCov">     244949 :         size_t size = count * element_size;</span>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineCov">     244949 :         TLAB_ACCESS_INIT;</span>
<span class="lineNum">     112 </span><span class="lineCov">     489911 :         ENTER_CRITICAL_REGION;</span>
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span><span class="lineCov">     244983 :         mono_gc_memmove_atomic (dest, src, size);</span>
<span class="lineNum">     115 </span><span class="lineCov">     244983 :         sgen_card_table_mark_range ((mword)dest, size);</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineCov">     979906 :         EXIT_CRITICAL_REGION;</span>
<span class="lineNum">     118 </span><span class="lineCov">     244976 : }</span>
<a name="119"><span class="lineNum">     119 </span>            : </a>
<span class="lineNum">     120 </span>            : static void
<span class="lineNum">     121 </span>            : sgen_card_table_wbarrier_object_copy (GCObject* obj, GCObject *src)
<span class="lineNum">     122 </span>            : {
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :         size_t size = sgen_client_par_object_get_size (SGEN_LOAD_VTABLE_UNCHECKED (obj), obj);</span>
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :         TLAB_ACCESS_INIT;</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :         ENTER_CRITICAL_REGION;</span>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :         mono_gc_memmove_aligned ((char*)obj + SGEN_CLIENT_OBJECT_HEADER_SIZE, (char*)src + SGEN_CLIENT_OBJECT_HEADER_SIZE,</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                         size - SGEN_CLIENT_OBJECT_HEADER_SIZE);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         sgen_card_table_mark_range ((mword)obj, size);</span>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :         EXIT_CRITICAL_REGION;</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 : }</span>
<a name="134"><span class="lineNum">     134 </span>            : </a>
<span class="lineNum">     135 </span>            : static void
<span class="lineNum">     136 </span>            : sgen_card_table_wbarrier_generic_nostore (gpointer ptr)
<span class="lineNum">     137 </span>            : {
<span class="lineNum">     138 </span><span class="lineCov">  642710309 :         sgen_card_table_mark_address ((mword)ptr);      </span>
<span class="lineNum">     139 </span><span class="lineCov">  642710309 : }</span>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span>            : guint8 *sgen_shadow_cardtable;
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            : #define SGEN_CARDTABLE_END (sgen_cardtable + CARD_COUNT_IN_BYTES)
<a name="146"><span class="lineNum">     146 </span>            : </a>
<span class="lineNum">     147 </span>            : static gboolean
<span class="lineNum">     148 </span>            : sgen_card_table_region_begin_scanning (mword start, mword size)
<span class="lineNum">     149 </span>            : {
<span class="lineNum">     150 </span><span class="lineCov">        766 :         mword end = start + size;</span>
<span class="lineNum">     151 </span>            :         /*XXX this can be improved to work on words and have a single loop induction var */
<span class="lineNum">     152 </span><span class="lineCov">      25980 :         while (start &lt; end) {</span>
<span class="lineNum">     153 </span><span class="lineCov">      12226 :                 if (sgen_card_table_card_begin_scanning (start))</span>
<span class="lineNum">     154 </span><span class="lineCov">          2 :                         return TRUE;</span>
<span class="lineNum">     155 </span><span class="lineCov">      12224 :                 start += CARD_SIZE_IN_BYTES;</span>
<span class="lineNum">     156 </span>            :         }
<span class="lineNum">     157 </span><span class="lineCov">        764 :         return FALSE;</span>
<span class="lineNum">     158 </span><span class="lineCov">        766 : }</span>
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span>            : #else
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span>            : static gboolean
<span class="lineNum">     163 </span>            : sgen_card_table_region_begin_scanning (mword start, mword size)
<span class="lineNum">     164 </span>            : {
<span class="lineNum">     165 </span>            :         gboolean res = FALSE;
<span class="lineNum">     166 </span>            :         guint8 *card = sgen_card_table_get_card_address (start);
<span class="lineNum">     167 </span>            :         guint8 *end = card + sgen_card_table_number_of_cards_in_range (start, size);
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            :         /*XXX this can be improved to work on words and have a branchless body */
<span class="lineNum">     170 </span>            :         while (card != end) {
<span class="lineNum">     171 </span>            :                 if (*card++) {
<span class="lineNum">     172 </span>            :                         res = TRUE;
<span class="lineNum">     173 </span>            :                         break;
<span class="lineNum">     174 </span>            :                 }
<span class="lineNum">     175 </span>            :         }
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            :         memset (sgen_card_table_get_card_address (start), 0, size &gt;&gt; CARD_BITS);
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span>            :         return res;
<span class="lineNum">     180 </span>            : }
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            : #endif
<span class="lineNum">     183 </span>            : 
<a name="184"><span class="lineNum">     184 </span>            : /*FIXME this assumes that major blocks are multiple of 4K which is pretty reasonable */</a>
<span class="lineNum">     185 </span>            : gboolean
<span class="lineNum">     186 </span>            : sgen_card_table_get_card_data (guint8 *data_dest, mword address, mword cards)
<span class="lineNum">     187 </span>            : {
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :         mword *start = (mword*)sgen_card_table_get_card_scan_address (address);</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         mword *dest = (mword*)data_dest;</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         mword *end = (mword*)(data_dest + cards);</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         mword mask = 0;</span>
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :         for (; dest &lt; end; ++dest, ++start) {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :                 mword v = *start;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                 *dest = v;</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                 mask |= v;</span>
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span>            : #ifndef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     199 </span>            :                 *start = 0;
<span class="lineNum">     200 </span>            : #endif
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         return mask != 0;</span>
<span class="lineNum">     204 </span>            : }
<a name="205"><span class="lineNum">     205 </span>            : </a>
<span class="lineNum">     206 </span>            : void*
<span class="lineNum">     207 </span>            : sgen_card_table_align_pointer (void *ptr)
<span class="lineNum">     208 </span>            : {
<span class="lineNum">     209 </span><span class="lineCov">   10620540 :         return (void*)((mword)ptr &amp; ~(CARD_SIZE_IN_BYTES - 1));</span>
<span class="lineNum">     210 </span>            : }
<a name="211"><span class="lineNum">     211 </span>            : </a>
<span class="lineNum">     212 </span>            : void
<span class="lineNum">     213 </span>            : sgen_card_table_mark_range (mword address, mword size)
<span class="lineNum">     214 </span>            : {
<span class="lineNum">     215 </span><span class="lineCov">     244974 :         mword num_cards = sgen_card_table_number_of_cards_in_range (address, size);</span>
<span class="lineNum">     216 </span><span class="lineCov">     244974 :         guint8 *start = sgen_card_table_get_card_address (address);</span>
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     219 </span>            :         /*
<span class="lineNum">     220 </span>            :          * FIXME: There's a theoretical bug here, namely that the card table is allocated so
<span class="lineNum">     221 </span>            :          * far toward the end of the address space that start + num_cards overflows.
<span class="lineNum">     222 </span>            :          */
<span class="lineNum">     223 </span><span class="lineCov">     244974 :         guint8 *end = start + num_cards;</span>
<span class="lineNum">     224 </span><span class="lineCov">     734916 :         SGEN_ASSERT (0, num_cards &lt;= CARD_COUNT_IN_BYTES, &quot;How did we get an object larger than the card table?&quot;);</span>
<span class="lineNum">     225 </span><span class="lineCov">     244973 :         if (end &gt; SGEN_CARDTABLE_END) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                 memset (start, 1, SGEN_CARDTABLE_END - start);</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                 memset (sgen_cardtable, 1, end - SGEN_CARDTABLE_END);</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     229 </span>            :         }
<span class="lineNum">     230 </span>            : #endif
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">     244972 :         memset (start, 1, num_cards);</span>
<span class="lineNum">     233 </span><span class="lineCov">     489945 : }</span>
<a name="234"><span class="lineNum">     234 </span>            : </a>
<span class="lineNum">     235 </span>            : static gboolean
<span class="lineNum">     236 </span>            : sgen_card_table_is_range_marked (guint8 *cards, mword address, mword size)
<span class="lineNum">     237 </span>            : {
<span class="lineNum">     238 </span><span class="lineCov">        232 :         guint8 *end = cards + sgen_card_table_number_of_cards_in_range (address, size);</span>
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span>            :         /*This is safe since this function is only called by code that only passes continuous card blocks*/
<span class="lineNum">     241 </span><span class="lineCov">        976 :         while (cards != end) {</span>
<span class="lineNum">     242 </span><span class="lineCov">        488 :                 if (*cards++)</span>
<span class="lineNum">     243 </span><span class="lineCov">        232 :                         return TRUE;</span>
<span class="lineNum">     244 </span>            :         }
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">        232 : }</span>
<a name="248"><span class="lineNum">     248 </span>            : </a>
<span class="lineNum">     249 </span>            : static void
<span class="lineNum">     250 </span>            : sgen_card_table_record_pointer (gpointer address)
<span class="lineNum">     251 </span>            : {
<span class="lineNum">     252 </span><span class="lineCov">   21184849 :         *sgen_card_table_get_card_address ((mword)address) = 1;</span>
<span class="lineNum">     253 </span><span class="lineCov">   21184849 : }</span>
<a name="254"><span class="lineNum">     254 </span>            : </a>
<span class="lineNum">     255 </span>            : static gboolean
<span class="lineNum">     256 </span>            : sgen_card_table_find_address (char *addr)
<span class="lineNum">     257 </span>            : {
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :         return sgen_card_table_address_is_marked ((mword)addr);</span>
<span class="lineNum">     259 </span>            : }
<a name="260"><span class="lineNum">     260 </span>            : </a>
<span class="lineNum">     261 </span>            : static gboolean
<span class="lineNum">     262 </span>            : sgen_card_table_find_address_with_cards (char *cards_start, guint8 *cards, char *addr)
<span class="lineNum">     263 </span>            : {
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         cards_start = (char *)sgen_card_table_align_pointer (cards_start);</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         return cards [(addr - cards_start) &gt;&gt; CARD_BITS];</span>
<span class="lineNum">     266 </span>            : }
<a name="267"><span class="lineNum">     267 </span>            : </a>
<span class="lineNum">     268 </span>            : static void
<span class="lineNum">     269 </span>            : update_mod_union (guint8 *dest, guint8 *start_card, size_t num_cards)
<span class="lineNum">     270 </span>            : {
<span class="lineNum">     271 </span>            :         int i;
<span class="lineNum">     272 </span>            :         /* Marking from another thread can happen while we mark here */
<span class="lineNum">     273 </span><span class="lineCov">   52108966 :         for (i = 0; i &lt; num_cards; ++i) {</span>
<span class="lineNum">     274 </span><span class="lineCov">   25621784 :                 if (start_card [i])</span>
<span class="lineNum">     275 </span><span class="lineCov">    3171151 :                         dest [i] = 1;</span>
<span class="lineNum">     276 </span><span class="lineCov">   25621784 :         }</span>
<span class="lineNum">     277 </span><span class="lineCov">     432699 : }</span>
<a name="278"><span class="lineNum">     278 </span>            : </a>
<span class="lineNum">     279 </span>            : guint8*
<span class="lineNum">     280 </span>            : sgen_card_table_alloc_mod_union (char *obj, mword obj_size)
<span class="lineNum">     281 </span>            : {
<span class="lineNum">     282 </span><span class="lineCov">      90567 :         size_t num_cards = sgen_card_table_number_of_cards_in_range ((mword) obj, obj_size);</span>
<span class="lineNum">     283 </span><span class="lineCov">      90567 :         guint8 *mod_union = (guint8 *)sgen_alloc_internal_dynamic (num_cards, INTERNAL_MEM_CARDTABLE_MOD_UNION, TRUE);</span>
<span class="lineNum">     284 </span><span class="lineCov">      90567 :         memset (mod_union, 0, num_cards);</span>
<span class="lineNum">     285 </span><span class="lineCov">      90567 :         return mod_union;</span>
<span class="lineNum">     286 </span>            : }
<a name="287"><span class="lineNum">     287 </span>            : </a>
<span class="lineNum">     288 </span>            : void
<span class="lineNum">     289 </span>            : sgen_card_table_free_mod_union (guint8 *mod_union, char *obj, mword obj_size)
<span class="lineNum">     290 </span>            : {
<span class="lineNum">     291 </span><span class="lineCov">      44777 :         size_t num_cards = sgen_card_table_number_of_cards_in_range ((mword) obj, obj_size);</span>
<span class="lineNum">     292 </span><span class="lineCov">      44777 :         sgen_free_internal_dynamic (mod_union, num_cards, INTERNAL_MEM_CARDTABLE_MOD_UNION);</span>
<span class="lineNum">     293 </span><span class="lineCov">      44777 : }</span>
<a name="294"><span class="lineNum">     294 </span>            : </a>
<span class="lineNum">     295 </span>            : void
<span class="lineNum">     296 </span>            : sgen_card_table_update_mod_union_from_cards (guint8 *dest, guint8 *start_card, size_t num_cards)
<span class="lineNum">     297 </span>            : {
<span class="lineNum">     298 </span><span class="lineCov">    1298097 :         SGEN_ASSERT (0, dest, &quot;Why don't we have a mod union?&quot;);</span>
<span class="lineNum">     299 </span><span class="lineCov">     432699 :         update_mod_union (dest, start_card, num_cards);</span>
<span class="lineNum">     300 </span><span class="lineCov">     432699 : }</span>
<a name="301"><span class="lineNum">     301 </span>            : </a>
<span class="lineNum">     302 </span>            : void
<span class="lineNum">     303 </span>            : sgen_card_table_update_mod_union (guint8 *dest, char *obj, mword obj_size, size_t *out_num_cards)
<span class="lineNum">     304 </span>            : {
<span class="lineNum">     305 </span><span class="lineCov">     432699 :         guint8 *start_card = sgen_card_table_get_card_address ((mword)obj);</span>
<span class="lineNum">     306 </span>            : #ifndef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     307 </span>            :         guint8 *end_card = sgen_card_table_get_card_address ((mword)obj + obj_size - 1) + 1;
<span class="lineNum">     308 </span>            : #endif
<span class="lineNum">     309 </span>            :         size_t num_cards;
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     312 </span>            :         size_t rest;
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">     432699 :         rest = num_cards = sgen_card_table_number_of_cards_in_range ((mword) obj, obj_size);</span>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span><span class="lineCov">     865398 :         while (start_card + rest &gt; SGEN_CARDTABLE_END) {</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :                 size_t count = SGEN_CARDTABLE_END - start_card;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :                 sgen_card_table_update_mod_union_from_cards (dest, start_card, count);</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                 dest += count;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :                 rest -= count;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :                 start_card = sgen_cardtable;</span>
<span class="lineNum">     322 </span>            :         }
<span class="lineNum">     323 </span><span class="lineCov">     432699 :         num_cards = rest;</span>
<span class="lineNum">     324 </span>            : #else
<span class="lineNum">     325 </span>            :         num_cards = end_card - start_card;
<span class="lineNum">     326 </span>            : #endif
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineCov">     432699 :         sgen_card_table_update_mod_union_from_cards (dest, start_card, num_cards);</span>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineCov">     432699 :         if (out_num_cards)</span>
<span class="lineNum">     331 </span><span class="lineCov">     330632 :                 *out_num_cards = num_cards;</span>
<span class="lineNum">     332 </span><span class="lineCov">     432699 : }</span>
<span class="lineNum">     333 </span>            : 
<a name="334"><span class="lineNum">     334 </span>            : /* Preclean cards and saves the cards that need to be scanned afterwards in cards_preclean */</a>
<span class="lineNum">     335 </span>            : void
<span class="lineNum">     336 </span>            : sgen_card_table_preclean_mod_union (guint8 *cards, guint8 *cards_preclean, size_t num_cards)
<span class="lineNum">     337 </span>            : {
<span class="lineNum">     338 </span>            :         size_t i;
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineCov">     208775 :         memcpy (cards_preclean, cards, num_cards);</span>
<span class="lineNum">     341 </span><span class="lineCov">   15611934 :         for (i = 0; i &lt; num_cards; i++) {</span>
<span class="lineNum">     342 </span><span class="lineCov">    7597192 :                 if (cards_preclean [i]) {</span>
<span class="lineNum">     343 </span><span class="lineCov">    1565761 :                         cards [i] = 0;</span>
<span class="lineNum">     344 </span><span class="lineCov">    1565761 :                 }</span>
<span class="lineNum">     345 </span><span class="lineCov">    7597192 :         }</span>
<span class="lineNum">     346 </span>            :         /*
<span class="lineNum">     347 </span>            :          * When precleaning we need to make sure the card cleaning
<span class="lineNum">     348 </span>            :          * takes place before the object is scanned. If we don't
<span class="lineNum">     349 </span>            :          * do this we could finish scanning the object and, before
<span class="lineNum">     350 </span>            :          * the cleaning of the card takes place, another thread
<span class="lineNum">     351 </span>            :          * could dirty the object, mark the mod_union card only for
<span class="lineNum">     352 </span>            :          * us to clean it back, without scanning the object again.
<span class="lineNum">     353 </span>            :          */
<span class="lineNum">     354 </span><span class="lineCov">     208775 :         mono_memory_barrier ();</span>
<span class="lineNum">     355 </span><span class="lineCov">     208775 : }</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<a name="358"><span class="lineNum">     358 </span>            : </a>
<span class="lineNum">     359 </span>            : static void
<span class="lineNum">     360 </span>            : move_cards_to_shadow_table (mword start, mword size)
<span class="lineNum">     361 </span>            : {
<span class="lineNum">     362 </span><span class="lineCov">   10592408 :         guint8 *from = sgen_card_table_get_card_address (start);</span>
<span class="lineNum">     363 </span><span class="lineCov">   10592408 :         guint8 *to = sgen_card_table_get_shadow_card_address (start);</span>
<span class="lineNum">     364 </span><span class="lineCov">   10592408 :         size_t bytes = sgen_card_table_number_of_cards_in_range (start, size);</span>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineCov">   10592408 :         if (bytes &gt;= CARD_COUNT_IN_BYTES) {</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :                 memcpy (sgen_shadow_cardtable, sgen_cardtable, CARD_COUNT_IN_BYTES);</span>
<span class="lineNum">     368 </span><span class="lineCov">   10592408 :         } else if (to + bytes &gt; SGEN_SHADOW_CARDTABLE_END) {</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                 size_t first_chunk = SGEN_SHADOW_CARDTABLE_END - to;</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                 size_t second_chunk = MIN (CARD_COUNT_IN_BYTES, bytes) - first_chunk;</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                 memcpy (to, from, first_chunk);</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                 memcpy (sgen_shadow_cardtable, sgen_cardtable, second_chunk);</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     375 </span><span class="lineCov">   10592408 :                 memcpy (to, from, bytes);</span>
<span class="lineNum">     376 </span>            :         }
<span class="lineNum">     377 </span><span class="lineCov">   10592408 : }</span>
<a name="378"><span class="lineNum">     378 </span>            : </a>
<span class="lineNum">     379 </span>            : static void
<span class="lineNum">     380 </span>            : clear_cards (mword start, mword size)
<span class="lineNum">     381 </span>            : {
<span class="lineNum">     382 </span><span class="lineCov">   14341632 :         guint8 *addr = sgen_card_table_get_card_address (start);</span>
<span class="lineNum">     383 </span><span class="lineCov">   14341632 :         size_t bytes = sgen_card_table_number_of_cards_in_range (start, size);</span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span><span class="lineCov">   14341632 :         if (bytes &gt;= CARD_COUNT_IN_BYTES) {</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :                 memset (sgen_cardtable, 0, CARD_COUNT_IN_BYTES);</span>
<span class="lineNum">     387 </span><span class="lineCov">   14341632 :         } else if (addr + bytes &gt; SGEN_CARDTABLE_END) {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                 size_t first_chunk = SGEN_CARDTABLE_END - addr;</span>
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                 memset (addr, 0, first_chunk);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                 memset (sgen_cardtable, 0, bytes - first_chunk);</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     393 </span><span class="lineCov">   14341632 :                 memset (addr, 0, bytes);</span>
<span class="lineNum">     394 </span>            :         }
<span class="lineNum">     395 </span><span class="lineCov">   14341632 : }</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            : #else
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            : static void
<span class="lineNum">     401 </span>            : clear_cards (mword start, mword size)
<span class="lineNum">     402 </span>            : {
<span class="lineNum">     403 </span>            :         memset (sgen_card_table_get_card_address (start), 0, sgen_card_table_number_of_cards_in_range (start, size));
<span class="lineNum">     404 </span>            : }
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            : #endif
<a name="408"><span class="lineNum">     408 </span>            : </a>
<span class="lineNum">     409 </span>            : static void
<span class="lineNum">     410 </span>            : sgen_card_table_clear_cards (void)
<span class="lineNum">     411 </span>            : {
<span class="lineNum">     412 </span>            :         /*XXX we could do this in 2 ways. using mincore or iterating over all sections/los objects */
<span class="lineNum">     413 </span><span class="lineCov">     189716 :         sgen_major_collector_iterate_block_ranges (clear_cards);</span>
<span class="lineNum">     414 </span><span class="lineCov">     189716 :         sgen_los_iterate_live_block_ranges (clear_cards);</span>
<span class="lineNum">     415 </span><span class="lineCov">     189716 : }</span>
<a name="416"><span class="lineNum">     416 </span>            : </a>
<span class="lineNum">     417 </span>            : static void
<span class="lineNum">     418 </span>            : sgen_card_table_finish_minor_collection (void)
<span class="lineNum">     419 </span>            : {
<span class="lineNum">     420 </span><span class="lineCov">       9946 :         sgen_card_tables_collect_stats (FALSE);</span>
<span class="lineNum">     421 </span><span class="lineCov">       9946 : }</span>
<a name="422"><span class="lineNum">     422 </span>            : </a>
<span class="lineNum">     423 </span>            : static void
<span class="lineNum">     424 </span>            : sgen_card_table_scan_remsets (ScanCopyContext ctx)
<span class="lineNum">     425 </span>            : {
<span class="lineNum">     426 </span>            :         SGEN_TV_DECLARE (atv);
<span class="lineNum">     427 </span>            :         SGEN_TV_DECLARE (btv);
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineCov">       9946 :         sgen_card_tables_collect_stats (TRUE);</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     432 </span>            :         /*FIXME we should have a bit on each block/los object telling if the object have marked cards.*/
<span class="lineNum">     433 </span>            :         /*First we copy*/
<span class="lineNum">     434 </span><span class="lineCov">       9946 :         sgen_major_collector_iterate_block_ranges (move_cards_to_shadow_table);</span>
<span class="lineNum">     435 </span><span class="lineCov">       9946 :         sgen_los_iterate_live_block_ranges (move_cards_to_shadow_table);</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span>            :         /*Then we clear*/
<span class="lineNum">     438 </span><span class="lineCov">       9946 :         sgen_card_table_clear_cards ();</span>
<span class="lineNum">     439 </span>            : #endif
<span class="lineNum">     440 </span><span class="lineCov">       9946 :         SGEN_TV_GETTIME (atv);</span>
<span class="lineNum">     441 </span><span class="lineCov">       9946 :         sgen_get_major_collector ()-&gt;scan_card_table (CARDTABLE_SCAN_GLOBAL, ctx);</span>
<span class="lineNum">     442 </span><span class="lineCov">       9946 :         SGEN_TV_GETTIME (btv);</span>
<span class="lineNum">     443 </span><span class="lineCov">       9946 :         last_major_scan_time = SGEN_TV_ELAPSED (atv, btv); </span>
<span class="lineNum">     444 </span><span class="lineCov">       9946 :         major_card_scan_time += last_major_scan_time;</span>
<span class="lineNum">     445 </span><span class="lineCov">       9946 :         sgen_los_scan_card_table (CARDTABLE_SCAN_GLOBAL, ctx);</span>
<span class="lineNum">     446 </span><span class="lineCov">       9946 :         SGEN_TV_GETTIME (atv);</span>
<span class="lineNum">     447 </span><span class="lineCov">       9946 :         last_los_scan_time = SGEN_TV_ELAPSED (btv, atv);</span>
<span class="lineNum">     448 </span><span class="lineCov">       9946 :         los_card_scan_time += last_los_scan_time;</span>
<span class="lineNum">     449 </span><span class="lineCov">       9946 : }</span>
<a name="450"><span class="lineNum">     450 </span>            : </a>
<span class="lineNum">     451 </span>            : guint8*
<span class="lineNum">     452 </span>            : sgen_get_card_table_configuration (int *shift_bits, gpointer *mask)
<span class="lineNum">     453 </span>            : {
<span class="lineNum">     454 </span>            : #ifndef MANAGED_WBARRIER
<span class="lineNum">     455 </span>            :         return NULL;
<span class="lineNum">     456 </span>            : #else
<span class="lineNum">     457 </span><span class="lineCov">   16343201 :         if (!sgen_cardtable)</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineCov">   16343521 :         *shift_bits = CARD_BITS;</span>
<span class="lineNum">     461 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     462 </span><span class="lineCov">   16343521 :         *mask = (gpointer)CARD_MASK;</span>
<span class="lineNum">     463 </span>            : #else
<span class="lineNum">     464 </span>            :         *mask = NULL;
<span class="lineNum">     465 </span>            : #endif
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineCov">   16343521 :         return sgen_cardtable;</span>
<span class="lineNum">     468 </span>            : #endif
<span class="lineNum">     469 </span><span class="lineCov">   16343735 : }</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span>            : #if 0
<span class="lineNum">     472 </span>            : void
<span class="lineNum">     473 </span>            : sgen_card_table_dump_obj_card (GCObject *object, size_t size, void *dummy)
<span class="lineNum">     474 </span>            : {
<span class="lineNum">     475 </span>            :         guint8 *start = sgen_card_table_get_card_scan_address (object);
<span class="lineNum">     476 </span>            :         guint8 *end = start + sgen_card_table_number_of_cards_in_range (object, size);
<span class="lineNum">     477 </span>            :         int cnt = 0;
<span class="lineNum">     478 </span>            :         printf (&quot;--obj %p %d cards [%p %p]--&quot;, object, size, start, end);
<span class="lineNum">     479 </span>            :         for (; start &lt; end; ++start) {
<span class="lineNum">     480 </span>            :                 if (cnt == 0)
<span class="lineNum">     481 </span>            :                         printf (&quot;\n\t[%p] &quot;, start);
<span class="lineNum">     482 </span>            :                 printf (&quot;%x &quot;, *start);
<span class="lineNum">     483 </span>            :                 ++cnt;
<span class="lineNum">     484 </span>            :                 if (cnt == 8)
<span class="lineNum">     485 </span>            :                         cnt = 0;
<span class="lineNum">     486 </span>            :         }
<span class="lineNum">     487 </span>            :         printf (&quot;\n&quot;);
<span class="lineNum">     488 </span>            : }
<span class="lineNum">     489 </span>            : #endif
<a name="490"><span class="lineNum">     490 </span>            : </a>
<span class="lineNum">     491 </span>            : void
<span class="lineNum">     492 </span>            : sgen_cardtable_scan_object (GCObject *obj, mword block_obj_size, guint8 *cards, ScanCopyContext ctx)
<span class="lineNum">     493 </span>            : {
<span class="lineNum">     494 </span>            :         HEAVY_STAT (++large_objects);
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineCov">     615931 :         if (sgen_client_cardtable_scan_object (obj, block_obj_size, cards, ctx))</span>
<span class="lineNum">     497 </span><span class="lineCov">     614933 :                 return;</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span>            :         HEAVY_STAT (++bloby_objects);
<span class="lineNum">     500 </span><span class="lineCov">        998 :         if (cards) {</span>
<span class="lineNum">     501 </span><span class="lineCov">        232 :                 if (sgen_card_table_is_range_marked (cards, (mword)obj, block_obj_size))</span>
<span class="lineNum">     502 </span><span class="lineCov">        232 :                         ctx.ops-&gt;scan_object (obj, sgen_obj_get_descriptor (obj), ctx.queue);</span>
<span class="lineNum">     503 </span><span class="lineCov">        998 :         } else if (sgen_card_table_region_begin_scanning ((mword)obj, block_obj_size)) {</span>
<span class="lineNum">     504 </span><span class="lineCov">          2 :                 ctx.ops-&gt;scan_object (obj, sgen_obj_get_descriptor (obj), ctx.queue);</span>
<span class="lineNum">     505 </span><span class="lineCov">          2 :         }</span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineCov">        998 :         binary_protocol_card_scan (obj, sgen_safe_object_get_size (obj));</span>
<span class="lineNum">     508 </span><span class="lineCov">     616929 : }</span>
<span class="lineNum">     509 </span>            : 
<span class="lineNum">     510 </span>            : #ifdef CARDTABLE_STATS
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            : typedef struct {
<span class="lineNum">     513 </span>            :         int total, marked, remarked, gc_marked; 
<span class="lineNum">     514 </span>            : } card_stats;
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span>            : static card_stats major_stats, los_stats;
<span class="lineNum">     517 </span>            : static card_stats *cur_stats;
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span>            : static void
<span class="lineNum">     520 </span>            : count_marked_cards (mword start, mword size)
<span class="lineNum">     521 </span>            : {
<span class="lineNum">     522 </span>            :         mword end = start + size;
<span class="lineNum">     523 </span>            :         while (start &lt;= end) {
<span class="lineNum">     524 </span>            :                 guint8 card = *sgen_card_table_get_card_address (start);
<span class="lineNum">     525 </span>            :                 ++cur_stats-&gt;total;
<span class="lineNum">     526 </span>            :                 if (card)
<span class="lineNum">     527 </span>            :                         ++cur_stats-&gt;marked;
<span class="lineNum">     528 </span>            :                 if (card == 2)
<span class="lineNum">     529 </span>            :                         ++cur_stats-&gt;gc_marked;
<span class="lineNum">     530 </span>            :                 start += CARD_SIZE_IN_BYTES;
<span class="lineNum">     531 </span>            :         }
<span class="lineNum">     532 </span>            : }
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span>            : static void
<span class="lineNum">     535 </span>            : count_remarked_cards (mword start, mword size)
<span class="lineNum">     536 </span>            : {
<span class="lineNum">     537 </span>            :         mword end = start + size;
<span class="lineNum">     538 </span>            :         while (start &lt;= end) {
<span class="lineNum">     539 </span>            :                 if (sgen_card_table_address_is_marked (start)) {
<span class="lineNum">     540 </span>            :                         ++cur_stats-&gt;remarked;
<span class="lineNum">     541 </span>            :                         *sgen_card_table_get_card_address (start) = 2;
<span class="lineNum">     542 </span>            :                 }
<span class="lineNum">     543 </span>            :                 start += CARD_SIZE_IN_BYTES;
<span class="lineNum">     544 </span>            :         }
<span class="lineNum">     545 </span>            : }
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span>            : #endif
<a name="548"><span class="lineNum">     548 </span>            : </a>
<span class="lineNum">     549 </span>            : static void
<span class="lineNum">     550 </span>            : sgen_card_tables_collect_stats (gboolean begin)
<span class="lineNum">     551 </span>            : {
<span class="lineNum">     552 </span>            : #ifdef CARDTABLE_STATS
<span class="lineNum">     553 </span>            :         if (begin) {
<span class="lineNum">     554 </span>            :                 memset (&amp;major_stats, 0, sizeof (card_stats));
<span class="lineNum">     555 </span>            :                 memset (&amp;los_stats, 0, sizeof (card_stats));
<span class="lineNum">     556 </span>            :                 cur_stats = &amp;major_stats;
<span class="lineNum">     557 </span>            :                 sgen_major_collector_iterate_live_block_ranges (count_marked_cards);
<span class="lineNum">     558 </span>            :                 cur_stats = &amp;los_stats;
<span class="lineNum">     559 </span>            :                 sgen_los_iterate_live_block_ranges (count_marked_cards);
<span class="lineNum">     560 </span>            :         } else {
<span class="lineNum">     561 </span>            :                 cur_stats = &amp;major_stats;
<span class="lineNum">     562 </span>            :                 sgen_major_collector_iterate_live_block_ranges (count_remarked_cards);
<span class="lineNum">     563 </span>            :                 cur_stats = &amp;los_stats;
<span class="lineNum">     564 </span>            :                 sgen_los_iterate_live_block_ranges (count_remarked_cards);
<span class="lineNum">     565 </span>            :                 printf (&quot;cards major (t %d m %d g %d r %d)  los (t %d m %d g %d r %d) major_scan %.2fms los_scan %.2fms\n&quot;, 
<span class="lineNum">     566 </span>            :                         major_stats.total, major_stats.marked, major_stats.gc_marked, major_stats.remarked,
<span class="lineNum">     567 </span>            :                         los_stats.total, los_stats.marked, los_stats.gc_marked, los_stats.remarked,
<span class="lineNum">     568 </span>            :                         last_major_scan_time / 10000.0f, last_los_scan_time / 10000.0f);
<span class="lineNum">     569 </span>            :         }
<span class="lineNum">     570 </span>            : #endif
<span class="lineNum">     571 </span><span class="lineCov">      19892 : }</span>
<a name="572"><span class="lineNum">     572 </span>            : </a>
<span class="lineNum">     573 </span>            : void
<span class="lineNum">     574 </span>            : sgen_card_table_init (SgenRememberedSet *remset)
<span class="lineNum">     575 </span>            : {
<span class="lineNum">     576 </span><span class="lineCov">       3285 :         sgen_cardtable = (guint8 *)sgen_alloc_os_memory (CARD_COUNT_IN_BYTES, (SgenAllocFlags)(SGEN_ALLOC_INTERNAL | SGEN_ALLOC_ACTIVATE), &quot;card table&quot;, MONO_MEM_ACCOUNT_SGEN_CARD_TABLE);</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            : #ifdef SGEN_HAVE_OVERLAPPING_CARDS
<span class="lineNum">     579 </span><span class="lineCov">       3285 :         sgen_shadow_cardtable = (guint8 *)sgen_alloc_os_memory (CARD_COUNT_IN_BYTES, (SgenAllocFlags)(SGEN_ALLOC_INTERNAL | SGEN_ALLOC_ACTIVATE), &quot;shadow card table&quot;, MONO_MEM_ACCOUNT_SGEN_SHADOW_CARD_TABLE);</span>
<span class="lineNum">     580 </span>            : #endif
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            : #ifdef HEAVY_STATISTICS
<span class="lineNum">     583 </span>            :         mono_counters_register (&quot;marked cards&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG, &amp;marked_cards);
<span class="lineNum">     584 </span>            :         mono_counters_register (&quot;scanned cards&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG, &amp;scanned_cards);
<span class="lineNum">     585 </span>            :         mono_counters_register (&quot;remarked cards&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG, &amp;remarked_cards);
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :         mono_counters_register (&quot;cardtable scanned objects&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG, &amp;scanned_objects);
<span class="lineNum">     588 </span>            :         mono_counters_register (&quot;cardtable large objects&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG, &amp;large_objects);
<span class="lineNum">     589 </span>            :         mono_counters_register (&quot;cardtable bloby objects&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG, &amp;bloby_objects);
<span class="lineNum">     590 </span>            : #endif
<span class="lineNum">     591 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;cardtable major scan time&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG | MONO_COUNTER_TIME, &amp;major_card_scan_time);</span>
<span class="lineNum">     592 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;cardtable los scan time&quot;, MONO_COUNTER_GC | MONO_COUNTER_ULONG | MONO_COUNTER_TIME, &amp;los_card_scan_time);</span>
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineCov">       3285 :         remset-&gt;wbarrier_set_field = sgen_card_table_wbarrier_set_field;</span>
<span class="lineNum">     596 </span><span class="lineCov">       3285 :         remset-&gt;wbarrier_arrayref_copy = sgen_card_table_wbarrier_arrayref_copy;</span>
<span class="lineNum">     597 </span><span class="lineCov">       3285 :         remset-&gt;wbarrier_value_copy = sgen_card_table_wbarrier_value_copy;</span>
<span class="lineNum">     598 </span><span class="lineCov">       3285 :         remset-&gt;wbarrier_object_copy = sgen_card_table_wbarrier_object_copy;</span>
<span class="lineNum">     599 </span><span class="lineCov">       3285 :         remset-&gt;wbarrier_generic_nostore = sgen_card_table_wbarrier_generic_nostore;</span>
<span class="lineNum">     600 </span><span class="lineCov">       3285 :         remset-&gt;record_pointer = sgen_card_table_record_pointer;</span>
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span><span class="lineCov">       3285 :         remset-&gt;scan_remsets = sgen_card_table_scan_remsets;</span>
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span><span class="lineCov">       3285 :         remset-&gt;finish_minor_collection = sgen_card_table_finish_minor_collection;</span>
<span class="lineNum">     605 </span><span class="lineCov">       3285 :         remset-&gt;clear_cards = sgen_card_table_clear_cards;</span>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">       3285 :         remset-&gt;find_address = sgen_card_table_find_address;</span>
<span class="lineNum">     608 </span><span class="lineCov">       3285 :         remset-&gt;find_address_with_cards = sgen_card_table_find_address_with_cards;</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineCov">       3285 :         need_mod_union = sgen_get_major_collector ()-&gt;is_concurrent;</span>
<span class="lineNum">     611 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span>            : #endif /*HAVE_SGEN_GC*/
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
