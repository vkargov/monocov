<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - metadata/object.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">metadata</a> - object.c<span style="font-size: 80%;"> (source / <a href="object.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2176</td>
            <td class="headerCovTableEntry">3082</td>
            <td class="headerCovTableEntryLo">70.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">169</td>
            <td class="headerCovTableEntry">242</td>
            <td class="headerCovTableEntryLo">69.8 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * object.c: Object creation for the Mono runtime
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Author:
<span class="lineNum">       5 </span>            :  *   Miguel de Icaza (miguel@ximian.com)
<span class="lineNum">       6 </span>            :  *   Paolo Molaro (lupus@ximian.com)
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  * Copyright 2001-2003 Ximian, Inc (http://www.ximian.com)
<span class="lineNum">       9 </span>            :  * Copyright 2004-2011 Novell, Inc (http://www.novell.com)
<span class="lineNum">      10 </span>            :  * Copyright 2001 Xamarin Inc (http://www.xamarin.com)
<span class="lineNum">      11 </span>            :  * Licensed under the MIT license. See LICENSE file in the project root for full license information.
<span class="lineNum">      12 </span>            :  */
<span class="lineNum">      13 </span>            : #include &lt;config.h&gt;
<span class="lineNum">      14 </span>            : #ifdef HAVE_ALLOCA_H
<span class="lineNum">      15 </span>            : #include &lt;alloca.h&gt;
<span class="lineNum">      16 </span>            : #endif
<span class="lineNum">      17 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      18 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      19 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      20 </span>            : #include &lt;mono/metadata/mono-endian.h&gt;
<span class="lineNum">      21 </span>            : #include &lt;mono/metadata/tabledefs.h&gt;
<span class="lineNum">      22 </span>            : #include &lt;mono/metadata/tokentype.h&gt;
<span class="lineNum">      23 </span>            : #include &lt;mono/metadata/loader.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;mono/metadata/object.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;mono/metadata/gc-internals.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;mono/metadata/exception.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;mono/metadata/exception-internals.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;mono/metadata/domain-internals.h&gt;
<span class="lineNum">      29 </span>            : #include &quot;mono/metadata/metadata-internals.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;mono/metadata/class-internals.h&quot;
<span class="lineNum">      31 </span>            : #include &lt;mono/metadata/assembly.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;mono/metadata/marshal.h&gt;
<span class="lineNum">      33 </span>            : #include &quot;mono/metadata/debug-helpers.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mono/metadata/marshal.h&quot;
<span class="lineNum">      35 </span>            : #include &lt;mono/metadata/threads.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;mono/metadata/threads-types.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;mono/metadata/environment.h&gt;
<span class="lineNum">      38 </span>            : #include &quot;mono/metadata/profiler-private.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;mono/metadata/security-manager.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;mono/metadata/mono-debug-debugger.h&quot;
<span class="lineNum">      41 </span>            : #include &lt;mono/metadata/gc-internals.h&gt;
<span class="lineNum">      42 </span>            : #include &lt;mono/metadata/verify-internals.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;mono/metadata/reflection-internals.h&gt;
<span class="lineNum">      44 </span>            : #include &lt;mono/metadata/w32event.h&gt;
<span class="lineNum">      45 </span>            : #include &lt;mono/utils/strenc.h&gt;
<span class="lineNum">      46 </span>            : #include &lt;mono/utils/mono-counters.h&gt;
<span class="lineNum">      47 </span>            : #include &lt;mono/utils/mono-error-internals.h&gt;
<span class="lineNum">      48 </span>            : #include &lt;mono/utils/mono-memory-model.h&gt;
<span class="lineNum">      49 </span>            : #include &lt;mono/utils/checked-build.h&gt;
<span class="lineNum">      50 </span>            : #include &lt;mono/utils/mono-threads.h&gt;
<span class="lineNum">      51 </span>            : #include &lt;mono/utils/mono-threads-coop.h&gt;
<span class="lineNum">      52 </span>            : #include &quot;cominterop.h&quot;
<span class="lineNum">      53 </span>            : #include &lt;mono/io-layer/io-layer.h&gt;
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : static void
<span class="lineNum">      56 </span>            : get_default_field_value (MonoDomain* domain, MonoClassField *field, void *value, MonoError *error);
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            : static MonoString*
<span class="lineNum">      59 </span>            : mono_ldstr_metadata_sig (MonoDomain *domain, const char* sig, MonoError *error);
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : static void
<span class="lineNum">      62 </span>            : free_main_args (void);
<span class="lineNum">      63 </span>            : 
<span class="lineNum">      64 </span>            : static char *
<span class="lineNum">      65 </span>            : mono_string_to_utf8_internal (MonoMemPool *mp, MonoImage *image, MonoString *s, gboolean ignore_error, MonoError *error);
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            : static MonoMethod*
<span class="lineNum">      68 </span>            : class_get_virtual_method (MonoClass *klass, MonoMethod *method, gboolean is_proxy, MonoError *error);
<a name="69"><span class="lineNum">      69 </span>            : </a>
<a name="70"><span class="lineNum">      70 </span>            : /* Class lazy loading functions */</a>
<a name="71"><span class="lineNum">      71 </span><span class="lineCov">         10 : static GENERATE_GET_CLASS_WITH_CACHE (pointer, System.Reflection, Pointer)</span></a>
<a name="72"><span class="lineNum">      72 </span><span class="lineCov">          5 : static GENERATE_GET_CLASS_WITH_CACHE (remoting_services, System.Runtime.Remoting, RemotingServices)</span></a>
<a name="73"><span class="lineNum">      73 </span><span class="lineCov">         45 : static GENERATE_GET_CLASS_WITH_CACHE (unhandled_exception_event_args, System, UnhandledExceptionEventArgs)</span></a>
<span class="lineNum">      74 </span><span class="lineCov">        930 : static GENERATE_GET_CLASS_WITH_CACHE (sta_thread_attribute, System, STAThreadAttribute)</span>
<span class="lineNum">      75 </span><span class="lineCov">         33 : static GENERATE_GET_CLASS_WITH_CACHE (activation_services, System.Runtime.Remoting.Activation, ActivationServices)</span>
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : #define ldstr_lock() mono_os_mutex_lock (&amp;ldstr_section)
<span class="lineNum">      79 </span>            : #define ldstr_unlock() mono_os_mutex_unlock (&amp;ldstr_section)
<span class="lineNum">      80 </span>            : static mono_mutex_t ldstr_section;
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            : /**
<span class="lineNum">      84 </span>            :  * mono_runtime_object_init:
<span class="lineNum">      85 </span>            :  * @this_obj: the object to initialize
<span class="lineNum">      86 </span>            :  *
<span class="lineNum">      87 </span>            :  * This function calls the zero-argument constructor (which must
<span class="lineNum">      88 </span>            :  * exist) for the given object.
<a name="89"><span class="lineNum">      89 </span>            :  */</a>
<span class="lineNum">      90 </span>            : void
<span class="lineNum">      91 </span>            : mono_runtime_object_init (MonoObject *this_obj)
<span class="lineNum">      92 </span>            : {
<span class="lineNum">      93 </span>            :         MonoError error;
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :         mono_runtime_object_init_checked (this_obj, &amp;error);</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            : /**
<span class="lineNum">      99 </span>            :  * mono_runtime_object_init_checked:
<span class="lineNum">     100 </span>            :  * @this_obj: the object to initialize
<span class="lineNum">     101 </span>            :  * @error: set on error.
<span class="lineNum">     102 </span>            :  *
<span class="lineNum">     103 </span>            :  * This function calls the zero-argument constructor (which must
<span class="lineNum">     104 </span>            :  * exist) for the given object and returns TRUE on success, or FALSE
<span class="lineNum">     105 </span>            :  * on error and sets @error.
<a name="106"><span class="lineNum">     106 </span>            :  */</a>
<span class="lineNum">     107 </span>            : gboolean
<span class="lineNum">     108 </span>            : mono_runtime_object_init_checked (MonoObject *this_obj, MonoError *error)
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineCov">     170779 :         MonoMethod *method = NULL;</span>
<span class="lineNum">     113 </span><span class="lineCov">     170779 :         MonoClass *klass = this_obj-&gt;vtable-&gt;klass;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineCov">     170779 :         mono_error_init (error);</span>
<span class="lineNum">     116 </span><span class="lineCov">     170779 :         method = mono_class_get_method_from_name (klass, &quot;.ctor&quot;, 0);</span>
<span class="lineNum">     117 </span><span class="lineCov">     170779 :         if (!method)</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :                 g_error (&quot;Could not lookup zero argument constructor for class %s&quot;, mono_type_get_full_name (klass));</span>
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span><span class="lineCov">     170779 :         if (method-&gt;klass-&gt;valuetype)</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                 this_obj = (MonoObject *)mono_object_unbox (this_obj);</span>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">     170779 :         mono_runtime_invoke_checked (method, this_obj, NULL, error);</span>
<span class="lineNum">     124 </span><span class="lineCov">     170779 :         return is_ok (error);</span>
<span class="lineNum">     125 </span>            : }
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span>            : /* The pseudo algorithm for type initialization from the spec
<span class="lineNum">     128 </span>            : Note it doesn't say anything about domains - only threads.
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span>            : 2. If the type is initialized you are done.
<span class="lineNum">     131 </span>            : 2.1. If the type is not yet initialized, try to take an 
<span class="lineNum">     132 </span>            :      initialization lock.  
<span class="lineNum">     133 </span>            : 2.2. If successful, record this thread as responsible for 
<span class="lineNum">     134 </span>            :      initializing the type and proceed to step 2.3.
<span class="lineNum">     135 </span>            : 2.2.1. If not, see whether this thread or any thread 
<span class="lineNum">     136 </span>            :      waiting for this thread to complete already holds the lock.
<span class="lineNum">     137 </span>            : 2.2.2. If so, return since blocking would create a deadlock.  This thread 
<span class="lineNum">     138 </span>            :      will now see an incompletely initialized state for the type, 
<span class="lineNum">     139 </span>            :      but no deadlock will arise.
<span class="lineNum">     140 </span>            : 2.2.3  If not, block until the type is initialized then return.
<span class="lineNum">     141 </span>            : 2.3 Initialize the parent type and then all interfaces implemented 
<span class="lineNum">     142 </span>            :     by this type.
<span class="lineNum">     143 </span>            : 2.4 Execute the type initialization code for this type.
<span class="lineNum">     144 </span>            : 2.5 Mark the type as initialized, release the initialization lock, 
<span class="lineNum">     145 </span>            :     awaken any threads waiting for this type to be initialized, 
<span class="lineNum">     146 </span>            :     and return.
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : */
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span>            : typedef struct
<span class="lineNum">     151 </span>            : {
<span class="lineNum">     152 </span>            :         MonoNativeThreadId initializing_tid;
<span class="lineNum">     153 </span>            :         guint32 waiting_count;
<span class="lineNum">     154 </span>            :         gboolean done;
<span class="lineNum">     155 </span>            :         MonoCoopMutex initialization_section;
<span class="lineNum">     156 </span>            : } TypeInitializationLock;
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span>            : /* for locking access to type_initialization_hash and blocked_thread_hash */
<span class="lineNum">     159 </span>            : static MonoCoopMutex type_initialization_section;
<a name="160"><span class="lineNum">     160 </span>            : </a>
<span class="lineNum">     161 </span>            : static inline void
<span class="lineNum">     162 </span>            : mono_type_initialization_lock (void)
<span class="lineNum">     163 </span>            : {
<span class="lineNum">     164 </span>            :         /* The critical sections protected by this lock in mono_runtime_class_init_full () can block */
<span class="lineNum">     165 </span><span class="lineCov">    7420168 :         mono_coop_mutex_lock (&amp;type_initialization_section);</span>
<span class="lineNum">     166 </span><span class="lineCov">    7420168 : }</span>
<a name="167"><span class="lineNum">     167 </span>            : </a>
<span class="lineNum">     168 </span>            : static inline void
<span class="lineNum">     169 </span>            : mono_type_initialization_unlock (void)
<span class="lineNum">     170 </span>            : {
<span class="lineNum">     171 </span><span class="lineCov">    7420314 :         mono_coop_mutex_unlock (&amp;type_initialization_section);</span>
<span class="lineNum">     172 </span><span class="lineCov">    7420314 : }</span>
<a name="173"><span class="lineNum">     173 </span>            : </a>
<span class="lineNum">     174 </span>            : static void
<span class="lineNum">     175 </span>            : mono_type_init_lock (TypeInitializationLock *lock)
<span class="lineNum">     176 </span>            : {
<span class="lineNum">     177 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineCov">    1117512 :         mono_coop_mutex_lock (&amp;lock-&gt;initialization_section);</span>
<span class="lineNum">     180 </span><span class="lineCov">    1117512 : }</span>
<a name="181"><span class="lineNum">     181 </span>            : </a>
<span class="lineNum">     182 </span>            : static void
<span class="lineNum">     183 </span>            : mono_type_init_unlock (TypeInitializationLock *lock)
<span class="lineNum">     184 </span>            : {
<span class="lineNum">     185 </span><span class="lineCov">    1117510 :         mono_coop_mutex_unlock (&amp;lock-&gt;initialization_section);</span>
<span class="lineNum">     186 </span><span class="lineCov">    1117510 : }</span>
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span>            : /* from vtable to lock */
<span class="lineNum">     189 </span>            : static GHashTable *type_initialization_hash;
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span>            : /* from thread id to thread id being waited on */
<span class="lineNum">     192 </span>            : static GHashTable *blocked_thread_hash;
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : /* Main thread */
<span class="lineNum">     195 </span>            : static MonoThread *main_thread;
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span>            : /* Functions supplied by the runtime */
<span class="lineNum">     198 </span>            : static MonoRuntimeCallbacks callbacks;
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            : /**
<span class="lineNum">     201 </span>            :  * mono_thread_set_main:
<span class="lineNum">     202 </span>            :  * @thread: thread to set as the main thread
<span class="lineNum">     203 </span>            :  *
<span class="lineNum">     204 </span>            :  * This function can be used to instruct the runtime to treat @thread
<span class="lineNum">     205 </span>            :  * as the main thread, ie, the thread that would normally execute the Main()
<span class="lineNum">     206 </span>            :  * method. This basically means that at the end of @thread, the runtime will
<span class="lineNum">     207 </span>            :  * wait for the existing foreground threads to quit and other such details.
<a name="208"><span class="lineNum">     208 </span>            :  */</a>
<span class="lineNum">     209 </span>            : void
<span class="lineNum">     210 </span>            : mono_thread_set_main (MonoThread *thread)
<span class="lineNum">     211 </span>            : {
<span class="lineNum">     212 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span>            :         static gboolean registered = FALSE;
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span><span class="lineCov">       3274 :         if (!registered) {</span>
<span class="lineNum">     217 </span><span class="lineCov">      13096 :                 MONO_GC_REGISTER_ROOT_SINGLE (main_thread, MONO_ROOT_SOURCE_THREADING, &quot;main thread object&quot;);</span>
<span class="lineNum">     218 </span><span class="lineCov">       3274 :                 registered = TRUE;</span>
<span class="lineNum">     219 </span><span class="lineCov">       3274 :         }</span>
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span><span class="lineCov">       3274 :         main_thread = thread;</span>
<span class="lineNum">     222 </span><span class="lineCov">       3274 : }</span>
<a name="223"><span class="lineNum">     223 </span>            : </a>
<span class="lineNum">     224 </span>            : MonoThread*
<span class="lineNum">     225 </span>            : mono_thread_get_main (void)
<span class="lineNum">     226 </span>            : {
<span class="lineNum">     227 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineCov">        870 :         return main_thread;</span>
<span class="lineNum">     230 </span>            : }
<a name="231"><span class="lineNum">     231 </span>            : </a>
<span class="lineNum">     232 </span>            : void
<span class="lineNum">     233 </span>            : mono_type_initialization_init (void)
<span class="lineNum">     234 </span>            : {
<span class="lineNum">     235 </span><span class="lineCov">       3285 :         mono_coop_mutex_init_recursive (&amp;type_initialization_section);</span>
<span class="lineNum">     236 </span><span class="lineCov">       3285 :         type_initialization_hash = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">     237 </span><span class="lineCov">       3285 :         blocked_thread_hash = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">     238 </span><span class="lineCov">       3285 :         mono_os_mutex_init_recursive (&amp;ldstr_section);</span>
<span class="lineNum">     239 </span><span class="lineCov">       3285 : }</span>
<a name="240"><span class="lineNum">     240 </span>            : </a>
<span class="lineNum">     241 </span>            : void
<span class="lineNum">     242 </span>            : mono_type_initialization_cleanup (void)
<span class="lineNum">     243 </span>            : {
<span class="lineNum">     244 </span>            : #if 0
<span class="lineNum">     245 </span>            :         /* This is causing race conditions with
<span class="lineNum">     246 </span>            :          * mono_release_type_locks
<span class="lineNum">     247 </span>            :          */
<span class="lineNum">     248 </span>            :         mono_coop_mutex_destroy (&amp;type_initialization_section);
<span class="lineNum">     249 </span>            :         g_hash_table_destroy (type_initialization_hash);
<span class="lineNum">     250 </span>            :         type_initialization_hash = NULL;
<span class="lineNum">     251 </span>            : #endif
<span class="lineNum">     252 </span><span class="lineCov">       3272 :         mono_os_mutex_destroy (&amp;ldstr_section);</span>
<span class="lineNum">     253 </span><span class="lineCov">       3272 :         g_hash_table_destroy (blocked_thread_hash);</span>
<span class="lineNum">     254 </span><span class="lineCov">       3272 :         blocked_thread_hash = NULL;</span>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">       3272 :         free_main_args ();</span>
<span class="lineNum">     257 </span><span class="lineCov">       3272 : }</span>
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span>            : /**
<span class="lineNum">     260 </span>            :  * get_type_init_exception_for_vtable:
<span class="lineNum">     261 </span>            :  *
<span class="lineNum">     262 </span>            :  *   Return the stored type initialization exception for VTABLE.
<a name="263"><span class="lineNum">     263 </span>            :  */</a>
<span class="lineNum">     264 </span>            : static MonoException*
<span class="lineNum">     265 </span>            : get_type_init_exception_for_vtable (MonoVTable *vtable)
<span class="lineNum">     266 </span>            : {
<span class="lineNum">     267 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            :         MonoError error;
<span class="lineNum">     270 </span><span class="lineCov">        115 :         MonoDomain *domain = vtable-&gt;domain;</span>
<span class="lineNum">     271 </span><span class="lineCov">        115 :         MonoClass *klass = vtable-&gt;klass;</span>
<span class="lineNum">     272 </span>            :         MonoException *ex;
<span class="lineNum">     273 </span>            :         gchar *full_name;
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineCov">        115 :         if (!vtable-&gt;init_failed)</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :                 g_error (&quot;Trying to get the init exception for a non-failed vtable of class %s&quot;, mono_type_get_full_name (klass));</span>
<span class="lineNum">     277 </span>            :         
<span class="lineNum">     278 </span>            :         /* 
<span class="lineNum">     279 </span>            :          * If the initializing thread was rudely aborted, the exception is not stored
<span class="lineNum">     280 </span>            :          * in the hash.
<span class="lineNum">     281 </span>            :          */
<span class="lineNum">     282 </span><span class="lineCov">        115 :         ex = NULL;</span>
<span class="lineNum">     283 </span><span class="lineCov">        115 :         mono_domain_lock (domain);</span>
<span class="lineNum">     284 </span><span class="lineCov">        115 :         if (domain-&gt;type_init_exception_hash)</span>
<span class="lineNum">     285 </span><span class="lineCov">        115 :                 ex = (MonoException *)mono_g_hash_table_lookup (domain-&gt;type_init_exception_hash, klass);</span>
<span class="lineNum">     286 </span><span class="lineCov">        115 :         mono_domain_unlock (domain);</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineCov">        115 :         if (!ex) {</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :                 if (klass-&gt;name_space &amp;&amp; *klass-&gt;name_space)</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :                         full_name = g_strdup_printf (&quot;%s.%s&quot;, klass-&gt;name_space, klass-&gt;name);</span>
<span class="lineNum">     291 </span>            :                 else
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :                         full_name = g_strdup (klass-&gt;name);</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :                 ex = mono_get_exception_type_initialization_checked (full_name, NULL, &amp;error);</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                 g_free (full_name);</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :                 return_val_if_nok (&amp;error, NULL);</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineCov">        115 :         return ex;</span>
<span class="lineNum">     299 </span><span class="lineCov">        115 : }</span>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            : /*
<span class="lineNum">     302 </span>            :  * mono_runtime_class_init:
<span class="lineNum">     303 </span>            :  * @vtable: vtable that needs to be initialized
<span class="lineNum">     304 </span>            :  *
<span class="lineNum">     305 </span>            :  * This routine calls the class constructor for @vtable.
<a name="306"><span class="lineNum">     306 </span>            :  */</a>
<span class="lineNum">     307 </span>            : void
<span class="lineNum">     308 </span>            : mono_runtime_class_init (MonoVTable *vtable)
<span class="lineNum">     309 </span>            : {
<span class="lineNum">     310 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     311 </span>            :         MonoError error;
<span class="lineNum">     312 </span>            : 
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :         mono_runtime_class_init_full (vtable, &amp;error);</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            : /**
<span class="lineNum">     318 </span>            :  * mono_runtime_class_init_full:
<span class="lineNum">     319 </span>            :  * @vtable that neeeds to be initialized
<span class="lineNum">     320 </span>            :  * @error set on error
<span class="lineNum">     321 </span>            :  *
<span class="lineNum">     322 </span>            :  * returns TRUE if class constructor .cctor has been initialized successfully, or FALSE otherwise and sets @error.
<span class="lineNum">     323 </span>            :  * 
<a name="324"><span class="lineNum">     324 </span>            :  */</a>
<span class="lineNum">     325 </span>            : gboolean
<span class="lineNum">     326 </span>            : mono_runtime_class_init_full (MonoVTable *vtable, MonoError *error)
<span class="lineNum">     327 </span>            : {
<span class="lineNum">     328 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineCov">   56808135 :         MonoMethod *method = NULL;</span>
<span class="lineNum">     331 </span>            :         MonoClass *klass;
<span class="lineNum">     332 </span>            :         gchar *full_name;
<span class="lineNum">     333 </span><span class="lineCov">   56808135 :         MonoDomain *domain = vtable-&gt;domain;</span>
<span class="lineNum">     334 </span>            :         TypeInitializationLock *lock;
<span class="lineNum">     335 </span>            :         MonoNativeThreadId tid;
<span class="lineNum">     336 </span><span class="lineCov">   56808135 :         int do_initialization = 0;</span>
<span class="lineNum">     337 </span><span class="lineCov">   56808135 :         MonoDomain *last_domain = NULL;</span>
<span class="lineNum">     338 </span><span class="lineCov">   56808135 :         MonoException * pending_tae = NULL;</span>
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineCov">   56808135 :         mono_error_init (error);</span>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineCov">   56808135 :         if (vtable-&gt;initialized)</span>
<span class="lineNum">     343 </span><span class="lineCov">   48482488 :                 return TRUE;</span>
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineCov">    8323804 :         klass = vtable-&gt;klass;</span>
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span><span class="lineCov">    8323804 :         if (!klass-&gt;image-&gt;checked_module_cctor) {</span>
<span class="lineNum">     348 </span><span class="lineCov">      15665 :                 mono_image_check_for_module_cctor (klass-&gt;image);</span>
<span class="lineNum">     349 </span><span class="lineCov">      15665 :                 if (klass-&gt;image-&gt;has_module_cctor) {</span>
<span class="lineNum">     350 </span>            :                         MonoClass *module_klass;
<span class="lineNum">     351 </span>            :                         MonoVTable *module_vtable;
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">          4 :                         module_klass = mono_class_get_checked (klass-&gt;image, MONO_TOKEN_TYPE_DEF | 1, error);</span>
<span class="lineNum">     354 </span><span class="lineCov">          4 :                         if (!module_klass) {</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :                                 return FALSE;</span>
<span class="lineNum">     356 </span>            :                         }
<span class="lineNum">     357 </span>            :                                 
<span class="lineNum">     358 </span><span class="lineCov">          4 :                         module_vtable = mono_class_vtable_full (vtable-&gt;domain, module_klass, error);</span>
<span class="lineNum">     359 </span><span class="lineCov">          4 :                         if (!module_vtable)</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :                                 return FALSE;</span>
<span class="lineNum">     361 </span><span class="lineCov">          4 :                         if (!mono_runtime_class_init_full (module_vtable, error))</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :                                 return FALSE;</span>
<span class="lineNum">     363 </span><span class="lineCov">          4 :                 }</span>
<span class="lineNum">     364 </span><span class="lineCov">      15665 :         }</span>
<span class="lineNum">     365 </span><span class="lineCov">    8323855 :         method = mono_class_get_cctor (klass);</span>
<span class="lineNum">     366 </span><span class="lineCov">    8323855 :         if (!method) {</span>
<span class="lineNum">     367 </span><span class="lineCov">    2037747 :                 vtable-&gt;initialized = 1;</span>
<span class="lineNum">     368 </span><span class="lineCov">    2037747 :                 return TRUE;</span>
<span class="lineNum">     369 </span>            :         }
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span><span class="lineCov">    6286121 :         tid = mono_native_thread_id_get ();</span>
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span><span class="lineCov">    6286121 :         mono_type_initialization_lock ();</span>
<span class="lineNum">     374 </span>            :         /* double check... */
<span class="lineNum">     375 </span><span class="lineCov">    6286121 :         if (vtable-&gt;initialized) {</span>
<span class="lineNum">     376 </span><span class="lineCov">        531 :                 mono_type_initialization_unlock ();</span>
<span class="lineNum">     377 </span><span class="lineCov">        531 :                 return TRUE;</span>
<span class="lineNum">     378 </span>            :         }
<span class="lineNum">     379 </span><span class="lineCov">    6285590 :         if (vtable-&gt;init_failed) {</span>
<span class="lineNum">     380 </span><span class="lineCov">        102 :                 mono_type_initialization_unlock ();</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :                 /* The type initialization already failed once, rethrow the same exception */
<span class="lineNum">     383 </span><span class="lineCov">        102 :                 mono_error_set_exception_instance (error, get_type_init_exception_for_vtable (vtable));</span>
<span class="lineNum">     384 </span><span class="lineCov">        102 :                 return FALSE;</span>
<span class="lineNum">     385 </span>            :         }
<span class="lineNum">     386 </span><span class="lineCov">    6285488 :         lock = (TypeInitializationLock *)g_hash_table_lookup (type_initialization_hash, vtable);</span>
<span class="lineNum">     387 </span><span class="lineCov">    6285488 :         if (lock == NULL) {</span>
<span class="lineNum">     388 </span>            :                 /* This thread will get to do the initialization */
<span class="lineNum">     389 </span><span class="lineCov">     969200 :                 if (mono_domain_get () != domain) {</span>
<span class="lineNum">     390 </span>            :                         /* Transfer into the target domain */
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                         last_domain = mono_domain_get ();</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                         if (!mono_domain_set (domain, FALSE)) {</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                                 vtable-&gt;initialized = 1;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                                 mono_type_initialization_unlock ();</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                                 mono_error_set_exception_instance (error, mono_get_exception_appdomain_unloaded ());</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                                 return FALSE;</span>
<span class="lineNum">     397 </span>            :                         }
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     399 </span><span class="lineCov">     969200 :                 lock = (TypeInitializationLock *)g_malloc (sizeof (TypeInitializationLock));</span>
<span class="lineNum">     400 </span><span class="lineCov">     969200 :                 mono_coop_mutex_init_recursive (&amp;lock-&gt;initialization_section);</span>
<span class="lineNum">     401 </span><span class="lineCov">     969200 :                 lock-&gt;initializing_tid = tid;</span>
<span class="lineNum">     402 </span><span class="lineCov">     969200 :                 lock-&gt;waiting_count = 1;</span>
<span class="lineNum">     403 </span><span class="lineCov">     969200 :                 lock-&gt;done = FALSE;</span>
<span class="lineNum">     404 </span>            :                 /* grab the vtable lock while this thread still owns type_initialization_section */
<span class="lineNum">     405 </span>            :                 /* This is why type_initialization_lock needs to enter blocking mode */
<span class="lineNum">     406 </span><span class="lineCov">     969200 :                 mono_type_init_lock (lock);</span>
<span class="lineNum">     407 </span><span class="lineCov">     969200 :                 g_hash_table_insert (type_initialization_hash, vtable, lock);</span>
<span class="lineNum">     408 </span><span class="lineCov">     969200 :                 do_initialization = 1;</span>
<span class="lineNum">     409 </span><span class="lineCov">     969200 :         } else {</span>
<span class="lineNum">     410 </span>            :                 gpointer blocked;
<span class="lineNum">     411 </span>            :                 TypeInitializationLock *pending_lock;
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineCov">    5465168 :                 if (mono_native_thread_id_equals (lock-&gt;initializing_tid, tid) || lock-&gt;done) {</span>
<span class="lineNum">     414 </span><span class="lineCov">    5167976 :                         mono_type_initialization_unlock ();</span>
<span class="lineNum">     415 </span><span class="lineCov">    5167976 :                         return TRUE;</span>
<span class="lineNum">     416 </span>            :                 }
<span class="lineNum">     417 </span>            :                 /* see if the thread doing the initialization is already blocked on this thread */
<span class="lineNum">     418 </span><span class="lineCov">     148312 :                 blocked = GUINT_TO_POINTER (MONO_NATIVE_THREAD_ID_TO_UINT (lock-&gt;initializing_tid));</span>
<span class="lineNum">     419 </span><span class="lineCov">     296624 :                 while ((pending_lock = (TypeInitializationLock*) g_hash_table_lookup (blocked_thread_hash, blocked))) {</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :                         if (mono_native_thread_id_equals (pending_lock-&gt;initializing_tid, tid)) {</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :                                 if (!pending_lock-&gt;done) {</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :                                         mono_type_initialization_unlock ();</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                                         return TRUE;</span>
<span class="lineNum">     424 </span>            :                                 } else {
<span class="lineNum">     425 </span>            :                                         /* the thread doing the initialization is blocked on this thread,
<span class="lineNum">     426 </span>            :                                            but on a lock that has already been freed. It just hasn't got
<span class="lineNum">     427 </span>            :                                            time to awake */
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">     429 </span>            :                                 }
<span class="lineNum">     430 </span>            :                         }
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                         blocked = GUINT_TO_POINTER (MONO_NATIVE_THREAD_ID_TO_UINT (pending_lock-&gt;initializing_tid));</span>
<span class="lineNum">     432 </span>            :                 }
<span class="lineNum">     433 </span><span class="lineCov">     148312 :                 ++lock-&gt;waiting_count;</span>
<span class="lineNum">     434 </span>            :                 /* record the fact that we are waiting on the initializing thread */
<span class="lineNum">     435 </span><span class="lineCov">     148312 :                 g_hash_table_insert (blocked_thread_hash, GUINT_TO_POINTER (tid), lock);</span>
<span class="lineNum">     436 </span>            :         }
<span class="lineNum">     437 </span><span class="lineCov">    1117512 :         mono_type_initialization_unlock ();</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineCov">    1117512 :         if (do_initialization) {</span>
<span class="lineNum">     440 </span><span class="lineCov">     969200 :                 MonoException *exc = NULL;</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">     969200 :                 mono_threads_begin_abort_protected_block ();</span>
<span class="lineNum">     443 </span><span class="lineCov">     969200 :                 mono_runtime_try_invoke (method, NULL, NULL, (MonoObject**) &amp;exc, error);</span>
<span class="lineNum">     444 </span><span class="lineCov">     969200 :                 mono_threads_end_abort_protected_block ();</span>
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            :                 //exception extracted, error will be set to the right value later
<span class="lineNum">     447 </span><span class="lineCov">    1938388 :                 if (exc == NULL &amp;&amp; !mono_error_ok (error))//invoking failed but exc was not set</span>
<span class="lineNum">     448 </span><span class="lineCov">          1 :                         exc = mono_error_convert_to_exception (error);</span>
<span class="lineNum">     449 </span>            :                 else
<span class="lineNum">     450 </span><span class="lineCov">     969199 :                         mono_error_cleanup (error);</span>
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">     969200 :                 mono_error_init (error);</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span>            :                 /* If the initialization failed, mark the class as unusable. */
<span class="lineNum">     455 </span>            :                 /* Avoid infinite loops */
<span class="lineNum">     456 </span><span class="lineCov">     969200 :                 if (!(!exc ||</span>
<span class="lineNum">     457 </span><span class="lineCov">         13 :                           (klass-&gt;image == mono_defaults.corlib &amp;&amp;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                            !strcmp (klass-&gt;name_space, &quot;System&quot;) &amp;&amp;</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                            !strcmp (klass-&gt;name, &quot;TypeInitializationException&quot;)))) {</span>
<span class="lineNum">     460 </span><span class="lineCov">         13 :                         vtable-&gt;init_failed = 1;</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">         26 :                         if (klass-&gt;name_space &amp;&amp; *klass-&gt;name_space)</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                                 full_name = g_strdup_printf (&quot;%s.%s&quot;, klass-&gt;name_space, klass-&gt;name);</span>
<span class="lineNum">     464 </span>            :                         else
<span class="lineNum">     465 </span><span class="lineCov">         13 :                                 full_name = g_strdup (klass-&gt;name);</span>
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineCov">         13 :                         MonoException *exc_to_throw = mono_get_exception_type_initialization_checked (full_name, exc, error);</span>
<span class="lineNum">     468 </span><span class="lineCov">         13 :                         g_free (full_name);</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineCov">         13 :                         mono_error_assert_ok (error); //We can't recover from this, no way to fail a type we can't alloc a failure.</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :                         /*
<span class="lineNum">     473 </span>            :                          * Store the exception object so it could be thrown on subsequent
<span class="lineNum">     474 </span>            :                          * accesses.
<span class="lineNum">     475 </span>            :                          */
<span class="lineNum">     476 </span><span class="lineCov">         13 :                         mono_domain_lock (domain);</span>
<span class="lineNum">     477 </span><span class="lineCov">         13 :                         if (!domain-&gt;type_init_exception_hash)</span>
<span class="lineNum">     478 </span><span class="lineCov">         11 :                                 domain-&gt;type_init_exception_hash = mono_g_hash_table_new_type (mono_aligned_addr_hash, NULL, MONO_HASH_VALUE_GC, MONO_ROOT_SOURCE_DOMAIN, &quot;type initialization exceptions table&quot;);</span>
<span class="lineNum">     479 </span><span class="lineCov">         13 :                         mono_g_hash_table_insert (domain-&gt;type_init_exception_hash, klass, exc_to_throw);</span>
<span class="lineNum">     480 </span><span class="lineCov">         13 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">     481 </span><span class="lineCov">         13 :                 }</span>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineCov">     969199 :                 if (last_domain)</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                         mono_domain_set (last_domain, TRUE);</span>
<span class="lineNum">     485 </span><span class="lineCov">     969199 :                 lock-&gt;done = TRUE;</span>
<span class="lineNum">     486 </span><span class="lineCov">     969199 :                 mono_type_init_unlock (lock);</span>
<span class="lineNum">     487 </span><span class="lineCov">     969212 :                 if (exc &amp;&amp; mono_object_class (exc) == mono_defaults.threadabortexception_class)</span>
<span class="lineNum">     488 </span><span class="lineCov">          2 :                         pending_tae = exc;</span>
<span class="lineNum">     489 </span>            :                 //TAEs are blocked around .cctors, they must escape as soon as no cctor is left to run.
<span class="lineNum">     490 </span><span class="lineCov">    1938395 :                 if (!pending_tae &amp;&amp; mono_get_eh_callbacks ()-&gt;mono_above_abort_threshold ())</span>
<span class="lineNum">     491 </span><span class="lineCov">      32843 :                         pending_tae = mono_thread_try_resume_interruption ();</span>
<span class="lineNum">     492 </span><span class="lineCov">     969197 :         } else {</span>
<span class="lineNum">     493 </span>            :                 /* this just blocks until the initializing thread is done */
<span class="lineNum">     494 </span><span class="lineCov">     148309 :                 mono_type_init_lock (lock);</span>
<span class="lineNum">     495 </span><span class="lineCov">     148309 :                 mono_type_init_unlock (lock);</span>
<span class="lineNum">     496 </span>            :         }
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineCov">    1117512 :         mono_type_initialization_lock ();</span>
<span class="lineNum">     499 </span><span class="lineCov">    1117512 :         if (!mono_native_thread_id_equals (lock-&gt;initializing_tid, tid))</span>
<span class="lineNum">     500 </span><span class="lineCov">     148312 :                 g_hash_table_remove (blocked_thread_hash, GUINT_TO_POINTER (tid));</span>
<span class="lineNum">     501 </span><span class="lineCov">    1117512 :         --lock-&gt;waiting_count;</span>
<span class="lineNum">     502 </span><span class="lineCov">    1117512 :         if (lock-&gt;waiting_count == 0) {</span>
<span class="lineNum">     503 </span><span class="lineCov">     969200 :                 mono_coop_mutex_destroy (&amp;lock-&gt;initialization_section);</span>
<span class="lineNum">     504 </span><span class="lineCov">     969200 :                 g_hash_table_remove (type_initialization_hash, vtable);</span>
<span class="lineNum">     505 </span><span class="lineCov">     969200 :                 g_free (lock);</span>
<span class="lineNum">     506 </span><span class="lineCov">     969200 :         }</span>
<span class="lineNum">     507 </span><span class="lineCov">    1117512 :         mono_memory_barrier ();</span>
<span class="lineNum">     508 </span><span class="lineCov">    1117512 :         if (!vtable-&gt;init_failed)</span>
<span class="lineNum">     509 </span><span class="lineCov">    1117497 :                 vtable-&gt;initialized = 1;</span>
<span class="lineNum">     510 </span><span class="lineCov">    1117510 :         mono_type_initialization_unlock ();</span>
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :         //TAE wins over TIE
<span class="lineNum">     513 </span><span class="lineCov">    1117510 :         if (pending_tae)</span>
<span class="lineNum">     514 </span><span class="lineCov">          5 :                 mono_error_set_exception_instance (error, pending_tae);</span>
<span class="lineNum">     515 </span><span class="lineCov">    1117495 :         else if (vtable-&gt;init_failed) {</span>
<span class="lineNum">     516 </span>            :                 /* Either we were the initializing thread or we waited for the initialization */
<span class="lineNum">     517 </span><span class="lineCov">         13 :                 mono_error_set_exception_instance (error, get_type_init_exception_for_vtable (vtable));</span>
<span class="lineNum">     518 </span><span class="lineCov">         13 :                 return FALSE;</span>
<span class="lineNum">     519 </span>            :         }
<span class="lineNum">     520 </span><span class="lineCov">    1117497 :         return TRUE;</span>
<span class="lineNum">     521 </span><span class="lineCov">   56804273 : }</span>
<a name="522"><span class="lineNum">     522 </span>            : </a>
<span class="lineNum">     523 </span>            : static
<span class="lineNum">     524 </span>            : gboolean release_type_locks (gpointer key, gpointer value, gpointer user)
<span class="lineNum">     525 </span>            : {
<span class="lineNum">     526 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineCov">        706 :         MonoVTable *vtable = (MonoVTable*)key;</span>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span><span class="lineCov">        706 :         TypeInitializationLock *lock = (TypeInitializationLock*) value;</span>
<span class="lineNum">     531 </span><span class="lineCov">        706 :         if (mono_native_thread_id_equals (lock-&gt;initializing_tid, MONO_UINT_TO_NATIVE_THREAD_ID (GPOINTER_TO_UINT (user))) &amp;&amp; !lock-&gt;done) {</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                 lock-&gt;done = TRUE;</span>
<span class="lineNum">     533 </span>            :                 /* 
<span class="lineNum">     534 </span>            :                  * Have to set this since it cannot be set by the normal code in 
<span class="lineNum">     535 </span>            :                  * mono_runtime_class_init (). In this case, the exception object is not stored,
<span class="lineNum">     536 </span>            :                  * and get_type_init_exception_for_class () needs to be aware of this.
<span class="lineNum">     537 </span>            :                  */
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                 vtable-&gt;init_failed = 1;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                 mono_type_init_unlock (lock);</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :                 --lock-&gt;waiting_count;</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :                 if (lock-&gt;waiting_count == 0) {</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :                         mono_coop_mutex_destroy (&amp;lock-&gt;initialization_section);</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                         g_free (lock);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                         return TRUE;</span>
<span class="lineNum">     545 </span>            :                 }
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     547 </span><span class="lineCov">        706 :         return FALSE;</span>
<span class="lineNum">     548 </span><span class="lineCov">        706 : }</span>
<a name="549"><span class="lineNum">     549 </span>            : </a>
<span class="lineNum">     550 </span>            : void
<span class="lineNum">     551 </span>            : mono_release_type_locks (MonoInternalThread *thread)
<span class="lineNum">     552 </span>            : {
<span class="lineNum">     553 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineCov">      16681 :         mono_type_initialization_lock ();</span>
<span class="lineNum">     556 </span><span class="lineCov">      16681 :         g_hash_table_foreach_remove (type_initialization_hash, release_type_locks, GUINT_TO_POINTER (thread-&gt;tid));</span>
<span class="lineNum">     557 </span><span class="lineCov">      16681 :         mono_type_initialization_unlock ();</span>
<span class="lineNum">     558 </span><span class="lineCov">      16681 : }</span>
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            : #ifndef DISABLE_REMOTING
<a name="561"><span class="lineNum">     561 </span>            : </a>
<span class="lineNum">     562 </span>            : static gpointer
<span class="lineNum">     563 </span>            : create_remoting_trampoline (MonoDomain *domain, MonoMethod *method, MonoRemotingTarget target, MonoError *error)
<span class="lineNum">     564 </span>            : {
<span class="lineNum">     565 </span><span class="lineCov">      99819 :         if (!callbacks.create_remoting_trampoline)</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                 g_error (&quot;remoting not installed&quot;);</span>
<span class="lineNum">     567 </span><span class="lineCov">      99819 :         return callbacks.create_remoting_trampoline (domain, method, target, error);</span>
<span class="lineNum">     568 </span>            : }
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span>            : #endif
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            : static MonoImtTrampolineBuilder imt_trampoline_builder;
<span class="lineNum">     573 </span>            : static gboolean always_build_imt_trampolines;
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span>            : #if (MONO_IMT_SIZE &gt; 32)
<span class="lineNum">     576 </span>            : #error &quot;MONO_IMT_SIZE cannot be larger than 32&quot;
<span class="lineNum">     577 </span>            : #endif
<a name="578"><span class="lineNum">     578 </span>            : </a>
<span class="lineNum">     579 </span>            : void
<span class="lineNum">     580 </span>            : mono_install_callbacks (MonoRuntimeCallbacks *cbs)
<span class="lineNum">     581 </span>            : {
<span class="lineNum">     582 </span><span class="lineCov">       3285 :         memcpy (&amp;callbacks, cbs, sizeof (*cbs));</span>
<span class="lineNum">     583 </span><span class="lineCov">       3285 : }</span>
<a name="584"><span class="lineNum">     584 </span>            : </a>
<span class="lineNum">     585 </span>            : MonoRuntimeCallbacks*
<span class="lineNum">     586 </span>            : mono_get_runtime_callbacks (void)
<span class="lineNum">     587 </span>            : {
<span class="lineNum">     588 </span><span class="lineCov">          1 :         return &amp;callbacks;</span>
<span class="lineNum">     589 </span>            : }
<a name="590"><span class="lineNum">     590 </span>            : </a>
<span class="lineNum">     591 </span>            : void
<span class="lineNum">     592 </span>            : mono_install_imt_trampoline_builder (MonoImtTrampolineBuilder func)
<span class="lineNum">     593 </span>            : {
<span class="lineNum">     594 </span><span class="lineCov">       3285 :         imt_trampoline_builder = func;</span>
<span class="lineNum">     595 </span><span class="lineCov">       3285 : }</span>
<a name="596"><span class="lineNum">     596 </span>            : </a>
<span class="lineNum">     597 </span>            : void
<span class="lineNum">     598 </span>            : mono_set_always_build_imt_trampolines (gboolean value)
<span class="lineNum">     599 </span>            : {
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :         always_build_imt_trampolines = value;</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            : /**
<span class="lineNum">     604 </span>            :  * mono_compile_method:
<span class="lineNum">     605 </span>            :  * @method: The method to compile.
<span class="lineNum">     606 </span>            :  *
<span class="lineNum">     607 </span>            :  * This JIT-compiles the method, and returns the pointer to the native code
<span class="lineNum">     608 </span>            :  * produced.
<a name="609"><span class="lineNum">     609 </span>            :  */</a>
<span class="lineNum">     610 </span>            : gpointer 
<span class="lineNum">     611 </span>            : mono_compile_method (MonoMethod *method)
<span class="lineNum">     612 </span>            : {
<span class="lineNum">     613 </span>            :         MonoError error;
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :         gpointer result = mono_compile_method_checked (method, &amp;error);</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">     617 </span>            : }
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span>            : /**
<span class="lineNum">     620 </span>            :  * mono_compile_method:
<span class="lineNum">     621 </span>            :  * @method: The method to compile.
<span class="lineNum">     622 </span>            :  * @error: set on error.
<span class="lineNum">     623 </span>            :  *
<span class="lineNum">     624 </span>            :  * This JIT-compiles the method, and returns the pointer to the native code
<span class="lineNum">     625 </span>            :  * produced.  On failure returns NULL and sets @error.
<a name="626"><span class="lineNum">     626 </span>            :  */</a>
<span class="lineNum">     627 </span>            : gpointer
<span class="lineNum">     628 </span>            : mono_compile_method_checked (MonoMethod *method, MonoError *error)
<span class="lineNum">     629 </span>            : {
<span class="lineNum">     630 </span>            :         gpointer res;
<span class="lineNum">     631 </span>            : 
<span class="lineNum">     632 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineCov">     719211 :         mono_error_init (error);</span>
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineCov">    2157639 :         g_assert (callbacks.compile_method);</span>
<span class="lineNum">     637 </span><span class="lineCov">     719214 :         res = callbacks.compile_method (method, error);</span>
<span class="lineNum">     638 </span><span class="lineCov">     719214 :         return res;</span>
<span class="lineNum">     639 </span>            : }
<a name="640"><span class="lineNum">     640 </span>            : </a>
<span class="lineNum">     641 </span>            : gpointer
<span class="lineNum">     642 </span>            : mono_runtime_create_jump_trampoline (MonoDomain *domain, MonoMethod *method, gboolean add_sync_wrapper, MonoError *error)
<span class="lineNum">     643 </span>            : {
<span class="lineNum">     644 </span>            :         gpointer res;
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineCov">       2243 :         mono_error_init (error);</span>
<span class="lineNum">     649 </span><span class="lineCov">       2243 :         res = callbacks.create_jump_trampoline (domain, method, add_sync_wrapper, error);</span>
<span class="lineNum">     650 </span><span class="lineCov">       2243 :         return res;</span>
<span class="lineNum">     651 </span>            : }
<a name="652"><span class="lineNum">     652 </span>            : </a>
<span class="lineNum">     653 </span>            : gpointer
<span class="lineNum">     654 </span>            : mono_runtime_create_delegate_trampoline (MonoClass *klass)
<span class="lineNum">     655 </span>            : {
<span class="lineNum">     656 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span><span class="lineCov">        297 :         g_assert (callbacks.create_delegate_trampoline);</span>
<span class="lineNum">     659 </span><span class="lineCov">         99 :         return callbacks.create_delegate_trampoline (mono_domain_get (), klass);</span>
<span class="lineNum">     660 </span>            : }
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span>            : /**
<span class="lineNum">     663 </span>            :  * mono_runtime_free_method:
<span class="lineNum">     664 </span>            :  * @domain; domain where the method is hosted
<span class="lineNum">     665 </span>            :  * @method: method to release
<span class="lineNum">     666 </span>            :  *
<span class="lineNum">     667 </span>            :  * This routine is invoked to free the resources associated with
<span class="lineNum">     668 </span>            :  * a method that has been JIT compiled.  This is used to discard
<span class="lineNum">     669 </span>            :  * methods that were used only temporarily (for example, used in marshalling)
<span class="lineNum">     670 </span>            :  *
<a name="671"><span class="lineNum">     671 </span>            :  */</a>
<span class="lineNum">     672 </span>            : void
<span class="lineNum">     673 </span>            : mono_runtime_free_method (MonoDomain *domain, MonoMethod *method)
<span class="lineNum">     674 </span>            : {
<span class="lineNum">     675 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineCov">      10028 :         if (callbacks.free_method)</span>
<span class="lineNum">     678 </span><span class="lineCov">      10028 :                 callbacks.free_method (domain, method);</span>
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span><span class="lineCov">      10028 :         mono_method_clear_object (domain, method);</span>
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span><span class="lineCov">      10028 :         mono_free_method (method);</span>
<span class="lineNum">     683 </span><span class="lineCov">      10028 : }</span>
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span>            : /*
<span class="lineNum">     686 </span>            :  * The vtables in the root appdomain are assumed to be reachable by other 
<span class="lineNum">     687 </span>            :  * roots, and we don't use typed allocation in the other domains.
<span class="lineNum">     688 </span>            :  */
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span>            : /* The sync block is no longer a GC pointer */
<span class="lineNum">     691 </span>            : #define GC_HEADER_BITMAP (0)
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            : #define BITMAP_EL_SIZE (sizeof (gsize) * 8)
<a name="694"><span class="lineNum">     694 </span>            : </a>
<span class="lineNum">     695 </span>            : static gsize*
<span class="lineNum">     696 </span>            : compute_class_bitmap (MonoClass *klass, gsize *bitmap, int size, int offset, int *max_set, gboolean static_fields)
<span class="lineNum">     697 </span>            : {
<span class="lineNum">     698 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span>            :         MonoClassField *field;
<span class="lineNum">     701 </span>            :         MonoClass *p;
<span class="lineNum">     702 </span>            :         guint32 pos;
<span class="lineNum">     703 </span>            :         int max_size;
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineCov">    7107488 :         if (static_fields)</span>
<span class="lineNum">     706 </span><span class="lineCov">    1108377 :                 max_size = mono_class_data_size (klass) / sizeof (gpointer);</span>
<span class="lineNum">     707 </span>            :         else
<span class="lineNum">     708 </span><span class="lineCov">    5999111 :                 max_size = klass-&gt;instance_size / sizeof (gpointer);</span>
<span class="lineNum">     709 </span><span class="lineCov">    7107488 :         if (max_size &gt; size) {</span>
<span class="lineNum">     710 </span><span class="lineCov">       6198 :                 g_assert (offset &lt;= 0);</span>
<span class="lineNum">     711 </span><span class="lineCov">       2066 :                 bitmap = (gsize *)g_malloc0 ((max_size + BITMAP_EL_SIZE - 1) / BITMAP_EL_SIZE * sizeof (gsize));</span>
<span class="lineNum">     712 </span><span class="lineCov">       2066 :                 size = max_size;</span>
<span class="lineNum">     713 </span><span class="lineCov">       2066 :         }</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">     716 </span>            :         /*An Ephemeron cannot be marked by sgen*/
<span class="lineNum">     717 </span><span class="lineCov">   14796561 :         if (!static_fields &amp;&amp; klass-&gt;image == mono_defaults.corlib &amp;&amp; !strcmp (&quot;Ephemeron&quot;, klass-&gt;name)) {</span>
<span class="lineNum">     718 </span><span class="lineCov">       2136 :                 *max_set = 0;</span>
<span class="lineNum">     719 </span><span class="lineCov">       2136 :                 memset (bitmap, 0, size / 8);</span>
<span class="lineNum">     720 </span><span class="lineCov">       2136 :                 return bitmap;</span>
<span class="lineNum">     721 </span>            :         }
<span class="lineNum">     722 </span>            : #endif
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineCov">   48733659 :         for (p = klass; p != NULL; p = p-&gt;parent) {</span>
<span class="lineNum">     725 </span><span class="lineCov">   18369855 :                 gpointer iter = NULL;</span>
<span class="lineNum">     726 </span><span class="lineCov">  132124293 :                 while ((field = mono_class_get_fields (p, &amp;iter))) {</span>
<span class="lineNum">     727 </span>            :                         MonoType *type;
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineCov">   71120917 :                         if (static_fields) {</span>
<span class="lineNum">     730 </span><span class="lineCov">    6193924 :                                 if (!(field-&gt;type-&gt;attrs &amp; (FIELD_ATTRIBUTE_STATIC | FIELD_ATTRIBUTE_HAS_FIELD_RVA)))</span>
<span class="lineNum">     731 </span><span class="lineCov">    2820898 :                                         continue;</span>
<span class="lineNum">     732 </span><span class="lineCov">    3373026 :                                 if (field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL)</span>
<span class="lineNum">     733 </span><span class="lineCov">    1073124 :                                         continue;</span>
<span class="lineNum">     734 </span><span class="lineCov">    2299902 :                         } else {</span>
<span class="lineNum">     735 </span><span class="lineCov">   64926993 :                                 if (field-&gt;type-&gt;attrs &amp; (FIELD_ATTRIBUTE_STATIC | FIELD_ATTRIBUTE_HAS_FIELD_RVA))</span>
<span class="lineNum">     736 </span><span class="lineCov">   42959628 :                                         continue;</span>
<span class="lineNum">     737 </span>            :                         }
<span class="lineNum">     738 </span>            :                         /* FIXME: should not happen, flag as type load error */
<span class="lineNum">     739 </span><span class="lineCov">   24267268 :                         if (field-&gt;type-&gt;byref)</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     741 </span>            : 
<span class="lineNum">     742 </span><span class="lineCov">   26567170 :                         if (static_fields &amp;&amp; field-&gt;offset == -1)</span>
<span class="lineNum">     743 </span>            :                                 /* special static */
<span class="lineNum">     744 </span><span class="lineCov">       3598 :                                 continue;</span>
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineCov">   25170237 :                         pos = field-&gt;offset / sizeof (gpointer);</span>
<span class="lineNum">     747 </span><span class="lineCov">   25170237 :                         pos += offset;</span>
<span class="lineNum">     748 </span>            : 
<span class="lineNum">     749 </span><span class="lineCov">   25170237 :                         type = mono_type_get_underlying_type (field-&gt;type);</span>
<span class="lineNum">     750 </span><span class="lineCov">   25170237 :                         switch (type-&gt;type) {</span>
<span class="lineNum">     751 </span>            :                         case MONO_TYPE_I:
<span class="lineNum">     752 </span>            :                         case MONO_TYPE_PTR:
<span class="lineNum">     753 </span>            :                         case MONO_TYPE_FNPTR:
<span class="lineNum">     754 </span><span class="lineCov">    2108332 :                                 break;</span>
<span class="lineNum">     755 </span>            :                         /* only UIntPtr is allowed to be GC-tracked and only in mscorlib */
<span class="lineNum">     756 </span>            :                         case MONO_TYPE_U:
<span class="lineNum">     757 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">     758 </span><span class="lineCov">       9943 :                                 break;</span>
<span class="lineNum">     759 </span>            : #else
<span class="lineNum">     760 </span>            :                                 if (klass-&gt;image != mono_defaults.corlib)
<span class="lineNum">     761 </span>            :                                         break;
<span class="lineNum">     762 </span>            : #endif
<span class="lineNum">     763 </span>            :                         case MONO_TYPE_STRING:
<span class="lineNum">     764 </span>            :                         case MONO_TYPE_SZARRAY:
<span class="lineNum">     765 </span>            :                         case MONO_TYPE_CLASS:
<span class="lineNum">     766 </span>            :                         case MONO_TYPE_OBJECT:
<span class="lineNum">     767 </span>            :                         case MONO_TYPE_ARRAY:
<span class="lineNum">     768 </span><span class="lineCov">   31424553 :                                 g_assert ((field-&gt;offset % sizeof(gpointer)) == 0);</span>
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span><span class="lineCov">   41899404 :                                 g_assert (pos &lt; size || pos &lt;= max_size);</span>
<span class="lineNum">     771 </span><span class="lineCov">   10474851 :                                 bitmap [pos / BITMAP_EL_SIZE] |= ((gsize)1) &lt;&lt; (pos % BITMAP_EL_SIZE);</span>
<span class="lineNum">     772 </span><span class="lineCov">   31424553 :                                 *max_set = MAX (*max_set, pos);</span>
<span class="lineNum">     773 </span><span class="lineCov">   10474851 :                                 break;</span>
<span class="lineNum">     774 </span>            :                         case MONO_TYPE_GENERICINST:
<span class="lineNum">     775 </span><span class="lineCov">    5394970 :                                 if (!mono_type_generic_inst_is_valuetype (type)) {</span>
<span class="lineNum">     776 </span><span class="lineCov">   10745491 :                                         g_assert ((field-&gt;offset % sizeof(gpointer)) == 0);</span>
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineCov">    3581832 :                                         bitmap [pos / BITMAP_EL_SIZE] |= ((gsize)1) &lt;&lt; (pos % BITMAP_EL_SIZE);</span>
<span class="lineNum">     779 </span><span class="lineCov">   10745494 :                                         *max_set = MAX (*max_set, pos);</span>
<span class="lineNum">     780 </span><span class="lineCov">    3581831 :                                         break;</span>
<span class="lineNum">     781 </span>            :                                 } else {
<span class="lineNum">     782 </span>            :                                         /* fall through */
<span class="lineNum">     783 </span>            :                                 }
<span class="lineNum">     784 </span>            :                         case MONO_TYPE_VALUETYPE: {
<span class="lineNum">     785 </span><span class="lineCov">    1694477 :                                 MonoClass *fclass = mono_class_from_mono_type (field-&gt;type);</span>
<span class="lineNum">     786 </span><span class="lineCov">    1694477 :                                 if (fclass-&gt;has_references) {</span>
<span class="lineNum">     787 </span>            :                                         /* remove the object header */
<span class="lineNum">     788 </span><span class="lineCov">    1243960 :                                         compute_class_bitmap (fclass, bitmap, size, pos - (sizeof (MonoObject) / sizeof (gpointer)), max_set, FALSE);</span>
<span class="lineNum">     789 </span><span class="lineCov">    1243960 :                                 }</span>
<span class="lineNum">     790 </span><span class="lineCov">    1694477 :                                 break;</span>
<span class="lineNum">     791 </span>            :                         }
<span class="lineNum">     792 </span>            :                         case MONO_TYPE_I1:
<span class="lineNum">     793 </span>            :                         case MONO_TYPE_U1:
<span class="lineNum">     794 </span>            :                         case MONO_TYPE_I2:
<span class="lineNum">     795 </span>            :                         case MONO_TYPE_U2:
<span class="lineNum">     796 </span>            :                         case MONO_TYPE_I4:
<span class="lineNum">     797 </span>            :                         case MONO_TYPE_U4:
<span class="lineNum">     798 </span>            :                         case MONO_TYPE_I8:
<span class="lineNum">     799 </span>            :                         case MONO_TYPE_U8:
<span class="lineNum">     800 </span>            :                         case MONO_TYPE_R4:
<span class="lineNum">     801 </span>            :                         case MONO_TYPE_R8:
<span class="lineNum">     802 </span>            :                         case MONO_TYPE_BOOLEAN:
<span class="lineNum">     803 </span>            :                         case MONO_TYPE_CHAR:
<span class="lineNum">     804 </span><span class="lineCov">    6394233 :                                 break;</span>
<span class="lineNum">     805 </span>            :                         default:
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                                 g_error (&quot;compute_class_bitmap: Invalid type %x for field %s:%s\n&quot;, type-&gt;type, mono_type_get_full_name (field-&gt;parent), field-&gt;name);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     808 </span>            :                         }
<span class="lineNum">     809 </span>            :                 }
<span class="lineNum">     810 </span><span class="lineCov">   18369854 :                 if (static_fields)</span>
<span class="lineNum">     811 </span><span class="lineCov">    1108377 :                         break;</span>
<span class="lineNum">     812 </span><span class="lineCov">   17261477 :         }</span>
<span class="lineNum">     813 </span><span class="lineCov">    7105352 :         return bitmap;</span>
<span class="lineNum">     814 </span><span class="lineCov">    7107488 : }</span>
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span>            : /**
<span class="lineNum">     817 </span>            :  * mono_class_compute_bitmap:
<span class="lineNum">     818 </span>            :  *
<span class="lineNum">     819 </span>            :  * Mono internal function to compute a bitmap of reference fields in a class.
<a name="820"><span class="lineNum">     820 </span>            :  */</a>
<span class="lineNum">     821 </span>            : gsize*
<span class="lineNum">     822 </span>            : mono_class_compute_bitmap (MonoClass *klass, gsize *bitmap, int size, int offset, int *max_set, gboolean static_fields)
<span class="lineNum">     823 </span>            : {
<span class="lineNum">     824 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :         return compute_class_bitmap (klass, bitmap, size, offset, max_set, static_fields);</span>
<span class="lineNum">     827 </span>            : }
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            : #if 0
<span class="lineNum">     830 </span>            : /* 
<span class="lineNum">     831 </span>            :  * similar to the above, but sets the bits in the bitmap for any non-ref field
<span class="lineNum">     832 </span>            :  * and ignores static fields
<span class="lineNum">     833 </span>            :  */
<span class="lineNum">     834 </span>            : static gsize*
<span class="lineNum">     835 </span>            : compute_class_non_ref_bitmap (MonoClass *klass, gsize *bitmap, int size, int offset)
<span class="lineNum">     836 </span>            : {
<span class="lineNum">     837 </span>            :         MonoClassField *field;
<span class="lineNum">     838 </span>            :         MonoClass *p;
<span class="lineNum">     839 </span>            :         guint32 pos, pos2;
<span class="lineNum">     840 </span>            :         int max_size;
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span>            :         max_size = class-&gt;instance_size / sizeof (gpointer);
<span class="lineNum">     843 </span>            :         if (max_size &gt;= size) {
<span class="lineNum">     844 </span>            :                 bitmap = g_malloc0 (sizeof (gsize) * ((max_size) + 1));
<span class="lineNum">     845 </span>            :         }
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span>            :         for (p = class; p != NULL; p = p-&gt;parent) {
<span class="lineNum">     848 </span>            :                 gpointer iter = NULL;
<span class="lineNum">     849 </span>            :                 while ((field = mono_class_get_fields (p, &amp;iter))) {
<span class="lineNum">     850 </span>            :                         MonoType *type;
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span>            :                         if (field-&gt;type-&gt;attrs &amp; (FIELD_ATTRIBUTE_STATIC | FIELD_ATTRIBUTE_HAS_FIELD_RVA))
<span class="lineNum">     853 </span>            :                                 continue;
<span class="lineNum">     854 </span>            :                         /* FIXME: should not happen, flag as type load error */
<span class="lineNum">     855 </span>            :                         if (field-&gt;type-&gt;byref)
<span class="lineNum">     856 </span>            :                                 break;
<span class="lineNum">     857 </span>            : 
<span class="lineNum">     858 </span>            :                         pos = field-&gt;offset / sizeof (gpointer);
<span class="lineNum">     859 </span>            :                         pos += offset;
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span>            :                         type = mono_type_get_underlying_type (field-&gt;type);
<span class="lineNum">     862 </span>            :                         switch (type-&gt;type) {
<span class="lineNum">     863 </span>            : #if SIZEOF_VOID_P == 8
<span class="lineNum">     864 </span>            :                         case MONO_TYPE_I:
<span class="lineNum">     865 </span>            :                         case MONO_TYPE_U:
<span class="lineNum">     866 </span>            :                         case MONO_TYPE_PTR:
<span class="lineNum">     867 </span>            :                         case MONO_TYPE_FNPTR:
<span class="lineNum">     868 </span>            : #endif
<span class="lineNum">     869 </span>            :                         case MONO_TYPE_I8:
<span class="lineNum">     870 </span>            :                         case MONO_TYPE_U8:
<span class="lineNum">     871 </span>            :                         case MONO_TYPE_R8:
<span class="lineNum">     872 </span>            :                                 if ((((field-&gt;offset + 7) / sizeof (gpointer)) + offset) != pos) {
<span class="lineNum">     873 </span>            :                                         pos2 = ((field-&gt;offset + 7) / sizeof (gpointer)) + offset;
<span class="lineNum">     874 </span>            :                                         bitmap [pos2 / BITMAP_EL_SIZE] |= ((gsize)1) &lt;&lt; (pos2 % BITMAP_EL_SIZE);
<span class="lineNum">     875 </span>            :                                 }
<span class="lineNum">     876 </span>            :                                 /* fall through */
<span class="lineNum">     877 </span>            : #if SIZEOF_VOID_P == 4
<span class="lineNum">     878 </span>            :                         case MONO_TYPE_I:
<span class="lineNum">     879 </span>            :                         case MONO_TYPE_U:
<span class="lineNum">     880 </span>            :                         case MONO_TYPE_PTR:
<span class="lineNum">     881 </span>            :                         case MONO_TYPE_FNPTR:
<span class="lineNum">     882 </span>            : #endif
<span class="lineNum">     883 </span>            :                         case MONO_TYPE_I4:
<span class="lineNum">     884 </span>            :                         case MONO_TYPE_U4:
<span class="lineNum">     885 </span>            :                         case MONO_TYPE_R4:
<span class="lineNum">     886 </span>            :                                 if ((((field-&gt;offset + 3) / sizeof (gpointer)) + offset) != pos) {
<span class="lineNum">     887 </span>            :                                         pos2 = ((field-&gt;offset + 3) / sizeof (gpointer)) + offset;
<span class="lineNum">     888 </span>            :                                         bitmap [pos2 / BITMAP_EL_SIZE] |= ((gsize)1) &lt;&lt; (pos2 % BITMAP_EL_SIZE);
<span class="lineNum">     889 </span>            :                                 }
<span class="lineNum">     890 </span>            :                                 /* fall through */
<span class="lineNum">     891 </span>            :                         case MONO_TYPE_CHAR:
<span class="lineNum">     892 </span>            :                         case MONO_TYPE_I2:
<span class="lineNum">     893 </span>            :                         case MONO_TYPE_U2:
<span class="lineNum">     894 </span>            :                                 if ((((field-&gt;offset + 1) / sizeof (gpointer)) + offset) != pos) {
<span class="lineNum">     895 </span>            :                                         pos2 = ((field-&gt;offset + 1) / sizeof (gpointer)) + offset;
<span class="lineNum">     896 </span>            :                                         bitmap [pos2 / BITMAP_EL_SIZE] |= ((gsize)1) &lt;&lt; (pos2 % BITMAP_EL_SIZE);
<span class="lineNum">     897 </span>            :                                 }
<span class="lineNum">     898 </span>            :                                 /* fall through */
<span class="lineNum">     899 </span>            :                         case MONO_TYPE_BOOLEAN:
<span class="lineNum">     900 </span>            :                         case MONO_TYPE_I1:
<span class="lineNum">     901 </span>            :                         case MONO_TYPE_U1:
<span class="lineNum">     902 </span>            :                                 bitmap [pos / BITMAP_EL_SIZE] |= ((gsize)1) &lt;&lt; (pos % BITMAP_EL_SIZE);
<span class="lineNum">     903 </span>            :                                 break;
<span class="lineNum">     904 </span>            :                         case MONO_TYPE_STRING:
<span class="lineNum">     905 </span>            :                         case MONO_TYPE_SZARRAY:
<span class="lineNum">     906 </span>            :                         case MONO_TYPE_CLASS:
<span class="lineNum">     907 </span>            :                         case MONO_TYPE_OBJECT:
<span class="lineNum">     908 </span>            :                         case MONO_TYPE_ARRAY:
<span class="lineNum">     909 </span>            :                                 break;
<span class="lineNum">     910 </span>            :                         case MONO_TYPE_GENERICINST:
<span class="lineNum">     911 </span>            :                                 if (!mono_type_generic_inst_is_valuetype (type)) {
<span class="lineNum">     912 </span>            :                                         break;
<span class="lineNum">     913 </span>            :                                 } else {
<span class="lineNum">     914 </span>            :                                         /* fall through */
<span class="lineNum">     915 </span>            :                                 }
<span class="lineNum">     916 </span>            :                         case MONO_TYPE_VALUETYPE: {
<span class="lineNum">     917 </span>            :                                 MonoClass *fclass = mono_class_from_mono_type (field-&gt;type);
<span class="lineNum">     918 </span>            :                                 /* remove the object header */
<span class="lineNum">     919 </span>            :                                 compute_class_non_ref_bitmap (fclass, bitmap, size, pos - (sizeof (MonoObject) / sizeof (gpointer)));
<span class="lineNum">     920 </span>            :                                 break;
<span class="lineNum">     921 </span>            :                         }
<span class="lineNum">     922 </span>            :                         default:
<span class="lineNum">     923 </span>            :                                 g_assert_not_reached ();
<span class="lineNum">     924 </span>            :                                 break;
<span class="lineNum">     925 </span>            :                         }
<span class="lineNum">     926 </span>            :                 }
<span class="lineNum">     927 </span>            :         }
<span class="lineNum">     928 </span>            :         return bitmap;
<span class="lineNum">     929 </span>            : }
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span>            : /**
<span class="lineNum">     932 </span>            :  * mono_class_insecure_overlapping:
<span class="lineNum">     933 </span>            :  * check if a class with explicit layout has references and non-references
<span class="lineNum">     934 </span>            :  * fields overlapping.
<span class="lineNum">     935 </span>            :  *
<span class="lineNum">     936 </span>            :  * Returns: TRUE if it is insecure to load the type.
<span class="lineNum">     937 </span>            :  */
<span class="lineNum">     938 </span>            : gboolean
<span class="lineNum">     939 </span>            : mono_class_insecure_overlapping (MonoClass *klass)
<span class="lineNum">     940 </span>            : {
<span class="lineNum">     941 </span>            :         int max_set = 0;
<span class="lineNum">     942 </span>            :         gsize *bitmap;
<span class="lineNum">     943 </span>            :         gsize default_bitmap [4] = {0};
<span class="lineNum">     944 </span>            :         gsize *nrbitmap;
<span class="lineNum">     945 </span>            :         gsize default_nrbitmap [4] = {0};
<span class="lineNum">     946 </span>            :         int i, insecure = FALSE;
<span class="lineNum">     947 </span>            :                 return FALSE;
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span>            :         bitmap = compute_class_bitmap (klass, default_bitmap, sizeof (default_bitmap) * 8, 0, &amp;max_set, FALSE);
<span class="lineNum">     950 </span>            :         nrbitmap = compute_class_non_ref_bitmap (klass, default_nrbitmap, sizeof (default_nrbitmap) * 8, 0);
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span>            :         for (i = 0; i &lt;= max_set; i += sizeof (bitmap [0]) * 8) {
<span class="lineNum">     953 </span>            :                 int idx = i % (sizeof (bitmap [0]) * 8);
<span class="lineNum">     954 </span>            :                 if (bitmap [idx] &amp; nrbitmap [idx]) {
<span class="lineNum">     955 </span>            :                         insecure = TRUE;
<span class="lineNum">     956 </span>            :                         break;
<span class="lineNum">     957 </span>            :                 }
<span class="lineNum">     958 </span>            :         }
<span class="lineNum">     959 </span>            :         if (bitmap != default_bitmap)
<span class="lineNum">     960 </span>            :                 g_free (bitmap);
<span class="lineNum">     961 </span>            :         if (nrbitmap != default_nrbitmap)
<span class="lineNum">     962 </span>            :                 g_free (nrbitmap);
<span class="lineNum">     963 </span>            :         if (insecure) {
<span class="lineNum">     964 </span>            :                 g_print (&quot;class %s.%s in assembly %s has overlapping references\n&quot;, klass-&gt;name_space, klass-&gt;name, klass-&gt;image-&gt;name);
<span class="lineNum">     965 </span>            :                 return FALSE;
<span class="lineNum">     966 </span>            :         }
<span class="lineNum">     967 </span>            :         return insecure;
<span class="lineNum">     968 </span>            : }
<span class="lineNum">     969 </span>            : #endif
<a name="970"><span class="lineNum">     970 </span>            : </a>
<span class="lineNum">     971 </span>            : MonoString*
<span class="lineNum">     972 </span>            : ves_icall_string_alloc (int length)
<span class="lineNum">     973 </span>            : {
<span class="lineNum">     974 </span>            :         MonoError error;
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :         MonoString *str = mono_string_new_size_checked (mono_domain_get (), length, &amp;error);</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">     977 </span>            : 
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :         return str;</span>
<span class="lineNum">     979 </span>            : }
<span class="lineNum">     980 </span>            : 
<a name="981"><span class="lineNum">     981 </span>            : /* LOCKING: Acquires the loader lock */</a>
<span class="lineNum">     982 </span>            : void
<span class="lineNum">     983 </span>            : mono_class_compute_gc_descriptor (MonoClass *klass)
<span class="lineNum">     984 </span>            : {
<span class="lineNum">     985 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">     986 </span>            : 
<span class="lineNum">     987 </span><span class="lineCov">    5279592 :         int max_set = 0;</span>
<span class="lineNum">     988 </span>            :         gsize *bitmap;
<span class="lineNum">     989 </span><span class="lineCov">    5279592 :         gsize default_bitmap [4] = {0};</span>
<span class="lineNum">     990 </span>            :         static gboolean gcj_inited = FALSE;
<span class="lineNum">     991 </span>            :         MonoGCDescriptor gc_descr;
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineCov">    5279592 :         if (!gcj_inited) {</span>
<span class="lineNum">     994 </span><span class="lineCov">       3285 :                 mono_loader_lock ();</span>
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span><span class="lineCov">       3285 :                 mono_register_jit_icall (ves_icall_object_new_fast, &quot;ves_icall_object_new_fast&quot;, mono_create_icall_signature (&quot;object ptr&quot;), FALSE);</span>
<span class="lineNum">     997 </span><span class="lineCov">       3285 :                 mono_register_jit_icall (ves_icall_string_alloc, &quot;ves_icall_string_alloc&quot;, mono_create_icall_signature (&quot;object int&quot;), FALSE);</span>
<span class="lineNum">     998 </span>            : 
<span class="lineNum">     999 </span><span class="lineCov">       3285 :                 gcj_inited = TRUE;</span>
<span class="lineNum">    1000 </span><span class="lineCov">       3285 :                 mono_loader_unlock ();</span>
<span class="lineNum">    1001 </span><span class="lineCov">       3285 :         }</span>
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span><span class="lineCov">    5279592 :         if (!klass-&gt;inited)</span>
<span class="lineNum">    1004 </span><span class="lineCov">       3981 :                 mono_class_init (klass);</span>
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span><span class="lineCov">    5279592 :         if (klass-&gt;gc_descr_inited)</span>
<span class="lineNum">    1007 </span><span class="lineCov">     335386 :                 return;</span>
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">    4944206 :         bitmap = default_bitmap;</span>
<span class="lineNum">    1010 </span><span class="lineCov">    4944206 :         if (klass == mono_defaults.string_class) {</span>
<span class="lineNum">    1011 </span><span class="lineCov">       3285 :                 gc_descr = mono_gc_make_descr_for_string (bitmap, 2);</span>
<span class="lineNum">    1012 </span><span class="lineCov">    4944205 :         } else if (klass-&gt;rank) {</span>
<span class="lineNum">    1013 </span><span class="lineCov">     575674 :                 mono_class_compute_gc_descriptor (klass-&gt;element_class);</span>
<span class="lineNum">    1014 </span><span class="lineCov">     575674 :                 if (MONO_TYPE_IS_REFERENCE (&amp;klass-&gt;element_class-&gt;byval_arg)) {</span>
<span class="lineNum">    1015 </span><span class="lineCov">     185771 :                         gsize abm = 1;</span>
<span class="lineNum">    1016 </span><span class="lineCov">     185771 :                         gc_descr = mono_gc_make_descr_for_array (klass-&gt;byval_arg.type == MONO_TYPE_SZARRAY, &amp;abm, 1, sizeof (gpointer));</span>
<span class="lineNum">    1017 </span>            :                         /*printf (&quot;new array descriptor: 0x%x for %s.%s\n&quot;, class-&gt;gc_descr,
<span class="lineNum">    1018 </span>            :                                 class-&gt;name_space, class-&gt;name);*/
<span class="lineNum">    1019 </span><span class="lineCov">     185771 :                 } else {</span>
<span class="lineNum">    1020 </span>            :                         /* remove the object header */
<span class="lineNum">    1021 </span><span class="lineCov">     389903 :                         bitmap = compute_class_bitmap (klass-&gt;element_class, default_bitmap, sizeof (default_bitmap) * 8, - (int)(sizeof (MonoObject) / sizeof (gpointer)), &amp;max_set, FALSE);</span>
<span class="lineNum">    1022 </span><span class="lineCov">     389903 :                         gc_descr = mono_gc_make_descr_for_array (klass-&gt;byval_arg.type == MONO_TYPE_SZARRAY, bitmap, mono_array_element_size (klass) / sizeof (gpointer), mono_array_element_size (klass));</span>
<span class="lineNum">    1023 </span>            :                         /*printf (&quot;new vt array descriptor: 0x%x for %s.%s\n&quot;, class-&gt;gc_descr,
<span class="lineNum">    1024 </span>            :                                 class-&gt;name_space, class-&gt;name);*/
<span class="lineNum">    1025 </span><span class="lineCov">     389903 :                         if (bitmap != default_bitmap)</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                                 g_free (bitmap);</span>
<span class="lineNum">    1027 </span>            :                 }
<span class="lineNum">    1028 </span><span class="lineCov">     575674 :         } else {</span>
<span class="lineNum">    1029 </span>            :                 /*static int count = 0;
<span class="lineNum">    1030 </span>            :                 if (count++ &gt; 58)
<span class="lineNum">    1031 </span>            :                         return;*/
<span class="lineNum">    1032 </span><span class="lineCov">    4365246 :                 bitmap = compute_class_bitmap (klass, default_bitmap, sizeof (default_bitmap) * 8, 0, &amp;max_set, FALSE);</span>
<span class="lineNum">    1033 </span><span class="lineCov">    4365246 :                 gc_descr = mono_gc_make_descr_for_object (bitmap, max_set + 1, klass-&gt;instance_size);</span>
<span class="lineNum">    1034 </span>            :                 /*
<span class="lineNum">    1035 </span>            :                 if (class-&gt;gc_descr == MONO_GC_DESCRIPTOR_NULL)
<span class="lineNum">    1036 </span>            :                         g_print (&quot;disabling typed alloc (%d) for %s.%s\n&quot;, max_set, class-&gt;name_space, class-&gt;name);
<span class="lineNum">    1037 </span>            :                 */
<span class="lineNum">    1038 </span>            :                 /*printf (&quot;new descriptor: %p 0x%x for %s.%s\n&quot;, class-&gt;gc_descr, bitmap [0], class-&gt;name_space, class-&gt;name);*/
<span class="lineNum">    1039 </span><span class="lineCov">    4365246 :                 if (bitmap != default_bitmap)</span>
<span class="lineNum">    1040 </span><span class="lineCov">       1031 :                         g_free (bitmap);</span>
<span class="lineNum">    1041 </span>            :         }
<span class="lineNum">    1042 </span>            : 
<span class="lineNum">    1043 </span>            :         /* Publish the data */
<span class="lineNum">    1044 </span><span class="lineCov">    4944205 :         mono_loader_lock ();</span>
<span class="lineNum">    1045 </span><span class="lineCov">    4944205 :         klass-&gt;gc_descr = gc_descr;</span>
<span class="lineNum">    1046 </span><span class="lineCov">    4944205 :         mono_memory_barrier ();</span>
<span class="lineNum">    1047 </span><span class="lineCov">    4944205 :         klass-&gt;gc_descr_inited = TRUE;</span>
<span class="lineNum">    1048 </span><span class="lineCov">    4944205 :         mono_loader_unlock ();</span>
<span class="lineNum">    1049 </span><span class="lineCov">   10223797 : }</span>
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span>            : /**
<span class="lineNum">    1052 </span>            :  * field_is_special_static:
<span class="lineNum">    1053 </span>            :  * @fklass: The MonoClass to look up.
<span class="lineNum">    1054 </span>            :  * @field: The MonoClassField describing the field.
<span class="lineNum">    1055 </span>            :  *
<span class="lineNum">    1056 </span>            :  * Returns: SPECIAL_STATIC_THREAD if the field is thread static, SPECIAL_STATIC_CONTEXT if it is context static,
<span class="lineNum">    1057 </span>            :  * SPECIAL_STATIC_NONE otherwise.
<a name="1058"><span class="lineNum">    1058 </span>            :  */</a>
<span class="lineNum">    1059 </span>            : static gint32
<span class="lineNum">    1060 </span>            : field_is_special_static (MonoClass *fklass, MonoClassField *field)
<span class="lineNum">    1061 </span>            : {
<span class="lineNum">    1062 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1063 </span>            : 
<span class="lineNum">    1064 </span>            :         MonoError error;
<span class="lineNum">    1065 </span>            :         MonoCustomAttrInfo *ainfo;
<span class="lineNum">    1066 </span>            :         int i;
<span class="lineNum">    1067 </span><span class="lineCov">    9792590 :         ainfo = mono_custom_attrs_from_field_checked (fklass, field, &amp;error);</span>
<span class="lineNum">    1068 </span><span class="lineCov">    9792590 :         mono_error_cleanup (&amp;error); /* FIXME don't swallow the error? */</span>
<span class="lineNum">    1069 </span><span class="lineCov">    9792590 :         if (!ainfo)</span>
<span class="lineNum">    1070 </span><span class="lineCov">    9306209 :                 return FALSE;</span>
<span class="lineNum">    1071 </span><span class="lineCov">    1378950 :         for (i = 0; i &lt; ainfo-&gt;num_attrs; ++i) {</span>
<span class="lineNum">    1072 </span><span class="lineCov">     493939 :                 MonoClass *klass = ainfo-&gt;attrs [i].ctor-&gt;klass;</span>
<span class="lineNum">    1073 </span><span class="lineCov">     493939 :                 if (klass-&gt;image == mono_defaults.corlib) {</span>
<span class="lineNum">    1074 </span><span class="lineCov">     493939 :                         if (strcmp (klass-&gt;name, &quot;ThreadStaticAttribute&quot;) == 0) {</span>
<span class="lineNum">    1075 </span><span class="lineCov">     287288 :                                 mono_custom_attrs_free (ainfo);</span>
<span class="lineNum">    1076 </span><span class="lineCov">     287288 :                                 return SPECIAL_STATIC_THREAD;</span>
<span class="lineNum">    1077 </span>            :                         }
<span class="lineNum">    1078 </span><span class="lineCov">     206649 :                         else if (strcmp (klass-&gt;name, &quot;ContextStaticAttribute&quot;) == 0) {</span>
<span class="lineNum">    1079 </span><span class="lineCov">       3571 :                                 mono_custom_attrs_free (ainfo);</span>
<span class="lineNum">    1080 </span><span class="lineCov">       3571 :                                 return SPECIAL_STATIC_CONTEXT;</span>
<span class="lineNum">    1081 </span>            :                         }
<span class="lineNum">    1082 </span><span class="lineCov">     203077 :                 }</span>
<span class="lineNum">    1083 </span><span class="lineCov">     203078 :         }</span>
<span class="lineNum">    1084 </span><span class="lineCov">     195536 :         mono_custom_attrs_free (ainfo);</span>
<span class="lineNum">    1085 </span><span class="lineCov">     195536 :         return SPECIAL_STATIC_NONE;</span>
<span class="lineNum">    1086 </span><span class="lineCov">    9792449 : }</span>
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span>            : #define rot(x,k) (((x)&lt;&lt;(k)) | ((x)&gt;&gt;(32-(k))))
<span class="lineNum">    1089 </span>            : #define mix(a,b,c) { \
<span class="lineNum">    1090 </span>            :         a -= c;  a ^= rot(c, 4);  c += b; \
<span class="lineNum">    1091 </span>            :         b -= a;  b ^= rot(a, 6);  a += c; \
<span class="lineNum">    1092 </span>            :         c -= b;  c ^= rot(b, 8);  b += a; \
<span class="lineNum">    1093 </span>            :         a -= c;  a ^= rot(c,16);  c += b; \
<span class="lineNum">    1094 </span>            :         b -= a;  b ^= rot(a,19);  a += c; \
<span class="lineNum">    1095 </span>            :         c -= b;  c ^= rot(b, 4);  b += a; \
<span class="lineNum">    1096 </span>            : }
<span class="lineNum">    1097 </span>            : #define final(a,b,c) { \
<span class="lineNum">    1098 </span>            :         c ^= b; c -= rot(b,14); \
<span class="lineNum">    1099 </span>            :         a ^= c; a -= rot(c,11); \
<span class="lineNum">    1100 </span>            :         b ^= a; b -= rot(a,25); \
<span class="lineNum">    1101 </span>            :         c ^= b; c -= rot(b,16); \
<span class="lineNum">    1102 </span>            :         a ^= c; a -= rot(c,4);  \
<span class="lineNum">    1103 </span>            :         b ^= a; b -= rot(a,14); \
<span class="lineNum">    1104 </span>            :         c ^= b; c -= rot(b,24); \
<span class="lineNum">    1105 </span>            : }
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span>            : /*
<span class="lineNum">    1108 </span>            :  * mono_method_get_imt_slot:
<span class="lineNum">    1109 </span>            :  *
<span class="lineNum">    1110 </span>            :  *   The IMT slot is embedded into AOTed code, so this must return the same value
<span class="lineNum">    1111 </span>            :  * for the same method across all executions. This means:
<span class="lineNum">    1112 </span>            :  * - pointers shouldn't be used as hash values.
<span class="lineNum">    1113 </span>            :  * - mono_metadata_str_hash () should be used for hashing strings.
<a name="1114"><span class="lineNum">    1114 </span>            :  */</a>
<span class="lineNum">    1115 </span>            : guint32
<span class="lineNum">    1116 </span>            : mono_method_get_imt_slot (MonoMethod *method)
<span class="lineNum">    1117 </span>            : {
<span class="lineNum">    1118 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span>            :         MonoMethodSignature *sig;
<span class="lineNum">    1121 </span>            :         int hashes_count;
<span class="lineNum">    1122 </span>            :         guint32 *hashes_start, *hashes;
<span class="lineNum">    1123 </span>            :         guint32 a, b, c;
<span class="lineNum">    1124 </span>            :         int i;
<span class="lineNum">    1125 </span>            : 
<span class="lineNum">    1126 </span>            :         /* This can be used to stress tests the collision code */
<span class="lineNum">    1127 </span>            :         //return 0;
<span class="lineNum">    1128 </span>            : 
<span class="lineNum">    1129 </span>            :         /*
<span class="lineNum">    1130 </span>            :          * We do this to simplify generic sharing.  It will hurt
<span class="lineNum">    1131 </span>            :          * performance in cases where a class implements two different
<span class="lineNum">    1132 </span>            :          * instantiations of the same generic interface.
<span class="lineNum">    1133 </span>            :          * The code in build_imt_slots () depends on this.
<span class="lineNum">    1134 </span>            :          */
<span class="lineNum">    1135 </span><span class="lineCov">   35939379 :         if (method-&gt;is_inflated)</span>
<span class="lineNum">    1136 </span><span class="lineCov">    2119544 :                 method = ((MonoMethodInflated*)method)-&gt;declaring;</span>
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span><span class="lineCov">   35939409 :         sig = mono_method_signature (method);</span>
<span class="lineNum">    1139 </span><span class="lineCov">   35939409 :         hashes_count = sig-&gt;param_count + 4;</span>
<span class="lineNum">    1140 </span><span class="lineCov">   35939409 :         hashes_start = (guint32 *)malloc (hashes_count * sizeof (guint32));</span>
<span class="lineNum">    1141 </span><span class="lineCov">   35939409 :         hashes = hashes_start;</span>
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineCov">   35939409 :         if (! MONO_CLASS_IS_INTERFACE (method-&gt;klass)) {</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :                 g_error (&quot;mono_method_get_imt_slot: %s.%s.%s is not an interface MonoMethod&quot;,</span>
<span class="lineNum">    1145 </span>            :                                 method-&gt;klass-&gt;name_space, method-&gt;klass-&gt;name, method-&gt;name);
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1147 </span>            :         
<span class="lineNum">    1148 </span>            :         /* Initialize hashes */
<span class="lineNum">    1149 </span><span class="lineCov">   35939323 :         hashes [0] = mono_metadata_str_hash (method-&gt;klass-&gt;name);</span>
<span class="lineNum">    1150 </span><span class="lineCov">   35939323 :         hashes [1] = mono_metadata_str_hash (method-&gt;klass-&gt;name_space);</span>
<span class="lineNum">    1151 </span><span class="lineCov">   35939323 :         hashes [2] = mono_metadata_str_hash (method-&gt;name);</span>
<span class="lineNum">    1152 </span><span class="lineCov">   35939323 :         hashes [3] = mono_metadata_type_hash (sig-&gt;ret);</span>
<span class="lineNum">    1153 </span><span class="lineCov">  100736553 :         for (i = 0; i &lt; sig-&gt;param_count; i++) {</span>
<span class="lineNum">    1154 </span><span class="lineCov">   14428837 :                 hashes [4 + i] = mono_metadata_type_hash (sig-&gt;params [i]);</span>
<span class="lineNum">    1155 </span><span class="lineCov">   14428837 :         }</span>
<span class="lineNum">    1156 </span>            : 
<span class="lineNum">    1157 </span>            :         /* Setup internal state */
<span class="lineNum">    1158 </span><span class="lineCov">   35939424 :         a = b = c = 0xdeadbeef + (((guint32)hashes_count)&lt;&lt;2);</span>
<span class="lineNum">    1159 </span>            : 
<span class="lineNum">    1160 </span>            :         /* Handle most of the hashes */
<span class="lineNum">    1161 </span><span class="lineCov">  145559150 :         while (hashes_count &gt; 3) {</span>
<span class="lineNum">    1162 </span><span class="lineCov">   36840072 :                 a += hashes [0];</span>
<span class="lineNum">    1163 </span><span class="lineCov">   36840072 :                 b += hashes [1];</span>
<span class="lineNum">    1164 </span><span class="lineCov">   36840072 :                 c += hashes [2];</span>
<span class="lineNum">    1165 </span><span class="lineCov">   36840072 :                 mix (a,b,c);</span>
<span class="lineNum">    1166 </span><span class="lineCov">   36840072 :                 hashes_count -= 3;</span>
<span class="lineNum">    1167 </span><span class="lineCov">   36840072 :                 hashes += 3;</span>
<span class="lineNum">    1168 </span>            :         }
<span class="lineNum">    1169 </span>            : 
<span class="lineNum">    1170 </span>            :         /* Handle the last 3 hashes (all the case statements fall through) */
<span class="lineNum">    1171 </span><span class="lineCov">  119545702 :         switch (hashes_count) { </span>
<span class="lineNum">    1172 </span><span class="lineCov">    1972188 :         case 3 : c += hashes [2];</span>
<span class="lineNum">    1173 </span><span class="lineCov">    9754924 :         case 2 : b += hashes [1];</span>
<span class="lineNum">    1174 </span><span class="lineCov">   35939460 :         case 1 : a += hashes [0];</span>
<span class="lineNum">    1175 </span><span class="lineCov">   35939460 :                 final (a,b,c);</span>
<span class="lineNum">    1176 </span>            :         case 0: /* nothing left to add */
<span class="lineNum">    1177 </span><span class="lineCov">   35939717 :                 break;</span>
<span class="lineNum">    1178 </span>            :         }
<span class="lineNum">    1179 </span>            :         
<span class="lineNum">    1180 </span><span class="lineCov">   35939603 :         g_free (hashes_start);</span>
<span class="lineNum">    1181 </span>            :         /* Report the result */
<span class="lineNum">    1182 </span><span class="lineCov">   35939603 :         return c % MONO_IMT_SIZE;</span>
<span class="lineNum">    1183 </span>            : }
<span class="lineNum">    1184 </span>            : #undef rot
<span class="lineNum">    1185 </span>            : #undef mix
<span class="lineNum">    1186 </span>            : #undef final
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span>            : #define DEBUG_IMT 0
<a name="1189"><span class="lineNum">    1189 </span>            : </a>
<span class="lineNum">    1190 </span>            : static void
<span class="lineNum">    1191 </span>            : add_imt_builder_entry (MonoImtBuilderEntry **imt_builder, MonoMethod *method, guint32 *imt_collisions_bitmap, int vtable_slot, int slot_num) {
<span class="lineNum">    1192 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1193 </span>            : 
<span class="lineNum">    1194 </span><span class="lineCov">   28772732 :         guint32 imt_slot = mono_method_get_imt_slot (method);</span>
<span class="lineNum">    1195 </span>            :         MonoImtBuilderEntry *entry;
<span class="lineNum">    1196 </span>            : 
<span class="lineNum">    1197 </span><span class="lineCov">   57450932 :         if (slot_num &gt;= 0 &amp;&amp; imt_slot != slot_num) {</span>
<span class="lineNum">    1198 </span>            :                 /* we build just a single imt slot and this is not it */
<span class="lineNum">    1199 </span><span class="lineCov">   26126850 :                 return;</span>
<span class="lineNum">    1200 </span>            :         }
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span><span class="lineCov">    2645882 :         entry = (MonoImtBuilderEntry *)g_malloc0 (sizeof (MonoImtBuilderEntry));</span>
<span class="lineNum">    1203 </span><span class="lineCov">    2645882 :         entry-&gt;key = method;</span>
<span class="lineNum">    1204 </span><span class="lineCov">    2645882 :         entry-&gt;value.vtable_slot = vtable_slot;</span>
<span class="lineNum">    1205 </span><span class="lineCov">    2645882 :         entry-&gt;next = imt_builder [imt_slot];</span>
<span class="lineNum">    1206 </span><span class="lineCov">    2645882 :         if (imt_builder [imt_slot] != NULL) {</span>
<span class="lineNum">    1207 </span><span class="lineCov">    1662255 :                 entry-&gt;children = imt_builder [imt_slot]-&gt;children + 1;</span>
<span class="lineNum">    1208 </span><span class="lineCov">    1662255 :                 if (entry-&gt;children == 1) {</span>
<span class="lineNum">    1209 </span><span class="lineCov">     525596 :                         mono_stats.imt_slots_with_collisions++;</span>
<span class="lineNum">    1210 </span><span class="lineCov">     525596 :                         *imt_collisions_bitmap |= (1 &lt;&lt; imt_slot);</span>
<span class="lineNum">    1211 </span><span class="lineCov">     525596 :                 }</span>
<span class="lineNum">    1212 </span><span class="lineCov">    1662255 :         } else {</span>
<span class="lineNum">    1213 </span><span class="lineCov">     983627 :                 entry-&gt;children = 0;</span>
<span class="lineNum">    1214 </span><span class="lineCov">     983627 :                 mono_stats.imt_used_slots++;</span>
<span class="lineNum">    1215 </span>            :         }
<span class="lineNum">    1216 </span><span class="lineCov">    2645882 :         imt_builder [imt_slot] = entry;</span>
<span class="lineNum">    1217 </span>            : #if DEBUG_IMT
<span class="lineNum">    1218 </span>            :         {
<span class="lineNum">    1219 </span>            :         char *method_name = mono_method_full_name (method, TRUE);
<span class="lineNum">    1220 </span>            :         printf (&quot;Added IMT slot for method (%p) %s: imt_slot = %d, vtable_slot = %d, colliding with other %d entries\n&quot;,
<span class="lineNum">    1221 </span>            :                         method, method_name, imt_slot, vtable_slot, entry-&gt;children);
<span class="lineNum">    1222 </span>            :         g_free (method_name);
<span class="lineNum">    1223 </span>            :         }
<span class="lineNum">    1224 </span>            : #endif
<span class="lineNum">    1225 </span><span class="lineCov">   31418614 : }</span>
<span class="lineNum">    1226 </span>            : 
<span class="lineNum">    1227 </span>            : #if DEBUG_IMT
<span class="lineNum">    1228 </span>            : static void
<span class="lineNum">    1229 </span>            : print_imt_entry (const char* message, MonoImtBuilderEntry *e, int num) {
<span class="lineNum">    1230 </span>            :         if (e != NULL) {
<span class="lineNum">    1231 </span>            :                 MonoMethod *method = e-&gt;key;
<span class="lineNum">    1232 </span>            :                 printf (&quot;  * %s [%d]: (%p) '%s.%s.%s'\n&quot;,
<span class="lineNum">    1233 </span>            :                                 message,
<span class="lineNum">    1234 </span>            :                                 num,
<span class="lineNum">    1235 </span>            :                                 method,
<span class="lineNum">    1236 </span>            :                                 method-&gt;klass-&gt;name_space,
<span class="lineNum">    1237 </span>            :                                 method-&gt;klass-&gt;name,
<span class="lineNum">    1238 </span>            :                                 method-&gt;name);
<span class="lineNum">    1239 </span>            :         } else {
<span class="lineNum">    1240 </span>            :                 printf (&quot;  * %s: NULL\n&quot;, message);
<span class="lineNum">    1241 </span>            :         }
<span class="lineNum">    1242 </span>            : }
<span class="lineNum">    1243 </span>            : #endif
<a name="1244"><span class="lineNum">    1244 </span>            : </a>
<span class="lineNum">    1245 </span>            : static int
<span class="lineNum">    1246 </span>            : compare_imt_builder_entries (const void *p1, const void *p2) {
<span class="lineNum">    1247 </span><span class="lineCov">    3679694 :         MonoImtBuilderEntry *e1 = *(MonoImtBuilderEntry**) p1;</span>
<span class="lineNum">    1248 </span><span class="lineCov">    3679694 :         MonoImtBuilderEntry *e2 = *(MonoImtBuilderEntry**) p2;</span>
<span class="lineNum">    1249 </span>            :         
<span class="lineNum">    1250 </span><span class="lineCov">   11039082 :         return (e1-&gt;key &lt; e2-&gt;key) ? -1 : ((e1-&gt;key &gt; e2-&gt;key) ? 1 : 0);</span>
<span class="lineNum">    1251 </span>            : }
<a name="1252"><span class="lineNum">    1252 </span>            : </a>
<span class="lineNum">    1253 </span>            : static int
<span class="lineNum">    1254 </span>            : imt_emit_ir (MonoImtBuilderEntry **sorted_array, int start, int end, GPtrArray *out_array)
<span class="lineNum">    1255 </span>            : {
<span class="lineNum">    1256 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span><span class="lineCov">    1746263 :         int count = end - start;</span>
<span class="lineNum">    1259 </span><span class="lineCov">    1746263 :         int chunk_start = out_array-&gt;len;</span>
<span class="lineNum">    1260 </span><span class="lineCov">    1746263 :         if (count &lt; 4) {</span>
<span class="lineNum">    1261 </span>            :                 int i;
<span class="lineNum">    1262 </span><span class="lineCov">    7894360 :                 for (i = start; i &lt; end; ++i) {</span>
<span class="lineNum">    1263 </span><span class="lineCov">    2617190 :                         MonoIMTCheckItem *item = g_new0 (MonoIMTCheckItem, 1);</span>
<span class="lineNum">    1264 </span><span class="lineCov">    2617190 :                         item-&gt;key = sorted_array [i]-&gt;key;</span>
<span class="lineNum">    1265 </span><span class="lineCov">    2617190 :                         item-&gt;value = sorted_array [i]-&gt;value;</span>
<span class="lineNum">    1266 </span><span class="lineCov">    2617190 :                         item-&gt;has_target_code = sorted_array [i]-&gt;has_target_code;</span>
<span class="lineNum">    1267 </span><span class="lineCov">    2617190 :                         item-&gt;is_equals = TRUE;</span>
<span class="lineNum">    1268 </span><span class="lineCov">    2617190 :                         if (i &lt; end - 1)</span>
<span class="lineNum">    1269 </span><span class="lineCov">    1287200 :                                 item-&gt;check_target_idx = out_array-&gt;len + 1;</span>
<span class="lineNum">    1270 </span>            :                         else
<span class="lineNum">    1271 </span><span class="lineCov">    1329990 :                                 item-&gt;check_target_idx = 0;</span>
<span class="lineNum">    1272 </span><span class="lineCov">    2617190 :                         g_ptr_array_add (out_array, item);</span>
<span class="lineNum">    1273 </span><span class="lineCov">    2617190 :                 }</span>
<span class="lineNum">    1274 </span><span class="lineCov">    1329990 :         } else {</span>
<span class="lineNum">    1275 </span><span class="lineCov">     416273 :                 int middle = start + count / 2;</span>
<span class="lineNum">    1276 </span><span class="lineCov">     416273 :                 MonoIMTCheckItem *item = g_new0 (MonoIMTCheckItem, 1);</span>
<span class="lineNum">    1277 </span>            : 
<span class="lineNum">    1278 </span><span class="lineCov">     416273 :                 item-&gt;key = sorted_array [middle]-&gt;key;</span>
<span class="lineNum">    1279 </span><span class="lineCov">     416273 :                 item-&gt;is_equals = FALSE;</span>
<span class="lineNum">    1280 </span><span class="lineCov">     416273 :                 g_ptr_array_add (out_array, item);</span>
<span class="lineNum">    1281 </span><span class="lineCov">     416273 :                 imt_emit_ir (sorted_array, start, middle, out_array);</span>
<span class="lineNum">    1282 </span><span class="lineCov">     416273 :                 item-&gt;check_target_idx = imt_emit_ir (sorted_array, middle, end, out_array);</span>
<span class="lineNum">    1283 </span>            :         }
<span class="lineNum">    1284 </span><span class="lineCov">    1746263 :         return chunk_start;</span>
<span class="lineNum">    1285 </span>            : }
<a name="1286"><span class="lineNum">    1286 </span>            : </a>
<span class="lineNum">    1287 </span>            : static GPtrArray*
<span class="lineNum">    1288 </span>            : imt_sort_slot_entries (MonoImtBuilderEntry *entries) {
<span class="lineNum">    1289 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span><span class="lineCov">     913717 :         int number_of_entries = entries-&gt;children + 1;</span>
<span class="lineNum">    1292 </span><span class="lineCov">     913717 :         MonoImtBuilderEntry **sorted_array = (MonoImtBuilderEntry **)malloc (sizeof (MonoImtBuilderEntry*) * number_of_entries);</span>
<span class="lineNum">    1293 </span><span class="lineCov">     913717 :         GPtrArray *result = g_ptr_array_new ();</span>
<span class="lineNum">    1294 </span>            :         MonoImtBuilderEntry *current_entry;
<span class="lineNum">    1295 </span>            :         int i;
<span class="lineNum">    1296 </span>            :         
<span class="lineNum">    1297 </span><span class="lineCov">    7061814 :         for (current_entry = entries, i = 0; current_entry != NULL; current_entry = current_entry-&gt;next, i++) {</span>
<span class="lineNum">    1298 </span><span class="lineCov">    2617190 :                 sorted_array [i] = current_entry;</span>
<span class="lineNum">    1299 </span><span class="lineCov">    2617190 :         }</span>
<span class="lineNum">    1300 </span><span class="lineCov">     913717 :         qsort (sorted_array, number_of_entries, sizeof (MonoImtBuilderEntry*), compare_imt_builder_entries);</span>
<span class="lineNum">    1301 </span>            : 
<span class="lineNum">    1302 </span>            :         /*for (i = 0; i &lt; number_of_entries; i++) {
<span class="lineNum">    1303 </span>            :                 print_imt_entry (&quot; sorted array:&quot;, sorted_array [i], i);
<span class="lineNum">    1304 </span>            :         }*/
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineCov">     913717 :         imt_emit_ir (sorted_array, 0, number_of_entries, result);</span>
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span><span class="lineCov">     913717 :         g_free (sorted_array);</span>
<span class="lineNum">    1309 </span><span class="lineCov">     913717 :         return result;</span>
<span class="lineNum">    1310 </span>            : }
<a name="1311"><span class="lineNum">    1311 </span>            : </a>
<span class="lineNum">    1312 </span>            : static gpointer
<span class="lineNum">    1313 </span>            : initialize_imt_slot (MonoVTable *vtable, MonoDomain *domain, MonoImtBuilderEntry *imt_builder_entry, gpointer fail_tramp)
<span class="lineNum">    1314 </span>            : {
<span class="lineNum">    1315 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span><span class="lineCov">     986074 :         if (imt_builder_entry != NULL) {</span>
<span class="lineNum">    1318 </span><span class="lineCov">    1506995 :                 if (imt_builder_entry-&gt;children == 0 &amp;&amp; !fail_tramp &amp;&amp; !always_build_imt_trampolines) {</span>
<span class="lineNum">    1319 </span>            :                         /* No collision, return the vtable slot contents */
<span class="lineNum">    1320 </span><span class="lineCov">      77596 :                         return vtable-&gt;vtable [imt_builder_entry-&gt;value.vtable_slot];</span>
<span class="lineNum">    1321 </span>            :                 } else {
<span class="lineNum">    1322 </span>            :                         /* Collision, build the trampoline */
<span class="lineNum">    1323 </span><span class="lineCov">     906061 :                         GPtrArray *imt_ir = imt_sort_slot_entries (imt_builder_entry);</span>
<span class="lineNum">    1324 </span>            :                         gpointer result;
<span class="lineNum">    1325 </span>            :                         int i;
<span class="lineNum">    1326 </span><span class="lineCov">    1812122 :                         result = imt_trampoline_builder (vtable, domain,</span>
<span class="lineNum">    1327 </span><span class="lineCov">     906061 :                                 (MonoIMTCheckItem**)imt_ir-&gt;pdata, imt_ir-&gt;len, fail_tramp);</span>
<span class="lineNum">    1328 </span><span class="lineCov">    7858712 :                         for (i = 0; i &lt; imt_ir-&gt;len; ++i)</span>
<span class="lineNum">    1329 </span><span class="lineCov">    3023295 :                                 g_free (g_ptr_array_index (imt_ir, i));</span>
<span class="lineNum">    1330 </span><span class="lineCov">     906061 :                         g_ptr_array_free (imt_ir, TRUE);</span>
<span class="lineNum">    1331 </span><span class="lineCov">     906061 :                         return result;</span>
<span class="lineNum">    1332 </span>            :                 }
<span class="lineNum">    1333 </span>            :         } else {
<span class="lineNum">    1334 </span><span class="lineCov">       2417 :                 if (fail_tramp)</span>
<span class="lineNum">    1335 </span><span class="lineCov">        282 :                         return fail_tramp;</span>
<span class="lineNum">    1336 </span>            :                 else
<span class="lineNum">    1337 </span>            :                         /* Empty slot */
<span class="lineNum">    1338 </span><span class="lineCov">       2135 :                         return NULL;</span>
<span class="lineNum">    1339 </span>            :         }
<span class="lineNum">    1340 </span><span class="lineCov">     986074 : }</span>
<span class="lineNum">    1341 </span>            : 
<span class="lineNum">    1342 </span>            : static MonoImtBuilderEntry*
<span class="lineNum">    1343 </span>            : get_generic_virtual_entries (MonoDomain *domain, gpointer *vtable_slot);
<span class="lineNum">    1344 </span>            : 
<span class="lineNum">    1345 </span>            : /*
<span class="lineNum">    1346 </span>            :  * LOCKING: requires the loader and domain locks.
<span class="lineNum">    1347 </span>            :  *
<a name="1348"><span class="lineNum">    1348 </span>            : */</a>
<span class="lineNum">    1349 </span>            : static void
<span class="lineNum">    1350 </span>            : build_imt_slots (MonoClass *klass, MonoVTable *vt, MonoDomain *domain, gpointer* imt, GSList *extra_interfaces, int slot_num)
<span class="lineNum">    1351 </span>            : {
<span class="lineNum">    1352 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span>            :         int i;
<span class="lineNum">    1355 </span>            :         GSList *list_item;
<span class="lineNum">    1356 </span><span class="lineCov">     972646 :         guint32 imt_collisions_bitmap = 0;</span>
<span class="lineNum">    1357 </span><span class="lineCov">     972646 :         MonoImtBuilderEntry **imt_builder = (MonoImtBuilderEntry **)calloc (MONO_IMT_SIZE, sizeof (MonoImtBuilderEntry*));</span>
<span class="lineNum">    1358 </span><span class="lineCov">     972646 :         int method_count = 0;</span>
<span class="lineNum">    1359 </span><span class="lineCov">     972646 :         gboolean record_method_count_for_max_collisions = FALSE;</span>
<span class="lineNum">    1360 </span><span class="lineCov">     972646 :         gboolean has_generic_virtual = FALSE, has_variant_iface = FALSE;</span>
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span>            : #if DEBUG_IMT
<span class="lineNum">    1363 </span>            :         printf (&quot;Building IMT for class %s.%s slot %d\n&quot;, klass-&gt;name_space, klass-&gt;name, slot_num);
<span class="lineNum">    1364 </span>            : #endif
<span class="lineNum">    1365 </span><span class="lineCov">   15425584 :         for (i = 0; i &lt; klass-&gt;interface_offsets_count; ++i) {</span>
<span class="lineNum">    1366 </span><span class="lineCov">    6740146 :                 MonoClass *iface = klass-&gt;interfaces_packed [i];</span>
<span class="lineNum">    1367 </span><span class="lineCov">    6740146 :                 int interface_offset = klass-&gt;interface_offsets_packed [i];</span>
<span class="lineNum">    1368 </span>            :                 int method_slot_in_interface, vt_slot;
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span><span class="lineCov">    6740146 :                 if (mono_class_has_variant_generic_params (iface))</span>
<span class="lineNum">    1371 </span><span class="lineCov">    1024856 :                         has_variant_iface = TRUE;</span>
<span class="lineNum">    1372 </span>            : 
<span class="lineNum">    1373 </span><span class="lineCov">    6740146 :                 mono_class_setup_methods (iface);</span>
<span class="lineNum">    1374 </span><span class="lineCov">    6740146 :                 vt_slot = interface_offset;</span>
<span class="lineNum">    1375 </span><span class="lineCov">    6740146 :                 int mcount = mono_class_get_method_count (iface);</span>
<span class="lineNum">    1376 </span><span class="lineCov">   77783026 :                 for (method_slot_in_interface = 0; method_slot_in_interface &lt; mcount; method_slot_in_interface++) {</span>
<span class="lineNum">    1377 </span>            :                         MonoMethod *method;
<span class="lineNum">    1378 </span>            : 
<span class="lineNum">    1379 </span><span class="lineCov">   64298579 :                         if (slot_num &gt;= 0 &amp;&amp; mono_class_is_ginst (iface)) {</span>
<span class="lineNum">    1380 </span>            :                                 /*
<span class="lineNum">    1381 </span>            :                                  * The imt slot of the method is the same as for its declaring method,
<span class="lineNum">    1382 </span>            :                                  * see the comment in mono_method_get_imt_slot (), so we can
<span class="lineNum">    1383 </span>            :                                  * avoid inflating methods which will be discarded by 
<span class="lineNum">    1384 </span>            :                                  * add_imt_builder_entry anyway.
<span class="lineNum">    1385 </span>            :                                  */
<span class="lineNum">    1386 </span><span class="lineCov">    3811670 :                                 method = mono_class_get_method_by_index (mono_class_get_generic_class (iface)-&gt;container_class, method_slot_in_interface);</span>
<span class="lineNum">    1387 </span><span class="lineCov">    3811670 :                                 if (mono_method_get_imt_slot (method) != slot_num) {</span>
<span class="lineNum">    1388 </span><span class="lineCov">    3236930 :                                         vt_slot ++;</span>
<span class="lineNum">    1389 </span><span class="lineCov">    3236930 :                                         continue;</span>
<span class="lineNum">    1390 </span>            :                                 }
<span class="lineNum">    1391 </span><span class="lineCov">     574740 :                         }</span>
<span class="lineNum">    1392 </span><span class="lineCov">   28914437 :                         method = mono_class_get_method_by_index (iface, method_slot_in_interface);</span>
<span class="lineNum">    1393 </span><span class="lineCov">   28914437 :                         if (method-&gt;is_generic) {</span>
<span class="lineNum">    1394 </span><span class="lineCov">     232083 :                                 has_generic_virtual = TRUE;</span>
<span class="lineNum">    1395 </span><span class="lineCov">     232083 :                                 vt_slot ++;</span>
<span class="lineNum">    1396 </span><span class="lineCov">     232083 :                                 continue;</span>
<span class="lineNum">    1397 </span>            :                         }
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span><span class="lineCov">   28682354 :                         if (!(method-&gt;flags &amp; METHOD_ATTRIBUTE_STATIC)) {</span>
<span class="lineNum">    1400 </span><span class="lineCov">   28682354 :                                 add_imt_builder_entry (imt_builder, method, &amp;imt_collisions_bitmap, vt_slot, slot_num);</span>
<span class="lineNum">    1401 </span><span class="lineCov">   28682354 :                                 vt_slot ++;</span>
<span class="lineNum">    1402 </span><span class="lineCov">   28682354 :                         }</span>
<span class="lineNum">    1403 </span><span class="lineCov">   28682354 :                 }</span>
<span class="lineNum">    1404 </span><span class="lineCov">    6740146 :         }</span>
<span class="lineNum">    1405 </span><span class="lineCov">     972646 :         if (extra_interfaces) {</span>
<span class="lineNum">    1406 </span><span class="lineCov">        604 :                 int interface_offset = klass-&gt;vtable_size;</span>
<span class="lineNum">    1407 </span>            : 
<span class="lineNum">    1408 </span><span class="lineCov">     181820 :                 for (list_item = extra_interfaces; list_item != NULL; list_item=list_item-&gt;next) {</span>
<span class="lineNum">    1409 </span><span class="lineCov">      90306 :                         MonoClass* iface = (MonoClass *)list_item-&gt;data;</span>
<span class="lineNum">    1410 </span>            :                         int method_slot_in_interface;
<span class="lineNum">    1411 </span><span class="lineCov">      90306 :                         int mcount = mono_class_get_method_count (iface);</span>
<span class="lineNum">    1412 </span><span class="lineCov">     361368 :                         for (method_slot_in_interface = 0; method_slot_in_interface &lt; mcount; method_slot_in_interface++) {</span>
<span class="lineNum">    1413 </span><span class="lineCov">      90378 :                                 MonoMethod *method = mono_class_get_method_by_index (iface, method_slot_in_interface);</span>
<span class="lineNum">    1414 </span>            : 
<span class="lineNum">    1415 </span><span class="lineCov">      90378 :                                 if (method-&gt;is_generic)</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :                                         has_generic_virtual = TRUE;</span>
<span class="lineNum">    1417 </span><span class="lineCov">      90378 :                                 add_imt_builder_entry (imt_builder, method, &amp;imt_collisions_bitmap, interface_offset + method_slot_in_interface, slot_num);</span>
<span class="lineNum">    1418 </span><span class="lineCov">      90378 :                         }</span>
<span class="lineNum">    1419 </span><span class="lineCov">      90306 :                         interface_offset += mcount;</span>
<span class="lineNum">    1420 </span><span class="lineCov">      90306 :                 }</span>
<span class="lineNum">    1421 </span><span class="lineCov">        604 :         }</span>
<span class="lineNum">    1422 </span><span class="lineCov">   38905840 :         for (i = 0; i &lt; MONO_IMT_SIZE; ++i) {</span>
<span class="lineNum">    1423 </span>            :                 /* overwrite the imt slot only if we're building all the entries or if 
<span class="lineNum">    1424 </span>            :                  * we're building this specific one
<span class="lineNum">    1425 </span>            :                  */
<span class="lineNum">    1426 </span><span class="lineCov">   36946374 :                 if (slot_num &lt; 0 || i == slot_num) {</span>
<span class="lineNum">    1427 </span><span class="lineCov">     986074 :                         MonoImtBuilderEntry *entries = get_generic_virtual_entries (domain, &amp;imt [i]);</span>
<span class="lineNum">    1428 </span>            : 
<span class="lineNum">    1429 </span><span class="lineCov">     986074 :                         if (entries) {</span>
<span class="lineNum">    1430 </span><span class="lineCov">      15614 :                                 if (imt_builder [i]) {</span>
<span class="lineNum">    1431 </span>            :                                         MonoImtBuilderEntry *entry;
<span class="lineNum">    1432 </span>            : 
<span class="lineNum">    1433 </span>            :                                         /* Link entries with imt_builder [i] */
<span class="lineNum">    1434 </span><span class="lineCov">      77364 :                                         for (entry = entries; entry-&gt;next; entry = entry-&gt;next) {</span>
<span class="lineNum">    1435 </span>            : #if DEBUG_IMT
<span class="lineNum">    1436 </span>            :                                                 MonoMethod *method = (MonoMethod*)entry-&gt;key;
<span class="lineNum">    1437 </span>            :                                                 char *method_name = mono_method_full_name (method, TRUE);
<span class="lineNum">    1438 </span>            :                                                 printf (&quot;Added extra entry for method (%p) %s: imt_slot = %d\n&quot;, method, method_name, i);
<span class="lineNum">    1439 </span>            :                                                 g_free (method_name);
<span class="lineNum">    1440 </span>            : #endif
<span class="lineNum">    1441 </span><span class="lineCov">      23098 :                                         }</span>
<span class="lineNum">    1442 </span><span class="lineCov">      15584 :                                         entry-&gt;next = imt_builder [i];</span>
<span class="lineNum">    1443 </span><span class="lineCov">      15584 :                                         entries-&gt;children += imt_builder [i]-&gt;children + 1;</span>
<span class="lineNum">    1444 </span><span class="lineCov">      15584 :                                 }</span>
<span class="lineNum">    1445 </span><span class="lineCov">      15614 :                                 imt_builder [i] = entries;</span>
<span class="lineNum">    1446 </span><span class="lineCov">      15614 :                         }</span>
<span class="lineNum">    1447 </span>            : 
<span class="lineNum">    1448 </span><span class="lineCov">    1740047 :                         if (has_generic_virtual || has_variant_iface) {</span>
<span class="lineNum">    1449 </span>            :                                 /*
<span class="lineNum">    1450 </span>            :                                  * There might be collisions later when the the trampoline is expanded.
<span class="lineNum">    1451 </span>            :                                  */
<span class="lineNum">    1452 </span><span class="lineCov">     842598 :                                 imt_collisions_bitmap |= (1 &lt;&lt; i);</span>
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span>            :                                 /* 
<span class="lineNum">    1455 </span>            :                                  * The IMT trampoline might be called with an instance of one of the 
<span class="lineNum">    1456 </span>            :                                  * generic virtual methods, so has to fallback to the IMT trampoline.
<span class="lineNum">    1457 </span>            :                                  */
<span class="lineNum">    1458 </span><span class="lineCov">     842598 :                                 imt [i] = initialize_imt_slot (vt, domain, imt_builder [i], callbacks.get_imt_trampoline (vt, i));</span>
<span class="lineNum">    1459 </span><span class="lineCov">     842598 :                         } else {</span>
<span class="lineNum">    1460 </span><span class="lineCov">     143476 :                                 imt [i] = initialize_imt_slot (vt, domain, imt_builder [i], NULL);</span>
<span class="lineNum">    1461 </span>            :                         }
<span class="lineNum">    1462 </span>            : #if DEBUG_IMT
<span class="lineNum">    1463 </span>            :                         printf (&quot;initialize_imt_slot[%d]: %p methods %d\n&quot;, i, imt [i], imt_builder [i]-&gt;children + 1);
<span class="lineNum">    1464 </span>            : #endif
<span class="lineNum">    1465 </span><span class="lineCov">     986074 :                 }</span>
<span class="lineNum">    1466 </span>            : 
<span class="lineNum">    1467 </span><span class="lineCov">   18480274 :                 if (imt_builder [i] != NULL) {</span>
<span class="lineNum">    1468 </span><span class="lineCov">     983657 :                         int methods_in_slot = imt_builder [i]-&gt;children + 1;</span>
<span class="lineNum">    1469 </span><span class="lineCov">     983657 :                         if (methods_in_slot &gt; mono_stats.imt_max_collisions_in_slot) {</span>
<span class="lineNum">    1470 </span><span class="lineCov">       4669 :                                 mono_stats.imt_max_collisions_in_slot = methods_in_slot;</span>
<span class="lineNum">    1471 </span><span class="lineCov">       4669 :                                 record_method_count_for_max_collisions = TRUE;</span>
<span class="lineNum">    1472 </span><span class="lineCov">       4669 :                         }</span>
<span class="lineNum">    1473 </span><span class="lineCov">     983657 :                         method_count += methods_in_slot;</span>
<span class="lineNum">    1474 </span><span class="lineCov">     983657 :                 }</span>
<span class="lineNum">    1475 </span><span class="lineCov">   18480274 :         }</span>
<span class="lineNum">    1476 </span>            :         
<span class="lineNum">    1477 </span><span class="lineCov">     972646 :         mono_stats.imt_number_of_methods += method_count;</span>
<span class="lineNum">    1478 </span><span class="lineCov">     972646 :         if (record_method_count_for_max_collisions) {</span>
<span class="lineNum">    1479 </span><span class="lineCov">       4667 :                 mono_stats.imt_method_count_when_max_collisions = method_count;</span>
<span class="lineNum">    1480 </span><span class="lineCov">       4667 :         }</span>
<span class="lineNum">    1481 </span>            :         
<span class="lineNum">    1482 </span><span class="lineCov">   38905840 :         for (i = 0; i &lt; MONO_IMT_SIZE; i++) {</span>
<span class="lineNum">    1483 </span><span class="lineCov">   18480274 :                 MonoImtBuilderEntry* entry = imt_builder [i];</span>
<span class="lineNum">    1484 </span><span class="lineCov">   42329784 :                 while (entry != NULL) {</span>
<span class="lineNum">    1485 </span><span class="lineCov">    2684618 :                         MonoImtBuilderEntry* next = entry-&gt;next;</span>
<span class="lineNum">    1486 </span><span class="lineCov">    2684618 :                         g_free (entry);</span>
<span class="lineNum">    1487 </span><span class="lineCov">    2684618 :                         entry = next;</span>
<span class="lineNum">    1488 </span>            :                 }
<span class="lineNum">    1489 </span><span class="lineCov">   18480274 :         }</span>
<span class="lineNum">    1490 </span><span class="lineCov">     972646 :         g_free (imt_builder);</span>
<span class="lineNum">    1491 </span>            :         /* we OR the bitmap since we may build just a single imt slot at a time */
<span class="lineNum">    1492 </span><span class="lineCov">     972646 :         vt-&gt;imt_collisions_bitmap |= imt_collisions_bitmap;</span>
<span class="lineNum">    1493 </span><span class="lineCov">     972646 : }</span>
<a name="1494"><span class="lineNum">    1494 </span>            : </a>
<span class="lineNum">    1495 </span>            : static void
<span class="lineNum">    1496 </span>            : build_imt (MonoClass *klass, MonoVTable *vt, MonoDomain *domain, gpointer* imt, GSList *extra_interfaces) {
<span class="lineNum">    1497 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1498 </span>            : 
<span class="lineNum">    1499 </span><span class="lineCov">        746 :         build_imt_slots (klass, vt, domain, imt, extra_interfaces, -1);</span>
<span class="lineNum">    1500 </span><span class="lineCov">        746 : }</span>
<span class="lineNum">    1501 </span>            : 
<span class="lineNum">    1502 </span>            : /**
<span class="lineNum">    1503 </span>            :  * mono_vtable_build_imt_slot:
<span class="lineNum">    1504 </span>            :  * @vtable: virtual object table struct
<span class="lineNum">    1505 </span>            :  * @imt_slot: slot in the IMT table
<span class="lineNum">    1506 </span>            :  *
<span class="lineNum">    1507 </span>            :  * Fill the given @imt_slot in the IMT table of @vtable with
<span class="lineNum">    1508 </span>            :  * a trampoline or a trampoline for the case of collisions.
<span class="lineNum">    1509 </span>            :  * This is part of the internal mono API.
<span class="lineNum">    1510 </span>            :  *
<span class="lineNum">    1511 </span>            :  * LOCKING: Take the domain lock.
<a name="1512"><span class="lineNum">    1512 </span>            :  */</a>
<span class="lineNum">    1513 </span>            : void
<span class="lineNum">    1514 </span>            : mono_vtable_build_imt_slot (MonoVTable* vtable, int imt_slot)
<span class="lineNum">    1515 </span>            : {
<span class="lineNum">    1516 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1517 </span>            : 
<span class="lineNum">    1518 </span><span class="lineCov">    1193784 :         gpointer *imt = (gpointer*)vtable;</span>
<span class="lineNum">    1519 </span><span class="lineCov">    1193784 :         imt -= MONO_IMT_SIZE;</span>
<span class="lineNum">    1520 </span><span class="lineCov">    5968720 :         g_assert (imt_slot &gt;= 0 &amp;&amp; imt_slot &lt; MONO_IMT_SIZE);</span>
<span class="lineNum">    1521 </span>            : 
<span class="lineNum">    1522 </span>            :         /* no support for extra interfaces: the proxy objects will need
<span class="lineNum">    1523 </span>            :          * to build the complete IMT
<span class="lineNum">    1524 </span>            :          * Update and heck needs to ahppen inside the proper domain lock, as all
<span class="lineNum">    1525 </span>            :          * the changes made to a MonoVTable.
<span class="lineNum">    1526 </span>            :          */
<span class="lineNum">    1527 </span><span class="lineCov">    1193833 :         mono_loader_lock (); /*FIXME build_imt_slots requires the loader lock.*/</span>
<span class="lineNum">    1528 </span><span class="lineCov">    1193833 :         mono_domain_lock (vtable-&gt;domain);</span>
<span class="lineNum">    1529 </span>            :         /* we change the slot only if it wasn't changed from the generic imt trampoline already */
<span class="lineNum">    1530 </span><span class="lineCov">    1193833 :         if (!callbacks.imt_entry_inited (vtable, imt_slot))</span>
<span class="lineNum">    1531 </span><span class="lineCov">     971900 :                 build_imt_slots (vtable-&gt;klass, vtable, vtable-&gt;domain, imt, NULL, imt_slot);</span>
<span class="lineNum">    1532 </span><span class="lineCov">    1193833 :         mono_domain_unlock (vtable-&gt;domain);</span>
<span class="lineNum">    1533 </span><span class="lineCov">    1193833 :         mono_loader_unlock ();</span>
<span class="lineNum">    1534 </span><span class="lineCov">    1193833 : }</span>
<span class="lineNum">    1535 </span>            : 
<span class="lineNum">    1536 </span>            : #define THUNK_THRESHOLD         10
<span class="lineNum">    1537 </span>            : 
<span class="lineNum">    1538 </span>            : /**
<span class="lineNum">    1539 </span>            :  * mono_method_alloc_generic_virtual_trampoline:
<span class="lineNum">    1540 </span>            :  * @domain: a domain
<span class="lineNum">    1541 </span>            :  * @size: size in bytes
<span class="lineNum">    1542 </span>            :  *
<span class="lineNum">    1543 </span>            :  * Allocs size bytes to be used for the code of a generic virtual
<span class="lineNum">    1544 </span>            :  * trampoline.  It's either allocated from the domain's code manager or
<span class="lineNum">    1545 </span>            :  * reused from a previously invalidated piece.
<span class="lineNum">    1546 </span>            :  *
<span class="lineNum">    1547 </span>            :  * LOCKING: The domain lock must be held.
<a name="1548"><span class="lineNum">    1548 </span>            :  */</a>
<span class="lineNum">    1549 </span>            : gpointer
<span class="lineNum">    1550 </span>            : mono_method_alloc_generic_virtual_trampoline (MonoDomain *domain, int size)
<span class="lineNum">    1551 </span>            : {
<span class="lineNum">    1552 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1553 </span>            : 
<span class="lineNum">    1554 </span>            :         static gboolean inited = FALSE;
<span class="lineNum">    1555 </span>            :         static int generic_virtual_trampolines_size = 0;
<span class="lineNum">    1556 </span>            : 
<span class="lineNum">    1557 </span><span class="lineCov">     849972 :         if (!inited) {</span>
<span class="lineNum">    1558 </span><span class="lineCov">       2058 :                 mono_counters_register (&quot;Generic virtual trampoline bytes&quot;,</span>
<span class="lineNum">    1559 </span>            :                                 MONO_COUNTER_GENERICS | MONO_COUNTER_INT, &amp;generic_virtual_trampolines_size);
<span class="lineNum">    1560 </span><span class="lineCov">       2058 :                 inited = TRUE;</span>
<span class="lineNum">    1561 </span><span class="lineCov">       2058 :         }</span>
<span class="lineNum">    1562 </span><span class="lineCov">     849972 :         generic_virtual_trampolines_size += size;</span>
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span><span class="lineCov">     849972 :         return mono_domain_code_reserve (domain, size);</span>
<span class="lineNum">    1565 </span>            : }
<span class="lineNum">    1566 </span>            : 
<span class="lineNum">    1567 </span>            : typedef struct _GenericVirtualCase {
<span class="lineNum">    1568 </span>            :         MonoMethod *method;
<span class="lineNum">    1569 </span>            :         gpointer code;
<span class="lineNum">    1570 </span>            :         int count;
<span class="lineNum">    1571 </span>            :         struct _GenericVirtualCase *next;
<span class="lineNum">    1572 </span>            : } GenericVirtualCase;
<span class="lineNum">    1573 </span>            : 
<span class="lineNum">    1574 </span>            : /*
<span class="lineNum">    1575 </span>            :  * get_generic_virtual_entries:
<span class="lineNum">    1576 </span>            :  *
<span class="lineNum">    1577 </span>            :  *   Return IMT entries for the generic virtual method instances and
<span class="lineNum">    1578 </span>            :  *   variant interface methods for vtable slot
<span class="lineNum">    1579 </span>            :  * VTABLE_SLOT.
<a name="1580"><span class="lineNum">    1580 </span>            :  */ </a>
<span class="lineNum">    1581 </span>            : static MonoImtBuilderEntry*
<span class="lineNum">    1582 </span>            : get_generic_virtual_entries (MonoDomain *domain, gpointer *vtable_slot)
<span class="lineNum">    1583 </span>            : {
<span class="lineNum">    1584 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1585 </span>            : 
<span class="lineNum">    1586 </span>            :         GenericVirtualCase *list;
<span class="lineNum">    1587 </span>            :         MonoImtBuilderEntry *entries;
<span class="lineNum">    1588 </span>            :   
<span class="lineNum">    1589 </span><span class="lineCov">     993730 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1590 </span><span class="lineCov">     993730 :         if (!domain-&gt;generic_virtual_cases)</span>
<span class="lineNum">    1591 </span><span class="lineCov">       2611 :                 domain-&gt;generic_virtual_cases = g_hash_table_new (mono_aligned_addr_hash, NULL);</span>
<span class="lineNum">    1592 </span>            :  
<span class="lineNum">    1593 </span><span class="lineCov">     993730 :         list = (GenericVirtualCase *)g_hash_table_lookup (domain-&gt;generic_virtual_cases, vtable_slot);</span>
<span class="lineNum">    1594 </span>            :  
<span class="lineNum">    1595 </span><span class="lineCov">     993730 :         entries = NULL;</span>
<span class="lineNum">    1596 </span><span class="lineCov">    2103020 :         for (; list; list = list-&gt;next) {</span>
<span class="lineNum">    1597 </span>            :                 MonoImtBuilderEntry *entry;
<span class="lineNum">    1598 </span>            :  
<span class="lineNum">    1599 </span><span class="lineCov">      57780 :                 if (list-&gt;count &lt; THUNK_THRESHOLD)</span>
<span class="lineNum">    1600 </span><span class="lineCov">       8876 :                         continue;</span>
<span class="lineNum">    1601 </span>            :  
<span class="lineNum">    1602 </span><span class="lineCov">      48904 :                 entry = g_new0 (MonoImtBuilderEntry, 1);</span>
<span class="lineNum">    1603 </span><span class="lineCov">      48904 :                 entry-&gt;key = list-&gt;method;</span>
<span class="lineNum">    1604 </span><span class="lineCov">      48904 :                 entry-&gt;value.target_code = mono_get_addr_from_ftnptr (list-&gt;code);</span>
<span class="lineNum">    1605 </span><span class="lineCov">      48904 :                 entry-&gt;has_target_code = 1;</span>
<span class="lineNum">    1606 </span><span class="lineCov">      48904 :                 if (entries)</span>
<span class="lineNum">    1607 </span><span class="lineCov">      25634 :                         entry-&gt;children = entries-&gt;children + 1;</span>
<span class="lineNum">    1608 </span><span class="lineCov">      48904 :                 entry-&gt;next = entries;</span>
<span class="lineNum">    1609 </span><span class="lineCov">      48904 :                 entries = entry;</span>
<span class="lineNum">    1610 </span><span class="lineCov">      48904 :         }</span>
<span class="lineNum">    1611 </span>            :  
<span class="lineNum">    1612 </span><span class="lineCov">     993730 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1613 </span>            :  
<span class="lineNum">    1614 </span>            :         /* FIXME: Leaking memory ? */
<span class="lineNum">    1615 </span><span class="lineCov">     993730 :         return entries;</span>
<span class="lineNum">    1616 </span>            : }
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span>            : /**
<span class="lineNum">    1619 </span>            :  * mono_method_add_generic_virtual_invocation:
<span class="lineNum">    1620 </span>            :  * @domain: a domain
<span class="lineNum">    1621 </span>            :  * @vtable_slot: pointer to the vtable slot
<span class="lineNum">    1622 </span>            :  * @method: the inflated generic virtual method
<span class="lineNum">    1623 </span>            :  * @code: the method's code
<span class="lineNum">    1624 </span>            :  *
<span class="lineNum">    1625 </span>            :  * Registers a call via unmanaged code to a generic virtual method
<span class="lineNum">    1626 </span>            :  * instantiation or variant interface method.  If the number of calls reaches a threshold
<span class="lineNum">    1627 </span>            :  * (THUNK_THRESHOLD), the method is added to the vtable slot's generic
<span class="lineNum">    1628 </span>            :  * virtual method trampoline.
<a name="1629"><span class="lineNum">    1629 </span>            :  */</a>
<span class="lineNum">    1630 </span>            : void
<span class="lineNum">    1631 </span>            : mono_method_add_generic_virtual_invocation (MonoDomain *domain, MonoVTable *vtable,
<span class="lineNum">    1632 </span>            :                                                                                         gpointer *vtable_slot,
<span class="lineNum">    1633 </span>            :                                                                                         MonoMethod *method, gpointer code)
<span class="lineNum">    1634 </span>            : {
<span class="lineNum">    1635 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1636 </span>            : 
<span class="lineNum">    1637 </span>            :         static gboolean inited = FALSE;
<span class="lineNum">    1638 </span>            :         static int num_added = 0;
<span class="lineNum">    1639 </span>            :         static int num_freed = 0;
<span class="lineNum">    1640 </span>            : 
<span class="lineNum">    1641 </span>            :         GenericVirtualCase *gvc, *list;
<span class="lineNum">    1642 </span>            :         MonoImtBuilderEntry *entries;
<span class="lineNum">    1643 </span>            :         int i;
<span class="lineNum">    1644 </span>            :         GPtrArray *sorted;
<span class="lineNum">    1645 </span>            : 
<span class="lineNum">    1646 </span><span class="lineCov">     333673 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1647 </span><span class="lineCov">     333673 :         if (!domain-&gt;generic_virtual_cases)</span>
<span class="lineNum">    1648 </span><span class="lineCov">         34 :                 domain-&gt;generic_virtual_cases = g_hash_table_new (mono_aligned_addr_hash, NULL);</span>
<span class="lineNum">    1649 </span>            : 
<span class="lineNum">    1650 </span><span class="lineCov">     333673 :         if (!inited) {</span>
<span class="lineNum">    1651 </span><span class="lineCov">       1117 :                 mono_counters_register (&quot;Generic virtual cases&quot;, MONO_COUNTER_GENERICS | MONO_COUNTER_INT, &amp;num_added);</span>
<span class="lineNum">    1652 </span><span class="lineCov">       1117 :                 mono_counters_register (&quot;Freed IMT trampolines&quot;, MONO_COUNTER_GENERICS | MONO_COUNTER_INT, &amp;num_freed);</span>
<span class="lineNum">    1653 </span><span class="lineCov">       1117 :                 inited = TRUE;</span>
<span class="lineNum">    1654 </span><span class="lineCov">       1117 :         }</span>
<span class="lineNum">    1655 </span>            : 
<span class="lineNum">    1656 </span>            :         /* Check whether the case was already added */
<span class="lineNum">    1657 </span><span class="lineCov">     333673 :         list = (GenericVirtualCase *)g_hash_table_lookup (domain-&gt;generic_virtual_cases, vtable_slot);</span>
<span class="lineNum">    1658 </span><span class="lineCov">     333673 :         gvc = list;</span>
<span class="lineNum">    1659 </span><span class="lineCov">     851058 :         while (gvc) {</span>
<span class="lineNum">    1660 </span><span class="lineCov">     373052 :                 if (gvc-&gt;method == method)</span>
<span class="lineNum">    1661 </span><span class="lineCov">     281196 :                         break;</span>
<span class="lineNum">    1662 </span><span class="lineCov">      91856 :                 gvc = gvc-&gt;next;</span>
<span class="lineNum">    1663 </span>            :         }
<span class="lineNum">    1664 </span>            : 
<span class="lineNum">    1665 </span>            :         /* If not found, make a new one */
<span class="lineNum">    1666 </span><span class="lineCov">     333673 :         if (!gvc) {</span>
<span class="lineNum">    1667 </span><span class="lineCov">      52477 :                 gvc = (GenericVirtualCase *)mono_domain_alloc (domain, sizeof (GenericVirtualCase));</span>
<span class="lineNum">    1668 </span><span class="lineCov">      52477 :                 gvc-&gt;method = method;</span>
<span class="lineNum">    1669 </span><span class="lineCov">      52477 :                 gvc-&gt;code = code;</span>
<span class="lineNum">    1670 </span><span class="lineCov">      52477 :                 gvc-&gt;count = 0;</span>
<span class="lineNum">    1671 </span><span class="lineCov">      52477 :                 gvc-&gt;next = (GenericVirtualCase *)g_hash_table_lookup (domain-&gt;generic_virtual_cases, vtable_slot);</span>
<span class="lineNum">    1672 </span>            : 
<span class="lineNum">    1673 </span><span class="lineCov">      52477 :                 g_hash_table_insert (domain-&gt;generic_virtual_cases, vtable_slot, gvc);</span>
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span><span class="lineCov">      52477 :                 num_added++;</span>
<span class="lineNum">    1676 </span><span class="lineCov">      52477 :         }</span>
<span class="lineNum">    1677 </span>            : 
<span class="lineNum">    1678 </span><span class="lineCov">     333673 :         if (++gvc-&gt;count == THUNK_THRESHOLD) {</span>
<span class="lineNum">    1679 </span><span class="lineCov">      23547 :                 gpointer *old_thunk = (void **)*vtable_slot;</span>
<span class="lineNum">    1680 </span><span class="lineCov">      23547 :                 gpointer vtable_trampoline = NULL;</span>
<span class="lineNum">    1681 </span><span class="lineCov">      23547 :                 gpointer imt_trampoline = NULL;</span>
<span class="lineNum">    1682 </span>            : 
<span class="lineNum">    1683 </span><span class="lineCov">      23547 :                 if ((gpointer)vtable_slot &lt; (gpointer)vtable) {</span>
<span class="lineNum">    1684 </span><span class="lineCov">      15891 :                         int displacement = (gpointer*)vtable_slot - (gpointer*)vtable;</span>
<span class="lineNum">    1685 </span><span class="lineCov">      15891 :                         int imt_slot = MONO_IMT_SIZE + displacement;</span>
<span class="lineNum">    1686 </span>            : 
<span class="lineNum">    1687 </span>            :                         /* Force the rebuild of the trampoline at the next call */
<span class="lineNum">    1688 </span><span class="lineCov">      15891 :                         imt_trampoline = callbacks.get_imt_trampoline (vtable, imt_slot);</span>
<span class="lineNum">    1689 </span><span class="lineCov">      15891 :                         *vtable_slot = imt_trampoline;</span>
<span class="lineNum">    1690 </span><span class="lineCov">      15891 :                 } else {</span>
<span class="lineNum">    1691 </span><span class="lineCov">      22968 :                         vtable_trampoline = callbacks.get_vtable_trampoline ? callbacks.get_vtable_trampoline (vtable, (gpointer*)vtable_slot - (gpointer*)vtable-&gt;vtable) : NULL;</span>
<span class="lineNum">    1692 </span>            : 
<span class="lineNum">    1693 </span><span class="lineCov">       7656 :                         entries = get_generic_virtual_entries (domain, vtable_slot);</span>
<span class="lineNum">    1694 </span>            : 
<span class="lineNum">    1695 </span><span class="lineCov">       7656 :                         sorted = imt_sort_slot_entries (entries);</span>
<span class="lineNum">    1696 </span>            : 
<span class="lineNum">    1697 </span><span class="lineCov">      15312 :                         *vtable_slot = imt_trampoline_builder (NULL, domain, (MonoIMTCheckItem**)sorted-&gt;pdata, sorted-&gt;len,</span>
<span class="lineNum">    1698 </span><span class="lineCov">       7656 :                                                                                                    vtable_trampoline);</span>
<span class="lineNum">    1699 </span>            : 
<span class="lineNum">    1700 </span><span class="lineCov">      35648 :                         while (entries) {</span>
<span class="lineNum">    1701 </span><span class="lineCov">      10168 :                                 MonoImtBuilderEntry *next = entries-&gt;next;</span>
<span class="lineNum">    1702 </span><span class="lineCov">      10168 :                                 g_free (entries);</span>
<span class="lineNum">    1703 </span><span class="lineCov">      10168 :                                 entries = next;</span>
<span class="lineNum">    1704 </span>            :                         }
<span class="lineNum">    1705 </span>            : 
<span class="lineNum">    1706 </span><span class="lineCov">      35648 :                         for (i = 0; i &lt; sorted-&gt;len; ++i)</span>
<span class="lineNum">    1707 </span><span class="lineCov">      10168 :                                 g_free (g_ptr_array_index (sorted, i));</span>
<span class="lineNum">    1708 </span><span class="lineCov">       7656 :                         g_ptr_array_free (sorted, TRUE);</span>
<span class="lineNum">    1709 </span>            : 
<span class="lineNum">    1710 </span><span class="lineCov">      10142 :                         if (old_thunk != vtable_trampoline &amp;&amp; old_thunk != imt_trampoline)</span>
<span class="lineNum">    1711 </span><span class="lineCov">       2486 :                                 num_freed ++;</span>
<span class="lineNum">    1712 </span>            :                 }
<span class="lineNum">    1713 </span><span class="lineCov">      23547 :         }</span>
<span class="lineNum">    1714 </span>            : 
<span class="lineNum">    1715 </span><span class="lineCov">     333673 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1716 </span><span class="lineCov">     333673 : }</span>
<span class="lineNum">    1717 </span>            : 
<span class="lineNum">    1718 </span>            : static MonoVTable *mono_class_create_runtime_vtable (MonoDomain *domain, MonoClass *klass, MonoError *error);
<span class="lineNum">    1719 </span>            : 
<span class="lineNum">    1720 </span>            : /**
<span class="lineNum">    1721 </span>            :  * mono_class_vtable:
<span class="lineNum">    1722 </span>            :  * @domain: the application domain
<span class="lineNum">    1723 </span>            :  * @class: the class to initialize
<span class="lineNum">    1724 </span>            :  *
<span class="lineNum">    1725 </span>            :  * VTables are domain specific because we create domain specific code, and 
<span class="lineNum">    1726 </span>            :  * they contain the domain specific static class data.
<span class="lineNum">    1727 </span>            :  * On failure, NULL is returned, and class-&gt;exception_type is set.
<a name="1728"><span class="lineNum">    1728 </span>            :  */</a>
<span class="lineNum">    1729 </span>            : MonoVTable *
<span class="lineNum">    1730 </span>            : mono_class_vtable (MonoDomain *domain, MonoClass *klass)
<span class="lineNum">    1731 </span>            : {
<span class="lineNum">    1732 </span>            :         MonoError error;
<span class="lineNum">    1733 </span><span class="lineCov">  118000299 :         MonoVTable* vtable = mono_class_vtable_full (domain, klass, &amp;error);</span>
<span class="lineNum">    1734 </span><span class="lineCov">  118000299 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    1735 </span><span class="lineCov">  118000299 :         return vtable;</span>
<span class="lineNum">    1736 </span>            : }
<span class="lineNum">    1737 </span>            : 
<span class="lineNum">    1738 </span>            : /**
<span class="lineNum">    1739 </span>            :  * mono_class_vtable_full:
<span class="lineNum">    1740 </span>            :  * @domain: the application domain
<span class="lineNum">    1741 </span>            :  * @class: the class to initialize
<span class="lineNum">    1742 </span>            :  * @error set on failure.
<span class="lineNum">    1743 </span>            :  *
<span class="lineNum">    1744 </span>            :  * VTables are domain specific because we create domain specific code, and 
<span class="lineNum">    1745 </span>            :  * they contain the domain specific static class data.
<a name="1746"><span class="lineNum">    1746 </span>            :  */</a>
<span class="lineNum">    1747 </span>            : MonoVTable *
<span class="lineNum">    1748 </span>            : mono_class_vtable_full (MonoDomain *domain, MonoClass *klass, MonoError *error)
<span class="lineNum">    1749 </span>            : {
<span class="lineNum">    1750 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    1751 </span>            : 
<span class="lineNum">    1752 </span>            :         MonoClassRuntimeInfo *runtime_info;
<span class="lineNum">    1753 </span>            : 
<span class="lineNum">    1754 </span><span class="lineCov">  142376508 :         mono_error_init (error);</span>
<span class="lineNum">    1755 </span>            : 
<span class="lineNum">    1756 </span><span class="lineCov">  427189833 :         g_assert (klass);</span>
<span class="lineNum">    1757 </span>            : 
<span class="lineNum">    1758 </span><span class="lineCov">  142419274 :         if (mono_class_has_failure (klass)) {</span>
<span class="lineNum">    1759 </span><span class="lineNoCov">          0 :                 mono_error_set_for_class_failure (error, klass);</span>
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1761 </span>            :         }
<span class="lineNum">    1762 </span>            : 
<span class="lineNum">    1763 </span>            :         /* this check can be inlined in jitted code, too */
<span class="lineNum">    1764 </span><span class="lineCov">  142422277 :         runtime_info = klass-&gt;runtime_info;</span>
<span class="lineNum">    1765 </span><span class="lineCov">  417610009 :         if (runtime_info &amp;&amp; runtime_info-&gt;max_domain &gt;= domain-&gt;domain_id &amp;&amp; runtime_info-&gt;domain_vtables [domain-&gt;domain_id])</span>
<span class="lineNum">    1766 </span><span class="lineCov">  137477880 :                 return runtime_info-&gt;domain_vtables [domain-&gt;domain_id];</span>
<span class="lineNum">    1767 </span><span class="lineCov">    4944070 :         return mono_class_create_runtime_vtable (domain, klass, error);</span>
<span class="lineNum">    1768 </span><span class="lineCov">  142426518 : }</span>
<span class="lineNum">    1769 </span>            : 
<span class="lineNum">    1770 </span>            : /**
<span class="lineNum">    1771 </span>            :  * mono_class_try_get_vtable:
<span class="lineNum">    1772 </span>            :  * @domain: the application domain
<span class="lineNum">    1773 </span>            :  * @class: the class to initialize
<span class="lineNum">    1774 </span>            :  *
<span class="lineNum">    1775 </span>            :  * This function tries to get the associated vtable from @class if
<span class="lineNum">    1776 </span>            :  * it was already created.
<a name="1777"><span class="lineNum">    1777 </span>            :  */</a>
<span class="lineNum">    1778 </span>            : MonoVTable *
<span class="lineNum">    1779 </span>            : mono_class_try_get_vtable (MonoDomain *domain, MonoClass *klass)
<span class="lineNum">    1780 </span>            : {
<span class="lineNum">    1781 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1782 </span>            : 
<span class="lineNum">    1783 </span>            :         MonoClassRuntimeInfo *runtime_info;
<span class="lineNum">    1784 </span>            : 
<span class="lineNum">    1785 </span><span class="lineCov">   25953584 :         g_assert (klass);</span>
<span class="lineNum">    1786 </span>            : 
<span class="lineNum">    1787 </span><span class="lineCov">    8651374 :         runtime_info = klass-&gt;runtime_info;</span>
<span class="lineNum">    1788 </span><span class="lineCov">   14815499 :         if (runtime_info &amp;&amp; runtime_info-&gt;max_domain &gt;= domain-&gt;domain_id &amp;&amp; runtime_info-&gt;domain_vtables [domain-&gt;domain_id])</span>
<span class="lineNum">    1789 </span><span class="lineCov">    2950214 :                 return runtime_info-&gt;domain_vtables [domain-&gt;domain_id];</span>
<span class="lineNum">    1790 </span><span class="lineCov">    5701259 :         return NULL;</span>
<span class="lineNum">    1791 </span><span class="lineCov">    8651463 : }</span>
<a name="1792"><span class="lineNum">    1792 </span>            : </a>
<span class="lineNum">    1793 </span>            : static gpointer*
<span class="lineNum">    1794 </span>            : alloc_vtable (MonoDomain *domain, size_t vtable_size, size_t imt_table_bytes)
<span class="lineNum">    1795 </span>            : {
<span class="lineNum">    1796 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    1797 </span>            : 
<span class="lineNum">    1798 </span>            :         size_t alloc_offset;
<span class="lineNum">    1799 </span>            : 
<span class="lineNum">    1800 </span>            :         /*
<span class="lineNum">    1801 </span>            :          * We want the pointer to the MonoVTable aligned to 8 bytes because SGen uses three
<span class="lineNum">    1802 </span>            :          * address bits.  The IMT has an odd number of entries, however, so on 32 bits the
<span class="lineNum">    1803 </span>            :          * alignment will be off.  In that case we allocate 4 more bytes and skip over them.
<span class="lineNum">    1804 </span>            :          */
<span class="lineNum">    1805 </span>            :         if (sizeof (gpointer) == 4 &amp;&amp; (imt_table_bytes &amp; 7)) {
<span class="lineNum">    1806 </span>            :                 g_assert ((imt_table_bytes &amp; 7) == 4);
<span class="lineNum">    1807 </span>            :                 vtable_size += 4;
<span class="lineNum">    1808 </span>            :                 alloc_offset = 4;
<span class="lineNum">    1809 </span>            :         } else {
<span class="lineNum">    1810 </span><span class="lineCov">    4679775 :                 alloc_offset = 0;</span>
<span class="lineNum">    1811 </span>            :         }
<span class="lineNum">    1812 </span>            : 
<span class="lineNum">    1813 </span><span class="lineCov">    4679775 :         return (gpointer*) ((char*)mono_domain_alloc0 (domain, vtable_size) + alloc_offset);</span>
<span class="lineNum">    1814 </span>            : }
<a name="1815"><span class="lineNum">    1815 </span>            : </a>
<span class="lineNum">    1816 </span>            : static MonoVTable *
<span class="lineNum">    1817 </span>            : mono_class_create_runtime_vtable (MonoDomain *domain, MonoClass *klass, MonoError *error)
<span class="lineNum">    1818 </span>            : {
<span class="lineNum">    1819 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    1820 </span>            : 
<span class="lineNum">    1821 </span>            :         MonoVTable *vt;
<span class="lineNum">    1822 </span>            :         MonoClassRuntimeInfo *runtime_info, *old_info;
<span class="lineNum">    1823 </span>            :         MonoClassField *field;
<span class="lineNum">    1824 </span>            :         char *t;
<span class="lineNum">    1825 </span>            :         int i, vtable_slots;
<span class="lineNum">    1826 </span>            :         size_t imt_table_bytes;
<span class="lineNum">    1827 </span>            :         int gc_bits;
<span class="lineNum">    1828 </span>            :         guint32 vtable_size, class_size;
<span class="lineNum">    1829 </span>            :         gpointer iter;
<span class="lineNum">    1830 </span>            :         gpointer *interface_offsets;
<span class="lineNum">    1831 </span>            : 
<span class="lineNum">    1832 </span><span class="lineCov">    4944444 :         mono_error_init (error);</span>
<span class="lineNum">    1833 </span>            : 
<span class="lineNum">    1834 </span><span class="lineCov">    4944444 :         mono_loader_lock (); /*FIXME mono_class_init acquires it*/</span>
<span class="lineNum">    1835 </span><span class="lineCov">    4944444 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1836 </span><span class="lineCov">    4944444 :         runtime_info = klass-&gt;runtime_info;</span>
<span class="lineNum">    1837 </span><span class="lineCov">    5693494 :         if (runtime_info &amp;&amp; runtime_info-&gt;max_domain &gt;= domain-&gt;domain_id &amp;&amp; runtime_info-&gt;domain_vtables [domain-&gt;domain_id]) {</span>
<span class="lineNum">    1838 </span><span class="lineCov">     265403 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    1839 </span><span class="lineCov">     265403 :                 mono_loader_unlock ();</span>
<span class="lineNum">    1840 </span><span class="lineCov">     265403 :                 return runtime_info-&gt;domain_vtables [domain-&gt;domain_id];</span>
<span class="lineNum">    1841 </span>            :         }
<span class="lineNum">    1842 </span><span class="lineCov">    7975576 :         if (!klass-&gt;inited || mono_class_has_failure (klass)) {</span>
<span class="lineNum">    1843 </span><span class="lineCov">    2765010 :                 if (!mono_class_init (klass) || mono_class_has_failure (klass)) {</span>
<span class="lineNum">    1844 </span><span class="lineCov">          2 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">    1845 </span><span class="lineCov">          2 :                         mono_loader_unlock ();</span>
<span class="lineNum">    1846 </span><span class="lineCov">          2 :                         mono_error_set_for_class_failure (error, klass);</span>
<span class="lineNum">    1847 </span><span class="lineCov">          2 :                         return NULL;</span>
<span class="lineNum">    1848 </span>            :                 }
<span class="lineNum">    1849 </span><span class="lineCov">    1382504 :         }</span>
<span class="lineNum">    1850 </span>            : 
<span class="lineNum">    1851 </span>            :         /* Array types require that their element type be valid*/
<span class="lineNum">    1852 </span><span class="lineCov">    9352838 :         if (klass-&gt;byval_arg.type == MONO_TYPE_ARRAY || klass-&gt;byval_arg.type == MONO_TYPE_SZARRAY) {</span>
<span class="lineNum">    1853 </span><span class="lineCov">     589943 :                 MonoClass *element_class = klass-&gt;element_class;</span>
<span class="lineNum">    1854 </span><span class="lineCov">     589943 :                 if (!element_class-&gt;inited)</span>
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :                         mono_class_init (element_class);</span>
<span class="lineNum">    1856 </span>            : 
<span class="lineNum">    1857 </span>            :                 /*mono_class_init can leave the vtable layout to be lazily done and we can't afford this here*/
<span class="lineNum">    1858 </span><span class="lineCov">    1179886 :                 if (!mono_class_has_failure (element_class) &amp;&amp; !element_class-&gt;vtable_size)</span>
<span class="lineNum">    1859 </span><span class="lineCov">     131177 :                         mono_class_setup_vtable (element_class);</span>
<span class="lineNum">    1860 </span>            :                 
<span class="lineNum">    1861 </span><span class="lineCov">     589943 :                 if (mono_class_has_failure (element_class)) {</span>
<span class="lineNum">    1862 </span>            :                         /*Can happen if element_class only got bad after mono_class_setup_vtable*/
<span class="lineNum">    1863 </span><span class="lineCov">          2 :                         if (!mono_class_has_failure (klass))</span>
<span class="lineNum">    1864 </span><span class="lineCov">          2 :                                 mono_class_set_type_load_failure (klass, &quot;&quot;);</span>
<span class="lineNum">    1865 </span><span class="lineCov">          2 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">    1866 </span><span class="lineCov">          2 :                         mono_loader_unlock ();</span>
<span class="lineNum">    1867 </span><span class="lineCov">          2 :                         mono_error_set_for_class_failure (error, klass);</span>
<span class="lineNum">    1868 </span><span class="lineCov">          2 :                         return NULL;</span>
<span class="lineNum">    1869 </span>            :                 }
<span class="lineNum">    1870 </span><span class="lineCov">     589941 :         }</span>
<span class="lineNum">    1871 </span>            : 
<span class="lineNum">    1872 </span>            :         /* 
<span class="lineNum">    1873 </span>            :          * For some classes, mono_class_init () already computed klass-&gt;vtable_size, and 
<span class="lineNum">    1874 </span>            :          * that is all that is needed because of the vtable trampolines.
<span class="lineNum">    1875 </span>            :          */
<span class="lineNum">    1876 </span><span class="lineCov">    4679037 :         if (!klass-&gt;vtable_size)</span>
<span class="lineNum">    1877 </span><span class="lineCov">    1155223 :                 mono_class_setup_vtable (klass);</span>
<span class="lineNum">    1878 </span>            : 
<span class="lineNum">    1879 </span><span class="lineCov">    6936106 :         if (mono_class_is_ginst (klass) &amp;&amp; !klass-&gt;vtable)</span>
<span class="lineNum">    1880 </span><span class="lineCov">    2214212 :                 mono_class_check_vtable_constraints (klass, NULL);</span>
<span class="lineNum">    1881 </span>            : 
<span class="lineNum">    1882 </span>            :         /* Initialize klass-&gt;has_finalize */
<span class="lineNum">    1883 </span><span class="lineCov">    4679037 :         mono_class_has_finalizer (klass);</span>
<span class="lineNum">    1884 </span>            : 
<span class="lineNum">    1885 </span><span class="lineCov">    4679037 :         if (mono_class_has_failure (klass)) {</span>
<span class="lineNum">    1886 </span><span class="lineCov">          8 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    1887 </span><span class="lineCov">          8 :                 mono_loader_unlock ();</span>
<span class="lineNum">    1888 </span><span class="lineCov">          8 :                 mono_error_set_for_class_failure (error, klass);</span>
<span class="lineNum">    1889 </span><span class="lineCov">          8 :                 return NULL;</span>
<span class="lineNum">    1890 </span>            :         }
<span class="lineNum">    1891 </span>            : 
<span class="lineNum">    1892 </span><span class="lineCov">    4679029 :         vtable_slots = klass-&gt;vtable_size;</span>
<span class="lineNum">    1893 </span>            :         /* we add an additional vtable slot to store the pointer to static field data only when needed */
<span class="lineNum">    1894 </span><span class="lineCov">    4679029 :         class_size = mono_class_data_size (klass);</span>
<span class="lineNum">    1895 </span><span class="lineCov">    4679029 :         if (class_size)</span>
<span class="lineNum">    1896 </span><span class="lineCov">    1175344 :                 vtable_slots++;</span>
<span class="lineNum">    1897 </span>            : 
<span class="lineNum">    1898 </span><span class="lineCov">    4679029 :         if (klass-&gt;interface_offsets_count) {</span>
<span class="lineNum">    1899 </span><span class="lineCov">    3104751 :                 imt_table_bytes = sizeof (gpointer) * (MONO_IMT_SIZE);</span>
<span class="lineNum">    1900 </span><span class="lineCov">    3104751 :                 mono_stats.imt_number_of_tables++;</span>
<span class="lineNum">    1901 </span><span class="lineCov">    3104751 :                 mono_stats.imt_tables_size += imt_table_bytes;</span>
<span class="lineNum">    1902 </span><span class="lineCov">    3104751 :         } else {</span>
<span class="lineNum">    1903 </span><span class="lineCov">    1574278 :                 imt_table_bytes = 0;</span>
<span class="lineNum">    1904 </span>            :         }
<span class="lineNum">    1905 </span>            : 
<span class="lineNum">    1906 </span><span class="lineCov">    4679029 :         vtable_size = imt_table_bytes + MONO_SIZEOF_VTABLE + vtable_slots * sizeof (gpointer);</span>
<span class="lineNum">    1907 </span>            : 
<span class="lineNum">    1908 </span><span class="lineCov">    4679029 :         mono_stats.used_class_count++;</span>
<span class="lineNum">    1909 </span><span class="lineCov">    4679029 :         mono_stats.class_vtable_size += vtable_size;</span>
<span class="lineNum">    1910 </span>            : 
<span class="lineNum">    1911 </span><span class="lineCov">    4679029 :         interface_offsets = alloc_vtable (domain, vtable_size, imt_table_bytes);</span>
<span class="lineNum">    1912 </span><span class="lineCov">    4679029 :         vt = (MonoVTable*) ((char*)interface_offsets + imt_table_bytes);</span>
<span class="lineNum">    1913 </span><span class="lineCov">   14037087 :         g_assert (!((gsize)vt &amp; 7));</span>
<span class="lineNum">    1914 </span>            : 
<span class="lineNum">    1915 </span><span class="lineCov">    4679029 :         vt-&gt;klass = klass;</span>
<span class="lineNum">    1916 </span><span class="lineCov">    4679029 :         vt-&gt;rank = klass-&gt;rank;</span>
<span class="lineNum">    1917 </span><span class="lineCov">    4679029 :         vt-&gt;domain = domain;</span>
<span class="lineNum">    1918 </span>            : 
<span class="lineNum">    1919 </span><span class="lineCov">    4679029 :         mono_class_compute_gc_descriptor (klass);</span>
<span class="lineNum">    1920 </span>            :                 /*
<span class="lineNum">    1921 </span>            :                  * We can't use typed allocation in the non-root domains, since the
<span class="lineNum">    1922 </span>            :                  * collector needs the GC descriptor stored in the vtable even after
<span class="lineNum">    1923 </span>            :                  * the mempool containing the vtable is destroyed when the domain is
<span class="lineNum">    1924 </span>            :                  * unloaded. An alternative might be to allocate vtables in the GC
<span class="lineNum">    1925 </span>            :                  * heap, but this does not seem to work (it leads to crashes inside
<span class="lineNum">    1926 </span>            :                  * libgc). If that approach is tried, two gc descriptors need to be
<span class="lineNum">    1927 </span>            :                  * allocated for each class: one for the root domain, and one for all
<span class="lineNum">    1928 </span>            :                  * other domains. The second descriptor should contain a bit for the
<span class="lineNum">    1929 </span>            :                  * vtable field in MonoObject, since we can no longer assume the 
<span class="lineNum">    1930 </span>            :                  * vtable is reachable by other roots after the appdomain is unloaded.
<span class="lineNum">    1931 </span>            :                  */
<span class="lineNum">    1932 </span>            : #ifdef HAVE_BOEHM_GC
<span class="lineNum">    1933 </span>            :         if (domain != mono_get_root_domain () &amp;&amp; !mono_dont_free_domains)
<span class="lineNum">    1934 </span>            :                 vt-&gt;gc_descr = MONO_GC_DESCRIPTOR_NULL;
<span class="lineNum">    1935 </span>            :         else
<span class="lineNum">    1936 </span>            : #endif
<span class="lineNum">    1937 </span><span class="lineCov">    4679029 :                 vt-&gt;gc_descr = klass-&gt;gc_descr;</span>
<span class="lineNum">    1938 </span>            : 
<span class="lineNum">    1939 </span><span class="lineCov">    4679029 :         gc_bits = mono_gc_get_vtable_bits (klass);</span>
<span class="lineNum">    1940 </span><span class="lineCov">   14037087 :         g_assert (!(gc_bits &amp; ~((1 &lt;&lt; MONO_VTABLE_AVAILABLE_GC_BITS) - 1)));</span>
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span><span class="lineCov">    4679029 :         vt-&gt;gc_bits = gc_bits;</span>
<span class="lineNum">    1943 </span>            : 
<span class="lineNum">    1944 </span><span class="lineCov">    4679029 :         if (class_size) {</span>
<span class="lineNum">    1945 </span>            :                 /* we store the static field pointer at the end of the vtable: vt-&gt;vtable [class-&gt;vtable_size] */
<span class="lineNum">    1946 </span><span class="lineCov">    1175344 :                 if (klass-&gt;has_static_refs) {</span>
<span class="lineNum">    1947 </span>            :                         MonoGCDescriptor statics_gc_descr;
<span class="lineNum">    1948 </span><span class="lineCov">    1108377 :                         int max_set = 0;</span>
<span class="lineNum">    1949 </span><span class="lineCov">    1108377 :                         gsize default_bitmap [4] = {0};</span>
<span class="lineNum">    1950 </span>            :                         gsize *bitmap;
<span class="lineNum">    1951 </span>            : 
<span class="lineNum">    1952 </span><span class="lineCov">    1108377 :                         bitmap = compute_class_bitmap (klass, default_bitmap, sizeof (default_bitmap) * 8, 0, &amp;max_set, TRUE);</span>
<span class="lineNum">    1953 </span>            :                         /*g_print (&quot;bitmap 0x%x for %s.%s (size: %d)\n&quot;, bitmap [0], klass-&gt;name_space, klass-&gt;name, class_size);*/
<span class="lineNum">    1954 </span><span class="lineCov">    1108377 :                         statics_gc_descr = mono_gc_make_descr_from_bitmap (bitmap, max_set + 1);</span>
<span class="lineNum">    1955 </span><span class="lineCov">    1108377 :                         vt-&gt;vtable [klass-&gt;vtable_size] = mono_gc_alloc_fixed (class_size, statics_gc_descr, MONO_ROOT_SOURCE_STATIC, &quot;managed static variables&quot;);</span>
<span class="lineNum">    1956 </span><span class="lineCov">    1108377 :                         mono_domain_add_class_static_data (domain, klass, vt-&gt;vtable [klass-&gt;vtable_size], NULL);</span>
<span class="lineNum">    1957 </span><span class="lineCov">    1108377 :                         if (bitmap != default_bitmap)</span>
<span class="lineNum">    1958 </span><span class="lineCov">       1033 :                                 g_free (bitmap);</span>
<span class="lineNum">    1959 </span><span class="lineCov">    1108377 :                 } else {</span>
<span class="lineNum">    1960 </span><span class="lineCov">      66967 :                         vt-&gt;vtable [klass-&gt;vtable_size] = mono_domain_alloc0 (domain, class_size);</span>
<span class="lineNum">    1961 </span>            :                 }
<span class="lineNum">    1962 </span><span class="lineCov">    1175344 :                 vt-&gt;has_static_fields = TRUE;</span>
<span class="lineNum">    1963 </span><span class="lineCov">    1175344 :                 mono_stats.class_static_data_size += class_size;</span>
<span class="lineNum">    1964 </span><span class="lineCov">    1175344 :         }</span>
<span class="lineNum">    1965 </span>            : 
<span class="lineNum">    1966 </span><span class="lineCov">    4679029 :         iter = NULL;</span>
<span class="lineNum">    1967 </span><span class="lineCov">   33346869 :         while ((field = mono_class_get_fields (klass, &amp;iter))) {</span>
<span class="lineNum">    1968 </span><span class="lineCov">   17264138 :                 if (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC))</span>
<span class="lineNum">    1969 </span><span class="lineCov">   10436316 :                         continue;</span>
<span class="lineNum">    1970 </span><span class="lineCov">    6827822 :                 if (mono_field_is_deleted (field))</span>
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1972 </span><span class="lineCov">    6827822 :                 if (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL)) {</span>
<span class="lineNum">    1973 </span><span class="lineCov">    7438746 :                         gint32 special_static = klass-&gt;no_special_static_fields ? SPECIAL_STATIC_NONE : field_is_special_static (klass, field);</span>
<span class="lineNum">    1974 </span><span class="lineCov">    2479582 :                         if (special_static != SPECIAL_STATIC_NONE) {</span>
<span class="lineNum">    1975 </span>            :                                 guint32 size, offset;
<span class="lineNum">    1976 </span>            :                                 gint32 align;
<span class="lineNum">    1977 </span><span class="lineCov">      45650 :                                 gsize default_bitmap [4] = {0};</span>
<span class="lineNum">    1978 </span>            :                                 gsize *bitmap;
<span class="lineNum">    1979 </span><span class="lineCov">      45650 :                                 int max_set = 0;</span>
<span class="lineNum">    1980 </span>            :                                 int numbits;
<span class="lineNum">    1981 </span>            :                                 MonoClass *fclass;
<span class="lineNum">    1982 </span><span class="lineCov">      45650 :                                 if (mono_type_is_reference (field-&gt;type)) {</span>
<span class="lineNum">    1983 </span><span class="lineCov">      45631 :                                         default_bitmap [0] = 1;</span>
<span class="lineNum">    1984 </span><span class="lineCov">      45631 :                                         numbits = 1;</span>
<span class="lineNum">    1985 </span><span class="lineCov">      45631 :                                         bitmap = default_bitmap;</span>
<span class="lineNum">    1986 </span><span class="lineCov">      45650 :                                 } else if (mono_type_is_struct (field-&gt;type)) {</span>
<span class="lineNum">    1987 </span><span class="lineCov">          2 :                                         fclass = mono_class_from_mono_type (field-&gt;type);</span>
<span class="lineNum">    1988 </span><span class="lineCov">          2 :                                         bitmap = compute_class_bitmap (fclass, default_bitmap, sizeof (default_bitmap) * 8, - (int)(sizeof (MonoObject) / sizeof (gpointer)), &amp;max_set, FALSE);</span>
<span class="lineNum">    1989 </span><span class="lineCov">          2 :                                         numbits = max_set + 1;</span>
<span class="lineNum">    1990 </span><span class="lineCov">          2 :                                 } else {</span>
<span class="lineNum">    1991 </span><span class="lineCov">         17 :                                         default_bitmap [0] = 0;</span>
<span class="lineNum">    1992 </span><span class="lineCov">         17 :                                         numbits = 0;</span>
<span class="lineNum">    1993 </span><span class="lineCov">         17 :                                         bitmap = default_bitmap;</span>
<span class="lineNum">    1994 </span>            :                                 }
<span class="lineNum">    1995 </span><span class="lineCov">      45650 :                                 size = mono_type_size (field-&gt;type, &amp;align);</span>
<span class="lineNum">    1996 </span><span class="lineCov">      45650 :                                 offset = mono_alloc_special_static_data (special_static, size, align, (uintptr_t*)bitmap, numbits);</span>
<span class="lineNum">    1997 </span><span class="lineCov">      45650 :                                 if (!domain-&gt;special_static_fields)</span>
<span class="lineNum">    1998 </span><span class="lineCov">       3538 :                                         domain-&gt;special_static_fields = g_hash_table_new (NULL, NULL);</span>
<span class="lineNum">    1999 </span><span class="lineCov">      45650 :                                 g_hash_table_insert (domain-&gt;special_static_fields, field, GUINT_TO_POINTER (offset));</span>
<span class="lineNum">    2000 </span><span class="lineCov">      45650 :                                 if (bitmap != default_bitmap)</span>
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :                                         g_free (bitmap);</span>
<span class="lineNum">    2002 </span>            :                                 /* 
<span class="lineNum">    2003 </span>            :                                  * This marks the field as special static to speed up the
<span class="lineNum">    2004 </span>            :                                  * checks in mono_field_static_get/set_value ().
<span class="lineNum">    2005 </span>            :                                  */
<span class="lineNum">    2006 </span><span class="lineCov">      45650 :                                 field-&gt;offset = -1;</span>
<span class="lineNum">    2007 </span><span class="lineCov">      45650 :                                 continue;</span>
<span class="lineNum">    2008 </span>            :                         }
<span class="lineNum">    2009 </span><span class="lineCov">    2433932 :                 }</span>
<span class="lineNum">    2010 </span><span class="lineCov">    6782172 :                 if ((field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_HAS_FIELD_RVA)) {</span>
<span class="lineNum">    2011 </span><span class="lineCov">      57499 :                         MonoClass *fklass = mono_class_from_mono_type (field-&gt;type);</span>
<span class="lineNum">    2012 </span><span class="lineCov">      57499 :                         const char *data = mono_field_get_data (field);</span>
<span class="lineNum">    2013 </span>            : 
<span class="lineNum">    2014 </span><span class="lineCov">     172497 :                         g_assert (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_HAS_DEFAULT));</span>
<span class="lineNum">    2015 </span><span class="lineCov">      57499 :                         t = (char*)mono_vtable_get_static_field_data (vt) + field-&gt;offset;</span>
<span class="lineNum">    2016 </span>            :                         /* some fields don't really have rva, they are just zeroed (bss? bug #343083) */
<span class="lineNum">    2017 </span><span class="lineCov">      57499 :                         if (!data)</span>
<span class="lineNum">    2018 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    2019 </span><span class="lineCov">      57499 :                         if (fklass-&gt;valuetype) {</span>
<span class="lineNum">    2020 </span><span class="lineCov">      57499 :                                 memcpy (t, data, mono_class_value_size (fklass, NULL));</span>
<span class="lineNum">    2021 </span><span class="lineCov">      57499 :                         } else {</span>
<span class="lineNum">    2022 </span>            :                                 /* it's a pointer type: add check */
<span class="lineNum">    2023 </span><span class="lineNoCov">          0 :                                 g_assert ((fklass-&gt;byval_arg.type == MONO_TYPE_PTR) || (fklass-&gt;byval_arg.type == MONO_TYPE_FNPTR));</span>
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :                                 *t = *(char *)data;</span>
<span class="lineNum">    2025 </span>            :                         }
<span class="lineNum">    2026 </span><span class="lineCov">      57499 :                         continue;</span>
<span class="lineNum">    2027 </span>            :                 }               
<span class="lineNum">    2028 </span>            :         }
<span class="lineNum">    2029 </span>            : 
<span class="lineNum">    2030 </span><span class="lineCov">    4679029 :         vt-&gt;max_interface_id = klass-&gt;max_interface_id;</span>
<span class="lineNum">    2031 </span><span class="lineCov">    4679029 :         vt-&gt;interface_bitmap = klass-&gt;interface_bitmap;</span>
<span class="lineNum">    2032 </span>            :         
<span class="lineNum">    2033 </span>            :         //printf (&quot;Initializing VT for class %s (interface_offsets_count = %d)\n&quot;,
<span class="lineNum">    2034 </span>            :         //              class-&gt;name, klass-&gt;interface_offsets_count);
<span class="lineNum">    2035 </span>            : 
<span class="lineNum">    2036 </span>            :         /* Initialize vtable */
<span class="lineNum">    2037 </span><span class="lineCov">    4679029 :         if (callbacks.get_vtable_trampoline) {</span>
<span class="lineNum">    2038 </span>            :                 // This also covers the AOT case
<span class="lineNum">    2039 </span><span class="lineCov">  238335858 :                 for (i = 0; i &lt; klass-&gt;vtable_size; ++i) {</span>
<span class="lineNum">    2040 </span><span class="lineCov">  114488900 :                         vt-&gt;vtable [i] = callbacks.get_vtable_trampoline (vt, i);</span>
<span class="lineNum">    2041 </span><span class="lineCov">  114488900 :                 }</span>
<span class="lineNum">    2042 </span><span class="lineCov">    4679029 :         } else {</span>
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :                 mono_class_setup_vtable (klass);</span>
<span class="lineNum">    2044 </span>            : 
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; klass-&gt;vtable_size; ++i) {</span>
<span class="lineNum">    2046 </span>            :                         MonoMethod *cm;
<span class="lineNum">    2047 </span>            : 
<span class="lineNum">    2048 </span><span class="lineNoCov">          0 :                         cm = klass-&gt;vtable [i];</span>
<span class="lineNum">    2049 </span><span class="lineNoCov">          0 :                         if (cm) {</span>
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :                                 vt-&gt;vtable [i] = callbacks.create_jit_trampoline (domain, cm, error);</span>
<span class="lineNum">    2051 </span><span class="lineNoCov">          0 :                                 if (!is_ok (error)) {</span>
<span class="lineNum">    2052 </span><span class="lineNoCov">          0 :                                         mono_domain_unlock (domain);</span>
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :                                         mono_loader_unlock ();</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :                                         return NULL;</span>
<span class="lineNum">    2055 </span>            :                                 }
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    2057 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2058 </span>            :         }
<span class="lineNum">    2059 </span>            : 
<span class="lineNum">    2060 </span><span class="lineCov">    4679029 :         if (imt_table_bytes) {</span>
<span class="lineNum">    2061 </span>            :                 /* Now that the vtable is full, we can actually fill up the IMT */
<span class="lineNum">    2062 </span><span class="lineCov">  124190040 :                         for (i = 0; i &lt; MONO_IMT_SIZE; ++i)</span>
<span class="lineNum">    2063 </span><span class="lineCov">   58990269 :                                 interface_offsets [i] = callbacks.get_imt_trampoline (vt, i);</span>
<span class="lineNum">    2064 </span><span class="lineCov">    3104751 :         }</span>
<span class="lineNum">    2065 </span>            : 
<span class="lineNum">    2066 </span>            :         /*
<span class="lineNum">    2067 </span>            :          * FIXME: Is it ok to allocate while holding the domain/loader locks ? If not, we can release them, allocate, then
<span class="lineNum">    2068 </span>            :          * re-acquire them and check if another thread has created the vtable in the meantime.
<span class="lineNum">    2069 </span>            :          */
<span class="lineNum">    2070 </span>            :         /* Special case System.MonoType to avoid infinite recursion */
<span class="lineNum">    2071 </span><span class="lineCov">    4679029 :         if (klass != mono_defaults.runtimetype_class) {</span>
<span class="lineNum">    2072 </span><span class="lineCov">    4675491 :                 vt-&gt;type = mono_type_get_object_checked (domain, &amp;klass-&gt;byval_arg, error);</span>
<span class="lineNum">    2073 </span><span class="lineCov">    4675491 :                 if (!is_ok (error)) {</span>
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :                         mono_loader_unlock ();</span>
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    2077 </span>            :                 }
<span class="lineNum">    2078 </span>            : 
<span class="lineNum">    2079 </span><span class="lineCov">    4675491 :                 if (mono_object_get_class ((MonoObject *)vt-&gt;type) != mono_defaults.runtimetype_class)</span>
<span class="lineNum">    2080 </span>            :                         /* This is unregistered in
<span class="lineNum">    2081 </span>            :                            unregister_vtable_reflection_type() in
<span class="lineNum">    2082 </span>            :                            domain.c. */
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :                         MONO_GC_REGISTER_ROOT_IF_MOVING(vt-&gt;type, MONO_ROOT_SOURCE_REFLECTION, &quot;vtable reflection type&quot;);</span>
<span class="lineNum">    2084 </span><span class="lineCov">    4675491 :         }</span>
<span class="lineNum">    2085 </span>            : 
<span class="lineNum">    2086 </span><span class="lineCov">    9358058 :         mono_vtable_set_is_remote (vt, mono_class_is_contextbound (klass));</span>
<span class="lineNum">    2087 </span>            : 
<span class="lineNum">    2088 </span>            :         /*  class_vtable_array keeps an array of created vtables
<span class="lineNum">    2089 </span>            :          */
<span class="lineNum">    2090 </span><span class="lineCov">    4679029 :         g_ptr_array_add (domain-&gt;class_vtable_array, vt);</span>
<span class="lineNum">    2091 </span>            :         /* klass-&gt;runtime_info is protected by the loader lock, both when
<span class="lineNum">    2092 </span>            :          * it it enlarged and when it is stored info.
<span class="lineNum">    2093 </span>            :          */
<span class="lineNum">    2094 </span>            : 
<span class="lineNum">    2095 </span>            :         /*
<span class="lineNum">    2096 </span>            :          * Store the vtable in klass-&gt;runtime_info.
<span class="lineNum">    2097 </span>            :          * klass-&gt;runtime_info is accessed without locking, so this do this last after the vtable has been constructed.
<span class="lineNum">    2098 </span>            :          */
<span class="lineNum">    2099 </span><span class="lineCov">    4679029 :         mono_memory_barrier ();</span>
<span class="lineNum">    2100 </span>            : 
<span class="lineNum">    2101 </span><span class="lineCov">    4679029 :         old_info = klass-&gt;runtime_info;</span>
<span class="lineNum">    2102 </span><span class="lineCov">    4789469 :         if (old_info &amp;&amp; old_info-&gt;max_domain &gt;= domain-&gt;domain_id) {</span>
<span class="lineNum">    2103 </span>            :                 /* someone already created a large enough runtime info */
<span class="lineNum">    2104 </span><span class="lineCov">     107804 :                 old_info-&gt;domain_vtables [domain-&gt;domain_id] = vt;</span>
<span class="lineNum">    2105 </span><span class="lineCov">     107804 :         } else {</span>
<span class="lineNum">    2106 </span><span class="lineCov">    4571225 :                 int new_size = domain-&gt;domain_id;</span>
<span class="lineNum">    2107 </span><span class="lineCov">    4571225 :                 if (old_info)</span>
<span class="lineNum">    2108 </span><span class="lineCov">       7908 :                         new_size = MAX (new_size, old_info-&gt;max_domain);</span>
<span class="lineNum">    2109 </span><span class="lineCov">    4571225 :                 new_size++;</span>
<span class="lineNum">    2110 </span>            :                 /* make the new size a power of two */
<span class="lineNum">    2111 </span><span class="lineCov">    4571225 :                 i = 2;</span>
<span class="lineNum">    2112 </span><span class="lineCov">    9150970 :                 while (new_size &gt; i)</span>
<span class="lineNum">    2113 </span><span class="lineCov">       4260 :                         i &lt;&lt;= 1;</span>
<span class="lineNum">    2114 </span><span class="lineCov">    4571225 :                 new_size = i;</span>
<span class="lineNum">    2115 </span>            :                 /* this is a bounded memory retention issue: may want to 
<span class="lineNum">    2116 </span>            :                  * handle it differently when we'll have a rcu-like system.
<span class="lineNum">    2117 </span>            :                  */
<span class="lineNum">    2118 </span><span class="lineCov">    4571225 :                 runtime_info = (MonoClassRuntimeInfo *)mono_image_alloc0 (klass-&gt;image, MONO_SIZEOF_CLASS_RUNTIME_INFO + new_size * sizeof (gpointer));</span>
<span class="lineNum">    2119 </span><span class="lineCov">    4571225 :                 runtime_info-&gt;max_domain = new_size - 1;</span>
<span class="lineNum">    2120 </span>            :                 /* copy the stuff from the older info */
<span class="lineNum">    2121 </span><span class="lineCov">    4571225 :                 if (old_info) {</span>
<span class="lineNum">    2122 </span><span class="lineCov">       2636 :                         memcpy (runtime_info-&gt;domain_vtables, old_info-&gt;domain_vtables, (old_info-&gt;max_domain + 1) * sizeof (gpointer));</span>
<span class="lineNum">    2123 </span><span class="lineCov">       2636 :                 }</span>
<span class="lineNum">    2124 </span><span class="lineCov">    4571225 :                 runtime_info-&gt;domain_vtables [domain-&gt;domain_id] = vt;</span>
<span class="lineNum">    2125 </span>            :                 /* keep this last*/
<span class="lineNum">    2126 </span><span class="lineCov">    4571225 :                 mono_memory_barrier ();</span>
<span class="lineNum">    2127 </span><span class="lineCov">    4571225 :                 klass-&gt;runtime_info = runtime_info;</span>
<span class="lineNum">    2128 </span>            :         }
<span class="lineNum">    2129 </span>            : 
<span class="lineNum">    2130 </span><span class="lineCov">    4679029 :         if (klass == mono_defaults.runtimetype_class) {</span>
<span class="lineNum">    2131 </span><span class="lineCov">       3538 :                 vt-&gt;type = mono_type_get_object_checked (domain, &amp;klass-&gt;byval_arg, error);</span>
<span class="lineNum">    2132 </span><span class="lineCov">       3538 :                 if (!is_ok (error)) {</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :                         mono_loader_unlock ();</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    2136 </span>            :                 }
<span class="lineNum">    2137 </span>            : 
<span class="lineNum">    2138 </span><span class="lineCov">       3538 :                 if (mono_object_get_class ((MonoObject *)vt-&gt;type) != mono_defaults.runtimetype_class)</span>
<span class="lineNum">    2139 </span>            :                         /* This is unregistered in
<span class="lineNum">    2140 </span>            :                            unregister_vtable_reflection_type() in
<span class="lineNum">    2141 </span>            :                            domain.c. */
<span class="lineNum">    2142 </span><span class="lineNoCov">          0 :                         MONO_GC_REGISTER_ROOT_IF_MOVING(vt-&gt;type, MONO_ROOT_SOURCE_REFLECTION, &quot;vtable reflection type&quot;);</span>
<span class="lineNum">    2143 </span><span class="lineCov">       3538 :         }</span>
<span class="lineNum">    2144 </span>            : 
<span class="lineNum">    2145 </span><span class="lineCov">    4679028 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    2146 </span><span class="lineCov">    4679028 :         mono_loader_unlock ();</span>
<span class="lineNum">    2147 </span>            : 
<span class="lineNum">    2148 </span>            :         /* make sure the parent is initialized */
<span class="lineNum">    2149 </span>            :         /*FIXME shouldn't this fail the current type?*/
<span class="lineNum">    2150 </span><span class="lineCov">    4679028 :         if (klass-&gt;parent)</span>
<span class="lineNum">    2151 </span><span class="lineCov">    4668072 :                 mono_class_vtable_full (domain, klass-&gt;parent, error);</span>
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span><span class="lineCov">    4679029 :         return vt;</span>
<span class="lineNum">    2154 </span><span class="lineCov">    4944439 : }</span>
<span class="lineNum">    2155 </span>            : 
<span class="lineNum">    2156 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    2157 </span>            : /**
<span class="lineNum">    2158 </span>            :  * mono_class_proxy_vtable:
<span class="lineNum">    2159 </span>            :  * @domain: the application domain
<span class="lineNum">    2160 </span>            :  * @remove_class: the remote class
<span class="lineNum">    2161 </span>            :  * @error: set on error
<span class="lineNum">    2162 </span>            :  *
<span class="lineNum">    2163 </span>            :  * Creates a vtable for transparent proxies. It is basically
<span class="lineNum">    2164 </span>            :  * a copy of the real vtable of the class wrapped in @remote_class,
<span class="lineNum">    2165 </span>            :  * but all function pointers invoke the remoting functions, and
<span class="lineNum">    2166 </span>            :  * vtable-&gt;klass points to the transparent proxy class, and not to @class.
<span class="lineNum">    2167 </span>            :  *
<span class="lineNum">    2168 </span>            :  * On failure returns NULL and sets @error
<a name="2169"><span class="lineNum">    2169 </span>            :  */</a>
<span class="lineNum">    2170 </span>            : static MonoVTable *
<span class="lineNum">    2171 </span>            : mono_class_proxy_vtable (MonoDomain *domain, MonoRemoteClass *remote_class, MonoRemotingTarget target_type, MonoError *error)
<span class="lineNum">    2172 </span>            : {
<span class="lineNum">    2173 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2174 </span>            : 
<span class="lineNum">    2175 </span>            :         MonoVTable *vt, *pvt;
<span class="lineNum">    2176 </span><span class="lineCov">        746 :         int i, j, vtsize, extra_interface_vtsize = 0;</span>
<span class="lineNum">    2177 </span>            :         guint32 max_interface_id;
<span class="lineNum">    2178 </span>            :         MonoClass *k;
<span class="lineNum">    2179 </span><span class="lineCov">        746 :         GSList *extra_interfaces = NULL;</span>
<span class="lineNum">    2180 </span><span class="lineCov">        746 :         MonoClass *klass = remote_class-&gt;proxy_class;</span>
<span class="lineNum">    2181 </span>            :         gpointer *interface_offsets;
<span class="lineNum">    2182 </span><span class="lineCov">        746 :         uint8_t *bitmap = NULL;</span>
<span class="lineNum">    2183 </span>            :         int bsize;
<span class="lineNum">    2184 </span>            :         size_t imt_table_bytes;
<span class="lineNum">    2185 </span>            :         
<span class="lineNum">    2186 </span>            : #ifdef COMPRESSED_INTERFACE_BITMAP
<span class="lineNum">    2187 </span>            :         int bcsize;
<span class="lineNum">    2188 </span>            : #endif
<span class="lineNum">    2189 </span>            : 
<span class="lineNum">    2190 </span><span class="lineCov">        746 :         mono_error_init (error);</span>
<span class="lineNum">    2191 </span>            : 
<span class="lineNum">    2192 </span><span class="lineCov">        746 :         vt = mono_class_vtable (domain, klass);</span>
<span class="lineNum">    2193 </span><span class="lineCov">       2238 :         g_assert (vt); /*FIXME property handle failure*/</span>
<span class="lineNum">    2194 </span><span class="lineCov">        746 :         max_interface_id = vt-&gt;max_interface_id;</span>
<span class="lineNum">    2195 </span>            :         
<span class="lineNum">    2196 </span>            :         /* Calculate vtable space for extra interfaces */
<span class="lineNum">    2197 </span><span class="lineCov">     182104 :         for (j = 0; j &lt; remote_class-&gt;interface_count; j++) {</span>
<span class="lineNum">    2198 </span><span class="lineCov">      90306 :                 MonoClass* iclass = remote_class-&gt;interfaces[j];</span>
<span class="lineNum">    2199 </span>            :                 GPtrArray *ifaces;
<span class="lineNum">    2200 </span>            :                 int method_count;
<span class="lineNum">    2201 </span>            : 
<span class="lineNum">    2202 </span>            :                 /*FIXME test for interfaces with variant generic arguments*/
<span class="lineNum">    2203 </span><span class="lineCov">      90306 :                 if (MONO_CLASS_IMPLEMENTS_INTERFACE (klass, iclass-&gt;interface_id))</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :                         continue;       /* interface implemented by the class */</span>
<span class="lineNum">    2205 </span><span class="lineCov">      90306 :                 if (g_slist_find (extra_interfaces, iclass))</span>
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2207 </span>            :                         
<span class="lineNum">    2208 </span><span class="lineCov">      90306 :                 extra_interfaces = g_slist_prepend (extra_interfaces, iclass);</span>
<span class="lineNum">    2209 </span>            :                 
<span class="lineNum">    2210 </span><span class="lineCov">      90306 :                 method_count = mono_class_num_methods (iclass);</span>
<span class="lineNum">    2211 </span>            :         
<span class="lineNum">    2212 </span><span class="lineCov">      90306 :                 ifaces = mono_class_get_implemented_interfaces (iclass, error);</span>
<span class="lineNum">    2213 </span><span class="lineCov">      90306 :                 if (!is_ok (error))</span>
<span class="lineNum">    2214 </span><span class="lineNoCov">          0 :                         goto failure;</span>
<span class="lineNum">    2215 </span><span class="lineCov">      90306 :                 if (ifaces) {</span>
<span class="lineNum">    2216 </span><span class="lineNoCov">          0 :                         for (i = 0; i &lt; ifaces-&gt;len; ++i) {</span>
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :                                 MonoClass *ic = (MonoClass *)g_ptr_array_index (ifaces, i);</span>
<span class="lineNum">    2218 </span>            :                                 /*FIXME test for interfaces with variant generic arguments*/
<span class="lineNum">    2219 </span><span class="lineNoCov">          0 :                                 if (MONO_CLASS_IMPLEMENTS_INTERFACE (klass, ic-&gt;interface_id))</span>
<span class="lineNum">    2220 </span><span class="lineNoCov">          0 :                                         continue;       /* interface implemented by the class */</span>
<span class="lineNum">    2221 </span><span class="lineNoCov">          0 :                                 if (g_slist_find (extra_interfaces, ic))</span>
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :                                 extra_interfaces = g_slist_prepend (extra_interfaces, ic);</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :                                 method_count += mono_class_num_methods (ic);</span>
<span class="lineNum">    2225 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    2226 </span><span class="lineNoCov">          0 :                         g_ptr_array_free (ifaces, TRUE);</span>
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :                         ifaces = NULL;</span>
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2229 </span>            : 
<span class="lineNum">    2230 </span><span class="lineCov">      90306 :                 extra_interface_vtsize += method_count * sizeof (gpointer);</span>
<span class="lineNum">    2231 </span><span class="lineCov">     172402 :                 if (iclass-&gt;max_interface_id &gt; max_interface_id) max_interface_id = iclass-&gt;max_interface_id;</span>
<span class="lineNum">    2232 </span><span class="lineCov">      90306 :         }</span>
<span class="lineNum">    2233 </span>            : 
<span class="lineNum">    2234 </span><span class="lineCov">        746 :         imt_table_bytes = sizeof (gpointer) * MONO_IMT_SIZE;</span>
<span class="lineNum">    2235 </span><span class="lineCov">        746 :         mono_stats.imt_number_of_tables++;</span>
<span class="lineNum">    2236 </span><span class="lineCov">        746 :         mono_stats.imt_tables_size += imt_table_bytes;</span>
<span class="lineNum">    2237 </span>            : 
<span class="lineNum">    2238 </span><span class="lineCov">        746 :         vtsize = imt_table_bytes + MONO_SIZEOF_VTABLE + klass-&gt;vtable_size * sizeof (gpointer);</span>
<span class="lineNum">    2239 </span>            : 
<span class="lineNum">    2240 </span><span class="lineCov">        746 :         mono_stats.class_vtable_size += vtsize + extra_interface_vtsize;</span>
<span class="lineNum">    2241 </span>            : 
<span class="lineNum">    2242 </span><span class="lineCov">        746 :         interface_offsets = alloc_vtable (domain, vtsize + extra_interface_vtsize, imt_table_bytes);</span>
<span class="lineNum">    2243 </span><span class="lineCov">        746 :         pvt = (MonoVTable*) ((char*)interface_offsets + imt_table_bytes);</span>
<span class="lineNum">    2244 </span><span class="lineCov">       2238 :         g_assert (!((gsize)pvt &amp; 7));</span>
<span class="lineNum">    2245 </span>            : 
<span class="lineNum">    2246 </span><span class="lineCov">        746 :         memcpy (pvt, vt, MONO_SIZEOF_VTABLE + klass-&gt;vtable_size * sizeof (gpointer));</span>
<span class="lineNum">    2247 </span>            : 
<span class="lineNum">    2248 </span><span class="lineCov">        746 :         pvt-&gt;klass = mono_defaults.transparent_proxy_class;</span>
<span class="lineNum">    2249 </span>            :         /* we need to keep the GC descriptor for a transparent proxy or we confuse the precise GC */
<span class="lineNum">    2250 </span><span class="lineCov">        746 :         pvt-&gt;gc_descr = mono_defaults.transparent_proxy_class-&gt;gc_descr;</span>
<span class="lineNum">    2251 </span>            : 
<span class="lineNum">    2252 </span>            :         /* initialize vtable */
<span class="lineNum">    2253 </span><span class="lineCov">        746 :         mono_class_setup_vtable (klass);</span>
<span class="lineNum">    2254 </span><span class="lineCov">      20374 :         for (i = 0; i &lt; klass-&gt;vtable_size; ++i) {</span>
<span class="lineNum">    2255 </span>            :                 MonoMethod *cm;
<span class="lineNum">    2256 </span>            :                     
<span class="lineNum">    2257 </span><span class="lineCov">       9441 :                 if ((cm = klass-&gt;vtable [i])) {</span>
<span class="lineNum">    2258 </span><span class="lineCov">       9441 :                         pvt-&gt;vtable [i] = create_remoting_trampoline (domain, cm, target_type, error);</span>
<span class="lineNum">    2259 </span><span class="lineCov">       9441 :                         if (!is_ok (error))</span>
<span class="lineNum">    2260 </span><span class="lineNoCov">          0 :                                 goto failure;</span>
<span class="lineNum">    2261 </span><span class="lineCov">       9441 :                 } else</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :                         pvt-&gt;vtable [i] = NULL;</span>
<span class="lineNum">    2263 </span><span class="lineCov">       9441 :         }</span>
<span class="lineNum">    2264 </span>            : 
<span class="lineNum">    2265 </span><span class="lineCov">        746 :         if (mono_class_is_abstract (klass)) {</span>
<span class="lineNum">    2266 </span>            :                 /* create trampolines for abstract methods */
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :                 for (k = klass; k; k = k-&gt;parent) {</span>
<span class="lineNum">    2268 </span>            :                         MonoMethod* m;
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :                         gpointer iter = NULL;</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :                         while ((m = mono_class_get_methods (k, &amp;iter)))</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :                                 if (!pvt-&gt;vtable [m-&gt;slot]) {</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :                                         pvt-&gt;vtable [m-&gt;slot] = create_remoting_trampoline (domain, m, target_type, error);</span>
<span class="lineNum">    2273 </span><span class="lineNoCov">          0 :                                         if (!is_ok (error))</span>
<span class="lineNum">    2274 </span><span class="lineNoCov">          0 :                                                 goto failure;</span>
<span class="lineNum">    2275 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">    2276 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2277 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2278 </span>            : 
<span class="lineNum">    2279 </span><span class="lineCov">        746 :         pvt-&gt;max_interface_id = max_interface_id;</span>
<span class="lineNum">    2280 </span><span class="lineCov">        746 :         bsize = sizeof (guint8) * (max_interface_id/8 + 1 );</span>
<span class="lineNum">    2281 </span>            : #ifdef COMPRESSED_INTERFACE_BITMAP
<span class="lineNum">    2282 </span>            :         bitmap = (uint8_t *)g_malloc0 (bsize);
<span class="lineNum">    2283 </span>            : #else
<span class="lineNum">    2284 </span><span class="lineCov">        746 :         bitmap = (uint8_t *)mono_domain_alloc0 (domain, bsize);</span>
<span class="lineNum">    2285 </span>            : #endif
<span class="lineNum">    2286 </span>            : 
<span class="lineNum">    2287 </span><span class="lineCov">       1774 :         for (i = 0; i &lt; klass-&gt;interface_offsets_count; ++i) {</span>
<span class="lineNum">    2288 </span><span class="lineCov">        141 :                 int interface_id = klass-&gt;interfaces_packed [i]-&gt;interface_id;</span>
<span class="lineNum">    2289 </span><span class="lineCov">        141 :                 bitmap [interface_id &gt;&gt; 3] |= (1 &lt;&lt; (interface_id &amp; 7));</span>
<span class="lineNum">    2290 </span><span class="lineCov">        141 :         }</span>
<span class="lineNum">    2291 </span>            : 
<span class="lineNum">    2292 </span><span class="lineCov">        746 :         if (extra_interfaces) {</span>
<span class="lineNum">    2293 </span><span class="lineCov">        604 :                 int slot = klass-&gt;vtable_size;</span>
<span class="lineNum">    2294 </span>            :                 MonoClass* interf;
<span class="lineNum">    2295 </span>            :                 gpointer iter;
<span class="lineNum">    2296 </span>            :                 MonoMethod* cm;
<span class="lineNum">    2297 </span>            :                 GSList *list_item;
<span class="lineNum">    2298 </span>            : 
<span class="lineNum">    2299 </span>            :                 /* Create trampolines for the methods of the interfaces */
<span class="lineNum">    2300 </span><span class="lineCov">     181820 :                 for (list_item = extra_interfaces; list_item != NULL; list_item=list_item-&gt;next) {</span>
<span class="lineNum">    2301 </span><span class="lineCov">      90306 :                         interf = (MonoClass *)list_item-&gt;data;</span>
<span class="lineNum">    2302 </span>            :                         
<span class="lineNum">    2303 </span><span class="lineCov">      90306 :                         bitmap [interf-&gt;interface_id &gt;&gt; 3] |= (1 &lt;&lt; (interf-&gt;interface_id &amp; 7));</span>
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span><span class="lineCov">      90306 :                         iter = NULL;</span>
<span class="lineNum">    2306 </span><span class="lineCov">      90306 :                         j = 0;</span>
<span class="lineNum">    2307 </span><span class="lineCov">     361368 :                         while ((cm = mono_class_get_methods (interf, &amp;iter))) {</span>
<span class="lineNum">    2308 </span><span class="lineCov">      90378 :                                 pvt-&gt;vtable [slot + j++] = create_remoting_trampoline (domain, cm, target_type, error);</span>
<span class="lineNum">    2309 </span><span class="lineCov">      90378 :                                 if (!is_ok (error))</span>
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :                                         goto failure;</span>
<span class="lineNum">    2311 </span>            :                         }
<span class="lineNum">    2312 </span>            :                         
<span class="lineNum">    2313 </span><span class="lineCov">      90306 :                         slot += mono_class_num_methods (interf);</span>
<span class="lineNum">    2314 </span><span class="lineCov">      90306 :                 }</span>
<span class="lineNum">    2315 </span><span class="lineCov">        604 :         }</span>
<span class="lineNum">    2316 </span>            : 
<span class="lineNum">    2317 </span>            :         /* Now that the vtable is full, we can actually fill up the IMT */
<span class="lineNum">    2318 </span><span class="lineCov">        746 :         build_imt (klass, pvt, domain, interface_offsets, extra_interfaces);</span>
<span class="lineNum">    2319 </span><span class="lineCov">        746 :         if (extra_interfaces) {</span>
<span class="lineNum">    2320 </span><span class="lineCov">        604 :                 g_slist_free (extra_interfaces);</span>
<span class="lineNum">    2321 </span><span class="lineCov">        604 :         }</span>
<span class="lineNum">    2322 </span>            : 
<span class="lineNum">    2323 </span>            : #ifdef COMPRESSED_INTERFACE_BITMAP
<span class="lineNum">    2324 </span>            :         bcsize = mono_compress_bitmap (NULL, bitmap, bsize);
<span class="lineNum">    2325 </span>            :         pvt-&gt;interface_bitmap = mono_domain_alloc0 (domain, bcsize);
<span class="lineNum">    2326 </span>            :         mono_compress_bitmap (pvt-&gt;interface_bitmap, bitmap, bsize);
<span class="lineNum">    2327 </span>            :         g_free (bitmap);
<span class="lineNum">    2328 </span>            : #else
<span class="lineNum">    2329 </span><span class="lineCov">        746 :         pvt-&gt;interface_bitmap = bitmap;</span>
<span class="lineNum">    2330 </span>            : #endif
<span class="lineNum">    2331 </span><span class="lineCov">        746 :         return pvt;</span>
<span class="lineNum">    2332 </span>            : failure:
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 :         if (extra_interfaces)</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :                 g_slist_free (extra_interfaces);</span>
<span class="lineNum">    2335 </span>            : #ifdef COMPRESSED_INTERFACE_BITMAP
<span class="lineNum">    2336 </span>            :         g_free (bitmap);
<span class="lineNum">    2337 </span>            : #endif
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    2339 </span><span class="lineCov">        746 : }</span>
<span class="lineNum">    2340 </span>            : 
<span class="lineNum">    2341 </span>            : #endif /* DISABLE_REMOTING */
<span class="lineNum">    2342 </span>            : 
<span class="lineNum">    2343 </span>            : /**
<span class="lineNum">    2344 </span>            :  * mono_class_field_is_special_static:
<span class="lineNum">    2345 </span>            :  *
<span class="lineNum">    2346 </span>            :  *   Returns whether @field is a thread/context static field.
<a name="2347"><span class="lineNum">    2347 </span>            :  */</a>
<span class="lineNum">    2348 </span>            : gboolean
<span class="lineNum">    2349 </span>            : mono_class_field_is_special_static (MonoClassField *field)
<span class="lineNum">    2350 </span>            : {
<span class="lineNum">    2351 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">    2352 </span>            : 
<span class="lineNum">    2353 </span><span class="lineCov">    7608296 :         if (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC))</span>
<span class="lineNum">    2354 </span><span class="lineCov">      10231 :                 return FALSE;</span>
<span class="lineNum">    2355 </span><span class="lineCov">    7598073 :         if (mono_field_is_deleted (field))</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2357 </span><span class="lineCov">    7598055 :         if (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL)) {</span>
<span class="lineNum">    2358 </span><span class="lineCov">    7589477 :                 if (field_is_special_static (field-&gt;parent, field) != SPECIAL_STATIC_NONE)</span>
<span class="lineNum">    2359 </span><span class="lineCov">     245209 :                         return TRUE;</span>
<span class="lineNum">    2360 </span><span class="lineCov">    7344200 :         }</span>
<span class="lineNum">    2361 </span><span class="lineCov">    7352549 :         return FALSE;</span>
<span class="lineNum">    2362 </span><span class="lineCov">    7608012 : }</span>
<span class="lineNum">    2363 </span>            : 
<span class="lineNum">    2364 </span>            : /**
<span class="lineNum">    2365 </span>            :  * mono_class_field_get_special_static_type:
<span class="lineNum">    2366 </span>            :  * @field: The MonoClassField describing the field.
<span class="lineNum">    2367 </span>            :  *
<span class="lineNum">    2368 </span>            :  * Returns: SPECIAL_STATIC_THREAD if the field is thread static, SPECIAL_STATIC_CONTEXT if it is context static,
<span class="lineNum">    2369 </span>            :  * SPECIAL_STATIC_NONE otherwise.
<a name="2370"><span class="lineNum">    2370 </span>            :  */</a>
<span class="lineNum">    2371 </span>            : guint32
<span class="lineNum">    2372 </span>            : mono_class_field_get_special_static_type (MonoClassField *field)
<span class="lineNum">    2373 </span>            : {
<span class="lineNum">    2374 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">    2375 </span>            : 
<span class="lineNum">    2376 </span><span class="lineNoCov">          0 :         if (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC))</span>
<span class="lineNum">    2377 </span><span class="lineNoCov">          0 :                 return SPECIAL_STATIC_NONE;</span>
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :         if (mono_field_is_deleted (field))</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :                 return SPECIAL_STATIC_NONE;</span>
<span class="lineNum">    2380 </span><span class="lineNoCov">          0 :         if (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL))</span>
<span class="lineNum">    2381 </span><span class="lineNoCov">          0 :                 return field_is_special_static (field-&gt;parent, field);</span>
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :         return SPECIAL_STATIC_NONE;</span>
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2384 </span>            : 
<span class="lineNum">    2385 </span>            : /**
<span class="lineNum">    2386 </span>            :  * mono_class_has_special_static_fields:
<span class="lineNum">    2387 </span>            :  * 
<span class="lineNum">    2388 </span>            :  *   Returns whenever @klass has any thread/context static fields.
<a name="2389"><span class="lineNum">    2389 </span>            :  */</a>
<span class="lineNum">    2390 </span>            : gboolean
<span class="lineNum">    2391 </span>            : mono_class_has_special_static_fields (MonoClass *klass)
<span class="lineNum">    2392 </span>            : {
<span class="lineNum">    2393 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">    2394 </span>            : 
<span class="lineNum">    2395 </span>            :         MonoClassField *field;
<span class="lineNum">    2396 </span>            :         gpointer iter;
<span class="lineNum">    2397 </span>            : 
<span class="lineNum">    2398 </span><span class="lineCov">       4482 :         iter = NULL;</span>
<span class="lineNum">    2399 </span><span class="lineCov">      49774 :         while ((field = mono_class_get_fields (klass, &amp;iter))) {</span>
<span class="lineNum">    2400 </span><span class="lineCov">      61251 :                 g_assert (field-&gt;parent == klass);</span>
<span class="lineNum">    2401 </span><span class="lineCov">      20417 :                 if (mono_class_field_is_special_static (field))</span>
<span class="lineNum">    2402 </span><span class="lineCov">         12 :                         return TRUE;</span>
<span class="lineNum">    2403 </span>            :         }
<span class="lineNum">    2404 </span>            : 
<span class="lineNum">    2405 </span><span class="lineCov">       4470 :         return FALSE;</span>
<span class="lineNum">    2406 </span><span class="lineCov">       4482 : }</span>
<span class="lineNum">    2407 </span>            : 
<span class="lineNum">    2408 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    2409 </span>            : /**
<span class="lineNum">    2410 </span>            :  * create_remote_class_key:
<span class="lineNum">    2411 </span>            :  * Creates an array of pointers that can be used as a hash key for a remote class.
<span class="lineNum">    2412 </span>            :  * The first element of the array is the number of pointers.
<a name="2413"><span class="lineNum">    2413 </span>            :  */</a>
<span class="lineNum">    2414 </span>            : static gpointer*
<span class="lineNum">    2415 </span>            : create_remote_class_key (MonoRemoteClass *remote_class, MonoClass *extra_class)
<span class="lineNum">    2416 </span>            : {
<span class="lineNum">    2417 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    2418 </span>            : 
<span class="lineNum">    2419 </span>            :         gpointer *key;
<span class="lineNum">    2420 </span>            :         int i, j;
<span class="lineNum">    2421 </span>            :         
<span class="lineNum">    2422 </span><span class="lineCov">       1449 :         if (remote_class == NULL) {</span>
<span class="lineNum">    2423 </span><span class="lineCov">        845 :                 if (mono_class_is_interface (extra_class)) {</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :                         key = (void **)g_malloc (sizeof(gpointer) * 3);</span>
<span class="lineNum">    2425 </span><span class="lineNoCov">          0 :                         key [0] = GINT_TO_POINTER (2);</span>
<span class="lineNum">    2426 </span><span class="lineNoCov">          0 :                         key [1] = mono_defaults.marshalbyrefobject_class;</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :                         key [2] = extra_class;</span>
<span class="lineNum">    2428 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    2429 </span><span class="lineCov">        845 :                         key = (void **)g_malloc (sizeof(gpointer) * 2);</span>
<span class="lineNum">    2430 </span><span class="lineCov">        845 :                         key [0] = GINT_TO_POINTER (1);</span>
<span class="lineNum">    2431 </span><span class="lineCov">        845 :                         key [1] = extra_class;</span>
<span class="lineNum">    2432 </span>            :                 }
<span class="lineNum">    2433 </span><span class="lineCov">        845 :         } else {</span>
<span class="lineNum">    2434 </span><span class="lineCov">       1208 :                 if (extra_class != NULL &amp;&amp; mono_class_is_interface (extra_class)) {</span>
<span class="lineNum">    2435 </span><span class="lineCov">        604 :                         key = (void **)g_malloc (sizeof(gpointer) * (remote_class-&gt;interface_count + 3));</span>
<span class="lineNum">    2436 </span><span class="lineCov">        604 :                         key [0] = GINT_TO_POINTER (remote_class-&gt;interface_count + 2);</span>
<span class="lineNum">    2437 </span><span class="lineCov">        604 :                         key [1] = remote_class-&gt;proxy_class;</span>
<span class="lineNum">    2438 </span>            : 
<span class="lineNum">    2439 </span>            :                         // Keep the list of interfaces sorted
<span class="lineNum">    2440 </span><span class="lineCov">     180612 :                         for (i = 0, j = 2; i &lt; remote_class-&gt;interface_count; i++, j++) {</span>
<span class="lineNum">    2441 </span><span class="lineCov">     179053 :                                 if (extra_class &amp;&amp; remote_class-&gt;interfaces [i] &gt; extra_class) {</span>
<span class="lineNum">    2442 </span><span class="lineCov">         24 :                                         key [j++] = extra_class;</span>
<span class="lineNum">    2443 </span><span class="lineCov">         24 :                                         extra_class = NULL;</span>
<span class="lineNum">    2444 </span><span class="lineCov">         24 :                                 }</span>
<span class="lineNum">    2445 </span><span class="lineCov">      89702 :                                 key [j] = remote_class-&gt;interfaces [i];</span>
<span class="lineNum">    2446 </span><span class="lineCov">      89702 :                         }</span>
<span class="lineNum">    2447 </span><span class="lineCov">        604 :                         if (extra_class)</span>
<span class="lineNum">    2448 </span><span class="lineCov">        580 :                                 key [j] = extra_class;</span>
<span class="lineNum">    2449 </span><span class="lineCov">        604 :                 } else {</span>
<span class="lineNum">    2450 </span>            :                         // Replace the old class. The interface list is the same
<span class="lineNum">    2451 </span><span class="lineNoCov">          0 :                         key = (void **)g_malloc (sizeof(gpointer) * (remote_class-&gt;interface_count + 2));</span>
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 :                         key [0] = GINT_TO_POINTER (remote_class-&gt;interface_count + 1);</span>
<span class="lineNum">    2453 </span><span class="lineNoCov">          0 :                         key [1] = extra_class != NULL ? extra_class : remote_class-&gt;proxy_class;</span>
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :                         for (i = 0; i &lt; remote_class-&gt;interface_count; i++)</span>
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :                                 key [2 + i] = remote_class-&gt;interfaces [i];</span>
<span class="lineNum">    2456 </span>            :                 }
<span class="lineNum">    2457 </span>            :         }
<span class="lineNum">    2458 </span>            :         
<span class="lineNum">    2459 </span><span class="lineCov">       1449 :         return key;</span>
<span class="lineNum">    2460 </span>            : }
<span class="lineNum">    2461 </span>            : 
<span class="lineNum">    2462 </span>            : /**
<span class="lineNum">    2463 </span>            :  * copy_remote_class_key:
<span class="lineNum">    2464 </span>            :  *
<span class="lineNum">    2465 </span>            :  *   Make a copy of KEY in the domain and return the copy.
<a name="2466"><span class="lineNum">    2466 </span>            :  */</a>
<span class="lineNum">    2467 </span>            : static gpointer*
<span class="lineNum">    2468 </span>            : copy_remote_class_key (MonoDomain *domain, gpointer *key)
<span class="lineNum">    2469 </span>            : {
<span class="lineNum">    2470 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">    2471 </span>            : 
<span class="lineNum">    2472 </span><span class="lineCov">        746 :         int key_size = (GPOINTER_TO_UINT (key [0]) + 1) * sizeof (gpointer);</span>
<span class="lineNum">    2473 </span><span class="lineCov">        746 :         gpointer *mp_key = (gpointer *)mono_domain_alloc (domain, key_size);</span>
<span class="lineNum">    2474 </span>            : 
<span class="lineNum">    2475 </span><span class="lineCov">        746 :         memcpy (mp_key, key, key_size);</span>
<span class="lineNum">    2476 </span>            : 
<span class="lineNum">    2477 </span><span class="lineCov">        746 :         return mp_key;</span>
<span class="lineNum">    2478 </span>            : }
<span class="lineNum">    2479 </span>            : 
<span class="lineNum">    2480 </span>            : /**
<span class="lineNum">    2481 </span>            :  * mono_remote_class:
<span class="lineNum">    2482 </span>            :  * @domain: the application domain
<span class="lineNum">    2483 </span>            :  * @class_name: name of the remote class
<span class="lineNum">    2484 </span>            :  * @error: set on error
<span class="lineNum">    2485 </span>            :  *
<span class="lineNum">    2486 </span>            :  * Creates and initializes a MonoRemoteClass object for a remote type. 
<span class="lineNum">    2487 </span>            :  *
<span class="lineNum">    2488 </span>            :  * On failure returns NULL and sets @error
<a name="2489"><span class="lineNum">    2489 </span>            :  */</a>
<span class="lineNum">    2490 </span>            : MonoRemoteClass*
<span class="lineNum">    2491 </span>            : mono_remote_class (MonoDomain *domain, MonoStringHandle class_name, MonoClass *proxy_class, MonoError *error)
<span class="lineNum">    2492 </span>            : {
<span class="lineNum">    2493 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span>            :         MonoRemoteClass *rc;
<span class="lineNum">    2496 </span>            :         gpointer* key, *mp_key;
<span class="lineNum">    2497 </span>            :         char *name;
<span class="lineNum">    2498 </span>            :         
<span class="lineNum">    2499 </span><span class="lineCov">        845 :         mono_error_init (error);</span>
<span class="lineNum">    2500 </span>            : 
<span class="lineNum">    2501 </span><span class="lineCov">        845 :         key = create_remote_class_key (NULL, proxy_class);</span>
<span class="lineNum">    2502 </span>            :         
<span class="lineNum">    2503 </span><span class="lineCov">        845 :         mono_domain_lock (domain);</span>
<span class="lineNum">    2504 </span><span class="lineCov">        845 :         rc = (MonoRemoteClass *)g_hash_table_lookup (domain-&gt;proxy_vtable_hash, key);</span>
<span class="lineNum">    2505 </span>            : 
<span class="lineNum">    2506 </span><span class="lineCov">        845 :         if (rc) {</span>
<span class="lineNum">    2507 </span><span class="lineCov">        703 :                 g_free (key);</span>
<span class="lineNum">    2508 </span><span class="lineCov">        703 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    2509 </span><span class="lineCov">        703 :                 return rc;</span>
<span class="lineNum">    2510 </span>            :         }
<span class="lineNum">    2511 </span>            : 
<span class="lineNum">    2512 </span><span class="lineCov">        142 :         name = mono_string_to_utf8_mp (domain-&gt;mp, MONO_HANDLE_RAW (class_name), error);</span>
<span class="lineNum">    2513 </span><span class="lineCov">        142 :         if (!is_ok (error)) {</span>
<span class="lineNum">    2514 </span><span class="lineNoCov">          0 :                 g_free (key);</span>
<span class="lineNum">    2515 </span><span class="lineNoCov">          0 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    2516 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2517 </span>            :         }
<span class="lineNum">    2518 </span>            : 
<span class="lineNum">    2519 </span><span class="lineCov">        142 :         mp_key = copy_remote_class_key (domain, key);</span>
<span class="lineNum">    2520 </span><span class="lineCov">        142 :         g_free (key);</span>
<span class="lineNum">    2521 </span><span class="lineCov">        142 :         key = mp_key;</span>
<span class="lineNum">    2522 </span>            : 
<span class="lineNum">    2523 </span><span class="lineCov">        142 :         if (mono_class_is_interface (proxy_class)) {</span>
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :                 rc = (MonoRemoteClass *)mono_domain_alloc (domain, MONO_SIZEOF_REMOTE_CLASS + sizeof(MonoClass*));</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :                 rc-&gt;interface_count = 1;</span>
<span class="lineNum">    2526 </span><span class="lineNoCov">          0 :                 rc-&gt;interfaces [0] = proxy_class;</span>
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :                 rc-&gt;proxy_class = mono_defaults.marshalbyrefobject_class;</span>
<span class="lineNum">    2528 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    2529 </span><span class="lineCov">        142 :                 rc = (MonoRemoteClass *)mono_domain_alloc (domain, MONO_SIZEOF_REMOTE_CLASS);</span>
<span class="lineNum">    2530 </span><span class="lineCov">        142 :                 rc-&gt;interface_count = 0;</span>
<span class="lineNum">    2531 </span><span class="lineCov">        142 :                 rc-&gt;proxy_class = proxy_class;</span>
<span class="lineNum">    2532 </span>            :         }
<span class="lineNum">    2533 </span>            :         
<span class="lineNum">    2534 </span><span class="lineCov">        142 :         rc-&gt;default_vtable = NULL;</span>
<span class="lineNum">    2535 </span><span class="lineCov">        142 :         rc-&gt;xdomain_vtable = NULL;</span>
<span class="lineNum">    2536 </span><span class="lineCov">        142 :         rc-&gt;proxy_class_name = name;</span>
<span class="lineNum">    2537 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">    2538 </span><span class="lineCov">        142 :         mono_perfcounters-&gt;loader_bytes += mono_string_length (MONO_HANDLE_RAW (class_name)) + 1;</span>
<span class="lineNum">    2539 </span>            : #endif
<span class="lineNum">    2540 </span>            : 
<span class="lineNum">    2541 </span><span class="lineCov">        142 :         g_hash_table_insert (domain-&gt;proxy_vtable_hash, key, rc);</span>
<span class="lineNum">    2542 </span>            : 
<span class="lineNum">    2543 </span><span class="lineCov">        142 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    2544 </span><span class="lineCov">        142 :         return rc;</span>
<span class="lineNum">    2545 </span><span class="lineCov">        845 : }</span>
<span class="lineNum">    2546 </span>            : 
<span class="lineNum">    2547 </span>            : /**
<span class="lineNum">    2548 </span>            :  * clone_remote_class:
<span class="lineNum">    2549 </span>            :  * Creates a copy of the remote_class, adding the provided class or interface
<a name="2550"><span class="lineNum">    2550 </span>            :  */</a>
<span class="lineNum">    2551 </span>            : static MonoRemoteClass*
<span class="lineNum">    2552 </span>            : clone_remote_class (MonoDomain *domain, MonoRemoteClass* remote_class, MonoClass *extra_class)
<span class="lineNum">    2553 </span>            : {
<span class="lineNum">    2554 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    2555 </span>            : 
<span class="lineNum">    2556 </span>            :         MonoRemoteClass *rc;
<span class="lineNum">    2557 </span>            :         gpointer* key, *mp_key;
<span class="lineNum">    2558 </span>            :         
<span class="lineNum">    2559 </span><span class="lineCov">        604 :         key = create_remote_class_key (remote_class, extra_class);</span>
<span class="lineNum">    2560 </span><span class="lineCov">        604 :         rc = (MonoRemoteClass *)g_hash_table_lookup (domain-&gt;proxy_vtable_hash, key);</span>
<span class="lineNum">    2561 </span><span class="lineCov">        604 :         if (rc != NULL) {</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :                 g_free (key);</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :                 return rc;</span>
<span class="lineNum">    2564 </span>            :         }
<span class="lineNum">    2565 </span>            : 
<span class="lineNum">    2566 </span><span class="lineCov">        604 :         mp_key = copy_remote_class_key (domain, key);</span>
<span class="lineNum">    2567 </span><span class="lineCov">        604 :         g_free (key);</span>
<span class="lineNum">    2568 </span><span class="lineCov">        604 :         key = mp_key;</span>
<span class="lineNum">    2569 </span>            : 
<span class="lineNum">    2570 </span><span class="lineCov">        604 :         if (mono_class_is_interface (extra_class)) {</span>
<span class="lineNum">    2571 </span>            :                 int i,j;
<span class="lineNum">    2572 </span><span class="lineCov">        604 :                 rc = (MonoRemoteClass *)mono_domain_alloc (domain, MONO_SIZEOF_REMOTE_CLASS + sizeof(MonoClass*) * (remote_class-&gt;interface_count + 1));</span>
<span class="lineNum">    2573 </span><span class="lineCov">        604 :                 rc-&gt;proxy_class = remote_class-&gt;proxy_class;</span>
<span class="lineNum">    2574 </span><span class="lineCov">        604 :                 rc-&gt;interface_count = remote_class-&gt;interface_count + 1;</span>
<span class="lineNum">    2575 </span>            :                 
<span class="lineNum">    2576 </span>            :                 // Keep the list of interfaces sorted, since the hash key of
<span class="lineNum">    2577 </span>            :                 // the remote class depends on this
<span class="lineNum">    2578 </span><span class="lineCov">     180612 :                 for (i = 0, j = 0; i &lt; remote_class-&gt;interface_count; i++, j++) {</span>
<span class="lineNum">    2579 </span><span class="lineCov">      90077 :                         if (remote_class-&gt;interfaces [i] &gt; extra_class &amp;&amp; i == j)</span>
<span class="lineNum">    2580 </span><span class="lineCov">         24 :                                 rc-&gt;interfaces [j++] = extra_class;</span>
<span class="lineNum">    2581 </span><span class="lineCov">      89702 :                         rc-&gt;interfaces [j] = remote_class-&gt;interfaces [i];</span>
<span class="lineNum">    2582 </span><span class="lineCov">      89702 :                 }</span>
<span class="lineNum">    2583 </span><span class="lineCov">        604 :                 if (i == j)</span>
<span class="lineNum">    2584 </span><span class="lineCov">        580 :                         rc-&gt;interfaces [j] = extra_class;</span>
<span class="lineNum">    2585 </span><span class="lineCov">        604 :         } else {</span>
<span class="lineNum">    2586 </span>            :                 // Replace the old class. The interface array is the same
<span class="lineNum">    2587 </span><span class="lineNoCov">          0 :                 rc = (MonoRemoteClass *)mono_domain_alloc (domain, MONO_SIZEOF_REMOTE_CLASS + sizeof(MonoClass*) * remote_class-&gt;interface_count);</span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 :                 rc-&gt;proxy_class = extra_class;</span>
<span class="lineNum">    2589 </span><span class="lineNoCov">          0 :                 rc-&gt;interface_count = remote_class-&gt;interface_count;</span>
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :                 if (rc-&gt;interface_count &gt; 0)</span>
<span class="lineNum">    2591 </span><span class="lineNoCov">          0 :                         memcpy (rc-&gt;interfaces, remote_class-&gt;interfaces, rc-&gt;interface_count * sizeof (MonoClass*));</span>
<span class="lineNum">    2592 </span>            :         }
<span class="lineNum">    2593 </span>            :         
<span class="lineNum">    2594 </span><span class="lineCov">        604 :         rc-&gt;default_vtable = NULL;</span>
<span class="lineNum">    2595 </span><span class="lineCov">        604 :         rc-&gt;xdomain_vtable = NULL;</span>
<span class="lineNum">    2596 </span><span class="lineCov">        604 :         rc-&gt;proxy_class_name = remote_class-&gt;proxy_class_name;</span>
<span class="lineNum">    2597 </span>            : 
<span class="lineNum">    2598 </span><span class="lineCov">        604 :         g_hash_table_insert (domain-&gt;proxy_vtable_hash, key, rc);</span>
<span class="lineNum">    2599 </span>            : 
<span class="lineNum">    2600 </span><span class="lineCov">        604 :         return rc;</span>
<span class="lineNum">    2601 </span><span class="lineCov">        604 : }</span>
<a name="2602"><span class="lineNum">    2602 </span>            : </a>
<span class="lineNum">    2603 </span>            : gpointer
<span class="lineNum">    2604 </span>            : mono_remote_class_vtable (MonoDomain *domain, MonoRemoteClass *remote_class, MonoRealProxyHandle rp, MonoError *error)
<span class="lineNum">    2605 </span>            : {
<span class="lineNum">    2606 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2607 </span>            : 
<span class="lineNum">    2608 </span><span class="lineCov">       1449 :         mono_error_init (error);</span>
<span class="lineNum">    2609 </span>            : 
<span class="lineNum">    2610 </span><span class="lineCov">       1449 :         mono_loader_lock (); /*FIXME mono_class_from_mono_type and mono_class_proxy_vtable take it*/</span>
<span class="lineNum">    2611 </span><span class="lineCov">       1449 :         mono_domain_lock (domain);</span>
<span class="lineNum">    2612 </span><span class="lineCov">       1449 :         gint32 target_domain_id = MONO_HANDLE_GETVAL (rp, target_domain_id);</span>
<span class="lineNum">    2613 </span><span class="lineCov">       1449 :         if (target_domain_id != -1) {</span>
<span class="lineNum">    2614 </span><span class="lineCov">        810 :                 if (remote_class-&gt;xdomain_vtable == NULL)</span>
<span class="lineNum">    2615 </span><span class="lineCov">        109 :                         remote_class-&gt;xdomain_vtable = mono_class_proxy_vtable (domain, remote_class, MONO_REMOTING_TARGET_APPDOMAIN, error);</span>
<span class="lineNum">    2616 </span><span class="lineCov">        810 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    2617 </span><span class="lineCov">        810 :                 mono_loader_unlock ();</span>
<span class="lineNum">    2618 </span><span class="lineCov">       2430 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    2619 </span><span class="lineCov">        810 :                 return remote_class-&gt;xdomain_vtable;</span>
<span class="lineNum">    2620 </span>            :         }
<span class="lineNum">    2621 </span><span class="lineCov">        639 :         if (remote_class-&gt;default_vtable == NULL) {</span>
<span class="lineNum">    2622 </span><span class="lineCov">        637 :                 MonoReflectionTypeHandle reftype = MONO_HANDLE_NEW (MonoReflectionType, NULL);</span>
<span class="lineNum">    2623 </span><span class="lineCov">       1274 :                 MONO_HANDLE_GET (reftype, rp, class_to_proxy);</span>
<span class="lineNum">    2624 </span>            :                 
<span class="lineNum">    2625 </span><span class="lineCov">        637 :                 MonoType *type = MONO_HANDLE_GETVAL (reftype, type);</span>
<span class="lineNum">    2626 </span><span class="lineCov">        637 :                 MonoClass *klass = mono_class_from_mono_type (type);</span>
<span class="lineNum">    2627 </span>            : #ifndef DISABLE_COM
<span class="lineNum">    2628 </span><span class="lineCov">       1913 :                 if ((mono_class_is_com_object (klass) || (mono_class_get_com_object_class () &amp;&amp; klass == mono_class_get_com_object_class ())) &amp;&amp; !mono_vtable_is_remote (mono_class_vtable (mono_domain_get (), klass)))</span>
<span class="lineNum">    2629 </span><span class="lineCov">         10 :                         remote_class-&gt;default_vtable = mono_class_proxy_vtable (domain, remote_class, MONO_REMOTING_TARGET_COMINTEROP, error);</span>
<span class="lineNum">    2630 </span>            :                 else
<span class="lineNum">    2631 </span>            : #endif
<span class="lineNum">    2632 </span><span class="lineCov">        627 :                         remote_class-&gt;default_vtable = mono_class_proxy_vtable (domain, remote_class, MONO_REMOTING_TARGET_UNKNOWN, error);</span>
<span class="lineNum">    2633 </span>            :                 /* N.B. both branches of the if modify error */
<span class="lineNum">    2634 </span><span class="lineCov">        637 :                 if (!is_ok (error)) {</span>
<span class="lineNum">    2635 </span><span class="lineNoCov">          0 :                         mono_domain_unlock (domain);</span>
<span class="lineNum">    2636 </span><span class="lineNoCov">          0 :                         mono_loader_unlock ();</span>
<span class="lineNum">    2637 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    2638 </span>            :                 }
<span class="lineNum">    2639 </span><span class="lineCov">        637 :         }</span>
<span class="lineNum">    2640 </span>            :         
<span class="lineNum">    2641 </span><span class="lineCov">        639 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    2642 </span><span class="lineCov">        639 :         mono_loader_unlock ();</span>
<span class="lineNum">    2643 </span><span class="lineCov">        639 :         return remote_class-&gt;default_vtable;</span>
<span class="lineNum">    2644 </span><span class="lineCov">       1449 : }</span>
<span class="lineNum">    2645 </span>            : 
<span class="lineNum">    2646 </span>            : /**
<span class="lineNum">    2647 </span>            :  * mono_upgrade_remote_class:
<span class="lineNum">    2648 </span>            :  * @domain: the application domain
<span class="lineNum">    2649 </span>            :  * @tproxy: the proxy whose remote class has to be upgraded.
<span class="lineNum">    2650 </span>            :  * @klass: class to which the remote class can be casted.
<span class="lineNum">    2651 </span>            :  * @error: set on error
<span class="lineNum">    2652 </span>            :  *
<span class="lineNum">    2653 </span>            :  * Updates the vtable of the remote class by adding the necessary method slots
<span class="lineNum">    2654 </span>            :  * and interface offsets so it can be safely casted to klass. klass can be a
<span class="lineNum">    2655 </span>            :  * class or an interface.  On success returns TRUE, on failure returns FALSE and sets @error.
<a name="2656"><span class="lineNum">    2656 </span>            :  */</a>
<span class="lineNum">    2657 </span>            : gboolean
<span class="lineNum">    2658 </span>            : mono_upgrade_remote_class (MonoDomain *domain, MonoObjectHandle proxy_object, MonoClass *klass, MonoError *error)
<span class="lineNum">    2659 </span>            : {
<span class="lineNum">    2660 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2661 </span>            : 
<span class="lineNum">    2662 </span><span class="lineCov">        604 :         mono_error_init (error);</span>
<span class="lineNum">    2663 </span>            : 
<span class="lineNum">    2664 </span><span class="lineCov">        604 :         MonoTransparentProxyHandle tproxy = MONO_HANDLE_CAST (MonoTransparentProxy, proxy_object);</span>
<span class="lineNum">    2665 </span><span class="lineCov">        604 :         MonoRemoteClass *remote_class = MONO_HANDLE_GETVAL (tproxy, remote_class);</span>
<span class="lineNum">    2666 </span>            :         
<span class="lineNum">    2667 </span>            :         gboolean redo_vtable;
<span class="lineNum">    2668 </span><span class="lineCov">        604 :         if (mono_class_is_interface (klass)) {</span>
<span class="lineNum">    2669 </span>            :                 int i;
<span class="lineNum">    2670 </span><span class="lineCov">        604 :                 redo_vtable = TRUE;</span>
<span class="lineNum">    2671 </span><span class="lineCov">     360620 :                 for (i = 0; i &lt; remote_class-&gt;interface_count &amp;&amp; redo_vtable; i++)</span>
<span class="lineNum">    2672 </span><span class="lineCov">     179404 :                         if (remote_class-&gt;interfaces [i] == klass)</span>
<span class="lineNum">    2673 </span><span class="lineNoCov">          0 :                                 redo_vtable = FALSE;</span>
<span class="lineNum">    2674 </span><span class="lineCov">        604 :         }</span>
<span class="lineNum">    2675 </span>            :         else {
<span class="lineNum">    2676 </span><span class="lineNoCov">          0 :                 redo_vtable = (remote_class-&gt;proxy_class != klass);</span>
<span class="lineNum">    2677 </span>            :         }
<span class="lineNum">    2678 </span>            : 
<span class="lineNum">    2679 </span><span class="lineCov">        604 :         mono_loader_lock (); /*FIXME mono_remote_class_vtable requires it.*/</span>
<span class="lineNum">    2680 </span><span class="lineCov">        604 :         mono_domain_lock (domain);</span>
<span class="lineNum">    2681 </span><span class="lineCov">       1208 :         if (redo_vtable) {</span>
<span class="lineNum">    2682 </span><span class="lineCov">        604 :                 MonoRemoteClass *fresh_remote_class = clone_remote_class (domain, remote_class, klass);</span>
<span class="lineNum">    2683 </span><span class="lineCov">       1208 :                 MONO_HANDLE_SETVAL (tproxy, remote_class, MonoRemoteClass*, fresh_remote_class);</span>
<span class="lineNum">    2684 </span><span class="lineCov">        604 :                 MonoRealProxyHandle real_proxy = MONO_HANDLE_NEW (MonoRealProxy, NULL);</span>
<span class="lineNum">    2685 </span><span class="lineCov">       1208 :                 MONO_HANDLE_GET (real_proxy, tproxy, rp);</span>
<span class="lineNum">    2686 </span><span class="lineCov">       1208 :                 MONO_HANDLE_SETVAL (proxy_object, vtable, MonoVTable*, mono_remote_class_vtable (domain, fresh_remote_class, real_proxy, error));</span>
<span class="lineNum">    2687 </span><span class="lineCov">        604 :                 if (!is_ok (error))</span>
<span class="lineNum">    2688 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">    2689 </span><span class="lineCov">        604 :         }</span>
<span class="lineNum">    2690 </span>            :         
<span class="lineNum">    2691 </span>            : leave:
<span class="lineNum">    2692 </span><span class="lineCov">        604 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    2693 </span><span class="lineCov">        604 :         mono_loader_unlock ();</span>
<span class="lineNum">    2694 </span><span class="lineCov">        604 :         return is_ok (error);</span>
<span class="lineNum">    2695 </span>            : }
<span class="lineNum">    2696 </span>            : #endif /* DISABLE_REMOTING */
<span class="lineNum">    2697 </span>            : 
<span class="lineNum">    2698 </span>            : 
<span class="lineNum">    2699 </span>            : /**
<span class="lineNum">    2700 </span>            :  * mono_object_get_virtual_method:
<span class="lineNum">    2701 </span>            :  * @obj: object to operate on.
<span class="lineNum">    2702 </span>            :  * @method: method 
<span class="lineNum">    2703 </span>            :  *
<span class="lineNum">    2704 </span>            :  * Retrieves the MonoMethod that would be called on obj if obj is passed as
<span class="lineNum">    2705 </span>            :  * the instance of a callvirt of method.
<a name="2706"><span class="lineNum">    2706 </span>            :  */</a>
<span class="lineNum">    2707 </span>            : MonoMethod*
<span class="lineNum">    2708 </span>            : mono_object_get_virtual_method (MonoObject *obj_raw, MonoMethod *method)
<span class="lineNum">    2709 </span>            : {
<span class="lineNum">    2710 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2711 </span><span class="lineCov">     117359 :         HANDLE_FUNCTION_ENTER ();</span>
<span class="lineNum">    2712 </span>            :         MonoError error;
<span class="lineNum">    2713 </span><span class="lineCov">      58682 :         MONO_HANDLE_DCL (MonoObject, obj);</span>
<span class="lineNum">    2714 </span><span class="lineCov">      58682 :         MonoMethod *result = mono_object_handle_get_virtual_method (obj, method, &amp;error);</span>
<span class="lineNum">    2715 </span><span class="lineCov">      58682 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    2716 </span><span class="lineCov">     117372 :         HANDLE_FUNCTION_RETURN_VAL (result);</span>
<span class="lineNum">    2717 </span>            : }
<span class="lineNum">    2718 </span>            : 
<span class="lineNum">    2719 </span>            : /**
<span class="lineNum">    2720 </span>            :  * mono_object_get_virtual_method:
<span class="lineNum">    2721 </span>            :  * @obj: object to operate on.
<span class="lineNum">    2722 </span>            :  * @method: method 
<span class="lineNum">    2723 </span>            :  *
<span class="lineNum">    2724 </span>            :  * Retrieves the MonoMethod that would be called on obj if obj is passed as
<span class="lineNum">    2725 </span>            :  * the instance of a callvirt of method.
<a name="2726"><span class="lineNum">    2726 </span>            :  */</a>
<span class="lineNum">    2727 </span>            : MonoMethod*
<span class="lineNum">    2728 </span>            : mono_object_handle_get_virtual_method (MonoObjectHandle obj, MonoMethod *method, MonoError *error)
<span class="lineNum">    2729 </span>            : {
<span class="lineNum">    2730 </span><span class="lineCov">      58687 :         mono_error_init (error);</span>
<span class="lineNum">    2731 </span>            : 
<span class="lineNum">    2732 </span><span class="lineCov">      58687 :         gboolean is_proxy = FALSE;</span>
<span class="lineNum">    2733 </span><span class="lineCov">      58687 :         MonoClass *klass = mono_handle_class (obj);</span>
<span class="lineNum">    2734 </span><span class="lineCov">      58687 :         if (mono_class_is_transparent_proxy (klass)) {</span>
<span class="lineNum">    2735 </span><span class="lineCov">          6 :                 MonoRemoteClass *remote_class = MONO_HANDLE_GETVAL (MONO_HANDLE_CAST (MonoTransparentProxy, obj), remote_class);</span>
<span class="lineNum">    2736 </span><span class="lineCov">          6 :                 klass = remote_class-&gt;proxy_class;</span>
<span class="lineNum">    2737 </span><span class="lineCov">          6 :                 is_proxy = TRUE;</span>
<span class="lineNum">    2738 </span><span class="lineCov">          6 :         }</span>
<span class="lineNum">    2739 </span><span class="lineCov">      58689 :         return class_get_virtual_method (klass, method, is_proxy, error);</span>
<span class="lineNum">    2740 </span>            : }
<a name="2741"><span class="lineNum">    2741 </span>            : </a>
<span class="lineNum">    2742 </span>            : static MonoMethod*
<span class="lineNum">    2743 </span>            : class_get_virtual_method (MonoClass *klass, MonoMethod *method, gboolean is_proxy, MonoError *error)
<span class="lineNum">    2744 </span>            : {
<span class="lineNum">    2745 </span><span class="lineCov">      58689 :         mono_error_init (error);</span>
<span class="lineNum">    2746 </span>            : 
<span class="lineNum">    2747 </span>            : 
<span class="lineNum">    2748 </span><span class="lineCov">     176044 :         if (!is_proxy &amp;&amp; ((method-&gt;flags &amp; METHOD_ATTRIBUTE_FINAL) || !(method-&gt;flags &amp; METHOD_ATTRIBUTE_VIRTUAL)))</span>
<span class="lineNum">    2749 </span><span class="lineCov">       4781 :                         return method;</span>
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span><span class="lineCov">      53902 :         mono_class_setup_vtable (klass);</span>
<span class="lineNum">    2752 </span><span class="lineCov">      53902 :         MonoMethod **vtable = klass-&gt;vtable;</span>
<span class="lineNum">    2753 </span>            : 
<span class="lineNum">    2754 </span><span class="lineCov">      53902 :         if (method-&gt;slot == -1) {</span>
<span class="lineNum">    2755 </span>            :                 /* method-&gt;slot might not be set for instances of generic methods */
<span class="lineNum">    2756 </span><span class="lineCov">          2 :                 if (method-&gt;is_inflated) {</span>
<span class="lineNum">    2757 </span><span class="lineCov">          6 :                         g_assert (((MonoMethodInflated*)method)-&gt;declaring-&gt;slot != -1);</span>
<span class="lineNum">    2758 </span><span class="lineCov">          2 :                         method-&gt;slot = ((MonoMethodInflated*)method)-&gt;declaring-&gt;slot; </span>
<span class="lineNum">    2759 </span><span class="lineCov">          2 :                 } else {</span>
<span class="lineNum">    2760 </span><span class="lineNoCov">          0 :                         if (!is_proxy)</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">          0 :                                 g_assert_not_reached ();</span>
<span class="lineNum">    2762 </span>            :                 }
<span class="lineNum">    2763 </span><span class="lineCov">          2 :         }</span>
<span class="lineNum">    2764 </span>            : 
<span class="lineNum">    2765 </span><span class="lineCov">      53898 :         MonoMethod *res = NULL;</span>
<span class="lineNum">    2766 </span>            :         /* check method-&gt;slot is a valid index: perform isinstance? */
<span class="lineNum">    2767 </span><span class="lineCov">      53898 :         if (method-&gt;slot != -1) {</span>
<span class="lineNum">    2768 </span><span class="lineCov">      53908 :                 if (mono_class_is_interface (method-&gt;klass)) {</span>
<span class="lineNum">    2769 </span><span class="lineCov">          4 :                         if (!is_proxy) {</span>
<span class="lineNum">    2770 </span><span class="lineCov">          2 :                                 gboolean variance_used = FALSE;</span>
<span class="lineNum">    2771 </span><span class="lineCov">          2 :                                 int iface_offset = mono_class_interface_offset_with_variance (klass, method-&gt;klass, &amp;variance_used);</span>
<span class="lineNum">    2772 </span><span class="lineCov">          6 :                                 g_assert (iface_offset &gt; 0);</span>
<span class="lineNum">    2773 </span><span class="lineCov">          2 :                                 res = vtable [iface_offset + method-&gt;slot];</span>
<span class="lineNum">    2774 </span><span class="lineCov">          2 :                         }</span>
<span class="lineNum">    2775 </span><span class="lineCov">          4 :                 } else {</span>
<span class="lineNum">    2776 </span><span class="lineCov">      53897 :                         res = vtable [method-&gt;slot];</span>
<span class="lineNum">    2777 </span>            :                 }
<span class="lineNum">    2778 </span><span class="lineCov">      53899 :     }</span>
<span class="lineNum">    2779 </span>            : 
<span class="lineNum">    2780 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    2781 </span><span class="lineCov">      53901 :         if (is_proxy) {</span>
<span class="lineNum">    2782 </span>            :                 /* It may be an interface, abstract class method or generic method */
<span class="lineNum">    2783 </span><span class="lineCov">         10 :                 if (!res || mono_method_signature (res)-&gt;generic_param_count)</span>
<span class="lineNum">    2784 </span><span class="lineCov">          2 :                         res = method;</span>
<span class="lineNum">    2785 </span>            : 
<span class="lineNum">    2786 </span>            :                 /* generic methods demand invoke_with_check */
<span class="lineNum">    2787 </span><span class="lineCov">          6 :                 if (mono_method_signature (res)-&gt;generic_param_count)</span>
<span class="lineNum">    2788 </span><span class="lineCov">          2 :                         res = mono_marshal_get_remoting_invoke_with_check (res);</span>
<span class="lineNum">    2789 </span>            :                 else {
<span class="lineNum">    2790 </span>            : #ifndef DISABLE_COM
<span class="lineNum">    2791 </span><span class="lineCov">          8 :                         if (klass == mono_class_get_com_object_class () || mono_class_is_com_object (klass))</span>
<span class="lineNum">    2792 </span><span class="lineNoCov">          0 :                                 res = mono_cominterop_get_invoke (res);</span>
<span class="lineNum">    2793 </span>            :                         else
<span class="lineNum">    2794 </span>            : #endif
<span class="lineNum">    2795 </span><span class="lineCov">          4 :                                 res = mono_marshal_get_remoting_invoke (res);</span>
<span class="lineNum">    2796 </span>            :                 }
<span class="lineNum">    2797 </span><span class="lineCov">          6 :         } else</span>
<span class="lineNum">    2798 </span>            : #endif
<span class="lineNum">    2799 </span>            :         {
<span class="lineNum">    2800 </span><span class="lineCov">      53901 :                 if (method-&gt;is_inflated) {</span>
<span class="lineNum">    2801 </span>            :                         /* Have to inflate the result */
<span class="lineNum">    2802 </span><span class="lineCov">      51799 :                         res = mono_class_inflate_generic_method_checked (res, &amp;((MonoMethodInflated*)method)-&gt;context, error);</span>
<span class="lineNum">    2803 </span><span class="lineCov">      51799 :                 }</span>
<span class="lineNum">    2804 </span>            :         }
<span class="lineNum">    2805 </span>            : 
<span class="lineNum">    2806 </span><span class="lineCov">      53895 :         return res;</span>
<span class="lineNum">    2807 </span><span class="lineCov">      58676 : }</span>
<a name="2808"><span class="lineNum">    2808 </span>            : </a>
<span class="lineNum">    2809 </span>            : static MonoObject*
<span class="lineNum">    2810 </span>            : do_runtime_invoke (MonoMethod *method, void *obj, void **params, MonoObject **exc, MonoError *error)
<span class="lineNum">    2811 </span>            : {
<span class="lineNum">    2812 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2813 </span>            : 
<span class="lineNum">    2814 </span><span class="lineCov">    2805916 :         MonoObject *result = NULL;</span>
<span class="lineNum">    2815 </span>            : 
<span class="lineNum">    2816 </span><span class="lineCov">    8417786 :         g_assert (callbacks.runtime_invoke);</span>
<span class="lineNum">    2817 </span>            : 
<span class="lineNum">    2818 </span><span class="lineCov">    2805933 :         mono_error_init (error);</span>
<span class="lineNum">    2819 </span>            :         
<span class="lineNum">    2820 </span><span class="lineCov">    2805933 :         if (mono_profiler_get_events () &amp; MONO_PROFILE_METHOD_EVENTS)</span>
<span class="lineNum">    2821 </span><span class="lineNoCov">          0 :                 mono_profiler_method_start_invoke (method);</span>
<span class="lineNum">    2822 </span>            : 
<span class="lineNum">    2823 </span><span class="lineCov">    2804845 :         result = callbacks.runtime_invoke (method, obj, params, exc, error);</span>
<span class="lineNum">    2824 </span>            : 
<span class="lineNum">    2825 </span><span class="lineCov">    2804845 :         if (mono_profiler_get_events () &amp; MONO_PROFILE_METHOD_EVENTS)</span>
<span class="lineNum">    2826 </span><span class="lineNoCov">          0 :                 mono_profiler_method_end_invoke (method);</span>
<span class="lineNum">    2827 </span>            : 
<span class="lineNum">    2828 </span><span class="lineCov">    2804823 :         if (!mono_error_ok (error))</span>
<span class="lineNum">    2829 </span><span class="lineCov">          1 :                 return NULL;</span>
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span><span class="lineCov">    2804868 :         return result;</span>
<span class="lineNum">    2832 </span><span class="lineCov">    2804898 : }</span>
<span class="lineNum">    2833 </span>            : 
<span class="lineNum">    2834 </span>            : /**
<span class="lineNum">    2835 </span>            :  * mono_runtime_invoke:
<span class="lineNum">    2836 </span>            :  * @method: method to invoke
<span class="lineNum">    2837 </span>            :  * @obJ: object instance
<span class="lineNum">    2838 </span>            :  * @params: arguments to the method
<span class="lineNum">    2839 </span>            :  * @exc: exception information.
<span class="lineNum">    2840 </span>            :  *
<span class="lineNum">    2841 </span>            :  * Invokes the method represented by @method on the object @obj.
<span class="lineNum">    2842 </span>            :  *
<span class="lineNum">    2843 </span>            :  * obj is the 'this' pointer, it should be NULL for static
<span class="lineNum">    2844 </span>            :  * methods, a MonoObject* for object instances and a pointer to
<span class="lineNum">    2845 </span>            :  * the value type for value types.
<span class="lineNum">    2846 </span>            :  *
<span class="lineNum">    2847 </span>            :  * The params array contains the arguments to the method with the
<span class="lineNum">    2848 </span>            :  * same convention: MonoObject* pointers for object instances and
<span class="lineNum">    2849 </span>            :  * pointers to the value type otherwise. 
<span class="lineNum">    2850 </span>            :  * 
<span class="lineNum">    2851 </span>            :  * From unmanaged code you'll usually use the
<span class="lineNum">    2852 </span>            :  * mono_runtime_invoke() variant.
<span class="lineNum">    2853 </span>            :  *
<span class="lineNum">    2854 </span>            :  * Note that this function doesn't handle virtual methods for
<span class="lineNum">    2855 </span>            :  * you, it will exec the exact method you pass: we still need to
<span class="lineNum">    2856 </span>            :  * expose a function to lookup the derived class implementation
<span class="lineNum">    2857 </span>            :  * of a virtual method (there are examples of this in the code,
<span class="lineNum">    2858 </span>            :  * though).
<span class="lineNum">    2859 </span>            :  * 
<span class="lineNum">    2860 </span>            :  * You can pass NULL as the exc argument if you don't want to
<span class="lineNum">    2861 </span>            :  * catch exceptions, otherwise, *exc will be set to the exception
<span class="lineNum">    2862 </span>            :  * thrown, if any.  if an exception is thrown, you can't use the
<span class="lineNum">    2863 </span>            :  * MonoObject* result from the function.
<span class="lineNum">    2864 </span>            :  * 
<span class="lineNum">    2865 </span>            :  * If the method returns a value type, it is boxed in an object
<span class="lineNum">    2866 </span>            :  * reference.
<a name="2867"><span class="lineNum">    2867 </span>            :  */</a>
<span class="lineNum">    2868 </span>            : MonoObject*
<span class="lineNum">    2869 </span>            : mono_runtime_invoke (MonoMethod *method, void *obj, void **params, MonoObject **exc)
<span class="lineNum">    2870 </span>            : {
<span class="lineNum">    2871 </span>            :         MonoError error;
<span class="lineNum">    2872 </span>            :         MonoObject *res;
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    2874 </span><span class="lineNoCov">          0 :                 res = mono_runtime_try_invoke (method, obj, params, exc, &amp;error);</span>
<span class="lineNum">    2875 </span><span class="lineNoCov">          0 :                 if (*exc == NULL &amp;&amp; !mono_error_ok(&amp;error)) {</span>
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :                         *exc = (MonoObject*) mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    2877 </span><span class="lineNoCov">          0 :                 } else</span>
<span class="lineNum">    2878 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :                 res = mono_runtime_invoke_checked (method, obj, params, &amp;error);</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :                 mono_error_raise_exception (&amp;error); /* OK to throw, external only without a good alternative */</span>
<span class="lineNum">    2882 </span>            :         }
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    2884 </span>            : }
<span class="lineNum">    2885 </span>            : 
<span class="lineNum">    2886 </span>            : /**
<span class="lineNum">    2887 </span>            :  * mono_runtime_try_invoke:
<span class="lineNum">    2888 </span>            :  * @method: method to invoke
<span class="lineNum">    2889 </span>            :  * @obJ: object instance
<span class="lineNum">    2890 </span>            :  * @params: arguments to the method
<span class="lineNum">    2891 </span>            :  * @exc: exception information.
<span class="lineNum">    2892 </span>            :  * @error: set on error
<span class="lineNum">    2893 </span>            :  *
<span class="lineNum">    2894 </span>            :  * Invokes the method represented by @method on the object @obj.
<span class="lineNum">    2895 </span>            :  *
<span class="lineNum">    2896 </span>            :  * obj is the 'this' pointer, it should be NULL for static
<span class="lineNum">    2897 </span>            :  * methods, a MonoObject* for object instances and a pointer to
<span class="lineNum">    2898 </span>            :  * the value type for value types.
<span class="lineNum">    2899 </span>            :  *
<span class="lineNum">    2900 </span>            :  * The params array contains the arguments to the method with the
<span class="lineNum">    2901 </span>            :  * same convention: MonoObject* pointers for object instances and
<span class="lineNum">    2902 </span>            :  * pointers to the value type otherwise. 
<span class="lineNum">    2903 </span>            :  * 
<span class="lineNum">    2904 </span>            :  * From unmanaged code you'll usually use the
<span class="lineNum">    2905 </span>            :  * mono_runtime_invoke() variant.
<span class="lineNum">    2906 </span>            :  *
<span class="lineNum">    2907 </span>            :  * Note that this function doesn't handle virtual methods for
<span class="lineNum">    2908 </span>            :  * you, it will exec the exact method you pass: we still need to
<span class="lineNum">    2909 </span>            :  * expose a function to lookup the derived class implementation
<span class="lineNum">    2910 </span>            :  * of a virtual method (there are examples of this in the code,
<span class="lineNum">    2911 </span>            :  * though).
<span class="lineNum">    2912 </span>            :  * 
<span class="lineNum">    2913 </span>            :  * For this function, you must not pass NULL as the exc argument if
<span class="lineNum">    2914 </span>            :  * you don't want to catch exceptions, use
<span class="lineNum">    2915 </span>            :  * mono_runtime_invoke_checked().  If an exception is thrown, you
<span class="lineNum">    2916 </span>            :  * can't use the MonoObject* result from the function.
<span class="lineNum">    2917 </span>            :  * 
<span class="lineNum">    2918 </span>            :  * If this method cannot be invoked, @error will be set and @exc and
<span class="lineNum">    2919 </span>            :  * the return value must not be used.
<span class="lineNum">    2920 </span>            :  *
<span class="lineNum">    2921 </span>            :  * If the method returns a value type, it is boxed in an object
<span class="lineNum">    2922 </span>            :  * reference.
<a name="2923"><span class="lineNum">    2923 </span>            :  */</a>
<span class="lineNum">    2924 </span>            : MonoObject*
<span class="lineNum">    2925 </span>            : mono_runtime_try_invoke (MonoMethod *method, void *obj, void **params, MonoObject **exc, MonoError* error)
<span class="lineNum">    2926 </span>            : {
<span class="lineNum">    2927 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2928 </span>            : 
<span class="lineNum">    2929 </span><span class="lineCov">    6253429 :         g_assert (exc != NULL);</span>
<span class="lineNum">    2930 </span>            : 
<span class="lineNum">    2931 </span><span class="lineCov">    2084394 :         if (mono_runtime_get_no_exec ())</span>
<span class="lineNum">    2932 </span><span class="lineNoCov">          0 :                 g_warning (&quot;Invoking method '%s' when running in no-exec mode.\n&quot;, mono_method_full_name (method, TRUE));</span>
<span class="lineNum">    2933 </span>            : 
<span class="lineNum">    2934 </span><span class="lineCov">    2084413 :         return do_runtime_invoke (method, obj, params, exc, error);</span>
<span class="lineNum">    2935 </span>            : }
<span class="lineNum">    2936 </span>            : 
<span class="lineNum">    2937 </span>            : /**
<span class="lineNum">    2938 </span>            :  * mono_runtime_invoke_checked:
<span class="lineNum">    2939 </span>            :  * @method: method to invoke
<span class="lineNum">    2940 </span>            :  * @obJ: object instance
<span class="lineNum">    2941 </span>            :  * @params: arguments to the method
<span class="lineNum">    2942 </span>            :  * @error: set on error
<span class="lineNum">    2943 </span>            :  *
<span class="lineNum">    2944 </span>            :  * Invokes the method represented by @method on the object @obj.
<span class="lineNum">    2945 </span>            :  *
<span class="lineNum">    2946 </span>            :  * obj is the 'this' pointer, it should be NULL for static
<span class="lineNum">    2947 </span>            :  * methods, a MonoObject* for object instances and a pointer to
<span class="lineNum">    2948 </span>            :  * the value type for value types.
<span class="lineNum">    2949 </span>            :  *
<span class="lineNum">    2950 </span>            :  * The params array contains the arguments to the method with the
<span class="lineNum">    2951 </span>            :  * same convention: MonoObject* pointers for object instances and
<span class="lineNum">    2952 </span>            :  * pointers to the value type otherwise. 
<span class="lineNum">    2953 </span>            :  * 
<span class="lineNum">    2954 </span>            :  * From unmanaged code you'll usually use the
<span class="lineNum">    2955 </span>            :  * mono_runtime_invoke() variant.
<span class="lineNum">    2956 </span>            :  *
<span class="lineNum">    2957 </span>            :  * Note that this function doesn't handle virtual methods for
<span class="lineNum">    2958 </span>            :  * you, it will exec the exact method you pass: we still need to
<span class="lineNum">    2959 </span>            :  * expose a function to lookup the derived class implementation
<span class="lineNum">    2960 </span>            :  * of a virtual method (there are examples of this in the code,
<span class="lineNum">    2961 </span>            :  * though).
<span class="lineNum">    2962 </span>            :  * 
<span class="lineNum">    2963 </span>            :  * If an exception is thrown, you can't use the MonoObject* result
<span class="lineNum">    2964 </span>            :  * from the function.
<span class="lineNum">    2965 </span>            :  * 
<span class="lineNum">    2966 </span>            :  * If this method cannot be invoked, @error will be set.  If the
<span class="lineNum">    2967 </span>            :  * method throws an exception (and we're in coop mode) the exception
<span class="lineNum">    2968 </span>            :  * will be set in @error.
<span class="lineNum">    2969 </span>            :  *
<span class="lineNum">    2970 </span>            :  * If the method returns a value type, it is boxed in an object
<span class="lineNum">    2971 </span>            :  * reference.
<a name="2972"><span class="lineNum">    2972 </span>            :  */</a>
<span class="lineNum">    2973 </span>            : MonoObject*
<span class="lineNum">    2974 </span>            : mono_runtime_invoke_checked (MonoMethod *method, void *obj, void **params, MonoError* error)
<span class="lineNum">    2975 </span>            : {
<span class="lineNum">    2976 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    2977 </span>            : 
<span class="lineNum">    2978 </span><span class="lineCov">     721356 :         if (mono_runtime_get_no_exec ())</span>
<span class="lineNum">    2979 </span><span class="lineNoCov">          0 :                 g_warning (&quot;Invoking method '%s' when running in no-exec mode.\n&quot;, mono_method_full_name (method, TRUE));</span>
<span class="lineNum">    2980 </span>            : 
<span class="lineNum">    2981 </span><span class="lineCov">     721364 :         return do_runtime_invoke (method, obj, params, NULL, error);</span>
<span class="lineNum">    2982 </span>            : }
<span class="lineNum">    2983 </span>            : 
<span class="lineNum">    2984 </span>            : /**
<span class="lineNum">    2985 </span>            :  * mono_method_get_unmanaged_thunk:
<span class="lineNum">    2986 </span>            :  * @method: method to generate a thunk for.
<span class="lineNum">    2987 </span>            :  *
<span class="lineNum">    2988 </span>            :  * Returns an unmanaged-&gt;managed thunk that can be used to call
<span class="lineNum">    2989 </span>            :  * a managed method directly from C.
<span class="lineNum">    2990 </span>            :  *
<span class="lineNum">    2991 </span>            :  * The thunk's C signature closely matches the managed signature:
<span class="lineNum">    2992 </span>            :  *
<span class="lineNum">    2993 </span>            :  * C#: public bool Equals (object obj);
<span class="lineNum">    2994 </span>            :  * C:  typedef MonoBoolean (*Equals)(MonoObject*,
<span class="lineNum">    2995 </span>            :  *             MonoObject*, MonoException**);
<span class="lineNum">    2996 </span>            :  *
<span class="lineNum">    2997 </span>            :  * The 1st (&quot;this&quot;) parameter must not be used with static methods:
<span class="lineNum">    2998 </span>            :  *
<span class="lineNum">    2999 </span>            :  * C#: public static bool ReferenceEquals (object a, object b);
<span class="lineNum">    3000 </span>            :  * C:  typedef MonoBoolean (*ReferenceEquals)(MonoObject*, MonoObject*,
<span class="lineNum">    3001 </span>            :  *             MonoException**);
<span class="lineNum">    3002 </span>            :  *
<span class="lineNum">    3003 </span>            :  * The last argument must be a non-null pointer of a MonoException* pointer.
<span class="lineNum">    3004 </span>            :  * It has &quot;out&quot; semantics. After invoking the thunk, *ex will be NULL if no
<span class="lineNum">    3005 </span>            :  * exception has been thrown in managed code. Otherwise it will point
<span class="lineNum">    3006 </span>            :  * to the MonoException* caught by the thunk. In this case, the result of
<span class="lineNum">    3007 </span>            :  * the thunk is undefined:
<span class="lineNum">    3008 </span>            :  *
<span class="lineNum">    3009 </span>            :  * MonoMethod *method = ... // MonoMethod* of System.Object.Equals
<span class="lineNum">    3010 </span>            :  * MonoException *ex = NULL;
<span class="lineNum">    3011 </span>            :  * Equals func = mono_method_get_unmanaged_thunk (method);
<span class="lineNum">    3012 </span>            :  * MonoBoolean res = func (thisObj, objToCompare, &amp;ex);
<span class="lineNum">    3013 </span>            :  * if (ex) {
<span class="lineNum">    3014 </span>            :  *    // handle exception
<span class="lineNum">    3015 </span>            :  * }
<span class="lineNum">    3016 </span>            :  *
<span class="lineNum">    3017 </span>            :  * The calling convention of the thunk matches the platform's default
<span class="lineNum">    3018 </span>            :  * convention. This means that under Windows, C declarations must
<span class="lineNum">    3019 </span>            :  * contain the __stdcall attribute:
<span class="lineNum">    3020 </span>            :  *
<span class="lineNum">    3021 </span>            :  * C:  typedef MonoBoolean (__stdcall *Equals)(MonoObject*,
<span class="lineNum">    3022 </span>            :  *             MonoObject*, MonoException**);
<span class="lineNum">    3023 </span>            :  *
<span class="lineNum">    3024 </span>            :  * LIMITATIONS
<span class="lineNum">    3025 </span>            :  *
<span class="lineNum">    3026 </span>            :  * Value type arguments and return values are treated as they were objects:
<span class="lineNum">    3027 </span>            :  *
<span class="lineNum">    3028 </span>            :  * C#: public static Rectangle Intersect (Rectangle a, Rectangle b);
<span class="lineNum">    3029 </span>            :  * C:  typedef MonoObject* (*Intersect)(MonoObject*, MonoObject*, MonoException**);
<span class="lineNum">    3030 </span>            :  *
<span class="lineNum">    3031 </span>            :  * Arguments must be properly boxed upon trunk's invocation, while return
<span class="lineNum">    3032 </span>            :  * values must be unboxed.
<a name="3033"><span class="lineNum">    3033 </span>            :  */</a>
<span class="lineNum">    3034 </span>            : gpointer
<span class="lineNum">    3035 </span>            : mono_method_get_unmanaged_thunk (MonoMethod *method)
<span class="lineNum">    3036 </span>            : {
<span class="lineNum">    3037 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3038 </span>            :         MONO_REQ_API_ENTRYPOINT;
<span class="lineNum">    3039 </span>            : 
<span class="lineNum">    3040 </span>            :         MonoError error;
<span class="lineNum">    3041 </span>            :         gpointer res;
<span class="lineNum">    3042 </span>            : 
<span class="lineNum">    3043 </span><span class="lineCov">        180 :         g_assert (!mono_threads_is_coop_enabled ());</span>
<span class="lineNum">    3044 </span>            : 
<span class="lineNum">    3045 </span><span class="lineCov">        120 :         MONO_ENTER_GC_UNSAFE;</span>
<span class="lineNum">    3046 </span><span class="lineCov">         60 :         method = mono_marshal_get_thunk_invoke_wrapper (method);</span>
<span class="lineNum">    3047 </span><span class="lineCov">         60 :         res = mono_compile_method_checked (method, &amp;error);</span>
<span class="lineNum">    3048 </span><span class="lineCov">         60 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    3049 </span><span class="lineCov">         60 :         MONO_EXIT_GC_UNSAFE;</span>
<span class="lineNum">    3050 </span>            : 
<span class="lineNum">    3051 </span><span class="lineCov">         60 :         return res;</span>
<span class="lineNum">    3052 </span>            : }
<a name="3053"><span class="lineNum">    3053 </span>            : </a>
<span class="lineNum">    3054 </span>            : void
<span class="lineNum">    3055 </span>            : mono_copy_value (MonoType *type, void *dest, void *value, int deref_pointer)
<span class="lineNum">    3056 </span>            : {
<span class="lineNum">    3057 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3058 </span>            : 
<span class="lineNum">    3059 </span>            :         int t;
<span class="lineNum">    3060 </span><span class="lineCov">     132618 :         if (type-&gt;byref) {</span>
<span class="lineNum">    3061 </span>            :                 /* object fields cannot be byref, so we don't need a
<span class="lineNum">    3062 </span>            :                    wbarrier here */
<span class="lineNum">    3063 </span><span class="lineNoCov">          0 :                 gpointer *p = (gpointer*)dest;</span>
<span class="lineNum">    3064 </span><span class="lineNoCov">          0 :                 *p = value;</span>
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3066 </span>            :         }
<span class="lineNum">    3067 </span><span class="lineCov">     132619 :         t = type-&gt;type;</span>
<span class="lineNum">    3068 </span>            : handle_enum:
<span class="lineNum">    3069 </span><span class="lineCov">     136504 :         switch (t) {</span>
<span class="lineNum">    3070 </span>            :         case MONO_TYPE_BOOLEAN:
<span class="lineNum">    3071 </span>            :         case MONO_TYPE_I1:
<span class="lineNum">    3072 </span>            :         case MONO_TYPE_U1: {
<span class="lineNum">    3073 </span><span class="lineCov">        578 :                 guint8 *p = (guint8*)dest;</span>
<span class="lineNum">    3074 </span><span class="lineCov">       1734 :                 *p = value ? *(guint8*)value : 0;</span>
<span class="lineNum">    3075 </span><span class="lineCov">        578 :                 return;</span>
<span class="lineNum">    3076 </span>            :         }
<span class="lineNum">    3077 </span>            :         case MONO_TYPE_I2:
<span class="lineNum">    3078 </span>            :         case MONO_TYPE_U2:
<span class="lineNum">    3079 </span>            :         case MONO_TYPE_CHAR: {
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :                 guint16 *p = (guint16*)dest;</span>
<span class="lineNum">    3081 </span><span class="lineNoCov">          0 :                 *p = value ? *(guint16*)value : 0;</span>
<span class="lineNum">    3082 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3083 </span>            :         }
<span class="lineNum">    3084 </span>            : #if SIZEOF_VOID_P == 4
<span class="lineNum">    3085 </span>            :         case MONO_TYPE_I:
<span class="lineNum">    3086 </span>            :         case MONO_TYPE_U:
<span class="lineNum">    3087 </span>            : #endif
<span class="lineNum">    3088 </span>            :         case MONO_TYPE_I4:
<span class="lineNum">    3089 </span>            :         case MONO_TYPE_U4: {
<span class="lineNum">    3090 </span><span class="lineCov">       5564 :                 gint32 *p = (gint32*)dest;</span>
<span class="lineNum">    3091 </span><span class="lineCov">      16692 :                 *p = value ? *(gint32*)value : 0;</span>
<span class="lineNum">    3092 </span><span class="lineCov">       5564 :                 return;</span>
<span class="lineNum">    3093 </span>            :         }
<span class="lineNum">    3094 </span>            : #if SIZEOF_VOID_P == 8
<span class="lineNum">    3095 </span>            :         case MONO_TYPE_I:
<span class="lineNum">    3096 </span>            :         case MONO_TYPE_U:
<span class="lineNum">    3097 </span>            : #endif
<span class="lineNum">    3098 </span>            :         case MONO_TYPE_I8:
<span class="lineNum">    3099 </span>            :         case MONO_TYPE_U8: {
<span class="lineNum">    3100 </span><span class="lineCov">       1068 :                 gint64 *p = (gint64*)dest;</span>
<span class="lineNum">    3101 </span><span class="lineCov">       3204 :                 *p = value ? *(gint64*)value : 0;</span>
<span class="lineNum">    3102 </span><span class="lineCov">       1068 :                 return;</span>
<span class="lineNum">    3103 </span>            :         }
<span class="lineNum">    3104 </span>            :         case MONO_TYPE_R4: {
<span class="lineNum">    3105 </span><span class="lineNoCov">          0 :                 float *p = (float*)dest;</span>
<span class="lineNum">    3106 </span><span class="lineNoCov">          0 :                 *p = value ? *(float*)value : 0;</span>
<span class="lineNum">    3107 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3108 </span>            :         }
<span class="lineNum">    3109 </span>            :         case MONO_TYPE_R8: {
<span class="lineNum">    3110 </span><span class="lineNoCov">          0 :                 double *p = (double*)dest;</span>
<span class="lineNum">    3111 </span><span class="lineNoCov">          0 :                 *p = value ? *(double*)value : 0;</span>
<span class="lineNum">    3112 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3113 </span>            :         }
<span class="lineNum">    3114 </span>            :         case MONO_TYPE_STRING:
<span class="lineNum">    3115 </span>            :         case MONO_TYPE_SZARRAY:
<span class="lineNum">    3116 </span>            :         case MONO_TYPE_CLASS:
<span class="lineNum">    3117 </span>            :         case MONO_TYPE_OBJECT:
<span class="lineNum">    3118 </span>            :         case MONO_TYPE_ARRAY:
<span class="lineNum">    3119 </span><span class="lineCov">     376089 :                 mono_gc_wbarrier_generic_store (dest, deref_pointer ? *(MonoObject **)value : (MonoObject *)value);</span>
<span class="lineNum">    3120 </span><span class="lineCov">     125363 :                 return;</span>
<span class="lineNum">    3121 </span>            :         case MONO_TYPE_FNPTR:
<span class="lineNum">    3122 </span>            :         case MONO_TYPE_PTR: {
<span class="lineNum">    3123 </span><span class="lineNoCov">          0 :                 gpointer *p = (gpointer*)dest;</span>
<span class="lineNum">    3124 </span><span class="lineNoCov">          0 :                 *p = deref_pointer? *(gpointer*)value: value;</span>
<span class="lineNum">    3125 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3126 </span>            :         }
<span class="lineNum">    3127 </span>            :         case MONO_TYPE_VALUETYPE:
<span class="lineNum">    3128 </span>            :                 /* note that 't' and 'type-&gt;type' can be different */
<span class="lineNum">    3129 </span><span class="lineCov">       1136 :                 if (type-&gt;type == MONO_TYPE_VALUETYPE &amp;&amp; type-&gt;data.klass-&gt;enumtype) {</span>
<span class="lineNum">    3130 </span><span class="lineCov">        524 :                         t = mono_class_enum_basetype (type-&gt;data.klass)-&gt;type;</span>
<span class="lineNum">    3131 </span><span class="lineCov">        524 :                         goto handle_enum;</span>
<span class="lineNum">    3132 </span>            :                 } else {
<span class="lineNum">    3133 </span><span class="lineCov">         44 :                         MonoClass *klass = mono_class_from_mono_type (type);</span>
<span class="lineNum">    3134 </span><span class="lineCov">         44 :                         int size = mono_class_value_size (klass, NULL);</span>
<span class="lineNum">    3135 </span><span class="lineCov">         44 :                         if (value == NULL)</span>
<span class="lineNum">    3136 </span><span class="lineNoCov">          0 :                                 mono_gc_bzero_atomic (dest, size);</span>
<span class="lineNum">    3137 </span>            :                         else
<span class="lineNum">    3138 </span><span class="lineCov">         44 :                                 mono_gc_wbarrier_value_copy (dest, value, 1, klass);</span>
<span class="lineNum">    3139 </span>            :                 }
<span class="lineNum">    3140 </span><span class="lineCov">         44 :                 return;</span>
<span class="lineNum">    3141 </span>            :         case MONO_TYPE_GENERICINST:
<span class="lineNum">    3142 </span><span class="lineCov">       3363 :                 t = type-&gt;data.generic_class-&gt;container_class-&gt;byval_arg.type;</span>
<span class="lineNum">    3143 </span><span class="lineCov">       3363 :                 goto handle_enum;</span>
<span class="lineNum">    3144 </span>            :         default:
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 :                 g_error (&quot;got type %x&quot;, type-&gt;type);</span>
<span class="lineNum">    3146 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3147 </span><span class="lineCov">     132614 : }</span>
<span class="lineNum">    3148 </span>            : 
<span class="lineNum">    3149 </span>            : /**
<span class="lineNum">    3150 </span>            :  * mono_field_set_value:
<span class="lineNum">    3151 </span>            :  * @obj: Instance object
<span class="lineNum">    3152 </span>            :  * @field: MonoClassField describing the field to set
<span class="lineNum">    3153 </span>            :  * @value: The value to be set
<span class="lineNum">    3154 </span>            :  *
<span class="lineNum">    3155 </span>            :  * Sets the value of the field described by @field in the object instance @obj
<span class="lineNum">    3156 </span>            :  * to the value passed in @value.   This method should only be used for instance
<span class="lineNum">    3157 </span>            :  * fields.   For static fields, use mono_field_static_set_value.
<span class="lineNum">    3158 </span>            :  *
<span class="lineNum">    3159 </span>            :  * The value must be on the native format of the field type. 
<a name="3160"><span class="lineNum">    3160 </span>            :  */</a>
<span class="lineNum">    3161 </span>            : void
<span class="lineNum">    3162 </span>            : mono_field_set_value (MonoObject *obj, MonoClassField *field, void *value)
<span class="lineNum">    3163 </span>            : {
<span class="lineNum">    3164 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3165 </span>            : 
<span class="lineNum">    3166 </span>            :         void *dest;
<span class="lineNum">    3167 </span>            : 
<span class="lineNum">    3168 </span><span class="lineCov">      37830 :         g_return_if_fail (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC));</span>
<span class="lineNum">    3169 </span>            : 
<span class="lineNum">    3170 </span><span class="lineCov">      12610 :         dest = (char*)obj + field-&gt;offset;</span>
<span class="lineNum">    3171 </span><span class="lineCov">      12610 :         mono_copy_value (field-&gt;type, dest, value, FALSE);</span>
<span class="lineNum">    3172 </span><span class="lineCov">      25220 : }</span>
<span class="lineNum">    3173 </span>            : 
<span class="lineNum">    3174 </span>            : /**
<span class="lineNum">    3175 </span>            :  * mono_field_static_set_value:
<span class="lineNum">    3176 </span>            :  * @field: MonoClassField describing the field to set
<span class="lineNum">    3177 </span>            :  * @value: The value to be set
<span class="lineNum">    3178 </span>            :  *
<span class="lineNum">    3179 </span>            :  * Sets the value of the static field described by @field
<span class="lineNum">    3180 </span>            :  * to the value passed in @value.
<span class="lineNum">    3181 </span>            :  *
<span class="lineNum">    3182 </span>            :  * The value must be on the native format of the field type. 
<a name="3183"><span class="lineNum">    3183 </span>            :  */</a>
<span class="lineNum">    3184 </span>            : void
<span class="lineNum">    3185 </span>            : mono_field_static_set_value (MonoVTable *vt, MonoClassField *field, void *value)
<span class="lineNum">    3186 </span>            : {
<span class="lineNum">    3187 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3188 </span>            : 
<span class="lineNum">    3189 </span>            :         void *dest;
<span class="lineNum">    3190 </span>            : 
<span class="lineNum">    3191 </span><span class="lineCov">      10602 :         g_return_if_fail (field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC);</span>
<span class="lineNum">    3192 </span>            :         /* you cant set a constant! */
<span class="lineNum">    3193 </span><span class="lineCov">      10602 :         g_return_if_fail (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL));</span>
<span class="lineNum">    3194 </span>            : 
<span class="lineNum">    3195 </span><span class="lineCov">       3534 :         if (field-&gt;offset == -1) {</span>
<span class="lineNum">    3196 </span>            :                 /* Special static */
<span class="lineNum">    3197 </span>            :                 gpointer addr;
<span class="lineNum">    3198 </span>            : 
<span class="lineNum">    3199 </span><span class="lineCov">          2 :                 mono_domain_lock (vt-&gt;domain);</span>
<span class="lineNum">    3200 </span><span class="lineCov">          2 :                 addr = g_hash_table_lookup (vt-&gt;domain-&gt;special_static_fields, field);</span>
<span class="lineNum">    3201 </span><span class="lineCov">          2 :                 mono_domain_unlock (vt-&gt;domain);</span>
<span class="lineNum">    3202 </span><span class="lineCov">          2 :                 dest = mono_get_special_static_data (GPOINTER_TO_UINT (addr));</span>
<span class="lineNum">    3203 </span><span class="lineCov">          2 :         } else {</span>
<span class="lineNum">    3204 </span><span class="lineCov">       3532 :                 dest = (char*)mono_vtable_get_static_field_data (vt) + field-&gt;offset;</span>
<span class="lineNum">    3205 </span>            :         }
<span class="lineNum">    3206 </span><span class="lineCov">       3534 :         mono_copy_value (field-&gt;type, dest, value, FALSE);</span>
<span class="lineNum">    3207 </span><span class="lineCov">       7068 : }</span>
<span class="lineNum">    3208 </span>            : 
<span class="lineNum">    3209 </span>            : /**
<span class="lineNum">    3210 </span>            :  * mono_vtable_get_static_field_data:
<span class="lineNum">    3211 </span>            :  *
<span class="lineNum">    3212 </span>            :  * Internal use function: return a pointer to the memory holding the static fields
<span class="lineNum">    3213 </span>            :  * for a class or NULL if there are no static fields.
<span class="lineNum">    3214 </span>            :  * This is exported only for use by the debugger.
<a name="3215"><span class="lineNum">    3215 </span>            :  */</a>
<span class="lineNum">    3216 </span>            : void *
<span class="lineNum">    3217 </span>            : mono_vtable_get_static_field_data (MonoVTable *vt)
<span class="lineNum">    3218 </span>            : {
<span class="lineNum">    3219 </span>            :         MONO_REQ_GC_NEUTRAL_MODE
<span class="lineNum">    3220 </span>            : 
<span class="lineNum">    3221 </span><span class="lineCov">   11087185 :         if (!vt-&gt;has_static_fields)</span>
<span class="lineNum">    3222 </span><span class="lineCov">       6878 :                 return NULL;</span>
<span class="lineNum">    3223 </span><span class="lineCov">   11080456 :         return vt-&gt;vtable [vt-&gt;klass-&gt;vtable_size];</span>
<span class="lineNum">    3224 </span><span class="lineCov">   11087521 : }</span>
<a name="3225"><span class="lineNum">    3225 </span>            : </a>
<span class="lineNum">    3226 </span>            : static guint8*
<span class="lineNum">    3227 </span>            : mono_field_get_addr (MonoObject *obj, MonoVTable *vt, MonoClassField *field)
<span class="lineNum">    3228 </span>            : {
<span class="lineNum">    3229 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3230 </span>            : 
<span class="lineNum">    3231 </span>            :         guint8 *src;
<span class="lineNum">    3232 </span>            : 
<span class="lineNum">    3233 </span><span class="lineNoCov">          0 :         if (field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC) {</span>
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :                 if (field-&gt;offset == -1) {</span>
<span class="lineNum">    3235 </span>            :                         /* Special static */
<span class="lineNum">    3236 </span>            :                         gpointer addr;
<span class="lineNum">    3237 </span>            : 
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :                         mono_domain_lock (vt-&gt;domain);</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :                         addr = g_hash_table_lookup (vt-&gt;domain-&gt;special_static_fields, field);</span>
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :                         mono_domain_unlock (vt-&gt;domain);</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :                         src = (guint8 *)mono_get_special_static_data (GPOINTER_TO_UINT (addr));</span>
<span class="lineNum">    3242 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    3243 </span><span class="lineNoCov">          0 :                         src = (guint8*)mono_vtable_get_static_field_data (vt) + field-&gt;offset;</span>
<span class="lineNum">    3244 </span>            :                 }
<span class="lineNum">    3245 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    3246 </span><span class="lineNoCov">          0 :                 src = (guint8*)obj + field-&gt;offset;</span>
<span class="lineNum">    3247 </span>            :         }
<span class="lineNum">    3248 </span>            : 
<span class="lineNum">    3249 </span><span class="lineNoCov">          0 :         return src;</span>
<span class="lineNum">    3250 </span>            : }
<span class="lineNum">    3251 </span>            : 
<span class="lineNum">    3252 </span>            : /**
<span class="lineNum">    3253 </span>            :  * mono_field_get_value:
<span class="lineNum">    3254 </span>            :  * @obj: Object instance
<span class="lineNum">    3255 </span>            :  * @field: MonoClassField describing the field to fetch information from
<span class="lineNum">    3256 </span>            :  * @value: pointer to the location where the value will be stored
<span class="lineNum">    3257 </span>            :  *
<span class="lineNum">    3258 </span>            :  * Use this routine to get the value of the field @field in the object
<span class="lineNum">    3259 </span>            :  * passed.
<span class="lineNum">    3260 </span>            :  *
<span class="lineNum">    3261 </span>            :  * The pointer provided by value must be of the field type, for reference
<span class="lineNum">    3262 </span>            :  * types this is a MonoObject*, for value types its the actual pointer to
<span class="lineNum">    3263 </span>            :  * the value type.
<span class="lineNum">    3264 </span>            :  *
<span class="lineNum">    3265 </span>            :  * For example:
<span class="lineNum">    3266 </span>            :  *     int i;
<span class="lineNum">    3267 </span>            :  *     mono_field_get_value (obj, int_field, &amp;i);
<a name="3268"><span class="lineNum">    3268 </span>            :  */</a>
<span class="lineNum">    3269 </span>            : void
<span class="lineNum">    3270 </span>            : mono_field_get_value (MonoObject *obj, MonoClassField *field, void *value)
<span class="lineNum">    3271 </span>            : {
<span class="lineNum">    3272 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3273 </span>            : 
<span class="lineNum">    3274 </span>            :         void *src;
<span class="lineNum">    3275 </span>            : 
<span class="lineNum">    3276 </span><span class="lineCov">     295822 :         g_assert (obj);</span>
<span class="lineNum">    3277 </span>            : 
<span class="lineNum">    3278 </span><span class="lineCov">     295822 :         g_return_if_fail (!(field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC));</span>
<span class="lineNum">    3279 </span>            : 
<span class="lineNum">    3280 </span><span class="lineCov">      98608 :         src = (char*)obj + field-&gt;offset;</span>
<span class="lineNum">    3281 </span><span class="lineCov">      98608 :         mono_copy_value (field-&gt;type, value, src, TRUE);</span>
<span class="lineNum">    3282 </span><span class="lineCov">     197213 : }</span>
<span class="lineNum">    3283 </span>            : 
<span class="lineNum">    3284 </span>            : /**
<span class="lineNum">    3285 </span>            :  * mono_field_get_value_object:
<span class="lineNum">    3286 </span>            :  * @domain: domain where the object will be created (if boxing)
<span class="lineNum">    3287 </span>            :  * @field: MonoClassField describing the field to fetch information from
<span class="lineNum">    3288 </span>            :  * @obj: The object instance for the field.
<span class="lineNum">    3289 </span>            :  *
<span class="lineNum">    3290 </span>            :  * Returns: a new MonoObject with the value from the given field.  If the
<span class="lineNum">    3291 </span>            :  * field represents a value type, the value is boxed.
<span class="lineNum">    3292 </span>            :  *
<a name="3293"><span class="lineNum">    3293 </span>            :  */</a>
<span class="lineNum">    3294 </span>            : MonoObject *
<span class="lineNum">    3295 </span>            : mono_field_get_value_object (MonoDomain *domain, MonoClassField *field, MonoObject *obj)
<span class="lineNum">    3296 </span>            : {       
<span class="lineNum">    3297 </span>            :         MonoError error;
<span class="lineNum">    3298 </span><span class="lineNoCov">          0 :         MonoObject* result = mono_field_get_value_object_checked (domain, field, obj, &amp;error);</span>
<span class="lineNum">    3299 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    3300 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    3301 </span>            : }
<span class="lineNum">    3302 </span>            : 
<span class="lineNum">    3303 </span>            : /**
<span class="lineNum">    3304 </span>            :  * mono_field_get_value_object_checked:
<span class="lineNum">    3305 </span>            :  * @domain: domain where the object will be created (if boxing)
<span class="lineNum">    3306 </span>            :  * @field: MonoClassField describing the field to fetch information from
<span class="lineNum">    3307 </span>            :  * @obj: The object instance for the field.
<span class="lineNum">    3308 </span>            :  * @error: Set on error.
<span class="lineNum">    3309 </span>            :  *
<span class="lineNum">    3310 </span>            :  * Returns: a new MonoObject with the value from the given field.  If the
<span class="lineNum">    3311 </span>            :  * field represents a value type, the value is boxed.  On error returns NULL and sets @error.
<span class="lineNum">    3312 </span>            :  *
<a name="3313"><span class="lineNum">    3313 </span>            :  */</a>
<span class="lineNum">    3314 </span>            : MonoObject *
<span class="lineNum">    3315 </span>            : mono_field_get_value_object_checked (MonoDomain *domain, MonoClassField *field, MonoObject *obj, MonoError *error)
<span class="lineNum">    3316 </span>            : {
<span class="lineNum">    3317 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3318 </span>            : 
<span class="lineNum">    3319 </span><span class="lineCov">      45187 :         mono_error_init (error);</span>
<span class="lineNum">    3320 </span>            : 
<span class="lineNum">    3321 </span>            :         MonoObject *o;
<span class="lineNum">    3322 </span>            :         MonoClass *klass;
<span class="lineNum">    3323 </span><span class="lineCov">      45187 :         MonoVTable *vtable = NULL;</span>
<span class="lineNum">    3324 </span>            :         gchar *v;
<span class="lineNum">    3325 </span><span class="lineCov">      45187 :         gboolean is_static = FALSE;</span>
<span class="lineNum">    3326 </span><span class="lineCov">      45187 :         gboolean is_ref = FALSE;</span>
<span class="lineNum">    3327 </span><span class="lineCov">      45187 :         gboolean is_literal = FALSE;</span>
<span class="lineNum">    3328 </span><span class="lineCov">      45187 :         gboolean is_ptr = FALSE;</span>
<span class="lineNum">    3329 </span><span class="lineCov">      45187 :         MonoType *type = mono_field_get_type_checked (field, error);</span>
<span class="lineNum">    3330 </span>            : 
<span class="lineNum">    3331 </span><span class="lineCov">     135569 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3332 </span>            : 
<span class="lineNum">    3333 </span><span class="lineCov">      45197 :         switch (type-&gt;type) {</span>
<span class="lineNum">    3334 </span>            :         case MONO_TYPE_STRING:
<span class="lineNum">    3335 </span>            :         case MONO_TYPE_OBJECT:
<span class="lineNum">    3336 </span>            :         case MONO_TYPE_CLASS:
<span class="lineNum">    3337 </span>            :         case MONO_TYPE_ARRAY:
<span class="lineNum">    3338 </span>            :         case MONO_TYPE_SZARRAY:
<span class="lineNum">    3339 </span><span class="lineCov">      34447 :                 is_ref = TRUE;</span>
<span class="lineNum">    3340 </span><span class="lineCov">      34447 :                 break;</span>
<span class="lineNum">    3341 </span>            :         case MONO_TYPE_U1:
<span class="lineNum">    3342 </span>            :         case MONO_TYPE_I1:
<span class="lineNum">    3343 </span>            :         case MONO_TYPE_BOOLEAN:
<span class="lineNum">    3344 </span>            :         case MONO_TYPE_U2:
<span class="lineNum">    3345 </span>            :         case MONO_TYPE_I2:
<span class="lineNum">    3346 </span>            :         case MONO_TYPE_CHAR:
<span class="lineNum">    3347 </span>            :         case MONO_TYPE_U:
<span class="lineNum">    3348 </span>            :         case MONO_TYPE_I:
<span class="lineNum">    3349 </span>            :         case MONO_TYPE_U4:
<span class="lineNum">    3350 </span>            :         case MONO_TYPE_I4:
<span class="lineNum">    3351 </span>            :         case MONO_TYPE_R4:
<span class="lineNum">    3352 </span>            :         case MONO_TYPE_U8:
<span class="lineNum">    3353 </span>            :         case MONO_TYPE_I8:
<span class="lineNum">    3354 </span>            :         case MONO_TYPE_R8:
<span class="lineNum">    3355 </span>            :         case MONO_TYPE_VALUETYPE:
<span class="lineNum">    3356 </span><span class="lineCov">       7385 :                 is_ref = type-&gt;byref;</span>
<span class="lineNum">    3357 </span><span class="lineCov">       7385 :                 break;</span>
<span class="lineNum">    3358 </span>            :         case MONO_TYPE_GENERICINST:
<span class="lineNum">    3359 </span><span class="lineCov">       3365 :                 is_ref = !mono_type_generic_inst_is_valuetype (type);</span>
<span class="lineNum">    3360 </span><span class="lineCov">       3365 :                 break;</span>
<span class="lineNum">    3361 </span>            :         case MONO_TYPE_PTR:
<span class="lineNum">    3362 </span><span class="lineNoCov">          0 :                 is_ptr = TRUE;</span>
<span class="lineNum">    3363 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    3364 </span>            :         default:
<span class="lineNum">    3365 </span><span class="lineNoCov">          0 :                 g_error (&quot;type 0x%x not handled in &quot;</span>
<span class="lineNum">    3366 </span>            :                          &quot;mono_field_get_value_object&quot;, type-&gt;type);
<span class="lineNum">    3367 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3368 </span>            :         }
<span class="lineNum">    3369 </span>            : 
<span class="lineNum">    3370 </span><span class="lineCov">      45193 :         if (type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL)</span>
<span class="lineNum">    3371 </span><span class="lineCov">       3337 :                 is_literal = TRUE;</span>
<span class="lineNum">    3372 </span>            : 
<span class="lineNum">    3373 </span><span class="lineCov">      45193 :         if (type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC) {</span>
<span class="lineNum">    3374 </span><span class="lineCov">      21205 :                 is_static = TRUE;</span>
<span class="lineNum">    3375 </span>            : 
<span class="lineNum">    3376 </span><span class="lineCov">      21205 :                 if (!is_literal) {</span>
<span class="lineNum">    3377 </span><span class="lineCov">      17868 :                         vtable = mono_class_vtable_full (domain, field-&gt;parent, error);</span>
<span class="lineNum">    3378 </span><span class="lineCov">      53604 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3379 </span>            : 
<span class="lineNum">    3380 </span><span class="lineCov">      17867 :                         if (!vtable-&gt;initialized) {</span>
<span class="lineNum">    3381 </span><span class="lineCov">        511 :                                 mono_runtime_class_init_full (vtable, error);</span>
<span class="lineNum">    3382 </span><span class="lineCov">       1533 :                                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3383 </span><span class="lineCov">        511 :                         }</span>
<span class="lineNum">    3384 </span><span class="lineCov">      17867 :                 }</span>
<span class="lineNum">    3385 </span><span class="lineCov">      21204 :         } else {</span>
<span class="lineNum">    3386 </span><span class="lineCov">      71967 :                 g_assert (obj);</span>
<span class="lineNum">    3387 </span>            :         }
<span class="lineNum">    3388 </span>            :         
<span class="lineNum">    3389 </span><span class="lineCov">      45193 :         if (is_ref) {</span>
<span class="lineNum">    3390 </span><span class="lineCov">      37809 :                 if (is_literal) {</span>
<span class="lineNum">    3391 </span><span class="lineCov">          6 :                         get_default_field_value (domain, field, &amp;o, error);</span>
<span class="lineNum">    3392 </span><span class="lineCov">         18 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3393 </span><span class="lineCov">      37808 :                 } else if (is_static) {</span>
<span class="lineNum">    3394 </span><span class="lineCov">      17863 :                         mono_field_static_get_value_checked (vtable, field, &amp;o, error);</span>
<span class="lineNum">    3395 </span><span class="lineCov">      53587 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3396 </span><span class="lineCov">      17862 :                 } else {</span>
<span class="lineNum">    3397 </span><span class="lineCov">      19940 :                         mono_field_get_value (obj, field, &amp;o);</span>
<span class="lineNum">    3398 </span>            :                 }
<span class="lineNum">    3399 </span><span class="lineCov">      37805 :                 return o;</span>
<span class="lineNum">    3400 </span>            :         }
<span class="lineNum">    3401 </span>            : 
<span class="lineNum">    3402 </span><span class="lineCov">       7384 :         if (is_ptr) {</span>
<span class="lineNum">    3403 </span>            :                 static MonoMethod *m;
<span class="lineNum">    3404 </span>            :                 gpointer args [2];
<span class="lineNum">    3405 </span>            :                 gpointer *ptr;
<span class="lineNum">    3406 </span>            :                 gpointer v;
<span class="lineNum">    3407 </span>            : 
<span class="lineNum">    3408 </span><span class="lineNoCov">          0 :                 if (!m) {</span>
<span class="lineNum">    3409 </span><span class="lineNoCov">          0 :                         MonoClass *ptr_klass = mono_class_get_pointer_class ();</span>
<span class="lineNum">    3410 </span><span class="lineNoCov">          0 :                         m = mono_class_get_method_from_name_flags (ptr_klass, &quot;Box&quot;, 2, METHOD_ATTRIBUTE_STATIC);</span>
<span class="lineNum">    3411 </span><span class="lineNoCov">          0 :                         g_assert (m);</span>
<span class="lineNum">    3412 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    3413 </span>            : 
<span class="lineNum">    3414 </span><span class="lineNoCov">          0 :                 v = &amp;ptr;</span>
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :                 if (is_literal) {</span>
<span class="lineNum">    3416 </span><span class="lineNoCov">          0 :                         get_default_field_value (domain, field, v, error);</span>
<span class="lineNum">    3417 </span><span class="lineNoCov">          0 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3418 </span><span class="lineNoCov">          0 :                 } else if (is_static) {</span>
<span class="lineNum">    3419 </span><span class="lineNoCov">          0 :                         mono_field_static_get_value_checked (vtable, field, v, error);</span>
<span class="lineNum">    3420 </span><span class="lineNoCov">          0 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3421 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    3422 </span><span class="lineNoCov">          0 :                         mono_field_get_value (obj, field, v);</span>
<span class="lineNum">    3423 </span>            :                 }
<span class="lineNum">    3424 </span>            : 
<span class="lineNum">    3425 </span>            :                 /* MONO_TYPE_PTR is passed by value to runtime_invoke () */
<span class="lineNum">    3426 </span><span class="lineNoCov">          0 :                 args [0] = ptr ? *ptr : NULL;</span>
<span class="lineNum">    3427 </span><span class="lineNoCov">          0 :                 args [1] = mono_type_get_object_checked (mono_domain_get (), type, error);</span>
<span class="lineNum">    3428 </span><span class="lineNoCov">          0 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3429 </span>            : 
<span class="lineNum">    3430 </span><span class="lineNoCov">          0 :                 o = mono_runtime_invoke_checked (m, NULL, args, error);</span>
<span class="lineNum">    3431 </span><span class="lineNoCov">          0 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3432 </span>            : 
<span class="lineNum">    3433 </span><span class="lineNoCov">          0 :                 return o;</span>
<span class="lineNum">    3434 </span>            :         }
<span class="lineNum">    3435 </span>            : 
<span class="lineNum">    3436 </span>            :         /* boxed value type */
<span class="lineNum">    3437 </span><span class="lineCov">       7384 :         klass = mono_class_from_mono_type (type);</span>
<span class="lineNum">    3438 </span>            : 
<span class="lineNum">    3439 </span><span class="lineCov">       7384 :         if (mono_class_is_nullable (klass))</span>
<span class="lineNum">    3440 </span><span class="lineNoCov">          0 :                 return mono_nullable_box (mono_field_get_addr (obj, vtable, field), klass, error);</span>
<span class="lineNum">    3441 </span>            : 
<span class="lineNum">    3442 </span><span class="lineCov">       7384 :         o = mono_object_new_checked (domain, klass, error);</span>
<span class="lineNum">    3443 </span><span class="lineCov">      22152 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3444 </span><span class="lineCov">       7384 :         v = ((gchar *) o) + sizeof (MonoObject);</span>
<span class="lineNum">    3445 </span>            : 
<span class="lineNum">    3446 </span><span class="lineCov">       7384 :         if (is_literal) {</span>
<span class="lineNum">    3447 </span><span class="lineCov">       3331 :                 get_default_field_value (domain, field, v, error);</span>
<span class="lineNum">    3448 </span><span class="lineCov">       9993 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3449 </span><span class="lineCov">       7384 :         } else if (is_static) {</span>
<span class="lineNum">    3450 </span><span class="lineCov">          4 :                 mono_field_static_get_value_checked (vtable, field, v, error);</span>
<span class="lineNum">    3451 </span><span class="lineCov">         12 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3452 </span><span class="lineCov">          4 :         } else {</span>
<span class="lineNum">    3453 </span><span class="lineCov">       4049 :                 mono_field_get_value (obj, field, v);</span>
<span class="lineNum">    3454 </span>            :         }
<span class="lineNum">    3455 </span>            : 
<span class="lineNum">    3456 </span><span class="lineCov">       7384 :         return o;</span>
<span class="lineNum">    3457 </span><span class="lineCov">      45190 : }</span>
<a name="3458"><span class="lineNum">    3458 </span>            : </a>
<span class="lineNum">    3459 </span>            : int
<span class="lineNum">    3460 </span>            : mono_get_constant_value_from_blob (MonoDomain* domain, MonoTypeEnum type, const char *blob, void *value, MonoError *error)
<span class="lineNum">    3461 </span>            : {
<span class="lineNum">    3462 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3463 </span>            : 
<span class="lineNum">    3464 </span><span class="lineCov">       3337 :         mono_error_init (error);</span>
<span class="lineNum">    3465 </span><span class="lineCov">       3337 :         int retval = 0;</span>
<span class="lineNum">    3466 </span><span class="lineCov">       3337 :         const char *p = blob;</span>
<span class="lineNum">    3467 </span><span class="lineCov">       3337 :         mono_metadata_decode_blob_size (p, &amp;p);</span>
<span class="lineNum">    3468 </span>            : 
<span class="lineNum">    3469 </span><span class="lineCov">       3337 :         switch (type) {</span>
<span class="lineNum">    3470 </span>            :         case MONO_TYPE_BOOLEAN:
<span class="lineNum">    3471 </span>            :         case MONO_TYPE_U1:
<span class="lineNum">    3472 </span>            :         case MONO_TYPE_I1:
<span class="lineNum">    3473 </span><span class="lineCov">         10 :                 *(guint8 *) value = *p;</span>
<span class="lineNum">    3474 </span><span class="lineCov">         10 :                 break;</span>
<span class="lineNum">    3475 </span>            :         case MONO_TYPE_CHAR:
<span class="lineNum">    3476 </span>            :         case MONO_TYPE_U2:
<span class="lineNum">    3477 </span>            :         case MONO_TYPE_I2:
<span class="lineNum">    3478 </span><span class="lineCov">         10 :                 *(guint16*) value = read16 (p);</span>
<span class="lineNum">    3479 </span><span class="lineCov">         10 :                 break;</span>
<span class="lineNum">    3480 </span>            :         case MONO_TYPE_U4:
<span class="lineNum">    3481 </span>            :         case MONO_TYPE_I4:
<span class="lineNum">    3482 </span><span class="lineCov">       3291 :                 *(guint32*) value = read32 (p);</span>
<span class="lineNum">    3483 </span><span class="lineCov">       3291 :                 break;</span>
<span class="lineNum">    3484 </span>            :         case MONO_TYPE_U8:
<span class="lineNum">    3485 </span>            :         case MONO_TYPE_I8:
<span class="lineNum">    3486 </span><span class="lineCov">          8 :                 *(guint64*) value = read64 (p);</span>
<span class="lineNum">    3487 </span><span class="lineCov">          8 :                 break;</span>
<span class="lineNum">    3488 </span>            :         case MONO_TYPE_R4:
<span class="lineNum">    3489 </span><span class="lineCov">         12 :                 readr4 (p, (float*) value);</span>
<span class="lineNum">    3490 </span><span class="lineCov">          6 :                 break;</span>
<span class="lineNum">    3491 </span>            :         case MONO_TYPE_R8:
<span class="lineNum">    3492 </span><span class="lineCov">         12 :                 readr8 (p, (double*) value);</span>
<span class="lineNum">    3493 </span><span class="lineCov">          6 :                 break;</span>
<span class="lineNum">    3494 </span>            :         case MONO_TYPE_STRING:
<span class="lineNum">    3495 </span><span class="lineCov">          4 :                 *(gpointer*) value = mono_ldstr_metadata_sig (domain, blob, error);</span>
<span class="lineNum">    3496 </span><span class="lineCov">          4 :                 break;</span>
<span class="lineNum">    3497 </span>            :         case MONO_TYPE_CLASS:
<span class="lineNum">    3498 </span><span class="lineCov">          2 :                 *(gpointer*) value = NULL;</span>
<span class="lineNum">    3499 </span><span class="lineCov">          2 :                 break;</span>
<span class="lineNum">    3500 </span>            :         default:
<span class="lineNum">    3501 </span><span class="lineNoCov">          0 :                 retval = -1;</span>
<span class="lineNum">    3502 </span><span class="lineNoCov">          0 :                 g_warning (&quot;type 0x%02x should not be in constant table&quot;, type);</span>
<span class="lineNum">    3503 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3504 </span><span class="lineCov">       3337 :         return retval;</span>
<span class="lineNum">    3505 </span>            : }
<a name="3506"><span class="lineNum">    3506 </span>            : </a>
<span class="lineNum">    3507 </span>            : static void
<span class="lineNum">    3508 </span>            : get_default_field_value (MonoDomain* domain, MonoClassField *field, void *value, MonoError *error)
<span class="lineNum">    3509 </span>            : {
<span class="lineNum">    3510 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3511 </span>            : 
<span class="lineNum">    3512 </span>            :         MonoTypeEnum def_type;
<span class="lineNum">    3513 </span>            :         const char* data;
<span class="lineNum">    3514 </span>            : 
<span class="lineNum">    3515 </span><span class="lineCov">       3337 :         mono_error_init (error);</span>
<span class="lineNum">    3516 </span>            :         
<span class="lineNum">    3517 </span><span class="lineCov">       3337 :         data = mono_class_get_field_default_value (field, &amp;def_type);</span>
<span class="lineNum">    3518 </span><span class="lineCov">       3337 :         mono_get_constant_value_from_blob (domain, def_type, data, value, error);</span>
<span class="lineNum">    3519 </span><span class="lineCov">       3337 : }</span>
<a name="3520"><span class="lineNum">    3520 </span>            : </a>
<span class="lineNum">    3521 </span>            : void
<span class="lineNum">    3522 </span>            : mono_field_static_get_value_for_thread (MonoInternalThread *thread, MonoVTable *vt, MonoClassField *field, void *value, MonoError *error)
<span class="lineNum">    3523 </span>            : {
<span class="lineNum">    3524 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3525 </span>            : 
<span class="lineNum">    3526 </span>            :         void *src;
<span class="lineNum">    3527 </span>            : 
<span class="lineNum">    3528 </span><span class="lineCov">      17866 :         mono_error_init (error);</span>
<span class="lineNum">    3529 </span>            : 
<span class="lineNum">    3530 </span><span class="lineCov">      53600 :         g_return_if_fail (field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_STATIC);</span>
<span class="lineNum">    3531 </span>            :         
<span class="lineNum">    3532 </span><span class="lineCov">      17867 :         if (field-&gt;type-&gt;attrs &amp; FIELD_ATTRIBUTE_LITERAL) {</span>
<span class="lineNum">    3533 </span><span class="lineNoCov">          0 :                 get_default_field_value (vt-&gt;domain, field, value, error);</span>
<span class="lineNum">    3534 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3535 </span>            :         }
<span class="lineNum">    3536 </span>            : 
<span class="lineNum">    3537 </span><span class="lineCov">      17867 :         if (field-&gt;offset == -1) {</span>
<span class="lineNum">    3538 </span>            :                 /* Special static */
<span class="lineNum">    3539 </span><span class="lineCov">          2 :                 gpointer addr = g_hash_table_lookup (vt-&gt;domain-&gt;special_static_fields, field);</span>
<span class="lineNum">    3540 </span><span class="lineCov">          2 :                 src = mono_get_special_static_data_for_thread (thread, GPOINTER_TO_UINT (addr));</span>
<span class="lineNum">    3541 </span><span class="lineCov">          2 :         } else {</span>
<span class="lineNum">    3542 </span><span class="lineCov">      17865 :                 src = (char*)mono_vtable_get_static_field_data (vt) + field-&gt;offset;</span>
<span class="lineNum">    3543 </span>            :         }
<span class="lineNum">    3544 </span><span class="lineCov">      17867 :         mono_copy_value (field-&gt;type, value, src, TRUE);</span>
<span class="lineNum">    3545 </span><span class="lineCov">      35733 : }</span>
<span class="lineNum">    3546 </span>            : 
<span class="lineNum">    3547 </span>            : /**
<span class="lineNum">    3548 </span>            :  * mono_field_static_get_value:
<span class="lineNum">    3549 </span>            :  * @vt: vtable to the object
<span class="lineNum">    3550 </span>            :  * @field: MonoClassField describing the field to fetch information from
<span class="lineNum">    3551 </span>            :  * @value: where the value is returned
<span class="lineNum">    3552 </span>            :  *
<span class="lineNum">    3553 </span>            :  * Use this routine to get the value of the static field @field value.
<span class="lineNum">    3554 </span>            :  *
<span class="lineNum">    3555 </span>            :  * The pointer provided by value must be of the field type, for reference
<span class="lineNum">    3556 </span>            :  * types this is a MonoObject*, for value types its the actual pointer to
<span class="lineNum">    3557 </span>            :  * the value type.
<span class="lineNum">    3558 </span>            :  *
<span class="lineNum">    3559 </span>            :  * For example:
<span class="lineNum">    3560 </span>            :  *     int i;
<span class="lineNum">    3561 </span>            :  *     mono_field_static_get_value (vt, int_field, &amp;i);
<a name="3562"><span class="lineNum">    3562 </span>            :  */</a>
<span class="lineNum">    3563 </span>            : void
<span class="lineNum">    3564 </span>            : mono_field_static_get_value (MonoVTable *vt, MonoClassField *field, void *value)
<span class="lineNum">    3565 </span>            : {
<span class="lineNum">    3566 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3567 </span>            : 
<span class="lineNum">    3568 </span>            :         MonoError error;
<span class="lineNum">    3569 </span><span class="lineNoCov">          0 :         mono_field_static_get_value_checked (vt, field, value, &amp;error);</span>
<span class="lineNum">    3570 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    3571 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3572 </span>            : 
<span class="lineNum">    3573 </span>            : /**
<span class="lineNum">    3574 </span>            :  * mono_field_static_get_value_checked:
<span class="lineNum">    3575 </span>            :  * @vt: vtable to the object
<span class="lineNum">    3576 </span>            :  * @field: MonoClassField describing the field to fetch information from
<span class="lineNum">    3577 </span>            :  * @value: where the value is returned
<span class="lineNum">    3578 </span>            :  * @error: set on error
<span class="lineNum">    3579 </span>            :  *
<span class="lineNum">    3580 </span>            :  * Use this routine to get the value of the static field @field value.
<span class="lineNum">    3581 </span>            :  *
<span class="lineNum">    3582 </span>            :  * The pointer provided by value must be of the field type, for reference
<span class="lineNum">    3583 </span>            :  * types this is a MonoObject*, for value types its the actual pointer to
<span class="lineNum">    3584 </span>            :  * the value type.
<span class="lineNum">    3585 </span>            :  *
<span class="lineNum">    3586 </span>            :  * For example:
<span class="lineNum">    3587 </span>            :  *     int i;
<span class="lineNum">    3588 </span>            :  *     mono_field_static_get_value_checked (vt, int_field, &amp;i, error);
<span class="lineNum">    3589 </span>            :  *     if (!is_ok (error)) { ... }
<span class="lineNum">    3590 </span>            :  *
<span class="lineNum">    3591 </span>            :  * On failure sets @error.
<a name="3592"><span class="lineNum">    3592 </span>            :  */</a>
<span class="lineNum">    3593 </span>            : void
<span class="lineNum">    3594 </span>            : mono_field_static_get_value_checked (MonoVTable *vt, MonoClassField *field, void *value, MonoError *error)
<span class="lineNum">    3595 </span>            : {
<span class="lineNum">    3596 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3597 </span>            : 
<span class="lineNum">    3598 </span><span class="lineCov">      17866 :         mono_field_static_get_value_for_thread (mono_thread_internal_current (), vt, field, value, error);</span>
<span class="lineNum">    3599 </span><span class="lineCov">      17866 : }</span>
<span class="lineNum">    3600 </span>            : 
<span class="lineNum">    3601 </span>            : /**
<span class="lineNum">    3602 </span>            :  * mono_property_set_value:
<span class="lineNum">    3603 </span>            :  * @prop: MonoProperty to set
<span class="lineNum">    3604 </span>            :  * @obj: instance object on which to act
<span class="lineNum">    3605 </span>            :  * @params: parameters to pass to the propery
<span class="lineNum">    3606 </span>            :  * @exc: optional exception
<span class="lineNum">    3607 </span>            :  *
<span class="lineNum">    3608 </span>            :  * Invokes the property's set method with the given arguments on the
<span class="lineNum">    3609 </span>            :  * object instance obj (or NULL for static properties). 
<span class="lineNum">    3610 </span>            :  * 
<span class="lineNum">    3611 </span>            :  * You can pass NULL as the exc argument if you don't want to
<span class="lineNum">    3612 </span>            :  * catch exceptions, otherwise, *exc will be set to the exception
<span class="lineNum">    3613 </span>            :  * thrown, if any.  if an exception is thrown, you can't use the
<span class="lineNum">    3614 </span>            :  * MonoObject* result from the function.
<a name="3615"><span class="lineNum">    3615 </span>            :  */</a>
<span class="lineNum">    3616 </span>            : void
<span class="lineNum">    3617 </span>            : mono_property_set_value (MonoProperty *prop, void *obj, void **params, MonoObject **exc)
<span class="lineNum">    3618 </span>            : {
<span class="lineNum">    3619 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3620 </span>            : 
<span class="lineNum">    3621 </span>            :         MonoError error;
<span class="lineNum">    3622 </span><span class="lineNoCov">          0 :         do_runtime_invoke (prop-&gt;set, obj, params, exc, &amp;error);</span>
<span class="lineNum">    3623 </span><span class="lineNoCov">          0 :         if (exc &amp;&amp; *exc == NULL &amp;&amp; !mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    3624 </span><span class="lineNoCov">          0 :                 *exc = (MonoObject*) mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    3625 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    3626 </span><span class="lineNoCov">          0 :                 mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    3627 </span>            :         }
<span class="lineNum">    3628 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3629 </span>            : 
<span class="lineNum">    3630 </span>            : /**
<span class="lineNum">    3631 </span>            :  * mono_property_set_value_checked:
<span class="lineNum">    3632 </span>            :  * @prop: MonoProperty to set
<span class="lineNum">    3633 </span>            :  * @obj: instance object on which to act
<span class="lineNum">    3634 </span>            :  * @params: parameters to pass to the propery
<span class="lineNum">    3635 </span>            :  * @error: set on error
<span class="lineNum">    3636 </span>            :  *
<span class="lineNum">    3637 </span>            :  * Invokes the property's set method with the given arguments on the
<span class="lineNum">    3638 </span>            :  * object instance obj (or NULL for static properties). 
<span class="lineNum">    3639 </span>            :  * 
<span class="lineNum">    3640 </span>            :  * Returns: TRUE on success.  On failure returns FALSE and sets @error.
<span class="lineNum">    3641 </span>            :  * If an exception is thrown, it will be caught and returned via @error.
<a name="3642"><span class="lineNum">    3642 </span>            :  */</a>
<span class="lineNum">    3643 </span>            : gboolean
<span class="lineNum">    3644 </span>            : mono_property_set_value_checked (MonoProperty *prop, void *obj, void **params, MonoError *error)
<span class="lineNum">    3645 </span>            : {
<span class="lineNum">    3646 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3647 </span>            : 
<span class="lineNum">    3648 </span>            :         MonoObject *exc;
<span class="lineNum">    3649 </span>            : 
<span class="lineNum">    3650 </span><span class="lineCov">        249 :         mono_error_init (error);</span>
<span class="lineNum">    3651 </span><span class="lineCov">        249 :         do_runtime_invoke (prop-&gt;set, obj, params, &amp;exc, error);</span>
<span class="lineNum">    3652 </span><span class="lineCov">        249 :         if (exc != NULL &amp;&amp; is_ok (error))</span>
<span class="lineNum">    3653 </span><span class="lineNoCov">          0 :                 mono_error_set_exception_instance (error, (MonoException*)exc);</span>
<span class="lineNum">    3654 </span><span class="lineCov">        249 :         return is_ok (error);</span>
<span class="lineNum">    3655 </span>            : }
<span class="lineNum">    3656 </span>            : 
<span class="lineNum">    3657 </span>            : /**
<span class="lineNum">    3658 </span>            :  * mono_property_get_value:
<span class="lineNum">    3659 </span>            :  * @prop: MonoProperty to fetch
<span class="lineNum">    3660 </span>            :  * @obj: instance object on which to act
<span class="lineNum">    3661 </span>            :  * @params: parameters to pass to the propery
<span class="lineNum">    3662 </span>            :  * @exc: optional exception
<span class="lineNum">    3663 </span>            :  *
<span class="lineNum">    3664 </span>            :  * Invokes the property's get method with the given arguments on the
<span class="lineNum">    3665 </span>            :  * object instance obj (or NULL for static properties). 
<span class="lineNum">    3666 </span>            :  * 
<span class="lineNum">    3667 </span>            :  * You can pass NULL as the exc argument if you don't want to
<span class="lineNum">    3668 </span>            :  * catch exceptions, otherwise, *exc will be set to the exception
<span class="lineNum">    3669 </span>            :  * thrown, if any.  if an exception is thrown, you can't use the
<span class="lineNum">    3670 </span>            :  * MonoObject* result from the function.
<span class="lineNum">    3671 </span>            :  *
<span class="lineNum">    3672 </span>            :  * Returns: the value from invoking the get method on the property.
<a name="3673"><span class="lineNum">    3673 </span>            :  */</a>
<span class="lineNum">    3674 </span>            : MonoObject*
<span class="lineNum">    3675 </span>            : mono_property_get_value (MonoProperty *prop, void *obj, void **params, MonoObject **exc)
<span class="lineNum">    3676 </span>            : {
<span class="lineNum">    3677 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3678 </span>            : 
<span class="lineNum">    3679 </span>            :         MonoError error;
<span class="lineNum">    3680 </span><span class="lineNoCov">          0 :         MonoObject *val = do_runtime_invoke (prop-&gt;get, obj, params, exc, &amp;error);</span>
<span class="lineNum">    3681 </span><span class="lineNoCov">          0 :         if (exc &amp;&amp; *exc == NULL &amp;&amp; !mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    3682 </span><span class="lineNoCov">          0 :                 *exc = (MonoObject*) mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    3683 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    3684 </span><span class="lineNoCov">          0 :                 mono_error_cleanup (&amp;error); /* FIXME don't raise here */</span>
<span class="lineNum">    3685 </span>            :         }
<span class="lineNum">    3686 </span>            : 
<span class="lineNum">    3687 </span><span class="lineNoCov">          0 :         return val;</span>
<span class="lineNum">    3688 </span>            : }
<span class="lineNum">    3689 </span>            : 
<span class="lineNum">    3690 </span>            : /**
<span class="lineNum">    3691 </span>            :  * mono_property_get_value_checked:
<span class="lineNum">    3692 </span>            :  * @prop: MonoProperty to fetch
<span class="lineNum">    3693 </span>            :  * @obj: instance object on which to act
<span class="lineNum">    3694 </span>            :  * @params: parameters to pass to the propery
<span class="lineNum">    3695 </span>            :  * @error: set on error
<span class="lineNum">    3696 </span>            :  *
<span class="lineNum">    3697 </span>            :  * Invokes the property's get method with the given arguments on the
<span class="lineNum">    3698 </span>            :  * object instance obj (or NULL for static properties). 
<span class="lineNum">    3699 </span>            :  * 
<span class="lineNum">    3700 </span>            :  * If an exception is thrown, you can't use the
<span class="lineNum">    3701 </span>            :  * MonoObject* result from the function.  The exception will be propagated via @error.
<span class="lineNum">    3702 </span>            :  *
<span class="lineNum">    3703 </span>            :  * Returns: the value from invoking the get method on the property. On
<span class="lineNum">    3704 </span>            :  * failure returns NULL and sets @error.
<a name="3705"><span class="lineNum">    3705 </span>            :  */</a>
<span class="lineNum">    3706 </span>            : MonoObject*
<span class="lineNum">    3707 </span>            : mono_property_get_value_checked (MonoProperty *prop, void *obj, void **params, MonoError *error)
<span class="lineNum">    3708 </span>            : {
<span class="lineNum">    3709 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3710 </span>            : 
<span class="lineNum">    3711 </span>            :         MonoObject *exc;
<span class="lineNum">    3712 </span><span class="lineNoCov">          0 :         MonoObject *val = do_runtime_invoke (prop-&gt;get, obj, params, &amp;exc, error);</span>
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :         if (exc != NULL &amp;&amp; !is_ok (error))</span>
<span class="lineNum">    3714 </span><span class="lineNoCov">          0 :                 mono_error_set_exception_instance (error, (MonoException*) exc);</span>
<span class="lineNum">    3715 </span><span class="lineNoCov">          0 :         if (!is_ok (error))</span>
<span class="lineNum">    3716 </span><span class="lineNoCov">          0 :                 val = NULL;</span>
<span class="lineNum">    3717 </span><span class="lineNoCov">          0 :         return val;</span>
<span class="lineNum">    3718 </span>            : }
<span class="lineNum">    3719 </span>            : 
<span class="lineNum">    3720 </span>            : 
<span class="lineNum">    3721 </span>            : /*
<span class="lineNum">    3722 </span>            :  * mono_nullable_init:
<span class="lineNum">    3723 </span>            :  * @buf: The nullable structure to initialize.
<span class="lineNum">    3724 </span>            :  * @value: the value to initialize from
<span class="lineNum">    3725 </span>            :  * @klass: the type for the object
<span class="lineNum">    3726 </span>            :  *
<span class="lineNum">    3727 </span>            :  * Initialize the nullable structure pointed to by @buf from @value which
<span class="lineNum">    3728 </span>            :  * should be a boxed value type.   The size of @buf should be able to hold
<span class="lineNum">    3729 </span>            :  * as much data as the @klass-&gt;instance_size (which is the number of bytes
<span class="lineNum">    3730 </span>            :  * that will be copies).
<span class="lineNum">    3731 </span>            :  *
<span class="lineNum">    3732 </span>            :  * Since Nullables have variable structure, we can not define a C
<span class="lineNum">    3733 </span>            :  * structure for them.
<a name="3734"><span class="lineNum">    3734 </span>            :  */</a>
<span class="lineNum">    3735 </span>            : void
<span class="lineNum">    3736 </span>            : mono_nullable_init (guint8 *buf, MonoObject *value, MonoClass *klass)
<span class="lineNum">    3737 </span>            : {
<span class="lineNum">    3738 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3739 </span>            : 
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :         MonoClass *param_class = klass-&gt;cast_class;</span>
<span class="lineNum">    3741 </span>            : 
<span class="lineNum">    3742 </span><span class="lineNoCov">          0 :         mono_class_setup_fields (klass);</span>
<span class="lineNum">    3743 </span><span class="lineNoCov">          0 :         g_assert (klass-&gt;fields_inited);</span>
<span class="lineNum">    3744 </span>            :                                 
<span class="lineNum">    3745 </span><span class="lineNoCov">          0 :         g_assert (mono_class_from_mono_type (klass-&gt;fields [0].type) == param_class);</span>
<span class="lineNum">    3746 </span><span class="lineNoCov">          0 :         g_assert (mono_class_from_mono_type (klass-&gt;fields [1].type) == mono_defaults.boolean_class);</span>
<span class="lineNum">    3747 </span>            : 
<span class="lineNum">    3748 </span><span class="lineNoCov">          0 :         *(guint8*)(buf + klass-&gt;fields [1].offset - sizeof (MonoObject)) = value ? 1 : 0;</span>
<span class="lineNum">    3749 </span><span class="lineNoCov">          0 :         if (value) {</span>
<span class="lineNum">    3750 </span><span class="lineNoCov">          0 :                 if (param_class-&gt;has_references)</span>
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :                         mono_gc_wbarrier_value_copy (buf + klass-&gt;fields [0].offset - sizeof (MonoObject), mono_object_unbox (value), 1, param_class);</span>
<span class="lineNum">    3752 </span>            :                 else
<span class="lineNum">    3753 </span><span class="lineNoCov">          0 :                         mono_gc_memmove_atomic (buf + klass-&gt;fields [0].offset - sizeof (MonoObject), mono_object_unbox (value), mono_class_value_size (param_class, NULL));</span>
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    3755 </span><span class="lineNoCov">          0 :                 mono_gc_bzero_atomic (buf + klass-&gt;fields [0].offset - sizeof (MonoObject), mono_class_value_size (param_class, NULL));</span>
<span class="lineNum">    3756 </span>            :         }
<span class="lineNum">    3757 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3758 </span>            : 
<span class="lineNum">    3759 </span>            : /**
<span class="lineNum">    3760 </span>            :  * mono_nullable_box:
<span class="lineNum">    3761 </span>            :  * @buf: The buffer representing the data to be boxed
<span class="lineNum">    3762 </span>            :  * @klass: the type to box it as.
<span class="lineNum">    3763 </span>            :  * @error: set on oerr
<span class="lineNum">    3764 </span>            :  *
<span class="lineNum">    3765 </span>            :  * Creates a boxed vtype or NULL from the Nullable structure pointed to by
<span class="lineNum">    3766 </span>            :  * @buf.  On failure returns NULL and sets @error
<a name="3767"><span class="lineNum">    3767 </span>            :  */</a>
<span class="lineNum">    3768 </span>            : MonoObject*
<span class="lineNum">    3769 </span>            : mono_nullable_box (guint8 *buf, MonoClass *klass, MonoError *error)
<span class="lineNum">    3770 </span>            : {
<span class="lineNum">    3771 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3772 </span>            : 
<span class="lineNum">    3773 </span><span class="lineCov">          4 :         mono_error_init (error);</span>
<span class="lineNum">    3774 </span><span class="lineCov">          4 :         MonoClass *param_class = klass-&gt;cast_class;</span>
<span class="lineNum">    3775 </span>            : 
<span class="lineNum">    3776 </span><span class="lineCov">          4 :         mono_class_setup_fields (klass);</span>
<span class="lineNum">    3777 </span><span class="lineCov">         12 :         g_assert (klass-&gt;fields_inited);</span>
<span class="lineNum">    3778 </span>            : 
<span class="lineNum">    3779 </span><span class="lineCov">         12 :         g_assert (mono_class_from_mono_type (klass-&gt;fields [0].type) == param_class);</span>
<span class="lineNum">    3780 </span><span class="lineCov">         12 :         g_assert (mono_class_from_mono_type (klass-&gt;fields [1].type) == mono_defaults.boolean_class);</span>
<span class="lineNum">    3781 </span>            : 
<span class="lineNum">    3782 </span><span class="lineCov">          4 :         if (*(guint8*)(buf + klass-&gt;fields [1].offset - sizeof (MonoObject))) {</span>
<span class="lineNum">    3783 </span><span class="lineCov">          2 :                 MonoObject *o = mono_object_new_checked (mono_domain_get (), param_class, error);</span>
<span class="lineNum">    3784 </span><span class="lineCov">          6 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3785 </span><span class="lineCov">          2 :                 if (param_class-&gt;has_references)</span>
<span class="lineNum">    3786 </span><span class="lineNoCov">          0 :                         mono_gc_wbarrier_value_copy (mono_object_unbox (o), buf + klass-&gt;fields [0].offset - sizeof (MonoObject), 1, param_class);</span>
<span class="lineNum">    3787 </span>            :                 else
<span class="lineNum">    3788 </span><span class="lineCov">          2 :                         mono_gc_memmove_atomic (mono_object_unbox (o), buf + klass-&gt;fields [0].offset - sizeof (MonoObject), mono_class_value_size (param_class, NULL));</span>
<span class="lineNum">    3789 </span><span class="lineCov">          2 :                 return o;</span>
<span class="lineNum">    3790 </span>            :         }
<span class="lineNum">    3791 </span>            :         else
<span class="lineNum">    3792 </span><span class="lineCov">          2 :                 return NULL;</span>
<span class="lineNum">    3793 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    3794 </span>            : 
<span class="lineNum">    3795 </span>            : /**
<span class="lineNum">    3796 </span>            :  * mono_get_delegate_invoke:
<span class="lineNum">    3797 </span>            :  * @klass: The delegate class
<span class="lineNum">    3798 </span>            :  *
<span class="lineNum">    3799 </span>            :  * Returns: the MonoMethod for the &quot;Invoke&quot; method in the delegate klass or NULL if @klass is a broken delegate type
<a name="3800"><span class="lineNum">    3800 </span>            :  */</a>
<span class="lineNum">    3801 </span>            : MonoMethod *
<span class="lineNum">    3802 </span>            : mono_get_delegate_invoke (MonoClass *klass)
<span class="lineNum">    3803 </span>            : {
<span class="lineNum">    3804 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3805 </span>            : 
<span class="lineNum">    3806 </span>            :         MonoMethod *im;
<span class="lineNum">    3807 </span>            : 
<span class="lineNum">    3808 </span>            :         /* This is called at runtime, so avoid the slower search in metadata */
<span class="lineNum">    3809 </span><span class="lineCov">     821061 :         mono_class_setup_methods (klass);</span>
<span class="lineNum">    3810 </span><span class="lineCov">     821061 :         if (mono_class_has_failure (klass))</span>
<span class="lineNum">    3811 </span><span class="lineCov">          2 :                 return NULL;</span>
<span class="lineNum">    3812 </span><span class="lineCov">     821059 :         im = mono_class_get_method_from_name (klass, &quot;Invoke&quot;, -1);</span>
<span class="lineNum">    3813 </span><span class="lineCov">     821059 :         return im;</span>
<span class="lineNum">    3814 </span><span class="lineCov">     821068 : }</span>
<span class="lineNum">    3815 </span>            : 
<span class="lineNum">    3816 </span>            : /**
<span class="lineNum">    3817 </span>            :  * mono_get_delegate_begin_invoke:
<span class="lineNum">    3818 </span>            :  * @klass: The delegate class
<span class="lineNum">    3819 </span>            :  *
<span class="lineNum">    3820 </span>            :  * Returns: the MonoMethod for the &quot;BeginInvoke&quot; method in the delegate klass or NULL if @klass is a broken delegate type
<a name="3821"><span class="lineNum">    3821 </span>            :  */</a>
<span class="lineNum">    3822 </span>            : MonoMethod *
<span class="lineNum">    3823 </span>            : mono_get_delegate_begin_invoke (MonoClass *klass)
<span class="lineNum">    3824 </span>            : {
<span class="lineNum">    3825 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3826 </span>            : 
<span class="lineNum">    3827 </span>            :         MonoMethod *im;
<span class="lineNum">    3828 </span>            : 
<span class="lineNum">    3829 </span>            :         /* This is called at runtime, so avoid the slower search in metadata */
<span class="lineNum">    3830 </span><span class="lineNoCov">          0 :         mono_class_setup_methods (klass);</span>
<span class="lineNum">    3831 </span><span class="lineNoCov">          0 :         if (mono_class_has_failure (klass))</span>
<span class="lineNum">    3832 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3833 </span><span class="lineNoCov">          0 :         im = mono_class_get_method_from_name (klass, &quot;BeginInvoke&quot;, -1);</span>
<span class="lineNum">    3834 </span><span class="lineNoCov">          0 :         return im;</span>
<span class="lineNum">    3835 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3836 </span>            : 
<span class="lineNum">    3837 </span>            : /**
<span class="lineNum">    3838 </span>            :  * mono_get_delegate_end_invoke:
<span class="lineNum">    3839 </span>            :  * @klass: The delegate class
<span class="lineNum">    3840 </span>            :  *
<span class="lineNum">    3841 </span>            :  * Returns: the MonoMethod for the &quot;EndInvoke&quot; method in the delegate klass or NULL if @klass is a broken delegate type
<a name="3842"><span class="lineNum">    3842 </span>            :  */</a>
<span class="lineNum">    3843 </span>            : MonoMethod *
<span class="lineNum">    3844 </span>            : mono_get_delegate_end_invoke (MonoClass *klass)
<span class="lineNum">    3845 </span>            : {
<span class="lineNum">    3846 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3847 </span>            : 
<span class="lineNum">    3848 </span>            :         MonoMethod *im;
<span class="lineNum">    3849 </span>            : 
<span class="lineNum">    3850 </span>            :         /* This is called at runtime, so avoid the slower search in metadata */
<span class="lineNum">    3851 </span><span class="lineNoCov">          0 :         mono_class_setup_methods (klass);</span>
<span class="lineNum">    3852 </span><span class="lineNoCov">          0 :         if (mono_class_has_failure (klass))</span>
<span class="lineNum">    3853 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    3854 </span><span class="lineNoCov">          0 :         im = mono_class_get_method_from_name (klass, &quot;EndInvoke&quot;, -1);</span>
<span class="lineNum">    3855 </span><span class="lineNoCov">          0 :         return im;</span>
<span class="lineNum">    3856 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3857 </span>            : 
<span class="lineNum">    3858 </span>            : /**
<span class="lineNum">    3859 </span>            :  * mono_runtime_delegate_invoke:
<span class="lineNum">    3860 </span>            :  * @delegate: pointer to a delegate object.
<span class="lineNum">    3861 </span>            :  * @params: parameters for the delegate.
<span class="lineNum">    3862 </span>            :  * @exc: Pointer to the exception result.
<span class="lineNum">    3863 </span>            :  *
<span class="lineNum">    3864 </span>            :  * Invokes the delegate method @delegate with the parameters provided.
<span class="lineNum">    3865 </span>            :  *
<span class="lineNum">    3866 </span>            :  * You can pass NULL as the exc argument if you don't want to
<span class="lineNum">    3867 </span>            :  * catch exceptions, otherwise, *exc will be set to the exception
<span class="lineNum">    3868 </span>            :  * thrown, if any.  if an exception is thrown, you can't use the
<span class="lineNum">    3869 </span>            :  * MonoObject* result from the function.
<a name="3870"><span class="lineNum">    3870 </span>            :  */</a>
<span class="lineNum">    3871 </span>            : MonoObject*
<span class="lineNum">    3872 </span>            : mono_runtime_delegate_invoke (MonoObject *delegate, void **params, MonoObject **exc)
<span class="lineNum">    3873 </span>            : {
<span class="lineNum">    3874 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3875 </span>            : 
<span class="lineNum">    3876 </span>            :         MonoError error;
<span class="lineNum">    3877 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    3878 </span><span class="lineNoCov">          0 :                 MonoObject *result = mono_runtime_delegate_try_invoke (delegate, params, exc, &amp;error);</span>
<span class="lineNum">    3879 </span><span class="lineNoCov">          0 :                 if (*exc) {</span>
<span class="lineNum">    3880 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    3881 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    3882 </span>            :                 } else {
<span class="lineNum">    3883 </span><span class="lineNoCov">          0 :                         if (!is_ok (&amp;error))</span>
<span class="lineNum">    3884 </span><span class="lineNoCov">          0 :                                 *exc = (MonoObject*)mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    3885 </span><span class="lineNoCov">          0 :                         return result;</span>
<span class="lineNum">    3886 </span>            :                 }
<span class="lineNum">    3887 </span>            :         } else {
<span class="lineNum">    3888 </span><span class="lineNoCov">          0 :                 MonoObject *result = mono_runtime_delegate_invoke_checked (delegate, params, &amp;error);</span>
<span class="lineNum">    3889 </span><span class="lineNoCov">          0 :                 mono_error_raise_exception (&amp;error); /* OK to throw, external only without a good alternative */</span>
<span class="lineNum">    3890 </span><span class="lineNoCov">          0 :                 return result;</span>
<span class="lineNum">    3891 </span>            :         }
<span class="lineNum">    3892 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3893 </span>            : 
<span class="lineNum">    3894 </span>            : /**
<span class="lineNum">    3895 </span>            :  * mono_runtime_delegate_try_invoke:
<span class="lineNum">    3896 </span>            :  * @delegate: pointer to a delegate object.
<span class="lineNum">    3897 </span>            :  * @params: parameters for the delegate.
<span class="lineNum">    3898 </span>            :  * @exc: Pointer to the exception result.
<span class="lineNum">    3899 </span>            :  * @error: set on error
<span class="lineNum">    3900 </span>            :  *
<span class="lineNum">    3901 </span>            :  * Invokes the delegate method @delegate with the parameters provided.
<span class="lineNum">    3902 </span>            :  *
<span class="lineNum">    3903 </span>            :  * You can pass NULL as the exc argument if you don't want to
<span class="lineNum">    3904 </span>            :  * catch exceptions, otherwise, *exc will be set to the exception
<span class="lineNum">    3905 </span>            :  * thrown, if any.  On failure to execute, @error will be set.
<span class="lineNum">    3906 </span>            :  * if an exception is thrown, you can't use the
<span class="lineNum">    3907 </span>            :  * MonoObject* result from the function.
<a name="3908"><span class="lineNum">    3908 </span>            :  */</a>
<span class="lineNum">    3909 </span>            : MonoObject*
<span class="lineNum">    3910 </span>            : mono_runtime_delegate_try_invoke (MonoObject *delegate, void **params, MonoObject **exc, MonoError *error)
<span class="lineNum">    3911 </span>            : {
<span class="lineNum">    3912 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3913 </span>            : 
<span class="lineNum">    3914 </span><span class="lineCov">       3025 :         mono_error_init (error);</span>
<span class="lineNum">    3915 </span>            :         MonoMethod *im;
<span class="lineNum">    3916 </span><span class="lineCov">       3025 :         MonoClass *klass = delegate-&gt;vtable-&gt;klass;</span>
<span class="lineNum">    3917 </span>            :         MonoObject *o;
<span class="lineNum">    3918 </span>            : 
<span class="lineNum">    3919 </span><span class="lineCov">       3025 :         im = mono_get_delegate_invoke (klass);</span>
<span class="lineNum">    3920 </span><span class="lineCov">       3025 :         if (!im)</span>
<span class="lineNum">    3921 </span><span class="lineNoCov">          0 :                 g_error (&quot;Could not lookup delegate invoke method for delegate %s&quot;, mono_type_get_full_name (klass));</span>
<span class="lineNum">    3922 </span>            : 
<span class="lineNum">    3923 </span><span class="lineCov">       3025 :         if (exc) {</span>
<span class="lineNum">    3924 </span><span class="lineCov">         15 :                 o = mono_runtime_try_invoke (im, delegate, params, exc, error);</span>
<span class="lineNum">    3925 </span><span class="lineCov">         15 :         } else {</span>
<span class="lineNum">    3926 </span><span class="lineCov">       3010 :                 o = mono_runtime_invoke_checked (im, delegate, params, error);</span>
<span class="lineNum">    3927 </span>            :         }
<span class="lineNum">    3928 </span>            : 
<span class="lineNum">    3929 </span><span class="lineCov">       2612 :         return o;</span>
<span class="lineNum">    3930 </span>            : }
<span class="lineNum">    3931 </span>            : 
<span class="lineNum">    3932 </span>            : /**
<span class="lineNum">    3933 </span>            :  * mono_runtime_delegate_invoke_checked:
<span class="lineNum">    3934 </span>            :  * @delegate: pointer to a delegate object.
<span class="lineNum">    3935 </span>            :  * @params: parameters for the delegate.
<span class="lineNum">    3936 </span>            :  * @error: set on error
<span class="lineNum">    3937 </span>            :  *
<span class="lineNum">    3938 </span>            :  * Invokes the delegate method @delegate with the parameters provided.
<span class="lineNum">    3939 </span>            :  *
<span class="lineNum">    3940 </span>            :  * On failure @error will be set and you can't use the MonoObject*
<span class="lineNum">    3941 </span>            :  * result from the function.
<a name="3942"><span class="lineNum">    3942 </span>            :  */</a>
<span class="lineNum">    3943 </span>            : MonoObject*
<span class="lineNum">    3944 </span>            : mono_runtime_delegate_invoke_checked (MonoObject *delegate, void **params, MonoError *error)
<span class="lineNum">    3945 </span>            : {
<span class="lineNum">    3946 </span><span class="lineCov">       3010 :         mono_error_init (error);</span>
<span class="lineNum">    3947 </span><span class="lineCov">       3010 :         return mono_runtime_delegate_try_invoke (delegate, params, NULL, error);</span>
<span class="lineNum">    3948 </span>            : }
<span class="lineNum">    3949 </span>            : 
<span class="lineNum">    3950 </span>            : static char **main_args = NULL;
<span class="lineNum">    3951 </span>            : static int num_main_args = 0;
<span class="lineNum">    3952 </span>            : 
<span class="lineNum">    3953 </span>            : /**
<span class="lineNum">    3954 </span>            :  * mono_runtime_get_main_args:
<span class="lineNum">    3955 </span>            :  *
<span class="lineNum">    3956 </span>            :  * Returns: a MonoArray with the arguments passed to the main program
<a name="3957"><span class="lineNum">    3957 </span>            :  */</a>
<span class="lineNum">    3958 </span>            : MonoArray*
<span class="lineNum">    3959 </span>            : mono_runtime_get_main_args (void)
<span class="lineNum">    3960 </span>            : {
<span class="lineNum">    3961 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    3962 </span>            :         MonoError error;
<span class="lineNum">    3963 </span><span class="lineNoCov">          0 :         MonoArray *result = mono_runtime_get_main_args_checked (&amp;error);</span>
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    3965 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    3966 </span>            : }
<span class="lineNum">    3967 </span>            : 
<span class="lineNum">    3968 </span>            : /**
<span class="lineNum">    3969 </span>            :  * mono_runtime_get_main_args:
<span class="lineNum">    3970 </span>            :  * @error: set on error
<span class="lineNum">    3971 </span>            :  *
<span class="lineNum">    3972 </span>            :  * Returns: a MonoArray with the arguments passed to the main
<span class="lineNum">    3973 </span>            :  * program. On failure returns NULL and sets @error.
<a name="3974"><span class="lineNum">    3974 </span>            :  */</a>
<span class="lineNum">    3975 </span>            : MonoArray*
<span class="lineNum">    3976 </span>            : mono_runtime_get_main_args_checked (MonoError *error)
<span class="lineNum">    3977 </span>            : {
<span class="lineNum">    3978 </span>            :         MonoArray *res;
<span class="lineNum">    3979 </span>            :         int i;
<span class="lineNum">    3980 </span><span class="lineNoCov">          0 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    3981 </span>            : 
<span class="lineNum">    3982 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    3983 </span>            : 
<span class="lineNum">    3984 </span><span class="lineNoCov">          0 :         res = (MonoArray*)mono_array_new_checked (domain, mono_defaults.string_class, num_main_args, error);</span>
<span class="lineNum">    3985 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    3986 </span>            : 
<span class="lineNum">    3987 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; num_main_args; ++i)</span>
<span class="lineNum">    3988 </span><span class="lineNoCov">          0 :                 mono_array_setref (res, i, mono_string_new (domain, main_args [i]));</span>
<span class="lineNum">    3989 </span>            : 
<span class="lineNum">    3990 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    3991 </span><span class="lineNoCov">          0 : }</span>
<a name="3992"><span class="lineNum">    3992 </span>            : </a>
<span class="lineNum">    3993 </span>            : static void
<span class="lineNum">    3994 </span>            : free_main_args (void)
<span class="lineNum">    3995 </span>            : {
<span class="lineNum">    3996 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    3997 </span>            : 
<span class="lineNum">    3998 </span>            :         int i;
<span class="lineNum">    3999 </span>            : 
<span class="lineNum">    4000 </span><span class="lineCov">      67306 :         for (i = 0; i &lt; num_main_args; ++i)</span>
<span class="lineNum">    4001 </span><span class="lineCov">      30381 :                 g_free (main_args [i]);</span>
<span class="lineNum">    4002 </span><span class="lineCov">       3272 :         g_free (main_args);</span>
<span class="lineNum">    4003 </span><span class="lineCov">       3272 :         num_main_args = 0;</span>
<span class="lineNum">    4004 </span><span class="lineCov">       3272 :         main_args = NULL;</span>
<span class="lineNum">    4005 </span><span class="lineCov">       3272 : }</span>
<span class="lineNum">    4006 </span>            : 
<span class="lineNum">    4007 </span>            : /**
<span class="lineNum">    4008 </span>            :  * mono_runtime_set_main_args:
<span class="lineNum">    4009 </span>            :  * @argc: number of arguments from the command line
<span class="lineNum">    4010 </span>            :  * @argv: array of strings from the command line
<span class="lineNum">    4011 </span>            :  *
<span class="lineNum">    4012 </span>            :  * Set the command line arguments from an embedding application that doesn't otherwise call
<span class="lineNum">    4013 </span>            :  * mono_runtime_run_main ().
<a name="4014"><span class="lineNum">    4014 </span>            :  */</a>
<span class="lineNum">    4015 </span>            : int
<span class="lineNum">    4016 </span>            : mono_runtime_set_main_args (int argc, char* argv[])
<span class="lineNum">    4017 </span>            : {
<span class="lineNum">    4018 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    4019 </span>            : 
<span class="lineNum">    4020 </span>            :         int i;
<span class="lineNum">    4021 </span>            : 
<span class="lineNum">    4022 </span><span class="lineNoCov">          0 :         free_main_args ();</span>
<span class="lineNum">    4023 </span><span class="lineNoCov">          0 :         main_args = g_new0 (char*, argc);</span>
<span class="lineNum">    4024 </span><span class="lineNoCov">          0 :         num_main_args = argc;</span>
<span class="lineNum">    4025 </span>            : 
<span class="lineNum">    4026 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; argc; ++i) {</span>
<span class="lineNum">    4027 </span>            :                 gchar *utf8_arg;
<span class="lineNum">    4028 </span>            : 
<span class="lineNum">    4029 </span><span class="lineNoCov">          0 :                 utf8_arg = mono_utf8_from_external (argv[i]);</span>
<span class="lineNum">    4030 </span><span class="lineNoCov">          0 :                 if (utf8_arg == NULL) {</span>
<span class="lineNum">    4031 </span><span class="lineNoCov">          0 :                         g_print (&quot;\nCannot determine the text encoding for argument %d (%s).\n&quot;, i, argv [i]);</span>
<span class="lineNum">    4032 </span><span class="lineNoCov">          0 :                         g_print (&quot;Please add the correct encoding to MONO_EXTERNAL_ENCODINGS and try again.\n&quot;);</span>
<span class="lineNum">    4033 </span><span class="lineNoCov">          0 :                         exit (-1);</span>
<span class="lineNum">    4034 </span>            :                 }
<span class="lineNum">    4035 </span>            : 
<span class="lineNum">    4036 </span><span class="lineNoCov">          0 :                 main_args [i] = utf8_arg;</span>
<span class="lineNum">    4037 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4038 </span>            : 
<span class="lineNum">    4039 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">    4040 </span>            : }
<span class="lineNum">    4041 </span>            : 
<span class="lineNum">    4042 </span>            : /*
<span class="lineNum">    4043 </span>            :  * Prepare an array of arguments in order to execute a standard Main()
<span class="lineNum">    4044 </span>            :  * method (argc/argv contains the executable name). This method also
<span class="lineNum">    4045 </span>            :  * sets the command line argument value needed by System.Environment.
<span class="lineNum">    4046 </span>            :  * 
<a name="4047"><span class="lineNum">    4047 </span>            :  */</a>
<span class="lineNum">    4048 </span>            : static MonoArray*
<span class="lineNum">    4049 </span>            : prepare_run_main (MonoMethod *method, int argc, char *argv[])
<span class="lineNum">    4050 </span>            : {
<span class="lineNum">    4051 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4052 </span>            : 
<span class="lineNum">    4053 </span>            :         MonoError error;
<span class="lineNum">    4054 </span>            :         int i;
<span class="lineNum">    4055 </span><span class="lineCov">       3274 :         MonoArray *args = NULL;</span>
<span class="lineNum">    4056 </span><span class="lineCov">       3274 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    4057 </span>            :         gchar *utf8_fullpath;
<span class="lineNum">    4058 </span>            :         MonoMethodSignature *sig;
<span class="lineNum">    4059 </span>            : 
<span class="lineNum">    4060 </span><span class="lineCov">       9822 :         g_assert (method != NULL);</span>
<span class="lineNum">    4061 </span>            :         
<span class="lineNum">    4062 </span><span class="lineCov">       3274 :         mono_thread_set_main (mono_thread_current ());</span>
<span class="lineNum">    4063 </span>            : 
<span class="lineNum">    4064 </span><span class="lineCov">       3274 :         main_args = g_new0 (char*, argc);</span>
<span class="lineNum">    4065 </span><span class="lineCov">       3274 :         num_main_args = argc;</span>
<span class="lineNum">    4066 </span>            : 
<span class="lineNum">    4067 </span><span class="lineCov">       3274 :         if (!g_path_is_absolute (argv [0])) {</span>
<span class="lineNum">    4068 </span><span class="lineCov">       1952 :                 gchar *basename = g_path_get_basename (argv [0]);</span>
<span class="lineNum">    4069 </span><span class="lineCov">       1952 :                 gchar *fullpath = g_build_filename (method-&gt;klass-&gt;image-&gt;assembly-&gt;basedir,</span>
<span class="lineNum">    4070 </span>            :                                                     basename,
<span class="lineNum">    4071 </span>            :                                                     NULL);
<span class="lineNum">    4072 </span>            : 
<span class="lineNum">    4073 </span><span class="lineCov">       1952 :                 utf8_fullpath = mono_utf8_from_external (fullpath);</span>
<span class="lineNum">    4074 </span><span class="lineCov">       1952 :                 if(utf8_fullpath == NULL) {</span>
<span class="lineNum">    4075 </span>            :                         /* Printing the arg text will cause glib to
<span class="lineNum">    4076 </span>            :                          * whinge about &quot;Invalid UTF-8&quot;, but at least
<span class="lineNum">    4077 </span>            :                          * its relevant, and shows the problem text
<span class="lineNum">    4078 </span>            :                          * string.
<span class="lineNum">    4079 </span>            :                          */
<span class="lineNum">    4080 </span><span class="lineNoCov">          0 :                         g_print (&quot;\nCannot determine the text encoding for the assembly location: %s\n&quot;, fullpath);</span>
<span class="lineNum">    4081 </span><span class="lineNoCov">          0 :                         g_print (&quot;Please add the correct encoding to MONO_EXTERNAL_ENCODINGS and try again.\n&quot;);</span>
<span class="lineNum">    4082 </span><span class="lineNoCov">          0 :                         exit (-1);</span>
<span class="lineNum">    4083 </span>            :                 }
<span class="lineNum">    4084 </span>            : 
<span class="lineNum">    4085 </span><span class="lineCov">       1952 :                 g_free (fullpath);</span>
<span class="lineNum">    4086 </span><span class="lineCov">       1952 :                 g_free (basename);</span>
<span class="lineNum">    4087 </span><span class="lineCov">       1952 :         } else {</span>
<span class="lineNum">    4088 </span><span class="lineCov">       1322 :                 utf8_fullpath = mono_utf8_from_external (argv[0]);</span>
<span class="lineNum">    4089 </span><span class="lineCov">       1322 :                 if(utf8_fullpath == NULL) {</span>
<span class="lineNum">    4090 </span><span class="lineNoCov">          0 :                         g_print (&quot;\nCannot determine the text encoding for the assembly location: %s\n&quot;, argv[0]);</span>
<span class="lineNum">    4091 </span><span class="lineNoCov">          0 :                         g_print (&quot;Please add the correct encoding to MONO_EXTERNAL_ENCODINGS and try again.\n&quot;);</span>
<span class="lineNum">    4092 </span><span class="lineNoCov">          0 :                         exit (-1);</span>
<span class="lineNum">    4093 </span>            :                 }
<span class="lineNum">    4094 </span>            :         }
<span class="lineNum">    4095 </span>            : 
<span class="lineNum">    4096 </span><span class="lineCov">       3274 :         main_args [0] = utf8_fullpath;</span>
<span class="lineNum">    4097 </span>            : 
<span class="lineNum">    4098 </span><span class="lineCov">      60788 :         for (i = 1; i &lt; argc; ++i) {</span>
<span class="lineNum">    4099 </span>            :                 gchar *utf8_arg;
<span class="lineNum">    4100 </span>            : 
<span class="lineNum">    4101 </span><span class="lineCov">      27120 :                 utf8_arg=mono_utf8_from_external (argv[i]);</span>
<span class="lineNum">    4102 </span><span class="lineCov">      27120 :                 if(utf8_arg==NULL) {</span>
<span class="lineNum">    4103 </span>            :                         /* Ditto the comment about Invalid UTF-8 here */
<span class="lineNum">    4104 </span><span class="lineNoCov">          0 :                         g_print (&quot;\nCannot determine the text encoding for argument %d (%s).\n&quot;, i, argv[i]);</span>
<span class="lineNum">    4105 </span><span class="lineNoCov">          0 :                         g_print (&quot;Please add the correct encoding to MONO_EXTERNAL_ENCODINGS and try again.\n&quot;);</span>
<span class="lineNum">    4106 </span><span class="lineNoCov">          0 :                         exit (-1);</span>
<span class="lineNum">    4107 </span>            :                 }
<span class="lineNum">    4108 </span>            : 
<span class="lineNum">    4109 </span><span class="lineCov">      27120 :                 main_args [i] = utf8_arg;</span>
<span class="lineNum">    4110 </span><span class="lineCov">      27120 :         }</span>
<span class="lineNum">    4111 </span><span class="lineCov">       3274 :         argc--;</span>
<span class="lineNum">    4112 </span><span class="lineCov">       3274 :         argv++;</span>
<span class="lineNum">    4113 </span>            : 
<span class="lineNum">    4114 </span><span class="lineCov">       3274 :         sig = mono_method_signature (method);</span>
<span class="lineNum">    4115 </span><span class="lineCov">       3274 :         if (!sig) {</span>
<span class="lineNum">    4116 </span><span class="lineNoCov">          0 :                 g_print (&quot;Unable to load Main method.\n&quot;);</span>
<span class="lineNum">    4117 </span><span class="lineNoCov">          0 :                 exit (-1);</span>
<span class="lineNum">    4118 </span>            :         }
<span class="lineNum">    4119 </span>            : 
<span class="lineNum">    4120 </span><span class="lineCov">       3274 :         if (sig-&gt;param_count) {</span>
<span class="lineNum">    4121 </span><span class="lineCov">       2128 :                 args = (MonoArray*)mono_array_new_checked (domain, mono_defaults.string_class, argc, &amp;error);</span>
<span class="lineNum">    4122 </span><span class="lineCov">       2128 :                 mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    4123 </span><span class="lineCov">      58496 :                 for (i = 0; i &lt; argc; ++i) {</span>
<span class="lineNum">    4124 </span>            :                         /* The encodings should all work, given that
<span class="lineNum">    4125 </span>            :                          * we've checked all these args for the
<span class="lineNum">    4126 </span>            :                          * main_args array.
<span class="lineNum">    4127 </span>            :                          */
<span class="lineNum">    4128 </span><span class="lineCov">      27120 :                         gchar *str = mono_utf8_from_external (argv [i]);</span>
<span class="lineNum">    4129 </span><span class="lineCov">      27120 :                         MonoString *arg = mono_string_new (domain, str);</span>
<span class="lineNum">    4130 </span><span class="lineCov">      54240 :                         mono_array_setref (args, i, arg);</span>
<span class="lineNum">    4131 </span><span class="lineCov">      27120 :                         g_free (str);</span>
<span class="lineNum">    4132 </span><span class="lineCov">      27120 :                 }</span>
<span class="lineNum">    4133 </span><span class="lineCov">       2128 :         } else {</span>
<span class="lineNum">    4134 </span><span class="lineCov">       1146 :                 args = (MonoArray*)mono_array_new_checked (domain, mono_defaults.string_class, 0, &amp;error);</span>
<span class="lineNum">    4135 </span><span class="lineCov">       1146 :                 mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    4136 </span>            :         }
<span class="lineNum">    4137 </span>            :         
<span class="lineNum">    4138 </span><span class="lineCov">       3274 :         mono_assembly_set_main (method-&gt;klass-&gt;image-&gt;assembly);</span>
<span class="lineNum">    4139 </span>            : 
<span class="lineNum">    4140 </span><span class="lineCov">       3274 :         return args;</span>
<span class="lineNum">    4141 </span>            : }
<span class="lineNum">    4142 </span>            : 
<span class="lineNum">    4143 </span>            : /**
<span class="lineNum">    4144 </span>            :  * mono_runtime_run_main:
<span class="lineNum">    4145 </span>            :  * @method: the method to start the application with (usually Main)
<span class="lineNum">    4146 </span>            :  * @argc: number of arguments from the command line
<span class="lineNum">    4147 </span>            :  * @argv: array of strings from the command line
<span class="lineNum">    4148 </span>            :  * @exc: excetption results
<span class="lineNum">    4149 </span>            :  *
<span class="lineNum">    4150 </span>            :  * Execute a standard Main() method (argc/argv contains the
<span class="lineNum">    4151 </span>            :  * executable name). This method also sets the command line argument value
<span class="lineNum">    4152 </span>            :  * needed by System.Environment.
<span class="lineNum">    4153 </span>            :  *
<span class="lineNum">    4154 </span>            :  * 
<a name="4155"><span class="lineNum">    4155 </span>            :  */</a>
<span class="lineNum">    4156 </span>            : int
<span class="lineNum">    4157 </span>            : mono_runtime_run_main (MonoMethod *method, int argc, char* argv[],
<span class="lineNum">    4158 </span>            :                        MonoObject **exc)
<span class="lineNum">    4159 </span>            : {
<span class="lineNum">    4160 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4161 </span>            : 
<span class="lineNum">    4162 </span>            :         MonoError error;
<span class="lineNum">    4163 </span><span class="lineNoCov">          0 :         MonoArray *args = prepare_run_main (method, argc, argv);</span>
<span class="lineNum">    4164 </span>            :         int res;
<span class="lineNum">    4165 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    4166 </span><span class="lineNoCov">          0 :                 res = mono_runtime_try_exec_main (method, args, exc);</span>
<span class="lineNum">    4167 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    4168 </span><span class="lineNoCov">          0 :                 res = mono_runtime_exec_main_checked (method, args, &amp;error);</span>
<span class="lineNum">    4169 </span><span class="lineNoCov">          0 :                 mono_error_raise_exception (&amp;error); /* OK to throw, external only without a better alternative */</span>
<span class="lineNum">    4170 </span>            :         }
<span class="lineNum">    4171 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    4172 </span>            : }
<span class="lineNum">    4173 </span>            : 
<span class="lineNum">    4174 </span>            : /**
<span class="lineNum">    4175 </span>            :  * mono_runtime_run_main_checked:
<span class="lineNum">    4176 </span>            :  * @method: the method to start the application with (usually Main)
<span class="lineNum">    4177 </span>            :  * @argc: number of arguments from the command line
<span class="lineNum">    4178 </span>            :  * @argv: array of strings from the command line
<span class="lineNum">    4179 </span>            :  * @error: set on error
<span class="lineNum">    4180 </span>            :  *
<span class="lineNum">    4181 </span>            :  * Execute a standard Main() method (argc/argv contains the
<span class="lineNum">    4182 </span>            :  * executable name). This method also sets the command line argument value
<span class="lineNum">    4183 </span>            :  * needed by System.Environment.  On failure sets @error.
<span class="lineNum">    4184 </span>            :  *
<span class="lineNum">    4185 </span>            :  * 
<a name="4186"><span class="lineNum">    4186 </span>            :  */</a>
<span class="lineNum">    4187 </span>            : int
<span class="lineNum">    4188 </span>            : mono_runtime_run_main_checked (MonoMethod *method, int argc, char* argv[],
<span class="lineNum">    4189 </span>            :                                MonoError *error)
<span class="lineNum">    4190 </span>            : {
<span class="lineNum">    4191 </span><span class="lineCov">       3274 :         mono_error_init (error);</span>
<span class="lineNum">    4192 </span><span class="lineCov">       3274 :         MonoArray *args = prepare_run_main (method, argc, argv);</span>
<span class="lineNum">    4193 </span><span class="lineCov">       3274 :         return mono_runtime_exec_main_checked (method, args, error);</span>
<span class="lineNum">    4194 </span>            : }
<span class="lineNum">    4195 </span>            : 
<span class="lineNum">    4196 </span>            : /**
<span class="lineNum">    4197 </span>            :  * mono_runtime_try_run_main:
<span class="lineNum">    4198 </span>            :  * @method: the method to start the application with (usually Main)
<span class="lineNum">    4199 </span>            :  * @argc: number of arguments from the command line
<span class="lineNum">    4200 </span>            :  * @argv: array of strings from the command line
<span class="lineNum">    4201 </span>            :  * @exc: set if Main throws an exception
<span class="lineNum">    4202 </span>            :  * @error: set if Main can't be executed
<span class="lineNum">    4203 </span>            :  *
<span class="lineNum">    4204 </span>            :  * Execute a standard Main() method (argc/argv contains the executable
<span class="lineNum">    4205 </span>            :  * name). This method also sets the command line argument value needed
<span class="lineNum">    4206 </span>            :  * by System.Environment.  On failure sets @error if Main can't be
<span class="lineNum">    4207 </span>            :  * executed or @exc if it threw and exception.
<span class="lineNum">    4208 </span>            :  *
<span class="lineNum">    4209 </span>            :  * 
<a name="4210"><span class="lineNum">    4210 </span>            :  */</a>
<span class="lineNum">    4211 </span>            : int
<span class="lineNum">    4212 </span>            : mono_runtime_try_run_main (MonoMethod *method, int argc, char* argv[],
<span class="lineNum">    4213 </span>            :                            MonoObject **exc)
<span class="lineNum">    4214 </span>            : {
<span class="lineNum">    4215 </span><span class="lineNoCov">          0 :         g_assert (exc);</span>
<span class="lineNum">    4216 </span><span class="lineNoCov">          0 :         MonoArray *args = prepare_run_main (method, argc, argv);</span>
<span class="lineNum">    4217 </span><span class="lineNoCov">          0 :         return mono_runtime_try_exec_main (method, args, exc);</span>
<span class="lineNum">    4218 </span>            : }
<span class="lineNum">    4219 </span>            : 
<a name="4220"><span class="lineNum">    4220 </span>            : </a>
<span class="lineNum">    4221 </span>            : static MonoObject*
<span class="lineNum">    4222 </span>            : serialize_object (MonoObject *obj, gboolean *failure, MonoObject **exc)
<span class="lineNum">    4223 </span>            : {
<span class="lineNum">    4224 </span>            :         static MonoMethod *serialize_method;
<span class="lineNum">    4225 </span>            : 
<span class="lineNum">    4226 </span>            :         MonoError error;
<span class="lineNum">    4227 </span>            :         void *params [1];
<span class="lineNum">    4228 </span>            :         MonoObject *array;
<span class="lineNum">    4229 </span>            : 
<span class="lineNum">    4230 </span><span class="lineCov">          1 :         if (!serialize_method) {</span>
<span class="lineNum">    4231 </span><span class="lineCov">          1 :                 MonoClass *klass = mono_class_get_remoting_services_class ();</span>
<span class="lineNum">    4232 </span><span class="lineCov">          1 :                 serialize_method = mono_class_get_method_from_name (klass, &quot;SerializeCallData&quot;, -1);</span>
<span class="lineNum">    4233 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">    4234 </span>            : 
<span class="lineNum">    4235 </span><span class="lineCov">          1 :         if (!serialize_method) {</span>
<span class="lineNum">    4236 </span><span class="lineNoCov">          0 :                 *failure = TRUE;</span>
<span class="lineNum">    4237 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    4238 </span>            :         }
<span class="lineNum">    4239 </span>            : 
<span class="lineNum">    4240 </span><span class="lineCov">          3 :         g_assert (!mono_class_is_marshalbyref (mono_object_class (obj)));</span>
<span class="lineNum">    4241 </span>            : 
<span class="lineNum">    4242 </span><span class="lineCov">          1 :         params [0] = obj;</span>
<span class="lineNum">    4243 </span><span class="lineCov">          1 :         *exc = NULL;</span>
<span class="lineNum">    4244 </span>            : 
<span class="lineNum">    4245 </span><span class="lineCov">          1 :         array = mono_runtime_try_invoke (serialize_method, NULL, params, exc, &amp;error);</span>
<span class="lineNum">    4246 </span><span class="lineCov">          2 :         if (*exc == NULL &amp;&amp; !mono_error_ok (&amp;error))</span>
<span class="lineNum">    4247 </span><span class="lineNoCov">          0 :                 *exc = (MonoObject*) mono_error_convert_to_exception (&amp;error); /* FIXME convert serialize_object to MonoError */</span>
<span class="lineNum">    4248 </span>            :         else
<span class="lineNum">    4249 </span><span class="lineCov">          1 :                 mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    4250 </span>            : 
<span class="lineNum">    4251 </span><span class="lineCov">          1 :         if (*exc)</span>
<span class="lineNum">    4252 </span><span class="lineNoCov">          0 :                 *failure = TRUE;</span>
<span class="lineNum">    4253 </span>            : 
<span class="lineNum">    4254 </span><span class="lineCov">          1 :         return array;</span>
<span class="lineNum">    4255 </span><span class="lineCov">          1 : }</span>
<a name="4256"><span class="lineNum">    4256 </span>            : </a>
<span class="lineNum">    4257 </span>            : static MonoObject*
<span class="lineNum">    4258 </span>            : deserialize_object (MonoObject *obj, gboolean *failure, MonoObject **exc)
<span class="lineNum">    4259 </span>            : {
<span class="lineNum">    4260 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4261 </span>            : 
<span class="lineNum">    4262 </span>            :         static MonoMethod *deserialize_method;
<span class="lineNum">    4263 </span>            : 
<span class="lineNum">    4264 </span>            :         MonoError error;
<span class="lineNum">    4265 </span>            :         void *params [1];
<span class="lineNum">    4266 </span>            :         MonoObject *result;
<span class="lineNum">    4267 </span>            : 
<span class="lineNum">    4268 </span><span class="lineCov">          1 :         if (!deserialize_method) {</span>
<span class="lineNum">    4269 </span><span class="lineCov">          1 :                 MonoClass *klass = mono_class_get_remoting_services_class ();</span>
<span class="lineNum">    4270 </span><span class="lineCov">          1 :                 deserialize_method = mono_class_get_method_from_name (klass, &quot;DeserializeCallData&quot;, -1);</span>
<span class="lineNum">    4271 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">    4272 </span><span class="lineCov">          1 :         if (!deserialize_method) {</span>
<span class="lineNum">    4273 </span><span class="lineNoCov">          0 :                 *failure = TRUE;</span>
<span class="lineNum">    4274 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    4275 </span>            :         }
<span class="lineNum">    4276 </span>            : 
<span class="lineNum">    4277 </span><span class="lineCov">          1 :         params [0] = obj;</span>
<span class="lineNum">    4278 </span><span class="lineCov">          1 :         *exc = NULL;</span>
<span class="lineNum">    4279 </span>            : 
<span class="lineNum">    4280 </span><span class="lineCov">          1 :         result = mono_runtime_try_invoke (deserialize_method, NULL, params, exc, &amp;error);</span>
<span class="lineNum">    4281 </span><span class="lineCov">          2 :         if (*exc == NULL &amp;&amp; !mono_error_ok (&amp;error))</span>
<span class="lineNum">    4282 </span><span class="lineNoCov">          0 :                 *exc = (MonoObject*) mono_error_convert_to_exception (&amp;error); /* FIXME convert deserialize_object to MonoError */</span>
<span class="lineNum">    4283 </span>            :         else
<span class="lineNum">    4284 </span><span class="lineCov">          1 :                 mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    4285 </span>            : 
<span class="lineNum">    4286 </span><span class="lineCov">          1 :         if (*exc)</span>
<span class="lineNum">    4287 </span><span class="lineNoCov">          0 :                 *failure = TRUE;</span>
<span class="lineNum">    4288 </span>            : 
<span class="lineNum">    4289 </span><span class="lineCov">          1 :         return result;</span>
<span class="lineNum">    4290 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    4291 </span>            : 
<a name="4292"><span class="lineNum">    4292 </span>            : #ifndef DISABLE_REMOTING</a>
<span class="lineNum">    4293 </span>            : static MonoObject*
<span class="lineNum">    4294 </span>            : make_transparent_proxy (MonoObject *obj, MonoError *error)
<span class="lineNum">    4295 </span>            : {
<span class="lineNum">    4296 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4297 </span>            : 
<span class="lineNum">    4298 </span>            :         static MonoMethod *get_proxy_method;
<span class="lineNum">    4299 </span>            : 
<span class="lineNum">    4300 </span><span class="lineNoCov">          0 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    4301 </span>            :         MonoRealProxy *real_proxy;
<span class="lineNum">    4302 </span>            :         MonoReflectionType *reflection_type;
<span class="lineNum">    4303 </span>            :         MonoTransparentProxy *transparent_proxy;
<span class="lineNum">    4304 </span>            : 
<span class="lineNum">    4305 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    4306 </span>            : 
<span class="lineNum">    4307 </span><span class="lineNoCov">          0 :         if (!get_proxy_method)</span>
<span class="lineNum">    4308 </span><span class="lineNoCov">          0 :                 get_proxy_method = mono_class_get_method_from_name (mono_defaults.real_proxy_class, &quot;GetTransparentProxy&quot;, 0);</span>
<span class="lineNum">    4309 </span>            : 
<span class="lineNum">    4310 </span><span class="lineNoCov">          0 :         g_assert (mono_class_is_marshalbyref (obj-&gt;vtable-&gt;klass));</span>
<span class="lineNum">    4311 </span>            : 
<span class="lineNum">    4312 </span><span class="lineNoCov">          0 :         real_proxy = (MonoRealProxy*) mono_object_new_checked (domain, mono_defaults.real_proxy_class, error);</span>
<span class="lineNum">    4313 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    4314 </span><span class="lineNoCov">          0 :         reflection_type = mono_type_get_object_checked (domain, &amp;obj-&gt;vtable-&gt;klass-&gt;byval_arg, error);</span>
<span class="lineNum">    4315 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    4316 </span>            : 
<span class="lineNum">    4317 </span><span class="lineNoCov">          0 :         MONO_OBJECT_SETREF (real_proxy, class_to_proxy, reflection_type);</span>
<span class="lineNum">    4318 </span><span class="lineNoCov">          0 :         MONO_OBJECT_SETREF (real_proxy, unwrapped_server, obj);</span>
<span class="lineNum">    4319 </span>            : 
<span class="lineNum">    4320 </span><span class="lineNoCov">          0 :         MonoObject *exc = NULL;</span>
<span class="lineNum">    4321 </span>            : 
<span class="lineNum">    4322 </span><span class="lineNoCov">          0 :         transparent_proxy = (MonoTransparentProxy*) mono_runtime_try_invoke (get_proxy_method, real_proxy, NULL, &amp;exc, error);</span>
<span class="lineNum">    4323 </span><span class="lineNoCov">          0 :         if (exc != NULL &amp;&amp; is_ok (error))</span>
<span class="lineNum">    4324 </span><span class="lineNoCov">          0 :                 mono_error_set_exception_instance (error, (MonoException*)exc);</span>
<span class="lineNum">    4325 </span>            : 
<span class="lineNum">    4326 </span><span class="lineNoCov">          0 :         return (MonoObject*) transparent_proxy;</span>
<span class="lineNum">    4327 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4328 </span>            : #endif /* DISABLE_REMOTING */
<span class="lineNum">    4329 </span>            : 
<span class="lineNum">    4330 </span>            : /**
<span class="lineNum">    4331 </span>            :  * mono_object_xdomain_representation
<span class="lineNum">    4332 </span>            :  * @obj: an object
<span class="lineNum">    4333 </span>            :  * @target_domain: a domain
<span class="lineNum">    4334 </span>            :  * @error: set on error.
<span class="lineNum">    4335 </span>            :  *
<span class="lineNum">    4336 </span>            :  * Creates a representation of obj in the domain target_domain.  This
<span class="lineNum">    4337 </span>            :  * is either a copy of obj arrived through via serialization and
<span class="lineNum">    4338 </span>            :  * deserialization or a proxy, depending on whether the object is
<span class="lineNum">    4339 </span>            :  * serializable or marshal by ref.  obj must not be in target_domain.
<span class="lineNum">    4340 </span>            :  *
<span class="lineNum">    4341 </span>            :  * If the object cannot be represented in target_domain, NULL is
<span class="lineNum">    4342 </span>            :  * returned and @error is set appropriately.
<a name="4343"><span class="lineNum">    4343 </span>            :  */</a>
<span class="lineNum">    4344 </span>            : MonoObject*
<span class="lineNum">    4345 </span>            : mono_object_xdomain_representation (MonoObject *obj, MonoDomain *target_domain, MonoError *error)
<span class="lineNum">    4346 </span>            : {
<span class="lineNum">    4347 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4348 </span>            : 
<span class="lineNum">    4349 </span><span class="lineCov">          1 :         mono_error_init (error);</span>
<span class="lineNum">    4350 </span><span class="lineCov">          1 :         MonoObject *deserialized = NULL;</span>
<span class="lineNum">    4351 </span>            : 
<span class="lineNum">    4352 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    4353 </span><span class="lineCov">          1 :         if (mono_class_is_marshalbyref (mono_object_class (obj))) {</span>
<span class="lineNum">    4354 </span><span class="lineNoCov">          0 :                 deserialized = make_transparent_proxy (obj, error);</span>
<span class="lineNum">    4355 </span><span class="lineNoCov">          0 :         } </span>
<span class="lineNum">    4356 </span>            :         else
<span class="lineNum">    4357 </span>            : #endif
<span class="lineNum">    4358 </span>            :         {
<span class="lineNum">    4359 </span><span class="lineCov">          1 :                 gboolean failure = FALSE;</span>
<span class="lineNum">    4360 </span><span class="lineCov">          1 :                 MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    4361 </span>            :                 MonoObject *serialized;
<span class="lineNum">    4362 </span><span class="lineCov">          1 :                 MonoObject *exc = NULL;</span>
<span class="lineNum">    4363 </span>            : 
<span class="lineNum">    4364 </span><span class="lineCov">          1 :                 mono_domain_set_internal_with_options (mono_object_domain (obj), FALSE);</span>
<span class="lineNum">    4365 </span><span class="lineCov">          1 :                 serialized = serialize_object (obj, &amp;failure, &amp;exc);</span>
<span class="lineNum">    4366 </span><span class="lineCov">          1 :                 mono_domain_set_internal_with_options (target_domain, FALSE);</span>
<span class="lineNum">    4367 </span><span class="lineCov">          1 :                 if (!failure)</span>
<span class="lineNum">    4368 </span><span class="lineCov">          1 :                         deserialized = deserialize_object (serialized, &amp;failure, &amp;exc);</span>
<span class="lineNum">    4369 </span><span class="lineCov">          1 :                 if (domain != target_domain)</span>
<span class="lineNum">    4370 </span><span class="lineNoCov">          0 :                         mono_domain_set_internal_with_options (domain, FALSE);</span>
<span class="lineNum">    4371 </span><span class="lineCov">          1 :                 if (failure)</span>
<span class="lineNum">    4372 </span><span class="lineNoCov">          0 :                         mono_error_set_exception_instance (error, (MonoException*)exc);</span>
<span class="lineNum">    4373 </span>            :         }
<span class="lineNum">    4374 </span>            : 
<span class="lineNum">    4375 </span><span class="lineCov">          1 :         return deserialized;</span>
<span class="lineNum">    4376 </span>            : }
<span class="lineNum">    4377 </span>            : 
<a name="4378"><span class="lineNum">    4378 </span>            : /* Used in call_unhandled_exception_delegate */</a>
<span class="lineNum">    4379 </span>            : static MonoObject *
<span class="lineNum">    4380 </span>            : create_unhandled_exception_eventargs (MonoObject *exc, MonoError *error)
<span class="lineNum">    4381 </span>            : {
<span class="lineNum">    4382 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4383 </span>            : 
<span class="lineNum">    4384 </span><span class="lineCov">         15 :         mono_error_init (error);</span>
<span class="lineNum">    4385 </span>            :         MonoClass *klass;
<span class="lineNum">    4386 </span>            :         gpointer args [2];
<span class="lineNum">    4387 </span><span class="lineCov">         15 :         MonoMethod *method = NULL;</span>
<span class="lineNum">    4388 </span><span class="lineCov">         15 :         MonoBoolean is_terminating = TRUE;</span>
<span class="lineNum">    4389 </span>            :         MonoObject *obj;
<span class="lineNum">    4390 </span>            : 
<span class="lineNum">    4391 </span><span class="lineCov">         15 :         klass = mono_class_get_unhandled_exception_event_args_class ();</span>
<span class="lineNum">    4392 </span><span class="lineCov">         15 :         mono_class_init (klass);</span>
<span class="lineNum">    4393 </span>            : 
<span class="lineNum">    4394 </span>            :         /* UnhandledExceptionEventArgs only has 1 public ctor with 2 args */
<span class="lineNum">    4395 </span><span class="lineCov">         15 :         method = mono_class_get_method_from_name_flags (klass, &quot;.ctor&quot;, 2, METHOD_ATTRIBUTE_PUBLIC);</span>
<span class="lineNum">    4396 </span><span class="lineCov">         45 :         g_assert (method);</span>
<span class="lineNum">    4397 </span>            : 
<span class="lineNum">    4398 </span><span class="lineCov">         15 :         args [0] = exc;</span>
<span class="lineNum">    4399 </span><span class="lineCov">         15 :         args [1] = &amp;is_terminating;</span>
<span class="lineNum">    4400 </span>            : 
<span class="lineNum">    4401 </span><span class="lineCov">         15 :         obj = mono_object_new_checked (mono_domain_get (), klass, error);</span>
<span class="lineNum">    4402 </span><span class="lineCov">         45 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    4403 </span>            : 
<span class="lineNum">    4404 </span><span class="lineCov">         15 :         mono_runtime_invoke_checked (method, obj, args, error);</span>
<span class="lineNum">    4405 </span><span class="lineCov">         45 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    4406 </span>            : 
<span class="lineNum">    4407 </span><span class="lineCov">         15 :         return obj;</span>
<span class="lineNum">    4408 </span><span class="lineCov">         15 : }</span>
<span class="lineNum">    4409 </span>            : 
<a name="4410"><span class="lineNum">    4410 </span>            : /* Used in mono_unhandled_exception */</a>
<span class="lineNum">    4411 </span>            : static void
<span class="lineNum">    4412 </span>            : call_unhandled_exception_delegate (MonoDomain *domain, MonoObject *delegate, MonoObject *exc) {
<span class="lineNum">    4413 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4414 </span>            : 
<span class="lineNum">    4415 </span>            :         MonoError error;
<span class="lineNum">    4416 </span><span class="lineCov">         15 :         MonoObject *e = NULL;</span>
<span class="lineNum">    4417 </span>            :         gpointer pa [2];
<span class="lineNum">    4418 </span><span class="lineCov">         15 :         MonoDomain *current_domain = mono_domain_get ();</span>
<span class="lineNum">    4419 </span>            : 
<span class="lineNum">    4420 </span><span class="lineCov">         15 :         if (domain != current_domain)</span>
<span class="lineNum">    4421 </span><span class="lineNoCov">          0 :                 mono_domain_set_internal_with_options (domain, FALSE);</span>
<span class="lineNum">    4422 </span>            : 
<span class="lineNum">    4423 </span><span class="lineCov">         45 :         g_assert (domain == mono_object_domain (domain-&gt;domain));</span>
<span class="lineNum">    4424 </span>            : 
<span class="lineNum">    4425 </span><span class="lineCov">         15 :         if (mono_object_domain (exc) != domain) {</span>
<span class="lineNum">    4426 </span>            : 
<span class="lineNum">    4427 </span><span class="lineNoCov">          0 :                 exc = mono_object_xdomain_representation (exc, domain, &amp;error);</span>
<span class="lineNum">    4428 </span><span class="lineNoCov">          0 :                 if (!exc) {</span>
<span class="lineNum">    4429 </span><span class="lineNoCov">          0 :                         if (!is_ok (&amp;error)) {</span>
<span class="lineNum">    4430 </span>            :                                 MonoError inner_error;
<span class="lineNum">    4431 </span><span class="lineNoCov">          0 :                                 MonoException *serialization_exc = mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    4432 </span><span class="lineNoCov">          0 :                                 exc = mono_object_xdomain_representation ((MonoObject*)serialization_exc, domain, &amp;inner_error);</span>
<span class="lineNum">    4433 </span><span class="lineNoCov">          0 :                                 mono_error_assert_ok (&amp;inner_error);</span>
<span class="lineNum">    4434 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">    4435 </span><span class="lineNoCov">          0 :                                 exc = (MonoObject*) mono_exception_from_name_msg (mono_get_corlib (),</span>
<span class="lineNum">    4436 </span>            :                                                 &quot;System.Runtime.Serialization&quot;, &quot;SerializationException&quot;,
<span class="lineNum">    4437 </span>            :                                                 &quot;Could not serialize unhandled exception.&quot;);
<span class="lineNum">    4438 </span>            :                         }
<span class="lineNum">    4439 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    4440 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4441 </span><span class="lineCov">         45 :         g_assert (mono_object_domain (exc) == domain);</span>
<span class="lineNum">    4442 </span>            : 
<span class="lineNum">    4443 </span><span class="lineCov">          5 :         pa [0] = domain-&gt;domain;</span>
<span class="lineNum">    4444 </span><span class="lineCov">          5 :         pa [1] = create_unhandled_exception_eventargs (exc, &amp;error);</span>
<span class="lineNum">    4445 </span><span class="lineCov">          5 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    4446 </span><span class="lineCov">          5 :         mono_runtime_delegate_try_invoke (delegate, pa, &amp;e, &amp;error);</span>
<span class="lineNum">    4447 </span><span class="lineCov">          5 :         if (!is_ok (&amp;error)) {</span>
<span class="lineNum">    4448 </span><span class="lineNoCov">          0 :                 if (e == NULL)</span>
<span class="lineNum">    4449 </span><span class="lineNoCov">          0 :                         e = (MonoObject*)mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    4450 </span>            :                 else
<span class="lineNum">    4451 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    4452 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4453 </span>            : 
<span class="lineNum">    4454 </span><span class="lineCov">          5 :         if (domain != current_domain)</span>
<span class="lineNum">    4455 </span><span class="lineNoCov">          0 :                 mono_domain_set_internal_with_options (current_domain, FALSE);</span>
<span class="lineNum">    4456 </span>            : 
<span class="lineNum">    4457 </span><span class="lineCov">          5 :         if (e) {</span>
<span class="lineNum">    4458 </span><span class="lineNoCov">          0 :                 gchar *msg = mono_string_to_utf8_checked (((MonoException *) e)-&gt;message, &amp;error);</span>
<span class="lineNum">    4459 </span><span class="lineNoCov">          0 :                 if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    4460 </span><span class="lineNoCov">          0 :                         g_warning (&quot;Exception inside UnhandledException handler with invalid message (Invalid characters)\n&quot;);</span>
<span class="lineNum">    4461 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    4462 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    4463 </span><span class="lineNoCov">          0 :                         g_warning (&quot;exception inside UnhandledException handler: %s\n&quot;, msg);</span>
<span class="lineNum">    4464 </span><span class="lineNoCov">          0 :                         g_free (msg);</span>
<span class="lineNum">    4465 </span>            :                 }
<span class="lineNum">    4466 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4467 </span><span class="lineCov">          5 : }</span>
<span class="lineNum">    4468 </span>            : 
<span class="lineNum">    4469 </span>            : static MonoRuntimeUnhandledExceptionPolicy runtime_unhandled_exception_policy = MONO_UNHANDLED_POLICY_CURRENT;
<span class="lineNum">    4470 </span>            : 
<span class="lineNum">    4471 </span>            : /**
<span class="lineNum">    4472 </span>            :  * mono_runtime_unhandled_exception_policy_set:
<span class="lineNum">    4473 </span>            :  * @policy: the new policy
<span class="lineNum">    4474 </span>            :  * 
<span class="lineNum">    4475 </span>            :  * This is a VM internal routine.
<span class="lineNum">    4476 </span>            :  *
<span class="lineNum">    4477 </span>            :  * Sets the runtime policy for handling unhandled exceptions.
<a name="4478"><span class="lineNum">    4478 </span>            :  */</a>
<span class="lineNum">    4479 </span>            : void
<span class="lineNum">    4480 </span>            : mono_runtime_unhandled_exception_policy_set (MonoRuntimeUnhandledExceptionPolicy policy) {
<span class="lineNum">    4481 </span><span class="lineCov">          3 :         runtime_unhandled_exception_policy = policy;</span>
<span class="lineNum">    4482 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">    4483 </span>            : 
<span class="lineNum">    4484 </span>            : /**
<span class="lineNum">    4485 </span>            :  * mono_runtime_unhandled_exception_policy_get:
<span class="lineNum">    4486 </span>            :  *
<span class="lineNum">    4487 </span>            :  * This is a VM internal routine.
<span class="lineNum">    4488 </span>            :  *
<span class="lineNum">    4489 </span>            :  * Gets the runtime policy for handling unhandled exceptions.
<a name="4490"><span class="lineNum">    4490 </span>            :  */</a>
<span class="lineNum">    4491 </span>            : MonoRuntimeUnhandledExceptionPolicy
<span class="lineNum">    4492 </span>            : mono_runtime_unhandled_exception_policy_get (void) {
<span class="lineNum">    4493 </span><span class="lineCov">        422 :         return runtime_unhandled_exception_policy;</span>
<span class="lineNum">    4494 </span>            : }
<span class="lineNum">    4495 </span>            : 
<span class="lineNum">    4496 </span>            : /**
<span class="lineNum">    4497 </span>            :  * mono_unhandled_exception:
<span class="lineNum">    4498 </span>            :  * @exc: exception thrown
<span class="lineNum">    4499 </span>            :  *
<span class="lineNum">    4500 </span>            :  * This is a VM internal routine.
<span class="lineNum">    4501 </span>            :  *
<span class="lineNum">    4502 </span>            :  * We call this function when we detect an unhandled exception
<span class="lineNum">    4503 </span>            :  * in the default domain.
<span class="lineNum">    4504 </span>            :  *
<span class="lineNum">    4505 </span>            :  * It invokes the * UnhandledException event in AppDomain or prints
<span class="lineNum">    4506 </span>            :  * a warning to the console 
<a name="4507"><span class="lineNum">    4507 </span>            :  */</a>
<span class="lineNum">    4508 </span>            : void
<span class="lineNum">    4509 </span>            : mono_unhandled_exception (MonoObject *exc)
<span class="lineNum">    4510 </span>            : {
<span class="lineNum">    4511 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4512 </span>            : 
<span class="lineNum">    4513 </span>            :         MonoError error;
<span class="lineNum">    4514 </span>            :         MonoClassField *field;
<span class="lineNum">    4515 </span>            :         MonoDomain *current_domain, *root_domain;
<span class="lineNum">    4516 </span><span class="lineCov">        409 :         MonoObject *current_appdomain_delegate = NULL, *root_appdomain_delegate = NULL;</span>
<span class="lineNum">    4517 </span>            : 
<span class="lineNum">    4518 </span><span class="lineCov">        409 :         if (mono_class_has_parent (exc-&gt;vtable-&gt;klass, mono_defaults.threadabortexception_class))</span>
<span class="lineNum">    4519 </span><span class="lineCov">        388 :                 return;</span>
<span class="lineNum">    4520 </span>            : 
<span class="lineNum">    4521 </span><span class="lineCov">         21 :         field = mono_class_get_field_from_name (mono_defaults.appdomain_class, &quot;UnhandledException&quot;);</span>
<span class="lineNum">    4522 </span><span class="lineCov">         63 :         g_assert (field);</span>
<span class="lineNum">    4523 </span>            : 
<span class="lineNum">    4524 </span><span class="lineCov">         21 :         current_domain = mono_domain_get ();</span>
<span class="lineNum">    4525 </span><span class="lineCov">         21 :         root_domain = mono_get_root_domain ();</span>
<span class="lineNum">    4526 </span>            : 
<span class="lineNum">    4527 </span><span class="lineCov">         21 :         root_appdomain_delegate = mono_field_get_value_object_checked (root_domain, field, (MonoObject*) root_domain-&gt;domain, &amp;error);</span>
<span class="lineNum">    4528 </span><span class="lineCov">         21 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    4529 </span><span class="lineCov">         21 :         if (current_domain != root_domain) {</span>
<span class="lineNum">    4530 </span><span class="lineNoCov">          0 :                 current_appdomain_delegate = mono_field_get_value_object_checked (current_domain, field, (MonoObject*) current_domain-&gt;domain, &amp;error);</span>
<span class="lineNum">    4531 </span><span class="lineNoCov">          0 :                 mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    4532 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    4533 </span>            : 
<span class="lineNum">    4534 </span><span class="lineCov">         42 :         if (!current_appdomain_delegate &amp;&amp; !root_appdomain_delegate) {</span>
<span class="lineNum">    4535 </span><span class="lineCov">          6 :                 mono_print_unhandled_exception (exc);</span>
<span class="lineNum">    4536 </span><span class="lineCov">          6 :         } else {</span>
<span class="lineNum">    4537 </span>            :                 /* unhandled exception callbacks must not be aborted */
<span class="lineNum">    4538 </span><span class="lineCov">         15 :                 mono_threads_begin_abort_protected_block ();</span>
<span class="lineNum">    4539 </span><span class="lineCov">         15 :                 if (root_appdomain_delegate)</span>
<span class="lineNum">    4540 </span><span class="lineCov">         15 :                         call_unhandled_exception_delegate (root_domain, root_appdomain_delegate, exc);</span>
<span class="lineNum">    4541 </span><span class="lineCov">          5 :                 if (current_appdomain_delegate)</span>
<span class="lineNum">    4542 </span><span class="lineNoCov">          0 :                         call_unhandled_exception_delegate (current_domain, current_appdomain_delegate, exc);</span>
<span class="lineNum">    4543 </span><span class="lineCov">          5 :                 mono_threads_end_abort_protected_block ();</span>
<span class="lineNum">    4544 </span>            :         }
<span class="lineNum">    4545 </span>            : 
<span class="lineNum">    4546 </span>            :         /* set exitcode only if we will abort the process */
<span class="lineNum">    4547 </span><span class="lineCov">         33 :         if ((main_thread &amp;&amp; mono_thread_internal_current () == main_thread-&gt;internal_thread)</span>
<span class="lineNum">    4548 </span><span class="lineCov">         22 :                  || mono_runtime_unhandled_exception_policy_get () == MONO_UNHANDLED_POLICY_CURRENT)</span>
<span class="lineNum">    4549 </span>            :         {
<span class="lineNum">    4550 </span><span class="lineCov">         11 :                 mono_environment_exitcode_set (1);</span>
<span class="lineNum">    4551 </span><span class="lineCov">         11 :         }</span>
<span class="lineNum">    4552 </span><span class="lineCov">        399 : }</span>
<span class="lineNum">    4553 </span>            : 
<span class="lineNum">    4554 </span>            : /**
<span class="lineNum">    4555 </span>            :  * mono_runtime_exec_managed_code:
<span class="lineNum">    4556 </span>            :  * @domain: Application domain
<span class="lineNum">    4557 </span>            :  * @main_func: function to invoke from the execution thread
<span class="lineNum">    4558 </span>            :  * @main_args: parameter to the main_func
<span class="lineNum">    4559 </span>            :  *
<span class="lineNum">    4560 </span>            :  * Launch a new thread to execute a function
<span class="lineNum">    4561 </span>            :  *
<span class="lineNum">    4562 </span>            :  * main_func is called back from the thread with main_args as the
<span class="lineNum">    4563 </span>            :  * parameter.  The callback function is expected to start Main()
<span class="lineNum">    4564 </span>            :  * eventually.  This function then waits for all managed threads to
<span class="lineNum">    4565 </span>            :  * finish.
<span class="lineNum">    4566 </span>            :  * It is not necesseray anymore to execute managed code in a subthread,
<span class="lineNum">    4567 </span>            :  * so this function should not be used anymore by default: just
<span class="lineNum">    4568 </span>            :  * execute the code and then call mono_thread_manage ().
<a name="4569"><span class="lineNum">    4569 </span>            :  */</a>
<span class="lineNum">    4570 </span>            : void
<span class="lineNum">    4571 </span>            : mono_runtime_exec_managed_code (MonoDomain *domain,
<span class="lineNum">    4572 </span>            :                                 MonoMainThreadFunc main_func,
<span class="lineNum">    4573 </span>            :                                 gpointer main_args)
<span class="lineNum">    4574 </span>            : {
<span class="lineNum">    4575 </span>            :         MonoError error;
<span class="lineNum">    4576 </span><span class="lineNoCov">          0 :         mono_thread_create_checked (domain, main_func, main_args, &amp;error);</span>
<span class="lineNum">    4577 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    4578 </span>            : 
<span class="lineNum">    4579 </span><span class="lineNoCov">          0 :         mono_thread_manage ();</span>
<span class="lineNum">    4580 </span><span class="lineNoCov">          0 : }</span>
<a name="4581"><span class="lineNum">    4581 </span>            : </a>
<span class="lineNum">    4582 </span>            : static void
<span class="lineNum">    4583 </span>            : prepare_thread_to_exec_main (MonoDomain *domain, MonoMethod *method)
<span class="lineNum">    4584 </span>            : {
<span class="lineNum">    4585 </span><span class="lineCov">       3366 :         MonoInternalThread* thread = mono_thread_internal_current ();</span>
<span class="lineNum">    4586 </span>            :         MonoCustomAttrInfo* cinfo;
<span class="lineNum">    4587 </span>            :         gboolean has_stathread_attribute;
<span class="lineNum">    4588 </span>            : 
<span class="lineNum">    4589 </span><span class="lineCov">       3366 :         if (!domain-&gt;entry_assembly) {</span>
<span class="lineNum">    4590 </span>            :                 gchar *str;
<span class="lineNum">    4591 </span>            :                 MonoAssembly *assembly;
<span class="lineNum">    4592 </span>            : 
<span class="lineNum">    4593 </span><span class="lineCov">       3362 :                 assembly = method-&gt;klass-&gt;image-&gt;assembly;</span>
<span class="lineNum">    4594 </span><span class="lineCov">       3362 :                 domain-&gt;entry_assembly = assembly;</span>
<span class="lineNum">    4595 </span>            :                 /* Domains created from another domain already have application_base and configuration_file set */
<span class="lineNum">    4596 </span><span class="lineCov">       3362 :                 if (domain-&gt;setup-&gt;application_base == NULL) {</span>
<span class="lineNum">    4597 </span><span class="lineCov">       6548 :                         MONO_OBJECT_SETREF (domain-&gt;setup, application_base, mono_string_new (domain, assembly-&gt;basedir));</span>
<span class="lineNum">    4598 </span><span class="lineCov">       3274 :                 }</span>
<span class="lineNum">    4599 </span>            : 
<span class="lineNum">    4600 </span><span class="lineCov">       3362 :                 if (domain-&gt;setup-&gt;configuration_file == NULL) {</span>
<span class="lineNum">    4601 </span><span class="lineCov">       3274 :                         str = g_strconcat (assembly-&gt;image-&gt;name, &quot;.config&quot;, NULL);</span>
<span class="lineNum">    4602 </span><span class="lineCov">       6548 :                         MONO_OBJECT_SETREF (domain-&gt;setup, configuration_file, mono_string_new (domain, str));</span>
<span class="lineNum">    4603 </span><span class="lineCov">       3274 :                         g_free (str);</span>
<span class="lineNum">    4604 </span><span class="lineCov">       3274 :                         mono_domain_set_options_from_config (domain);</span>
<span class="lineNum">    4605 </span><span class="lineCov">       3274 :                 }</span>
<span class="lineNum">    4606 </span><span class="lineCov">       3362 :         }</span>
<span class="lineNum">    4607 </span>            : 
<span class="lineNum">    4608 </span>            :         MonoError cattr_error;
<span class="lineNum">    4609 </span><span class="lineCov">       3366 :         cinfo = mono_custom_attrs_from_method_checked (method, &amp;cattr_error);</span>
<span class="lineNum">    4610 </span><span class="lineCov">       3366 :         mono_error_cleanup (&amp;cattr_error); /* FIXME warn here? */</span>
<span class="lineNum">    4611 </span><span class="lineCov">       3366 :         if (cinfo) {</span>
<span class="lineNum">    4612 </span><span class="lineCov">        310 :                 has_stathread_attribute = mono_custom_attrs_has_attr (cinfo, mono_class_get_sta_thread_attribute_class ());</span>
<span class="lineNum">    4613 </span><span class="lineCov">        310 :                 if (!cinfo-&gt;cached)</span>
<span class="lineNum">    4614 </span><span class="lineCov">        310 :                         mono_custom_attrs_free (cinfo);</span>
<span class="lineNum">    4615 </span><span class="lineCov">        310 :         } else {</span>
<span class="lineNum">    4616 </span><span class="lineCov">       3056 :                 has_stathread_attribute = FALSE;</span>
<span class="lineNum">    4617 </span>            :         }
<span class="lineNum">    4618 </span><span class="lineCov">       3366 :         if (has_stathread_attribute) {</span>
<span class="lineNum">    4619 </span><span class="lineCov">        304 :                 thread-&gt;apartment_state = ThreadApartmentState_STA;</span>
<span class="lineNum">    4620 </span><span class="lineCov">        304 :         } else {</span>
<span class="lineNum">    4621 </span><span class="lineCov">       3062 :                 thread-&gt;apartment_state = ThreadApartmentState_MTA;</span>
<span class="lineNum">    4622 </span>            :         }
<span class="lineNum">    4623 </span><span class="lineCov">       3366 :         mono_thread_init_apartment_state ();</span>
<span class="lineNum">    4624 </span>            : 
<span class="lineNum">    4625 </span><span class="lineCov">       3366 : }</span>
<a name="4626"><span class="lineNum">    4626 </span>            : </a>
<span class="lineNum">    4627 </span>            : static int
<span class="lineNum">    4628 </span>            : do_exec_main_checked (MonoMethod *method, MonoArray *args, MonoError *error)
<span class="lineNum">    4629 </span>            : {
<span class="lineNum">    4630 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4631 </span>            : 
<span class="lineNum">    4632 </span>            :         gpointer pa [1];
<span class="lineNum">    4633 </span>            :         int rval;
<span class="lineNum">    4634 </span>            : 
<span class="lineNum">    4635 </span><span class="lineCov">       3366 :         mono_error_init (error);</span>
<span class="lineNum">    4636 </span><span class="lineCov">      10098 :         g_assert (args);</span>
<span class="lineNum">    4637 </span>            : 
<span class="lineNum">    4638 </span><span class="lineCov">       3366 :         pa [0] = args;</span>
<span class="lineNum">    4639 </span>            : 
<span class="lineNum">    4640 </span>            :         /* FIXME: check signature of method */
<span class="lineNum">    4641 </span><span class="lineCov">       3366 :         if (mono_method_signature (method)-&gt;ret-&gt;type == MONO_TYPE_I4) {</span>
<span class="lineNum">    4642 </span>            :                 MonoObject *res;
<span class="lineNum">    4643 </span><span class="lineCov">       2747 :                 res = mono_runtime_invoke_checked (method, NULL, pa, error);</span>
<span class="lineNum">    4644 </span><span class="lineCov">       2747 :                 if (is_ok (error))</span>
<span class="lineNum">    4645 </span><span class="lineCov">       2747 :                         rval = *(guint32 *)((char *)res + sizeof (MonoObject));</span>
<span class="lineNum">    4646 </span>            :                 else
<span class="lineNum">    4647 </span><span class="lineNoCov">          0 :                         rval = -1;</span>
<span class="lineNum">    4648 </span><span class="lineCov">       2747 :                 mono_environment_exitcode_set (rval);</span>
<span class="lineNum">    4649 </span><span class="lineCov">       2747 :         } else {</span>
<span class="lineNum">    4650 </span><span class="lineCov">        573 :                 mono_runtime_invoke_checked (method, NULL, pa, error);</span>
<span class="lineNum">    4651 </span>            : 
<span class="lineNum">    4652 </span><span class="lineCov">        573 :                 if (is_ok (error))</span>
<span class="lineNum">    4653 </span><span class="lineCov">        573 :                         rval = 0;</span>
<span class="lineNum">    4654 </span>            :                 else {
<span class="lineNum">    4655 </span><span class="lineNoCov">          0 :                         rval = -1;</span>
<span class="lineNum">    4656 </span>            :                 }
<span class="lineNum">    4657 </span>            :         }
<span class="lineNum">    4658 </span><span class="lineCov">       3320 :         return rval;</span>
<span class="lineNum">    4659 </span>            : }
<a name="4660"><span class="lineNum">    4660 </span>            : </a>
<span class="lineNum">    4661 </span>            : static int
<span class="lineNum">    4662 </span>            : do_try_exec_main (MonoMethod *method, MonoArray *args, MonoObject **exc)
<span class="lineNum">    4663 </span>            : {
<span class="lineNum">    4664 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    4665 </span>            : 
<span class="lineNum">    4666 </span>            :         gpointer pa [1];
<span class="lineNum">    4667 </span>            :         int rval;
<span class="lineNum">    4668 </span>            : 
<span class="lineNum">    4669 </span><span class="lineNoCov">          0 :         g_assert (args);</span>
<span class="lineNum">    4670 </span><span class="lineNoCov">          0 :         g_assert (exc);</span>
<span class="lineNum">    4671 </span>            : 
<span class="lineNum">    4672 </span><span class="lineNoCov">          0 :         pa [0] = args;</span>
<span class="lineNum">    4673 </span>            : 
<span class="lineNum">    4674 </span>            :         /* FIXME: check signature of method */
<span class="lineNum">    4675 </span><span class="lineNoCov">          0 :         if (mono_method_signature (method)-&gt;ret-&gt;type == MONO_TYPE_I4) {</span>
<span class="lineNum">    4676 </span>            :                 MonoError inner_error;
<span class="lineNum">    4677 </span>            :                 MonoObject *res;
<span class="lineNum">    4678 </span><span class="lineNoCov">          0 :                 res = mono_runtime_try_invoke (method, NULL, pa, exc, &amp;inner_error);</span>
<span class="lineNum">    4679 </span><span class="lineNoCov">          0 :                 if (*exc == NULL &amp;&amp; !mono_error_ok (&amp;inner_error))</span>
<span class="lineNum">    4680 </span><span class="lineNoCov">          0 :                         *exc = (MonoObject*) mono_error_convert_to_exception (&amp;inner_error);</span>
<span class="lineNum">    4681 </span>            :                 else
<span class="lineNum">    4682 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;inner_error);</span>
<span class="lineNum">    4683 </span>            : 
<span class="lineNum">    4684 </span><span class="lineNoCov">          0 :                 if (*exc == NULL)</span>
<span class="lineNum">    4685 </span><span class="lineNoCov">          0 :                         rval = *(guint32 *)((char *)res + sizeof (MonoObject));</span>
<span class="lineNum">    4686 </span>            :                 else
<span class="lineNum">    4687 </span><span class="lineNoCov">          0 :                         rval = -1;</span>
<span class="lineNum">    4688 </span>            : 
<span class="lineNum">    4689 </span><span class="lineNoCov">          0 :                 mono_environment_exitcode_set (rval);</span>
<span class="lineNum">    4690 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    4691 </span>            :                 MonoError inner_error;
<span class="lineNum">    4692 </span><span class="lineNoCov">          0 :                 mono_runtime_try_invoke (method, NULL, pa, exc, &amp;inner_error);</span>
<span class="lineNum">    4693 </span><span class="lineNoCov">          0 :                 if (*exc == NULL &amp;&amp; !mono_error_ok (&amp;inner_error))</span>
<span class="lineNum">    4694 </span><span class="lineNoCov">          0 :                         *exc = (MonoObject*) mono_error_convert_to_exception (&amp;inner_error);</span>
<span class="lineNum">    4695 </span>            :                 else
<span class="lineNum">    4696 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;inner_error);</span>
<span class="lineNum">    4697 </span>            : 
<span class="lineNum">    4698 </span><span class="lineNoCov">          0 :                 if (*exc == NULL)</span>
<span class="lineNum">    4699 </span><span class="lineNoCov">          0 :                         rval = 0;</span>
<span class="lineNum">    4700 </span>            :                 else {
<span class="lineNum">    4701 </span>            :                         /* If the return type of Main is void, only
<span class="lineNum">    4702 </span>            :                          * set the exitcode if an exception was thrown
<span class="lineNum">    4703 </span>            :                          * (we don't want to blow away an
<span class="lineNum">    4704 </span>            :                          * explicitly-set exit code)
<span class="lineNum">    4705 </span>            :                          */
<span class="lineNum">    4706 </span><span class="lineNoCov">          0 :                         rval = -1;</span>
<span class="lineNum">    4707 </span><span class="lineNoCov">          0 :                         mono_environment_exitcode_set (rval);</span>
<span class="lineNum">    4708 </span>            :                 }
<span class="lineNum">    4709 </span>            :         }
<span class="lineNum">    4710 </span>            : 
<span class="lineNum">    4711 </span><span class="lineNoCov">          0 :         return rval;</span>
<span class="lineNum">    4712 </span>            : }
<span class="lineNum">    4713 </span>            : 
<span class="lineNum">    4714 </span>            : /*
<span class="lineNum">    4715 </span>            :  * Execute a standard Main() method (args doesn't contain the
<span class="lineNum">    4716 </span>            :  * executable name).
<a name="4717"><span class="lineNum">    4717 </span>            :  */</a>
<span class="lineNum">    4718 </span>            : int
<span class="lineNum">    4719 </span>            : mono_runtime_exec_main (MonoMethod *method, MonoArray *args, MonoObject **exc)
<span class="lineNum">    4720 </span>            : {
<span class="lineNum">    4721 </span>            :         MonoError error;
<span class="lineNum">    4722 </span><span class="lineNoCov">          0 :         prepare_thread_to_exec_main (mono_object_domain (args), method);</span>
<span class="lineNum">    4723 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    4724 </span><span class="lineNoCov">          0 :                 int rval = do_try_exec_main (method, args, exc);</span>
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :                 return rval;</span>
<span class="lineNum">    4726 </span>            :         } else {
<span class="lineNum">    4727 </span><span class="lineNoCov">          0 :                 int rval = do_exec_main_checked (method, args, &amp;error);</span>
<span class="lineNum">    4728 </span><span class="lineNoCov">          0 :                 mono_error_raise_exception (&amp;error); /* OK to throw, external only with no better option */</span>
<span class="lineNum">    4729 </span><span class="lineNoCov">          0 :                 return rval;</span>
<span class="lineNum">    4730 </span>            :         }
<span class="lineNum">    4731 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4732 </span>            : 
<span class="lineNum">    4733 </span>            : /*
<span class="lineNum">    4734 </span>            :  * Execute a standard Main() method (args doesn't contain the
<span class="lineNum">    4735 </span>            :  * executable name).
<span class="lineNum">    4736 </span>            :  *
<span class="lineNum">    4737 </span>            :  * On failure sets @error
<a name="4738"><span class="lineNum">    4738 </span>            :  */</a>
<span class="lineNum">    4739 </span>            : int
<span class="lineNum">    4740 </span>            : mono_runtime_exec_main_checked (MonoMethod *method, MonoArray *args, MonoError *error)
<span class="lineNum">    4741 </span>            : {
<span class="lineNum">    4742 </span><span class="lineCov">       3366 :         mono_error_init (error);</span>
<span class="lineNum">    4743 </span><span class="lineCov">       3366 :         prepare_thread_to_exec_main (mono_object_domain (args), method);</span>
<span class="lineNum">    4744 </span><span class="lineCov">       3366 :         return do_exec_main_checked (method, args, error);</span>
<span class="lineNum">    4745 </span>            : }
<span class="lineNum">    4746 </span>            : 
<span class="lineNum">    4747 </span>            : /*
<span class="lineNum">    4748 </span>            :  * Execute a standard Main() method (args doesn't contain the
<span class="lineNum">    4749 </span>            :  * executable name).
<span class="lineNum">    4750 </span>            :  *
<span class="lineNum">    4751 </span>            :  * On failure sets @error if Main couldn't be executed, or @exc if it threw an exception.
<a name="4752"><span class="lineNum">    4752 </span>            :  */</a>
<span class="lineNum">    4753 </span>            : int
<span class="lineNum">    4754 </span>            : mono_runtime_try_exec_main (MonoMethod *method, MonoArray *args, MonoObject **exc)
<span class="lineNum">    4755 </span>            : {
<span class="lineNum">    4756 </span><span class="lineNoCov">          0 :         prepare_thread_to_exec_main (mono_object_domain (args), method);</span>
<span class="lineNum">    4757 </span><span class="lineNoCov">          0 :         return do_try_exec_main (method, args, exc);</span>
<span class="lineNum">    4758 </span>            : }
<span class="lineNum">    4759 </span>            : 
<span class="lineNum">    4760 </span>            : 
<span class="lineNum">    4761 </span>            : 
<span class="lineNum">    4762 </span>            : /** invoke_array_extract_argument:
<span class="lineNum">    4763 </span>            :  * @params: array of arguments to the method.
<span class="lineNum">    4764 </span>            :  * @i: the index of the argument to extract.
<span class="lineNum">    4765 </span>            :  * @t: ith type from the method signature.
<span class="lineNum">    4766 </span>            :  * @has_byref_nullables: outarg - TRUE if method expects a byref nullable argument
<span class="lineNum">    4767 </span>            :  * @error: set on error.
<span class="lineNum">    4768 </span>            :  *
<span class="lineNum">    4769 </span>            :  * Given an array of method arguments, return the ith one using the corresponding type
<span class="lineNum">    4770 </span>            :  * to perform necessary unboxing.  If method expects a ref nullable argument, writes TRUE to @has_byref_nullables.
<span class="lineNum">    4771 </span>            :  *
<span class="lineNum">    4772 </span>            :  * On failure sets @error and returns NULL.
<a name="4773"><span class="lineNum">    4773 </span>            :  */</a>
<span class="lineNum">    4774 </span>            : static gpointer
<span class="lineNum">    4775 </span>            : invoke_array_extract_argument (MonoArray *params, int i, MonoType *t, gboolean* has_byref_nullables, MonoError *error)
<span class="lineNum">    4776 </span>            : {
<span class="lineNum">    4777 </span><span class="lineCov">     128893 :         MonoType *t_orig = t;</span>
<span class="lineNum">    4778 </span><span class="lineCov">     128893 :         gpointer result = NULL;</span>
<span class="lineNum">    4779 </span><span class="lineCov">     128893 :         mono_error_init (error);</span>
<span class="lineNum">    4780 </span>            :                 again:
<span class="lineNum">    4781 </span><span class="lineCov">     128917 :                         switch (t-&gt;type) {</span>
<span class="lineNum">    4782 </span>            :                         case MONO_TYPE_U1:
<span class="lineNum">    4783 </span>            :                         case MONO_TYPE_I1:
<span class="lineNum">    4784 </span>            :                         case MONO_TYPE_BOOLEAN:
<span class="lineNum">    4785 </span>            :                         case MONO_TYPE_U2:
<span class="lineNum">    4786 </span>            :                         case MONO_TYPE_I2:
<span class="lineNum">    4787 </span>            :                         case MONO_TYPE_CHAR:
<span class="lineNum">    4788 </span>            :                         case MONO_TYPE_U:
<span class="lineNum">    4789 </span>            :                         case MONO_TYPE_I:
<span class="lineNum">    4790 </span>            :                         case MONO_TYPE_U4:
<span class="lineNum">    4791 </span>            :                         case MONO_TYPE_I4:
<span class="lineNum">    4792 </span>            :                         case MONO_TYPE_U8:
<span class="lineNum">    4793 </span>            :                         case MONO_TYPE_I8:
<span class="lineNum">    4794 </span>            :                         case MONO_TYPE_R4:
<span class="lineNum">    4795 </span>            :                         case MONO_TYPE_R8:
<span class="lineNum">    4796 </span>            :                         case MONO_TYPE_VALUETYPE:
<span class="lineNum">    4797 </span><span class="lineCov">      87374 :                                 if (t-&gt;type == MONO_TYPE_VALUETYPE &amp;&amp; mono_class_is_nullable (mono_class_from_mono_type (t_orig))) {</span>
<span class="lineNum">    4798 </span>            :                                         /* The runtime invoke wrapper needs the original boxed vtype, it does handle byref values as well. */
<span class="lineNum">    4799 </span><span class="lineCov">          6 :                                         result = mono_array_get (params, MonoObject*, i);</span>
<span class="lineNum">    4800 </span><span class="lineCov">          6 :                                         if (t-&gt;byref)</span>
<span class="lineNum">    4801 </span><span class="lineCov">          6 :                                                 *has_byref_nullables = TRUE;</span>
<span class="lineNum">    4802 </span><span class="lineCov">          6 :                                 } else {</span>
<span class="lineNum">    4803 </span>            :                                         /* MS seems to create the objects if a null is passed in */
<span class="lineNum">    4804 </span><span class="lineCov">      83785 :                                         if (!mono_array_get (params, MonoObject*, i)) {</span>
<span class="lineNum">    4805 </span><span class="lineCov">          4 :                                                 MonoObject *o = mono_object_new_checked (mono_domain_get (), mono_class_from_mono_type (t_orig), error);</span>
<span class="lineNum">    4806 </span><span class="lineCov">         12 :                                                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    4807 </span><span class="lineCov">          8 :                                                 mono_array_setref (params, i, o); </span>
<span class="lineNum">    4808 </span><span class="lineCov">          4 :                                         }</span>
<span class="lineNum">    4809 </span>            : 
<span class="lineNum">    4810 </span><span class="lineCov">      83785 :                                         if (t-&gt;byref) {</span>
<span class="lineNum">    4811 </span>            :                                                 /*
<span class="lineNum">    4812 </span>            :                                                  * We can't pass the unboxed vtype byref to the callee, since
<span class="lineNum">    4813 </span>            :                                                  * that would mean the callee would be able to modify boxed
<span class="lineNum">    4814 </span>            :                                                  * primitive types. So we (and MS) make a copy of the boxed
<span class="lineNum">    4815 </span>            :                                                  * object, pass that to the callee, and replace the original
<span class="lineNum">    4816 </span>            :                                                  * boxed object in the arg array with the copy.
<span class="lineNum">    4817 </span>            :                                                  */
<span class="lineNum">    4818 </span><span class="lineCov">         12 :                                                 MonoObject *orig = mono_array_get (params, MonoObject*, i);</span>
<span class="lineNum">    4819 </span><span class="lineCov">         12 :                                                 MonoObject *copy = mono_value_box_checked (mono_domain_get (), orig-&gt;vtable-&gt;klass, mono_object_unbox (orig), error);</span>
<span class="lineNum">    4820 </span><span class="lineCov">         36 :                                                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    4821 </span><span class="lineCov">         24 :                                                 mono_array_setref (params, i, copy);</span>
<span class="lineNum">    4822 </span><span class="lineCov">         12 :                                         }</span>
<span class="lineNum">    4823 </span>            :                                                 
<span class="lineNum">    4824 </span><span class="lineCov">      83785 :                                         result = mono_object_unbox (mono_array_get (params, MonoObject*, i));</span>
<span class="lineNum">    4825 </span>            :                                 }
<span class="lineNum">    4826 </span><span class="lineCov">      83791 :                                 break;</span>
<span class="lineNum">    4827 </span>            :                         case MONO_TYPE_STRING:
<span class="lineNum">    4828 </span>            :                         case MONO_TYPE_OBJECT:
<span class="lineNum">    4829 </span>            :                         case MONO_TYPE_CLASS:
<span class="lineNum">    4830 </span>            :                         case MONO_TYPE_ARRAY:
<span class="lineNum">    4831 </span>            :                         case MONO_TYPE_SZARRAY:
<span class="lineNum">    4832 </span><span class="lineCov">      45098 :                                 if (t-&gt;byref)</span>
<span class="lineNum">    4833 </span><span class="lineCov">         10 :                                         result = mono_array_addr (params, MonoObject*, i);</span>
<span class="lineNum">    4834 </span>            :                                         // FIXME: I need to check this code path
<span class="lineNum">    4835 </span>            :                                 else
<span class="lineNum">    4836 </span><span class="lineCov">      45088 :                                         result = mono_array_get (params, MonoObject*, i);</span>
<span class="lineNum">    4837 </span><span class="lineCov">      45098 :                                 break;</span>
<span class="lineNum">    4838 </span>            :                         case MONO_TYPE_GENERICINST:
<span class="lineNum">    4839 </span><span class="lineCov">         24 :                                 if (t-&gt;byref)</span>
<span class="lineNum">    4840 </span><span class="lineCov">         10 :                                         t = &amp;t-&gt;data.generic_class-&gt;container_class-&gt;this_arg;</span>
<span class="lineNum">    4841 </span>            :                                 else
<span class="lineNum">    4842 </span><span class="lineCov">         14 :                                         t = &amp;t-&gt;data.generic_class-&gt;container_class-&gt;byval_arg;</span>
<span class="lineNum">    4843 </span><span class="lineCov">         24 :                                 goto again;</span>
<span class="lineNum">    4844 </span>            :                         case MONO_TYPE_PTR: {
<span class="lineNum">    4845 </span>            :                                 MonoObject *arg;
<span class="lineNum">    4846 </span>            : 
<span class="lineNum">    4847 </span>            :                                 /* The argument should be an IntPtr */
<span class="lineNum">    4848 </span><span class="lineCov">          4 :                                 arg = mono_array_get (params, MonoObject*, i);</span>
<span class="lineNum">    4849 </span><span class="lineCov">          4 :                                 if (arg == NULL) {</span>
<span class="lineNum">    4850 </span><span class="lineCov">          2 :                                         result = NULL;</span>
<span class="lineNum">    4851 </span><span class="lineCov">          2 :                                 } else {</span>
<span class="lineNum">    4852 </span><span class="lineCov">          6 :                                         g_assert (arg-&gt;vtable-&gt;klass == mono_defaults.int_class);</span>
<span class="lineNum">    4853 </span><span class="lineCov">          2 :                                         result = ((MonoIntPtr*)arg)-&gt;m_value;</span>
<span class="lineNum">    4854 </span>            :                                 }
<span class="lineNum">    4855 </span><span class="lineCov">          4 :                                 break;</span>
<span class="lineNum">    4856 </span>            :                         }
<span class="lineNum">    4857 </span>            :                         default:
<span class="lineNum">    4858 </span><span class="lineNoCov">          0 :                                 g_error (&quot;type 0x%x not handled in mono_runtime_invoke_array&quot;, t_orig-&gt;type);</span>
<span class="lineNum">    4859 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    4860 </span><span class="lineCov">     128893 :         return result;</span>
<span class="lineNum">    4861 </span><span class="lineCov">     128893 : }</span>
<span class="lineNum">    4862 </span>            : /**
<span class="lineNum">    4863 </span>            :  * mono_runtime_invoke_array:
<span class="lineNum">    4864 </span>            :  * @method: method to invoke
<span class="lineNum">    4865 </span>            :  * @obJ: object instance
<span class="lineNum">    4866 </span>            :  * @params: arguments to the method
<span class="lineNum">    4867 </span>            :  * @exc: exception information.
<span class="lineNum">    4868 </span>            :  *
<span class="lineNum">    4869 </span>            :  * Invokes the method represented by @method on the object @obj.
<span class="lineNum">    4870 </span>            :  *
<span class="lineNum">    4871 </span>            :  * obj is the 'this' pointer, it should be NULL for static
<span class="lineNum">    4872 </span>            :  * methods, a MonoObject* for object instances and a pointer to
<span class="lineNum">    4873 </span>            :  * the value type for value types.
<span class="lineNum">    4874 </span>            :  *
<span class="lineNum">    4875 </span>            :  * The params array contains the arguments to the method with the
<span class="lineNum">    4876 </span>            :  * same convention: MonoObject* pointers for object instances and
<span class="lineNum">    4877 </span>            :  * pointers to the value type otherwise. The _invoke_array
<span class="lineNum">    4878 </span>            :  * variant takes a C# object[] as the params argument (MonoArray
<span class="lineNum">    4879 </span>            :  * *params): in this case the value types are boxed inside the
<span class="lineNum">    4880 </span>            :  * respective reference representation.
<span class="lineNum">    4881 </span>            :  * 
<span class="lineNum">    4882 </span>            :  * From unmanaged code you'll usually use the
<span class="lineNum">    4883 </span>            :  * mono_runtime_invoke_checked() variant.
<span class="lineNum">    4884 </span>            :  *
<span class="lineNum">    4885 </span>            :  * Note that this function doesn't handle virtual methods for
<span class="lineNum">    4886 </span>            :  * you, it will exec the exact method you pass: we still need to
<span class="lineNum">    4887 </span>            :  * expose a function to lookup the derived class implementation
<span class="lineNum">    4888 </span>            :  * of a virtual method (there are examples of this in the code,
<span class="lineNum">    4889 </span>            :  * though).
<span class="lineNum">    4890 </span>            :  * 
<span class="lineNum">    4891 </span>            :  * You can pass NULL as the exc argument if you don't want to
<span class="lineNum">    4892 </span>            :  * catch exceptions, otherwise, *exc will be set to the exception
<span class="lineNum">    4893 </span>            :  * thrown, if any.  if an exception is thrown, you can't use the
<span class="lineNum">    4894 </span>            :  * MonoObject* result from the function.
<span class="lineNum">    4895 </span>            :  * 
<span class="lineNum">    4896 </span>            :  * If the method returns a value type, it is boxed in an object
<span class="lineNum">    4897 </span>            :  * reference.
<a name="4898"><span class="lineNum">    4898 </span>            :  */</a>
<span class="lineNum">    4899 </span>            : MonoObject*
<span class="lineNum">    4900 </span>            : mono_runtime_invoke_array (MonoMethod *method, void *obj, MonoArray *params,
<span class="lineNum">    4901 </span>            :                            MonoObject **exc)
<span class="lineNum">    4902 </span>            : {
<span class="lineNum">    4903 </span>            :         MonoError error;
<span class="lineNum">    4904 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    4905 </span><span class="lineNoCov">          0 :                 MonoObject *result = mono_runtime_try_invoke_array (method, obj, params, exc, &amp;error);</span>
<span class="lineNum">    4906 </span><span class="lineNoCov">          0 :                 if (*exc) {</span>
<span class="lineNum">    4907 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    4908 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    4909 </span>            :                 } else {
<span class="lineNum">    4910 </span><span class="lineNoCov">          0 :                         if (!is_ok (&amp;error))</span>
<span class="lineNum">    4911 </span><span class="lineNoCov">          0 :                                 *exc = (MonoObject*)mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    4912 </span><span class="lineNoCov">          0 :                         return result;</span>
<span class="lineNum">    4913 </span>            :                 }
<span class="lineNum">    4914 </span>            :         } else {
<span class="lineNum">    4915 </span><span class="lineNoCov">          0 :                 MonoObject *result = mono_runtime_try_invoke_array (method, obj, params, NULL, &amp;error);</span>
<span class="lineNum">    4916 </span><span class="lineNoCov">          0 :                 mono_error_raise_exception (&amp;error); /* OK to throw, external only without a good alternative */</span>
<span class="lineNum">    4917 </span><span class="lineNoCov">          0 :                 return result;</span>
<span class="lineNum">    4918 </span>            :         }
<span class="lineNum">    4919 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4920 </span>            : 
<span class="lineNum">    4921 </span>            : /**
<span class="lineNum">    4922 </span>            :  * mono_runtime_invoke_array_checked:
<span class="lineNum">    4923 </span>            :  * @method: method to invoke
<span class="lineNum">    4924 </span>            :  * @obJ: object instance
<span class="lineNum">    4925 </span>            :  * @params: arguments to the method
<span class="lineNum">    4926 </span>            :  * @error: set on failure.
<span class="lineNum">    4927 </span>            :  *
<span class="lineNum">    4928 </span>            :  * Invokes the method represented by @method on the object @obj.
<span class="lineNum">    4929 </span>            :  *
<span class="lineNum">    4930 </span>            :  * obj is the 'this' pointer, it should be NULL for static
<span class="lineNum">    4931 </span>            :  * methods, a MonoObject* for object instances and a pointer to
<span class="lineNum">    4932 </span>            :  * the value type for value types.
<span class="lineNum">    4933 </span>            :  *
<span class="lineNum">    4934 </span>            :  * The params array contains the arguments to the method with the
<span class="lineNum">    4935 </span>            :  * same convention: MonoObject* pointers for object instances and
<span class="lineNum">    4936 </span>            :  * pointers to the value type otherwise. The _invoke_array
<span class="lineNum">    4937 </span>            :  * variant takes a C# object[] as the params argument (MonoArray
<span class="lineNum">    4938 </span>            :  * *params): in this case the value types are boxed inside the
<span class="lineNum">    4939 </span>            :  * respective reference representation.
<span class="lineNum">    4940 </span>            :  *
<span class="lineNum">    4941 </span>            :  * From unmanaged code you'll usually use the
<span class="lineNum">    4942 </span>            :  * mono_runtime_invoke_checked() variant.
<span class="lineNum">    4943 </span>            :  *
<span class="lineNum">    4944 </span>            :  * Note that this function doesn't handle virtual methods for
<span class="lineNum">    4945 </span>            :  * you, it will exec the exact method you pass: we still need to
<span class="lineNum">    4946 </span>            :  * expose a function to lookup the derived class implementation
<span class="lineNum">    4947 </span>            :  * of a virtual method (there are examples of this in the code,
<span class="lineNum">    4948 </span>            :  * though).
<span class="lineNum">    4949 </span>            :  *
<span class="lineNum">    4950 </span>            :  * On failure or exception, @error will be set. In that case, you
<span class="lineNum">    4951 </span>            :  * can't use the MonoObject* result from the function.
<span class="lineNum">    4952 </span>            :  *
<span class="lineNum">    4953 </span>            :  * If the method returns a value type, it is boxed in an object
<span class="lineNum">    4954 </span>            :  * reference.
<a name="4955"><span class="lineNum">    4955 </span>            :  */</a>
<span class="lineNum">    4956 </span>            : MonoObject*
<span class="lineNum">    4957 </span>            : mono_runtime_invoke_array_checked (MonoMethod *method, void *obj, MonoArray *params,
<span class="lineNum">    4958 </span>            :                                    MonoError *error)
<span class="lineNum">    4959 </span>            : {
<span class="lineNum">    4960 </span><span class="lineCov">     325640 :         mono_error_init (error);</span>
<span class="lineNum">    4961 </span><span class="lineCov">     325640 :         return mono_runtime_try_invoke_array (method, obj, params, NULL, error);</span>
<span class="lineNum">    4962 </span>            : }
<span class="lineNum">    4963 </span>            : 
<span class="lineNum">    4964 </span>            : /**
<span class="lineNum">    4965 </span>            :  * mono_runtime_try_invoke_array:
<span class="lineNum">    4966 </span>            :  * @method: method to invoke
<span class="lineNum">    4967 </span>            :  * @obJ: object instance
<span class="lineNum">    4968 </span>            :  * @params: arguments to the method
<span class="lineNum">    4969 </span>            :  * @exc: exception information.
<span class="lineNum">    4970 </span>            :  * @error: set on failure.
<span class="lineNum">    4971 </span>            :  *
<span class="lineNum">    4972 </span>            :  * Invokes the method represented by @method on the object @obj.
<span class="lineNum">    4973 </span>            :  *
<span class="lineNum">    4974 </span>            :  * obj is the 'this' pointer, it should be NULL for static
<span class="lineNum">    4975 </span>            :  * methods, a MonoObject* for object instances and a pointer to
<span class="lineNum">    4976 </span>            :  * the value type for value types.
<span class="lineNum">    4977 </span>            :  *
<span class="lineNum">    4978 </span>            :  * The params array contains the arguments to the method with the
<span class="lineNum">    4979 </span>            :  * same convention: MonoObject* pointers for object instances and
<span class="lineNum">    4980 </span>            :  * pointers to the value type otherwise. The _invoke_array
<span class="lineNum">    4981 </span>            :  * variant takes a C# object[] as the params argument (MonoArray
<span class="lineNum">    4982 </span>            :  * *params): in this case the value types are boxed inside the
<span class="lineNum">    4983 </span>            :  * respective reference representation.
<span class="lineNum">    4984 </span>            :  *
<span class="lineNum">    4985 </span>            :  * From unmanaged code you'll usually use the
<span class="lineNum">    4986 </span>            :  * mono_runtime_invoke_checked() variant.
<span class="lineNum">    4987 </span>            :  *
<span class="lineNum">    4988 </span>            :  * Note that this function doesn't handle virtual methods for
<span class="lineNum">    4989 </span>            :  * you, it will exec the exact method you pass: we still need to
<span class="lineNum">    4990 </span>            :  * expose a function to lookup the derived class implementation
<span class="lineNum">    4991 </span>            :  * of a virtual method (there are examples of this in the code,
<span class="lineNum">    4992 </span>            :  * though).
<span class="lineNum">    4993 </span>            :  *
<span class="lineNum">    4994 </span>            :  * You can pass NULL as the exc argument if you don't want to catch
<span class="lineNum">    4995 </span>            :  * exceptions, otherwise, *exc will be set to the exception thrown, if
<span class="lineNum">    4996 </span>            :  * any.  On other failures, @error will be set. If an exception is
<span class="lineNum">    4997 </span>            :  * thrown or there's an error, you can't use the MonoObject* result
<span class="lineNum">    4998 </span>            :  * from the function.
<span class="lineNum">    4999 </span>            :  *
<span class="lineNum">    5000 </span>            :  * If the method returns a value type, it is boxed in an object
<span class="lineNum">    5001 </span>            :  * reference.
<a name="5002"><span class="lineNum">    5002 </span>            :  */</a>
<span class="lineNum">    5003 </span>            : MonoObject*
<span class="lineNum">    5004 </span>            : mono_runtime_try_invoke_array (MonoMethod *method, void *obj, MonoArray *params,
<span class="lineNum">    5005 </span>            :                                MonoObject **exc, MonoError *error)
<span class="lineNum">    5006 </span>            : {
<span class="lineNum">    5007 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5008 </span>            : 
<span class="lineNum">    5009 </span><span class="lineCov">     325774 :         mono_error_init (error);</span>
<span class="lineNum">    5010 </span>            : 
<span class="lineNum">    5011 </span><span class="lineCov">     325774 :         MonoMethodSignature *sig = mono_method_signature (method);</span>
<span class="lineNum">    5012 </span><span class="lineCov">     325774 :         gpointer *pa = NULL;</span>
<span class="lineNum">    5013 </span>            :         MonoObject *res;
<span class="lineNum">    5014 </span>            :         int i;
<span class="lineNum">    5015 </span><span class="lineCov">     325774 :         gboolean has_byref_nullables = FALSE;</span>
<span class="lineNum">    5016 </span>            : 
<span class="lineNum">    5017 </span><span class="lineCov">     325774 :         if (NULL != params) {</span>
<span class="lineNum">    5018 </span><span class="lineCov">      65117 :                 pa = (void **)alloca (sizeof (gpointer) * mono_array_length (params));</span>
<span class="lineNum">    5019 </span><span class="lineCov">     388020 :                 for (i = 0; i &lt; mono_array_length (params); i++) {</span>
<span class="lineNum">    5020 </span><span class="lineCov">     128893 :                         MonoType *t = sig-&gt;params [i];</span>
<span class="lineNum">    5021 </span><span class="lineCov">     128893 :                         pa [i] = invoke_array_extract_argument (params, i, t, &amp;has_byref_nullables, error);</span>
<span class="lineNum">    5022 </span><span class="lineCov">     386679 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5023 </span><span class="lineCov">     128893 :                 }</span>
<span class="lineNum">    5024 </span><span class="lineCov">      65117 :         }</span>
<span class="lineNum">    5025 </span>            : 
<span class="lineNum">    5026 </span><span class="lineCov">     620903 :         if (!strcmp (method-&gt;name, &quot;.ctor&quot;) &amp;&amp; method-&gt;klass != mono_defaults.string_class) {</span>
<span class="lineNum">    5027 </span><span class="lineCov">     235173 :                 void *o = obj;</span>
<span class="lineNum">    5028 </span>            : 
<span class="lineNum">    5029 </span><span class="lineCov">     235173 :                 if (mono_class_is_nullable (method-&gt;klass)) {</span>
<span class="lineNum">    5030 </span>            :                         /* Need to create a boxed vtype instead */
<span class="lineNum">    5031 </span><span class="lineNoCov">          0 :                         g_assert (!obj);</span>
<span class="lineNum">    5032 </span>            : 
<span class="lineNum">    5033 </span><span class="lineNoCov">          0 :                         if (!params)</span>
<span class="lineNum">    5034 </span><span class="lineNoCov">          0 :                                 return NULL;</span>
<span class="lineNum">    5035 </span>            :                         else {
<span class="lineNum">    5036 </span><span class="lineNoCov">          0 :                                 return mono_value_box_checked (mono_domain_get (), method-&gt;klass-&gt;cast_class, pa [0], error);</span>
<span class="lineNum">    5037 </span>            :                         }
<span class="lineNum">    5038 </span>            :                 }
<span class="lineNum">    5039 </span>            : 
<span class="lineNum">    5040 </span><span class="lineCov">     235171 :                 if (!obj) {</span>
<span class="lineNum">    5041 </span><span class="lineCov">     231591 :                         obj = mono_object_new_checked (mono_domain_get (), method-&gt;klass, error);</span>
<span class="lineNum">    5042 </span><span class="lineCov">     231591 :                         mono_error_assert_ok (error);</span>
<span class="lineNum">    5043 </span><span class="lineCov">     694903 :                         g_assert (obj); /*maybe we should raise a TLE instead?*/</span>
<span class="lineNum">    5044 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    5045 </span><span class="lineCov">     231650 :                         if (mono_object_is_transparent_proxy (obj)) {</span>
<span class="lineNum">    5046 </span><span class="lineCov">          9 :                                 method = mono_marshal_get_remoting_invoke (method-&gt;slot == -1 ? method : method-&gt;klass-&gt;vtable [method-&gt;slot]);</span>
<span class="lineNum">    5047 </span><span class="lineCov">          3 :                         }</span>
<span class="lineNum">    5048 </span>            : #endif
<span class="lineNum">    5049 </span><span class="lineCov">     231611 :                         if (method-&gt;klass-&gt;valuetype)</span>
<span class="lineNum">    5050 </span><span class="lineCov">          6 :                                 o = (MonoObject *)mono_object_unbox ((MonoObject *)obj);</span>
<span class="lineNum">    5051 </span>            :                         else
<span class="lineNum">    5052 </span><span class="lineCov">     231625 :                                 o = obj;</span>
<span class="lineNum">    5053 </span><span class="lineCov">     235252 :                 } else if (method-&gt;klass-&gt;valuetype) {</span>
<span class="lineNum">    5054 </span><span class="lineCov">        539 :                         obj = mono_value_box_checked (mono_domain_get (), method-&gt;klass, obj, error);</span>
<span class="lineNum">    5055 </span><span class="lineCov">       1617 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5056 </span><span class="lineCov">        539 :                 }</span>
<span class="lineNum">    5057 </span>            : 
<span class="lineNum">    5058 </span><span class="lineCov">     235180 :                 if (exc) {</span>
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :                         mono_runtime_try_invoke (method, o, pa, exc, error);</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    5061 </span><span class="lineCov">     235219 :                         mono_runtime_invoke_checked (method, o, pa, error);</span>
<span class="lineNum">    5062 </span>            :                 }
<span class="lineNum">    5063 </span>            : 
<span class="lineNum">    5064 </span><span class="lineCov">     235221 :                 return (MonoObject *)obj;</span>
<span class="lineNum">    5065 </span>            :         } else {
<span class="lineNum">    5066 </span><span class="lineCov">      90474 :                 if (mono_class_is_nullable (method-&gt;klass)) {</span>
<span class="lineNum">    5067 </span>            :                         MonoObject *nullable;
<span class="lineNum">    5068 </span>            : 
<span class="lineNum">    5069 </span>            :                         /* Convert the unboxed vtype into a Nullable structure */
<span class="lineNum">    5070 </span><span class="lineNoCov">          0 :                         nullable = mono_object_new_checked (mono_domain_get (), method-&gt;klass, error);</span>
<span class="lineNum">    5071 </span><span class="lineNoCov">          0 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5072 </span>            : 
<span class="lineNum">    5073 </span><span class="lineNoCov">          0 :                         MonoObject *boxed = mono_value_box_checked (mono_domain_get (), method-&gt;klass-&gt;cast_class, obj, error);</span>
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5075 </span><span class="lineNoCov">          0 :                         mono_nullable_init ((guint8 *)mono_object_unbox (nullable), boxed, method-&gt;klass);</span>
<span class="lineNum">    5076 </span><span class="lineNoCov">          0 :                         obj = mono_object_unbox (nullable);</span>
<span class="lineNum">    5077 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    5078 </span>            : 
<span class="lineNum">    5079 </span>            :                 /* obj must be already unboxed if needed */
<span class="lineNum">    5080 </span><span class="lineCov">      90474 :                 if (exc) {</span>
<span class="lineNum">    5081 </span><span class="lineCov">         60 :                         res = mono_runtime_try_invoke (method, obj, pa, exc, error);</span>
<span class="lineNum">    5082 </span><span class="lineCov">         60 :                 } else {</span>
<span class="lineNum">    5083 </span><span class="lineCov">      90414 :                         res = mono_runtime_invoke_checked (method, obj, pa, error);</span>
<span class="lineNum">    5084 </span>            :                 }
<span class="lineNum">    5085 </span><span class="lineCov">     271104 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5086 </span>            : 
<span class="lineNum">    5087 </span><span class="lineCov">      90368 :                 if (sig-&gt;ret-&gt;type == MONO_TYPE_PTR) {</span>
<span class="lineNum">    5088 </span>            :                         MonoClass *pointer_class;
<span class="lineNum">    5089 </span>            :                         static MonoMethod *box_method;
<span class="lineNum">    5090 </span>            :                         void *box_args [2];
<span class="lineNum">    5091 </span>            :                         MonoObject *box_exc;
<span class="lineNum">    5092 </span>            : 
<span class="lineNum">    5093 </span>            :                         /* 
<span class="lineNum">    5094 </span>            :                          * The runtime-invoke wrapper returns a boxed IntPtr, need to 
<span class="lineNum">    5095 </span>            :                          * convert it to a Pointer object.
<span class="lineNum">    5096 </span>            :                          */
<span class="lineNum">    5097 </span><span class="lineCov">          4 :                         pointer_class = mono_class_get_pointer_class ();</span>
<span class="lineNum">    5098 </span><span class="lineCov">          4 :                         if (!box_method)</span>
<span class="lineNum">    5099 </span><span class="lineCov">          2 :                                 box_method = mono_class_get_method_from_name (pointer_class, &quot;Box&quot;, -1);</span>
<span class="lineNum">    5100 </span>            : 
<span class="lineNum">    5101 </span><span class="lineCov">         12 :                         g_assert (res-&gt;vtable-&gt;klass == mono_defaults.int_class);</span>
<span class="lineNum">    5102 </span><span class="lineCov">          4 :                         box_args [0] = ((MonoIntPtr*)res)-&gt;m_value;</span>
<span class="lineNum">    5103 </span><span class="lineCov">          4 :                         box_args [1] = mono_type_get_object_checked (mono_domain_get (), sig-&gt;ret, error);</span>
<span class="lineNum">    5104 </span><span class="lineCov">         12 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5105 </span>            : 
<span class="lineNum">    5106 </span><span class="lineCov">          4 :                         res = mono_runtime_try_invoke (box_method, NULL, box_args, &amp;box_exc, error);</span>
<span class="lineNum">    5107 </span><span class="lineCov">         12 :                         g_assert (box_exc == NULL);</span>
<span class="lineNum">    5108 </span><span class="lineCov">          4 :                         mono_error_assert_ok (error);</span>
<span class="lineNum">    5109 </span><span class="lineCov">          4 :                 }</span>
<span class="lineNum">    5110 </span>            : 
<span class="lineNum">    5111 </span><span class="lineCov">      90368 :                 if (has_byref_nullables) {</span>
<span class="lineNum">    5112 </span>            :                         /* 
<span class="lineNum">    5113 </span>            :                          * The runtime invoke wrapper already converted byref nullables back,
<span class="lineNum">    5114 </span>            :                          * and stored them in pa, we just need to copy them back to the
<span class="lineNum">    5115 </span>            :                          * managed array.
<span class="lineNum">    5116 </span>            :                          */
<span class="lineNum">    5117 </span><span class="lineCov">         24 :                         for (i = 0; i &lt; mono_array_length (params); i++) {</span>
<span class="lineNum">    5118 </span><span class="lineCov">          6 :                                 MonoType *t = sig-&gt;params [i];</span>
<span class="lineNum">    5119 </span>            : 
<span class="lineNum">    5120 </span><span class="lineCov">         18 :                                 if (t-&gt;byref &amp;&amp; t-&gt;type == MONO_TYPE_GENERICINST &amp;&amp; mono_class_is_nullable (mono_class_from_mono_type (t)))</span>
<span class="lineNum">    5121 </span><span class="lineCov">         18 :                                         mono_array_setref (params, i, pa [i]);</span>
<span class="lineNum">    5122 </span><span class="lineCov">          6 :                         }</span>
<span class="lineNum">    5123 </span><span class="lineCov">          6 :                 }</span>
<span class="lineNum">    5124 </span>            : 
<span class="lineNum">    5125 </span><span class="lineCov">      90368 :                 return res;</span>
<span class="lineNum">    5126 </span>            :         }
<span class="lineNum">    5127 </span><span class="lineCov">     325528 : }</span>
<span class="lineNum">    5128 </span>            : 
<span class="lineNum">    5129 </span>            : /**
<span class="lineNum">    5130 </span>            :  * mono_object_new:
<span class="lineNum">    5131 </span>            :  * @klass: the class of the object that we want to create
<span class="lineNum">    5132 </span>            :  *
<span class="lineNum">    5133 </span>            :  * Returns: a newly created object whose definition is
<span class="lineNum">    5134 </span>            :  * looked up using @klass.   This will not invoke any constructors, 
<span class="lineNum">    5135 </span>            :  * so the consumer of this routine has to invoke any constructors on
<span class="lineNum">    5136 </span>            :  * its own to initialize the object.
<span class="lineNum">    5137 </span>            :  * 
<span class="lineNum">    5138 </span>            :  * It returns NULL on failure.
<a name="5139"><span class="lineNum">    5139 </span>            :  */</a>
<span class="lineNum">    5140 </span>            : MonoObject *
<span class="lineNum">    5141 </span>            : mono_object_new (MonoDomain *domain, MonoClass *klass)
<span class="lineNum">    5142 </span>            : {
<span class="lineNum">    5143 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5144 </span>            : 
<span class="lineNum">    5145 </span>            :         MonoError error;
<span class="lineNum">    5146 </span>            : 
<span class="lineNum">    5147 </span><span class="lineNoCov">          0 :         MonoObject * result = mono_object_new_checked (domain, klass, &amp;error);</span>
<span class="lineNum">    5148 </span>            : 
<span class="lineNum">    5149 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5150 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    5151 </span>            : }
<a name="5152"><span class="lineNum">    5152 </span>            : </a>
<span class="lineNum">    5153 </span>            : MonoObject *
<span class="lineNum">    5154 </span>            : ves_icall_object_new (MonoDomain *domain, MonoClass *klass)
<span class="lineNum">    5155 </span>            : {
<span class="lineNum">    5156 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5157 </span>            : 
<span class="lineNum">    5158 </span>            :         MonoError error;
<span class="lineNum">    5159 </span>            : 
<span class="lineNum">    5160 </span><span class="lineCov">        604 :         MonoObject * result = mono_object_new_checked (domain, klass, &amp;error);</span>
<span class="lineNum">    5161 </span>            : 
<span class="lineNum">    5162 </span><span class="lineCov">        604 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    5163 </span><span class="lineCov">        604 :         return result;</span>
<span class="lineNum">    5164 </span>            : }
<span class="lineNum">    5165 </span>            : 
<span class="lineNum">    5166 </span>            : /**
<span class="lineNum">    5167 </span>            :  * mono_object_new_checked:
<span class="lineNum">    5168 </span>            :  * @klass: the class of the object that we want to create
<span class="lineNum">    5169 </span>            :  * @error: set on error
<span class="lineNum">    5170 </span>            :  *
<span class="lineNum">    5171 </span>            :  * Returns: a newly created object whose definition is
<span class="lineNum">    5172 </span>            :  * looked up using @klass.   This will not invoke any constructors,
<span class="lineNum">    5173 </span>            :  * so the consumer of this routine has to invoke any constructors on
<span class="lineNum">    5174 </span>            :  * its own to initialize the object.
<span class="lineNum">    5175 </span>            :  *
<span class="lineNum">    5176 </span>            :  * It returns NULL on failure and sets @error.
<a name="5177"><span class="lineNum">    5177 </span>            :  */</a>
<span class="lineNum">    5178 </span>            : MonoObject *
<span class="lineNum">    5179 </span>            : mono_object_new_checked (MonoDomain *domain, MonoClass *klass, MonoError *error)
<span class="lineNum">    5180 </span>            : {
<span class="lineNum">    5181 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5182 </span>            : 
<span class="lineNum">    5183 </span>            :         MonoVTable *vtable;
<span class="lineNum">    5184 </span>            : 
<span class="lineNum">    5185 </span><span class="lineCov">     924860 :         vtable = mono_class_vtable (domain, klass);</span>
<span class="lineNum">    5186 </span><span class="lineCov">    2774716 :         g_assert (vtable); /* FIXME don't swallow the error */</span>
<span class="lineNum">    5187 </span>            : 
<span class="lineNum">    5188 </span><span class="lineCov">     924929 :         MonoObject *o = mono_object_new_specific_checked (vtable, error);</span>
<span class="lineNum">    5189 </span><span class="lineCov">     924929 :         return o;</span>
<span class="lineNum">    5190 </span>            : }
<span class="lineNum">    5191 </span>            : 
<span class="lineNum">    5192 </span>            : /**
<span class="lineNum">    5193 </span>            :  * mono_object_new_pinned:
<span class="lineNum">    5194 </span>            :  *
<span class="lineNum">    5195 </span>            :  *   Same as mono_object_new, but the returned object will be pinned.
<span class="lineNum">    5196 </span>            :  * For SGEN, these objects will only be freed at appdomain unload.
<a name="5197"><span class="lineNum">    5197 </span>            :  */</a>
<span class="lineNum">    5198 </span>            : MonoObject *
<span class="lineNum">    5199 </span>            : mono_object_new_pinned (MonoDomain *domain, MonoClass *klass, MonoError *error)
<span class="lineNum">    5200 </span>            : {
<span class="lineNum">    5201 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5202 </span>            : 
<span class="lineNum">    5203 </span>            :         MonoVTable *vtable;
<span class="lineNum">    5204 </span>            : 
<span class="lineNum">    5205 </span><span class="lineCov">    4926213 :         mono_error_init (error);</span>
<span class="lineNum">    5206 </span>            : 
<span class="lineNum">    5207 </span><span class="lineCov">    4926213 :         vtable = mono_class_vtable (domain, klass);</span>
<span class="lineNum">    5208 </span><span class="lineCov">   14778639 :         g_assert (vtable); /* FIXME don't swallow the error */</span>
<span class="lineNum">    5209 </span>            : 
<span class="lineNum">    5210 </span><span class="lineCov">    4926213 :         MonoObject *o = (MonoObject *)mono_gc_alloc_pinned_obj (vtable, mono_class_instance_size (klass));</span>
<span class="lineNum">    5211 </span>            : 
<span class="lineNum">    5212 </span><span class="lineCov">    4926213 :         if (G_UNLIKELY (!o))</span>
<span class="lineNum">    5213 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, mono_class_instance_size (klass));</span>
<span class="lineNum">    5214 </span><span class="lineCov">    4926213 :         else if (G_UNLIKELY (vtable-&gt;klass-&gt;has_finalize))</span>
<span class="lineNum">    5215 </span><span class="lineCov">       3538 :                 mono_object_register_finalizer (o);</span>
<span class="lineNum">    5216 </span>            : 
<span class="lineNum">    5217 </span><span class="lineCov">    4926213 :         return o;</span>
<span class="lineNum">    5218 </span>            : }
<span class="lineNum">    5219 </span>            : 
<span class="lineNum">    5220 </span>            : /**
<span class="lineNum">    5221 </span>            :  * mono_object_new_specific:
<span class="lineNum">    5222 </span>            :  * @vtable: the vtable of the object that we want to create
<span class="lineNum">    5223 </span>            :  *
<span class="lineNum">    5224 </span>            :  * Returns: A newly created object with class and domain specified
<span class="lineNum">    5225 </span>            :  * by @vtable
<a name="5226"><span class="lineNum">    5226 </span>            :  */</a>
<span class="lineNum">    5227 </span>            : MonoObject *
<span class="lineNum">    5228 </span>            : mono_object_new_specific (MonoVTable *vtable)
<span class="lineNum">    5229 </span>            : {
<span class="lineNum">    5230 </span>            :         MonoError error;
<span class="lineNum">    5231 </span><span class="lineNoCov">          0 :         MonoObject *o = mono_object_new_specific_checked (vtable, &amp;error);</span>
<span class="lineNum">    5232 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5233 </span>            : 
<span class="lineNum">    5234 </span><span class="lineNoCov">          0 :         return o;</span>
<span class="lineNum">    5235 </span>            : }
<a name="5236"><span class="lineNum">    5236 </span>            : </a>
<span class="lineNum">    5237 </span>            : MonoObject *
<span class="lineNum">    5238 </span>            : mono_object_new_specific_checked (MonoVTable *vtable, MonoError *error)
<span class="lineNum">    5239 </span>            : {
<span class="lineNum">    5240 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5241 </span>            : 
<span class="lineNum">    5242 </span>            :         MonoObject *o;
<span class="lineNum">    5243 </span>            : 
<span class="lineNum">    5244 </span><span class="lineCov">    4981323 :         mono_error_init (error);</span>
<span class="lineNum">    5245 </span>            : 
<span class="lineNum">    5246 </span>            :         /* check for is_com_object for COM Interop */
<span class="lineNum">    5247 </span><span class="lineCov">    9962603 :         if (mono_vtable_is_remote (vtable) || mono_class_is_com_object (vtable-&gt;klass))</span>
<span class="lineNum">    5248 </span>            :         {
<span class="lineNum">    5249 </span>            :                 gpointer pa [1];
<span class="lineNum">    5250 </span><span class="lineCov">         17 :                 MonoMethod *im = vtable-&gt;domain-&gt;create_proxy_for_type_method;</span>
<span class="lineNum">    5251 </span>            : 
<span class="lineNum">    5252 </span><span class="lineCov">         17 :                 if (im == NULL) {</span>
<span class="lineNum">    5253 </span><span class="lineCov">         11 :                         MonoClass *klass = mono_class_get_activation_services_class ();</span>
<span class="lineNum">    5254 </span>            : 
<span class="lineNum">    5255 </span><span class="lineCov">         11 :                         if (!klass-&gt;inited)</span>
<span class="lineNum">    5256 </span><span class="lineCov">         10 :                                 mono_class_init (klass);</span>
<span class="lineNum">    5257 </span>            : 
<span class="lineNum">    5258 </span><span class="lineCov">         11 :                         im = mono_class_get_method_from_name (klass, &quot;CreateProxyForType&quot;, 1);</span>
<span class="lineNum">    5259 </span><span class="lineCov">         11 :                         if (!im) {</span>
<span class="lineNum">    5260 </span><span class="lineNoCov">          0 :                                 mono_error_set_not_supported (error, &quot;Linked away.&quot;);</span>
<span class="lineNum">    5261 </span><span class="lineNoCov">          0 :                                 return NULL;</span>
<span class="lineNum">    5262 </span>            :                         }
<span class="lineNum">    5263 </span><span class="lineCov">         11 :                         vtable-&gt;domain-&gt;create_proxy_for_type_method = im;</span>
<span class="lineNum">    5264 </span><span class="lineCov">         11 :                 }</span>
<span class="lineNum">    5265 </span>            :         
<span class="lineNum">    5266 </span><span class="lineCov">         17 :                 pa [0] = mono_type_get_object_checked (mono_domain_get (), &amp;vtable-&gt;klass-&gt;byval_arg, error);</span>
<span class="lineNum">    5267 </span><span class="lineCov">         17 :                 if (!mono_error_ok (error))</span>
<span class="lineNum">    5268 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    5269 </span>            : 
<span class="lineNum">    5270 </span><span class="lineCov">         17 :                 o = mono_runtime_invoke_checked (im, NULL, pa, error);</span>
<span class="lineNum">    5271 </span><span class="lineCov">         17 :                 if (!mono_error_ok (error))</span>
<span class="lineNum">    5272 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    5273 </span>            : 
<span class="lineNum">    5274 </span><span class="lineCov">         17 :                 if (o != NULL)</span>
<span class="lineNum">    5275 </span><span class="lineCov">         17 :                         return o;</span>
<span class="lineNum">    5276 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5277 </span>            : 
<span class="lineNum">    5278 </span><span class="lineCov">    4981274 :         return mono_object_new_alloc_specific_checked (vtable, error);</span>
<span class="lineNum">    5279 </span><span class="lineCov">    4981672 : }</span>
<a name="5280"><span class="lineNum">    5280 </span>            : </a>
<span class="lineNum">    5281 </span>            : MonoObject *
<span class="lineNum">    5282 </span>            : ves_icall_object_new_specific (MonoVTable *vtable)
<span class="lineNum">    5283 </span>            : {
<span class="lineNum">    5284 </span>            :         MonoError error;
<span class="lineNum">    5285 </span><span class="lineCov">    4056437 :         MonoObject *o = mono_object_new_specific_checked (vtable, &amp;error);</span>
<span class="lineNum">    5286 </span><span class="lineCov">    4056437 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    5287 </span>            : 
<span class="lineNum">    5288 </span><span class="lineCov">    4056437 :         return o;</span>
<span class="lineNum">    5289 </span>            : }
<span class="lineNum">    5290 </span>            : 
<span class="lineNum">    5291 </span>            : /**
<span class="lineNum">    5292 </span>            :  * mono_object_new_alloc_specific:
<span class="lineNum">    5293 </span>            :  * @vtable: virtual table for the object.
<span class="lineNum">    5294 </span>            :  *
<span class="lineNum">    5295 </span>            :  * This function allocates a new `MonoObject` with the type derived
<span class="lineNum">    5296 </span>            :  * from the @vtable information.   If the class of this object has a 
<span class="lineNum">    5297 </span>            :  * finalizer, then the object will be tracked for finalization.
<span class="lineNum">    5298 </span>            :  *
<span class="lineNum">    5299 </span>            :  * This method might raise an exception on errors.  Use the
<span class="lineNum">    5300 </span>            :  * `mono_object_new_fast_checked` method if you want to manually raise
<span class="lineNum">    5301 </span>            :  * the exception.
<span class="lineNum">    5302 </span>            :  *
<span class="lineNum">    5303 </span>            :  * Returns: the allocated object.   
<a name="5304"><span class="lineNum">    5304 </span>            :  */</a>
<span class="lineNum">    5305 </span>            : MonoObject *
<span class="lineNum">    5306 </span>            : mono_object_new_alloc_specific (MonoVTable *vtable)
<span class="lineNum">    5307 </span>            : {
<span class="lineNum">    5308 </span>            :         MonoError error;
<span class="lineNum">    5309 </span><span class="lineNoCov">          0 :         MonoObject *o = mono_object_new_alloc_specific_checked (vtable, &amp;error);</span>
<span class="lineNum">    5310 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5311 </span>            : 
<span class="lineNum">    5312 </span><span class="lineNoCov">          0 :         return o;</span>
<span class="lineNum">    5313 </span>            : }
<span class="lineNum">    5314 </span>            : 
<span class="lineNum">    5315 </span>            : /**
<span class="lineNum">    5316 </span>            :  * mono_object_new_alloc_specific_checked:
<span class="lineNum">    5317 </span>            :  * @vtable: virtual table for the object.
<span class="lineNum">    5318 </span>            :  * @error: holds the error return value.  
<span class="lineNum">    5319 </span>            :  *
<span class="lineNum">    5320 </span>            :  * This function allocates a new `MonoObject` with the type derived
<span class="lineNum">    5321 </span>            :  * from the @vtable information. If the class of this object has a 
<span class="lineNum">    5322 </span>            :  * finalizer, then the object will be tracked for finalization.
<span class="lineNum">    5323 </span>            :  *
<span class="lineNum">    5324 </span>            :  * If there is not enough memory, the @error parameter will be set
<span class="lineNum">    5325 </span>            :  * and will contain a user-visible message with the amount of bytes
<span class="lineNum">    5326 </span>            :  * that were requested.
<span class="lineNum">    5327 </span>            :  *
<span class="lineNum">    5328 </span>            :  * Returns: the allocated object, or NULL if there is not enough memory
<span class="lineNum">    5329 </span>            :  *
<a name="5330"><span class="lineNum">    5330 </span>            :  */</a>
<span class="lineNum">    5331 </span>            : MonoObject *
<span class="lineNum">    5332 </span>            : mono_object_new_alloc_specific_checked (MonoVTable *vtable, MonoError *error)
<span class="lineNum">    5333 </span>            : {
<span class="lineNum">    5334 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5335 </span>            : 
<span class="lineNum">    5336 </span>            :         MonoObject *o;
<span class="lineNum">    5337 </span>            : 
<span class="lineNum">    5338 </span><span class="lineCov">    4994144 :         mono_error_init (error);</span>
<span class="lineNum">    5339 </span>            : 
<span class="lineNum">    5340 </span><span class="lineCov">    4994144 :         o = (MonoObject *)mono_gc_alloc_obj (vtable, vtable-&gt;klass-&gt;instance_size);</span>
<span class="lineNum">    5341 </span>            : 
<span class="lineNum">    5342 </span><span class="lineCov">    4994144 :         if (G_UNLIKELY (!o))</span>
<span class="lineNum">    5343 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, vtable-&gt;klass-&gt;instance_size);</span>
<span class="lineNum">    5344 </span><span class="lineCov">    4994348 :         else if (G_UNLIKELY (vtable-&gt;klass-&gt;has_finalize))</span>
<span class="lineNum">    5345 </span><span class="lineCov">    3925218 :                 mono_object_register_finalizer (o);</span>
<span class="lineNum">    5346 </span>            : 
<span class="lineNum">    5347 </span><span class="lineCov">    4994293 :         return o;</span>
<span class="lineNum">    5348 </span>            : }
<span class="lineNum">    5349 </span>            : 
<span class="lineNum">    5350 </span>            : /**
<span class="lineNum">    5351 </span>            :  * mono_object_new_fast:
<span class="lineNum">    5352 </span>            :  * @vtable: virtual table for the object.
<span class="lineNum">    5353 </span>            :  *
<span class="lineNum">    5354 </span>            :  * This function allocates a new `MonoObject` with the type derived
<span class="lineNum">    5355 </span>            :  * from the @vtable information.   The returned object is not tracked
<span class="lineNum">    5356 </span>            :  * for finalization.   If your object implements a finalizer, you should
<span class="lineNum">    5357 </span>            :  * use `mono_object_new_alloc_specific` instead.
<span class="lineNum">    5358 </span>            :  *
<span class="lineNum">    5359 </span>            :  * This method might raise an exception on errors.  Use the
<span class="lineNum">    5360 </span>            :  * `mono_object_new_fast_checked` method if you want to manually raise
<span class="lineNum">    5361 </span>            :  * the exception.
<span class="lineNum">    5362 </span>            :  *
<span class="lineNum">    5363 </span>            :  * Returns: the allocated object.   
<a name="5364"><span class="lineNum">    5364 </span>            :  */</a>
<span class="lineNum">    5365 </span>            : MonoObject*
<span class="lineNum">    5366 </span>            : mono_object_new_fast (MonoVTable *vtable)
<span class="lineNum">    5367 </span>            : {
<span class="lineNum">    5368 </span>            :         MonoError error;
<span class="lineNum">    5369 </span><span class="lineNoCov">          0 :         MonoObject *o = mono_object_new_fast_checked (vtable, &amp;error);</span>
<span class="lineNum">    5370 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5371 </span>            : 
<span class="lineNum">    5372 </span><span class="lineNoCov">          0 :         return o;</span>
<span class="lineNum">    5373 </span>            : }
<span class="lineNum">    5374 </span>            : 
<span class="lineNum">    5375 </span>            : /**
<span class="lineNum">    5376 </span>            :  * mono_object_new_fast_checked:
<span class="lineNum">    5377 </span>            :  * @vtable: virtual table for the object.
<span class="lineNum">    5378 </span>            :  * @error: holds the error return value.
<span class="lineNum">    5379 </span>            :  *
<span class="lineNum">    5380 </span>            :  * This function allocates a new `MonoObject` with the type derived
<span class="lineNum">    5381 </span>            :  * from the @vtable information. The returned object is not tracked
<span class="lineNum">    5382 </span>            :  * for finalization.   If your object implements a finalizer, you should
<span class="lineNum">    5383 </span>            :  * use `mono_object_new_alloc_specific_checked` instead.
<span class="lineNum">    5384 </span>            :  *
<span class="lineNum">    5385 </span>            :  * If there is not enough memory, the @error parameter will be set
<span class="lineNum">    5386 </span>            :  * and will contain a user-visible message with the amount of bytes
<span class="lineNum">    5387 </span>            :  * that were requested.
<span class="lineNum">    5388 </span>            :  *
<span class="lineNum">    5389 </span>            :  * Returns: the allocated object, or NULL if there is not enough memory
<span class="lineNum">    5390 </span>            :  *
<a name="5391"><span class="lineNum">    5391 </span>            :  */</a>
<span class="lineNum">    5392 </span>            : MonoObject*
<span class="lineNum">    5393 </span>            : mono_object_new_fast_checked (MonoVTable *vtable, MonoError *error)
<span class="lineNum">    5394 </span>            : {
<span class="lineNum">    5395 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5396 </span>            : 
<span class="lineNum">    5397 </span>            :         MonoObject *o;
<span class="lineNum">    5398 </span>            : 
<span class="lineNum">    5399 </span><span class="lineCov">    2020460 :         mono_error_init (error);</span>
<span class="lineNum">    5400 </span>            : 
<span class="lineNum">    5401 </span><span class="lineCov">    2020460 :         o = mono_gc_alloc_obj (vtable, vtable-&gt;klass-&gt;instance_size);</span>
<span class="lineNum">    5402 </span>            : 
<span class="lineNum">    5403 </span><span class="lineCov">    2020460 :         if (G_UNLIKELY (!o))</span>
<span class="lineNum">    5404 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, vtable-&gt;klass-&gt;instance_size);</span>
<span class="lineNum">    5405 </span>            : 
<span class="lineNum">    5406 </span><span class="lineCov">    2020460 :         return o;</span>
<span class="lineNum">    5407 </span>            : }
<a name="5408"><span class="lineNum">    5408 </span>            : </a>
<span class="lineNum">    5409 </span>            : MonoObject *
<span class="lineNum">    5410 </span>            : ves_icall_object_new_fast (MonoVTable *vtable)
<span class="lineNum">    5411 </span>            : {
<span class="lineNum">    5412 </span>            :         MonoError error;
<span class="lineNum">    5413 </span><span class="lineCov">    2008170 :         MonoObject *o = mono_object_new_fast_checked (vtable, &amp;error);</span>
<span class="lineNum">    5414 </span><span class="lineCov">    2008170 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    5415 </span>            : 
<span class="lineNum">    5416 </span><span class="lineCov">    2008170 :         return o;</span>
<span class="lineNum">    5417 </span>            : }
<a name="5418"><span class="lineNum">    5418 </span>            : </a>
<span class="lineNum">    5419 </span>            : MonoObject*
<span class="lineNum">    5420 </span>            : mono_object_new_mature (MonoVTable *vtable, MonoError *error)
<span class="lineNum">    5421 </span>            : {
<span class="lineNum">    5422 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5423 </span>            : 
<span class="lineNum">    5424 </span>            :         MonoObject *o;
<span class="lineNum">    5425 </span>            : 
<span class="lineNum">    5426 </span><span class="lineCov">      39830 :         mono_error_init (error);</span>
<span class="lineNum">    5427 </span>            : 
<span class="lineNum">    5428 </span><span class="lineCov">      39830 :         o = mono_gc_alloc_mature (vtable, vtable-&gt;klass-&gt;instance_size);</span>
<span class="lineNum">    5429 </span>            : 
<span class="lineNum">    5430 </span><span class="lineCov">      39830 :         if (G_UNLIKELY (!o))</span>
<span class="lineNum">    5431 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, vtable-&gt;klass-&gt;instance_size);</span>
<span class="lineNum">    5432 </span><span class="lineCov">      39830 :         else if (G_UNLIKELY (vtable-&gt;klass-&gt;has_finalize))</span>
<span class="lineNum">    5433 </span><span class="lineCov">      39830 :                 mono_object_register_finalizer (o);</span>
<span class="lineNum">    5434 </span>            : 
<span class="lineNum">    5435 </span><span class="lineCov">      39830 :         return o;</span>
<span class="lineNum">    5436 </span>            : }
<span class="lineNum">    5437 </span>            : 
<span class="lineNum">    5438 </span>            : /**
<span class="lineNum">    5439 </span>            :  * mono_class_get_allocation_ftn:
<span class="lineNum">    5440 </span>            :  * @vtable: vtable
<span class="lineNum">    5441 </span>            :  * @for_box: the object will be used for boxing
<span class="lineNum">    5442 </span>            :  * @pass_size_in_words: 
<span class="lineNum">    5443 </span>            :  *
<span class="lineNum">    5444 </span>            :  * Return the allocation function appropriate for the given class.
<span class="lineNum">    5445 </span>            :  */
<a name="5446"><span class="lineNum">    5446 </span>            : </a>
<span class="lineNum">    5447 </span>            : void*
<span class="lineNum">    5448 </span>            : mono_class_get_allocation_ftn (MonoVTable *vtable, gboolean for_box, gboolean *pass_size_in_words)
<span class="lineNum">    5449 </span>            : {
<span class="lineNum">    5450 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    5451 </span>            : 
<span class="lineNum">    5452 </span><span class="lineCov">      78801 :         *pass_size_in_words = FALSE;</span>
<span class="lineNum">    5453 </span>            : 
<span class="lineNum">    5454 </span><span class="lineCov">     117560 :         if (mono_class_has_finalizer (vtable-&gt;klass) || mono_class_is_marshalbyref (vtable-&gt;klass))</span>
<span class="lineNum">    5455 </span><span class="lineCov">      78670 :                 return ves_icall_object_new_specific;</span>
<span class="lineNum">    5456 </span>            : 
<span class="lineNum">    5457 </span><span class="lineCov">        130 :         if (vtable-&gt;gc_descr != MONO_GC_DESCRIPTOR_NULL) {</span>
<span class="lineNum">    5458 </span>            : 
<span class="lineNum">    5459 </span><span class="lineCov">        130 :                 return ves_icall_object_new_fast;</span>
<span class="lineNum">    5460 </span>            : 
<span class="lineNum">    5461 </span>            :                 /* 
<span class="lineNum">    5462 </span>            :                  * FIXME: This is actually slower than ves_icall_object_new_fast, because
<span class="lineNum">    5463 </span>            :                  * of the overhead of parameter passing.
<span class="lineNum">    5464 </span>            :                  */
<span class="lineNum">    5465 </span>            :                 /*
<span class="lineNum">    5466 </span>            :                 *pass_size_in_words = TRUE;
<span class="lineNum">    5467 </span>            : #ifdef GC_REDIRECT_TO_LOCAL
<span class="lineNum">    5468 </span>            :                 return GC_local_gcj_fast_malloc;
<span class="lineNum">    5469 </span>            : #else
<span class="lineNum">    5470 </span>            :                 return GC_gcj_fast_malloc;
<span class="lineNum">    5471 </span>            : #endif
<span class="lineNum">    5472 </span>            :                 */
<span class="lineNum">    5473 </span>            :         }
<span class="lineNum">    5474 </span>            : 
<span class="lineNum">    5475 </span><span class="lineNoCov">          0 :         return ves_icall_object_new_specific;</span>
<span class="lineNum">    5476 </span><span class="lineCov">      78800 : }</span>
<span class="lineNum">    5477 </span>            : 
<span class="lineNum">    5478 </span>            : /**
<span class="lineNum">    5479 </span>            :  * mono_object_new_from_token:
<span class="lineNum">    5480 </span>            :  * @image: Context where the type_token is hosted
<span class="lineNum">    5481 </span>            :  * @token: a token of the type that we want to create
<span class="lineNum">    5482 </span>            :  *
<span class="lineNum">    5483 </span>            :  * Returns: A newly created object whose definition is
<span class="lineNum">    5484 </span>            :  * looked up using @token in the @image image
<a name="5485"><span class="lineNum">    5485 </span>            :  */</a>
<span class="lineNum">    5486 </span>            : MonoObject *
<span class="lineNum">    5487 </span>            : mono_object_new_from_token  (MonoDomain *domain, MonoImage *image, guint32 token)
<span class="lineNum">    5488 </span>            : {
<span class="lineNum">    5489 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5490 </span>            : 
<span class="lineNum">    5491 </span>            :         MonoError error;
<span class="lineNum">    5492 </span>            :         MonoObject *result;
<span class="lineNum">    5493 </span>            :         MonoClass *klass;
<span class="lineNum">    5494 </span>            : 
<span class="lineNum">    5495 </span><span class="lineNoCov">          0 :         klass = mono_class_get_checked (image, token, &amp;error);</span>
<span class="lineNum">    5496 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    5497 </span>            :         
<span class="lineNum">    5498 </span><span class="lineNoCov">          0 :         result = mono_object_new_checked (domain, klass, &amp;error);</span>
<span class="lineNum">    5499 </span>            : 
<span class="lineNum">    5500 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5501 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    5502 </span>            :         
<span class="lineNum">    5503 </span>            : }
<span class="lineNum">    5504 </span>            : 
<span class="lineNum">    5505 </span>            : 
<span class="lineNum">    5506 </span>            : /**
<span class="lineNum">    5507 </span>            :  * mono_object_clone:
<span class="lineNum">    5508 </span>            :  * @obj: the object to clone
<span class="lineNum">    5509 </span>            :  *
<span class="lineNum">    5510 </span>            :  * Returns: A newly created object who is a shallow copy of @obj
<a name="5511"><span class="lineNum">    5511 </span>            :  */</a>
<span class="lineNum">    5512 </span>            : MonoObject *
<span class="lineNum">    5513 </span>            : mono_object_clone (MonoObject *obj)
<span class="lineNum">    5514 </span>            : {
<span class="lineNum">    5515 </span>            :         MonoError error;
<span class="lineNum">    5516 </span><span class="lineNoCov">          0 :         MonoObject *o = mono_object_clone_checked (obj, &amp;error);</span>
<span class="lineNum">    5517 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5518 </span>            : 
<span class="lineNum">    5519 </span><span class="lineNoCov">          0 :         return o;</span>
<span class="lineNum">    5520 </span>            : }
<a name="5521"><span class="lineNum">    5521 </span>            : </a>
<span class="lineNum">    5522 </span>            : MonoObject *
<span class="lineNum">    5523 </span>            : mono_object_clone_checked (MonoObject *obj, MonoError *error)
<span class="lineNum">    5524 </span>            : {
<span class="lineNum">    5525 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5526 </span>            : 
<span class="lineNum">    5527 </span>            :         MonoObject *o;
<span class="lineNum">    5528 </span>            :         int size;
<span class="lineNum">    5529 </span>            : 
<span class="lineNum">    5530 </span><span class="lineCov">       8912 :         mono_error_init (error);</span>
<span class="lineNum">    5531 </span>            : 
<span class="lineNum">    5532 </span><span class="lineCov">       8912 :         size = obj-&gt;vtable-&gt;klass-&gt;instance_size;</span>
<span class="lineNum">    5533 </span>            : 
<span class="lineNum">    5534 </span><span class="lineCov">       8912 :         if (obj-&gt;vtable-&gt;klass-&gt;rank)</span>
<span class="lineNum">    5535 </span><span class="lineNoCov">          0 :                 return (MonoObject*)mono_array_clone_checked ((MonoArray*)obj, error);</span>
<span class="lineNum">    5536 </span>            : 
<span class="lineNum">    5537 </span><span class="lineCov">       8912 :         o = (MonoObject *)mono_gc_alloc_obj (obj-&gt;vtable, size);</span>
<span class="lineNum">    5538 </span>            : 
<span class="lineNum">    5539 </span><span class="lineCov">       8912 :         if (G_UNLIKELY (!o)) {</span>
<span class="lineNum">    5540 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, size);</span>
<span class="lineNum">    5541 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    5542 </span>            :         }
<span class="lineNum">    5543 </span>            : 
<span class="lineNum">    5544 </span>            :         /* If the object doesn't contain references this will do a simple memmove. */
<span class="lineNum">    5545 </span><span class="lineCov">       8912 :         mono_gc_wbarrier_object_copy (o, obj);</span>
<span class="lineNum">    5546 </span>            : 
<span class="lineNum">    5547 </span><span class="lineCov">       8912 :         if (obj-&gt;vtable-&gt;klass-&gt;has_finalize)</span>
<span class="lineNum">    5548 </span><span class="lineNoCov">          0 :                 mono_object_register_finalizer (o);</span>
<span class="lineNum">    5549 </span><span class="lineCov">       8912 :         return o;</span>
<span class="lineNum">    5550 </span><span class="lineCov">       8912 : }</span>
<span class="lineNum">    5551 </span>            : 
<span class="lineNum">    5552 </span>            : /**
<span class="lineNum">    5553 </span>            :  * mono_array_full_copy:
<span class="lineNum">    5554 </span>            :  * @src: source array to copy
<span class="lineNum">    5555 </span>            :  * @dest: destination array
<span class="lineNum">    5556 </span>            :  *
<span class="lineNum">    5557 </span>            :  * Copies the content of one array to another with exactly the same type and size.
<a name="5558"><span class="lineNum">    5558 </span>            :  */</a>
<span class="lineNum">    5559 </span>            : void
<span class="lineNum">    5560 </span>            : mono_array_full_copy (MonoArray *src, MonoArray *dest)
<span class="lineNum">    5561 </span>            : {
<span class="lineNum">    5562 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5563 </span>            : 
<span class="lineNum">    5564 </span>            :         uintptr_t size;
<span class="lineNum">    5565 </span><span class="lineCov">          1 :         MonoClass *klass = src-&gt;obj.vtable-&gt;klass;</span>
<span class="lineNum">    5566 </span>            : 
<span class="lineNum">    5567 </span><span class="lineCov">          3 :         g_assert (klass == dest-&gt;obj.vtable-&gt;klass);</span>
<span class="lineNum">    5568 </span>            : 
<span class="lineNum">    5569 </span><span class="lineCov">          1 :         size = mono_array_length (src);</span>
<span class="lineNum">    5570 </span><span class="lineCov">          3 :         g_assert (size == mono_array_length (dest));</span>
<span class="lineNum">    5571 </span><span class="lineCov">          1 :         size *= mono_array_element_size (klass);</span>
<span class="lineNum">    5572 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">    5573 </span><span class="lineCov">          1 :         if (klass-&gt;element_class-&gt;valuetype) {</span>
<span class="lineNum">    5574 </span><span class="lineCov">          1 :                 if (klass-&gt;element_class-&gt;has_references)</span>
<span class="lineNum">    5575 </span><span class="lineNoCov">          0 :                         mono_value_copy_array (dest, 0, mono_array_addr_with_size_fast (src, 0, 0), mono_array_length (src));</span>
<span class="lineNum">    5576 </span>            :                 else
<span class="lineNum">    5577 </span><span class="lineCov">          1 :                         mono_gc_memmove_atomic (&amp;dest-&gt;vector, &amp;src-&gt;vector, size);</span>
<span class="lineNum">    5578 </span><span class="lineCov">          1 :         } else {</span>
<span class="lineNum">    5579 </span><span class="lineNoCov">          0 :                 mono_array_memcpy_refs (dest, 0, src, 0, mono_array_length (src));</span>
<span class="lineNum">    5580 </span>            :         }
<span class="lineNum">    5581 </span>            : #else
<span class="lineNum">    5582 </span>            :         mono_gc_memmove_atomic (&amp;dest-&gt;vector, &amp;src-&gt;vector, size);
<span class="lineNum">    5583 </span>            : #endif
<span class="lineNum">    5584 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    5585 </span>            : 
<span class="lineNum">    5586 </span>            : /**
<span class="lineNum">    5587 </span>            :  * mono_array_clone_in_domain:
<span class="lineNum">    5588 </span>            :  * @domain: the domain in which the array will be cloned into
<span class="lineNum">    5589 </span>            :  * @array: the array to clone
<span class="lineNum">    5590 </span>            :  * @error: set on error
<span class="lineNum">    5591 </span>            :  *
<span class="lineNum">    5592 </span>            :  * This routine returns a copy of the array that is hosted on the
<span class="lineNum">    5593 </span>            :  * specified MonoDomain.  On failure returns NULL and sets @error.
<a name="5594"><span class="lineNum">    5594 </span>            :  */</a>
<span class="lineNum">    5595 </span>            : MonoArray*
<span class="lineNum">    5596 </span>            : mono_array_clone_in_domain (MonoDomain *domain, MonoArray *array, MonoError *error)
<span class="lineNum">    5597 </span>            : {
<span class="lineNum">    5598 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5599 </span>            : 
<span class="lineNum">    5600 </span>            :         MonoArray *o;
<span class="lineNum">    5601 </span>            :         uintptr_t size, i;
<span class="lineNum">    5602 </span>            :         uintptr_t *sizes;
<span class="lineNum">    5603 </span><span class="lineCov">     359992 :         MonoClass *klass = array-&gt;obj.vtable-&gt;klass;</span>
<span class="lineNum">    5604 </span>            : 
<span class="lineNum">    5605 </span><span class="lineCov">     359992 :         mono_error_init (error);</span>
<span class="lineNum">    5606 </span>            : 
<span class="lineNum">    5607 </span><span class="lineCov">     359992 :         if (array-&gt;bounds == NULL) {</span>
<span class="lineNum">    5608 </span><span class="lineCov">     359977 :                 size = mono_array_length (array);</span>
<span class="lineNum">    5609 </span><span class="lineCov">     359977 :                 o = mono_array_new_full_checked (domain, klass, &amp;size, NULL, error);</span>
<span class="lineNum">    5610 </span><span class="lineCov">    1079926 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5611 </span>            : 
<span class="lineNum">    5612 </span><span class="lineCov">     359980 :                 size *= mono_array_element_size (klass);</span>
<span class="lineNum">    5613 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">    5614 </span><span class="lineCov">     359980 :                 if (klass-&gt;element_class-&gt;valuetype) {</span>
<span class="lineNum">    5615 </span><span class="lineCov">     237459 :                         if (klass-&gt;element_class-&gt;has_references)</span>
<span class="lineNum">    5616 </span><span class="lineNoCov">          0 :                                 mono_value_copy_array (o, 0, mono_array_addr_with_size_fast (array, 0, 0), mono_array_length (array));</span>
<span class="lineNum">    5617 </span>            :                         else
<span class="lineNum">    5618 </span><span class="lineCov">     237460 :                                 mono_gc_memmove_atomic (&amp;o-&gt;vector, &amp;array-&gt;vector, size);</span>
<span class="lineNum">    5619 </span><span class="lineCov">     237466 :                 } else {</span>
<span class="lineNum">    5620 </span><span class="lineCov">     245023 :                         mono_array_memcpy_refs (o, 0, array, 0, mono_array_length (array));</span>
<span class="lineNum">    5621 </span>            :                 }
<span class="lineNum">    5622 </span>            : #else
<span class="lineNum">    5623 </span>            :                 mono_gc_memmove_atomic (&amp;o-&gt;vector, &amp;array-&gt;vector, size);
<span class="lineNum">    5624 </span>            : #endif
<span class="lineNum">    5625 </span><span class="lineCov">     359993 :                 return o;</span>
<span class="lineNum">    5626 </span>            :         }
<span class="lineNum">    5627 </span>            :         
<span class="lineNum">    5628 </span><span class="lineNoCov">          0 :         sizes = (uintptr_t *)alloca (klass-&gt;rank * sizeof(intptr_t) * 2);</span>
<span class="lineNum">    5629 </span><span class="lineNoCov">          0 :         size = mono_array_element_size (klass);</span>
<span class="lineNum">    5630 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; klass-&gt;rank; ++i) {</span>
<span class="lineNum">    5631 </span><span class="lineNoCov">          0 :                 sizes [i] = array-&gt;bounds [i].length;</span>
<span class="lineNum">    5632 </span><span class="lineNoCov">          0 :                 size *= array-&gt;bounds [i].length;</span>
<span class="lineNum">    5633 </span><span class="lineNoCov">          0 :                 sizes [i + klass-&gt;rank] = array-&gt;bounds [i].lower_bound;</span>
<span class="lineNum">    5634 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    5635 </span><span class="lineNoCov">          0 :         o = mono_array_new_full_checked (domain, klass, sizes, (intptr_t*)sizes + klass-&gt;rank, error);</span>
<span class="lineNum">    5636 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5637 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">    5638 </span><span class="lineNoCov">          0 :         if (klass-&gt;element_class-&gt;valuetype) {</span>
<span class="lineNum">    5639 </span><span class="lineNoCov">          0 :                 if (klass-&gt;element_class-&gt;has_references)</span>
<span class="lineNum">    5640 </span><span class="lineNoCov">          0 :                         mono_value_copy_array (o, 0, mono_array_addr_with_size_fast (array, 0, 0), mono_array_length (array));</span>
<span class="lineNum">    5641 </span>            :                 else
<span class="lineNum">    5642 </span><span class="lineNoCov">          0 :                         mono_gc_memmove_atomic (&amp;o-&gt;vector, &amp;array-&gt;vector, size);</span>
<span class="lineNum">    5643 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    5644 </span><span class="lineNoCov">          0 :                 mono_array_memcpy_refs (o, 0, array, 0, mono_array_length (array));</span>
<span class="lineNum">    5645 </span>            :         }
<span class="lineNum">    5646 </span>            : #else
<span class="lineNum">    5647 </span>            :         mono_gc_memmove_atomic (&amp;o-&gt;vector, &amp;array-&gt;vector, size);
<span class="lineNum">    5648 </span>            : #endif
<span class="lineNum">    5649 </span>            : 
<span class="lineNum">    5650 </span><span class="lineNoCov">          0 :         return o;</span>
<span class="lineNum">    5651 </span><span class="lineCov">     359979 : }</span>
<span class="lineNum">    5652 </span>            : 
<span class="lineNum">    5653 </span>            : /**
<span class="lineNum">    5654 </span>            :  * mono_array_clone:
<span class="lineNum">    5655 </span>            :  * @array: the array to clone
<span class="lineNum">    5656 </span>            :  *
<span class="lineNum">    5657 </span>            :  * Returns: A newly created array who is a shallow copy of @array
<a name="5658"><span class="lineNum">    5658 </span>            :  */</a>
<span class="lineNum">    5659 </span>            : MonoArray*
<span class="lineNum">    5660 </span>            : mono_array_clone (MonoArray *array)
<span class="lineNum">    5661 </span>            : {
<span class="lineNum">    5662 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5663 </span>            : 
<span class="lineNum">    5664 </span>            :         MonoError error;
<span class="lineNum">    5665 </span><span class="lineNoCov">          0 :         MonoArray *result = mono_array_clone_checked (array, &amp;error);</span>
<span class="lineNum">    5666 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5667 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    5668 </span>            : }
<span class="lineNum">    5669 </span>            : 
<span class="lineNum">    5670 </span>            : /**
<span class="lineNum">    5671 </span>            :  * mono_array_clone_checked:
<span class="lineNum">    5672 </span>            :  * @array: the array to clone
<span class="lineNum">    5673 </span>            :  * @error: set on error
<span class="lineNum">    5674 </span>            :  *
<span class="lineNum">    5675 </span>            :  * Returns: A newly created array who is a shallow copy of @array.  On
<span class="lineNum">    5676 </span>            :  * failure returns NULL and sets @error.
<a name="5677"><span class="lineNum">    5677 </span>            :  */</a>
<span class="lineNum">    5678 </span>            : MonoArray*
<span class="lineNum">    5679 </span>            : mono_array_clone_checked (MonoArray *array, MonoError *error)
<span class="lineNum">    5680 </span>            : {
<span class="lineNum">    5681 </span>            : 
<span class="lineNum">    5682 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5683 </span><span class="lineCov">     357797 :         return mono_array_clone_in_domain (((MonoObject *)array)-&gt;vtable-&gt;domain, array, error);</span>
<span class="lineNum">    5684 </span>            : }
<span class="lineNum">    5685 </span>            : 
<span class="lineNum">    5686 </span>            : /* helper macros to check for overflow when calculating the size of arrays */
<span class="lineNum">    5687 </span>            : #ifdef MONO_BIG_ARRAYS
<span class="lineNum">    5688 </span>            : #define MYGUINT64_MAX 0x0000FFFFFFFFFFFFUL
<span class="lineNum">    5689 </span>            : #define MYGUINT_MAX MYGUINT64_MAX
<span class="lineNum">    5690 </span>            : #define CHECK_ADD_OVERFLOW_UN(a,b) \
<span class="lineNum">    5691 </span>            :             (G_UNLIKELY ((guint64)(MYGUINT64_MAX) - (guint64)(b) &lt; (guint64)(a)))
<span class="lineNum">    5692 </span>            : #define CHECK_MUL_OVERFLOW_UN(a,b) \
<span class="lineNum">    5693 </span>            :             (G_UNLIKELY (((guint64)(a) &gt; 0) &amp;&amp; ((guint64)(b) &gt; 0) &amp;&amp;      \
<span class="lineNum">    5694 </span>            :                                          ((guint64)(b) &gt; ((MYGUINT64_MAX) / (guint64)(a)))))
<span class="lineNum">    5695 </span>            : #else
<span class="lineNum">    5696 </span>            : #define MYGUINT32_MAX 4294967295U
<span class="lineNum">    5697 </span>            : #define MYGUINT_MAX MYGUINT32_MAX
<span class="lineNum">    5698 </span>            : #define CHECK_ADD_OVERFLOW_UN(a,b) \
<span class="lineNum">    5699 </span>            :             (G_UNLIKELY ((guint32)(MYGUINT32_MAX) - (guint32)(b) &lt; (guint32)(a)))
<span class="lineNum">    5700 </span>            : #define CHECK_MUL_OVERFLOW_UN(a,b) \
<span class="lineNum">    5701 </span>            :             (G_UNLIKELY (((guint32)(a) &gt; 0) &amp;&amp; ((guint32)(b) &gt; 0) &amp;&amp;                      \
<span class="lineNum">    5702 </span>            :                                          ((guint32)(b) &gt; ((MYGUINT32_MAX) / (guint32)(a)))))
<span class="lineNum">    5703 </span>            : #endif
<a name="5704"><span class="lineNum">    5704 </span>            : </a>
<span class="lineNum">    5705 </span>            : gboolean
<span class="lineNum">    5706 </span>            : mono_array_calc_byte_len (MonoClass *klass, uintptr_t len, uintptr_t *res)
<span class="lineNum">    5707 </span>            : {
<span class="lineNum">    5708 </span>            :         MONO_REQ_GC_NEUTRAL_MODE;
<span class="lineNum">    5709 </span>            : 
<span class="lineNum">    5710 </span>            :         uintptr_t byte_len;
<span class="lineNum">    5711 </span>            : 
<span class="lineNum">    5712 </span><span class="lineCov">    1296005 :         byte_len = mono_array_element_size (klass);</span>
<span class="lineNum">    5713 </span><span class="lineCov">    4784194 :         if (CHECK_MUL_OVERFLOW_UN (byte_len, len))</span>
<span class="lineNum">    5714 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    5715 </span><span class="lineCov">    1295967 :         byte_len *= len;</span>
<span class="lineNum">    5716 </span><span class="lineCov">    1295967 :         if (CHECK_ADD_OVERFLOW_UN (byte_len, MONO_SIZEOF_MONO_ARRAY))</span>
<span class="lineNum">    5717 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    5718 </span><span class="lineCov">    1296022 :         byte_len += MONO_SIZEOF_MONO_ARRAY;</span>
<span class="lineNum">    5719 </span>            : 
<span class="lineNum">    5720 </span><span class="lineCov">    1296022 :         *res = byte_len;</span>
<span class="lineNum">    5721 </span>            : 
<span class="lineNum">    5722 </span><span class="lineCov">    1296022 :         return TRUE;</span>
<span class="lineNum">    5723 </span><span class="lineCov">    1296032 : }</span>
<span class="lineNum">    5724 </span>            : 
<span class="lineNum">    5725 </span>            : /**
<span class="lineNum">    5726 </span>            :  * mono_array_new_full:
<span class="lineNum">    5727 </span>            :  * @domain: domain where the object is created
<span class="lineNum">    5728 </span>            :  * @array_class: array class
<span class="lineNum">    5729 </span>            :  * @lengths: lengths for each dimension in the array
<span class="lineNum">    5730 </span>            :  * @lower_bounds: lower bounds for each dimension in the array (may be NULL)
<span class="lineNum">    5731 </span>            :  *
<span class="lineNum">    5732 </span>            :  * This routine creates a new array objects with the given dimensions,
<span class="lineNum">    5733 </span>            :  * lower bounds and type.
<a name="5734"><span class="lineNum">    5734 </span>            :  */</a>
<span class="lineNum">    5735 </span>            : MonoArray*
<span class="lineNum">    5736 </span>            : mono_array_new_full (MonoDomain *domain, MonoClass *array_class, uintptr_t *lengths, intptr_t *lower_bounds)
<span class="lineNum">    5737 </span>            : {
<span class="lineNum">    5738 </span>            :         MonoError error;
<span class="lineNum">    5739 </span><span class="lineNoCov">          0 :         MonoArray *array = mono_array_new_full_checked (domain, array_class, lengths, lower_bounds, &amp;error);</span>
<span class="lineNum">    5740 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5741 </span>            : 
<span class="lineNum">    5742 </span><span class="lineNoCov">          0 :         return array;</span>
<span class="lineNum">    5743 </span>            : }
<a name="5744"><span class="lineNum">    5744 </span>            : </a>
<span class="lineNum">    5745 </span>            : MonoArray*
<span class="lineNum">    5746 </span>            : mono_array_new_full_checked (MonoDomain *domain, MonoClass *array_class, uintptr_t *lengths, intptr_t *lower_bounds, MonoError *error)
<span class="lineNum">    5747 </span>            : {
<span class="lineNum">    5748 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5749 </span>            : 
<span class="lineNum">    5750 </span><span class="lineCov">     442510 :         uintptr_t byte_len = 0, len, bounds_size;</span>
<span class="lineNum">    5751 </span>            :         MonoObject *o;
<span class="lineNum">    5752 </span>            :         MonoArray *array;
<span class="lineNum">    5753 </span>            :         MonoArrayBounds *bounds;
<span class="lineNum">    5754 </span>            :         MonoVTable *vtable;
<span class="lineNum">    5755 </span>            :         int i;
<span class="lineNum">    5756 </span>            : 
<span class="lineNum">    5757 </span><span class="lineCov">     442510 :         mono_error_init (error);</span>
<span class="lineNum">    5758 </span>            : 
<span class="lineNum">    5759 </span><span class="lineCov">     442510 :         if (!array_class-&gt;inited)</span>
<span class="lineNum">    5760 </span><span class="lineCov">        474 :                 mono_class_init (array_class);</span>
<span class="lineNum">    5761 </span>            : 
<span class="lineNum">    5762 </span><span class="lineCov">     442499 :         len = 1;</span>
<span class="lineNum">    5763 </span>            : 
<span class="lineNum">    5764 </span>            :         /* A single dimensional array with a 0 lower bound is the same as an szarray */
<span class="lineNum">    5765 </span><span class="lineCov">     814843 :         if (array_class-&gt;rank == 1 &amp;&amp; ((array_class-&gt;byval_arg.type == MONO_TYPE_SZARRAY) || (lower_bounds &amp;&amp; lower_bounds [0] == 0))) {</span>
<span class="lineNum">    5766 </span><span class="lineCov">     371840 :                 len = lengths [0];</span>
<span class="lineNum">    5767 </span><span class="lineCov">     371840 :                 if (len &gt; MONO_ARRAY_MAX_INDEX) {</span>
<span class="lineNum">    5768 </span><span class="lineNoCov">          0 :                         mono_error_set_generic_error (error, &quot;System&quot;, &quot;OverflowException&quot;, &quot;&quot;);</span>
<span class="lineNum">    5769 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    5770 </span>            :                 }
<span class="lineNum">    5771 </span><span class="lineCov">     371842 :                 bounds_size = 0;</span>
<span class="lineNum">    5772 </span><span class="lineCov">     371842 :         } else {</span>
<span class="lineNum">    5773 </span><span class="lineCov">      70655 :                 bounds_size = sizeof (MonoArrayBounds) * array_class-&gt;rank;</span>
<span class="lineNum">    5774 </span>            : 
<span class="lineNum">    5775 </span><span class="lineCov">     423557 :                 for (i = 0; i &lt; array_class-&gt;rank; ++i) {</span>
<span class="lineNum">    5776 </span><span class="lineCov">     141417 :                         if (lengths [i] &gt; MONO_ARRAY_MAX_INDEX) {</span>
<span class="lineNum">    5777 </span><span class="lineCov">        200 :                                 mono_error_set_generic_error (error, &quot;System&quot;, &quot;OverflowException&quot;, &quot;&quot;);</span>
<span class="lineNum">    5778 </span><span class="lineCov">        200 :                                 return NULL;</span>
<span class="lineNum">    5779 </span>            :                         }
<span class="lineNum">    5780 </span><span class="lineCov">     564893 :                         if (CHECK_MUL_OVERFLOW_UN (len, lengths [i])) {</span>
<span class="lineNum">    5781 </span><span class="lineCov">        100 :                                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, MONO_ARRAY_MAX_SIZE);</span>
<span class="lineNum">    5782 </span><span class="lineCov">        100 :                                 return NULL;</span>
<span class="lineNum">    5783 </span>            :                         }
<span class="lineNum">    5784 </span><span class="lineCov">     141122 :                         len *= lengths [i];</span>
<span class="lineNum">    5785 </span><span class="lineCov">     141122 :                 }</span>
<span class="lineNum">    5786 </span>            :         }
<span class="lineNum">    5787 </span>            : 
<span class="lineNum">    5788 </span><span class="lineCov">     442204 :         if (!mono_array_calc_byte_len (array_class, len, &amp;byte_len)) {</span>
<span class="lineNum">    5789 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, MONO_ARRAY_MAX_SIZE);</span>
<span class="lineNum">    5790 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    5791 </span>            :         }
<span class="lineNum">    5792 </span>            : 
<span class="lineNum">    5793 </span><span class="lineCov">     442197 :         if (bounds_size) {</span>
<span class="lineNum">    5794 </span>            :                 /* align */
<span class="lineNum">    5795 </span><span class="lineCov">      70361 :                 if (CHECK_ADD_OVERFLOW_UN (byte_len, 3)) {</span>
<span class="lineNum">    5796 </span><span class="lineNoCov">          0 :                         mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, MONO_ARRAY_MAX_SIZE);</span>
<span class="lineNum">    5797 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    5798 </span>            :                 }
<span class="lineNum">    5799 </span><span class="lineCov">      70363 :                 byte_len = (byte_len + 3) &amp; ~3;</span>
<span class="lineNum">    5800 </span><span class="lineCov">      70363 :                 if (CHECK_ADD_OVERFLOW_UN (byte_len, bounds_size)) {</span>
<span class="lineNum">    5801 </span><span class="lineNoCov">          0 :                         mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, MONO_ARRAY_MAX_SIZE);</span>
<span class="lineNum">    5802 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    5803 </span>            :                 }
<span class="lineNum">    5804 </span><span class="lineCov">      70362 :                 byte_len += bounds_size;</span>
<span class="lineNum">    5805 </span><span class="lineCov">      70362 :         }</span>
<span class="lineNum">    5806 </span>            :         /* 
<span class="lineNum">    5807 </span>            :          * Following three lines almost taken from mono_object_new ():
<span class="lineNum">    5808 </span>            :          * they need to be kept in sync.
<span class="lineNum">    5809 </span>            :          */
<span class="lineNum">    5810 </span><span class="lineCov">     442200 :         vtable = mono_class_vtable_full (domain, array_class, error);</span>
<span class="lineNum">    5811 </span><span class="lineCov">    1326656 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5812 </span>            : 
<span class="lineNum">    5813 </span><span class="lineCov">     442230 :         if (bounds_size)</span>
<span class="lineNum">    5814 </span><span class="lineCov">      70359 :                 o = (MonoObject *)mono_gc_alloc_array (vtable, byte_len, len, bounds_size);</span>
<span class="lineNum">    5815 </span>            :         else
<span class="lineNum">    5816 </span><span class="lineCov">     371857 :                 o = (MonoObject *)mono_gc_alloc_vector (vtable, byte_len, len);</span>
<span class="lineNum">    5817 </span>            : 
<span class="lineNum">    5818 </span><span class="lineCov">     442208 :         if (G_UNLIKELY (!o)) {</span>
<span class="lineNum">    5819 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %zd bytes&quot;, (gsize) byte_len);</span>
<span class="lineNum">    5820 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    5821 </span>            :         }
<span class="lineNum">    5822 </span>            : 
<span class="lineNum">    5823 </span><span class="lineCov">     442206 :         array = (MonoArray*)o;</span>
<span class="lineNum">    5824 </span>            : 
<span class="lineNum">    5825 </span><span class="lineCov">     442206 :         bounds = array-&gt;bounds;</span>
<span class="lineNum">    5826 </span>            : 
<span class="lineNum">    5827 </span><span class="lineCov">     442206 :         if (bounds_size) {</span>
<span class="lineNum">    5828 </span><span class="lineCov">     422545 :                 for (i = 0; i &lt; array_class-&gt;rank; ++i) {</span>
<span class="lineNum">    5829 </span><span class="lineCov">     140917 :                         bounds [i].length = lengths [i];</span>
<span class="lineNum">    5830 </span><span class="lineCov">     140917 :                         if (lower_bounds)</span>
<span class="lineNum">    5831 </span><span class="lineCov">     140919 :                                 bounds [i].lower_bound = lower_bounds [i];</span>
<span class="lineNum">    5832 </span><span class="lineCov">     140917 :                 }</span>
<span class="lineNum">    5833 </span><span class="lineCov">      70362 :         }</span>
<span class="lineNum">    5834 </span>            : 
<span class="lineNum">    5835 </span><span class="lineCov">     442201 :         return array;</span>
<span class="lineNum">    5836 </span><span class="lineCov">     442503 : }</span>
<span class="lineNum">    5837 </span>            : 
<span class="lineNum">    5838 </span>            : /**
<span class="lineNum">    5839 </span>            :  * mono_array_new:
<span class="lineNum">    5840 </span>            :  * @domain: domain where the object is created
<span class="lineNum">    5841 </span>            :  * @eclass: element class
<span class="lineNum">    5842 </span>            :  * @n: number of array elements
<span class="lineNum">    5843 </span>            :  *
<span class="lineNum">    5844 </span>            :  * This routine creates a new szarray with @n elements of type @eclass.
<a name="5845"><span class="lineNum">    5845 </span>            :  */</a>
<span class="lineNum">    5846 </span>            : MonoArray *
<span class="lineNum">    5847 </span>            : mono_array_new (MonoDomain *domain, MonoClass *eclass, uintptr_t n)
<span class="lineNum">    5848 </span>            : {
<span class="lineNum">    5849 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5850 </span>            : 
<span class="lineNum">    5851 </span>            :         MonoError error;
<span class="lineNum">    5852 </span><span class="lineNoCov">          0 :         MonoArray *result = mono_array_new_checked (domain, eclass, n, &amp;error);</span>
<span class="lineNum">    5853 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5854 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    5855 </span>            : }
<span class="lineNum">    5856 </span>            : 
<span class="lineNum">    5857 </span>            : /**
<span class="lineNum">    5858 </span>            :  * mono_array_new_checked:
<span class="lineNum">    5859 </span>            :  * @domain: domain where the object is created
<span class="lineNum">    5860 </span>            :  * @eclass: element class
<span class="lineNum">    5861 </span>            :  * @n: number of array elements
<span class="lineNum">    5862 </span>            :  * @error: set on error
<span class="lineNum">    5863 </span>            :  *
<span class="lineNum">    5864 </span>            :  * This routine creates a new szarray with @n elements of type @eclass.
<span class="lineNum">    5865 </span>            :  * On failure returns NULL and sets @error.
<a name="5866"><span class="lineNum">    5866 </span>            :  */</a>
<span class="lineNum">    5867 </span>            : MonoArray *
<span class="lineNum">    5868 </span>            : mono_array_new_checked (MonoDomain *domain, MonoClass *eclass, uintptr_t n, MonoError *error)
<span class="lineNum">    5869 </span>            : {
<span class="lineNum">    5870 </span>            :         MonoClass *ac;
<span class="lineNum">    5871 </span>            : 
<span class="lineNum">    5872 </span><span class="lineCov">     818077 :         mono_error_init (error);</span>
<span class="lineNum">    5873 </span>            : 
<span class="lineNum">    5874 </span><span class="lineCov">     818077 :         ac = mono_array_class_get (eclass, 1);</span>
<span class="lineNum">    5875 </span><span class="lineCov">    2454395 :         g_assert (ac);</span>
<span class="lineNum">    5876 </span>            : 
<span class="lineNum">    5877 </span><span class="lineCov">     818159 :         MonoVTable *vtable = mono_class_vtable_full (domain, ac, error);</span>
<span class="lineNum">    5878 </span><span class="lineCov">    2454477 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    5879 </span>            : 
<span class="lineNum">    5880 </span><span class="lineCov">     818160 :         return mono_array_new_specific_checked (vtable, n, error);</span>
<span class="lineNum">    5881 </span><span class="lineCov">     818142 : }</span>
<a name="5882"><span class="lineNum">    5882 </span>            : </a>
<span class="lineNum">    5883 </span>            : MonoArray*
<span class="lineNum">    5884 </span>            : ves_icall_array_new (MonoDomain *domain, MonoClass *eclass, uintptr_t n)
<span class="lineNum">    5885 </span>            : {
<span class="lineNum">    5886 </span>            :         MonoError error;
<span class="lineNum">    5887 </span><span class="lineCov">        884 :         MonoArray *arr = mono_array_new_checked (domain, eclass, n, &amp;error);</span>
<span class="lineNum">    5888 </span><span class="lineCov">        884 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    5889 </span>            : 
<span class="lineNum">    5890 </span><span class="lineCov">        884 :         return arr;</span>
<span class="lineNum">    5891 </span>            : }
<span class="lineNum">    5892 </span>            : 
<span class="lineNum">    5893 </span>            : /**
<span class="lineNum">    5894 </span>            :  * mono_array_new_specific:
<span class="lineNum">    5895 </span>            :  * @vtable: a vtable in the appropriate domain for an initialized class
<span class="lineNum">    5896 </span>            :  * @n: number of array elements
<span class="lineNum">    5897 </span>            :  *
<span class="lineNum">    5898 </span>            :  * This routine is a fast alternative to mono_array_new() for code which
<span class="lineNum">    5899 </span>            :  * can be sure about the domain it operates in.
<a name="5900"><span class="lineNum">    5900 </span>            :  */</a>
<span class="lineNum">    5901 </span>            : MonoArray *
<span class="lineNum">    5902 </span>            : mono_array_new_specific (MonoVTable *vtable, uintptr_t n)
<span class="lineNum">    5903 </span>            : {
<span class="lineNum">    5904 </span>            :         MonoError error;
<span class="lineNum">    5905 </span><span class="lineNoCov">          0 :         MonoArray *arr = mono_array_new_specific_checked (vtable, n, &amp;error);</span>
<span class="lineNum">    5906 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5907 </span>            : 
<span class="lineNum">    5908 </span><span class="lineNoCov">          0 :         return arr;</span>
<span class="lineNum">    5909 </span>            : }
<a name="5910"><span class="lineNum">    5910 </span>            : </a>
<span class="lineNum">    5911 </span>            : MonoArray*
<span class="lineNum">    5912 </span>            : mono_array_new_specific_checked (MonoVTable *vtable, uintptr_t n, MonoError *error)
<span class="lineNum">    5913 </span>            : {
<span class="lineNum">    5914 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5915 </span>            : 
<span class="lineNum">    5916 </span>            :         MonoObject *o;
<span class="lineNum">    5917 </span>            :         uintptr_t byte_len;
<span class="lineNum">    5918 </span>            : 
<span class="lineNum">    5919 </span><span class="lineCov">     853871 :         mono_error_init (error);</span>
<span class="lineNum">    5920 </span>            : 
<span class="lineNum">    5921 </span><span class="lineCov">     853871 :         if (G_UNLIKELY (n &gt; MONO_ARRAY_MAX_INDEX)) {</span>
<span class="lineNum">    5922 </span><span class="lineCov">          8 :                 mono_error_set_generic_error (error, &quot;System&quot;, &quot;OverflowException&quot;, &quot;&quot;);</span>
<span class="lineNum">    5923 </span><span class="lineCov">          8 :                 return NULL;</span>
<span class="lineNum">    5924 </span>            :         }
<span class="lineNum">    5925 </span>            : 
<span class="lineNum">    5926 </span><span class="lineCov">     853858 :         if (!mono_array_calc_byte_len (vtable-&gt;klass, n, &amp;byte_len)) {</span>
<span class="lineNum">    5927 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, MONO_ARRAY_MAX_SIZE);</span>
<span class="lineNum">    5928 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    5929 </span>            :         }
<span class="lineNum">    5930 </span><span class="lineCov">     853841 :         o = (MonoObject *)mono_gc_alloc_vector (vtable, byte_len, n);</span>
<span class="lineNum">    5931 </span>            : 
<span class="lineNum">    5932 </span><span class="lineCov">     853841 :         if (G_UNLIKELY (!o)) {</span>
<span class="lineNum">    5933 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %zd bytes&quot;, (gsize) byte_len);</span>
<span class="lineNum">    5934 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    5935 </span>            :         }
<span class="lineNum">    5936 </span>            : 
<span class="lineNum">    5937 </span><span class="lineCov">     853843 :         return (MonoArray*)o;</span>
<span class="lineNum">    5938 </span><span class="lineCov">     853852 : }</span>
<a name="5939"><span class="lineNum">    5939 </span>            : </a>
<span class="lineNum">    5940 </span>            : MonoArray*
<span class="lineNum">    5941 </span>            : ves_icall_array_new_specific (MonoVTable *vtable, uintptr_t n)
<span class="lineNum">    5942 </span>            : {
<span class="lineNum">    5943 </span>            :         MonoError error;
<span class="lineNum">    5944 </span><span class="lineCov">         98 :         MonoArray *arr = mono_array_new_specific_checked (vtable, n, &amp;error);</span>
<span class="lineNum">    5945 </span><span class="lineCov">         98 :         mono_error_set_pending_exception (&amp;error);</span>
<span class="lineNum">    5946 </span>            : 
<span class="lineNum">    5947 </span><span class="lineCov">         98 :         return arr;</span>
<span class="lineNum">    5948 </span>            : }
<span class="lineNum">    5949 </span>            : 
<span class="lineNum">    5950 </span>            : /**
<span class="lineNum">    5951 </span>            :  * mono_string_empty_wrapper:
<span class="lineNum">    5952 </span>            :  *
<span class="lineNum">    5953 </span>            :  * Returns: The same empty string instance as the managed string.Empty
<a name="5954"><span class="lineNum">    5954 </span>            :  */</a>
<span class="lineNum">    5955 </span>            : MonoString*
<span class="lineNum">    5956 </span>            : mono_string_empty_wrapper (void)
<span class="lineNum">    5957 </span>            : {
<span class="lineNum">    5958 </span><span class="lineNoCov">          0 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    5959 </span><span class="lineNoCov">          0 :         return mono_string_empty (domain);</span>
<span class="lineNum">    5960 </span>            : }
<span class="lineNum">    5961 </span>            : 
<span class="lineNum">    5962 </span>            : /**
<span class="lineNum">    5963 </span>            :  * mono_string_empty:
<span class="lineNum">    5964 </span>            :  *
<span class="lineNum">    5965 </span>            :  * Returns: The same empty string instance as the managed string.Empty
<a name="5966"><span class="lineNum">    5966 </span>            :  */</a>
<span class="lineNum">    5967 </span>            : MonoString*
<span class="lineNum">    5968 </span>            : mono_string_empty (MonoDomain *domain)
<span class="lineNum">    5969 </span>            : {
<span class="lineNum">    5970 </span><span class="lineNoCov">          0 :         g_assert (domain);</span>
<span class="lineNum">    5971 </span><span class="lineNoCov">          0 :         g_assert (domain-&gt;empty_string);</span>
<span class="lineNum">    5972 </span><span class="lineNoCov">          0 :         return domain-&gt;empty_string;</span>
<span class="lineNum">    5973 </span>            : }
<span class="lineNum">    5974 </span>            : 
<span class="lineNum">    5975 </span>            : /**
<span class="lineNum">    5976 </span>            :  * mono_string_new_utf16:
<span class="lineNum">    5977 </span>            :  * @text: a pointer to an utf16 string
<span class="lineNum">    5978 </span>            :  * @len: the length of the string
<span class="lineNum">    5979 </span>            :  *
<span class="lineNum">    5980 </span>            :  * Returns: A newly created string object which contains @text.
<a name="5981"><span class="lineNum">    5981 </span>            :  */</a>
<span class="lineNum">    5982 </span>            : MonoString *
<span class="lineNum">    5983 </span>            : mono_string_new_utf16 (MonoDomain *domain, const guint16 *text, gint32 len)
<span class="lineNum">    5984 </span>            : {
<span class="lineNum">    5985 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    5986 </span>            : 
<span class="lineNum">    5987 </span>            :         MonoError error;
<span class="lineNum">    5988 </span><span class="lineNoCov">          0 :         MonoString *res = NULL;</span>
<span class="lineNum">    5989 </span><span class="lineNoCov">          0 :         res = mono_string_new_utf16_checked (domain, text, len, &amp;error);</span>
<span class="lineNum">    5990 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    5991 </span>            : 
<span class="lineNum">    5992 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    5993 </span>            : }
<span class="lineNum">    5994 </span>            : 
<span class="lineNum">    5995 </span>            : /**
<span class="lineNum">    5996 </span>            :  * mono_string_new_utf16_checked:
<span class="lineNum">    5997 </span>            :  * @text: a pointer to an utf16 string
<span class="lineNum">    5998 </span>            :  * @len: the length of the string
<span class="lineNum">    5999 </span>            :  * @error: written on error.
<span class="lineNum">    6000 </span>            :  *
<span class="lineNum">    6001 </span>            :  * Returns: A newly created string object which contains @text.
<span class="lineNum">    6002 </span>            :  * On error, returns NULL and sets @error.
<a name="6003"><span class="lineNum">    6003 </span>            :  */</a>
<span class="lineNum">    6004 </span>            : MonoString *
<span class="lineNum">    6005 </span>            : mono_string_new_utf16_checked (MonoDomain *domain, const guint16 *text, gint32 len, MonoError *error)
<span class="lineNum">    6006 </span>            : {
<span class="lineNum">    6007 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6008 </span>            : 
<span class="lineNum">    6009 </span>            :         MonoString *s;
<span class="lineNum">    6010 </span>            :         
<span class="lineNum">    6011 </span><span class="lineCov">    5328995 :         mono_error_init (error);</span>
<span class="lineNum">    6012 </span>            :         
<span class="lineNum">    6013 </span><span class="lineCov">    5328995 :         s = mono_string_new_size_checked (domain, len, error);</span>
<span class="lineNum">    6014 </span><span class="lineCov">    5328995 :         if (s != NULL)</span>
<span class="lineNum">    6015 </span><span class="lineCov">    5329162 :                 memcpy (mono_string_chars (s), text, len * 2);</span>
<span class="lineNum">    6016 </span>            : 
<span class="lineNum">    6017 </span><span class="lineCov">    5329539 :         return s;</span>
<span class="lineNum">    6018 </span>            : }
<span class="lineNum">    6019 </span>            : 
<span class="lineNum">    6020 </span>            : /**
<span class="lineNum">    6021 </span>            :  * mono_string_new_utf32:
<span class="lineNum">    6022 </span>            :  * @text: a pointer to an utf32 string
<span class="lineNum">    6023 </span>            :  * @len: the length of the string
<span class="lineNum">    6024 </span>            :  * @error: set on failure.
<span class="lineNum">    6025 </span>            :  *
<span class="lineNum">    6026 </span>            :  * Returns: A newly created string object which contains @text. On failure returns NULL and sets @error.
<a name="6027"><span class="lineNum">    6027 </span>            :  */</a>
<span class="lineNum">    6028 </span>            : static MonoString *
<span class="lineNum">    6029 </span>            : mono_string_new_utf32_checked (MonoDomain *domain, const mono_unichar4 *text, gint32 len, MonoError *error)
<span class="lineNum">    6030 </span>            : {
<span class="lineNum">    6031 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6032 </span>            : 
<span class="lineNum">    6033 </span>            :         MonoString *s;
<span class="lineNum">    6034 </span><span class="lineNoCov">          0 :         mono_unichar2 *utf16_output = NULL;</span>
<span class="lineNum">    6035 </span><span class="lineNoCov">          0 :         gint32 utf16_len = 0;</span>
<span class="lineNum">    6036 </span><span class="lineNoCov">          0 :         GError *gerror = NULL;</span>
<span class="lineNum">    6037 </span>            :         glong items_written;
<span class="lineNum">    6038 </span>            :         
<span class="lineNum">    6039 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    6040 </span><span class="lineNoCov">          0 :         utf16_output = g_ucs4_to_utf16 (text, len, NULL, &amp;items_written, &amp;gerror);</span>
<span class="lineNum">    6041 </span>            :         
<span class="lineNum">    6042 </span><span class="lineNoCov">          0 :         if (gerror)</span>
<span class="lineNum">    6043 </span><span class="lineNoCov">          0 :                 g_error_free (gerror);</span>
<span class="lineNum">    6044 </span>            : 
<span class="lineNum">    6045 </span><span class="lineNoCov">          0 :         while (utf16_output [utf16_len]) utf16_len++;</span>
<span class="lineNum">    6046 </span>            :         
<span class="lineNum">    6047 </span><span class="lineNoCov">          0 :         s = mono_string_new_size_checked (domain, utf16_len, error);</span>
<span class="lineNum">    6048 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    6049 </span>            : 
<span class="lineNum">    6050 </span><span class="lineNoCov">          0 :         memcpy (mono_string_chars (s), utf16_output, utf16_len * 2);</span>
<span class="lineNum">    6051 </span>            : 
<span class="lineNum">    6052 </span><span class="lineNoCov">          0 :         g_free (utf16_output);</span>
<span class="lineNum">    6053 </span>            :         
<span class="lineNum">    6054 </span><span class="lineNoCov">          0 :         return s;</span>
<span class="lineNum">    6055 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6056 </span>            : 
<span class="lineNum">    6057 </span>            : /**
<span class="lineNum">    6058 </span>            :  * mono_string_new_utf32:
<span class="lineNum">    6059 </span>            :  * @text: a pointer to an utf32 string
<span class="lineNum">    6060 </span>            :  * @len: the length of the string
<span class="lineNum">    6061 </span>            :  *
<span class="lineNum">    6062 </span>            :  * Returns: A newly created string object which contains @text.
<a name="6063"><span class="lineNum">    6063 </span>            :  */</a>
<span class="lineNum">    6064 </span>            : MonoString *
<span class="lineNum">    6065 </span>            : mono_string_new_utf32 (MonoDomain *domain, const mono_unichar4 *text, gint32 len)
<span class="lineNum">    6066 </span>            : {
<span class="lineNum">    6067 </span>            :         MonoError error;
<span class="lineNum">    6068 </span><span class="lineNoCov">          0 :         MonoString *result = mono_string_new_utf32_checked (domain, text, len, &amp;error);</span>
<span class="lineNum">    6069 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6070 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    6071 </span>            : }
<span class="lineNum">    6072 </span>            : 
<span class="lineNum">    6073 </span>            : /**
<span class="lineNum">    6074 </span>            :  * mono_string_new_size:
<span class="lineNum">    6075 </span>            :  * @text: a pointer to an utf16 string
<span class="lineNum">    6076 </span>            :  * @len: the length of the string
<span class="lineNum">    6077 </span>            :  *
<span class="lineNum">    6078 </span>            :  * Returns: A newly created string object of @len
<a name="6079"><span class="lineNum">    6079 </span>            :  */</a>
<span class="lineNum">    6080 </span>            : MonoString *
<span class="lineNum">    6081 </span>            : mono_string_new_size (MonoDomain *domain, gint32 len)
<span class="lineNum">    6082 </span>            : {
<span class="lineNum">    6083 </span>            :         MonoError error;
<span class="lineNum">    6084 </span><span class="lineNoCov">          0 :         MonoString *str = mono_string_new_size_checked (domain, len, &amp;error);</span>
<span class="lineNum">    6085 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6086 </span>            : 
<span class="lineNum">    6087 </span><span class="lineNoCov">          0 :         return str;</span>
<span class="lineNum">    6088 </span>            : }
<a name="6089"><span class="lineNum">    6089 </span>            : </a>
<span class="lineNum">    6090 </span>            : MonoString *
<span class="lineNum">    6091 </span>            : mono_string_new_size_checked (MonoDomain *domain, gint32 len, MonoError *error)
<span class="lineNum">    6092 </span>            : {
<span class="lineNum">    6093 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6094 </span>            : 
<span class="lineNum">    6095 </span>            :         MonoString *s;
<span class="lineNum">    6096 </span>            :         MonoVTable *vtable;
<span class="lineNum">    6097 </span>            :         size_t size;
<span class="lineNum">    6098 </span>            : 
<span class="lineNum">    6099 </span><span class="lineCov">   38610080 :         mono_error_init (error);</span>
<span class="lineNum">    6100 </span>            : 
<span class="lineNum">    6101 </span>            :         /* check for overflow */
<span class="lineNum">    6102 </span><span class="lineCov">   77228681 :         if (len &lt; 0 || len &gt; ((SIZE_MAX - G_STRUCT_OFFSET (MonoString, chars) - 8) / 2)) {</span>
<span class="lineNum">    6103 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, -1);</span>
<span class="lineNum">    6104 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    6105 </span>            :         }
<span class="lineNum">    6106 </span>            : 
<span class="lineNum">    6107 </span><span class="lineCov">   38614054 :         size = (G_STRUCT_OFFSET (MonoString, chars) + (((size_t)len + 1) * 2));</span>
<span class="lineNum">    6108 </span><span class="lineCov">  115870508 :         g_assert (size &gt; 0);</span>
<span class="lineNum">    6109 </span>            : 
<span class="lineNum">    6110 </span><span class="lineCov">   38640196 :         vtable = mono_class_vtable (domain, mono_defaults.string_class);</span>
<span class="lineNum">    6111 </span><span class="lineCov">  115891888 :         g_assert (vtable);</span>
<span class="lineNum">    6112 </span>            : 
<span class="lineNum">    6113 </span><span class="lineCov">   38610258 :         s = (MonoString *)mono_gc_alloc_string (vtable, size, len);</span>
<span class="lineNum">    6114 </span>            : 
<span class="lineNum">    6115 </span><span class="lineCov">   38610258 :         if (G_UNLIKELY (!s)) {</span>
<span class="lineNum">    6116 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %zd bytes&quot;, size);</span>
<span class="lineNum">    6117 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    6118 </span>            :         }
<span class="lineNum">    6119 </span>            : 
<span class="lineNum">    6120 </span><span class="lineCov">   38612036 :         return s;</span>
<span class="lineNum">    6121 </span><span class="lineCov">   38612756 : }</span>
<span class="lineNum">    6122 </span>            : 
<span class="lineNum">    6123 </span>            : /**
<span class="lineNum">    6124 </span>            :  * mono_string_new_len:
<span class="lineNum">    6125 </span>            :  * @text: a pointer to an utf8 string
<span class="lineNum">    6126 </span>            :  * @length: number of bytes in @text to consider
<span class="lineNum">    6127 </span>            :  *
<span class="lineNum">    6128 </span>            :  * Returns: A newly created string object which contains @text.
<a name="6129"><span class="lineNum">    6129 </span>            :  */</a>
<span class="lineNum">    6130 </span>            : MonoString*
<span class="lineNum">    6131 </span>            : mono_string_new_len (MonoDomain *domain, const char *text, guint length)
<span class="lineNum">    6132 </span>            : {
<span class="lineNum">    6133 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6134 </span>            : 
<span class="lineNum">    6135 </span>            :         MonoError error;
<span class="lineNum">    6136 </span><span class="lineNoCov">          0 :         MonoString *result = mono_string_new_len_checked (domain, text, length, &amp;error);</span>
<span class="lineNum">    6137 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6138 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    6139 </span>            : }
<span class="lineNum">    6140 </span>            : 
<span class="lineNum">    6141 </span>            : /**
<span class="lineNum">    6142 </span>            :  * mono_string_new_len_checked:
<span class="lineNum">    6143 </span>            :  * @text: a pointer to an utf8 string
<span class="lineNum">    6144 </span>            :  * @length: number of bytes in @text to consider
<span class="lineNum">    6145 </span>            :  * @error: set on error
<span class="lineNum">    6146 </span>            :  *
<span class="lineNum">    6147 </span>            :  * Returns: A newly created string object which contains @text. On
<span class="lineNum">    6148 </span>            :  * failure returns NULL and sets @error.
<a name="6149"><span class="lineNum">    6149 </span>            :  */</a>
<span class="lineNum">    6150 </span>            : MonoString*
<span class="lineNum">    6151 </span>            : mono_string_new_len_checked (MonoDomain *domain, const char *text, guint length, MonoError *error)
<span class="lineNum">    6152 </span>            : {
<span class="lineNum">    6153 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6154 </span>            : 
<span class="lineNum">    6155 </span><span class="lineCov">        335 :         mono_error_init (error);</span>
<span class="lineNum">    6156 </span>            : 
<span class="lineNum">    6157 </span><span class="lineCov">        335 :         GError *eg_error = NULL;</span>
<span class="lineNum">    6158 </span><span class="lineCov">        335 :         MonoString *o = NULL;</span>
<span class="lineNum">    6159 </span><span class="lineCov">        335 :         guint16 *ut = NULL;</span>
<span class="lineNum">    6160 </span>            :         glong items_written;
<span class="lineNum">    6161 </span>            : 
<span class="lineNum">    6162 </span><span class="lineCov">        335 :         ut = eg_utf8_to_utf16_with_nuls (text, length, NULL, &amp;items_written, &amp;eg_error);</span>
<span class="lineNum">    6163 </span>            : 
<span class="lineNum">    6164 </span><span class="lineCov">        335 :         if (!eg_error)</span>
<span class="lineNum">    6165 </span><span class="lineCov">        335 :                 o = mono_string_new_utf16_checked (domain, ut, items_written, error);</span>
<span class="lineNum">    6166 </span>            :         else 
<span class="lineNum">    6167 </span><span class="lineNoCov">          0 :                 g_error_free (eg_error);</span>
<span class="lineNum">    6168 </span>            : 
<span class="lineNum">    6169 </span><span class="lineCov">        335 :         g_free (ut);</span>
<span class="lineNum">    6170 </span>            : 
<span class="lineNum">    6171 </span><span class="lineCov">        335 :         return o;</span>
<span class="lineNum">    6172 </span>            : }
<span class="lineNum">    6173 </span>            : 
<span class="lineNum">    6174 </span>            : /**
<span class="lineNum">    6175 </span>            :  * mono_string_new:
<span class="lineNum">    6176 </span>            :  * @text: a pointer to an utf8 string
<span class="lineNum">    6177 </span>            :  *
<span class="lineNum">    6178 </span>            :  * Returns: A newly created string object which contains @text.
<span class="lineNum">    6179 </span>            :  *
<span class="lineNum">    6180 </span>            :  * This function asserts if it cannot allocate a new string.
<span class="lineNum">    6181 </span>            :  *
<span class="lineNum">    6182 </span>            :  * @deprecated Use mono_string_new_checked in new code.
<a name="6183"><span class="lineNum">    6183 </span>            :  */</a>
<span class="lineNum">    6184 </span>            : MonoString*
<span class="lineNum">    6185 </span>            : mono_string_new (MonoDomain *domain, const char *text)
<span class="lineNum">    6186 </span>            : {
<span class="lineNum">    6187 </span>            :         MonoError error;
<span class="lineNum">    6188 </span><span class="lineCov">     713175 :         MonoString *res = NULL;</span>
<span class="lineNum">    6189 </span><span class="lineCov">     713175 :         res = mono_string_new_checked (domain, text, &amp;error);</span>
<span class="lineNum">    6190 </span><span class="lineCov">     713175 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    6191 </span><span class="lineCov">     713175 :         return res;</span>
<span class="lineNum">    6192 </span>            : }
<span class="lineNum">    6193 </span>            : 
<span class="lineNum">    6194 </span>            : /**
<span class="lineNum">    6195 </span>            :  * mono_string_new_checked:
<span class="lineNum">    6196 </span>            :  * @text: a pointer to an utf8 string
<span class="lineNum">    6197 </span>            :  * @merror: set on error
<span class="lineNum">    6198 </span>            :  *
<span class="lineNum">    6199 </span>            :  * Returns: A newly created string object which contains @text.
<span class="lineNum">    6200 </span>            :  * On error returns NULL and sets @merror.
<a name="6201"><span class="lineNum">    6201 </span>            :  */</a>
<span class="lineNum">    6202 </span>            : MonoString*
<span class="lineNum">    6203 </span>            : mono_string_new_checked (MonoDomain *domain, const char *text, MonoError *error)
<span class="lineNum">    6204 </span>            : {
<span class="lineNum">    6205 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6206 </span>            : 
<span class="lineNum">    6207 </span><span class="lineCov">     993729 :     GError *eg_error = NULL;</span>
<span class="lineNum">    6208 </span><span class="lineCov">     993729 :     MonoString *o = NULL;</span>
<span class="lineNum">    6209 </span>            :     guint16 *ut;
<span class="lineNum">    6210 </span>            :     glong items_written;
<span class="lineNum">    6211 </span>            :     int l;
<span class="lineNum">    6212 </span>            : 
<span class="lineNum">    6213 </span><span class="lineCov">     993729 :     mono_error_init (error);</span>
<span class="lineNum">    6214 </span>            : 
<span class="lineNum">    6215 </span><span class="lineCov">     993729 :     l = strlen (text);</span>
<span class="lineNum">    6216 </span>            :    
<span class="lineNum">    6217 </span><span class="lineCov">     993729 :     ut = g_utf8_to_utf16 (text, l, NULL, &amp;items_written, &amp;eg_error);</span>
<span class="lineNum">    6218 </span>            : 
<span class="lineNum">    6219 </span><span class="lineCov">     993729 :     if (!eg_error)</span>
<span class="lineNum">    6220 </span><span class="lineCov">     993735 :             o = mono_string_new_utf16_checked (domain, ut, items_written, error);</span>
<span class="lineNum">    6221 </span>            :     else
<span class="lineNum">    6222 </span><span class="lineCov">          1 :         g_error_free (eg_error);</span>
<span class="lineNum">    6223 </span>            : 
<span class="lineNum">    6224 </span><span class="lineCov">     993755 :     g_free (ut);</span>
<span class="lineNum">    6225 </span>            :     
<span class="lineNum">    6226 </span>            : /*FIXME g_utf8_get_char, g_utf8_next_char and g_utf8_validate are not part of eglib.*/
<span class="lineNum">    6227 </span>            : #if 0
<span class="lineNum">    6228 </span>            :         gunichar2 *str;
<span class="lineNum">    6229 </span>            :         const gchar *end;
<span class="lineNum">    6230 </span>            :         int len;
<span class="lineNum">    6231 </span>            :         MonoString *o = NULL;
<span class="lineNum">    6232 </span>            : 
<span class="lineNum">    6233 </span>            :         if (!g_utf8_validate (text, -1, &amp;end)) {
<span class="lineNum">    6234 </span>            :                 mono_error_set_argument (error, &quot;text&quot;, &quot;Not a valid utf8 string&quot;);
<span class="lineNum">    6235 </span>            :                 goto leave;
<span class="lineNum">    6236 </span>            :         }
<span class="lineNum">    6237 </span>            : 
<span class="lineNum">    6238 </span>            :         len = g_utf8_strlen (text, -1);
<span class="lineNum">    6239 </span>            :         o = mono_string_new_size_checked (domain, len, error);
<span class="lineNum">    6240 </span>            :         if (!o)
<span class="lineNum">    6241 </span>            :                 goto leave;
<span class="lineNum">    6242 </span>            :         str = mono_string_chars (o);
<span class="lineNum">    6243 </span>            : 
<span class="lineNum">    6244 </span>            :         while (text &lt; end) {
<span class="lineNum">    6245 </span>            :                 *str++ = g_utf8_get_char (text);
<span class="lineNum">    6246 </span>            :                 text = g_utf8_next_char (text);
<span class="lineNum">    6247 </span>            :         }
<span class="lineNum">    6248 </span>            : 
<span class="lineNum">    6249 </span>            : leave:
<span class="lineNum">    6250 </span>            : #endif
<span class="lineNum">    6251 </span><span class="lineCov">     993755 :         return o;</span>
<span class="lineNum">    6252 </span>            : }
<span class="lineNum">    6253 </span>            : 
<span class="lineNum">    6254 </span>            : /**
<span class="lineNum">    6255 </span>            :  * mono_string_new_wrapper:
<span class="lineNum">    6256 </span>            :  * @text: pointer to utf8 characters.
<span class="lineNum">    6257 </span>            :  *
<span class="lineNum">    6258 </span>            :  * Helper function to create a string object from @text in the current domain.
<a name="6259"><span class="lineNum">    6259 </span>            :  */</a>
<span class="lineNum">    6260 </span>            : MonoString*
<span class="lineNum">    6261 </span>            : mono_string_new_wrapper (const char *text)
<span class="lineNum">    6262 </span>            : {
<span class="lineNum">    6263 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6264 </span>            : 
<span class="lineNum">    6265 </span><span class="lineCov">       5760 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    6266 </span>            : 
<span class="lineNum">    6267 </span><span class="lineCov">       5760 :         if (text)</span>
<span class="lineNum">    6268 </span><span class="lineCov">       5712 :                 return mono_string_new (domain, text);</span>
<span class="lineNum">    6269 </span>            : 
<span class="lineNum">    6270 </span><span class="lineCov">         48 :         return NULL;</span>
<span class="lineNum">    6271 </span><span class="lineCov">       5760 : }</span>
<span class="lineNum">    6272 </span>            : 
<span class="lineNum">    6273 </span>            : /**
<span class="lineNum">    6274 </span>            :  * mono_value_box:
<span class="lineNum">    6275 </span>            :  * @class: the class of the value
<span class="lineNum">    6276 </span>            :  * @value: a pointer to the unboxed data
<span class="lineNum">    6277 </span>            :  *
<span class="lineNum">    6278 </span>            :  * Returns: A newly created object which contains @value.
<a name="6279"><span class="lineNum">    6279 </span>            :  */</a>
<span class="lineNum">    6280 </span>            : MonoObject *
<span class="lineNum">    6281 </span>            : mono_value_box (MonoDomain *domain, MonoClass *klass, gpointer value)
<span class="lineNum">    6282 </span>            : {
<span class="lineNum">    6283 </span>            :         MonoError error;
<span class="lineNum">    6284 </span><span class="lineNoCov">          0 :         MonoObject *result = mono_value_box_checked (domain, klass, value, &amp;error);</span>
<span class="lineNum">    6285 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6286 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    6287 </span>            : }
<span class="lineNum">    6288 </span>            : 
<span class="lineNum">    6289 </span>            : /**
<span class="lineNum">    6290 </span>            :  * mono_value_box_checked:
<span class="lineNum">    6291 </span>            :  * @domain: the domain of the new object
<span class="lineNum">    6292 </span>            :  * @class: the class of the value
<span class="lineNum">    6293 </span>            :  * @value: a pointer to the unboxed data
<span class="lineNum">    6294 </span>            :  * @error: set on error
<span class="lineNum">    6295 </span>            :  *
<span class="lineNum">    6296 </span>            :  * Returns: A newly created object which contains @value. On failure
<span class="lineNum">    6297 </span>            :  * returns NULL and sets @error.
<a name="6298"><span class="lineNum">    6298 </span>            :  */</a>
<span class="lineNum">    6299 </span>            : MonoObject *
<span class="lineNum">    6300 </span>            : mono_value_box_checked (MonoDomain *domain, MonoClass *klass, gpointer value, MonoError *error)
<span class="lineNum">    6301 </span>            : {
<span class="lineNum">    6302 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6303 </span>            :         MonoObject *res;
<span class="lineNum">    6304 </span>            :         int size;
<span class="lineNum">    6305 </span>            :         MonoVTable *vtable;
<span class="lineNum">    6306 </span>            : 
<span class="lineNum">    6307 </span><span class="lineCov">       2488 :         mono_error_init (error);</span>
<span class="lineNum">    6308 </span>            : 
<span class="lineNum">    6309 </span><span class="lineCov">       7464 :         g_assert (klass-&gt;valuetype);</span>
<span class="lineNum">    6310 </span><span class="lineCov">       2488 :         if (mono_class_is_nullable (klass))</span>
<span class="lineNum">    6311 </span><span class="lineCov">          2 :                 return mono_nullable_box ((guint8 *)value, klass, error);</span>
<span class="lineNum">    6312 </span>            : 
<span class="lineNum">    6313 </span><span class="lineCov">       2486 :         vtable = mono_class_vtable (domain, klass);</span>
<span class="lineNum">    6314 </span><span class="lineCov">       2486 :         if (!vtable)</span>
<span class="lineNum">    6315 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    6316 </span><span class="lineCov">       2486 :         size = mono_class_instance_size (klass);</span>
<span class="lineNum">    6317 </span><span class="lineCov">       2486 :         res = mono_object_new_alloc_specific_checked (vtable, error);</span>
<span class="lineNum">    6318 </span><span class="lineCov">       7458 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    6319 </span>            : 
<span class="lineNum">    6320 </span><span class="lineCov">       2486 :         size = size - sizeof (MonoObject);</span>
<span class="lineNum">    6321 </span>            : 
<span class="lineNum">    6322 </span>            : #ifdef HAVE_SGEN_GC
<span class="lineNum">    6323 </span><span class="lineCov">       7458 :         g_assert (size == mono_class_value_size (klass, NULL));</span>
<span class="lineNum">    6324 </span><span class="lineCov">       2486 :         mono_gc_wbarrier_value_copy ((char *)res + sizeof (MonoObject), value, 1, klass);</span>
<span class="lineNum">    6325 </span>            : #else
<span class="lineNum">    6326 </span>            : #if NO_UNALIGNED_ACCESS
<span class="lineNum">    6327 </span>            :         mono_gc_memmove_atomic ((char *)res + sizeof (MonoObject), value, size);
<span class="lineNum">    6328 </span>            : #else
<span class="lineNum">    6329 </span>            :         switch (size) {
<span class="lineNum">    6330 </span>            :         case 1:
<span class="lineNum">    6331 </span>            :                 *((guint8 *) res + sizeof (MonoObject)) = *(guint8 *) value;
<span class="lineNum">    6332 </span>            :                 break;
<span class="lineNum">    6333 </span>            :         case 2:
<span class="lineNum">    6334 </span>            :                 *(guint16 *)((guint8 *) res + sizeof (MonoObject)) = *(guint16 *) value;
<span class="lineNum">    6335 </span>            :                 break;
<span class="lineNum">    6336 </span>            :         case 4:
<span class="lineNum">    6337 </span>            :                 *(guint32 *)((guint8 *) res + sizeof (MonoObject)) = *(guint32 *) value;
<span class="lineNum">    6338 </span>            :                 break;
<span class="lineNum">    6339 </span>            :         case 8:
<span class="lineNum">    6340 </span>            :                 *(guint64 *)((guint8 *) res + sizeof (MonoObject)) = *(guint64 *) value;
<span class="lineNum">    6341 </span>            :                 break;
<span class="lineNum">    6342 </span>            :         default:
<span class="lineNum">    6343 </span>            :                 mono_gc_memmove_atomic ((char *)res + sizeof (MonoObject), value, size);
<span class="lineNum">    6344 </span>            :         }
<span class="lineNum">    6345 </span>            : #endif
<span class="lineNum">    6346 </span>            : #endif
<span class="lineNum">    6347 </span><span class="lineCov">       2486 :         if (klass-&gt;has_finalize) {</span>
<span class="lineNum">    6348 </span><span class="lineNoCov">          0 :                 mono_object_register_finalizer (res);</span>
<span class="lineNum">    6349 </span><span class="lineNoCov">          0 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    6350 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    6351 </span><span class="lineCov">       2486 :         return res;</span>
<span class="lineNum">    6352 </span><span class="lineCov">       2488 : }</span>
<span class="lineNum">    6353 </span>            : 
<span class="lineNum">    6354 </span>            : /**
<span class="lineNum">    6355 </span>            :  * mono_value_copy:
<span class="lineNum">    6356 </span>            :  * @dest: destination pointer
<span class="lineNum">    6357 </span>            :  * @src: source pointer
<span class="lineNum">    6358 </span>            :  * @klass: a valuetype class
<span class="lineNum">    6359 </span>            :  *
<span class="lineNum">    6360 </span>            :  * Copy a valuetype from @src to @dest. This function must be used
<span class="lineNum">    6361 </span>            :  * when @klass contains references fields.
<a name="6362"><span class="lineNum">    6362 </span>            :  */</a>
<span class="lineNum">    6363 </span>            : void
<span class="lineNum">    6364 </span>            : mono_value_copy (gpointer dest, gpointer src, MonoClass *klass)
<span class="lineNum">    6365 </span>            : {
<span class="lineNum">    6366 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6367 </span>            : 
<span class="lineNum">    6368 </span><span class="lineCov">       1476 :         mono_gc_wbarrier_value_copy (dest, src, 1, klass);</span>
<span class="lineNum">    6369 </span><span class="lineCov">       1476 : }</span>
<span class="lineNum">    6370 </span>            : 
<span class="lineNum">    6371 </span>            : /**
<span class="lineNum">    6372 </span>            :  * mono_value_copy_array:
<span class="lineNum">    6373 </span>            :  * @dest: destination array
<span class="lineNum">    6374 </span>            :  * @dest_idx: index in the @dest array
<span class="lineNum">    6375 </span>            :  * @src: source pointer
<span class="lineNum">    6376 </span>            :  * @count: number of items
<span class="lineNum">    6377 </span>            :  *
<span class="lineNum">    6378 </span>            :  * Copy @count valuetype items from @src to the array @dest at index @dest_idx. 
<span class="lineNum">    6379 </span>            :  * This function must be used when @klass contains references fields.
<span class="lineNum">    6380 </span>            :  * Overlap is handled.
<a name="6381"><span class="lineNum">    6381 </span>            :  */</a>
<span class="lineNum">    6382 </span>            : void
<span class="lineNum">    6383 </span>            : mono_value_copy_array (MonoArray *dest, int dest_idx, gpointer src, int count)
<span class="lineNum">    6384 </span>            : {
<span class="lineNum">    6385 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6386 </span>            : 
<span class="lineNum">    6387 </span><span class="lineCov">    8519847 :         int size = mono_array_element_size (dest-&gt;obj.vtable-&gt;klass);</span>
<span class="lineNum">    6388 </span><span class="lineCov">    8519847 :         char *d = mono_array_addr_with_size_fast (dest, size, dest_idx);</span>
<span class="lineNum">    6389 </span><span class="lineCov">   25564686 :         g_assert (size == mono_class_value_size (mono_object_class (dest)-&gt;element_class, NULL));</span>
<span class="lineNum">    6390 </span><span class="lineCov">    8522735 :         mono_gc_wbarrier_value_copy (d, src, count, mono_object_class (dest)-&gt;element_class);</span>
<span class="lineNum">    6391 </span><span class="lineCov">    8522735 : }</span>
<span class="lineNum">    6392 </span>            : 
<span class="lineNum">    6393 </span>            : /**
<span class="lineNum">    6394 </span>            :  * mono_object_get_domain:
<span class="lineNum">    6395 </span>            :  * @obj: object to query
<span class="lineNum">    6396 </span>            :  * 
<span class="lineNum">    6397 </span>            :  * Returns: the MonoDomain where the object is hosted
<a name="6398"><span class="lineNum">    6398 </span>            :  */</a>
<span class="lineNum">    6399 </span>            : MonoDomain*
<span class="lineNum">    6400 </span>            : mono_object_get_domain (MonoObject *obj)
<span class="lineNum">    6401 </span>            : {
<span class="lineNum">    6402 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6403 </span>            : 
<span class="lineNum">    6404 </span><span class="lineCov">      11423 :         return mono_object_domain (obj);</span>
<span class="lineNum">    6405 </span>            : }
<span class="lineNum">    6406 </span>            : 
<span class="lineNum">    6407 </span>            : /**
<span class="lineNum">    6408 </span>            :  * mono_object_get_class:
<span class="lineNum">    6409 </span>            :  * @obj: object to query
<span class="lineNum">    6410 </span>            :  *
<span class="lineNum">    6411 </span>            :  * Use this function to obtain the `MonoClass*` for a given `MonoObject`.
<span class="lineNum">    6412 </span>            :  *
<span class="lineNum">    6413 </span>            :  * Returns: the MonoClass of the object.
<a name="6414"><span class="lineNum">    6414 </span>            :  */</a>
<span class="lineNum">    6415 </span>            : MonoClass*
<span class="lineNum">    6416 </span>            : mono_object_get_class (MonoObject *obj)
<span class="lineNum">    6417 </span>            : {
<span class="lineNum">    6418 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6419 </span>            : 
<span class="lineNum">    6420 </span><span class="lineCov">    4679039 :         return mono_object_class (obj);</span>
<span class="lineNum">    6421 </span>            : }
<span class="lineNum">    6422 </span>            : /**
<span class="lineNum">    6423 </span>            :  * mono_object_get_size:
<span class="lineNum">    6424 </span>            :  * @o: object to query
<span class="lineNum">    6425 </span>            :  * 
<span class="lineNum">    6426 </span>            :  * Returns: the size, in bytes, of @o
<a name="6427"><span class="lineNum">    6427 </span>            :  */</a>
<span class="lineNum">    6428 </span>            : guint
<span class="lineNum">    6429 </span>            : mono_object_get_size (MonoObject* o)
<span class="lineNum">    6430 </span>            : {
<span class="lineNum">    6431 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6432 </span>            : 
<span class="lineNum">    6433 </span><span class="lineCov">    2023963 :         MonoClass* klass = mono_object_class (o);</span>
<span class="lineNum">    6434 </span><span class="lineCov">    2023963 :         if (klass == mono_defaults.string_class) {</span>
<span class="lineNum">    6435 </span><span class="lineCov">        526 :                 return sizeof (MonoString) + 2 * mono_string_length ((MonoString*) o) + 2;</span>
<span class="lineNum">    6436 </span><span class="lineCov">    2023437 :         } else if (o-&gt;vtable-&gt;rank) {</span>
<span class="lineNum">    6437 </span><span class="lineCov">       6162 :                 MonoArray *array = (MonoArray*)o;</span>
<span class="lineNum">    6438 </span><span class="lineCov">       6162 :                 size_t size = MONO_SIZEOF_MONO_ARRAY + mono_array_element_size (klass) * mono_array_length (array);</span>
<span class="lineNum">    6439 </span><span class="lineCov">       6162 :                 if (array-&gt;bounds) {</span>
<span class="lineNum">    6440 </span><span class="lineNoCov">          0 :                         size += 3;</span>
<span class="lineNum">    6441 </span><span class="lineNoCov">          0 :                         size &amp;= ~3;</span>
<span class="lineNum">    6442 </span><span class="lineNoCov">          0 :                         size += sizeof (MonoArrayBounds) * o-&gt;vtable-&gt;rank;</span>
<span class="lineNum">    6443 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    6444 </span><span class="lineCov">       6162 :                 return size;</span>
<span class="lineNum">    6445 </span>            :         } else {
<span class="lineNum">    6446 </span><span class="lineCov">    2017275 :                 return mono_class_instance_size (klass);</span>
<span class="lineNum">    6447 </span>            :         }
<span class="lineNum">    6448 </span><span class="lineCov">    2023963 : }</span>
<span class="lineNum">    6449 </span>            : 
<span class="lineNum">    6450 </span>            : /**
<span class="lineNum">    6451 </span>            :  * mono_object_unbox:
<span class="lineNum">    6452 </span>            :  * @obj: object to unbox
<span class="lineNum">    6453 </span>            :  * 
<span class="lineNum">    6454 </span>            :  * Returns: a pointer to the start of the valuetype boxed in this
<span class="lineNum">    6455 </span>            :  * object.
<span class="lineNum">    6456 </span>            :  *
<span class="lineNum">    6457 </span>            :  * This method will assert if the object passed is not a valuetype.
<a name="6458"><span class="lineNum">    6458 </span>            :  */</a>
<span class="lineNum">    6459 </span>            : gpointer
<span class="lineNum">    6460 </span>            : mono_object_unbox (MonoObject *obj)
<span class="lineNum">    6461 </span>            : {
<span class="lineNum">    6462 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6463 </span>            : 
<span class="lineNum">    6464 </span>            :         /* add assert for valuetypes? */
<span class="lineNum">    6465 </span><span class="lineCov">    3588680 :         g_assert (obj-&gt;vtable-&gt;klass-&gt;valuetype);</span>
<span class="lineNum">    6466 </span><span class="lineCov">    1196456 :         return ((char*)obj) + sizeof (MonoObject);</span>
<span class="lineNum">    6467 </span>            : }
<span class="lineNum">    6468 </span>            : 
<span class="lineNum">    6469 </span>            : /**
<span class="lineNum">    6470 </span>            :  * mono_object_isinst:
<span class="lineNum">    6471 </span>            :  * @obj: an object
<span class="lineNum">    6472 </span>            :  * @klass: a pointer to a class 
<span class="lineNum">    6473 </span>            :  *
<span class="lineNum">    6474 </span>            :  * Returns: @obj if @obj is derived from @klass or NULL otherwise.
<a name="6475"><span class="lineNum">    6475 </span>            :  */</a>
<span class="lineNum">    6476 </span>            : MonoObject *
<span class="lineNum">    6477 </span>            : mono_object_isinst (MonoObject *obj_raw, MonoClass *klass)
<span class="lineNum">    6478 </span>            : {
<span class="lineNum">    6479 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6480 </span>            : 
<span class="lineNum">    6481 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_ENTER ();</span>
<span class="lineNum">    6482 </span><span class="lineNoCov">          0 :         MONO_HANDLE_DCL (MonoObject, obj);</span>
<span class="lineNum">    6483 </span>            :         MonoError error;
<span class="lineNum">    6484 </span><span class="lineNoCov">          0 :         MonoObjectHandle result = mono_object_handle_isinst (obj, klass, &amp;error);</span>
<span class="lineNum">    6485 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6486 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_RETURN_OBJ (result);</span>
<span class="lineNum">    6487 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6488 </span>            :         
<span class="lineNum">    6489 </span>            : 
<span class="lineNum">    6490 </span>            : /**
<span class="lineNum">    6491 </span>            :  * mono_object_isinst_checked:
<span class="lineNum">    6492 </span>            :  * @obj: an object
<span class="lineNum">    6493 </span>            :  * @klass: a pointer to a class 
<span class="lineNum">    6494 </span>            :  * @error: set on error
<span class="lineNum">    6495 </span>            :  *
<span class="lineNum">    6496 </span>            :  * Returns: @obj if @obj is derived from @klass or NULL if it isn't.
<span class="lineNum">    6497 </span>            :  * On failure returns NULL and sets @error.
<a name="6498"><span class="lineNum">    6498 </span>            :  */</a>
<span class="lineNum">    6499 </span>            : MonoObject *
<span class="lineNum">    6500 </span>            : mono_object_isinst_checked (MonoObject *obj_raw, MonoClass *klass, MonoError *error)
<span class="lineNum">    6501 </span>            : {
<span class="lineNum">    6502 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6503 </span>            : 
<span class="lineNum">    6504 </span><span class="lineCov">  585312981 :         HANDLE_FUNCTION_ENTER ();</span>
<span class="lineNum">    6505 </span><span class="lineCov">  292445004 :         mono_error_init (error);</span>
<span class="lineNum">    6506 </span><span class="lineCov">  292445004 :         MONO_HANDLE_DCL (MonoObject, obj);</span>
<span class="lineNum">    6507 </span><span class="lineCov">  292445004 :         MonoObjectHandle result = mono_object_handle_isinst (obj, klass, error);</span>
<span class="lineNum">    6508 </span><span class="lineCov">  578219618 :         HANDLE_FUNCTION_RETURN_OBJ (result);</span>
<span class="lineNum">    6509 </span><span class="lineCov">  293160814 : }</span>
<span class="lineNum">    6510 </span>            : 
<span class="lineNum">    6511 </span>            : /**
<span class="lineNum">    6512 </span>            :  * mono_object_handle_isinst:
<span class="lineNum">    6513 </span>            :  * @obj: an object
<span class="lineNum">    6514 </span>            :  * @klass: a pointer to a class 
<span class="lineNum">    6515 </span>            :  * @error: set on error
<span class="lineNum">    6516 </span>            :  *
<span class="lineNum">    6517 </span>            :  * Returns: @obj if @obj is derived from @klass or NULL if it isn't.
<span class="lineNum">    6518 </span>            :  * On failure returns NULL and sets @error.
<a name="6519"><span class="lineNum">    6519 </span>            :  */</a>
<span class="lineNum">    6520 </span>            : MonoObjectHandle
<span class="lineNum">    6521 </span>            : mono_object_handle_isinst (MonoObjectHandle obj, MonoClass *klass, MonoError *error)
<span class="lineNum">    6522 </span>            : {
<span class="lineNum">    6523 </span><span class="lineCov">  294386951 :         mono_error_init (error);</span>
<span class="lineNum">    6524 </span>            :         
<span class="lineNum">    6525 </span><span class="lineCov">  294386951 :         if (!klass-&gt;inited)</span>
<span class="lineNum">    6526 </span><span class="lineCov">      16964 :                 mono_class_init (klass);</span>
<span class="lineNum">    6527 </span>            : 
<span class="lineNum">    6528 </span><span class="lineCov">  584150202 :         if (mono_class_is_marshalbyref (klass) || mono_class_is_interface (klass)) {</span>
<span class="lineNum">    6529 </span><span class="lineCov">    1180777 :                 return mono_object_handle_isinst_mbyref (obj, klass, error);</span>
<span class="lineNum">    6530 </span>            :         }
<span class="lineNum">    6531 </span>            : 
<span class="lineNum">    6532 </span><span class="lineCov">  290596147 :         MonoObjectHandle result = MONO_HANDLE_NEW (MonoObject, NULL);</span>
<span class="lineNum">    6533 </span>            : 
<span class="lineNum">    6534 </span><span class="lineCov">  583124095 :         if (!MONO_HANDLE_IS_NULL (obj) &amp;&amp; mono_class_is_assignable_from (klass, mono_handle_class (obj)))</span>
<span class="lineNum">    6535 </span><span class="lineCov">  293057674 :                 MONO_HANDLE_ASSIGN (result, obj);</span>
<span class="lineNum">    6536 </span><span class="lineCov">  285518545 :         return result;</span>
<span class="lineNum">    6537 </span><span class="lineCov">  288058283 : }</span>
<a name="6538"><span class="lineNum">    6538 </span>            : </a>
<span class="lineNum">    6539 </span>            : MonoObject *
<span class="lineNum">    6540 </span>            : mono_object_isinst_mbyref (MonoObject *obj_raw, MonoClass *klass)
<span class="lineNum">    6541 </span>            : {
<span class="lineNum">    6542 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6543 </span>            : 
<span class="lineNum">    6544 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_ENTER ();</span>
<span class="lineNum">    6545 </span>            :         MonoError error;
<span class="lineNum">    6546 </span><span class="lineNoCov">          0 :         MONO_HANDLE_DCL (MonoObject, obj);</span>
<span class="lineNum">    6547 </span><span class="lineNoCov">          0 :         MonoObjectHandle result = mono_object_handle_isinst_mbyref (obj, klass, &amp;error);</span>
<span class="lineNum">    6548 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error); /* FIXME better API that doesn't swallow the error */</span>
<span class="lineNum">    6549 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_RETURN_OBJ (result);</span>
<span class="lineNum">    6550 </span><span class="lineNoCov">          0 : }</span>
<a name="6551"><span class="lineNum">    6551 </span>            : </a>
<span class="lineNum">    6552 </span>            : MonoObjectHandle
<span class="lineNum">    6553 </span>            : mono_object_handle_isinst_mbyref (MonoObjectHandle obj, MonoClass *klass, MonoError *error)
<span class="lineNum">    6554 </span>            : {
<span class="lineNum">    6555 </span><span class="lineCov">    1180851 :         mono_error_init (error);</span>
<span class="lineNum">    6556 </span>            : 
<span class="lineNum">    6557 </span><span class="lineCov">    1180851 :         MonoObjectHandle result = MONO_HANDLE_NEW (MonoObject, NULL);</span>
<span class="lineNum">    6558 </span>            : 
<span class="lineNum">    6559 </span><span class="lineCov">    1180851 :         if (MONO_HANDLE_IS_NULL (obj))</span>
<span class="lineNum">    6560 </span><span class="lineNoCov">          0 :                 goto leave;</span>
<span class="lineNum">    6561 </span>            : 
<span class="lineNum">    6562 </span><span class="lineCov">    1180775 :         MonoVTable *vt = MONO_HANDLE_GETVAL (obj, vtable);</span>
<span class="lineNum">    6563 </span>            :         
<span class="lineNum">    6564 </span><span class="lineCov">    1180775 :         if (mono_class_is_interface (klass)) {</span>
<span class="lineNum">    6565 </span><span class="lineCov">    2211926 :                 if (MONO_VTABLE_IMPLEMENTS_INTERFACE (vt, klass-&gt;interface_id)) {</span>
<span class="lineNum">    6566 </span><span class="lineCov">    1029974 :                         MONO_HANDLE_ASSIGN (result, obj);</span>
<span class="lineNum">    6567 </span><span class="lineCov">    1029974 :                         goto leave;</span>
<span class="lineNum">    6568 </span>            :                 }
<span class="lineNum">    6569 </span>            : 
<span class="lineNum">    6570 </span>            :                 /* casting an array one of the invariant interfaces that must act as such */
<span class="lineNum">    6571 </span><span class="lineCov">     126094 :                 if (klass-&gt;is_array_special_interface) {</span>
<span class="lineNum">    6572 </span><span class="lineCov">      32612 :                         if (mono_class_is_assignable_from (klass, vt-&gt;klass)) {</span>
<span class="lineNum">    6573 </span><span class="lineCov">        278 :                                 MONO_HANDLE_ASSIGN (result, obj);</span>
<span class="lineNum">    6574 </span><span class="lineCov">        278 :                                 goto leave;</span>
<span class="lineNum">    6575 </span>            :                         }
<span class="lineNum">    6576 </span><span class="lineCov">      32335 :                 }</span>
<span class="lineNum">    6577 </span>            : 
<span class="lineNum">    6578 </span>            :                 /*If the above check fails we are in the slow path of possibly raising an exception. So it's ok to it this way.*/
<span class="lineNum">    6579 </span><span class="lineCov">     152002 :                 else if (mono_class_has_variant_generic_params (klass) &amp;&amp; mono_class_is_assignable_from (klass, mono_handle_class (obj))) {</span>
<span class="lineNum">    6580 </span><span class="lineCov">       2848 :                         MONO_HANDLE_ASSIGN (result, obj);</span>
<span class="lineNum">    6581 </span><span class="lineCov">       2848 :                         goto leave;</span>
<span class="lineNum">    6582 </span>            :                 }
<span class="lineNum">    6583 </span><span class="lineCov">     122967 :         } else {</span>
<span class="lineNum">    6584 </span><span class="lineCov">      24738 :                 MonoClass *oklass = vt-&gt;klass;</span>
<span class="lineNum">    6585 </span><span class="lineCov">      24738 :                 if (mono_class_is_transparent_proxy (oklass)){</span>
<span class="lineNum">    6586 </span><span class="lineCov">          2 :                         MonoRemoteClass *remote_class = MONO_HANDLE_GETVAL (MONO_HANDLE_CAST (MonoTransparentProxy, obj), remote_class);</span>
<span class="lineNum">    6587 </span><span class="lineCov">          2 :                         oklass = remote_class-&gt;proxy_class;</span>
<span class="lineNum">    6588 </span><span class="lineCov">          2 :                 }</span>
<span class="lineNum">    6589 </span>            : 
<span class="lineNum">    6590 </span><span class="lineCov">      24738 :                 mono_class_setup_supertypes (klass);    </span>
<span class="lineNum">    6591 </span><span class="lineCov">      49476 :                 if ((oklass-&gt;idepth &gt;= klass-&gt;idepth) &amp;&amp; (oklass-&gt;supertypes [klass-&gt;idepth - 1] == klass)) {</span>
<span class="lineNum">    6592 </span><span class="lineCov">      24738 :                         MONO_HANDLE_ASSIGN (result, obj);</span>
<span class="lineNum">    6593 </span><span class="lineCov">      24738 :                         goto leave;</span>
<span class="lineNum">    6594 </span>            :                 }
<span class="lineNum">    6595 </span>            :         }
<span class="lineNum">    6596 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    6597 </span><span class="lineCov">     245930 :         if (mono_class_is_transparent_proxy (vt-&gt;klass)) </span>
<span class="lineNum">    6598 </span>            :         {
<span class="lineNum">    6599 </span><span class="lineNoCov">          0 :                 MonoBoolean custom_type_info =  MONO_HANDLE_GETVAL (MONO_HANDLE_CAST (MonoTransparentProxy, obj), custom_type_info);</span>
<span class="lineNum">    6600 </span><span class="lineNoCov">          0 :                 if (!custom_type_info)</span>
<span class="lineNum">    6601 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">    6602 </span><span class="lineNoCov">          0 :                 MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    6603 </span><span class="lineNoCov">          0 :                 MonoObjectHandle rp = MONO_HANDLE_NEW (MonoObject, NULL);</span>
<span class="lineNum">    6604 </span><span class="lineNoCov">          0 :                 MONO_HANDLE_GET (rp, MONO_HANDLE_CAST (MonoTransparentProxy, obj), rp);</span>
<span class="lineNum">    6605 </span><span class="lineNoCov">          0 :                 MonoClass *rpklass = mono_defaults.iremotingtypeinfo_class;</span>
<span class="lineNum">    6606 </span><span class="lineNoCov">          0 :                 MonoMethod *im = NULL;</span>
<span class="lineNum">    6607 </span>            :                 gpointer pa [2];
<span class="lineNum">    6608 </span>            : 
<span class="lineNum">    6609 </span><span class="lineNoCov">          0 :                 im = mono_class_get_method_from_name (rpklass, &quot;CanCastTo&quot;, -1);</span>
<span class="lineNum">    6610 </span><span class="lineNoCov">          0 :                 if (!im) {</span>
<span class="lineNum">    6611 </span><span class="lineNoCov">          0 :                         mono_error_set_not_supported (error, &quot;Linked away.&quot;);</span>
<span class="lineNum">    6612 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">    6613 </span>            :                 }
<span class="lineNum">    6614 </span><span class="lineNoCov">          0 :                 im = mono_object_handle_get_virtual_method (rp, im, error);</span>
<span class="lineNum">    6615 </span><span class="lineNoCov">          0 :                 if (!is_ok (error))</span>
<span class="lineNum">    6616 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">    6617 </span><span class="lineNoCov">          0 :                 g_assert (im);</span>
<span class="lineNum">    6618 </span>            :         
<span class="lineNum">    6619 </span><span class="lineNoCov">          0 :                 MonoReflectionTypeHandle reftype = mono_type_get_object_handle (domain, &amp;klass-&gt;byval_arg, error);</span>
<span class="lineNum">    6620 </span><span class="lineNoCov">          0 :                 if (!is_ok (error))</span>
<span class="lineNum">    6621 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">    6622 </span>            : 
<span class="lineNum">    6623 </span><span class="lineNoCov">          0 :                 pa [0] = MONO_HANDLE_RAW (reftype);</span>
<span class="lineNum">    6624 </span><span class="lineNoCov">          0 :                 pa [1] = MONO_HANDLE_RAW (obj);</span>
<span class="lineNum">    6625 </span><span class="lineNoCov">          0 :                 MonoObject *res = mono_runtime_invoke_checked (im, rp, pa, error);</span>
<span class="lineNum">    6626 </span><span class="lineNoCov">          0 :                 if (!is_ok (error))</span>
<span class="lineNum">    6627 </span><span class="lineNoCov">          0 :                         goto leave;</span>
<span class="lineNum">    6628 </span>            : 
<span class="lineNum">    6629 </span><span class="lineNoCov">          0 :                 if (*(MonoBoolean *) mono_object_unbox(res)) {</span>
<span class="lineNum">    6630 </span>            :                         /* Update the vtable of the remote type, so it can safely cast to this new type */
<span class="lineNum">    6631 </span><span class="lineNoCov">          0 :                         mono_upgrade_remote_class (domain, obj, klass, error);</span>
<span class="lineNum">    6632 </span><span class="lineNoCov">          0 :                         if (!is_ok (error))</span>
<span class="lineNum">    6633 </span><span class="lineNoCov">          0 :                                 goto leave;</span>
<span class="lineNum">    6634 </span><span class="lineNoCov">          0 :                         MONO_HANDLE_ASSIGN (result, obj);</span>
<span class="lineNum">    6635 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    6636 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    6637 </span>            : #endif /* DISABLE_REMOTING */
<span class="lineNum">    6638 </span>            : leave:
<span class="lineNum">    6639 </span><span class="lineCov">    1180768 :         return result;</span>
<span class="lineNum">    6640 </span>            : }
<span class="lineNum">    6641 </span>            : 
<span class="lineNum">    6642 </span>            : /**
<span class="lineNum">    6643 </span>            :  * mono_object_castclass_mbyref:
<span class="lineNum">    6644 </span>            :  * @obj: an object
<span class="lineNum">    6645 </span>            :  * @klass: a pointer to a class 
<span class="lineNum">    6646 </span>            :  *
<span class="lineNum">    6647 </span>            :  * Returns: @obj if @obj is derived from @klass, returns NULL otherwise.
<a name="6648"><span class="lineNum">    6648 </span>            :  */</a>
<span class="lineNum">    6649 </span>            : MonoObject *
<span class="lineNum">    6650 </span>            : mono_object_castclass_mbyref (MonoObject *obj_raw, MonoClass *klass)
<span class="lineNum">    6651 </span>            : {
<span class="lineNum">    6652 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6653 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_ENTER ();</span>
<span class="lineNum">    6654 </span>            :         MonoError error;
<span class="lineNum">    6655 </span><span class="lineNoCov">          0 :         MONO_HANDLE_DCL (MonoObject, obj);</span>
<span class="lineNum">    6656 </span><span class="lineNoCov">          0 :         MonoObjectHandle result = MONO_HANDLE_NEW (MonoObject, NULL);</span>
<span class="lineNum">    6657 </span><span class="lineNoCov">          0 :         if (MONO_HANDLE_IS_NULL (obj))</span>
<span class="lineNum">    6658 </span><span class="lineNoCov">          0 :                 goto leave;</span>
<span class="lineNum">    6659 </span><span class="lineNoCov">          0 :         MONO_HANDLE_ASSIGN (result, mono_object_handle_isinst_mbyref (obj, klass, &amp;error));</span>
<span class="lineNum">    6660 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6661 </span>            : leave:
<span class="lineNum">    6662 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_RETURN_OBJ (result);</span>
<span class="lineNum">    6663 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6664 </span>            : 
<span class="lineNum">    6665 </span>            : typedef struct {
<span class="lineNum">    6666 </span>            :         MonoDomain *orig_domain;
<span class="lineNum">    6667 </span>            :         MonoString *ins;
<span class="lineNum">    6668 </span>            :         MonoString *res;
<span class="lineNum">    6669 </span>            : } LDStrInfo;
<a name="6670"><span class="lineNum">    6670 </span>            : </a>
<span class="lineNum">    6671 </span>            : static void
<span class="lineNum">    6672 </span>            : str_lookup (MonoDomain *domain, gpointer user_data)
<span class="lineNum">    6673 </span>            : {
<span class="lineNum">    6674 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6675 </span>            : 
<span class="lineNum">    6676 </span><span class="lineNoCov">          0 :         LDStrInfo *info = (LDStrInfo *)user_data;</span>
<span class="lineNum">    6677 </span><span class="lineNoCov">          0 :         if (info-&gt;res || domain == info-&gt;orig_domain)</span>
<span class="lineNum">    6678 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    6679 </span><span class="lineNoCov">          0 :         info-&gt;res = (MonoString *)mono_g_hash_table_lookup (domain-&gt;ldstr_table, info-&gt;ins);</span>
<span class="lineNum">    6680 </span><span class="lineNoCov">          0 : }</span>
<a name="6681"><span class="lineNum">    6681 </span>            : </a>
<span class="lineNum">    6682 </span>            : static MonoString*
<span class="lineNum">    6683 </span>            : mono_string_get_pinned (MonoString *str, MonoError *error)
<span class="lineNum">    6684 </span>            : {
<span class="lineNum">    6685 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6686 </span>            : 
<span class="lineNum">    6687 </span><span class="lineCov">    2454290 :         mono_error_init (error);</span>
<span class="lineNum">    6688 </span>            : 
<span class="lineNum">    6689 </span>            :         /* We only need to make a pinned version of a string if this is a moving GC */
<span class="lineNum">    6690 </span><span class="lineCov">    2454290 :         if (!mono_gc_is_moving ())</span>
<span class="lineNum">    6691 </span><span class="lineNoCov">          0 :                 return str;</span>
<span class="lineNum">    6692 </span>            :         int size;
<span class="lineNum">    6693 </span>            :         MonoString *news;
<span class="lineNum">    6694 </span><span class="lineCov">    2454290 :         size = sizeof (MonoString) + 2 * (mono_string_length (str) + 1);</span>
<span class="lineNum">    6695 </span><span class="lineCov">    2454290 :         news = (MonoString *)mono_gc_alloc_pinned_obj (((MonoObject*)str)-&gt;vtable, size);</span>
<span class="lineNum">    6696 </span><span class="lineCov">    2454290 :         if (news) {</span>
<span class="lineNum">    6697 </span><span class="lineCov">    2454290 :                 memcpy (mono_string_chars (news), mono_string_chars (str), mono_string_length (str) * 2);</span>
<span class="lineNum">    6698 </span><span class="lineCov">    2454290 :                 news-&gt;length = mono_string_length (str);</span>
<span class="lineNum">    6699 </span><span class="lineCov">    2454290 :         } else {</span>
<span class="lineNum">    6700 </span><span class="lineNoCov">          0 :                 mono_error_set_out_of_memory (error, &quot;Could not allocate %i bytes&quot;, size);</span>
<span class="lineNum">    6701 </span>            :         }
<span class="lineNum">    6702 </span><span class="lineCov">    2454290 :         return news;</span>
<span class="lineNum">    6703 </span><span class="lineCov">    2454290 : }</span>
<a name="6704"><span class="lineNum">    6704 </span>            : </a>
<span class="lineNum">    6705 </span>            : static MonoString*
<span class="lineNum">    6706 </span>            : mono_string_is_interned_lookup (MonoString *str, int insert, MonoError *error)
<span class="lineNum">    6707 </span>            : {
<span class="lineNum">    6708 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6709 </span>            : 
<span class="lineNum">    6710 </span>            :         MonoGHashTable *ldstr_table;
<span class="lineNum">    6711 </span>            :         MonoString *s, *res;
<span class="lineNum">    6712 </span>            :         MonoDomain *domain;
<span class="lineNum">    6713 </span>            :         
<span class="lineNum">    6714 </span><span class="lineCov">       3586 :         mono_error_init (error);</span>
<span class="lineNum">    6715 </span>            : 
<span class="lineNum">    6716 </span><span class="lineCov">       3586 :         domain = ((MonoObject *)str)-&gt;vtable-&gt;domain;</span>
<span class="lineNum">    6717 </span><span class="lineCov">       3586 :         ldstr_table = domain-&gt;ldstr_table;</span>
<span class="lineNum">    6718 </span><span class="lineCov">       3586 :         ldstr_lock ();</span>
<span class="lineNum">    6719 </span><span class="lineCov">       3586 :         res = (MonoString *)mono_g_hash_table_lookup (ldstr_table, str);</span>
<span class="lineNum">    6720 </span><span class="lineCov">       3586 :         if (res) {</span>
<span class="lineNum">    6721 </span><span class="lineCov">         26 :                 ldstr_unlock ();</span>
<span class="lineNum">    6722 </span><span class="lineCov">         26 :                 return res;</span>
<span class="lineNum">    6723 </span>            :         }
<span class="lineNum">    6724 </span><span class="lineCov">       3560 :         if (insert) {</span>
<span class="lineNum">    6725 </span>            :                 /* Allocate outside the lock */
<span class="lineNum">    6726 </span><span class="lineCov">       3560 :                 ldstr_unlock ();</span>
<span class="lineNum">    6727 </span><span class="lineCov">       3560 :                 s = mono_string_get_pinned (str, error);</span>
<span class="lineNum">    6728 </span><span class="lineCov">      10680 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    6729 </span><span class="lineCov">       3560 :                 if (s) {</span>
<span class="lineNum">    6730 </span><span class="lineCov">       3560 :                         ldstr_lock ();</span>
<span class="lineNum">    6731 </span><span class="lineCov">       3560 :                         res = (MonoString *)mono_g_hash_table_lookup (ldstr_table, str);</span>
<span class="lineNum">    6732 </span><span class="lineCov">       3560 :                         if (res) {</span>
<span class="lineNum">    6733 </span><span class="lineNoCov">          0 :                                 ldstr_unlock ();</span>
<span class="lineNum">    6734 </span><span class="lineNoCov">          0 :                                 return res;</span>
<span class="lineNum">    6735 </span>            :                         }
<span class="lineNum">    6736 </span><span class="lineCov">       3560 :                         mono_g_hash_table_insert (ldstr_table, s, s);</span>
<span class="lineNum">    6737 </span><span class="lineCov">       3560 :                         ldstr_unlock ();</span>
<span class="lineNum">    6738 </span><span class="lineCov">       3560 :                 }</span>
<span class="lineNum">    6739 </span><span class="lineCov">       3560 :                 return s;</span>
<span class="lineNum">    6740 </span>            :         } else {
<span class="lineNum">    6741 </span>            :                 LDStrInfo ldstr_info;
<span class="lineNum">    6742 </span><span class="lineNoCov">          0 :                 ldstr_info.orig_domain = domain;</span>
<span class="lineNum">    6743 </span><span class="lineNoCov">          0 :                 ldstr_info.ins = str;</span>
<span class="lineNum">    6744 </span><span class="lineNoCov">          0 :                 ldstr_info.res = NULL;</span>
<span class="lineNum">    6745 </span>            : 
<span class="lineNum">    6746 </span><span class="lineNoCov">          0 :                 mono_domain_foreach (str_lookup, &amp;ldstr_info);</span>
<span class="lineNum">    6747 </span><span class="lineNoCov">          0 :                 if (ldstr_info.res) {</span>
<span class="lineNum">    6748 </span>            :                         /* 
<span class="lineNum">    6749 </span>            :                          * the string was already interned in some other domain:
<span class="lineNum">    6750 </span>            :                          * intern it in the current one as well.
<span class="lineNum">    6751 </span>            :                          */
<span class="lineNum">    6752 </span><span class="lineNoCov">          0 :                         mono_g_hash_table_insert (ldstr_table, str, str);</span>
<span class="lineNum">    6753 </span><span class="lineNoCov">          0 :                         ldstr_unlock ();</span>
<span class="lineNum">    6754 </span><span class="lineNoCov">          0 :                         return str;</span>
<span class="lineNum">    6755 </span>            :                 }
<span class="lineNum">    6756 </span>            :         }
<span class="lineNum">    6757 </span><span class="lineNoCov">          0 :         ldstr_unlock ();</span>
<span class="lineNum">    6758 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    6759 </span><span class="lineCov">       3586 : }</span>
<span class="lineNum">    6760 </span>            : 
<span class="lineNum">    6761 </span>            : /**
<span class="lineNum">    6762 </span>            :  * mono_string_is_interned:
<span class="lineNum">    6763 </span>            :  * @o: String to probe
<span class="lineNum">    6764 </span>            :  *
<span class="lineNum">    6765 </span>            :  * Returns whether the string has been interned.
<a name="6766"><span class="lineNum">    6766 </span>            :  */</a>
<span class="lineNum">    6767 </span>            : MonoString*
<span class="lineNum">    6768 </span>            : mono_string_is_interned (MonoString *o)
<span class="lineNum">    6769 </span>            : {
<span class="lineNum">    6770 </span>            :         MonoError error;
<span class="lineNum">    6771 </span><span class="lineNoCov">          0 :         MonoString *result = mono_string_is_interned_lookup (o, FALSE, &amp;error);</span>
<span class="lineNum">    6772 </span>            :         /* This function does not fail. */
<span class="lineNum">    6773 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    6774 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    6775 </span>            : }
<span class="lineNum">    6776 </span>            : 
<span class="lineNum">    6777 </span>            : /**
<span class="lineNum">    6778 </span>            :  * mono_string_intern:
<span class="lineNum">    6779 </span>            :  * @o: String to intern
<span class="lineNum">    6780 </span>            :  *
<span class="lineNum">    6781 </span>            :  * Interns the string passed.  
<span class="lineNum">    6782 </span>            :  * Returns: The interned string.
<a name="6783"><span class="lineNum">    6783 </span>            :  */</a>
<span class="lineNum">    6784 </span>            : MonoString*
<span class="lineNum">    6785 </span>            : mono_string_intern (MonoString *str)
<span class="lineNum">    6786 </span>            : {
<span class="lineNum">    6787 </span>            :         MonoError error;
<span class="lineNum">    6788 </span><span class="lineNoCov">          0 :         MonoString *result = mono_string_intern_checked (str, &amp;error);</span>
<span class="lineNum">    6789 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    6790 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    6791 </span>            : }
<span class="lineNum">    6792 </span>            : 
<span class="lineNum">    6793 </span>            : /**
<span class="lineNum">    6794 </span>            :  * mono_string_intern_checked:
<span class="lineNum">    6795 </span>            :  * @o: String to intern
<span class="lineNum">    6796 </span>            :  * @error: set on error.
<span class="lineNum">    6797 </span>            :  *
<span class="lineNum">    6798 </span>            :  * Interns the string passed.
<span class="lineNum">    6799 </span>            :  * Returns: The interned string.  On failure returns NULL and sets @error
<a name="6800"><span class="lineNum">    6800 </span>            :  */</a>
<span class="lineNum">    6801 </span>            : MonoString*
<span class="lineNum">    6802 </span>            : mono_string_intern_checked (MonoString *str, MonoError *error)
<span class="lineNum">    6803 </span>            : {
<span class="lineNum">    6804 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6805 </span>            : 
<span class="lineNum">    6806 </span><span class="lineCov">       3586 :         mono_error_init (error);</span>
<span class="lineNum">    6807 </span>            : 
<span class="lineNum">    6808 </span><span class="lineCov">       3586 :         return mono_string_is_interned_lookup (str, TRUE, error);</span>
<span class="lineNum">    6809 </span>            : }
<span class="lineNum">    6810 </span>            : 
<span class="lineNum">    6811 </span>            : /**
<span class="lineNum">    6812 </span>            :  * mono_ldstr:
<span class="lineNum">    6813 </span>            :  * @domain: the domain where the string will be used.
<span class="lineNum">    6814 </span>            :  * @image: a metadata context
<span class="lineNum">    6815 </span>            :  * @idx: index into the user string table.
<span class="lineNum">    6816 </span>            :  * 
<span class="lineNum">    6817 </span>            :  * Implementation for the ldstr opcode.
<span class="lineNum">    6818 </span>            :  * Returns: a loaded string from the @image/@idx combination.
<a name="6819"><span class="lineNum">    6819 </span>            :  */</a>
<span class="lineNum">    6820 </span>            : MonoString*
<span class="lineNum">    6821 </span>            : mono_ldstr (MonoDomain *domain, MonoImage *image, guint32 idx)
<span class="lineNum">    6822 </span>            : {
<span class="lineNum">    6823 </span>            :         MonoError error;
<span class="lineNum">    6824 </span><span class="lineNoCov">          0 :         MonoString *result = mono_ldstr_checked (domain, image, idx, &amp;error);</span>
<span class="lineNum">    6825 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6826 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    6827 </span>            : }
<span class="lineNum">    6828 </span>            : 
<span class="lineNum">    6829 </span>            : /**
<span class="lineNum">    6830 </span>            :  * mono_ldstr_checked:
<span class="lineNum">    6831 </span>            :  * @domain: the domain where the string will be used.
<span class="lineNum">    6832 </span>            :  * @image: a metadata context
<span class="lineNum">    6833 </span>            :  * @idx: index into the user string table.
<span class="lineNum">    6834 </span>            :  * @error: set on error.
<span class="lineNum">    6835 </span>            :  * 
<span class="lineNum">    6836 </span>            :  * Implementation for the ldstr opcode.
<span class="lineNum">    6837 </span>            :  * Returns: a loaded string from the @image/@idx combination.
<span class="lineNum">    6838 </span>            :  * On failure returns NULL and sets @error.
<a name="6839"><span class="lineNum">    6839 </span>            :  */</a>
<span class="lineNum">    6840 </span>            : MonoString*
<span class="lineNum">    6841 </span>            : mono_ldstr_checked (MonoDomain *domain, MonoImage *image, guint32 idx, MonoError *error)
<span class="lineNum">    6842 </span>            : {
<span class="lineNum">    6843 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6844 </span><span class="lineCov">    4200513 :         mono_error_init (error);</span>
<span class="lineNum">    6845 </span>            : 
<span class="lineNum">    6846 </span><span class="lineCov">    4200513 :         if (image-&gt;dynamic) {</span>
<span class="lineNum">    6847 </span><span class="lineCov">         55 :                 MonoString *str = (MonoString *)mono_lookup_dynamic_token (image, MONO_TOKEN_STRING | idx, NULL, error);</span>
<span class="lineNum">    6848 </span><span class="lineCov">         55 :                 return str;</span>
<span class="lineNum">    6849 </span>            :         } else {
<span class="lineNum">    6850 </span><span class="lineCov">    4199186 :                 if (!mono_verifier_verify_string_signature (image, idx, NULL))</span>
<span class="lineNum">    6851 </span><span class="lineNoCov">          0 :                         return NULL; /*FIXME we should probably be raising an exception here*/</span>
<span class="lineNum">    6852 </span><span class="lineCov">    4199193 :                 MonoString *str = mono_ldstr_metadata_sig (domain, mono_metadata_user_string (image, idx), error);</span>
<span class="lineNum">    6853 </span><span class="lineCov">    4199193 :                 return str;</span>
<span class="lineNum">    6854 </span>            :         }
<span class="lineNum">    6855 </span><span class="lineCov">    4201599 : }</span>
<span class="lineNum">    6856 </span>            : 
<span class="lineNum">    6857 </span>            : /**
<span class="lineNum">    6858 </span>            :  * mono_ldstr_metadata_sig
<span class="lineNum">    6859 </span>            :  * @domain: the domain for the string
<span class="lineNum">    6860 </span>            :  * @sig: the signature of a metadata string
<span class="lineNum">    6861 </span>            :  * @error: set on error
<span class="lineNum">    6862 </span>            :  *
<span class="lineNum">    6863 </span>            :  * Returns: a MonoString for a string stored in the metadata. On
<span class="lineNum">    6864 </span>            :  * failure returns NULL and sets @error.
<a name="6865"><span class="lineNum">    6865 </span>            :  */</a>
<span class="lineNum">    6866 </span>            : static MonoString*
<span class="lineNum">    6867 </span>            : mono_ldstr_metadata_sig (MonoDomain *domain, const char* sig, MonoError *error)
<span class="lineNum">    6868 </span>            : {
<span class="lineNum">    6869 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6870 </span>            : 
<span class="lineNum">    6871 </span><span class="lineCov">    4199281 :         mono_error_init (error);</span>
<span class="lineNum">    6872 </span><span class="lineCov">    4199281 :         const char *str = sig;</span>
<span class="lineNum">    6873 </span>            :         MonoString *o, *interned;
<span class="lineNum">    6874 </span>            :         size_t len2;
<span class="lineNum">    6875 </span>            : 
<span class="lineNum">    6876 </span><span class="lineCov">    4199281 :         len2 = mono_metadata_decode_blob_size (str, &amp;str);</span>
<span class="lineNum">    6877 </span><span class="lineCov">    4199281 :         len2 &gt;&gt;= 1;</span>
<span class="lineNum">    6878 </span>            : 
<span class="lineNum">    6879 </span><span class="lineCov">    4199281 :         o = mono_string_new_utf16_checked (domain, (guint16*)str, len2, error);</span>
<span class="lineNum">    6880 </span><span class="lineCov">   12600778 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    6881 </span>            : #if G_BYTE_ORDER != G_LITTLE_ENDIAN
<span class="lineNum">    6882 </span>            :         {
<span class="lineNum">    6883 </span>            :                 int i;
<span class="lineNum">    6884 </span>            :                 guint16 *p2 = (guint16*)mono_string_chars (o);
<span class="lineNum">    6885 </span>            :                 for (i = 0; i &lt; len2; ++i) {
<span class="lineNum">    6886 </span>            :                         *p2 = GUINT16_FROM_LE (*p2);
<span class="lineNum">    6887 </span>            :                         ++p2;
<span class="lineNum">    6888 </span>            :                 }
<span class="lineNum">    6889 </span>            :         }
<span class="lineNum">    6890 </span>            : #endif
<span class="lineNum">    6891 </span><span class="lineCov">    4201551 :         ldstr_lock ();</span>
<span class="lineNum">    6892 </span><span class="lineCov">    4201551 :         interned = (MonoString *)mono_g_hash_table_lookup (domain-&gt;ldstr_table, o);</span>
<span class="lineNum">    6893 </span><span class="lineCov">    4201551 :         ldstr_unlock ();</span>
<span class="lineNum">    6894 </span><span class="lineCov">    4201551 :         if (interned)</span>
<span class="lineNum">    6895 </span><span class="lineCov">    1750816 :                 return interned; /* o will get garbage collected */</span>
<span class="lineNum">    6896 </span>            : 
<span class="lineNum">    6897 </span><span class="lineCov">    2450730 :         o = mono_string_get_pinned (o, error);</span>
<span class="lineNum">    6898 </span><span class="lineCov">    2450730 :         if (o) {</span>
<span class="lineNum">    6899 </span><span class="lineCov">    2450730 :                 ldstr_lock ();</span>
<span class="lineNum">    6900 </span><span class="lineCov">    2450730 :                 interned = (MonoString *)mono_g_hash_table_lookup (domain-&gt;ldstr_table, o);</span>
<span class="lineNum">    6901 </span><span class="lineCov">    2450730 :                 if (!interned) {</span>
<span class="lineNum">    6902 </span><span class="lineCov">    2449749 :                         mono_g_hash_table_insert (domain-&gt;ldstr_table, o, o);</span>
<span class="lineNum">    6903 </span><span class="lineCov">    2449749 :                         interned = o;</span>
<span class="lineNum">    6904 </span><span class="lineCov">    2449749 :                 }</span>
<span class="lineNum">    6905 </span><span class="lineCov">    2450730 :                 ldstr_unlock ();</span>
<span class="lineNum">    6906 </span><span class="lineCov">    2450730 :         }</span>
<span class="lineNum">    6907 </span>            : 
<span class="lineNum">    6908 </span><span class="lineCov">    2450730 :         return interned;</span>
<span class="lineNum">    6909 </span><span class="lineCov">    4201541 : }</span>
<span class="lineNum">    6910 </span>            : 
<span class="lineNum">    6911 </span>            : /*
<span class="lineNum">    6912 </span>            :  * mono_ldstr_utf8:
<span class="lineNum">    6913 </span>            :  *
<span class="lineNum">    6914 </span>            :  *   Same as mono_ldstr, but return a NULL terminated utf8 string instead
<span class="lineNum">    6915 </span>            :  * of an object.
<a name="6916"><span class="lineNum">    6916 </span>            :  */</a>
<span class="lineNum">    6917 </span>            : char*
<span class="lineNum">    6918 </span>            : mono_ldstr_utf8 (MonoImage *image, guint32 idx, MonoError *error)
<span class="lineNum">    6919 </span>            : {
<span class="lineNum">    6920 </span>            :         const char *str;
<span class="lineNum">    6921 </span>            :         size_t len2;
<span class="lineNum">    6922 </span><span class="lineNoCov">          0 :         long written = 0;</span>
<span class="lineNum">    6923 </span>            :         char *as;
<span class="lineNum">    6924 </span><span class="lineNoCov">          0 :         GError *gerror = NULL;</span>
<span class="lineNum">    6925 </span>            : 
<span class="lineNum">    6926 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    6927 </span>            : 
<span class="lineNum">    6928 </span><span class="lineNoCov">          0 :         if (!mono_verifier_verify_string_signature (image, idx, NULL))</span>
<span class="lineNum">    6929 </span><span class="lineNoCov">          0 :                 return NULL; /*FIXME we should probably be raising an exception here*/</span>
<span class="lineNum">    6930 </span><span class="lineNoCov">          0 :         str = mono_metadata_user_string (image, idx);</span>
<span class="lineNum">    6931 </span>            : 
<span class="lineNum">    6932 </span><span class="lineNoCov">          0 :         len2 = mono_metadata_decode_blob_size (str, &amp;str);</span>
<span class="lineNum">    6933 </span><span class="lineNoCov">          0 :         len2 &gt;&gt;= 1;</span>
<span class="lineNum">    6934 </span>            : 
<span class="lineNum">    6935 </span><span class="lineNoCov">          0 :         as = g_utf16_to_utf8 ((guint16*)str, len2, NULL, &amp;written, &amp;gerror);</span>
<span class="lineNum">    6936 </span><span class="lineNoCov">          0 :         if (gerror) {</span>
<span class="lineNum">    6937 </span><span class="lineNoCov">          0 :                 mono_error_set_argument (error, &quot;string&quot;, &quot;%s&quot;, gerror-&gt;message);</span>
<span class="lineNum">    6938 </span><span class="lineNoCov">          0 :                 g_error_free (gerror);</span>
<span class="lineNum">    6939 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    6940 </span>            :         }
<span class="lineNum">    6941 </span>            :         /* g_utf16_to_utf8  may not be able to complete the convertion (e.g. NULL values were found, #335488) */
<span class="lineNum">    6942 </span><span class="lineNoCov">          0 :         if (len2 &gt; written) {</span>
<span class="lineNum">    6943 </span>            :                 /* allocate the total length and copy the part of the string that has been converted */
<span class="lineNum">    6944 </span><span class="lineNoCov">          0 :                 char *as2 = (char *)g_malloc0 (len2);</span>
<span class="lineNum">    6945 </span><span class="lineNoCov">          0 :                 memcpy (as2, as, written);</span>
<span class="lineNum">    6946 </span><span class="lineNoCov">          0 :                 g_free (as);</span>
<span class="lineNum">    6947 </span><span class="lineNoCov">          0 :                 as = as2;</span>
<span class="lineNum">    6948 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    6949 </span>            : 
<span class="lineNum">    6950 </span><span class="lineNoCov">          0 :         return as;</span>
<span class="lineNum">    6951 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6952 </span>            : 
<span class="lineNum">    6953 </span>            : /**
<span class="lineNum">    6954 </span>            :  * mono_string_to_utf8:
<span class="lineNum">    6955 </span>            :  * @s: a System.String
<span class="lineNum">    6956 </span>            :  *
<span class="lineNum">    6957 </span>            :  * Returns the UTF8 representation for @s.
<span class="lineNum">    6958 </span>            :  * The resulting buffer needs to be freed with mono_free().
<span class="lineNum">    6959 </span>            :  *
<span class="lineNum">    6960 </span>            :  * @deprecated Use mono_string_to_utf8_checked to avoid having an exception arbritraly raised.
<a name="6961"><span class="lineNum">    6961 </span>            :  */</a>
<span class="lineNum">    6962 </span>            : char *
<span class="lineNum">    6963 </span>            : mono_string_to_utf8 (MonoString *s)
<span class="lineNum">    6964 </span>            : {
<span class="lineNum">    6965 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6966 </span>            : 
<span class="lineNum">    6967 </span>            :         MonoError error;
<span class="lineNum">    6968 </span><span class="lineCov">          2 :         char *result = mono_string_to_utf8_checked (s, &amp;error);</span>
<span class="lineNum">    6969 </span>            :         
<span class="lineNum">    6970 </span><span class="lineCov">          2 :         if (!is_ok (&amp;error)) {</span>
<span class="lineNum">    6971 </span><span class="lineNoCov">          0 :                 mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    6972 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    6973 </span>            :         }
<span class="lineNum">    6974 </span><span class="lineCov">          2 :         return result;</span>
<span class="lineNum">    6975 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    6976 </span>            : 
<span class="lineNum">    6977 </span>            : /**
<span class="lineNum">    6978 </span>            :  * mono_string_to_utf8_checked:
<span class="lineNum">    6979 </span>            :  * @s: a System.String
<span class="lineNum">    6980 </span>            :  * @error: a MonoError.
<span class="lineNum">    6981 </span>            :  * 
<span class="lineNum">    6982 </span>            :  * Converts a MonoString to its UTF8 representation. May fail; check 
<span class="lineNum">    6983 </span>            :  * @error to determine whether the conversion was successful.
<span class="lineNum">    6984 </span>            :  * The resulting buffer should be freed with mono_free().
<a name="6985"><span class="lineNum">    6985 </span>            :  */</a>
<span class="lineNum">    6986 </span>            : char *
<span class="lineNum">    6987 </span>            : mono_string_to_utf8_checked (MonoString *s, MonoError *error)
<span class="lineNum">    6988 </span>            : {
<span class="lineNum">    6989 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    6990 </span>            : 
<span class="lineNum">    6991 </span><span class="lineCov">     528148 :         long written = 0;</span>
<span class="lineNum">    6992 </span>            :         char *as;
<span class="lineNum">    6993 </span><span class="lineCov">     528148 :         GError *gerror = NULL;</span>
<span class="lineNum">    6994 </span>            : 
<span class="lineNum">    6995 </span><span class="lineCov">     528148 :         mono_error_init (error);</span>
<span class="lineNum">    6996 </span>            : 
<span class="lineNum">    6997 </span><span class="lineCov">     528148 :         if (s == NULL)</span>
<span class="lineNum">    6998 </span><span class="lineCov">         28 :                 return NULL;</span>
<span class="lineNum">    6999 </span>            : 
<span class="lineNum">    7000 </span><span class="lineCov">     528120 :         if (!s-&gt;length)</span>
<span class="lineNum">    7001 </span><span class="lineCov">        152 :                 return g_strdup (&quot;&quot;);</span>
<span class="lineNum">    7002 </span>            : 
<span class="lineNum">    7003 </span><span class="lineCov">     527976 :         as = g_utf16_to_utf8 (mono_string_chars (s), s-&gt;length, NULL, &amp;written, &amp;gerror);</span>
<span class="lineNum">    7004 </span><span class="lineCov">     527976 :         if (gerror) {</span>
<span class="lineNum">    7005 </span><span class="lineNoCov">          0 :                 mono_error_set_argument (error, &quot;string&quot;, &quot;%s&quot;, gerror-&gt;message);</span>
<span class="lineNum">    7006 </span><span class="lineNoCov">          0 :                 g_error_free (gerror);</span>
<span class="lineNum">    7007 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    7008 </span>            :         }
<span class="lineNum">    7009 </span>            :         /* g_utf16_to_utf8  may not be able to complete the convertion (e.g. NULL values were found, #335488) */
<span class="lineNum">    7010 </span><span class="lineCov">     527980 :         if (s-&gt;length &gt; written) {</span>
<span class="lineNum">    7011 </span>            :                 /* allocate the total length and copy the part of the string that has been converted */
<span class="lineNum">    7012 </span><span class="lineNoCov">          0 :                 char *as2 = (char *)g_malloc0 (s-&gt;length);</span>
<span class="lineNum">    7013 </span><span class="lineNoCov">          0 :                 memcpy (as2, as, written);</span>
<span class="lineNum">    7014 </span><span class="lineNoCov">          0 :                 g_free (as);</span>
<span class="lineNum">    7015 </span><span class="lineNoCov">          0 :                 as = as2;</span>
<span class="lineNum">    7016 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    7017 </span>            : 
<span class="lineNum">    7018 </span><span class="lineCov">     527979 :         return as;</span>
<span class="lineNum">    7019 </span><span class="lineCov">     528158 : }</span>
<a name="7020"><span class="lineNum">    7020 </span>            : </a>
<span class="lineNum">    7021 </span>            : char *
<span class="lineNum">    7022 </span>            : mono_string_handle_to_utf8 (MonoStringHandle s, MonoError *error)
<span class="lineNum">    7023 </span>            : {
<span class="lineNum">    7024 </span><span class="lineCov">     225906 :         return mono_string_to_utf8_checked (MONO_HANDLE_RAW (s), error);</span>
<span class="lineNum">    7025 </span>            : }
<span class="lineNum">    7026 </span>            : 
<span class="lineNum">    7027 </span>            : /**
<span class="lineNum">    7028 </span>            :  * mono_string_to_utf8_ignore:
<span class="lineNum">    7029 </span>            :  * @s: a MonoString
<span class="lineNum">    7030 </span>            :  *
<span class="lineNum">    7031 </span>            :  * Converts a MonoString to its UTF8 representation. Will ignore
<span class="lineNum">    7032 </span>            :  * invalid surrogate pairs.
<span class="lineNum">    7033 </span>            :  * The resulting buffer should be freed with mono_free().
<span class="lineNum">    7034 </span>            :  * 
<a name="7035"><span class="lineNum">    7035 </span>            :  */</a>
<span class="lineNum">    7036 </span>            : char *
<span class="lineNum">    7037 </span>            : mono_string_to_utf8_ignore (MonoString *s)
<span class="lineNum">    7038 </span>            : {
<span class="lineNum">    7039 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7040 </span>            : 
<span class="lineNum">    7041 </span><span class="lineCov">      10248 :         long written = 0;</span>
<span class="lineNum">    7042 </span>            :         char *as;
<span class="lineNum">    7043 </span>            : 
<span class="lineNum">    7044 </span><span class="lineCov">      10248 :         if (s == NULL)</span>
<span class="lineNum">    7045 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    7046 </span>            : 
<span class="lineNum">    7047 </span><span class="lineCov">      10248 :         if (!s-&gt;length)</span>
<span class="lineNum">    7048 </span><span class="lineCov">       2002 :                 return g_strdup (&quot;&quot;);</span>
<span class="lineNum">    7049 </span>            : 
<span class="lineNum">    7050 </span><span class="lineCov">       8246 :         as = g_utf16_to_utf8 (mono_string_chars (s), s-&gt;length, NULL, &amp;written, NULL);</span>
<span class="lineNum">    7051 </span>            : 
<span class="lineNum">    7052 </span>            :         /* g_utf16_to_utf8  may not be able to complete the convertion (e.g. NULL values were found, #335488) */
<span class="lineNum">    7053 </span><span class="lineCov">       8246 :         if (s-&gt;length &gt; written) {</span>
<span class="lineNum">    7054 </span>            :                 /* allocate the total length and copy the part of the string that has been converted */
<span class="lineNum">    7055 </span><span class="lineNoCov">          0 :                 char *as2 = (char *)g_malloc0 (s-&gt;length);</span>
<span class="lineNum">    7056 </span><span class="lineNoCov">          0 :                 memcpy (as2, as, written);</span>
<span class="lineNum">    7057 </span><span class="lineNoCov">          0 :                 g_free (as);</span>
<span class="lineNum">    7058 </span><span class="lineNoCov">          0 :                 as = as2;</span>
<span class="lineNum">    7059 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    7060 </span>            : 
<span class="lineNum">    7061 </span><span class="lineCov">       8246 :         return as;</span>
<span class="lineNum">    7062 </span><span class="lineCov">      10248 : }</span>
<span class="lineNum">    7063 </span>            : 
<span class="lineNum">    7064 </span>            : /**
<span class="lineNum">    7065 </span>            :  * mono_string_to_utf8_image_ignore:
<span class="lineNum">    7066 </span>            :  * @s: a System.String
<span class="lineNum">    7067 </span>            :  *
<span class="lineNum">    7068 </span>            :  * Same as mono_string_to_utf8_ignore, but allocate the string from the image mempool.
<a name="7069"><span class="lineNum">    7069 </span>            :  */</a>
<span class="lineNum">    7070 </span>            : char *
<span class="lineNum">    7071 </span>            : mono_string_to_utf8_image_ignore (MonoImage *image, MonoString *s)
<span class="lineNum">    7072 </span>            : {
<span class="lineNum">    7073 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7074 </span>            : 
<span class="lineNum">    7075 </span><span class="lineCov">      10248 :         return mono_string_to_utf8_internal (NULL, image, s, TRUE, NULL);</span>
<span class="lineNum">    7076 </span>            : }
<span class="lineNum">    7077 </span>            : 
<span class="lineNum">    7078 </span>            : /**
<span class="lineNum">    7079 </span>            :  * mono_string_to_utf8_mp_ignore:
<span class="lineNum">    7080 </span>            :  * @s: a System.String
<span class="lineNum">    7081 </span>            :  *
<span class="lineNum">    7082 </span>            :  * Same as mono_string_to_utf8_ignore, but allocate the string from a mempool.
<a name="7083"><span class="lineNum">    7083 </span>            :  */</a>
<span class="lineNum">    7084 </span>            : char *
<span class="lineNum">    7085 </span>            : mono_string_to_utf8_mp_ignore (MonoMemPool *mp, MonoString *s)
<span class="lineNum">    7086 </span>            : {
<span class="lineNum">    7087 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7088 </span>            : 
<span class="lineNum">    7089 </span><span class="lineNoCov">          0 :         return mono_string_to_utf8_internal (mp, NULL, s, TRUE, NULL);</span>
<span class="lineNum">    7090 </span>            : }
<span class="lineNum">    7091 </span>            : 
<span class="lineNum">    7092 </span>            : 
<span class="lineNum">    7093 </span>            : /**
<span class="lineNum">    7094 </span>            :  * mono_string_to_utf16:
<span class="lineNum">    7095 </span>            :  * @s: a MonoString
<span class="lineNum">    7096 </span>            :  *
<span class="lineNum">    7097 </span>            :  * Return an null-terminated array of the utf-16 chars
<span class="lineNum">    7098 </span>            :  * contained in @s. The result must be freed with g_free().
<span class="lineNum">    7099 </span>            :  * This is a temporary helper until our string implementation
<span class="lineNum">    7100 </span>            :  * is reworked to always include the null terminating char.
<a name="7101"><span class="lineNum">    7101 </span>            :  */</a>
<span class="lineNum">    7102 </span>            : mono_unichar2*
<span class="lineNum">    7103 </span>            : mono_string_to_utf16 (MonoString *s)
<span class="lineNum">    7104 </span>            : {
<span class="lineNum">    7105 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7106 </span>            : 
<span class="lineNum">    7107 </span>            :         char *as;
<span class="lineNum">    7108 </span>            : 
<span class="lineNum">    7109 </span><span class="lineNoCov">          0 :         if (s == NULL)</span>
<span class="lineNum">    7110 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    7111 </span>            : 
<span class="lineNum">    7112 </span><span class="lineNoCov">          0 :         as = (char *)g_malloc ((s-&gt;length * 2) + 2);</span>
<span class="lineNum">    7113 </span><span class="lineNoCov">          0 :         as [(s-&gt;length * 2)] = '\0';</span>
<span class="lineNum">    7114 </span><span class="lineNoCov">          0 :         as [(s-&gt;length * 2) + 1] = '\0';</span>
<span class="lineNum">    7115 </span>            : 
<span class="lineNum">    7116 </span><span class="lineNoCov">          0 :         if (!s-&gt;length) {</span>
<span class="lineNum">    7117 </span><span class="lineNoCov">          0 :                 return (gunichar2 *)(as);</span>
<span class="lineNum">    7118 </span>            :         }
<span class="lineNum">    7119 </span>            :         
<span class="lineNum">    7120 </span><span class="lineNoCov">          0 :         memcpy (as, mono_string_chars(s), s-&gt;length * 2);</span>
<span class="lineNum">    7121 </span><span class="lineNoCov">          0 :         return (gunichar2 *)(as);</span>
<span class="lineNum">    7122 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7123 </span>            : 
<span class="lineNum">    7124 </span>            : /**
<span class="lineNum">    7125 </span>            :  * mono_string_to_utf32:
<span class="lineNum">    7126 </span>            :  * @s: a MonoString
<span class="lineNum">    7127 </span>            :  *
<span class="lineNum">    7128 </span>            :  * Return an null-terminated array of the UTF-32 (UCS-4) chars
<span class="lineNum">    7129 </span>            :  * contained in @s. The result must be freed with g_free().
<a name="7130"><span class="lineNum">    7130 </span>            :  */</a>
<span class="lineNum">    7131 </span>            : mono_unichar4*
<span class="lineNum">    7132 </span>            : mono_string_to_utf32 (MonoString *s)
<span class="lineNum">    7133 </span>            : {
<span class="lineNum">    7134 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7135 </span>            : 
<span class="lineNum">    7136 </span><span class="lineNoCov">          0 :         mono_unichar4 *utf32_output = NULL; </span>
<span class="lineNum">    7137 </span><span class="lineNoCov">          0 :         GError *error = NULL;</span>
<span class="lineNum">    7138 </span>            :         glong items_written;
<span class="lineNum">    7139 </span>            :         
<span class="lineNum">    7140 </span><span class="lineNoCov">          0 :         if (s == NULL)</span>
<span class="lineNum">    7141 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    7142 </span>            :                 
<span class="lineNum">    7143 </span><span class="lineNoCov">          0 :         utf32_output = g_utf16_to_ucs4 (s-&gt;chars, s-&gt;length, NULL, &amp;items_written, &amp;error);</span>
<span class="lineNum">    7144 </span>            :         
<span class="lineNum">    7145 </span><span class="lineNoCov">          0 :         if (error)</span>
<span class="lineNum">    7146 </span><span class="lineNoCov">          0 :                 g_error_free (error);</span>
<span class="lineNum">    7147 </span>            : 
<span class="lineNum">    7148 </span><span class="lineNoCov">          0 :         return utf32_output;</span>
<span class="lineNum">    7149 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7150 </span>            : 
<span class="lineNum">    7151 </span>            : /**
<span class="lineNum">    7152 </span>            :  * mono_string_from_utf16:
<span class="lineNum">    7153 </span>            :  * @data: the UTF16 string (LPWSTR) to convert
<span class="lineNum">    7154 </span>            :  *
<span class="lineNum">    7155 </span>            :  * Converts a NULL terminated UTF16 string (LPWSTR) to a MonoString.
<span class="lineNum">    7156 </span>            :  *
<span class="lineNum">    7157 </span>            :  * Returns: a MonoString.
<a name="7158"><span class="lineNum">    7158 </span>            :  */</a>
<span class="lineNum">    7159 </span>            : MonoString *
<span class="lineNum">    7160 </span>            : mono_string_from_utf16 (gunichar2 *data)
<span class="lineNum">    7161 </span>            : {
<span class="lineNum">    7162 </span>            :         MonoError error;
<span class="lineNum">    7163 </span><span class="lineNoCov">          0 :         MonoString *result = mono_string_from_utf16_checked (data, &amp;error);</span>
<span class="lineNum">    7164 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    7165 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    7166 </span>            : }
<span class="lineNum">    7167 </span>            : 
<span class="lineNum">    7168 </span>            : /**
<span class="lineNum">    7169 </span>            :  * mono_string_from_utf16_checked:
<span class="lineNum">    7170 </span>            :  * @data: the UTF16 string (LPWSTR) to convert
<span class="lineNum">    7171 </span>            :  * @error: set on error
<span class="lineNum">    7172 </span>            :  *
<span class="lineNum">    7173 </span>            :  * Converts a NULL terminated UTF16 string (LPWSTR) to a MonoString.
<span class="lineNum">    7174 </span>            :  *
<span class="lineNum">    7175 </span>            :  * Returns: a MonoString. On failure sets @error and returns NULL.
<a name="7176"><span class="lineNum">    7176 </span>            :  */</a>
<span class="lineNum">    7177 </span>            : MonoString *
<span class="lineNum">    7178 </span>            : mono_string_from_utf16_checked (gunichar2 *data, MonoError *error)
<span class="lineNum">    7179 </span>            : {
<span class="lineNum">    7180 </span>            : 
<span class="lineNum">    7181 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7182 </span>            : 
<span class="lineNum">    7183 </span><span class="lineCov">      40667 :         mono_error_init (error);</span>
<span class="lineNum">    7184 </span><span class="lineCov">      40667 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    7185 </span><span class="lineCov">      40667 :         int len = 0;</span>
<span class="lineNum">    7186 </span>            : 
<span class="lineNum">    7187 </span><span class="lineCov">      40667 :         if (!data)</span>
<span class="lineNum">    7188 </span><span class="lineCov">          8 :                 return NULL;</span>
<span class="lineNum">    7189 </span>            : 
<span class="lineNum">    7190 </span><span class="lineCov">    1531211 :         while (data [len]) len++;</span>
<span class="lineNum">    7191 </span>            : 
<span class="lineNum">    7192 </span><span class="lineCov">      40655 :         return mono_string_new_utf16_checked (domain, data, len, error);</span>
<span class="lineNum">    7193 </span><span class="lineCov">      40668 : }</span>
<span class="lineNum">    7194 </span>            : 
<span class="lineNum">    7195 </span>            : /**
<span class="lineNum">    7196 </span>            :  * mono_string_from_utf32:
<span class="lineNum">    7197 </span>            :  * @data: the UTF32 string (LPWSTR) to convert
<span class="lineNum">    7198 </span>            :  *
<span class="lineNum">    7199 </span>            :  * Converts a UTF32 (UCS-4)to a MonoString.
<span class="lineNum">    7200 </span>            :  *
<span class="lineNum">    7201 </span>            :  * Returns: a MonoString.
<a name="7202"><span class="lineNum">    7202 </span>            :  */</a>
<span class="lineNum">    7203 </span>            : MonoString *
<span class="lineNum">    7204 </span>            : mono_string_from_utf32 (mono_unichar4 *data)
<span class="lineNum">    7205 </span>            : {
<span class="lineNum">    7206 </span>            :         MonoError error;
<span class="lineNum">    7207 </span><span class="lineNoCov">          0 :         MonoString *result = mono_string_from_utf32_checked (data, &amp;error);</span>
<span class="lineNum">    7208 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    7209 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    7210 </span>            : }
<span class="lineNum">    7211 </span>            : 
<span class="lineNum">    7212 </span>            : /**
<span class="lineNum">    7213 </span>            :  * mono_string_from_utf32_checked:
<span class="lineNum">    7214 </span>            :  * @data: the UTF32 string (LPWSTR) to convert
<span class="lineNum">    7215 </span>            :  * @error: set on error
<span class="lineNum">    7216 </span>            :  *
<span class="lineNum">    7217 </span>            :  * Converts a UTF32 (UCS-4)to a MonoString.
<span class="lineNum">    7218 </span>            :  *
<span class="lineNum">    7219 </span>            :  * Returns: a MonoString. On failure returns NULL and sets @error.
<a name="7220"><span class="lineNum">    7220 </span>            :  */</a>
<span class="lineNum">    7221 </span>            : MonoString *
<span class="lineNum">    7222 </span>            : mono_string_from_utf32_checked (mono_unichar4 *data, MonoError *error)
<span class="lineNum">    7223 </span>            : {
<span class="lineNum">    7224 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7225 </span>            : 
<span class="lineNum">    7226 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    7227 </span><span class="lineNoCov">          0 :         MonoString* result = NULL;</span>
<span class="lineNum">    7228 </span><span class="lineNoCov">          0 :         mono_unichar2 *utf16_output = NULL;</span>
<span class="lineNum">    7229 </span><span class="lineNoCov">          0 :         GError *gerror = NULL;</span>
<span class="lineNum">    7230 </span>            :         glong items_written;
<span class="lineNum">    7231 </span><span class="lineNoCov">          0 :         int len = 0;</span>
<span class="lineNum">    7232 </span>            : 
<span class="lineNum">    7233 </span><span class="lineNoCov">          0 :         if (!data)</span>
<span class="lineNum">    7234 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    7235 </span>            : 
<span class="lineNum">    7236 </span><span class="lineNoCov">          0 :         while (data [len]) len++;</span>
<span class="lineNum">    7237 </span>            : 
<span class="lineNum">    7238 </span><span class="lineNoCov">          0 :         utf16_output = g_ucs4_to_utf16 (data, len, NULL, &amp;items_written, &amp;gerror);</span>
<span class="lineNum">    7239 </span>            : 
<span class="lineNum">    7240 </span><span class="lineNoCov">          0 :         if (gerror)</span>
<span class="lineNum">    7241 </span><span class="lineNoCov">          0 :                 g_error_free (gerror);</span>
<span class="lineNum">    7242 </span>            : 
<span class="lineNum">    7243 </span><span class="lineNoCov">          0 :         result = mono_string_from_utf16_checked (utf16_output, error);</span>
<span class="lineNum">    7244 </span><span class="lineNoCov">          0 :         g_free (utf16_output);</span>
<span class="lineNum">    7245 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    7246 </span><span class="lineNoCov">          0 : }</span>
<a name="7247"><span class="lineNum">    7247 </span>            : </a>
<span class="lineNum">    7248 </span>            : static char *
<span class="lineNum">    7249 </span>            : mono_string_to_utf8_internal (MonoMemPool *mp, MonoImage *image, MonoString *s, gboolean ignore_error, MonoError *error)
<span class="lineNum">    7250 </span>            : {
<span class="lineNum">    7251 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7252 </span>            : 
<span class="lineNum">    7253 </span>            :         char *r;
<span class="lineNum">    7254 </span>            :         char *mp_s;
<span class="lineNum">    7255 </span>            :         int len;
<span class="lineNum">    7256 </span>            : 
<span class="lineNum">    7257 </span><span class="lineCov">      10868 :         if (ignore_error) {</span>
<span class="lineNum">    7258 </span><span class="lineCov">      10248 :                 r = mono_string_to_utf8_ignore (s);</span>
<span class="lineNum">    7259 </span><span class="lineCov">      10248 :         } else {</span>
<span class="lineNum">    7260 </span><span class="lineCov">        620 :                 r = mono_string_to_utf8_checked (s, error);</span>
<span class="lineNum">    7261 </span><span class="lineCov">        620 :                 if (!mono_error_ok (error))</span>
<span class="lineNum">    7262 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    7263 </span>            :         }
<span class="lineNum">    7264 </span>            : 
<span class="lineNum">    7265 </span><span class="lineCov">      21594 :         if (!mp &amp;&amp; !image)</span>
<span class="lineNum">    7266 </span><span class="lineCov">      10016 :                 return r;</span>
<span class="lineNum">    7267 </span>            : 
<span class="lineNum">    7268 </span><span class="lineCov">        852 :         len = strlen (r) + 1;</span>
<span class="lineNum">    7269 </span><span class="lineCov">        852 :         if (mp)</span>
<span class="lineNum">    7270 </span><span class="lineCov">        142 :                 mp_s = (char *)mono_mempool_alloc (mp, len);</span>
<span class="lineNum">    7271 </span>            :         else
<span class="lineNum">    7272 </span><span class="lineCov">        710 :                 mp_s = (char *)mono_image_alloc (image, len);</span>
<span class="lineNum">    7273 </span>            : 
<span class="lineNum">    7274 </span><span class="lineCov">        852 :         memcpy (mp_s, r, len);</span>
<span class="lineNum">    7275 </span>            : 
<span class="lineNum">    7276 </span><span class="lineCov">        852 :         g_free (r);</span>
<span class="lineNum">    7277 </span>            : 
<span class="lineNum">    7278 </span><span class="lineCov">        852 :         return mp_s;</span>
<span class="lineNum">    7279 </span><span class="lineCov">      10868 : }</span>
<span class="lineNum">    7280 </span>            : 
<span class="lineNum">    7281 </span>            : /**
<span class="lineNum">    7282 </span>            :  * mono_string_to_utf8_image:
<span class="lineNum">    7283 </span>            :  * @s: a System.String
<span class="lineNum">    7284 </span>            :  *
<span class="lineNum">    7285 </span>            :  * Same as mono_string_to_utf8, but allocate the string from the image mempool.
<a name="7286"><span class="lineNum">    7286 </span>            :  */</a>
<span class="lineNum">    7287 </span>            : char *
<span class="lineNum">    7288 </span>            : mono_string_to_utf8_image (MonoImage *image, MonoString *s, MonoError *error)
<span class="lineNum">    7289 </span>            : {
<span class="lineNum">    7290 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7291 </span>            : 
<span class="lineNum">    7292 </span><span class="lineCov">        478 :         return mono_string_to_utf8_internal (NULL, image, s, FALSE, error);</span>
<span class="lineNum">    7293 </span>            : }
<span class="lineNum">    7294 </span>            : 
<span class="lineNum">    7295 </span>            : /**
<span class="lineNum">    7296 </span>            :  * mono_string_to_utf8_mp:
<span class="lineNum">    7297 </span>            :  * @s: a System.String
<span class="lineNum">    7298 </span>            :  *
<span class="lineNum">    7299 </span>            :  * Same as mono_string_to_utf8, but allocate the string from a mempool.
<a name="7300"><span class="lineNum">    7300 </span>            :  */</a>
<span class="lineNum">    7301 </span>            : char *
<span class="lineNum">    7302 </span>            : mono_string_to_utf8_mp (MonoMemPool *mp, MonoString *s, MonoError *error)
<span class="lineNum">    7303 </span>            : {
<span class="lineNum">    7304 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7305 </span>            : 
<span class="lineNum">    7306 </span><span class="lineCov">        142 :         return mono_string_to_utf8_internal (mp, NULL, s, FALSE, error);</span>
<span class="lineNum">    7307 </span>            : }
<span class="lineNum">    7308 </span>            : 
<span class="lineNum">    7309 </span>            : 
<span class="lineNum">    7310 </span>            : static MonoRuntimeExceptionHandlingCallbacks eh_callbacks;
<a name="7311"><span class="lineNum">    7311 </span>            : </a>
<span class="lineNum">    7312 </span>            : void
<span class="lineNum">    7313 </span>            : mono_install_eh_callbacks (MonoRuntimeExceptionHandlingCallbacks *cbs)
<span class="lineNum">    7314 </span>            : {
<span class="lineNum">    7315 </span><span class="lineCov">       3285 :         eh_callbacks = *cbs;</span>
<span class="lineNum">    7316 </span><span class="lineCov">       3285 : }</span>
<a name="7317"><span class="lineNum">    7317 </span>            : </a>
<span class="lineNum">    7318 </span>            : MonoRuntimeExceptionHandlingCallbacks *
<span class="lineNum">    7319 </span>            : mono_get_eh_callbacks (void)
<span class="lineNum">    7320 </span>            : {
<span class="lineNum">    7321 </span><span class="lineCov">    1319443 :         return &amp;eh_callbacks;</span>
<span class="lineNum">    7322 </span>            : }
<span class="lineNum">    7323 </span>            : 
<span class="lineNum">    7324 </span>            : /**
<span class="lineNum">    7325 </span>            :  * mono_raise_exception:
<span class="lineNum">    7326 </span>            :  * @ex: exception object
<span class="lineNum">    7327 </span>            :  *
<span class="lineNum">    7328 </span>            :  * Signal the runtime that the exception @ex has been raised in unmanaged code.
<a name="7329"><span class="lineNum">    7329 </span>            :  */</a>
<span class="lineNum">    7330 </span>            : void
<span class="lineNum">    7331 </span>            : mono_raise_exception (MonoException *ex) 
<span class="lineNum">    7332 </span>            : {
<span class="lineNum">    7333 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7334 </span>            : 
<span class="lineNum">    7335 </span>            :         /*
<span class="lineNum">    7336 </span>            :          * NOTE: Do NOT annotate this function with G_GNUC_NORETURN, since
<span class="lineNum">    7337 </span>            :          * that will cause gcc to omit the function epilog, causing problems when
<span class="lineNum">    7338 </span>            :          * the JIT tries to walk the stack, since the return address on the stack
<span class="lineNum">    7339 </span>            :          * will point into the next function in the executable, not this one.
<span class="lineNum">    7340 </span>            :          */     
<span class="lineNum">    7341 </span><span class="lineCov">        536 :         eh_callbacks.mono_raise_exception (ex);</span>
<span class="lineNum">    7342 </span><span class="lineCov">        536 : }</span>
<a name="7343"><span class="lineNum">    7343 </span>            : </a>
<span class="lineNum">    7344 </span>            : void
<span class="lineNum">    7345 </span>            : mono_raise_exception_with_context (MonoException *ex, MonoContext *ctx) 
<span class="lineNum">    7346 </span>            : {
<span class="lineNum">    7347 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7348 </span>            : 
<span class="lineNum">    7349 </span><span class="lineNoCov">          0 :         eh_callbacks.mono_raise_exception_with_ctx (ex, ctx);</span>
<span class="lineNum">    7350 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7351 </span>            : 
<span class="lineNum">    7352 </span>            : /**
<span class="lineNum">    7353 </span>            :  * mono_wait_handle_new:
<span class="lineNum">    7354 </span>            :  * @domain: Domain where the object will be created
<span class="lineNum">    7355 </span>            :  * @handle: Handle for the wait handle
<span class="lineNum">    7356 </span>            :  * @error: set on error.
<span class="lineNum">    7357 </span>            :  *
<span class="lineNum">    7358 </span>            :  * Returns: A new MonoWaitHandle created in the given domain for the
<span class="lineNum">    7359 </span>            :  * given handle.  On failure returns NULL and sets @rror.
<a name="7360"><span class="lineNum">    7360 </span>            :  */</a>
<span class="lineNum">    7361 </span>            : MonoWaitHandle *
<span class="lineNum">    7362 </span>            : mono_wait_handle_new (MonoDomain *domain, HANDLE handle, MonoError *error)
<span class="lineNum">    7363 </span>            : {
<span class="lineNum">    7364 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7365 </span>            : 
<span class="lineNum">    7366 </span>            :         MonoWaitHandle *res;
<span class="lineNum">    7367 </span>            :         gpointer params [1];
<span class="lineNum">    7368 </span>            :         static MonoMethod *handle_set;
<span class="lineNum">    7369 </span>            : 
<span class="lineNum">    7370 </span><span class="lineCov">        473 :         mono_error_init (error);</span>
<span class="lineNum">    7371 </span><span class="lineCov">        473 :         res = (MonoWaitHandle *)mono_object_new_checked (domain, mono_defaults.manualresetevent_class, error);</span>
<span class="lineNum">    7372 </span><span class="lineCov">       1419 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7373 </span>            : 
<span class="lineNum">    7374 </span>            :         /* Even though this method is virtual, it's safe to invoke directly, since the object type matches.  */
<span class="lineNum">    7375 </span><span class="lineCov">        473 :         if (!handle_set)</span>
<span class="lineNum">    7376 </span><span class="lineCov">         50 :                 handle_set = mono_class_get_property_from_name (mono_defaults.manualresetevent_class, &quot;Handle&quot;)-&gt;set;</span>
<span class="lineNum">    7377 </span>            : 
<span class="lineNum">    7378 </span><span class="lineCov">        473 :         params [0] = &amp;handle;</span>
<span class="lineNum">    7379 </span>            : 
<span class="lineNum">    7380 </span><span class="lineCov">        473 :         mono_runtime_invoke_checked (handle_set, res, params, error);</span>
<span class="lineNum">    7381 </span><span class="lineCov">        473 :         return res;</span>
<span class="lineNum">    7382 </span><span class="lineCov">        473 : }</span>
<a name="7383"><span class="lineNum">    7383 </span>            : </a>
<span class="lineNum">    7384 </span>            : HANDLE
<span class="lineNum">    7385 </span>            : mono_wait_handle_get_handle (MonoWaitHandle *handle)
<span class="lineNum">    7386 </span>            : {
<span class="lineNum">    7387 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7388 </span>            : 
<span class="lineNum">    7389 </span>            :         static MonoClassField *f_safe_handle = NULL;
<span class="lineNum">    7390 </span>            :         MonoSafeHandle *sh;
<span class="lineNum">    7391 </span>            : 
<span class="lineNum">    7392 </span><span class="lineCov">       2818 :         if (!f_safe_handle) {</span>
<span class="lineNum">    7393 </span><span class="lineCov">         21 :                 f_safe_handle = mono_class_get_field_from_name (mono_defaults.manualresetevent_class, &quot;safeWaitHandle&quot;);</span>
<span class="lineNum">    7394 </span><span class="lineCov">         63 :                 g_assert (f_safe_handle);</span>
<span class="lineNum">    7395 </span><span class="lineCov">         21 :         }</span>
<span class="lineNum">    7396 </span>            : 
<span class="lineNum">    7397 </span><span class="lineCov">       2818 :         mono_field_get_value ((MonoObject*)handle, f_safe_handle, &amp;sh);</span>
<span class="lineNum">    7398 </span><span class="lineCov">       2818 :         return sh-&gt;handle;</span>
<span class="lineNum">    7399 </span>            : }
<span class="lineNum">    7400 </span>            : 
<a name="7401"><span class="lineNum">    7401 </span>            : </a>
<span class="lineNum">    7402 </span>            : static MonoObject*
<span class="lineNum">    7403 </span>            : mono_runtime_capture_context (MonoDomain *domain, MonoError *error)
<span class="lineNum">    7404 </span>            : {
<span class="lineNum">    7405 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7406 </span>            : 
<span class="lineNum">    7407 </span>            :         RuntimeInvokeFunction runtime_invoke;
<span class="lineNum">    7408 </span>            : 
<span class="lineNum">    7409 </span><span class="lineCov">        464 :         mono_error_init (error);</span>
<span class="lineNum">    7410 </span>            : 
<span class="lineNum">    7411 </span><span class="lineCov">        878 :         if (!domain-&gt;capture_context_runtime_invoke || !domain-&gt;capture_context_method) {</span>
<span class="lineNum">    7412 </span><span class="lineCov">         50 :                 MonoMethod *method = mono_get_context_capture_method ();</span>
<span class="lineNum">    7413 </span>            :                 MonoMethod *wrapper;
<span class="lineNum">    7414 </span><span class="lineCov">         50 :                 if (!method)</span>
<span class="lineNum">    7415 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    7416 </span><span class="lineCov">         50 :                 wrapper = mono_marshal_get_runtime_invoke (method, FALSE);</span>
<span class="lineNum">    7417 </span><span class="lineCov">         50 :                 domain-&gt;capture_context_runtime_invoke = mono_compile_method_checked (wrapper, error);</span>
<span class="lineNum">    7418 </span><span class="lineCov">        150 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7419 </span><span class="lineCov">         50 :                 domain-&gt;capture_context_method = mono_compile_method_checked (method, error);</span>
<span class="lineNum">    7420 </span><span class="lineCov">        150 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7421 </span><span class="lineCov">         50 :         }</span>
<span class="lineNum">    7422 </span>            : 
<span class="lineNum">    7423 </span><span class="lineCov">        464 :         runtime_invoke = (RuntimeInvokeFunction)domain-&gt;capture_context_runtime_invoke;</span>
<span class="lineNum">    7424 </span>            : 
<span class="lineNum">    7425 </span><span class="lineCov">        464 :         return runtime_invoke (NULL, NULL, NULL, domain-&gt;capture_context_method);</span>
<span class="lineNum">    7426 </span><span class="lineCov">        464 : }</span>
<span class="lineNum">    7427 </span>            : /**
<span class="lineNum">    7428 </span>            :  * mono_async_result_new:
<span class="lineNum">    7429 </span>            :  * @domain:domain where the object will be created.
<span class="lineNum">    7430 </span>            :  * @handle: wait handle.
<span class="lineNum">    7431 </span>            :  * @state: state to pass to AsyncResult
<span class="lineNum">    7432 </span>            :  * @data: C closure data.
<span class="lineNum">    7433 </span>            :  * @error: set on error.
<span class="lineNum">    7434 </span>            :  *
<span class="lineNum">    7435 </span>            :  * Creates a new MonoAsyncResult (AsyncResult C# class) in the given domain.
<span class="lineNum">    7436 </span>            :  * If the handle is not null, the handle is initialized to a MonOWaitHandle.
<span class="lineNum">    7437 </span>            :  * On failure returns NULL and sets @error.
<span class="lineNum">    7438 </span>            :  *
<a name="7439"><span class="lineNum">    7439 </span>            :  */</a>
<span class="lineNum">    7440 </span>            : MonoAsyncResult *
<span class="lineNum">    7441 </span>            : mono_async_result_new (MonoDomain *domain, HANDLE handle, MonoObject *state, gpointer data, MonoObject *object_data, MonoError *error)
<span class="lineNum">    7442 </span>            : {
<span class="lineNum">    7443 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7444 </span>            : 
<span class="lineNum">    7445 </span><span class="lineCov">        464 :         mono_error_init (error);</span>
<span class="lineNum">    7446 </span><span class="lineCov">        464 :         MonoAsyncResult *res = (MonoAsyncResult *)mono_object_new_checked (domain, mono_defaults.asyncresult_class, error);</span>
<span class="lineNum">    7447 </span><span class="lineCov">       1392 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7448 </span><span class="lineCov">        464 :         MonoObject *context = mono_runtime_capture_context (domain, error);</span>
<span class="lineNum">    7449 </span><span class="lineCov">       1392 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7450 </span>            :         /* we must capture the execution context from the original thread */
<span class="lineNum">    7451 </span><span class="lineCov">        464 :         if (context) {</span>
<span class="lineNum">    7452 </span><span class="lineCov">        928 :                 MONO_OBJECT_SETREF (res, execution_context, context);</span>
<span class="lineNum">    7453 </span>            :                 /* note: result may be null if the flow is suppressed */
<span class="lineNum">    7454 </span><span class="lineCov">        464 :         }</span>
<span class="lineNum">    7455 </span>            : 
<span class="lineNum">    7456 </span><span class="lineCov">        464 :         res-&gt;data = (void **)data;</span>
<span class="lineNum">    7457 </span><span class="lineCov">        928 :         MONO_OBJECT_SETREF (res, object_data, object_data);</span>
<span class="lineNum">    7458 </span><span class="lineCov">        928 :         MONO_OBJECT_SETREF (res, async_state, state);</span>
<span class="lineNum">    7459 </span><span class="lineCov">        464 :         MonoWaitHandle *wait_handle = mono_wait_handle_new (domain, handle, error);</span>
<span class="lineNum">    7460 </span><span class="lineCov">       1392 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7461 </span><span class="lineCov">        464 :         if (handle != NULL)</span>
<span class="lineNum">    7462 </span><span class="lineNoCov">          0 :                 MONO_OBJECT_SETREF (res, handle, (MonoObject *) wait_handle);</span>
<span class="lineNum">    7463 </span>            : 
<span class="lineNum">    7464 </span><span class="lineCov">        464 :         res-&gt;sync_completed = FALSE;</span>
<span class="lineNum">    7465 </span><span class="lineCov">        464 :         res-&gt;completed = FALSE;</span>
<span class="lineNum">    7466 </span>            : 
<span class="lineNum">    7467 </span><span class="lineCov">        464 :         return res;</span>
<span class="lineNum">    7468 </span><span class="lineCov">        464 : }</span>
<a name="7469"><span class="lineNum">    7469 </span>            : </a>
<span class="lineNum">    7470 </span>            : MonoObject *
<span class="lineNum">    7471 </span>            : ves_icall_System_Runtime_Remoting_Messaging_AsyncResult_Invoke (MonoAsyncResult *ares)
<span class="lineNum">    7472 </span>            : {
<span class="lineNum">    7473 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7474 </span>            : 
<span class="lineNum">    7475 </span>            :         MonoError error;
<span class="lineNum">    7476 </span>            :         MonoAsyncCall *ac;
<span class="lineNum">    7477 </span>            :         MonoObject *res;
<span class="lineNum">    7478 </span>            : 
<span class="lineNum">    7479 </span><span class="lineCov">        180 :         g_assert (ares);</span>
<span class="lineNum">    7480 </span><span class="lineCov">        180 :         g_assert (ares-&gt;async_delegate);</span>
<span class="lineNum">    7481 </span>            : 
<span class="lineNum">    7482 </span><span class="lineCov">         60 :         ac = (MonoAsyncCall*) ares-&gt;object_data;</span>
<span class="lineNum">    7483 </span><span class="lineCov">         60 :         if (!ac) {</span>
<span class="lineNum">    7484 </span><span class="lineNoCov">          0 :                 res = mono_runtime_delegate_invoke_checked (ares-&gt;async_delegate, (void**) &amp;ares-&gt;async_state, &amp;error);</span>
<span class="lineNum">    7485 </span><span class="lineNoCov">          0 :                 if (mono_error_set_pending_exception (&amp;error))</span>
<span class="lineNum">    7486 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    7487 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    7488 </span><span class="lineCov">         58 :                 gpointer wait_event = NULL;</span>
<span class="lineNum">    7489 </span>            : 
<span class="lineNum">    7490 </span><span class="lineCov">         58 :                 ac-&gt;msg-&gt;exc = NULL;</span>
<span class="lineNum">    7491 </span>            : 
<span class="lineNum">    7492 </span><span class="lineCov">         58 :                 res = mono_message_invoke (ares-&gt;async_delegate, ac-&gt;msg, &amp;ac-&gt;msg-&gt;exc, &amp;ac-&gt;out_args, &amp;error);</span>
<span class="lineNum">    7493 </span>            : 
<span class="lineNum">    7494 </span>            :                 /* The exit side of the invoke must not be aborted as it would leave the runtime in an undefined state */
<span class="lineNum">    7495 </span><span class="lineCov">         58 :                 mono_threads_begin_abort_protected_block ();</span>
<span class="lineNum">    7496 </span>            : 
<span class="lineNum">    7497 </span><span class="lineCov">         58 :                 if (!ac-&gt;msg-&gt;exc) {</span>
<span class="lineNum">    7498 </span><span class="lineCov">         26 :                         MonoException *ex = mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    7499 </span><span class="lineCov">         26 :                         ac-&gt;msg-&gt;exc = (MonoObject *)ex;</span>
<span class="lineNum">    7500 </span><span class="lineCov">         26 :                 } else {</span>
<span class="lineNum">    7501 </span><span class="lineCov">         32 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    7502 </span>            :                 }
<span class="lineNum">    7503 </span>            : 
<span class="lineNum">    7504 </span><span class="lineCov">        116 :                 MONO_OBJECT_SETREF (ac, res, res);</span>
<span class="lineNum">    7505 </span>            : 
<span class="lineNum">    7506 </span><span class="lineCov">         58 :                 mono_monitor_enter ((MonoObject*) ares);</span>
<span class="lineNum">    7507 </span><span class="lineCov">         58 :                 ares-&gt;completed = 1;</span>
<span class="lineNum">    7508 </span><span class="lineCov">         58 :                 if (ares-&gt;handle)</span>
<span class="lineNum">    7509 </span><span class="lineCov">         18 :                         wait_event = mono_wait_handle_get_handle ((MonoWaitHandle*) ares-&gt;handle);</span>
<span class="lineNum">    7510 </span><span class="lineCov">         58 :                 mono_monitor_exit ((MonoObject*) ares);</span>
<span class="lineNum">    7511 </span>            : 
<span class="lineNum">    7512 </span><span class="lineCov">         58 :                 if (wait_event != NULL)</span>
<span class="lineNum">    7513 </span><span class="lineCov">         18 :                         mono_w32event_set (wait_event);</span>
<span class="lineNum">    7514 </span>            : 
<span class="lineNum">    7515 </span><span class="lineCov">         58 :                 mono_error_init (&amp;error); //the else branch would leave it in an undefined state</span>
<span class="lineNum">    7516 </span><span class="lineCov">         58 :                 if (ac-&gt;cb_method)</span>
<span class="lineNum">    7517 </span><span class="lineCov">         42 :                         mono_runtime_invoke_checked (ac-&gt;cb_method, ac-&gt;cb_target, (gpointer*) &amp;ares, &amp;error);</span>
<span class="lineNum">    7518 </span>            : 
<span class="lineNum">    7519 </span><span class="lineCov">         44 :                 mono_threads_end_abort_protected_block ();</span>
<span class="lineNum">    7520 </span>            : 
<span class="lineNum">    7521 </span><span class="lineCov">         44 :                 if (mono_error_set_pending_exception (&amp;error))</span>
<span class="lineNum">    7522 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    7523 </span>            :         }
<span class="lineNum">    7524 </span>            : 
<span class="lineNum">    7525 </span><span class="lineCov">         44 :         return res;</span>
<span class="lineNum">    7526 </span><span class="lineCov">         44 : }</span>
<a name="7527"><span class="lineNum">    7527 </span>            : </a>
<span class="lineNum">    7528 </span>            : gboolean
<span class="lineNum">    7529 </span>            : mono_message_init (MonoDomain *domain,
<span class="lineNum">    7530 </span>            :                    MonoMethodMessage *this_obj, 
<span class="lineNum">    7531 </span>            :                    MonoReflectionMethod *method,
<span class="lineNum">    7532 </span>            :                    MonoArray *out_args,
<span class="lineNum">    7533 </span>            :                    MonoError *error)
<span class="lineNum">    7534 </span>            : {
<span class="lineNum">    7535 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7536 </span>            : 
<span class="lineNum">    7537 </span>            :         static MonoMethod *init_message_method = NULL;
<span class="lineNum">    7538 </span>            : 
<span class="lineNum">    7539 </span><span class="lineCov">       1744 :         if (!init_message_method) {</span>
<span class="lineNum">    7540 </span><span class="lineCov">         69 :                 init_message_method = mono_class_get_method_from_name (mono_defaults.mono_method_message_class, &quot;InitMessage&quot;, 2);</span>
<span class="lineNum">    7541 </span><span class="lineCov">        207 :                 g_assert (init_message_method != NULL);</span>
<span class="lineNum">    7542 </span><span class="lineCov">         69 :         }</span>
<span class="lineNum">    7543 </span>            : 
<span class="lineNum">    7544 </span><span class="lineCov">       1744 :         mono_error_init (error);</span>
<span class="lineNum">    7545 </span>            :         /* FIXME set domain instead? */
<span class="lineNum">    7546 </span><span class="lineCov">       5232 :         g_assert (domain == mono_domain_get ());</span>
<span class="lineNum">    7547 </span>            :         
<span class="lineNum">    7548 </span>            :         gpointer args[2];
<span class="lineNum">    7549 </span>            : 
<span class="lineNum">    7550 </span><span class="lineCov">       1744 :         args[0] = method;</span>
<span class="lineNum">    7551 </span><span class="lineCov">       1744 :         args[1] = out_args;</span>
<span class="lineNum">    7552 </span>            : 
<span class="lineNum">    7553 </span><span class="lineCov">       1744 :         mono_runtime_invoke_checked (init_message_method, this_obj, args, error);</span>
<span class="lineNum">    7554 </span><span class="lineCov">       1744 :         return is_ok (error);</span>
<span class="lineNum">    7555 </span>            : }
<span class="lineNum">    7556 </span>            : 
<span class="lineNum">    7557 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    7558 </span>            : /**
<span class="lineNum">    7559 </span>            :  * mono_remoting_invoke:
<span class="lineNum">    7560 </span>            :  * @real_proxy: pointer to a RealProxy object
<span class="lineNum">    7561 </span>            :  * @msg: The MonoMethodMessage to execute
<span class="lineNum">    7562 </span>            :  * @exc: used to store exceptions
<span class="lineNum">    7563 </span>            :  * @out_args: used to store output arguments
<span class="lineNum">    7564 </span>            :  *
<span class="lineNum">    7565 </span>            :  * This is used to call RealProxy::Invoke(). RealProxy::Invoke() returns an
<span class="lineNum">    7566 </span>            :  * IMessage interface and it is not trivial to extract results from there. So
<span class="lineNum">    7567 </span>            :  * we call an helper method PrivateInvoke instead of calling
<span class="lineNum">    7568 </span>            :  * RealProxy::Invoke() directly.
<span class="lineNum">    7569 </span>            :  *
<span class="lineNum">    7570 </span>            :  * Returns: the result object.
<a name="7571"><span class="lineNum">    7571 </span>            :  */</a>
<span class="lineNum">    7572 </span>            : MonoObject *
<span class="lineNum">    7573 </span>            : mono_remoting_invoke (MonoObject *real_proxy, MonoMethodMessage *msg, MonoObject **exc, MonoArray **out_args, MonoError *error)
<span class="lineNum">    7574 </span>            : {
<span class="lineNum">    7575 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7576 </span>            : 
<span class="lineNum">    7577 </span>            :         MonoObject *o;
<span class="lineNum">    7578 </span><span class="lineCov">       1247 :         MonoMethod *im = real_proxy-&gt;vtable-&gt;domain-&gt;private_invoke_method;</span>
<span class="lineNum">    7579 </span>            :         gpointer pa [4];
<span class="lineNum">    7580 </span>            : 
<span class="lineNum">    7581 </span><span class="lineCov">       3741 :         g_assert (exc);</span>
<span class="lineNum">    7582 </span>            : 
<span class="lineNum">    7583 </span><span class="lineCov">       1247 :         mono_error_init (error);</span>
<span class="lineNum">    7584 </span>            : 
<span class="lineNum">    7585 </span>            :         /*static MonoObject *(*invoke) (gpointer, gpointer, MonoObject **, MonoArray **) = NULL;*/
<span class="lineNum">    7586 </span>            : 
<span class="lineNum">    7587 </span><span class="lineCov">       1247 :         if (!im) {</span>
<span class="lineNum">    7588 </span><span class="lineCov">         26 :                 im = mono_class_get_method_from_name (mono_defaults.real_proxy_class, &quot;PrivateInvoke&quot;, 4);</span>
<span class="lineNum">    7589 </span><span class="lineCov">         26 :                 if (!im) {</span>
<span class="lineNum">    7590 </span><span class="lineNoCov">          0 :                         mono_error_set_not_supported (error, &quot;Linked away.&quot;);</span>
<span class="lineNum">    7591 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    7592 </span>            :                 }
<span class="lineNum">    7593 </span><span class="lineCov">         26 :                 real_proxy-&gt;vtable-&gt;domain-&gt;private_invoke_method = im;</span>
<span class="lineNum">    7594 </span><span class="lineCov">         26 :         }</span>
<span class="lineNum">    7595 </span>            : 
<span class="lineNum">    7596 </span><span class="lineCov">       1247 :         pa [0] = real_proxy;</span>
<span class="lineNum">    7597 </span><span class="lineCov">       1247 :         pa [1] = msg;</span>
<span class="lineNum">    7598 </span><span class="lineCov">       1247 :         pa [2] = exc;</span>
<span class="lineNum">    7599 </span><span class="lineCov">       1247 :         pa [3] = out_args;</span>
<span class="lineNum">    7600 </span>            : 
<span class="lineNum">    7601 </span><span class="lineCov">       1247 :         o = mono_runtime_try_invoke (im, NULL, pa, exc, error);</span>
<span class="lineNum">    7602 </span><span class="lineCov">       3741 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7603 </span>            : 
<span class="lineNum">    7604 </span><span class="lineCov">       1247 :         return o;</span>
<span class="lineNum">    7605 </span><span class="lineCov">       1247 : }</span>
<span class="lineNum">    7606 </span>            : #endif
<a name="7607"><span class="lineNum">    7607 </span>            : </a>
<span class="lineNum">    7608 </span>            : MonoObject *
<span class="lineNum">    7609 </span>            : mono_message_invoke (MonoObject *target, MonoMethodMessage *msg, 
<span class="lineNum">    7610 </span>            :                      MonoObject **exc, MonoArray **out_args, MonoError *error) 
<span class="lineNum">    7611 </span>            : {
<span class="lineNum">    7612 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7613 </span>            : 
<span class="lineNum">    7614 </span>            :         static MonoClass *object_array_klass;
<span class="lineNum">    7615 </span><span class="lineCov">         60 :         mono_error_init (error);</span>
<span class="lineNum">    7616 </span>            : 
<span class="lineNum">    7617 </span>            :         MonoDomain *domain; 
<span class="lineNum">    7618 </span>            :         MonoMethod *method;
<span class="lineNum">    7619 </span>            :         MonoMethodSignature *sig;
<span class="lineNum">    7620 </span>            :         MonoArray *arr;
<span class="lineNum">    7621 </span><span class="lineCov">         60 :         int i, j, outarg_count = 0;</span>
<span class="lineNum">    7622 </span>            : 
<span class="lineNum">    7623 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    7624 </span><span class="lineCov">        120 :         if (target &amp;&amp; mono_object_is_transparent_proxy (target)) {</span>
<span class="lineNum">    7625 </span><span class="lineNoCov">          0 :                 MonoTransparentProxy* tp = (MonoTransparentProxy *)target;</span>
<span class="lineNum">    7626 </span><span class="lineNoCov">          0 :                 if (mono_class_is_contextbound (tp-&gt;remote_class-&gt;proxy_class) &amp;&amp; tp-&gt;rp-&gt;context == (MonoObject *) mono_context_get ()) {</span>
<span class="lineNum">    7627 </span><span class="lineNoCov">          0 :                         target = tp-&gt;rp-&gt;unwrapped_server;</span>
<span class="lineNum">    7628 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    7629 </span><span class="lineNoCov">          0 :                         return mono_remoting_invoke ((MonoObject *)tp-&gt;rp, msg, exc, out_args, error);</span>
<span class="lineNum">    7630 </span>            :                 }
<span class="lineNum">    7631 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    7632 </span>            : #endif
<span class="lineNum">    7633 </span>            : 
<span class="lineNum">    7634 </span><span class="lineCov">         60 :         domain = mono_domain_get (); </span>
<span class="lineNum">    7635 </span><span class="lineCov">         60 :         method = msg-&gt;method-&gt;method;</span>
<span class="lineNum">    7636 </span><span class="lineCov">         60 :         sig = mono_method_signature (method);</span>
<span class="lineNum">    7637 </span>            : 
<span class="lineNum">    7638 </span><span class="lineCov">        216 :         for (i = 0; i &lt; sig-&gt;param_count; i++) {</span>
<span class="lineNum">    7639 </span><span class="lineCov">         48 :                 if (sig-&gt;params [i]-&gt;byref) </span>
<span class="lineNum">    7640 </span><span class="lineCov">          4 :                         outarg_count++;</span>
<span class="lineNum">    7641 </span><span class="lineCov">         48 :         }</span>
<span class="lineNum">    7642 </span>            : 
<span class="lineNum">    7643 </span><span class="lineCov">         60 :         if (!object_array_klass) {</span>
<span class="lineNum">    7644 </span>            :                 MonoClass *klass;
<span class="lineNum">    7645 </span>            : 
<span class="lineNum">    7646 </span><span class="lineCov">         44 :                 klass = mono_array_class_get (mono_defaults.object_class, 1);</span>
<span class="lineNum">    7647 </span><span class="lineCov">        132 :                 g_assert (klass);</span>
<span class="lineNum">    7648 </span>            : 
<span class="lineNum">    7649 </span><span class="lineCov">         44 :                 mono_memory_barrier ();</span>
<span class="lineNum">    7650 </span><span class="lineCov">         44 :                 object_array_klass = klass;</span>
<span class="lineNum">    7651 </span><span class="lineCov">         44 :         }</span>
<span class="lineNum">    7652 </span>            : 
<span class="lineNum">    7653 </span><span class="lineCov">         60 :         arr = mono_array_new_specific_checked (mono_class_vtable (domain, object_array_klass), outarg_count, error);</span>
<span class="lineNum">    7654 </span><span class="lineCov">        180 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7655 </span>            : 
<span class="lineNum">    7656 </span><span class="lineCov">         60 :         mono_gc_wbarrier_generic_store (out_args, (MonoObject*) arr);</span>
<span class="lineNum">    7657 </span><span class="lineCov">         60 :         *exc = NULL;</span>
<span class="lineNum">    7658 </span>            : 
<span class="lineNum">    7659 </span><span class="lineCov">        180 :         MonoObject *ret = mono_runtime_try_invoke_array (method, method-&gt;klass-&gt;valuetype? mono_object_unbox (target): target, msg-&gt;args, exc, error);</span>
<span class="lineNum">    7660 </span><span class="lineCov">        176 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7661 </span>            : 
<span class="lineNum">    7662 </span><span class="lineCov">        212 :         for (i = 0, j = 0; i &lt; sig-&gt;param_count; i++) {</span>
<span class="lineNum">    7663 </span><span class="lineCov">         48 :                 if (sig-&gt;params [i]-&gt;byref) {</span>
<span class="lineNum">    7664 </span>            :                         MonoObject* arg;
<span class="lineNum">    7665 </span><span class="lineCov">          4 :                         arg = (MonoObject *)mono_array_get (msg-&gt;args, gpointer, i);</span>
<span class="lineNum">    7666 </span><span class="lineCov">          8 :                         mono_array_setref (*out_args, j, arg);</span>
<span class="lineNum">    7667 </span><span class="lineCov">          4 :                         j++;</span>
<span class="lineNum">    7668 </span><span class="lineCov">          4 :                 }</span>
<span class="lineNum">    7669 </span><span class="lineCov">         48 :         }</span>
<span class="lineNum">    7670 </span>            : 
<span class="lineNum">    7671 </span><span class="lineCov">         58 :         return ret;</span>
<span class="lineNum">    7672 </span><span class="lineCov">         58 : }</span>
<span class="lineNum">    7673 </span>            : 
<span class="lineNum">    7674 </span>            : /**
<span class="lineNum">    7675 </span>            :  * prepare_to_string_method:
<span class="lineNum">    7676 </span>            :  * @obj: The object
<span class="lineNum">    7677 </span>            :  * @target: Set to @obj or unboxed value if a valuetype
<span class="lineNum">    7678 </span>            :  *
<span class="lineNum">    7679 </span>            :  * Returns: the ToString override for @obj. If @obj is a valuetype, @target is unboxed otherwise it's @obj.
<a name="7680"><span class="lineNum">    7680 </span>            :  */</a>
<span class="lineNum">    7681 </span>            : static MonoMethod *
<span class="lineNum">    7682 </span>            : prepare_to_string_method (MonoObject *obj, void **target)
<span class="lineNum">    7683 </span>            : {
<span class="lineNum">    7684 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7685 </span>            : 
<span class="lineNum">    7686 </span>            :         static MonoMethod *to_string = NULL;
<span class="lineNum">    7687 </span>            :         MonoMethod *method;
<span class="lineNum">    7688 </span><span class="lineCov">         51 :         g_assert (target);</span>
<span class="lineNum">    7689 </span><span class="lineCov">         51 :         g_assert (obj);</span>
<span class="lineNum">    7690 </span>            : 
<span class="lineNum">    7691 </span><span class="lineCov">         17 :         *target = obj;</span>
<span class="lineNum">    7692 </span>            : 
<span class="lineNum">    7693 </span><span class="lineCov">         17 :         if (!to_string)</span>
<span class="lineNum">    7694 </span><span class="lineCov">         11 :                 to_string = mono_class_get_method_from_name_flags (mono_get_object_class (), &quot;ToString&quot;, 0, METHOD_ATTRIBUTE_VIRTUAL | METHOD_ATTRIBUTE_PUBLIC);</span>
<span class="lineNum">    7695 </span>            : 
<span class="lineNum">    7696 </span><span class="lineCov">         17 :         method = mono_object_get_virtual_method (obj, to_string);</span>
<span class="lineNum">    7697 </span>            : 
<span class="lineNum">    7698 </span>            :         // Unbox value type if needed
<span class="lineNum">    7699 </span><span class="lineCov">         17 :         if (mono_class_is_valuetype (mono_method_get_class (method))) {</span>
<span class="lineNum">    7700 </span><span class="lineNoCov">          0 :                 *target = mono_object_unbox (obj);</span>
<span class="lineNum">    7701 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    7702 </span><span class="lineCov">         17 :         return method;</span>
<span class="lineNum">    7703 </span>            : }
<span class="lineNum">    7704 </span>            : 
<span class="lineNum">    7705 </span>            : /**
<span class="lineNum">    7706 </span>            :  * mono_object_to_string:
<span class="lineNum">    7707 </span>            :  * @obj: The object
<span class="lineNum">    7708 </span>            :  * @exc: Any exception thrown by ToString (). May be NULL.
<span class="lineNum">    7709 </span>            :  *
<span class="lineNum">    7710 </span>            :  * Returns: the result of calling ToString () on an object.
<a name="7711"><span class="lineNum">    7711 </span>            :  */</a>
<span class="lineNum">    7712 </span>            : MonoString *
<span class="lineNum">    7713 </span>            : mono_object_to_string (MonoObject *obj, MonoObject **exc)
<span class="lineNum">    7714 </span>            : {
<span class="lineNum">    7715 </span>            :         MonoError error;
<span class="lineNum">    7716 </span><span class="lineNoCov">          0 :         MonoString *s = NULL;</span>
<span class="lineNum">    7717 </span>            :         void *target;
<span class="lineNum">    7718 </span><span class="lineNoCov">          0 :         MonoMethod *method = prepare_to_string_method (obj, &amp;target);</span>
<span class="lineNum">    7719 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    7720 </span><span class="lineNoCov">          0 :                 s = (MonoString *) mono_runtime_try_invoke (method, target, NULL, exc, &amp;error);</span>
<span class="lineNum">    7721 </span><span class="lineNoCov">          0 :                 if (*exc == NULL &amp;&amp; !mono_error_ok (&amp;error))</span>
<span class="lineNum">    7722 </span><span class="lineNoCov">          0 :                         *exc = (MonoObject*) mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    7723 </span>            :                 else
<span class="lineNum">    7724 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    7725 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    7726 </span><span class="lineNoCov">          0 :                 s = (MonoString *) mono_runtime_invoke_checked (method, target, NULL, &amp;error);</span>
<span class="lineNum">    7727 </span><span class="lineNoCov">          0 :                 mono_error_raise_exception (&amp;error); /* OK to throw, external only without a good alternative */</span>
<span class="lineNum">    7728 </span>            :         }
<span class="lineNum">    7729 </span>            : 
<span class="lineNum">    7730 </span><span class="lineNoCov">          0 :         return s;</span>
<span class="lineNum">    7731 </span>            : }
<span class="lineNum">    7732 </span>            : 
<span class="lineNum">    7733 </span>            : /**
<span class="lineNum">    7734 </span>            :  * mono_object_to_string_checked:
<span class="lineNum">    7735 </span>            :  * @obj: The object
<span class="lineNum">    7736 </span>            :  * @error: Set on error.
<span class="lineNum">    7737 </span>            :  *
<span class="lineNum">    7738 </span>            :  * Returns: the result of calling ToString () on an object. If the
<span class="lineNum">    7739 </span>            :  * method cannot be invoked or if it raises an exception, sets @error
<span class="lineNum">    7740 </span>            :  * and returns NULL.
<a name="7741"><span class="lineNum">    7741 </span>            :  */</a>
<span class="lineNum">    7742 </span>            : MonoString *
<span class="lineNum">    7743 </span>            : mono_object_to_string_checked (MonoObject *obj, MonoError *error)
<span class="lineNum">    7744 </span>            : {
<span class="lineNum">    7745 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    7746 </span>            :         void *target;
<span class="lineNum">    7747 </span><span class="lineNoCov">          0 :         MonoMethod *method = prepare_to_string_method (obj, &amp;target);</span>
<span class="lineNum">    7748 </span><span class="lineNoCov">          0 :         return (MonoString*) mono_runtime_invoke_checked (method, target, NULL, error);</span>
<span class="lineNum">    7749 </span>            : }
<span class="lineNum">    7750 </span>            : 
<span class="lineNum">    7751 </span>            : /**
<span class="lineNum">    7752 </span>            :  * mono_object_try_to_string:
<span class="lineNum">    7753 </span>            :  * @obj: The object
<span class="lineNum">    7754 </span>            :  * @exc: Any exception thrown by ToString (). Must not be NULL.
<span class="lineNum">    7755 </span>            :  * @error: Set if method cannot be invoked.
<span class="lineNum">    7756 </span>            :  *
<span class="lineNum">    7757 </span>            :  * Returns: the result of calling ToString () on an object. If the
<span class="lineNum">    7758 </span>            :  * method cannot be invoked sets @error, if it raises an exception sets @exc,
<span class="lineNum">    7759 </span>            :  * and returns NULL.
<a name="7760"><span class="lineNum">    7760 </span>            :  */</a>
<span class="lineNum">    7761 </span>            : MonoString *
<span class="lineNum">    7762 </span>            : mono_object_try_to_string (MonoObject *obj, MonoObject **exc, MonoError *error)
<span class="lineNum">    7763 </span>            : {
<span class="lineNum">    7764 </span><span class="lineCov">         51 :         g_assert (exc);</span>
<span class="lineNum">    7765 </span><span class="lineCov">         17 :         mono_error_init (error);</span>
<span class="lineNum">    7766 </span>            :         void *target;
<span class="lineNum">    7767 </span><span class="lineCov">         17 :         MonoMethod *method = prepare_to_string_method (obj, &amp;target);</span>
<span class="lineNum">    7768 </span><span class="lineCov">         17 :         return (MonoString*) mono_runtime_try_invoke (method, target, NULL, exc, error);</span>
<span class="lineNum">    7769 </span>            : }
<span class="lineNum">    7770 </span>            : 
<span class="lineNum">    7771 </span>            : 
<a name="7772"><span class="lineNum">    7772 </span>            : </a>
<span class="lineNum">    7773 </span>            : static char *
<span class="lineNum">    7774 </span>            : get_native_backtrace (MonoException *exc_raw)
<span class="lineNum">    7775 </span>            : {
<span class="lineNum">    7776 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_ENTER ();</span>
<span class="lineNum">    7777 </span><span class="lineNoCov">          0 :         MONO_HANDLE_DCL(MonoException, exc);</span>
<span class="lineNum">    7778 </span><span class="lineNoCov">          0 :         char * trace = mono_exception_handle_get_native_backtrace (exc);</span>
<span class="lineNum">    7779 </span><span class="lineNoCov">          0 :         HANDLE_FUNCTION_RETURN_VAL (trace);</span>
<span class="lineNum">    7780 </span>            : }
<span class="lineNum">    7781 </span>            : 
<span class="lineNum">    7782 </span>            : /**
<span class="lineNum">    7783 </span>            :  * mono_print_unhandled_exception:
<span class="lineNum">    7784 </span>            :  * @exc: The exception
<span class="lineNum">    7785 </span>            :  *
<span class="lineNum">    7786 </span>            :  * Prints the unhandled exception.
<a name="7787"><span class="lineNum">    7787 </span>            :  */</a>
<span class="lineNum">    7788 </span>            : void
<span class="lineNum">    7789 </span>            : mono_print_unhandled_exception (MonoObject *exc)
<span class="lineNum">    7790 </span>            : {
<span class="lineNum">    7791 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7792 </span>            : 
<span class="lineNum">    7793 </span>            :         MonoString * str;
<span class="lineNum">    7794 </span><span class="lineCov">          6 :         char *message = (char*)&quot;&quot;;</span>
<span class="lineNum">    7795 </span><span class="lineCov">          6 :         gboolean free_message = FALSE;</span>
<span class="lineNum">    7796 </span>            :         MonoError error;
<span class="lineNum">    7797 </span>            : 
<span class="lineNum">    7798 </span><span class="lineCov">          6 :         if (exc == (MonoObject*)mono_object_domain (exc)-&gt;out_of_memory_ex) {</span>
<span class="lineNum">    7799 </span><span class="lineNoCov">          0 :                 message = g_strdup (&quot;OutOfMemoryException&quot;);</span>
<span class="lineNum">    7800 </span><span class="lineNoCov">          0 :                 free_message = TRUE;</span>
<span class="lineNum">    7801 </span><span class="lineCov">          6 :         } else if (exc == (MonoObject*)mono_object_domain (exc)-&gt;stack_overflow_ex) {</span>
<span class="lineNum">    7802 </span><span class="lineNoCov">          0 :                 message = g_strdup (&quot;StackOverflowException&quot;); //if we OVF, we can't expect to have stack space to JIT Exception::ToString.</span>
<span class="lineNum">    7803 </span><span class="lineNoCov">          0 :                 free_message = TRUE;</span>
<span class="lineNum">    7804 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    7805 </span>            :                 
<span class="lineNum">    7806 </span><span class="lineCov">          6 :                 if (((MonoException*)exc)-&gt;native_trace_ips) {</span>
<span class="lineNum">    7807 </span><span class="lineNoCov">          0 :                         message = get_native_backtrace ((MonoException*)exc);</span>
<span class="lineNum">    7808 </span><span class="lineNoCov">          0 :                         free_message = TRUE;</span>
<span class="lineNum">    7809 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    7810 </span><span class="lineCov">          6 :                         MonoObject *other_exc = NULL;</span>
<span class="lineNum">    7811 </span><span class="lineCov">          6 :                         str = mono_object_try_to_string (exc, &amp;other_exc, &amp;error);</span>
<span class="lineNum">    7812 </span><span class="lineCov">         12 :                         if (other_exc == NULL &amp;&amp; !is_ok (&amp;error))</span>
<span class="lineNum">    7813 </span><span class="lineNoCov">          0 :                                 other_exc = (MonoObject*)mono_error_convert_to_exception (&amp;error);</span>
<span class="lineNum">    7814 </span>            :                         else
<span class="lineNum">    7815 </span><span class="lineCov">          6 :                                 mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    7816 </span><span class="lineCov">          6 :                         if (other_exc) {</span>
<span class="lineNum">    7817 </span><span class="lineNoCov">          0 :                                 char *original_backtrace = mono_exception_get_managed_backtrace ((MonoException*)exc);</span>
<span class="lineNum">    7818 </span><span class="lineNoCov">          0 :                                 char *nested_backtrace = mono_exception_get_managed_backtrace ((MonoException*)other_exc);</span>
<span class="lineNum">    7819 </span>            :                                 
<span class="lineNum">    7820 </span><span class="lineNoCov">          0 :                                 message = g_strdup_printf (&quot;Nested exception detected.\nOriginal Exception: %s\nNested exception:%s\n&quot;,</span>
<span class="lineNum">    7821 </span><span class="lineNoCov">          0 :                                         original_backtrace, nested_backtrace);</span>
<span class="lineNum">    7822 </span>            : 
<span class="lineNum">    7823 </span><span class="lineNoCov">          0 :                                 g_free (original_backtrace);</span>
<span class="lineNum">    7824 </span><span class="lineNoCov">          0 :                                 g_free (nested_backtrace);</span>
<span class="lineNum">    7825 </span><span class="lineNoCov">          0 :                                 free_message = TRUE;</span>
<span class="lineNum">    7826 </span><span class="lineCov">          6 :                         } else if (str) {</span>
<span class="lineNum">    7827 </span><span class="lineCov">          6 :                                 message = mono_string_to_utf8_checked (str, &amp;error);</span>
<span class="lineNum">    7828 </span><span class="lineCov">          6 :                                 if (!mono_error_ok (&amp;error)) {</span>
<span class="lineNum">    7829 </span><span class="lineNoCov">          0 :                                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    7830 </span><span class="lineNoCov">          0 :                                         message = (char *) &quot;&quot;;</span>
<span class="lineNum">    7831 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">    7832 </span><span class="lineCov">          6 :                                         free_message = TRUE;</span>
<span class="lineNum">    7833 </span>            :                                 }
<span class="lineNum">    7834 </span><span class="lineCov">          6 :                         }</span>
<span class="lineNum">    7835 </span>            :                 }
<span class="lineNum">    7836 </span>            :         }
<span class="lineNum">    7837 </span>            : 
<span class="lineNum">    7838 </span>            :         /*
<span class="lineNum">    7839 </span>            :          * g_printerr (&quot;\nUnhandled Exception: %s.%s: %s\n&quot;, exc-&gt;vtable-&gt;klass-&gt;name_space, 
<span class="lineNum">    7840 </span>            :          *         exc-&gt;vtable-&gt;klass-&gt;name, message);
<span class="lineNum">    7841 </span>            :          */
<span class="lineNum">    7842 </span><span class="lineCov">          6 :         g_printerr (&quot;\nUnhandled Exception:\n%s\n&quot;, message);</span>
<span class="lineNum">    7843 </span>            :         
<span class="lineNum">    7844 </span><span class="lineCov">          6 :         if (free_message)</span>
<span class="lineNum">    7845 </span><span class="lineCov">          6 :                 g_free (message);</span>
<span class="lineNum">    7846 </span><span class="lineCov">          6 : }</span>
<span class="lineNum">    7847 </span>            : 
<span class="lineNum">    7848 </span>            : /**
<span class="lineNum">    7849 </span>            :  * mono_delegate_ctor_with_method:
<span class="lineNum">    7850 </span>            :  * @this: pointer to an uninitialized delegate object
<span class="lineNum">    7851 </span>            :  * @target: target object
<span class="lineNum">    7852 </span>            :  * @addr: pointer to native code
<span class="lineNum">    7853 </span>            :  * @method: method
<span class="lineNum">    7854 </span>            :  * @error: set on error.
<span class="lineNum">    7855 </span>            :  *
<span class="lineNum">    7856 </span>            :  * Initialize a delegate and sets a specific method, not the one
<span class="lineNum">    7857 </span>            :  * associated with addr.  This is useful when sharing generic code.
<span class="lineNum">    7858 </span>            :  * In that case addr will most probably not be associated with the
<span class="lineNum">    7859 </span>            :  * correct instantiation of the method.
<span class="lineNum">    7860 </span>            :  * On failure returns FALSE and sets @error.
<a name="7861"><span class="lineNum">    7861 </span>            :  */</a>
<span class="lineNum">    7862 </span>            : gboolean
<span class="lineNum">    7863 </span>            : mono_delegate_ctor_with_method (MonoObject *this_obj, MonoObject *target, gpointer addr, MonoMethod *method, MonoError *error)
<span class="lineNum">    7864 </span>            : {
<span class="lineNum">    7865 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7866 </span>            : 
<span class="lineNum">    7867 </span><span class="lineCov">     264732 :         mono_error_init (error);</span>
<span class="lineNum">    7868 </span><span class="lineCov">     264732 :         MonoDelegate *delegate = (MonoDelegate *)this_obj;</span>
<span class="lineNum">    7869 </span>            : 
<span class="lineNum">    7870 </span><span class="lineCov">     794214 :         g_assert (this_obj);</span>
<span class="lineNum">    7871 </span><span class="lineCov">     794223 :         g_assert (addr);</span>
<span class="lineNum">    7872 </span>            : 
<span class="lineNum">    7873 </span><span class="lineCov">     794214 :         g_assert (mono_class_has_parent (mono_object_class (this_obj), mono_defaults.multicastdelegate_class));</span>
<span class="lineNum">    7874 </span>            : 
<span class="lineNum">    7875 </span><span class="lineCov">     264739 :         if (method)</span>
<span class="lineNum">    7876 </span><span class="lineCov">     264739 :                 delegate-&gt;method = method;</span>
<span class="lineNum">    7877 </span>            : 
<span class="lineNum">    7878 </span><span class="lineCov">     264717 :         mono_stats.delegate_creations++;</span>
<span class="lineNum">    7879 </span>            : 
<span class="lineNum">    7880 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    7881 </span><span class="lineCov">     515241 :         if (target &amp;&amp; mono_object_is_transparent_proxy (target)) {</span>
<span class="lineNum">    7882 </span><span class="lineCov">         18 :                 g_assert (method);</span>
<span class="lineNum">    7883 </span><span class="lineCov">          6 :                 method = mono_marshal_get_remoting_invoke (method);</span>
<span class="lineNum">    7884 </span><span class="lineCov">          6 :                 delegate-&gt;method_ptr = mono_compile_method_checked (method, error);</span>
<span class="lineNum">    7885 </span><span class="lineCov">         18 :                 return_val_if_nok (error, FALSE);</span>
<span class="lineNum">    7886 </span><span class="lineCov">         12 :                 MONO_OBJECT_SETREF (delegate, target, target);</span>
<span class="lineNum">    7887 </span><span class="lineCov">          6 :         } else</span>
<span class="lineNum">    7888 </span>            : #endif
<span class="lineNum">    7889 </span>            :         {
<span class="lineNum">    7890 </span><span class="lineCov">     264710 :                 delegate-&gt;method_ptr = addr;</span>
<span class="lineNum">    7891 </span><span class="lineCov">     529425 :                 MONO_OBJECT_SETREF (delegate, target, target);</span>
<span class="lineNum">    7892 </span>            :         }
<span class="lineNum">    7893 </span>            : 
<span class="lineNum">    7894 </span><span class="lineCov">     264749 :         delegate-&gt;invoke_impl = callbacks.create_delegate_trampoline (delegate-&gt;object.vtable-&gt;domain, delegate-&gt;object.vtable-&gt;klass);</span>
<span class="lineNum">    7895 </span><span class="lineCov">     264749 :         if (callbacks.init_delegate)</span>
<span class="lineNum">    7896 </span><span class="lineCov">     264749 :                 callbacks.init_delegate (delegate);</span>
<span class="lineNum">    7897 </span><span class="lineCov">     264749 :         return TRUE;</span>
<span class="lineNum">    7898 </span><span class="lineCov">     264749 : }</span>
<span class="lineNum">    7899 </span>            : 
<span class="lineNum">    7900 </span>            : /**
<span class="lineNum">    7901 </span>            :  * mono_delegate_ctor:
<span class="lineNum">    7902 </span>            :  * @this: pointer to an uninitialized delegate object
<span class="lineNum">    7903 </span>            :  * @target: target object
<span class="lineNum">    7904 </span>            :  * @addr: pointer to native code
<span class="lineNum">    7905 </span>            :  * @error: set on error.
<span class="lineNum">    7906 </span>            :  *
<span class="lineNum">    7907 </span>            :  * This is used to initialize a delegate.
<span class="lineNum">    7908 </span>            :  * On failure returns FALSE and sets @error.
<a name="7909"><span class="lineNum">    7909 </span>            :  */</a>
<span class="lineNum">    7910 </span>            : gboolean
<span class="lineNum">    7911 </span>            : mono_delegate_ctor (MonoObject *this_obj, MonoObject *target, gpointer addr, MonoError *error)
<span class="lineNum">    7912 </span>            : {
<span class="lineNum">    7913 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7914 </span>            : 
<span class="lineNum">    7915 </span><span class="lineCov">     252448 :         mono_error_init (error);</span>
<span class="lineNum">    7916 </span><span class="lineCov">     252448 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    7917 </span>            :         MonoJitInfo *ji;
<span class="lineNum">    7918 </span><span class="lineCov">     252448 :         MonoMethod *method = NULL;</span>
<span class="lineNum">    7919 </span>            : 
<span class="lineNum">    7920 </span><span class="lineCov">     757394 :         g_assert (addr);</span>
<span class="lineNum">    7921 </span>            : 
<span class="lineNum">    7922 </span><span class="lineCov">     252482 :         ji = mono_jit_info_table_find (domain, (char *)mono_get_addr_from_ftnptr (addr));</span>
<span class="lineNum">    7923 </span>            :         /* Shared code */
<span class="lineNum">    7924 </span><span class="lineCov">     252482 :         if (!ji &amp;&amp; domain != mono_get_root_domain ())</span>
<span class="lineNum">    7925 </span><span class="lineNoCov">          0 :                 ji = mono_jit_info_table_find (mono_get_root_domain (), (char *)mono_get_addr_from_ftnptr (addr));</span>
<span class="lineNum">    7926 </span><span class="lineCov">     252476 :         if (ji) {</span>
<span class="lineNum">    7927 </span><span class="lineCov">     252478 :                 method = mono_jit_info_get_method (ji);</span>
<span class="lineNum">    7928 </span><span class="lineCov">     757427 :                 g_assert (!mono_class_is_gtd (method-&gt;klass));</span>
<span class="lineNum">    7929 </span><span class="lineCov">     252477 :         }</span>
<span class="lineNum">    7930 </span>            : 
<span class="lineNum">    7931 </span><span class="lineCov">     252479 :         return mono_delegate_ctor_with_method (this_obj, target, addr, method, error);</span>
<span class="lineNum">    7932 </span>            : }
<span class="lineNum">    7933 </span>            : 
<span class="lineNum">    7934 </span>            : /**
<span class="lineNum">    7935 </span>            :  * mono_method_call_message_new:
<span class="lineNum">    7936 </span>            :  * @method: method to encapsulate
<span class="lineNum">    7937 </span>            :  * @params: parameters to the method
<span class="lineNum">    7938 </span>            :  * @invoke: optional, delegate invoke.
<span class="lineNum">    7939 </span>            :  * @cb: async callback delegate.
<span class="lineNum">    7940 </span>            :  * @state: state passed to the async callback.
<span class="lineNum">    7941 </span>            :  * @error: set on error.
<span class="lineNum">    7942 </span>            :  *
<span class="lineNum">    7943 </span>            :  * Translates arguments pointers into a MonoMethodMessage.
<span class="lineNum">    7944 </span>            :  * On failure returns NULL and sets @error.
<a name="7945"><span class="lineNum">    7945 </span>            :  */</a>
<span class="lineNum">    7946 </span>            : MonoMethodMessage *
<span class="lineNum">    7947 </span>            : mono_method_call_message_new (MonoMethod *method, gpointer *params, MonoMethod *invoke, 
<span class="lineNum">    7948 </span>            :                               MonoDelegate **cb, MonoObject **state, MonoError *error)
<span class="lineNum">    7949 </span>            : {
<span class="lineNum">    7950 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    7951 </span>            : 
<span class="lineNum">    7952 </span><span class="lineCov">       1740 :         mono_error_init (error);</span>
<span class="lineNum">    7953 </span>            : 
<span class="lineNum">    7954 </span><span class="lineCov">       1740 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    7955 </span><span class="lineCov">       1740 :         MonoMethodSignature *sig = mono_method_signature (method);</span>
<span class="lineNum">    7956 </span>            :         MonoMethodMessage *msg;
<span class="lineNum">    7957 </span>            :         int i, count;
<span class="lineNum">    7958 </span>            : 
<span class="lineNum">    7959 </span><span class="lineCov">       1740 :         msg = (MonoMethodMessage *)mono_object_new_checked (domain, mono_defaults.mono_method_message_class, error); </span>
<span class="lineNum">    7960 </span><span class="lineCov">       5220 :         return_val_if_nok  (error, NULL);</span>
<span class="lineNum">    7961 </span>            : 
<span class="lineNum">    7962 </span><span class="lineCov">       1740 :         if (invoke) {</span>
<span class="lineNum">    7963 </span><span class="lineCov">        460 :                 MonoReflectionMethod *rm = mono_method_get_object_checked (domain, invoke, NULL, error);</span>
<span class="lineNum">    7964 </span><span class="lineCov">       1380 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7965 </span><span class="lineCov">        460 :                 mono_message_init (domain, msg, rm, NULL, error);</span>
<span class="lineNum">    7966 </span><span class="lineCov">       1380 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7967 </span><span class="lineCov">        460 :                 count =  sig-&gt;param_count - 2;</span>
<span class="lineNum">    7968 </span><span class="lineCov">        460 :         } else {</span>
<span class="lineNum">    7969 </span><span class="lineCov">       1280 :                 MonoReflectionMethod *rm = mono_method_get_object_checked (domain, method, NULL, error);</span>
<span class="lineNum">    7970 </span><span class="lineCov">       3840 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7971 </span><span class="lineCov">       1280 :                 mono_message_init (domain, msg, rm, NULL, error);</span>
<span class="lineNum">    7972 </span><span class="lineCov">       3840 :                 return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7973 </span><span class="lineCov">       1280 :                 count =  sig-&gt;param_count;</span>
<span class="lineNum">    7974 </span>            :         }
<span class="lineNum">    7975 </span>            : 
<span class="lineNum">    7976 </span><span class="lineCov">       6146 :         for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    7977 </span>            :                 gpointer vpos;
<span class="lineNum">    7978 </span>            :                 MonoClass *klass;
<span class="lineNum">    7979 </span>            :                 MonoObject *arg;
<span class="lineNum">    7980 </span>            : 
<span class="lineNum">    7981 </span><span class="lineCov">       1333 :                 if (sig-&gt;params [i]-&gt;byref)</span>
<span class="lineNum">    7982 </span><span class="lineCov">         18 :                         vpos = *((gpointer *)params [i]);</span>
<span class="lineNum">    7983 </span>            :                 else 
<span class="lineNum">    7984 </span><span class="lineCov">       1315 :                         vpos = params [i];</span>
<span class="lineNum">    7985 </span>            : 
<span class="lineNum">    7986 </span><span class="lineCov">       1333 :                 klass = mono_class_from_mono_type (sig-&gt;params [i]);</span>
<span class="lineNum">    7987 </span>            : 
<span class="lineNum">    7988 </span><span class="lineCov">       1333 :                 if (klass-&gt;valuetype) {</span>
<span class="lineNum">    7989 </span><span class="lineCov">       1273 :                         arg = mono_value_box_checked (domain, klass, vpos, error);</span>
<span class="lineNum">    7990 </span><span class="lineCov">       3819 :                         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    7991 </span><span class="lineCov">       1273 :                 } else </span>
<span class="lineNum">    7992 </span><span class="lineCov">         60 :                         arg = *((MonoObject **)vpos);</span>
<span class="lineNum">    7993 </span>            :                       
<span class="lineNum">    7994 </span><span class="lineCov">       2666 :                 mono_array_setref (msg-&gt;args, i, arg);</span>
<span class="lineNum">    7995 </span><span class="lineCov">       1333 :         }</span>
<span class="lineNum">    7996 </span>            : 
<span class="lineNum">    7997 </span><span class="lineCov">       2204 :         if (cb != NULL &amp;&amp; state != NULL) {</span>
<span class="lineNum">    7998 </span><span class="lineCov">        464 :                 *cb = *((MonoDelegate **)params [i]);</span>
<span class="lineNum">    7999 </span><span class="lineCov">        464 :                 i++;</span>
<span class="lineNum">    8000 </span><span class="lineCov">        464 :                 *state = *((MonoObject **)params [i]);</span>
<span class="lineNum">    8001 </span><span class="lineCov">        464 :         }</span>
<span class="lineNum">    8002 </span>            : 
<span class="lineNum">    8003 </span><span class="lineCov">       1740 :         return msg;</span>
<span class="lineNum">    8004 </span><span class="lineCov">       1740 : }</span>
<span class="lineNum">    8005 </span>            : 
<span class="lineNum">    8006 </span>            : /**
<span class="lineNum">    8007 </span>            :  * mono_method_return_message_restore:
<span class="lineNum">    8008 </span>            :  *
<span class="lineNum">    8009 </span>            :  * Restore results from message based processing back to arguments pointers
<a name="8010"><span class="lineNum">    8010 </span>            :  */</a>
<span class="lineNum">    8011 </span>            : void
<span class="lineNum">    8012 </span>            : mono_method_return_message_restore (MonoMethod *method, gpointer *params, MonoArray *out_args, MonoError *error)
<span class="lineNum">    8013 </span>            : {
<span class="lineNum">    8014 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8015 </span>            : 
<span class="lineNum">    8016 </span><span class="lineCov">       1267 :         mono_error_init (error);</span>
<span class="lineNum">    8017 </span>            : 
<span class="lineNum">    8018 </span><span class="lineCov">       1267 :         MonoMethodSignature *sig = mono_method_signature (method);</span>
<span class="lineNum">    8019 </span>            :         int i, j, type, size, out_len;
<span class="lineNum">    8020 </span>            :         
<span class="lineNum">    8021 </span><span class="lineCov">       1267 :         if (out_args == NULL)</span>
<span class="lineNum">    8022 </span><span class="lineCov">         13 :                 return;</span>
<span class="lineNum">    8023 </span><span class="lineCov">       1254 :         out_len = mono_array_length (out_args);</span>
<span class="lineNum">    8024 </span><span class="lineCov">       1254 :         if (out_len == 0)</span>
<span class="lineNum">    8025 </span><span class="lineCov">       1244 :                 return;</span>
<span class="lineNum">    8026 </span>            : 
<span class="lineNum">    8027 </span><span class="lineCov">         68 :         for (i = 0, j = 0; i &lt; sig-&gt;param_count; i++) {</span>
<span class="lineNum">    8028 </span><span class="lineCov">         24 :                 MonoType *pt = sig-&gt;params [i];</span>
<span class="lineNum">    8029 </span>            : 
<span class="lineNum">    8030 </span><span class="lineCov">         24 :                 if (pt-&gt;byref) {</span>
<span class="lineNum">    8031 </span>            :                         char *arg;
<span class="lineNum">    8032 </span><span class="lineCov">         12 :                         if (j &gt;= out_len) {</span>
<span class="lineNum">    8033 </span><span class="lineNoCov">          0 :                                 mono_error_set_execution_engine (error, &quot;The proxy call returned an incorrect number of output arguments&quot;);</span>
<span class="lineNum">    8034 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    8035 </span>            :                         }
<span class="lineNum">    8036 </span>            : 
<span class="lineNum">    8037 </span><span class="lineCov">         12 :                         arg = (char *)mono_array_get (out_args, gpointer, j);</span>
<span class="lineNum">    8038 </span><span class="lineCov">         12 :                         type = pt-&gt;type;</span>
<span class="lineNum">    8039 </span>            : 
<span class="lineNum">    8040 </span><span class="lineCov">         36 :                         g_assert (type != MONO_TYPE_VOID);</span>
<span class="lineNum">    8041 </span>            : 
<span class="lineNum">    8042 </span><span class="lineCov">         12 :                         if (MONO_TYPE_IS_REFERENCE (pt)) {</span>
<span class="lineNum">    8043 </span><span class="lineCov">          6 :                                 mono_gc_wbarrier_generic_store (*((MonoObject ***)params [i]), (MonoObject *)arg);</span>
<span class="lineNum">    8044 </span><span class="lineCov">          6 :                         } else {</span>
<span class="lineNum">    8045 </span><span class="lineCov">          6 :                                 if (arg) {</span>
<span class="lineNum">    8046 </span><span class="lineCov">          6 :                                         MonoClass *klass = ((MonoObject*)arg)-&gt;vtable-&gt;klass;</span>
<span class="lineNum">    8047 </span><span class="lineCov">          6 :                                         size = mono_class_value_size (klass, NULL);</span>
<span class="lineNum">    8048 </span><span class="lineCov">          6 :                                         if (klass-&gt;has_references)</span>
<span class="lineNum">    8049 </span><span class="lineNoCov">          0 :                                                 mono_gc_wbarrier_value_copy (*((gpointer *)params [i]), arg + sizeof (MonoObject), 1, klass);</span>
<span class="lineNum">    8050 </span>            :                                         else
<span class="lineNum">    8051 </span><span class="lineCov">          6 :                                                 mono_gc_memmove_atomic (*((gpointer *)params [i]), arg + sizeof (MonoObject), size);</span>
<span class="lineNum">    8052 </span><span class="lineCov">          6 :                                 } else {</span>
<span class="lineNum">    8053 </span><span class="lineNoCov">          0 :                                         size = mono_class_value_size (mono_class_from_mono_type (pt), NULL);</span>
<span class="lineNum">    8054 </span><span class="lineNoCov">          0 :                                         mono_gc_bzero_atomic (*((gpointer *)params [i]), size);</span>
<span class="lineNum">    8055 </span>            :                                 }
<span class="lineNum">    8056 </span>            :                         }
<span class="lineNum">    8057 </span>            : 
<span class="lineNum">    8058 </span><span class="lineCov">         12 :                         j++;</span>
<span class="lineNum">    8059 </span><span class="lineCov">         12 :                 }</span>
<span class="lineNum">    8060 </span><span class="lineCov">         24 :         }</span>
<span class="lineNum">    8061 </span><span class="lineCov">       1267 : }</span>
<span class="lineNum">    8062 </span>            : 
<span class="lineNum">    8063 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">    8064 </span>            : 
<span class="lineNum">    8065 </span>            : /**
<span class="lineNum">    8066 </span>            :  * mono_load_remote_field:
<span class="lineNum">    8067 </span>            :  * @this: pointer to an object
<span class="lineNum">    8068 </span>            :  * @klass: klass of the object containing @field
<span class="lineNum">    8069 </span>            :  * @field: the field to load
<span class="lineNum">    8070 </span>            :  * @res: a storage to store the result
<span class="lineNum">    8071 </span>            :  *
<span class="lineNum">    8072 </span>            :  * This method is called by the runtime on attempts to load fields of
<span class="lineNum">    8073 </span>            :  * transparent proxy objects. @this points to such TP, @klass is the class of
<span class="lineNum">    8074 </span>            :  * the object containing @field. @res is a storage location which can be
<span class="lineNum">    8075 </span>            :  * used to store the result.
<span class="lineNum">    8076 </span>            :  *
<span class="lineNum">    8077 </span>            :  * Returns: an address pointing to the value of field.
<a name="8078"><span class="lineNum">    8078 </span>            :  */</a>
<span class="lineNum">    8079 </span>            : gpointer
<span class="lineNum">    8080 </span>            : mono_load_remote_field (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, gpointer *res)
<span class="lineNum">    8081 </span>            : {
<span class="lineNum">    8082 </span>            :         MonoError error;
<span class="lineNum">    8083 </span><span class="lineNoCov">          0 :         gpointer result = mono_load_remote_field_checked (this_obj, klass, field, res, &amp;error);</span>
<span class="lineNum">    8084 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    8085 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    8086 </span>            : }
<span class="lineNum">    8087 </span>            : 
<span class="lineNum">    8088 </span>            : /**
<span class="lineNum">    8089 </span>            :  * mono_load_remote_field_checked:
<span class="lineNum">    8090 </span>            :  * @this: pointer to an object
<span class="lineNum">    8091 </span>            :  * @klass: klass of the object containing @field
<span class="lineNum">    8092 </span>            :  * @field: the field to load
<span class="lineNum">    8093 </span>            :  * @res: a storage to store the result
<span class="lineNum">    8094 </span>            :  * @error: set on error
<span class="lineNum">    8095 </span>            :  *
<span class="lineNum">    8096 </span>            :  * This method is called by the runtime on attempts to load fields of
<span class="lineNum">    8097 </span>            :  * transparent proxy objects. @this points to such TP, @klass is the class of
<span class="lineNum">    8098 </span>            :  * the object containing @field. @res is a storage location which can be
<span class="lineNum">    8099 </span>            :  * used to store the result.
<span class="lineNum">    8100 </span>            :  *
<span class="lineNum">    8101 </span>            :  * Returns: an address pointing to the value of field.  On failure returns NULL and sets @error.
<a name="8102"><span class="lineNum">    8102 </span>            :  */</a>
<span class="lineNum">    8103 </span>            : gpointer
<span class="lineNum">    8104 </span>            : mono_load_remote_field_checked (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, gpointer *res, MonoError *error)
<span class="lineNum">    8105 </span>            : {
<span class="lineNum">    8106 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8107 </span>            : 
<span class="lineNum">    8108 </span>            :         static MonoMethod *getter = NULL;
<span class="lineNum">    8109 </span>            : 
<span class="lineNum">    8110 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    8111 </span>            : 
<span class="lineNum">    8112 </span><span class="lineNoCov">          0 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    8113 </span><span class="lineNoCov">          0 :         MonoTransparentProxy *tp = (MonoTransparentProxy *) this_obj;</span>
<span class="lineNum">    8114 </span>            :         MonoClass *field_class;
<span class="lineNum">    8115 </span>            :         MonoMethodMessage *msg;
<span class="lineNum">    8116 </span>            :         MonoArray *out_args;
<span class="lineNum">    8117 </span>            :         MonoObject *exc;
<span class="lineNum">    8118 </span>            :         char* full_name;
<span class="lineNum">    8119 </span>            : 
<span class="lineNum">    8120 </span><span class="lineNoCov">          0 :         g_assert (mono_object_is_transparent_proxy (this_obj));</span>
<span class="lineNum">    8121 </span><span class="lineNoCov">          0 :         g_assert (res != NULL);</span>
<span class="lineNum">    8122 </span>            : 
<span class="lineNum">    8123 </span><span class="lineNoCov">          0 :         if (mono_class_is_contextbound (tp-&gt;remote_class-&gt;proxy_class) &amp;&amp; tp-&gt;rp-&gt;context == (MonoObject *) mono_context_get ()) {</span>
<span class="lineNum">    8124 </span><span class="lineNoCov">          0 :                 mono_field_get_value (tp-&gt;rp-&gt;unwrapped_server, field, res);</span>
<span class="lineNum">    8125 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    8126 </span>            :         }
<span class="lineNum">    8127 </span>            :         
<span class="lineNum">    8128 </span><span class="lineNoCov">          0 :         if (!getter) {</span>
<span class="lineNum">    8129 </span><span class="lineNoCov">          0 :                 getter = mono_class_get_method_from_name (mono_defaults.object_class, &quot;FieldGetter&quot;, -1);</span>
<span class="lineNum">    8130 </span><span class="lineNoCov">          0 :                 if (!getter) {</span>
<span class="lineNum">    8131 </span><span class="lineNoCov">          0 :                         mono_error_set_not_supported (error, &quot;Linked away.&quot;);</span>
<span class="lineNum">    8132 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    8133 </span>            :                 }
<span class="lineNum">    8134 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    8135 </span>            :         
<span class="lineNum">    8136 </span><span class="lineNoCov">          0 :         field_class = mono_class_from_mono_type (field-&gt;type);</span>
<span class="lineNum">    8137 </span>            : 
<span class="lineNum">    8138 </span><span class="lineNoCov">          0 :         msg = (MonoMethodMessage *)mono_object_new_checked (domain, mono_defaults.mono_method_message_class, error);</span>
<span class="lineNum">    8139 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    8140 </span><span class="lineNoCov">          0 :         out_args = mono_array_new_checked (domain, mono_defaults.object_class, 1, error);</span>
<span class="lineNum">    8141 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    8142 </span><span class="lineNoCov">          0 :         MonoReflectionMethod *rm = mono_method_get_object_checked (domain, getter, NULL, error);</span>
<span class="lineNum">    8143 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    8144 </span><span class="lineNoCov">          0 :         mono_message_init (domain, msg, rm, out_args, error);</span>
<span class="lineNum">    8145 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    8146 </span>            : 
<span class="lineNum">    8147 </span><span class="lineNoCov">          0 :         full_name = mono_type_get_full_name (klass);</span>
<span class="lineNum">    8148 </span><span class="lineNoCov">          0 :         mono_array_setref (msg-&gt;args, 0, mono_string_new (domain, full_name));</span>
<span class="lineNum">    8149 </span><span class="lineNoCov">          0 :         mono_array_setref (msg-&gt;args, 1, mono_string_new (domain, mono_field_get_name (field)));</span>
<span class="lineNum">    8150 </span><span class="lineNoCov">          0 :         g_free (full_name);</span>
<span class="lineNum">    8151 </span>            : 
<span class="lineNum">    8152 </span><span class="lineNoCov">          0 :         mono_remoting_invoke ((MonoObject *)(tp-&gt;rp), msg, &amp;exc, &amp;out_args, error);</span>
<span class="lineNum">    8153 </span><span class="lineNoCov">          0 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    8154 </span>            : 
<span class="lineNum">    8155 </span><span class="lineNoCov">          0 :         if (exc) {</span>
<span class="lineNum">    8156 </span><span class="lineNoCov">          0 :                 mono_error_set_exception_instance (error, (MonoException *)exc);</span>
<span class="lineNum">    8157 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    8158 </span>            :         }
<span class="lineNum">    8159 </span>            : 
<span class="lineNum">    8160 </span><span class="lineNoCov">          0 :         if (mono_array_length (out_args) == 0)</span>
<span class="lineNum">    8161 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    8162 </span>            : 
<span class="lineNum">    8163 </span><span class="lineNoCov">          0 :         mono_gc_wbarrier_generic_store (res, mono_array_get (out_args, MonoObject *, 0));</span>
<span class="lineNum">    8164 </span>            : 
<span class="lineNum">    8165 </span><span class="lineNoCov">          0 :         if (field_class-&gt;valuetype) {</span>
<span class="lineNum">    8166 </span><span class="lineNoCov">          0 :                 return ((char *)*res) + sizeof (MonoObject);</span>
<span class="lineNum">    8167 </span>            :         } else
<span class="lineNum">    8168 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    8169 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8170 </span>            : 
<span class="lineNum">    8171 </span>            : /**
<span class="lineNum">    8172 </span>            :  * mono_load_remote_field_new:
<span class="lineNum">    8173 </span>            :  * @this: 
<span class="lineNum">    8174 </span>            :  * @klass: 
<span class="lineNum">    8175 </span>            :  * @field:
<span class="lineNum">    8176 </span>            :  *
<span class="lineNum">    8177 </span>            :  * Missing documentation.
<a name="8178"><span class="lineNum">    8178 </span>            :  */</a>
<span class="lineNum">    8179 </span>            : MonoObject *
<span class="lineNum">    8180 </span>            : mono_load_remote_field_new (MonoObject *this_obj, MonoClass *klass, MonoClassField *field)
<span class="lineNum">    8181 </span>            : {
<span class="lineNum">    8182 </span>            :         MonoError error;
<span class="lineNum">    8183 </span>            : 
<span class="lineNum">    8184 </span><span class="lineNoCov">          0 :         MonoObject *result = mono_load_remote_field_new_checked (this_obj, klass, field, &amp;error);</span>
<span class="lineNum">    8185 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    8186 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    8187 </span>            : }
<span class="lineNum">    8188 </span>            : 
<span class="lineNum">    8189 </span>            : /**
<span class="lineNum">    8190 </span>            :  * mono_load_remote_field_new_checked:
<span class="lineNum">    8191 </span>            :  * @this: pointer to an object
<span class="lineNum">    8192 </span>            :  * @klass: klass of the object containing @field
<span class="lineNum">    8193 </span>            :  * @field: the field to load
<span class="lineNum">    8194 </span>            :  * @error: set on error.
<span class="lineNum">    8195 </span>            :  *
<span class="lineNum">    8196 </span>            :  * This method is called by the runtime on attempts to load fields of
<span class="lineNum">    8197 </span>            :  * transparent proxy objects. @this points to such TP, @klass is the class of
<span class="lineNum">    8198 </span>            :  * the object containing @field.
<span class="lineNum">    8199 </span>            :  * 
<span class="lineNum">    8200 </span>            :  * Returns: a freshly allocated object containing the value of the field.  On failure returns NULL and sets @error.
<a name="8201"><span class="lineNum">    8201 </span>            :  */</a>
<span class="lineNum">    8202 </span>            : MonoObject *
<span class="lineNum">    8203 </span>            : mono_load_remote_field_new_checked (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, MonoError *error)
<span class="lineNum">    8204 </span>            : {
<span class="lineNum">    8205 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8206 </span>            : 
<span class="lineNum">    8207 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    8208 </span>            : 
<span class="lineNum">    8209 </span>            :         static MonoMethod *tp_load = NULL;
<span class="lineNum">    8210 </span>            : 
<span class="lineNum">    8211 </span><span class="lineNoCov">          0 :         g_assert (mono_object_is_transparent_proxy (this_obj));</span>
<span class="lineNum">    8212 </span>            : 
<span class="lineNum">    8213 </span><span class="lineNoCov">          0 :         if (!tp_load) {</span>
<span class="lineNum">    8214 </span><span class="lineNoCov">          0 :                 tp_load = mono_class_get_method_from_name (mono_defaults.transparent_proxy_class, &quot;LoadRemoteFieldNew&quot;, -1);</span>
<span class="lineNum">    8215 </span><span class="lineNoCov">          0 :                 if (!tp_load) {</span>
<span class="lineNum">    8216 </span><span class="lineNoCov">          0 :                         mono_error_set_not_supported (error, &quot;Linked away.&quot;);</span>
<span class="lineNum">    8217 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    8218 </span>            :                 }
<span class="lineNum">    8219 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    8220 </span>            :         
<span class="lineNum">    8221 </span>            :         /* MonoType *type = mono_class_get_type (klass); */
<span class="lineNum">    8222 </span>            : 
<span class="lineNum">    8223 </span>            :         gpointer args[2];
<span class="lineNum">    8224 </span><span class="lineNoCov">          0 :         args [0] = &amp;klass;</span>
<span class="lineNum">    8225 </span><span class="lineNoCov">          0 :         args [1] = &amp;field;</span>
<span class="lineNum">    8226 </span>            : 
<span class="lineNum">    8227 </span><span class="lineNoCov">          0 :         return mono_runtime_invoke_checked (tp_load, this_obj, args, error);</span>
<span class="lineNum">    8228 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8229 </span>            : 
<span class="lineNum">    8230 </span>            : /**
<span class="lineNum">    8231 </span>            :  * mono_store_remote_field:
<span class="lineNum">    8232 </span>            :  * @this_obj: pointer to an object
<span class="lineNum">    8233 </span>            :  * @klass: klass of the object containing @field
<span class="lineNum">    8234 </span>            :  * @field: the field to load
<span class="lineNum">    8235 </span>            :  * @val: the value/object to store
<span class="lineNum">    8236 </span>            :  *
<span class="lineNum">    8237 </span>            :  * This method is called by the runtime on attempts to store fields of
<span class="lineNum">    8238 </span>            :  * transparent proxy objects. @this_obj points to such TP, @klass is the class of
<span class="lineNum">    8239 </span>            :  * the object containing @field. @val is the new value to store in @field.
<a name="8240"><span class="lineNum">    8240 </span>            :  */</a>
<span class="lineNum">    8241 </span>            : void
<span class="lineNum">    8242 </span>            : mono_store_remote_field (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, gpointer val)
<span class="lineNum">    8243 </span>            : {
<span class="lineNum">    8244 </span>            :         MonoError error;
<span class="lineNum">    8245 </span><span class="lineNoCov">          0 :         (void) mono_store_remote_field_checked (this_obj, klass, field, val, &amp;error);</span>
<span class="lineNum">    8246 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    8247 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8248 </span>            : 
<span class="lineNum">    8249 </span>            : /**
<span class="lineNum">    8250 </span>            :  * mono_store_remote_field_checked:
<span class="lineNum">    8251 </span>            :  * @this_obj: pointer to an object
<span class="lineNum">    8252 </span>            :  * @klass: klass of the object containing @field
<span class="lineNum">    8253 </span>            :  * @field: the field to load
<span class="lineNum">    8254 </span>            :  * @val: the value/object to store
<span class="lineNum">    8255 </span>            :  * @error: set on error
<span class="lineNum">    8256 </span>            :  *
<span class="lineNum">    8257 </span>            :  * This method is called by the runtime on attempts to store fields of
<span class="lineNum">    8258 </span>            :  * transparent proxy objects. @this_obj points to such TP, @klass is the class of
<span class="lineNum">    8259 </span>            :  * the object containing @field. @val is the new value to store in @field.
<span class="lineNum">    8260 </span>            :  *
<span class="lineNum">    8261 </span>            :  * Returns: on success returns TRUE, on failure returns FALSE and sets @error.
<a name="8262"><span class="lineNum">    8262 </span>            :  */</a>
<span class="lineNum">    8263 </span>            : gboolean
<span class="lineNum">    8264 </span>            : mono_store_remote_field_checked (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, gpointer val, MonoError *error)
<span class="lineNum">    8265 </span>            : {
<span class="lineNum">    8266 </span>            :         
<span class="lineNum">    8267 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8268 </span>            : 
<span class="lineNum">    8269 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    8270 </span>            : 
<span class="lineNum">    8271 </span><span class="lineNoCov">          0 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    8272 </span>            :         MonoClass *field_class;
<span class="lineNum">    8273 </span>            :         MonoObject *arg;
<span class="lineNum">    8274 </span>            : 
<span class="lineNum">    8275 </span><span class="lineNoCov">          0 :         g_assert (mono_object_is_transparent_proxy (this_obj));</span>
<span class="lineNum">    8276 </span>            : 
<span class="lineNum">    8277 </span><span class="lineNoCov">          0 :         field_class = mono_class_from_mono_type (field-&gt;type);</span>
<span class="lineNum">    8278 </span>            : 
<span class="lineNum">    8279 </span><span class="lineNoCov">          0 :         if (field_class-&gt;valuetype) {</span>
<span class="lineNum">    8280 </span><span class="lineNoCov">          0 :                 arg = mono_value_box_checked (domain, field_class, val, error);</span>
<span class="lineNum">    8281 </span><span class="lineNoCov">          0 :                 return_val_if_nok (error, FALSE);</span>
<span class="lineNum">    8282 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    8283 </span><span class="lineNoCov">          0 :                 arg = *((MonoObject**)val);</span>
<span class="lineNum">    8284 </span>            :         }
<span class="lineNum">    8285 </span>            : 
<span class="lineNum">    8286 </span><span class="lineNoCov">          0 :         return mono_store_remote_field_new_checked (this_obj, klass, field, arg, error);</span>
<span class="lineNum">    8287 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8288 </span>            : 
<span class="lineNum">    8289 </span>            : /**
<span class="lineNum">    8290 </span>            :  * mono_store_remote_field_new:
<span class="lineNum">    8291 </span>            :  * @this_obj:
<span class="lineNum">    8292 </span>            :  * @klass:
<span class="lineNum">    8293 </span>            :  * @field:
<span class="lineNum">    8294 </span>            :  * @arg:
<span class="lineNum">    8295 </span>            :  *
<span class="lineNum">    8296 </span>            :  * Missing documentation
<a name="8297"><span class="lineNum">    8297 </span>            :  */</a>
<span class="lineNum">    8298 </span>            : void
<span class="lineNum">    8299 </span>            : mono_store_remote_field_new (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, MonoObject *arg)
<span class="lineNum">    8300 </span>            : {
<span class="lineNum">    8301 </span>            :         MonoError error;
<span class="lineNum">    8302 </span><span class="lineNoCov">          0 :         (void) mono_store_remote_field_new_checked (this_obj, klass, field, arg, &amp;error);</span>
<span class="lineNum">    8303 </span><span class="lineNoCov">          0 :         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    8304 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8305 </span>            : 
<span class="lineNum">    8306 </span>            : /**
<span class="lineNum">    8307 </span>            :  * mono_store_remote_field_new_checked:
<span class="lineNum">    8308 </span>            :  * @this_obj:
<span class="lineNum">    8309 </span>            :  * @klass:
<span class="lineNum">    8310 </span>            :  * @field:
<span class="lineNum">    8311 </span>            :  * @arg:
<span class="lineNum">    8312 </span>            :  * @error:
<span class="lineNum">    8313 </span>            :  *
<span class="lineNum">    8314 </span>            :  * Missing documentation
<a name="8315"><span class="lineNum">    8315 </span>            :  */</a>
<span class="lineNum">    8316 </span>            : gboolean
<span class="lineNum">    8317 </span>            : mono_store_remote_field_new_checked (MonoObject *this_obj, MonoClass *klass, MonoClassField *field, MonoObject *arg, MonoError *error)
<span class="lineNum">    8318 </span>            : {
<span class="lineNum">    8319 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8320 </span>            : 
<span class="lineNum">    8321 </span>            :         static MonoMethod *tp_store = NULL;
<span class="lineNum">    8322 </span>            : 
<span class="lineNum">    8323 </span><span class="lineNoCov">          0 :         mono_error_init (error);</span>
<span class="lineNum">    8324 </span>            : 
<span class="lineNum">    8325 </span><span class="lineNoCov">          0 :         g_assert (mono_object_is_transparent_proxy (this_obj));</span>
<span class="lineNum">    8326 </span>            : 
<span class="lineNum">    8327 </span><span class="lineNoCov">          0 :         if (!tp_store) {</span>
<span class="lineNum">    8328 </span><span class="lineNoCov">          0 :                 tp_store = mono_class_get_method_from_name (mono_defaults.transparent_proxy_class, &quot;StoreRemoteField&quot;, -1);</span>
<span class="lineNum">    8329 </span><span class="lineNoCov">          0 :                 if (!tp_store) {</span>
<span class="lineNum">    8330 </span><span class="lineNoCov">          0 :                         mono_error_set_not_supported (error, &quot;Linked away.&quot;);</span>
<span class="lineNum">    8331 </span><span class="lineNoCov">          0 :                         return FALSE;</span>
<span class="lineNum">    8332 </span>            :                 }
<span class="lineNum">    8333 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    8334 </span>            : 
<span class="lineNum">    8335 </span>            :         gpointer args[3];
<span class="lineNum">    8336 </span><span class="lineNoCov">          0 :         args [0] = &amp;klass;</span>
<span class="lineNum">    8337 </span><span class="lineNoCov">          0 :         args [1] = &amp;field;</span>
<span class="lineNum">    8338 </span><span class="lineNoCov">          0 :         args [2] = arg;</span>
<span class="lineNum">    8339 </span>            : 
<span class="lineNum">    8340 </span><span class="lineNoCov">          0 :         mono_runtime_invoke_checked (tp_store, this_obj, args, error);</span>
<span class="lineNum">    8341 </span><span class="lineNoCov">          0 :         return is_ok (error);</span>
<span class="lineNum">    8342 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8343 </span>            : #endif
<span class="lineNum">    8344 </span>            : 
<span class="lineNum">    8345 </span>            : /*
<span class="lineNum">    8346 </span>            :  * mono_create_ftnptr:
<span class="lineNum">    8347 </span>            :  *
<span class="lineNum">    8348 </span>            :  *   Given a function address, create a function descriptor for it.
<span class="lineNum">    8349 </span>            :  * This is only needed on some platforms.
<a name="8350"><span class="lineNum">    8350 </span>            :  */</a>
<span class="lineNum">    8351 </span>            : gpointer
<span class="lineNum">    8352 </span>            : mono_create_ftnptr (MonoDomain *domain, gpointer addr)
<span class="lineNum">    8353 </span>            : {
<span class="lineNum">    8354 </span><span class="lineCov">   34873282 :         return callbacks.create_ftnptr (domain, addr);</span>
<span class="lineNum">    8355 </span>            : }
<span class="lineNum">    8356 </span>            : 
<span class="lineNum">    8357 </span>            : /*
<span class="lineNum">    8358 </span>            :  * mono_get_addr_from_ftnptr:
<span class="lineNum">    8359 </span>            :  *
<span class="lineNum">    8360 </span>            :  *   Given a pointer to a function descriptor, return the function address.
<span class="lineNum">    8361 </span>            :  * This is only needed on some platforms.
<a name="8362"><span class="lineNum">    8362 </span>            :  */</a>
<span class="lineNum">    8363 </span>            : gpointer
<span class="lineNum">    8364 </span>            : mono_get_addr_from_ftnptr (gpointer descr)
<span class="lineNum">    8365 </span>            : {
<span class="lineNum">    8366 </span><span class="lineCov">   63261577 :         return callbacks.get_addr_from_ftnptr (descr);</span>
<span class="lineNum">    8367 </span>            : }       
<span class="lineNum">    8368 </span>            : 
<span class="lineNum">    8369 </span>            : /**
<span class="lineNum">    8370 </span>            :  * mono_string_chars:
<span class="lineNum">    8371 </span>            :  * @s: a MonoString
<span class="lineNum">    8372 </span>            :  *
<span class="lineNum">    8373 </span>            :  * Returns a pointer to the UCS16 characters stored in the MonoString
<a name="8374"><span class="lineNum">    8374 </span>            :  */</a>
<span class="lineNum">    8375 </span>            : gunichar2 *
<span class="lineNum">    8376 </span>            : mono_string_chars (MonoString *s)
<span class="lineNum">    8377 </span>            : {
<span class="lineNum">    8378 </span>            :         // MONO_REQ_GC_UNSAFE_MODE; //FIXME too much trouble for now
<span class="lineNum">    8379 </span>            : 
<span class="lineNum">    8380 </span><span class="lineCov">   26489851 :         return s-&gt;chars;</span>
<span class="lineNum">    8381 </span>            : }
<span class="lineNum">    8382 </span>            : 
<span class="lineNum">    8383 </span>            : /**
<span class="lineNum">    8384 </span>            :  * mono_string_length:
<span class="lineNum">    8385 </span>            :  * @s: MonoString
<span class="lineNum">    8386 </span>            :  *
<span class="lineNum">    8387 </span>            :  * Returns the lenght in characters of the string
<a name="8388"><span class="lineNum">    8388 </span>            :  */</a>
<span class="lineNum">    8389 </span>            : int
<span class="lineNum">    8390 </span>            : mono_string_length (MonoString *s)
<span class="lineNum">    8391 </span>            : {
<span class="lineNum">    8392 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8393 </span>            : 
<span class="lineNum">    8394 </span><span class="lineCov">   46548537 :         return s-&gt;length;</span>
<span class="lineNum">    8395 </span>            : }
<span class="lineNum">    8396 </span>            : 
<span class="lineNum">    8397 </span>            : /**
<span class="lineNum">    8398 </span>            :  * mono_array_length:
<span class="lineNum">    8399 </span>            :  * @array: a MonoArray*
<span class="lineNum">    8400 </span>            :  *
<span class="lineNum">    8401 </span>            :  * Returns the total number of elements in the array. This works for
<span class="lineNum">    8402 </span>            :  * both vectors and multidimensional arrays.
<a name="8403"><span class="lineNum">    8403 </span>            :  */</a>
<span class="lineNum">    8404 </span>            : uintptr_t
<span class="lineNum">    8405 </span>            : mono_array_length (MonoArray *array)
<span class="lineNum">    8406 </span>            : {
<span class="lineNum">    8407 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8408 </span>            : 
<span class="lineNum">    8409 </span><span class="lineCov">    7541705 :         return array-&gt;max_length;</span>
<span class="lineNum">    8410 </span>            : }
<span class="lineNum">    8411 </span>            : 
<span class="lineNum">    8412 </span>            : /**
<span class="lineNum">    8413 </span>            :  * mono_array_addr_with_size:
<span class="lineNum">    8414 </span>            :  * @array: a MonoArray*
<span class="lineNum">    8415 </span>            :  * @size: size of the array elements
<span class="lineNum">    8416 </span>            :  * @idx: index into the array
<span class="lineNum">    8417 </span>            :  *
<span class="lineNum">    8418 </span>            :  * Use this function to obtain the address for the @idx item on the
<span class="lineNum">    8419 </span>            :  * @array containing elements of size @size.
<span class="lineNum">    8420 </span>            :  *
<span class="lineNum">    8421 </span>            :  * This method performs no bounds checking or type checking.
<span class="lineNum">    8422 </span>            :  *
<span class="lineNum">    8423 </span>            :  * Returns the address of the @idx element in the array.
<a name="8424"><span class="lineNum">    8424 </span>            :  */</a>
<span class="lineNum">    8425 </span>            : char*
<span class="lineNum">    8426 </span>            : mono_array_addr_with_size (MonoArray *array, int size, uintptr_t idx)
<span class="lineNum">    8427 </span>            : {
<span class="lineNum">    8428 </span>            :         MONO_REQ_GC_UNSAFE_MODE;
<span class="lineNum">    8429 </span>            : 
<span class="lineNum">    8430 </span><span class="lineCov">    3932854 :         return ((char*)(array)-&gt;vector) + size * idx;</span>
<span class="lineNum">    8431 </span>            : }
<span class="lineNum">    8432 </span>            : 
<a name="8433"><span class="lineNum">    8433 </span>            : </a>
<span class="lineNum">    8434 </span>            : MonoArray *
<span class="lineNum">    8435 </span>            : mono_glist_to_array (GList *list, MonoClass *eclass, MonoError *error) 
<span class="lineNum">    8436 </span>            : {
<span class="lineNum">    8437 </span><span class="lineCov">     377860 :         MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    8438 </span>            :         MonoArray *res;
<span class="lineNum">    8439 </span>            :         int len, i;
<span class="lineNum">    8440 </span>            : 
<span class="lineNum">    8441 </span><span class="lineCov">     377860 :         mono_error_init (error);</span>
<span class="lineNum">    8442 </span><span class="lineCov">     377860 :         if (!list)</span>
<span class="lineNum">    8443 </span><span class="lineCov">        100 :                 return NULL;</span>
<span class="lineNum">    8444 </span>            : 
<span class="lineNum">    8445 </span><span class="lineCov">     377759 :         len = g_list_length (list);</span>
<span class="lineNum">    8446 </span><span class="lineCov">     377759 :         res = mono_array_new_checked (domain, eclass, len, error);</span>
<span class="lineNum">    8447 </span><span class="lineCov">    1133279 :         return_val_if_nok (error, NULL);</span>
<span class="lineNum">    8448 </span>            : 
<span class="lineNum">    8449 </span><span class="lineCov">    4836440 :         for (i = 0; list; list = list-&gt;next, i++)</span>
<span class="lineNum">    8450 </span><span class="lineCov">    6121380 :                 mono_array_set (res, gpointer, i, list-&gt;data);</span>
<span class="lineNum">    8451 </span>            : 
<span class="lineNum">    8452 </span><span class="lineCov">     377760 :         return res;</span>
<span class="lineNum">    8453 </span><span class="lineCov">     377860 : }</span>
<span class="lineNum">    8454 </span>            : 
<span class="lineNum">    8455 </span>            : #if NEVER_DEFINED
<span class="lineNum">    8456 </span>            : /*
<span class="lineNum">    8457 </span>            :  * The following section is purely to declare prototypes and
<span class="lineNum">    8458 </span>            :  * document the API, as these C files are processed by our
<span class="lineNum">    8459 </span>            :  * tool
<span class="lineNum">    8460 </span>            :  */
<span class="lineNum">    8461 </span>            : 
<span class="lineNum">    8462 </span>            : /**
<span class="lineNum">    8463 </span>            :  * mono_array_set:
<span class="lineNum">    8464 </span>            :  * @array: array to alter
<span class="lineNum">    8465 </span>            :  * @element_type: A C type name, this macro will use the sizeof(type) to determine the element size
<span class="lineNum">    8466 </span>            :  * @index: index into the array
<span class="lineNum">    8467 </span>            :  * @value: value to set
<span class="lineNum">    8468 </span>            :  *
<span class="lineNum">    8469 </span>            :  * Value Type version: This sets the @index's element of the @array
<span class="lineNum">    8470 </span>            :  * with elements of size sizeof(type) to the provided @value.
<span class="lineNum">    8471 </span>            :  *
<span class="lineNum">    8472 </span>            :  * This macro does not attempt to perform type checking or bounds checking.
<span class="lineNum">    8473 </span>            :  *
<span class="lineNum">    8474 </span>            :  * Use this to set value types in a `MonoArray`.
<span class="lineNum">    8475 </span>            :  */
<span class="lineNum">    8476 </span>            : void mono_array_set(MonoArray *array, Type element_type, uintptr_t index, Value value)
<span class="lineNum">    8477 </span>            : {
<span class="lineNum">    8478 </span>            : }
<span class="lineNum">    8479 </span>            : 
<span class="lineNum">    8480 </span>            : /**
<span class="lineNum">    8481 </span>            :  * mono_array_setref:
<span class="lineNum">    8482 </span>            :  * @array: array to alter
<span class="lineNum">    8483 </span>            :  * @index: index into the array
<span class="lineNum">    8484 </span>            :  * @value: value to set
<span class="lineNum">    8485 </span>            :  *
<span class="lineNum">    8486 </span>            :  * Reference Type version: This sets the @index's element of the
<span class="lineNum">    8487 </span>            :  * @array with elements of size sizeof(type) to the provided @value.
<span class="lineNum">    8488 </span>            :  *
<span class="lineNum">    8489 </span>            :  * This macro does not attempt to perform type checking or bounds checking.
<span class="lineNum">    8490 </span>            :  *
<span class="lineNum">    8491 </span>            :  * Use this to reference types in a `MonoArray`.
<span class="lineNum">    8492 </span>            :  */
<span class="lineNum">    8493 </span>            : void mono_array_setref(MonoArray *array, uintptr_t index, MonoObject *object)
<span class="lineNum">    8494 </span>            : {
<span class="lineNum">    8495 </span>            : }
<span class="lineNum">    8496 </span>            : 
<span class="lineNum">    8497 </span>            : /**
<span class="lineNum">    8498 </span>            :  * mono_array_get:
<span class="lineNum">    8499 </span>            :  * @array: array on which to operate on
<span class="lineNum">    8500 </span>            :  * @element_type: C element type (example: MonoString *, int, MonoObject *)
<span class="lineNum">    8501 </span>            :  * @index: index into the array
<span class="lineNum">    8502 </span>            :  *
<span class="lineNum">    8503 </span>            :  * Use this macro to retrieve the @index element of an @array and
<span class="lineNum">    8504 </span>            :  * extract the value assuming that the elements of the array match
<span class="lineNum">    8505 </span>            :  * the provided type value.
<span class="lineNum">    8506 </span>            :  *
<span class="lineNum">    8507 </span>            :  * This method can be used with both arrays holding value types and
<span class="lineNum">    8508 </span>            :  * reference types.   For reference types, the @type parameter should
<span class="lineNum">    8509 </span>            :  * be a `MonoObject*` or any subclass of it, like `MonoString*`.
<span class="lineNum">    8510 </span>            :  *
<span class="lineNum">    8511 </span>            :  * This macro does not attempt to perform type checking or bounds checking.
<span class="lineNum">    8512 </span>            :  *
<span class="lineNum">    8513 </span>            :  * Returns: The element at the @index position in the @array.
<span class="lineNum">    8514 </span>            :  */
<span class="lineNum">    8515 </span>            : Type mono_array_get (MonoArray *array, Type element_type, uintptr_t index)
<span class="lineNum">    8516 </span>            : {
<span class="lineNum">    8517 </span>            : }
<span class="lineNum">    8518 </span>            : #endif
<span class="lineNum">    8519 </span>            :  
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
