<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - metadata/assembly.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">metadata</a> - assembly.c<span style="font-size: 80%;"> (source / <a href="assembly.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1133</td>
            <td class="headerCovTableEntry">1635</td>
            <td class="headerCovTableEntryLo">69.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">91</td>
            <td class="headerCovTableEntry">110</td>
            <td class="headerCovTableEntryMed">82.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * assembly.c: Routines for loading assemblies.
<span class="lineNum">       3 </span>            :  * 
<span class="lineNum">       4 </span>            :  * Author:
<span class="lineNum">       5 </span>            :  *   Miguel de Icaza (miguel@ximian.com)
<span class="lineNum">       6 </span>            :  *
<span class="lineNum">       7 </span>            :  * Copyright 2001-2003 Ximian, Inc (http://www.ximian.com)
<span class="lineNum">       8 </span>            :  * Copyright 2004-2009 Novell, Inc (http://www.novell.com)
<span class="lineNum">       9 </span>            :  * Copyright 2011 Xamarin, Inc (http://www.xamarin.com)
<span class="lineNum">      10 </span>            :  * Licensed under the MIT license. See LICENSE file in the project root for full license information.
<span class="lineNum">      11 </span>            :  */
<span class="lineNum">      12 </span>            : #include &lt;config.h&gt;
<span class="lineNum">      13 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">      14 </span>            : #include &lt;glib.h&gt;
<span class="lineNum">      15 </span>            : #include &lt;errno.h&gt;
<span class="lineNum">      16 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      17 </span>            : #include &lt;stdlib.h&gt;
<span class="lineNum">      18 </span>            : #include &quot;assembly.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;assembly-internals.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;image.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;image-internals.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;object-internals.h&quot;
<span class="lineNum">      23 </span>            : #include &lt;mono/metadata/loader.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;mono/metadata/tabledefs.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;mono/metadata/custom-attrs-internals.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;mono/metadata/metadata-internals.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;mono/metadata/profiler-private.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;mono/metadata/class-internals.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;mono/metadata/domain-internals.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;mono/metadata/reflection-internals.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;mono/metadata/mono-endian.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;mono/metadata/mono-debug.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;mono/io-layer/io-layer.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;mono/utils/mono-uri.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;mono/metadata/mono-config.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;mono/metadata/mono-config-dirs.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;mono/utils/mono-digest.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;mono/utils/mono-logger-internals.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;mono/utils/mono-path.h&gt;
<span class="lineNum">      40 </span>            : #include &lt;mono/metadata/reflection.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;mono/metadata/coree.h&gt;
<span class="lineNum">      42 </span>            : #include &lt;mono/metadata/cil-coff.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;mono/utils/mono-io-portability.h&gt;
<span class="lineNum">      44 </span>            : #include &lt;mono/utils/atomic.h&gt;
<span class="lineNum">      45 </span>            : #include &lt;mono/utils/mono-os-mutex.h&gt;
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : #ifndef HOST_WIN32
<span class="lineNum">      48 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      49 </span>            : #include &lt;unistd.h&gt;
<span class="lineNum">      50 </span>            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      51 </span>            : #endif
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #ifdef PLATFORM_MACOSX
<span class="lineNum">      54 </span>            : #include &lt;mach-o/dyld.h&gt;
<span class="lineNum">      55 </span>            : #endif
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : /* AssemblyVersionMap: an assembly name, the assembly version set on which it is based, the assembly name it is replaced with and whether only versions lower than the current runtime version should be remapped */
<span class="lineNum">      58 </span>            : typedef struct  {
<span class="lineNum">      59 </span>            :         const char* assembly_name;
<span class="lineNum">      60 </span>            :         guint8 version_set_index;
<span class="lineNum">      61 </span>            :         const char* new_assembly_name;
<span class="lineNum">      62 </span>            :         gboolean only_lower_versions;
<span class="lineNum">      63 </span>            : } AssemblyVersionMap;
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            : /* the default search path is empty, the first slot is replaced with the computed value */
<span class="lineNum">      66 </span>            : static const char*
<span class="lineNum">      67 </span>            : default_path [] = {
<span class="lineNum">      68 </span>            :         NULL,
<span class="lineNum">      69 </span>            :         NULL,
<span class="lineNum">      70 </span>            :         NULL
<span class="lineNum">      71 </span>            : };
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            : /* Contains the list of directories to be searched for assemblies (MONO_PATH) */
<span class="lineNum">      74 </span>            : static char **assemblies_path = NULL;
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span>            : /* Contains the list of directories that point to auxiliary GACs */
<span class="lineNum">      77 </span>            : static char **extra_gac_paths = NULL;
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            : #ifndef DISABLE_ASSEMBLY_REMAPPING
<span class="lineNum">      80 </span>            : /* The list of system assemblies what will be remapped to the running
<span class="lineNum">      81 </span>            :  * runtime version. WARNING: this list must be sorted.
<span class="lineNum">      82 </span>            :  * The integer number is an index in the MonoRuntimeInfo structure, whose
<span class="lineNum">      83 </span>            :  * values can be found in domain.c - supported_runtimes. Look there
<span class="lineNum">      84 </span>            :  * to understand what remapping will be made.
<span class="lineNum">      85 </span>            :  *
<span class="lineNum">      86 </span>            :  * .NET version can be found at https://github.com/dotnet/coreclr/blob/master/src/inc/fxretarget.h#L99
<span class="lineNum">      87 </span>            :  *
<span class="lineNum">      88 </span>            :  */
<span class="lineNum">      89 </span>            : static const AssemblyVersionMap framework_assemblies [] = {
<span class="lineNum">      90 </span>            :         {&quot;Accessibility&quot;, 0},
<span class="lineNum">      91 </span>            :         {&quot;Commons.Xml.Relaxng&quot;, 0},
<span class="lineNum">      92 </span>            :         {&quot;I18N&quot;, 0},
<span class="lineNum">      93 </span>            :         {&quot;I18N.CJK&quot;, 0},
<span class="lineNum">      94 </span>            :         {&quot;I18N.MidEast&quot;, 0},
<span class="lineNum">      95 </span>            :         {&quot;I18N.Other&quot;, 0},
<span class="lineNum">      96 </span>            :         {&quot;I18N.Rare&quot;, 0},
<span class="lineNum">      97 </span>            :         {&quot;I18N.West&quot;, 0},
<span class="lineNum">      98 </span>            :         {&quot;Microsoft.Build.Engine&quot;, 2, NULL, TRUE},
<span class="lineNum">      99 </span>            :         {&quot;Microsoft.Build.Framework&quot;, 2, NULL, TRUE},
<span class="lineNum">     100 </span>            :         {&quot;Microsoft.Build.Tasks&quot;, 2, &quot;Microsoft.Build.Tasks.v4.0&quot;},
<span class="lineNum">     101 </span>            :         {&quot;Microsoft.Build.Tasks.v3.5&quot;, 2, &quot;Microsoft.Build.Tasks.v4.0&quot;},
<span class="lineNum">     102 </span>            :         {&quot;Microsoft.Build.Utilities&quot;, 2, &quot;Microsoft.Build.Utilities.v4.0&quot;},
<span class="lineNum">     103 </span>            :         {&quot;Microsoft.Build.Utilities.v3.5&quot;, 2, &quot;Microsoft.Build.Utilities.v4.0&quot;},
<span class="lineNum">     104 </span>            :         {&quot;Microsoft.VisualBasic&quot;, 1},
<span class="lineNum">     105 </span>            :         {&quot;Microsoft.VisualC&quot;, 1},
<span class="lineNum">     106 </span>            :         {&quot;Mono.Cairo&quot;, 0},
<span class="lineNum">     107 </span>            :         {&quot;Mono.CompilerServices.SymbolWriter&quot;, 0},
<span class="lineNum">     108 </span>            :         {&quot;Mono.Data&quot;, 0},
<span class="lineNum">     109 </span>            :         {&quot;Mono.Data.SybaseClient&quot;, 0},
<span class="lineNum">     110 </span>            :         {&quot;Mono.Data.Tds&quot;, 0},
<span class="lineNum">     111 </span>            :         {&quot;Mono.Data.TdsClient&quot;, 0},
<span class="lineNum">     112 </span>            :         {&quot;Mono.GetOptions&quot;, 0},
<span class="lineNum">     113 </span>            :         {&quot;Mono.Http&quot;, 0},
<span class="lineNum">     114 </span>            :         {&quot;Mono.Posix&quot;, 0},
<span class="lineNum">     115 </span>            :         {&quot;Mono.Security&quot;, 0},
<span class="lineNum">     116 </span>            :         {&quot;Mono.Security.Win32&quot;, 0},
<span class="lineNum">     117 </span>            :         {&quot;Mono.Xml.Ext&quot;, 0},
<span class="lineNum">     118 </span>            :         {&quot;Novell.Directory.Ldap&quot;, 0},
<span class="lineNum">     119 </span>            :         {&quot;PEAPI&quot;, 0},
<span class="lineNum">     120 </span>            :         {&quot;System&quot;, 0},
<span class="lineNum">     121 </span>            :         {&quot;System.ComponentModel.Composition&quot;, 2},
<span class="lineNum">     122 </span>            :         {&quot;System.ComponentModel.DataAnnotations&quot;, 2},
<span class="lineNum">     123 </span>            :         {&quot;System.Configuration&quot;, 0},
<span class="lineNum">     124 </span>            :         {&quot;System.Configuration.Install&quot;, 0},
<span class="lineNum">     125 </span>            :         {&quot;System.Core&quot;, 2},
<span class="lineNum">     126 </span>            :         {&quot;System.Data&quot;, 0},
<span class="lineNum">     127 </span>            :         {&quot;System.Data.Linq&quot;, 2},
<span class="lineNum">     128 </span>            :         {&quot;System.Data.OracleClient&quot;, 0},
<span class="lineNum">     129 </span>            :         {&quot;System.Data.Services&quot;, 2},
<span class="lineNum">     130 </span>            :         {&quot;System.Data.Services.Client&quot;, 2},
<span class="lineNum">     131 </span>            :         {&quot;System.Data.SqlXml&quot;, 0},
<span class="lineNum">     132 </span>            :         {&quot;System.Design&quot;, 0},
<span class="lineNum">     133 </span>            :         {&quot;System.DirectoryServices&quot;, 0},
<span class="lineNum">     134 </span>            :         {&quot;System.Drawing&quot;, 0},
<span class="lineNum">     135 </span>            :         {&quot;System.Drawing.Design&quot;, 0},
<span class="lineNum">     136 </span>            :         {&quot;System.EnterpriseServices&quot;, 0},
<span class="lineNum">     137 </span>            :         {&quot;System.IdentityModel&quot;, 3},
<span class="lineNum">     138 </span>            :         {&quot;System.IdentityModel.Selectors&quot;, 3},
<span class="lineNum">     139 </span>            :         {&quot;System.Management&quot;, 0},
<span class="lineNum">     140 </span>            :         {&quot;System.Messaging&quot;, 0},
<span class="lineNum">     141 </span>            :         {&quot;System.Net&quot;, 2},
<span class="lineNum">     142 </span>            :         {&quot;System.Runtime.Remoting&quot;, 0},
<span class="lineNum">     143 </span>            :         {&quot;System.Runtime.Serialization&quot;, 3},
<span class="lineNum">     144 </span>            :         {&quot;System.Runtime.Serialization.Formatters.Soap&quot;, 0},
<span class="lineNum">     145 </span>            :         {&quot;System.Security&quot;, 0},
<span class="lineNum">     146 </span>            :         {&quot;System.ServiceModel&quot;, 3},
<span class="lineNum">     147 </span>            :         {&quot;System.ServiceModel.Web&quot;, 2},
<span class="lineNum">     148 </span>            :         {&quot;System.ServiceProcess&quot;, 0},
<span class="lineNum">     149 </span>            :         {&quot;System.Transactions&quot;, 0},
<span class="lineNum">     150 </span>            :         {&quot;System.Web&quot;, 0},
<span class="lineNum">     151 </span>            :         {&quot;System.Web.Abstractions&quot;, 2},
<span class="lineNum">     152 </span>            :         {&quot;System.Web.DynamicData&quot;, 2},
<span class="lineNum">     153 </span>            :         {&quot;System.Web.Extensions&quot;, 2},
<span class="lineNum">     154 </span>            :         {&quot;System.Web.Mobile&quot;, 0},
<span class="lineNum">     155 </span>            :         {&quot;System.Web.Routing&quot;, 2},
<span class="lineNum">     156 </span>            :         {&quot;System.Web.Services&quot;, 0},
<span class="lineNum">     157 </span>            :         {&quot;System.Windows.Forms&quot;, 0},
<span class="lineNum">     158 </span>            :         {&quot;System.Xml&quot;, 0},
<span class="lineNum">     159 </span>            :         {&quot;System.Xml.Linq&quot;, 2},
<span class="lineNum">     160 </span>            :         {&quot;WindowsBase&quot;, 3},
<span class="lineNum">     161 </span>            :         {&quot;mscorlib&quot;, 0}
<span class="lineNum">     162 </span>            : };
<span class="lineNum">     163 </span>            : #endif
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span>            : /*
<span class="lineNum">     166 </span>            :  * keeps track of loaded assemblies
<span class="lineNum">     167 </span>            :  */
<span class="lineNum">     168 </span>            : static GList *loaded_assemblies = NULL;
<span class="lineNum">     169 </span>            : static MonoAssembly *corlib;
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span>            : #if defined(__native_client__)
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            : /* On Native Client, allow mscorlib to be loaded from memory  */
<span class="lineNum">     174 </span>            : /* instead of loaded off disk.  If these are not set, default */
<span class="lineNum">     175 </span>            : /* mscorlib loading will take place                           */
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            : /* NOTE: If mscorlib data is passed to mono in this way then */
<span class="lineNum">     178 </span>            : /* it needs to remain allocated during the use of mono.      */
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span>            : static void *corlibData = NULL;
<span class="lineNum">     181 </span>            : static size_t corlibSize = 0;
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span>            : void
<span class="lineNum">     184 </span>            : mono_set_corlib_data (void *data, size_t size)
<span class="lineNum">     185 </span>            : {
<span class="lineNum">     186 </span>            :   corlibData = data;
<span class="lineNum">     187 </span>            :   corlibSize = size;
<span class="lineNum">     188 </span>            : }
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span>            : #endif
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span>            : static char* unquote (const char *str);
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : /* This protects loaded_assemblies and image-&gt;references */
<span class="lineNum">     195 </span>            : #define mono_assemblies_lock() mono_os_mutex_lock (&amp;assemblies_mutex)
<span class="lineNum">     196 </span>            : #define mono_assemblies_unlock() mono_os_mutex_unlock (&amp;assemblies_mutex)
<span class="lineNum">     197 </span>            : static mono_mutex_t assemblies_mutex;
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            : /* If defined, points to the bundled assembly information */
<span class="lineNum">     200 </span>            : const MonoBundledAssembly **bundles;
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            : static mono_mutex_t assembly_binding_mutex;
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : /* Loaded assembly binding info */
<span class="lineNum">     205 </span>            : static GSList *loaded_assembly_bindings = NULL;
<a name="206"><span class="lineNum">     206 </span>            : </a>
<span class="lineNum">     207 </span>            : /* Class lazy loading functions */
<span class="lineNum">     208 </span><span class="lineCov">     326213 : static GENERATE_TRY_GET_CLASS_WITH_CACHE (internals_visible, System.Runtime.CompilerServices, InternalsVisibleToAttribute)</span>
<span class="lineNum">     209 </span>            : static MonoAssembly*
<span class="lineNum">     210 </span>            : mono_assembly_invoke_search_hook_internal (MonoAssemblyName *aname, MonoAssembly *requesting, gboolean refonly, gboolean postload);
<span class="lineNum">     211 </span>            : static MonoAssembly*
<span class="lineNum">     212 </span>            : mono_assembly_load_full_internal (MonoAssemblyName *aname, MonoAssembly *requesting, const char *basedir, MonoImageOpenStatus *status, gboolean refonly);
<span class="lineNum">     213 </span>            : static MonoBoolean
<span class="lineNum">     214 </span>            : mono_assembly_is_in_gac (const gchar *filanem);
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span>            : static MonoAssembly*
<span class="lineNum">     217 </span>            : prevent_reference_assembly_from_running (MonoAssembly* candidate, gboolean refonly);
<a name="218"><span class="lineNum">     218 </span>            : </a>
<span class="lineNum">     219 </span>            : static gchar*
<span class="lineNum">     220 </span>            : encode_public_tok (const guchar *token, gint32 len)
<span class="lineNum">     221 </span>            : {
<span class="lineNum">     222 </span>            :         const static gchar allowed [] = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };
<span class="lineNum">     223 </span>            :         gchar *res;
<span class="lineNum">     224 </span>            :         int i;
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineCov">     215307 :         res = (gchar *)g_malloc (len * 2 + 1);</span>
<span class="lineNum">     227 </span><span class="lineCov">    3875539 :         for (i = 0; i &lt; len; i++) {</span>
<span class="lineNum">     228 </span><span class="lineCov">    1722462 :                 res [i * 2] = allowed [token [i] &gt;&gt; 4];</span>
<span class="lineNum">     229 </span><span class="lineCov">    1722462 :                 res [i * 2 + 1] = allowed [token [i] &amp; 0xF];</span>
<span class="lineNum">     230 </span><span class="lineCov">    1722462 :         }</span>
<span class="lineNum">     231 </span><span class="lineCov">     215309 :         res [len * 2] = 0;</span>
<span class="lineNum">     232 </span><span class="lineCov">     215309 :         return res;</span>
<span class="lineNum">     233 </span>            : }
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            : /**
<span class="lineNum">     236 </span>            :  * mono_public_tokens_are_equal:
<span class="lineNum">     237 </span>            :  * @pubt1: first public key token
<span class="lineNum">     238 </span>            :  * @pubt2: second public key token
<span class="lineNum">     239 </span>            :  *
<span class="lineNum">     240 </span>            :  * Compare two public key tokens and return #TRUE is they are equal and #FALSE
<span class="lineNum">     241 </span>            :  * otherwise.
<a name="242"><span class="lineNum">     242 </span>            :  */</a>
<span class="lineNum">     243 </span>            : gboolean
<span class="lineNum">     244 </span>            : mono_public_tokens_are_equal (const unsigned char *pubt1, const unsigned char *pubt2)
<span class="lineNum">     245 </span>            : {
<span class="lineNum">     246 </span><span class="lineCov">    9472542 :         return memcmp (pubt1, pubt2, 16) == 0;</span>
<span class="lineNum">     247 </span>            : }
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span>            : /**
<span class="lineNum">     250 </span>            :  * mono_set_assemblies_path:
<span class="lineNum">     251 </span>            :  * @path: list of paths that contain directories where Mono will look for assemblies
<span class="lineNum">     252 </span>            :  *
<span class="lineNum">     253 </span>            :  * Use this method to override the standard assembly lookup system and
<span class="lineNum">     254 </span>            :  * override any assemblies coming from the GAC.  This is the method
<span class="lineNum">     255 </span>            :  * that supports the MONO_PATH variable.
<span class="lineNum">     256 </span>            :  *
<span class="lineNum">     257 </span>            :  * Notice that MONO_PATH and this method are really a very bad idea as
<span class="lineNum">     258 </span>            :  * it prevents the GAC from working and it prevents the standard
<span class="lineNum">     259 </span>            :  * resolution mechanisms from working.  Nonetheless, for some debugging
<span class="lineNum">     260 </span>            :  * situations and bootstrapping setups, this is useful to have. 
<a name="261"><span class="lineNum">     261 </span>            :  */</a>
<span class="lineNum">     262 </span>            : void
<span class="lineNum">     263 </span>            : mono_set_assemblies_path (const char* path)
<span class="lineNum">     264 </span>            : {
<span class="lineNum">     265 </span>            :         char **splitted, **dest;
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span><span class="lineCov">       3287 :         splitted = g_strsplit (path, G_SEARCHPATH_SEPARATOR_S, 1000);</span>
<span class="lineNum">     268 </span><span class="lineCov">       3287 :         if (assemblies_path)</span>
<span class="lineNum">     269 </span><span class="lineCov">          2 :                 g_strfreev (assemblies_path);</span>
<span class="lineNum">     270 </span><span class="lineCov">       3287 :         assemblies_path = dest = splitted;</span>
<span class="lineNum">     271 </span><span class="lineCov">      15460 :         while (*splitted) {</span>
<span class="lineNum">     272 </span><span class="lineCov">       4443 :                 char *tmp = *splitted;</span>
<span class="lineNum">     273 </span><span class="lineCov">       4443 :                 if (*tmp)</span>
<span class="lineNum">     274 </span><span class="lineCov">       3362 :                         *dest++ = mono_path_canonicalize (tmp);</span>
<span class="lineNum">     275 </span><span class="lineCov">       4443 :                 g_free (tmp);</span>
<span class="lineNum">     276 </span><span class="lineCov">       4443 :                 splitted++;</span>
<span class="lineNum">     277 </span>            :         }
<span class="lineNum">     278 </span><span class="lineCov">       3287 :         *dest = *splitted;</span>
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span><span class="lineCov">       3287 :         if (g_getenv (&quot;MONO_DEBUG&quot;) == NULL)</span>
<span class="lineNum">     281 </span><span class="lineCov">       3287 :                 return;</span>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         splitted = assemblies_path;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         while (*splitted) {</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :                 if (**splitted &amp;&amp; !g_file_test (*splitted, G_FILE_TEST_IS_DIR))</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :                         g_warning (&quot;'%s' in MONO_PATH doesn't exist or has wrong permissions.&quot;, *splitted);</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :                 splitted++;</span>
<span class="lineNum">     289 </span>            :         }
<span class="lineNum">     290 </span><span class="lineCov">       3287 : }</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            : /* Native Client can't get this info from an environment variable so */
<span class="lineNum">     293 </span>            : /* it's passed in to the runtime, or set manually by embedding code. */
<span class="lineNum">     294 </span>            : #ifdef __native_client__
<span class="lineNum">     295 </span>            : char* nacl_mono_path = NULL;
<span class="lineNum">     296 </span>            : #endif
<a name="297"><span class="lineNum">     297 </span>            : </a>
<span class="lineNum">     298 </span>            : static void
<span class="lineNum">     299 </span>            : check_path_env (void)
<span class="lineNum">     300 </span>            : {
<span class="lineNum">     301 </span>            :         const char* path;
<span class="lineNum">     302 </span><span class="lineCov">       3285 :         path = g_getenv (&quot;MONO_PATH&quot;);</span>
<span class="lineNum">     303 </span>            : #ifdef __native_client__
<span class="lineNum">     304 </span>            :         if (!path)
<span class="lineNum">     305 </span>            :                 path = nacl_mono_path;
<span class="lineNum">     306 </span>            : #endif
<span class="lineNum">     307 </span><span class="lineCov">       6570 :         if (!path || assemblies_path != NULL)</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span><span class="lineCov">       3285 :         mono_set_assemblies_path(path);</span>
<span class="lineNum">     311 </span><span class="lineCov">       6570 : }</span>
<a name="312"><span class="lineNum">     312 </span>            : </a>
<span class="lineNum">     313 </span>            : static void
<span class="lineNum">     314 </span>            : check_extra_gac_path_env (void) {
<span class="lineNum">     315 </span>            :         const char *path;
<span class="lineNum">     316 </span>            :         char **splitted, **dest;
<span class="lineNum">     317 </span>            :         
<span class="lineNum">     318 </span><span class="lineCov">       3285 :         path = g_getenv (&quot;MONO_GAC_PREFIX&quot;);</span>
<span class="lineNum">     319 </span><span class="lineCov">       3285 :         if (!path)</span>
<span class="lineNum">     320 </span><span class="lineCov">       3285 :                 return;</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :         splitted = g_strsplit (path, G_SEARCHPATH_SEPARATOR_S, 1000);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :         if (extra_gac_paths)</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                 g_strfreev (extra_gac_paths);</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :         extra_gac_paths = dest = splitted;</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :         while (*splitted){</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :                 if (**splitted)</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :                         *dest++ = *splitted;</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :                 splitted++;</span>
<span class="lineNum">     330 </span>            :         }
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :         *dest = *splitted;</span>
<span class="lineNum">     332 </span>            :         
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :         if (g_getenv (&quot;MONO_DEBUG&quot;) == NULL)</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :         while (*splitted) {</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                 if (**splitted &amp;&amp; !g_file_test (*splitted, G_FILE_TEST_IS_DIR))</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                         g_warning (&quot;'%s' in MONO_GAC_PREFIX doesn't exist or has wrong permissions.&quot;, *splitted);</span>
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                 splitted++;</span>
<span class="lineNum">     341 </span>            :         }
<span class="lineNum">     342 </span><span class="lineCov">       3285 : }</span>
<a name="343"><span class="lineNum">     343 </span>            : </a>
<span class="lineNum">     344 </span>            : static gboolean
<span class="lineNum">     345 </span>            : assembly_binding_maps_name (MonoAssemblyBindingInfo *info, MonoAssemblyName *aname)
<span class="lineNum">     346 </span>            : {
<span class="lineNum">     347 </span><span class="lineCov">    4861252 :         if (!info || !info-&gt;name)</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineCov">    2430626 :         if (strcmp (info-&gt;name, aname-&gt;name))</span>
<span class="lineNum">     351 </span><span class="lineCov">    2329413 :                 return FALSE;</span>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">     202426 :         if (info-&gt;major != aname-&gt;major || info-&gt;minor != aname-&gt;minor)</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">     453093 :         if ((info-&gt;culture != NULL &amp;&amp; info-&gt;culture [0]) != (aname-&gt;culture != NULL &amp;&amp; aname-&gt;culture [0])) </span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     358 </span>            :         
<span class="lineNum">     359 </span><span class="lineCov">     209609 :         if (info-&gt;culture &amp;&amp; aname-&gt;culture &amp;&amp; strcmp (info-&gt;culture, aname-&gt;culture))</span>
<span class="lineNum">     360 </span><span class="lineCov">        300 :                 return FALSE;</span>
<span class="lineNum">     361 </span>            :         
<span class="lineNum">     362 </span><span class="lineCov">     100913 :         if (!mono_public_tokens_are_equal (info-&gt;public_key_token, aname-&gt;public_key_token))</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineCov">     100913 :         return TRUE;</span>
<span class="lineNum">     366 </span><span class="lineCov">    2430626 : }</span>
<a name="367"><span class="lineNum">     367 </span>            : </a>
<span class="lineNum">     368 </span>            : static void
<span class="lineNum">     369 </span>            : mono_assembly_binding_info_free (MonoAssemblyBindingInfo *info)
<span class="lineNum">     370 </span>            : {
<span class="lineNum">     371 </span><span class="lineCov">      39642 :         if (!info)</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span><span class="lineCov">      39642 :         g_free (info-&gt;name);</span>
<span class="lineNum">     375 </span><span class="lineCov">      39642 :         g_free (info-&gt;culture);</span>
<span class="lineNum">     376 </span><span class="lineCov">      79284 : }</span>
<a name="377"><span class="lineNum">     377 </span>            : </a>
<span class="lineNum">     378 </span>            : static void
<span class="lineNum">     379 </span>            : get_publisher_policy_info (MonoImage *image, MonoAssemblyName *aname, MonoAssemblyBindingInfo *binding_info)
<span class="lineNum">     380 </span>            : {
<span class="lineNum">     381 </span>            :         MonoTableInfo *t;
<span class="lineNum">     382 </span>            :         guint32 cols [MONO_MANIFEST_SIZE];
<span class="lineNum">     383 </span>            :         const gchar *filename;
<span class="lineNum">     384 </span>            :         gchar *subpath, *fullpath;
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :         t = &amp;image-&gt;tables [MONO_TABLE_MANIFESTRESOURCE];</span>
<span class="lineNum">     387 </span>            :         /* MS Impl. accepts policy assemblies with more than
<span class="lineNum">     388 </span>            :          * one manifest resource, and only takes the first one */
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :         if (t-&gt;rows &lt; 1) {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                 binding_info-&gt;is_valid = FALSE;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     392 </span>            :         }
<span class="lineNum">     393 </span>            :         
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         mono_metadata_decode_row (t, 0, cols, MONO_MANIFEST_SIZE);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         if ((cols [MONO_MANIFEST_IMPLEMENTATION] &amp; MONO_IMPLEMENTATION_MASK) != MONO_IMPLEMENTATION_FILE) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                 binding_info-&gt;is_valid = FALSE;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     398 </span>            :         }
<span class="lineNum">     399 </span>            :         
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         filename = mono_metadata_string_heap (image, cols [MONO_MANIFEST_NAME]);</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         g_assert (filename != NULL);</span>
<span class="lineNum">     402 </span>            :         
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :         subpath = g_path_get_dirname (image-&gt;name);</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :         fullpath = g_build_path (G_DIR_SEPARATOR_S, subpath, filename, NULL);</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         mono_config_parse_publisher_policy (fullpath, binding_info);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         g_free (subpath);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :         g_free (fullpath);</span>
<span class="lineNum">     408 </span>            :         
<span class="lineNum">     409 </span>            :         /* Define the optional elements/attributes before checking */
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         if (!binding_info-&gt;culture)</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                 binding_info-&gt;culture = g_strdup (&quot;&quot;);</span>
<span class="lineNum">     412 </span>            :         
<span class="lineNum">     413 </span>            :         /* Check that the most important elements/attributes exist */
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :         if (!binding_info-&gt;name || !binding_info-&gt;public_key_token [0] || !binding_info-&gt;has_old_version_bottom ||</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                         !binding_info-&gt;has_new_version || !assembly_binding_maps_name (binding_info, aname)) {</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 mono_assembly_binding_info_free (binding_info);</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 binding_info-&gt;is_valid = FALSE;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     419 </span>            :         }
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         binding_info-&gt;is_valid = TRUE;</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 : }</span>
<a name="423"><span class="lineNum">     423 </span>            : </a>
<span class="lineNum">     424 </span>            : static int
<span class="lineNum">     425 </span>            : compare_versions (AssemblyVersionSet *v, MonoAssemblyName *aname)
<span class="lineNum">     426 </span>            : {
<span class="lineNum">     427 </span><span class="lineCov">      16658 :         if (v-&gt;major &gt; aname-&gt;major)</span>
<span class="lineNum">     428 </span><span class="lineCov">          8 :                 return 1;</span>
<span class="lineNum">     429 </span><span class="lineCov">      16650 :         else if (v-&gt;major &lt; aname-&gt;major)</span>
<span class="lineNum">     430 </span><span class="lineCov">       8329 :                 return -1;</span>
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span><span class="lineCov">       8321 :         if (v-&gt;minor &gt; aname-&gt;minor)</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     434 </span><span class="lineCov">       8321 :         else if (v-&gt;minor &lt; aname-&gt;minor)</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineCov">       8321 :         if (v-&gt;build &gt; aname-&gt;build)</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     439 </span><span class="lineCov">       8321 :         else if (v-&gt;build &lt; aname-&gt;build)</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">       8321 :         if (v-&gt;revision &gt; aname-&gt;revision)</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     444 </span><span class="lineCov">       8321 :         else if (v-&gt;revision &lt; aname-&gt;revision)</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                 return -1;</span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineCov">       8321 :         return 0;</span>
<span class="lineNum">     448 </span><span class="lineCov">      16658 : }</span>
<a name="449"><span class="lineNum">     449 </span>            : </a>
<span class="lineNum">     450 </span>            : static gboolean
<span class="lineNum">     451 </span>            : check_policy_versions (MonoAssemblyBindingInfo *info, MonoAssemblyName *name)
<span class="lineNum">     452 </span>            : {
<span class="lineNum">     453 </span><span class="lineCov">     100554 :         if (!info-&gt;is_valid)</span>
<span class="lineNum">     454 </span><span class="lineCov">      92233 :                 return FALSE;</span>
<span class="lineNum">     455 </span>            :         
<span class="lineNum">     456 </span>            :         /* If has_old_version_top doesn't exist, we don't have an interval */
<span class="lineNum">     457 </span><span class="lineCov">       8321 :         if (!info-&gt;has_old_version_top) {</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                 if (compare_versions (&amp;info-&gt;old_version_bottom, name) == 0)</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                         return TRUE;</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     462 </span>            :         }
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span>            :         /* Check that the version defined by name is valid for the interval */
<span class="lineNum">     465 </span><span class="lineCov">       8321 :         if (compare_versions (&amp;info-&gt;old_version_top, name) &lt; 0)</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            :         /* We should be greater or equal than the small version */
<span class="lineNum">     469 </span><span class="lineCov">       8321 :         if (compare_versions (&amp;info-&gt;old_version_bottom, name) &gt; 0)</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineCov">       8321 :         return TRUE;</span>
<span class="lineNum">     473 </span><span class="lineCov">     100554 : }</span>
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span>            : /**
<span class="lineNum">     476 </span>            :  * mono_assembly_names_equal:
<span class="lineNum">     477 </span>            :  * @l: first assembly
<span class="lineNum">     478 </span>            :  * @r: second assembly.
<span class="lineNum">     479 </span>            :  *
<span class="lineNum">     480 </span>            :  * Compares two MonoAssemblyNames and returns whether they are equal.
<span class="lineNum">     481 </span>            :  *
<span class="lineNum">     482 </span>            :  * This compares the names, the cultures, the release version and their
<span class="lineNum">     483 </span>            :  * public tokens.
<span class="lineNum">     484 </span>            :  *
<span class="lineNum">     485 </span>            :  * Returns: TRUE if both assembly names are equal.
<a name="486"><span class="lineNum">     486 </span>            :  */</a>
<span class="lineNum">     487 </span>            : gboolean
<span class="lineNum">     488 </span>            : mono_assembly_names_equal (MonoAssemblyName *l, MonoAssemblyName *r)
<span class="lineNum">     489 </span>            : {
<span class="lineNum">     490 </span><span class="lineCov">    5078288 :         if (!l-&gt;name || !r-&gt;name)</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineCov">    2539144 :         if (strcmp (l-&gt;name, r-&gt;name))</span>
<span class="lineNum">     494 </span><span class="lineCov">    2434959 :                 return FALSE;</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineCov">     294213 :         if (l-&gt;culture &amp;&amp; r-&gt;culture &amp;&amp; strcmp (l-&gt;culture, r-&gt;culture))</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineCov">     290112 :         if (l-&gt;major != r-&gt;major || l-&gt;minor != r-&gt;minor ||</span>
<span class="lineNum">     500 </span><span class="lineCov">     171907 :                         l-&gt;build != r-&gt;build || l-&gt;revision != r-&gt;revision)</span>
<span class="lineNum">     501 </span><span class="lineCov">      44870 :                 if (! ((l-&gt;major == 0 &amp;&amp; l-&gt;minor == 0 &amp;&amp; l-&gt;build == 0 &amp;&amp; l-&gt;revision == 0) || (r-&gt;major == 0 &amp;&amp; r-&gt;minor == 0 &amp;&amp; r-&gt;build == 0 &amp;&amp; r-&gt;revision == 0)))</span>
<span class="lineNum">     502 </span><span class="lineCov">      22435 :                         return FALSE;</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">     162533 :         if (!l-&gt;public_key_token [0] || !r-&gt;public_key_token [0])</span>
<span class="lineNum">     505 </span><span class="lineCov">        967 :                 return TRUE;</span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineCov">      80783 :         if (!mono_public_tokens_are_equal (l-&gt;public_key_token, r-&gt;public_key_token))</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     509 </span>            : 
<span class="lineNum">     510 </span><span class="lineCov">      80783 :         return TRUE;</span>
<span class="lineNum">     511 </span><span class="lineCov">    2539144 : }</span>
<a name="512"><span class="lineNum">     512 </span>            : </a>
<span class="lineNum">     513 </span>            : static MonoAssembly *
<span class="lineNum">     514 </span>            : load_in_path (const char *basename, const char** search_path, MonoImageOpenStatus *status, MonoBoolean refonly)
<span class="lineNum">     515 </span>            : {
<span class="lineNum">     516 </span>            :         int i;
<span class="lineNum">     517 </span>            :         char *fullpath;
<span class="lineNum">     518 </span>            :         MonoAssembly *result;
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineCov">     197488 :         for (i = 0; search_path [i]; ++i) {</span>
<span class="lineNum">     521 </span><span class="lineCov">      98040 :                 fullpath = g_build_filename (search_path [i], basename, NULL);</span>
<span class="lineNum">     522 </span><span class="lineCov">      98040 :                 result = mono_assembly_open_full (fullpath, status, refonly);</span>
<span class="lineNum">     523 </span><span class="lineCov">      98040 :                 g_free (fullpath);</span>
<span class="lineNum">     524 </span><span class="lineCov">      98040 :                 if (result)</span>
<span class="lineNum">     525 </span><span class="lineCov">      50786 :                         return result;</span>
<span class="lineNum">     526 </span><span class="lineCov">      47254 :         }</span>
<span class="lineNum">     527 </span><span class="lineCov">        704 :         return NULL;</span>
<span class="lineNum">     528 </span><span class="lineCov">      51490 : }</span>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            : /**
<span class="lineNum">     531 </span>            :  * mono_assembly_setrootdir:
<span class="lineNum">     532 </span>            :  * @root_dir: The pathname of the root directory where we will locate assemblies
<span class="lineNum">     533 </span>            :  *
<span class="lineNum">     534 </span>            :  * This routine sets the internal default root directory for looking up
<span class="lineNum">     535 </span>            :  * assemblies.
<span class="lineNum">     536 </span>            :  *
<span class="lineNum">     537 </span>            :  * This is used by Windows installations to compute dynamically the
<span class="lineNum">     538 </span>            :  * place where the Mono assemblies are located.
<span class="lineNum">     539 </span>            :  *
<a name="540"><span class="lineNum">     540 </span>            :  */</a>
<span class="lineNum">     541 </span>            : void
<span class="lineNum">     542 </span>            : mono_assembly_setrootdir (const char *root_dir)
<span class="lineNum">     543 </span>            : {
<span class="lineNum">     544 </span>            :         /*
<span class="lineNum">     545 </span>            :          * Override the MONO_ASSEMBLIES directory configured at compile time.
<span class="lineNum">     546 </span>            :          */
<span class="lineNum">     547 </span>            :         /* Leak if called more than once */
<span class="lineNum">     548 </span><span class="lineCov">       3285 :         default_path [0] = g_strdup (root_dir);</span>
<span class="lineNum">     549 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span>            : /**
<span class="lineNum">     552 </span>            :  * mono_assembly_getrootdir:
<span class="lineNum">     553 </span>            :  * 
<span class="lineNum">     554 </span>            :  * Obtains the root directory used for looking up assemblies.
<span class="lineNum">     555 </span>            :  *
<span class="lineNum">     556 </span>            :  * Returns: a string with the directory, this string should not be freed.
<a name="557"><span class="lineNum">     557 </span>            :  */</a>
<span class="lineNum">     558 </span>            : G_CONST_RETURN gchar *
<span class="lineNum">     559 </span>            : mono_assembly_getrootdir (void)
<span class="lineNum">     560 </span>            : {
<span class="lineNum">     561 </span><span class="lineCov">     331121 :         return default_path [0];</span>
<span class="lineNum">     562 </span>            : }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span>            : /**
<span class="lineNum">     565 </span>            :  * mono_native_getrootdir:
<span class="lineNum">     566 </span>            :  * 
<span class="lineNum">     567 </span>            :  * Obtains the root directory used for looking up native libs (.so, .dylib).
<span class="lineNum">     568 </span>            :  *
<span class="lineNum">     569 </span>            :  * Returns: a string with the directory, this string should be freed by
<span class="lineNum">     570 </span>            :  * the caller.
<a name="571"><span class="lineNum">     571 </span>            :  */</a>
<span class="lineNum">     572 </span>            : gchar *
<span class="lineNum">     573 </span>            : mono_native_getrootdir (void)
<span class="lineNum">     574 </span>            : {
<span class="lineNum">     575 </span><span class="lineCov">         36 :         gchar* fullpath = g_build_path (G_DIR_SEPARATOR_S, mono_assembly_getrootdir (), mono_config_get_reloc_lib_dir(), NULL);</span>
<span class="lineNum">     576 </span><span class="lineCov">         36 :         return fullpath;</span>
<span class="lineNum">     577 </span>            : }
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span>            : /**
<span class="lineNum">     580 </span>            :  * mono_set_dirs:
<span class="lineNum">     581 </span>            :  * @assembly_dir: the base directory for assemblies
<span class="lineNum">     582 </span>            :  * @config_dir: the base directory for configuration files
<span class="lineNum">     583 </span>            :  *
<span class="lineNum">     584 </span>            :  * This routine is used internally and by developers embedding
<span class="lineNum">     585 </span>            :  * the runtime into their own applications.
<span class="lineNum">     586 </span>            :  *
<span class="lineNum">     587 </span>            :  * There are a number of cases to consider: Mono as a system-installed
<span class="lineNum">     588 </span>            :  * package that is available on the location preconfigured or Mono in
<span class="lineNum">     589 </span>            :  * a relocated location.
<span class="lineNum">     590 </span>            :  *
<span class="lineNum">     591 </span>            :  * If you are using a system-installed Mono, you can pass NULL
<span class="lineNum">     592 </span>            :  * to both parameters.  If you are not, you should compute both
<span class="lineNum">     593 </span>            :  * directory values and call this routine.
<span class="lineNum">     594 </span>            :  *
<span class="lineNum">     595 </span>            :  * The values for a given PREFIX are:
<span class="lineNum">     596 </span>            :  *
<span class="lineNum">     597 </span>            :  *    assembly_dir: PREFIX/lib
<span class="lineNum">     598 </span>            :  *    config_dir:   PREFIX/etc
<span class="lineNum">     599 </span>            :  *
<span class="lineNum">     600 </span>            :  * Notice that embedders that use Mono in a relocated way must
<span class="lineNum">     601 </span>            :  * compute the location at runtime, as they will be in control
<span class="lineNum">     602 </span>            :  * of where Mono is installed.
<a name="603"><span class="lineNum">     603 </span>            :  */</a>
<span class="lineNum">     604 </span>            : void
<span class="lineNum">     605 </span>            : mono_set_dirs (const char *assembly_dir, const char *config_dir)
<span class="lineNum">     606 </span>            : {
<span class="lineNum">     607 </span><span class="lineCov">       3285 :         if (assembly_dir == NULL)</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                 assembly_dir = mono_config_get_assemblies_dir ();</span>
<span class="lineNum">     609 </span><span class="lineCov">       3285 :         if (config_dir == NULL)</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                 config_dir = mono_config_get_cfg_dir ();</span>
<span class="lineNum">     611 </span><span class="lineCov">       3285 :         mono_assembly_setrootdir (assembly_dir);</span>
<span class="lineNum">     612 </span><span class="lineCov">       3285 :         mono_set_config_dir (config_dir);</span>
<span class="lineNum">     613 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            : #ifndef HOST_WIN32
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            : static char *
<span class="lineNum">     618 </span>            : compute_base (char *path)
<span class="lineNum">     619 </span>            : {
<span class="lineNum">     620 </span>            :         char *p = strrchr (path, '/');
<span class="lineNum">     621 </span>            :         if (p == NULL)
<span class="lineNum">     622 </span>            :                 return NULL;
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span>            :         /* Not a well known Mono executable, we are embedded, cant guess the base  */
<span class="lineNum">     625 </span>            :         if (strcmp (p, &quot;/mono&quot;) &amp;&amp; strcmp (p, &quot;/mono-boehm&quot;) &amp;&amp; strcmp (p, &quot;/mono-sgen&quot;) &amp;&amp; strcmp (p, &quot;/pedump&quot;) &amp;&amp; strcmp (p, &quot;/monodis&quot;))
<span class="lineNum">     626 </span>            :                 return NULL;
<span class="lineNum">     627 </span>            :             
<span class="lineNum">     628 </span>            :         *p = 0;
<span class="lineNum">     629 </span>            :         p = strrchr (path, '/');
<span class="lineNum">     630 </span>            :         if (p == NULL)
<span class="lineNum">     631 </span>            :                 return NULL;
<span class="lineNum">     632 </span>            :         
<span class="lineNum">     633 </span>            :         if (strcmp (p, &quot;/bin&quot;) != 0)
<span class="lineNum">     634 </span>            :                 return NULL;
<span class="lineNum">     635 </span>            :         *p = 0;
<span class="lineNum">     636 </span>            :         return path;
<span class="lineNum">     637 </span>            : }
<a name="638"><span class="lineNum">     638 </span>            : </a>
<span class="lineNum">     639 </span>            : static void
<span class="lineNum">     640 </span>            : fallback (void)
<span class="lineNum">     641 </span>            : {
<span class="lineNum">     642 </span><span class="lineCov">       3285 :         mono_set_dirs (mono_config_get_assemblies_dir (), mono_config_get_cfg_dir ());</span>
<span class="lineNum">     643 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span>            : static G_GNUC_UNUSED void
<span class="lineNum">     646 </span>            : set_dirs (char *exe)
<span class="lineNum">     647 </span>            : {
<span class="lineNum">     648 </span>            :         char *base;
<span class="lineNum">     649 </span>            :         char *config, *lib, *mono;
<span class="lineNum">     650 </span>            :         struct stat buf;
<span class="lineNum">     651 </span>            :         const char *bindir;
<span class="lineNum">     652 </span>            :         
<span class="lineNum">     653 </span>            :         /*
<span class="lineNum">     654 </span>            :          * Only /usr prefix is treated specially
<span class="lineNum">     655 </span>            :          */
<span class="lineNum">     656 </span>            :         bindir = mono_config_get_bin_dir ();
<span class="lineNum">     657 </span>            :         g_assert (bindir);
<span class="lineNum">     658 </span>            :         if (strncmp (exe, bindir, strlen (bindir)) == 0 || (base = compute_base (exe)) == NULL){
<span class="lineNum">     659 </span>            :                 fallback ();
<span class="lineNum">     660 </span>            :                 return;
<span class="lineNum">     661 </span>            :         }
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            :         config = g_build_filename (base, &quot;etc&quot;, NULL);
<span class="lineNum">     664 </span>            :         lib = g_build_filename (base, &quot;lib&quot;, NULL);
<span class="lineNum">     665 </span>            :         mono = g_build_filename (lib, &quot;mono/4.5&quot;, NULL);  // FIXME: stop hardcoding 4.5 here
<span class="lineNum">     666 </span>            :         if (stat (mono, &amp;buf) == -1)
<span class="lineNum">     667 </span>            :                 fallback ();
<span class="lineNum">     668 </span>            :         else {
<span class="lineNum">     669 </span>            :                 mono_set_dirs (lib, config);
<span class="lineNum">     670 </span>            :         }
<span class="lineNum">     671 </span>            :         
<span class="lineNum">     672 </span>            :         g_free (config);
<span class="lineNum">     673 </span>            :         g_free (lib);
<span class="lineNum">     674 </span>            :         g_free (mono);
<span class="lineNum">     675 </span>            : }
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            : #endif /* HOST_WIN32 */
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span>            : /**
<span class="lineNum">     680 </span>            :  * mono_set_rootdir:
<span class="lineNum">     681 </span>            :  *
<span class="lineNum">     682 </span>            :  * Registers the root directory for the Mono runtime, for Linux and Solaris 10,
<span class="lineNum">     683 </span>            :  * this auto-detects the prefix where Mono was installed. 
<a name="684"><span class="lineNum">     684 </span>            :  */</a>
<span class="lineNum">     685 </span>            : void
<span class="lineNum">     686 </span>            : mono_set_rootdir (void)
<span class="lineNum">     687 </span>            : {
<span class="lineNum">     688 </span>            : #if defined(HOST_WIN32) || (defined(PLATFORM_MACOSX) &amp;&amp; !defined(TARGET_ARM))
<span class="lineNum">     689 </span>            :         gchar *bindir, *installdir, *root, *name, *resolvedname, *config;
<span class="lineNum">     690 </span>            : 
<span class="lineNum">     691 </span>            : #ifdef HOST_WIN32
<span class="lineNum">     692 </span>            :         name = mono_get_module_file_name ((HMODULE) &amp;__ImageBase);
<span class="lineNum">     693 </span>            : #else
<span class="lineNum">     694 </span>            :         {
<span class="lineNum">     695 </span>            :                 /* 
<span class="lineNum">     696 </span>            :                  * _NSGetExecutablePath may return -1 to indicate buf is not large
<span class="lineNum">     697 </span>            :                  *  enough, but we ignore that case to avoid having to do extra dynamic
<span class="lineNum">     698 </span>            :                  *  allocation for the path and hope that 4096 is enough - this is 
<span class="lineNum">     699 </span>            :                  *  ok in the Linux/Solaris case below at least...
<span class="lineNum">     700 </span>            :                  */
<span class="lineNum">     701 </span>            :                 
<span class="lineNum">     702 </span>            :                 gchar buf[4096];
<span class="lineNum">     703 </span><span class="lineCov">       3285 :                 guint buf_size = sizeof (buf);</span>
<span class="lineNum">     704 </span>            :  
<span class="lineNum">     705 </span><span class="lineCov">       3285 :                 name = NULL;</span>
<span class="lineNum">     706 </span><span class="lineCov">       3285 :                 if (_NSGetExecutablePath (buf, &amp;buf_size) == 0)</span>
<span class="lineNum">     707 </span><span class="lineCov">       3285 :                         name = g_strdup (buf);</span>
<span class="lineNum">     708 </span>            :  
<span class="lineNum">     709 </span><span class="lineCov">       3285 :                 if (name == NULL) {</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                         fallback ();</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     712 </span>            :                 }
<span class="lineNum">     713 </span>            :         }
<span class="lineNum">     714 </span>            : #endif
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span><span class="lineCov">       3285 :         resolvedname = mono_path_resolve_symlinks (name);</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">       3285 :         bindir = g_path_get_dirname (resolvedname);</span>
<span class="lineNum">     719 </span><span class="lineCov">       3285 :         installdir = g_path_get_dirname (bindir);</span>
<span class="lineNum">     720 </span><span class="lineCov">       3285 :         root = g_build_path (G_DIR_SEPARATOR_S, installdir, &quot;lib&quot;, NULL);</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineCov">       3285 :         config = g_build_filename (root, &quot;..&quot;, &quot;etc&quot;, NULL);</span>
<span class="lineNum">     723 </span>            : #ifdef HOST_WIN32
<span class="lineNum">     724 </span>            :         mono_set_dirs (root, config);
<span class="lineNum">     725 </span>            : #else
<span class="lineNum">     726 </span><span class="lineCov">       3285 :         if (g_file_test (root, G_FILE_TEST_EXISTS) &amp;&amp; g_file_test (config, G_FILE_TEST_EXISTS))</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :                 mono_set_dirs (root, config);</span>
<span class="lineNum">     728 </span>            :         else
<span class="lineNum">     729 </span><span class="lineCov">       3285 :                 fallback ();</span>
<span class="lineNum">     730 </span>            : #endif
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span><span class="lineCov">       3285 :         g_free (config);</span>
<span class="lineNum">     733 </span><span class="lineCov">       3285 :         g_free (root);</span>
<span class="lineNum">     734 </span><span class="lineCov">       3285 :         g_free (installdir);</span>
<span class="lineNum">     735 </span><span class="lineCov">       3285 :         g_free (bindir);</span>
<span class="lineNum">     736 </span><span class="lineCov">       3285 :         g_free (name);</span>
<span class="lineNum">     737 </span><span class="lineCov">       3285 :         g_free (resolvedname);</span>
<span class="lineNum">     738 </span>            : #elif defined(DISABLE_MONO_AUTODETECTION)
<span class="lineNum">     739 </span>            :         fallback ();
<span class="lineNum">     740 </span>            : #else
<span class="lineNum">     741 </span>            :         char buf [4096];
<span class="lineNum">     742 </span>            :         int  s;
<span class="lineNum">     743 </span>            :         char *str;
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span>            :         /* Linux style */
<span class="lineNum">     746 </span>            :         s = readlink (&quot;/proc/self/exe&quot;, buf, sizeof (buf)-1);
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span>            :         if (s != -1){
<span class="lineNum">     749 </span>            :                 buf [s] = 0;
<span class="lineNum">     750 </span>            :                 set_dirs (buf);
<span class="lineNum">     751 </span>            :                 return;
<span class="lineNum">     752 </span>            :         }
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span>            :         /* Solaris 10 style */
<span class="lineNum">     755 </span>            :         str = g_strdup_printf (&quot;/proc/%d/path/a.out&quot;, getpid ());
<span class="lineNum">     756 </span>            :         s = readlink (str, buf, sizeof (buf)-1);
<span class="lineNum">     757 </span>            :         g_free (str);
<span class="lineNum">     758 </span>            :         if (s != -1){
<span class="lineNum">     759 </span>            :                 buf [s] = 0;
<span class="lineNum">     760 </span>            :                 set_dirs (buf);
<span class="lineNum">     761 </span>            :                 return;
<span class="lineNum">     762 </span>            :         } 
<span class="lineNum">     763 </span>            :         fallback ();
<span class="lineNum">     764 </span>            : #endif
<span class="lineNum">     765 </span><span class="lineCov">       6570 : }</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            : /**
<span class="lineNum">     768 </span>            :  * mono_assemblies_init:
<span class="lineNum">     769 </span>            :  *
<span class="lineNum">     770 </span>            :  *  Initialize global variables used by this module.
<a name="771"><span class="lineNum">     771 </span>            :  */</a>
<span class="lineNum">     772 </span>            : void
<span class="lineNum">     773 </span>            : mono_assemblies_init (void)
<span class="lineNum">     774 </span>            : {
<span class="lineNum">     775 </span>            :         /*
<span class="lineNum">     776 </span>            :          * Initialize our internal paths if we have not been initialized yet.
<span class="lineNum">     777 </span>            :          * This happens when embedders use Mono.
<span class="lineNum">     778 </span>            :          */
<span class="lineNum">     779 </span><span class="lineCov">       3285 :         if (mono_assembly_getrootdir () == NULL)</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :                 mono_set_rootdir ();</span>
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span><span class="lineCov">       3285 :         check_path_env ();</span>
<span class="lineNum">     783 </span><span class="lineCov">       3285 :         check_extra_gac_path_env ();</span>
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineCov">       3285 :         mono_os_mutex_init_recursive (&amp;assemblies_mutex);</span>
<span class="lineNum">     786 </span><span class="lineCov">       3285 :         mono_os_mutex_init (&amp;assembly_binding_mutex);</span>
<span class="lineNum">     787 </span><span class="lineCov">       3285 : }</span>
<a name="788"><span class="lineNum">     788 </span>            : </a>
<span class="lineNum">     789 </span>            : static void
<span class="lineNum">     790 </span>            : mono_assembly_binding_lock (void)
<span class="lineNum">     791 </span>            : {
<span class="lineNum">     792 </span><span class="lineCov">     719804 :         mono_locks_os_acquire (&amp;assembly_binding_mutex, AssemblyBindingLock);</span>
<span class="lineNum">     793 </span><span class="lineCov">     179956 : }</span>
<a name="794"><span class="lineNum">     794 </span>            : </a>
<span class="lineNum">     795 </span>            : static void
<span class="lineNum">     796 </span>            : mono_assembly_binding_unlock (void)
<span class="lineNum">     797 </span>            : {
<span class="lineNum">     798 </span><span class="lineCov">     719824 :         mono_locks_os_release (&amp;assembly_binding_mutex, AssemblyBindingLock);</span>
<span class="lineNum">     799 </span><span class="lineCov">     179956 : }</span>
<a name="800"><span class="lineNum">     800 </span>            : </a>
<span class="lineNum">     801 </span>            : gboolean
<span class="lineNum">     802 </span>            : mono_assembly_fill_assembly_name_full (MonoImage *image, MonoAssemblyName *aname, gboolean copyBlobs)
<span class="lineNum">     803 </span>            : {
<span class="lineNum">     804 </span><span class="lineCov">      44233 :         MonoTableInfo *t = &amp;image-&gt;tables [MONO_TABLE_ASSEMBLY];</span>
<span class="lineNum">     805 </span>            :         guint32 cols [MONO_ASSEMBLY_SIZE];
<span class="lineNum">     806 </span>            :         gint32 machine, flags;
<span class="lineNum">     807 </span>            : 
<span class="lineNum">     808 </span><span class="lineCov">      44233 :         if (!t-&gt;rows)</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineCov">      44233 :         mono_metadata_decode_row (t, 0, cols, MONO_ASSEMBLY_SIZE);</span>
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span><span class="lineCov">      44233 :         aname-&gt;hash_len = 0;</span>
<span class="lineNum">     814 </span><span class="lineCov">      44233 :         aname-&gt;hash_value = NULL;</span>
<span class="lineNum">     815 </span><span class="lineCov">      44233 :         aname-&gt;name = mono_metadata_string_heap (image, cols [MONO_ASSEMBLY_NAME]);</span>
<span class="lineNum">     816 </span><span class="lineCov">      44233 :         if (copyBlobs)</span>
<span class="lineNum">     817 </span><span class="lineCov">        300 :                 aname-&gt;name = g_strdup (aname-&gt;name);</span>
<span class="lineNum">     818 </span><span class="lineCov">      44233 :         aname-&gt;culture = mono_metadata_string_heap (image, cols [MONO_ASSEMBLY_CULTURE]);</span>
<span class="lineNum">     819 </span><span class="lineCov">      44233 :         if (copyBlobs)</span>
<span class="lineNum">     820 </span><span class="lineCov">        300 :                 aname-&gt;culture = g_strdup (aname-&gt;culture);</span>
<span class="lineNum">     821 </span><span class="lineCov">      44233 :         aname-&gt;flags = cols [MONO_ASSEMBLY_FLAGS];</span>
<span class="lineNum">     822 </span><span class="lineCov">      44233 :         aname-&gt;major = cols [MONO_ASSEMBLY_MAJOR_VERSION];</span>
<span class="lineNum">     823 </span><span class="lineCov">      44233 :         aname-&gt;minor = cols [MONO_ASSEMBLY_MINOR_VERSION];</span>
<span class="lineNum">     824 </span><span class="lineCov">      44233 :         aname-&gt;build = cols [MONO_ASSEMBLY_BUILD_NUMBER];</span>
<span class="lineNum">     825 </span><span class="lineCov">      44233 :         aname-&gt;revision = cols [MONO_ASSEMBLY_REV_NUMBER];</span>
<span class="lineNum">     826 </span><span class="lineCov">      44233 :         aname-&gt;hash_alg = cols [MONO_ASSEMBLY_HASH_ALG];</span>
<span class="lineNum">     827 </span><span class="lineCov">      44233 :         if (cols [MONO_ASSEMBLY_PUBLIC_KEY]) {</span>
<span class="lineNum">     828 </span><span class="lineCov">      41671 :                 guchar* token = (guchar *)g_malloc (8);</span>
<span class="lineNum">     829 </span>            :                 gchar* encoded;
<span class="lineNum">     830 </span>            :                 const gchar* pkey;
<span class="lineNum">     831 </span>            :                 int len;
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span><span class="lineCov">      41671 :                 pkey = mono_metadata_blob_heap (image, cols [MONO_ASSEMBLY_PUBLIC_KEY]);</span>
<span class="lineNum">     834 </span><span class="lineCov">      41671 :                 len = mono_metadata_decode_blob_size (pkey, &amp;pkey);</span>
<span class="lineNum">     835 </span><span class="lineCov">      41671 :                 aname-&gt;public_key = (guchar*)pkey;</span>
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span><span class="lineCov">      41671 :                 mono_digest_get_public_token (token, aname-&gt;public_key, len);</span>
<span class="lineNum">     838 </span><span class="lineCov">      41671 :                 encoded = encode_public_tok (token, 8);</span>
<span class="lineNum">     839 </span><span class="lineCov">      41671 :                 g_strlcpy ((char*)aname-&gt;public_key_token, encoded, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineCov">      41671 :                 g_free (encoded);</span>
<span class="lineNum">     842 </span><span class="lineCov">      41671 :                 g_free (token);</span>
<span class="lineNum">     843 </span><span class="lineCov">      41671 :         }</span>
<span class="lineNum">     844 </span>            :         else {
<span class="lineNum">     845 </span><span class="lineCov">       2562 :                 aname-&gt;public_key = NULL;</span>
<span class="lineNum">     846 </span><span class="lineCov">       2562 :                 memset (aname-&gt;public_key_token, 0, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">     847 </span>            :         }
<span class="lineNum">     848 </span>            : 
<span class="lineNum">     849 </span><span class="lineCov">      44231 :         if (cols [MONO_ASSEMBLY_PUBLIC_KEY]) {</span>
<span class="lineNum">     850 </span><span class="lineCov">      41670 :                 aname-&gt;public_key = (guchar*)mono_metadata_blob_heap (image, cols [MONO_ASSEMBLY_PUBLIC_KEY]);</span>
<span class="lineNum">     851 </span><span class="lineCov">      41670 :                 if (copyBlobs) {</span>
<span class="lineNum">     852 </span>            :                         const gchar *pkey_end;
<span class="lineNum">     853 </span><span class="lineCov">        300 :                         int len = mono_metadata_decode_blob_size ((const gchar*) aname-&gt;public_key, &amp;pkey_end);</span>
<span class="lineNum">     854 </span><span class="lineCov">        300 :                         pkey_end += len; /* move to end */</span>
<span class="lineNum">     855 </span><span class="lineCov">        300 :                         size_t size = pkey_end - (const gchar*)aname-&gt;public_key;</span>
<span class="lineNum">     856 </span><span class="lineCov">        300 :                         guchar *tmp = g_new (guchar, size);</span>
<span class="lineNum">     857 </span><span class="lineCov">        300 :                         memcpy (tmp, aname-&gt;public_key, size);</span>
<span class="lineNum">     858 </span><span class="lineCov">        300 :                         aname-&gt;public_key = tmp;</span>
<span class="lineNum">     859 </span><span class="lineCov">        300 :                 }</span>
<span class="lineNum">     860 </span>            : 
<span class="lineNum">     861 </span><span class="lineCov">      41670 :         }</span>
<span class="lineNum">     862 </span>            :         else
<span class="lineNum">     863 </span><span class="lineCov">       2562 :                 aname-&gt;public_key = 0;</span>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineCov">      44230 :         machine = ((MonoCLIImageInfo*)(image-&gt;image_info))-&gt;cli_header.coff.coff_machine;</span>
<span class="lineNum">     866 </span><span class="lineCov">      44230 :         flags = ((MonoCLIImageInfo*)(image-&gt;image_info))-&gt;cli_cli_header.ch_flags;</span>
<span class="lineNum">     867 </span><span class="lineCov">      44230 :         switch (machine) {</span>
<span class="lineNum">     868 </span>            :         case COFF_MACHINE_I386:
<span class="lineNum">     869 </span>            :                 /* https://bugzilla.xamarin.com/show_bug.cgi?id=17632 */
<span class="lineNum">     870 </span><span class="lineCov">      44232 :                 if (flags &amp; (CLI_FLAGS_32BITREQUIRED|CLI_FLAGS_PREFERRED32BIT))</span>
<span class="lineNum">     871 </span><span class="lineCov">          8 :                         aname-&gt;arch = MONO_PROCESSOR_ARCHITECTURE_X86;</span>
<span class="lineNum">     872 </span><span class="lineCov">      44224 :                 else if ((flags &amp; 0x70) == 0x70)</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                         aname-&gt;arch = MONO_PROCESSOR_ARCHITECTURE_NONE;</span>
<span class="lineNum">     874 </span>            :                 else
<span class="lineNum">     875 </span><span class="lineCov">      44224 :                         aname-&gt;arch = MONO_PROCESSOR_ARCHITECTURE_MSIL;</span>
<span class="lineNum">     876 </span><span class="lineCov">      44232 :                 break;</span>
<span class="lineNum">     877 </span>            :         case COFF_MACHINE_IA64:
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :                 aname-&gt;arch = MONO_PROCESSOR_ARCHITECTURE_IA64;</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     880 </span>            :         case COFF_MACHINE_AMD64:
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                 aname-&gt;arch = MONO_PROCESSOR_ARCHITECTURE_AMD64;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     883 </span>            :         case COFF_MACHINE_ARM:
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :                 aname-&gt;arch = MONO_PROCESSOR_ARCHITECTURE_ARM;</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     886 </span>            :         default:
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     888 </span>            :         }
<span class="lineNum">     889 </span>            : 
<span class="lineNum">     890 </span><span class="lineCov">      44231 :         return TRUE;</span>
<span class="lineNum">     891 </span><span class="lineCov">      44232 : }</span>
<a name="892"><span class="lineNum">     892 </span>            : </a>
<span class="lineNum">     893 </span>            : gboolean
<span class="lineNum">     894 </span>            : mono_assembly_fill_assembly_name (MonoImage *image, MonoAssemblyName *aname)
<span class="lineNum">     895 </span>            : {
<span class="lineNum">     896 </span><span class="lineCov">      43933 :         return mono_assembly_fill_assembly_name_full (image, aname, FALSE);</span>
<span class="lineNum">     897 </span>            : }
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span>            : /**
<span class="lineNum">     900 </span>            :  * mono_stringify_assembly_name:
<span class="lineNum">     901 </span>            :  * @aname: the assembly name.
<span class="lineNum">     902 </span>            :  *
<span class="lineNum">     903 </span>            :  * Convert @aname into its string format. The returned string is dynamically
<span class="lineNum">     904 </span>            :  * allocated and should be freed by the caller.
<span class="lineNum">     905 </span>            :  *
<span class="lineNum">     906 </span>            :  * Returns: a newly allocated string with a string representation of
<span class="lineNum">     907 </span>            :  * the assembly name.
<a name="908"><span class="lineNum">     908 </span>            :  */</a>
<span class="lineNum">     909 </span>            : char*
<span class="lineNum">     910 </span>            : mono_stringify_assembly_name (MonoAssemblyName *aname)
<span class="lineNum">     911 </span>            : {
<span class="lineNum">     912 </span><span class="lineCov">      14898 :         const char *quote = (aname-&gt;name &amp;&amp; g_ascii_isspace (aname-&gt;name [0])) ? &quot;\&quot;&quot; : &quot;&quot;;</span>
<span class="lineNum">     913 </span>            : 
<span class="lineNum">     914 </span><span class="lineCov">       4966 :         return g_strdup_printf (</span>
<span class="lineNum">     915 </span>            :                 &quot;%s%s%s, Version=%d.%d.%d.%d, Culture=%s, PublicKeyToken=%s%s&quot;,
<span class="lineNum">     916 </span><span class="lineCov">       4966 :                 quote, aname-&gt;name, quote,</span>
<span class="lineNum">     917 </span><span class="lineCov">       4966 :                 aname-&gt;major, aname-&gt;minor, aname-&gt;build, aname-&gt;revision,</span>
<span class="lineNum">     918 </span><span class="lineCov">      19864 :                 aname-&gt;culture &amp;&amp; *aname-&gt;culture? aname-&gt;culture: &quot;neutral&quot;,</span>
<span class="lineNum">     919 </span><span class="lineCov">      14898 :                 aname-&gt;public_key_token [0] ? (char *)aname-&gt;public_key_token : &quot;null&quot;,</span>
<span class="lineNum">     920 </span><span class="lineCov">       4966 :                 (aname-&gt;flags &amp; ASSEMBLYREF_RETARGETABLE_FLAG) ? &quot;, Retargetable=Yes&quot; : &quot;&quot;);</span>
<span class="lineNum">     921 </span>            : }
<a name="922"><span class="lineNum">     922 </span>            : </a>
<span class="lineNum">     923 </span>            : static gchar*
<span class="lineNum">     924 </span>            : assemblyref_public_tok (MonoImage *image, guint32 key_index, guint32 flags)
<span class="lineNum">     925 </span>            : {
<span class="lineNum">     926 </span>            :         const gchar *public_tok;
<span class="lineNum">     927 </span>            :         int len;
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span><span class="lineCov">     115924 :         public_tok = mono_metadata_blob_heap (image, key_index);</span>
<span class="lineNum">     930 </span><span class="lineCov">     115924 :         len = mono_metadata_decode_blob_size (public_tok, &amp;public_tok);</span>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span><span class="lineCov">     115924 :         if (flags &amp; ASSEMBLYREF_FULL_PUBLIC_KEY_FLAG) {</span>
<span class="lineNum">     933 </span>            :                 guchar token [8];
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :                 mono_digest_get_public_token (token, (guchar*)public_tok, len);</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :                 return encode_public_tok (token, 8);</span>
<span class="lineNum">     936 </span>            :         }
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span><span class="lineCov">     115924 :         return encode_public_tok ((guchar*)public_tok, len);</span>
<span class="lineNum">     939 </span><span class="lineCov">     115924 : }</span>
<span class="lineNum">     940 </span>            : 
<span class="lineNum">     941 </span>            : /**
<span class="lineNum">     942 </span>            :  * mono_assembly_addref:
<span class="lineNum">     943 </span>            :  * @assemnly: the assembly to reference
<span class="lineNum">     944 </span>            :  *
<span class="lineNum">     945 </span>            :  * This routine increments the reference count on a MonoAssembly.
<span class="lineNum">     946 </span>            :  * The reference count is reduced every time the method mono_assembly_close() is
<span class="lineNum">     947 </span>            :  * invoked.
<a name="948"><span class="lineNum">     948 </span>            :  */</a>
<span class="lineNum">     949 </span>            : void
<span class="lineNum">     950 </span>            : mono_assembly_addref (MonoAssembly *assembly)
<span class="lineNum">     951 </span>            : {
<span class="lineNum">     952 </span><span class="lineCov">     158812 :         InterlockedIncrement (&amp;assembly-&gt;ref_count);</span>
<span class="lineNum">     953 </span><span class="lineCov">     158812 : }</span>
<span class="lineNum">     954 </span>            : 
<span class="lineNum">     955 </span>            : /*
<span class="lineNum">     956 </span>            :  * CAUTION: This table must be kept in sync with
<span class="lineNum">     957 </span>            :  *          ivkm/reflect/Fusion.cs
<span class="lineNum">     958 </span>            :  */
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span>            : #define SILVERLIGHT_KEY &quot;7cec85d7bea7798e&quot;
<span class="lineNum">     961 </span>            : #define WINFX_KEY &quot;31bf3856ad364e35&quot;
<span class="lineNum">     962 </span>            : #define ECMA_KEY &quot;b77a5c561934e089&quot;
<span class="lineNum">     963 </span>            : #define MSFINAL_KEY &quot;b03f5f7f11d50a3a&quot;
<span class="lineNum">     964 </span>            : #define COMPACTFRAMEWORK_KEY &quot;969db8053d3322ac&quot;
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span>            : typedef struct {
<span class="lineNum">     967 </span>            :         const char *name;
<span class="lineNum">     968 </span>            :         const char *from;
<span class="lineNum">     969 </span>            :         const char *to;
<span class="lineNum">     970 </span>            : } KeyRemapEntry;
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            : static KeyRemapEntry key_remap_table[] = {
<span class="lineNum">     973 </span>            :         { &quot;CustomMarshalers&quot;, COMPACTFRAMEWORK_KEY, MSFINAL_KEY },
<span class="lineNum">     974 </span>            :         { &quot;Microsoft.CSharp&quot;, WINFX_KEY, MSFINAL_KEY },
<span class="lineNum">     975 </span>            :         { &quot;Microsoft.VisualBasic&quot;, COMPACTFRAMEWORK_KEY, MSFINAL_KEY },
<span class="lineNum">     976 </span>            :         { &quot;System&quot;, SILVERLIGHT_KEY, ECMA_KEY },
<span class="lineNum">     977 </span>            :         { &quot;System&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     978 </span>            :         { &quot;System.ComponentModel.Composition&quot;, WINFX_KEY, ECMA_KEY },
<span class="lineNum">     979 </span>            :         { &quot;System.ComponentModel.DataAnnotations&quot;, &quot;ddd0da4d3e678217&quot;, WINFX_KEY },
<span class="lineNum">     980 </span>            :         { &quot;System.Core&quot;, SILVERLIGHT_KEY, ECMA_KEY },
<span class="lineNum">     981 </span>            :         { &quot;System.Core&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     982 </span>            :         { &quot;System.Data&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     983 </span>            :         { &quot;System.Data.DataSetExtensions&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     984 </span>            :         { &quot;System.Drawing&quot;, COMPACTFRAMEWORK_KEY, MSFINAL_KEY },
<span class="lineNum">     985 </span>            :         { &quot;System.Messaging&quot;, COMPACTFRAMEWORK_KEY, MSFINAL_KEY },
<span class="lineNum">     986 </span>            :         // FIXME: MS uses MSFINAL_KEY for .NET 4.5
<span class="lineNum">     987 </span>            :         { &quot;System.Net&quot;, SILVERLIGHT_KEY, MSFINAL_KEY },
<span class="lineNum">     988 </span>            :         { &quot;System.Numerics&quot;, WINFX_KEY, ECMA_KEY },
<span class="lineNum">     989 </span>            :         { &quot;System.Runtime.Serialization&quot;, SILVERLIGHT_KEY, ECMA_KEY },
<span class="lineNum">     990 </span>            :         { &quot;System.Runtime.Serialization&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     991 </span>            :         { &quot;System.ServiceModel&quot;, WINFX_KEY, ECMA_KEY },
<span class="lineNum">     992 </span>            :         { &quot;System.ServiceModel&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     993 </span>            :         { &quot;System.ServiceModel.Web&quot;, SILVERLIGHT_KEY, WINFX_KEY },
<span class="lineNum">     994 </span>            :         { &quot;System.Web.Services&quot;, COMPACTFRAMEWORK_KEY, MSFINAL_KEY },
<span class="lineNum">     995 </span>            :         { &quot;System.Windows&quot;, SILVERLIGHT_KEY, MSFINAL_KEY },
<span class="lineNum">     996 </span>            :         { &quot;System.Windows.Forms&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     997 </span>            :         { &quot;System.Xml&quot;, SILVERLIGHT_KEY, ECMA_KEY },
<span class="lineNum">     998 </span>            :         { &quot;System.Xml&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">     999 </span>            :         { &quot;System.Xml.Linq&quot;, WINFX_KEY, ECMA_KEY },
<span class="lineNum">    1000 </span>            :         { &quot;System.Xml.Linq&quot;, COMPACTFRAMEWORK_KEY, ECMA_KEY },
<span class="lineNum">    1001 </span>            :         { &quot;System.Xml.Serialization&quot;, WINFX_KEY, ECMA_KEY }
<span class="lineNum">    1002 </span>            : };
<a name="1003"><span class="lineNum">    1003 </span>            : </a>
<span class="lineNum">    1004 </span>            : static void
<span class="lineNum">    1005 </span>            : remap_keys (MonoAssemblyName *aname)
<span class="lineNum">    1006 </span>            : {
<span class="lineNum">    1007 </span>            :         int i;
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; G_N_ELEMENTS (key_remap_table); i++) {</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :                 const KeyRemapEntry *entry = &amp;key_remap_table [i];</span>
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :                 if (strcmp (aname-&gt;name, entry-&gt;name) ||</span>
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                     !mono_public_tokens_are_equal (aname-&gt;public_key_token, (const unsigned char*) entry-&gt;from))</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1014 </span>            : 
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :                 memcpy (aname-&gt;public_key_token, entry-&gt;to, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    1016 </span>            :                      
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1018 </span>            :                             &quot;Remapped public key token of retargetable assembly %s from %s to %s&quot;,
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :                             aname-&gt;name, entry-&gt;from, entry-&gt;to);</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1021 </span>            :         }
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 : }</span>
<a name="1023"><span class="lineNum">    1023 </span>            : </a>
<span class="lineNum">    1024 </span>            : static MonoAssemblyName *
<span class="lineNum">    1025 </span>            : mono_assembly_remap_version (MonoAssemblyName *aname, MonoAssemblyName *dest_aname)
<span class="lineNum">    1026 </span>            : {
<span class="lineNum">    1027 </span>            :         const MonoRuntimeInfo *current_runtime;
<span class="lineNum">    1028 </span>            :         int pos, first, last;
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineCov">     287728 :         if (aname-&gt;name == NULL) return aname;</span>
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span><span class="lineCov">     287727 :         current_runtime = mono_get_runtime_info ();</span>
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span><span class="lineCov">     287727 :         if (aname-&gt;flags &amp; ASSEMBLYREF_RETARGETABLE_FLAG) {</span>
<span class="lineNum">    1035 </span>            :                 const AssemblyVersionSet* vset;
<span class="lineNum">    1036 </span>            : 
<span class="lineNum">    1037 </span>            :                 /* Remap to current runtime */
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                 vset = &amp;current_runtime-&gt;version_sets [0];</span>
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :                 memcpy (dest_aname, aname, sizeof(MonoAssemblyName));</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :                 dest_aname-&gt;major = vset-&gt;major;</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                 dest_aname-&gt;minor = vset-&gt;minor;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :                 dest_aname-&gt;build = vset-&gt;build;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :                 dest_aname-&gt;revision = vset-&gt;revision;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :                 dest_aname-&gt;flags &amp;= ~ASSEMBLYREF_RETARGETABLE_FLAG;</span>
<span class="lineNum">    1046 </span>            : 
<span class="lineNum">    1047 </span>            :                 /* Remap assembly name */
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :                 if (!strcmp (aname-&gt;name, &quot;System.Net&quot;))</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :                         dest_aname-&gt;name = g_strdup (&quot;System&quot;);</span>
<span class="lineNum">    1050 </span>            :                 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :                 remap_keys (dest_aname);</span>
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1054 </span>            :                                         &quot;The request to load the retargetable assembly %s v%d.%d.%d.%d was remapped to %s v%d.%d.%d.%d&quot;,
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                                         aname-&gt;name,</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :                                         aname-&gt;major, aname-&gt;minor, aname-&gt;build, aname-&gt;revision,</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :                                         dest_aname-&gt;name,</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :                                         vset-&gt;major, vset-&gt;minor, vset-&gt;build, vset-&gt;revision</span>
<span class="lineNum">    1059 </span>            :                                         );
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :                 return dest_aname;</span>
<span class="lineNum">    1062 </span>            :         }
<span class="lineNum">    1063 </span>            :         
<span class="lineNum">    1064 </span>            : #ifndef DISABLE_ASSEMBLY_REMAPPING
<span class="lineNum">    1065 </span><span class="lineCov">     287725 :         first = 0;</span>
<span class="lineNum">    1066 </span><span class="lineCov">     287725 :         last = G_N_ELEMENTS (framework_assemblies) - 1;</span>
<span class="lineNum">    1067 </span>            :         
<span class="lineNum">    1068 </span><span class="lineCov">    3892207 :         while (first &lt;= last) {</span>
<span class="lineNum">    1069 </span>            :                 int res;
<span class="lineNum">    1070 </span><span class="lineCov">    1783344 :                 pos = first + (last - first) / 2;</span>
<span class="lineNum">    1071 </span><span class="lineCov">    1783344 :                 res = strcmp (aname-&gt;name, framework_assemblies[pos].assembly_name);</span>
<span class="lineNum">    1072 </span><span class="lineCov">    1783344 :                 if (res == 0) {</span>
<span class="lineNum">    1073 </span>            :                         const AssemblyVersionSet* vset;
<span class="lineNum">    1074 </span><span class="lineCov">     124982 :                         int index = framework_assemblies[pos].version_set_index;</span>
<span class="lineNum">    1075 </span><span class="lineCov">     374943 :                         g_assert (index &lt; G_N_ELEMENTS (current_runtime-&gt;version_sets));</span>
<span class="lineNum">    1076 </span><span class="lineCov">     124979 :                         vset = &amp;current_runtime-&gt;version_sets [index];</span>
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineCov">     374286 :                         if (aname-&gt;major == vset-&gt;major &amp;&amp; aname-&gt;minor == vset-&gt;minor &amp;&amp;</span>
<span class="lineNum">    1079 </span><span class="lineCov">     249308 :                                 aname-&gt;build == vset-&gt;build &amp;&amp; aname-&gt;revision == vset-&gt;revision)</span>
<span class="lineNum">    1080 </span><span class="lineCov">     124654 :                                 return aname;</span>
<span class="lineNum">    1081 </span>            :                 
<span class="lineNum">    1082 </span><span class="lineCov">        342 :                         if (framework_assemblies[pos].only_lower_versions &amp;&amp; compare_versions ((AssemblyVersionSet*)vset, aname) &lt; 0)</span>
<span class="lineNum">    1083 </span><span class="lineCov">          8 :                                 return aname;</span>
<span class="lineNum">    1084 </span>            : 
<span class="lineNum">    1085 </span><span class="lineCov">        318 :                         if ((aname-&gt;major | aname-&gt;minor | aname-&gt;build | aname-&gt;revision) != 0)</span>
<span class="lineNum">    1086 </span><span class="lineCov">        265 :                                 mono_trace (G_LOG_LEVEL_WARNING, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1087 </span>            :                                         &quot;The request to load the assembly %s v%d.%d.%d.%d was remapped to v%d.%d.%d.%d&quot;,
<span class="lineNum">    1088 </span><span class="lineCov">        265 :                                                         aname-&gt;name,</span>
<span class="lineNum">    1089 </span><span class="lineCov">        265 :                                                         aname-&gt;major, aname-&gt;minor, aname-&gt;build, aname-&gt;revision,</span>
<span class="lineNum">    1090 </span><span class="lineCov">        265 :                                                         vset-&gt;major, vset-&gt;minor, vset-&gt;build, vset-&gt;revision</span>
<span class="lineNum">    1091 </span>            :                                                         );
<span class="lineNum">    1092 </span>            :                         
<span class="lineNum">    1093 </span><span class="lineCov">        318 :                         memcpy (dest_aname, aname, sizeof(MonoAssemblyName));</span>
<span class="lineNum">    1094 </span><span class="lineCov">        318 :                         dest_aname-&gt;major = vset-&gt;major;</span>
<span class="lineNum">    1095 </span><span class="lineCov">        318 :                         dest_aname-&gt;minor = vset-&gt;minor;</span>
<span class="lineNum">    1096 </span><span class="lineCov">        318 :                         dest_aname-&gt;build = vset-&gt;build;</span>
<span class="lineNum">    1097 </span><span class="lineCov">        318 :                         dest_aname-&gt;revision = vset-&gt;revision;</span>
<span class="lineNum">    1098 </span><span class="lineCov">        318 :                         if (framework_assemblies[pos].new_assembly_name != NULL) {</span>
<span class="lineNum">    1099 </span><span class="lineCov">          8 :                                 dest_aname-&gt;name = framework_assemblies[pos].new_assembly_name;</span>
<span class="lineNum">    1100 </span><span class="lineCov">          8 :                                 mono_trace (G_LOG_LEVEL_WARNING, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1101 </span>            :                                                         &quot;The assembly name %s was remapped to %s&quot;,
<span class="lineNum">    1102 </span><span class="lineCov">          8 :                                                         aname-&gt;name,</span>
<span class="lineNum">    1103 </span><span class="lineCov">          8 :                                                         dest_aname-&gt;name);</span>
<span class="lineNum">    1104 </span><span class="lineCov">          8 :                         }</span>
<span class="lineNum">    1105 </span><span class="lineCov">        318 :                         return dest_aname;</span>
<span class="lineNum">    1106 </span><span class="lineCov">    1658378 :                 } else if (res &lt; 0) {</span>
<span class="lineNum">    1107 </span><span class="lineCov">     427254 :                         last = pos - 1;</span>
<span class="lineNum">    1108 </span><span class="lineCov">     427254 :                 } else {</span>
<span class="lineNum">    1109 </span><span class="lineCov">    1231124 :                         first = pos + 1;</span>
<span class="lineNum">    1110 </span>            :                 }
<span class="lineNum">    1111 </span>            :         }
<span class="lineNum">    1112 </span>            : #endif
<span class="lineNum">    1113 </span>            : 
<span class="lineNum">    1114 </span><span class="lineCov">     162742 :         return aname;</span>
<span class="lineNum">    1115 </span><span class="lineCov">     287722 : }</span>
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span>            : /**
<span class="lineNum">    1118 </span>            :  * mono_assembly_get_assemblyref:
<span class="lineNum">    1119 </span>            :  * @image: pointer to the MonoImage to extract the information from.
<span class="lineNum">    1120 </span>            :  * @index: index to the assembly reference in the image.
<span class="lineNum">    1121 </span>            :  * @aname: pointer to a `MonoAssemblyName` that will hold the returned value.
<span class="lineNum">    1122 </span>            :  *
<span class="lineNum">    1123 </span>            :  * Fills out the @aname with the assembly name of the @index assembly reference in @image.
<a name="1124"><span class="lineNum">    1124 </span>            :  */</a>
<span class="lineNum">    1125 </span>            : void
<span class="lineNum">    1126 </span>            : mono_assembly_get_assemblyref (MonoImage *image, int index, MonoAssemblyName *aname)
<span class="lineNum">    1127 </span>            : {
<span class="lineNum">    1128 </span>            :         MonoTableInfo *t;
<span class="lineNum">    1129 </span>            :         guint32 cols [MONO_ASSEMBLYREF_SIZE];
<span class="lineNum">    1130 </span>            :         const char *hash;
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span><span class="lineCov">     116169 :         t = &amp;image-&gt;tables [MONO_TABLE_ASSEMBLYREF];</span>
<span class="lineNum">    1133 </span>            : 
<span class="lineNum">    1134 </span><span class="lineCov">     116169 :         mono_metadata_decode_row (t, index, cols, MONO_ASSEMBLYREF_SIZE);</span>
<span class="lineNum">    1135 </span>            :                 
<span class="lineNum">    1136 </span><span class="lineCov">     116169 :         hash = mono_metadata_blob_heap (image, cols [MONO_ASSEMBLYREF_HASH_VALUE]);</span>
<span class="lineNum">    1137 </span><span class="lineCov">     116169 :         aname-&gt;hash_len = mono_metadata_decode_blob_size (hash, &amp;hash);</span>
<span class="lineNum">    1138 </span><span class="lineCov">     116169 :         aname-&gt;hash_value = hash;</span>
<span class="lineNum">    1139 </span><span class="lineCov">     116169 :         aname-&gt;name = mono_metadata_string_heap (image, cols [MONO_ASSEMBLYREF_NAME]);</span>
<span class="lineNum">    1140 </span><span class="lineCov">     116169 :         aname-&gt;culture = mono_metadata_string_heap (image, cols [MONO_ASSEMBLYREF_CULTURE]);</span>
<span class="lineNum">    1141 </span><span class="lineCov">     116169 :         aname-&gt;flags = cols [MONO_ASSEMBLYREF_FLAGS];</span>
<span class="lineNum">    1142 </span><span class="lineCov">     116169 :         aname-&gt;major = cols [MONO_ASSEMBLYREF_MAJOR_VERSION];</span>
<span class="lineNum">    1143 </span><span class="lineCov">     116169 :         aname-&gt;minor = cols [MONO_ASSEMBLYREF_MINOR_VERSION];</span>
<span class="lineNum">    1144 </span><span class="lineCov">     116169 :         aname-&gt;build = cols [MONO_ASSEMBLYREF_BUILD_NUMBER];</span>
<span class="lineNum">    1145 </span><span class="lineCov">     116169 :         aname-&gt;revision = cols [MONO_ASSEMBLYREF_REV_NUMBER];</span>
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span><span class="lineCov">     116169 :         if (cols [MONO_ASSEMBLYREF_PUBLIC_KEY]) {</span>
<span class="lineNum">    1148 </span><span class="lineCov">     115925 :                 gchar *token = assemblyref_public_tok (image, cols [MONO_ASSEMBLYREF_PUBLIC_KEY], aname-&gt;flags);</span>
<span class="lineNum">    1149 </span><span class="lineCov">     115925 :                 g_strlcpy ((char*)aname-&gt;public_key_token, token, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    1150 </span><span class="lineCov">     115925 :                 g_free (token);</span>
<span class="lineNum">    1151 </span><span class="lineCov">     115925 :         } else {</span>
<span class="lineNum">    1152 </span><span class="lineCov">        244 :                 memset (aname-&gt;public_key_token, 0, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    1153 </span>            :         }
<span class="lineNum">    1154 </span><span class="lineCov">     116169 : }</span>
<a name="1155"><span class="lineNum">    1155 </span>            : </a>
<span class="lineNum">    1156 </span>            : void
<span class="lineNum">    1157 </span>            : mono_assembly_load_reference (MonoImage *image, int index)
<span class="lineNum">    1158 </span>            : {
<span class="lineNum">    1159 </span>            :         MonoAssembly *reference;
<span class="lineNum">    1160 </span>            :         MonoAssemblyName aname;
<span class="lineNum">    1161 </span>            :         MonoImageOpenStatus status;
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span>            :         /*
<span class="lineNum">    1164 </span>            :          * image-&gt;references is shared between threads, so we need to access
<span class="lineNum">    1165 </span>            :          * it inside a critical section.
<span class="lineNum">    1166 </span>            :          */
<span class="lineNum">    1167 </span><span class="lineCov">   15291743 :         mono_assemblies_lock ();</span>
<span class="lineNum">    1168 </span><span class="lineCov">   15291743 :         if (!image-&gt;references) {</span>
<span class="lineNum">    1169 </span><span class="lineCov">      40584 :                 MonoTableInfo *t = &amp;image-&gt;tables [MONO_TABLE_ASSEMBLYREF];</span>
<span class="lineNum">    1170 </span>            :         
<span class="lineNum">    1171 </span><span class="lineCov">      40584 :                 image-&gt;references = g_new0 (MonoAssembly *, t-&gt;rows + 1);</span>
<span class="lineNum">    1172 </span><span class="lineCov">      40584 :                 image-&gt;nreferences = t-&gt;rows;</span>
<span class="lineNum">    1173 </span><span class="lineCov">      40584 :         }</span>
<span class="lineNum">    1174 </span><span class="lineCov">   15291738 :         reference = image-&gt;references [index];</span>
<span class="lineNum">    1175 </span><span class="lineCov">   15291738 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    1176 </span><span class="lineCov">   15291738 :         if (reference)</span>
<span class="lineNum">    1177 </span><span class="lineCov">   15175618 :                 return;</span>
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineCov">     116124 :         mono_assembly_get_assemblyref (image, index, &amp;aname);</span>
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span><span class="lineCov">     232247 :         if (image-&gt;assembly &amp;&amp; image-&gt;assembly-&gt;ref_only) {</span>
<span class="lineNum">    1182 </span>            :                 /* We use the loaded corlib */
<span class="lineNum">    1183 </span><span class="lineCov">          4 :                 if (!strcmp (aname.name, &quot;mscorlib&quot;))</span>
<span class="lineNum">    1184 </span><span class="lineCov">          2 :                         reference = mono_assembly_load_full_internal (&amp;aname, image-&gt;assembly, image-&gt;assembly-&gt;basedir, &amp;status, FALSE);</span>
<span class="lineNum">    1185 </span>            :                 else {
<span class="lineNum">    1186 </span><span class="lineCov">          2 :                         reference = mono_assembly_loaded_full (&amp;aname, TRUE);</span>
<span class="lineNum">    1187 </span><span class="lineCov">          2 :                         if (!reference)</span>
<span class="lineNum">    1188 </span>            :                                 /* Try a postload search hook */
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :                                 reference = mono_assembly_invoke_search_hook_internal (&amp;aname, image-&gt;assembly, TRUE, TRUE);</span>
<span class="lineNum">    1190 </span>            :                 }
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span>            :                 /*
<span class="lineNum">    1193 </span>            :                  * Here we must advice that the error was due to
<span class="lineNum">    1194 </span>            :                  * a non loaded reference using the ReflectionOnly api
<span class="lineNum">    1195 </span>            :                 */
<span class="lineNum">    1196 </span><span class="lineCov">          4 :                 if (!reference)</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :                         reference = (MonoAssembly *)REFERENCE_MISSING;</span>
<span class="lineNum">    1198 </span><span class="lineCov">          4 :         } else {</span>
<span class="lineNum">    1199 </span>            :                 /* we first try without setting the basedir: this can eventually result in a ResolveAssembly
<span class="lineNum">    1200 </span>            :                  * event which is the MS .net compatible behaviour (the assemblyresolve_event3.cs test has been fixed
<span class="lineNum">    1201 </span>            :                  * accordingly, it would fail on the MS runtime before).
<span class="lineNum">    1202 </span>            :                  * The second load attempt has the basedir set to keep compatibility with the old mono behavior, for
<span class="lineNum">    1203 </span>            :                  * example bug-349190.2.cs and who knows how much more code in the wild.
<span class="lineNum">    1204 </span>            :                  */
<span class="lineNum">    1205 </span><span class="lineCov">     116120 :                 reference = mono_assembly_load_full_internal (&amp;aname, image-&gt;assembly, NULL, &amp;status, FALSE);</span>
<span class="lineNum">    1206 </span><span class="lineCov">     116137 :                 if (!reference &amp;&amp; image-&gt;assembly)</span>
<span class="lineNum">    1207 </span><span class="lineCov">         17 :                         reference = mono_assembly_load_full_internal (&amp;aname, image-&gt;assembly, image-&gt;assembly-&gt;basedir, &amp;status, FALSE);</span>
<span class="lineNum">    1208 </span>            :         }
<span class="lineNum">    1209 </span>            : 
<span class="lineNum">    1210 </span><span class="lineCov">     116124 :         if (reference == NULL){</span>
<span class="lineNum">    1211 </span>            :                 char *extra_msg;
<span class="lineNum">    1212 </span>            : 
<span class="lineNum">    1213 </span><span class="lineCov">         12 :                 if (status == MONO_IMAGE_ERROR_ERRNO &amp;&amp; errno == ENOENT) {</span>
<span class="lineNum">    1214 </span><span class="lineCov">         18 :                         extra_msg = g_strdup_printf (&quot;The assembly was not found in the Global Assembly Cache, a path listed in the MONO_PATH environment variable, or in the location of the executing assembly (%s).\n&quot;, image-&gt;assembly != NULL ? image-&gt;assembly-&gt;basedir : &quot;&quot; );</span>
<span class="lineNum">    1215 </span><span class="lineCov">          6 :                 } else if (status == MONO_IMAGE_ERROR_ERRNO) {</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                         extra_msg = g_strdup_printf (&quot;System error: %s\n&quot;, strerror (errno));</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                 } else if (status == MONO_IMAGE_MISSING_ASSEMBLYREF) {</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                         extra_msg = g_strdup (&quot;Cannot find an assembly referenced from this one.\n&quot;);</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                 } else if (status == MONO_IMAGE_IMAGE_INVALID) {</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                         extra_msg = g_strdup (&quot;The file exists but is not a valid assembly.\n&quot;);</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :                         extra_msg = g_strdup (&quot;&quot;);</span>
<span class="lineNum">    1223 </span>            :                 }
<span class="lineNum">    1224 </span>            :                 
<span class="lineNum">    1225 </span><span class="lineCov">          6 :                 mono_trace (G_LOG_LEVEL_WARNING, MONO_TRACE_ASSEMBLY, &quot;The following assembly referenced from %s could not be loaded:\n&quot;</span>
<span class="lineNum">    1226 </span>            :                                    &quot;     Assembly:   %s    (assemblyref_index=%d)\n&quot;
<span class="lineNum">    1227 </span>            :                                    &quot;     Version:    %d.%d.%d.%d\n&quot;
<span class="lineNum">    1228 </span>            :                                    &quot;     Public Key: %s\n%s&quot;,
<span class="lineNum">    1229 </span><span class="lineCov">          6 :                                    image-&gt;name, aname.name, index,</span>
<span class="lineNum">    1230 </span><span class="lineCov">          6 :                                    aname.major, aname.minor, aname.build, aname.revision,</span>
<span class="lineNum">    1231 </span><span class="lineCov">         18 :                                    strlen ((char*)aname.public_key_token) == 0 ? &quot;(none)&quot; : (char*)aname.public_key_token, extra_msg);</span>
<span class="lineNum">    1232 </span><span class="lineCov">          6 :                 g_free (extra_msg);</span>
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span><span class="lineCov">          6 :         }</span>
<span class="lineNum">    1235 </span>            : 
<span class="lineNum">    1236 </span><span class="lineCov">     116124 :         mono_assemblies_lock ();</span>
<span class="lineNum">    1237 </span><span class="lineCov">     116124 :         if (reference == NULL) {</span>
<span class="lineNum">    1238 </span>            :                 /* Flag as not found */
<span class="lineNum">    1239 </span><span class="lineCov">          6 :                 reference = (MonoAssembly *)REFERENCE_MISSING;</span>
<span class="lineNum">    1240 </span><span class="lineCov">          6 :         }       </span>
<span class="lineNum">    1241 </span>            : 
<span class="lineNum">    1242 </span><span class="lineCov">     116124 :         if (!image-&gt;references [index]) {</span>
<span class="lineNum">    1243 </span><span class="lineCov">     114039 :                 if (reference != REFERENCE_MISSING){</span>
<span class="lineNum">    1244 </span><span class="lineCov">     114033 :                         mono_assembly_addref (reference);</span>
<span class="lineNum">    1245 </span><span class="lineCov">     114033 :                         if (image-&gt;assembly)</span>
<span class="lineNum">    1246 </span><span class="lineCov">     114033 :                                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Assembly Ref addref %s[%p] -&gt; %s[%p]: %d&quot;,</span>
<span class="lineNum">    1247 </span><span class="lineCov">     114033 :                                     image-&gt;assembly-&gt;aname.name, image-&gt;assembly, reference-&gt;aname.name, reference, reference-&gt;ref_count);</span>
<span class="lineNum">    1248 </span><span class="lineCov">     114033 :                 } else {</span>
<span class="lineNum">    1249 </span><span class="lineCov">          6 :                         if (image-&gt;assembly)</span>
<span class="lineNum">    1250 </span><span class="lineCov">          6 :                                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Failed to load assembly %s[%p].&quot;,</span>
<span class="lineNum">    1251 </span><span class="lineCov">          6 :                                     image-&gt;assembly-&gt;aname.name, image-&gt;assembly);</span>
<span class="lineNum">    1252 </span>            :                 }
<span class="lineNum">    1253 </span>            :                 
<span class="lineNum">    1254 </span><span class="lineCov">     114039 :                 image-&gt;references [index] = reference;</span>
<span class="lineNum">    1255 </span><span class="lineCov">     114039 :         }</span>
<span class="lineNum">    1256 </span><span class="lineCov">     116123 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span><span class="lineCov">     116123 :         if (image-&gt;references [index] != reference) {</span>
<span class="lineNum">    1259 </span>            :                 /* Somebody loaded it before us */
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :                 mono_assembly_close (reference);</span>
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1262 </span><span class="lineCov">   15291727 : }</span>
<span class="lineNum">    1263 </span>            : 
<span class="lineNum">    1264 </span>            : /**
<span class="lineNum">    1265 </span>            :  * mono_assembly_load_references:
<span class="lineNum">    1266 </span>            :  * @image: 
<span class="lineNum">    1267 </span>            :  * @status:
<span class="lineNum">    1268 </span>            :  * @deprecated: There is no reason to use this method anymore, it does nothing
<span class="lineNum">    1269 </span>            :  *
<span class="lineNum">    1270 </span>            :  * This method is now a no-op, it does nothing other than setting the @status to #MONO_IMAGE_OK
<a name="1271"><span class="lineNum">    1271 </span>            :  */</a>
<span class="lineNum">    1272 </span>            : void
<span class="lineNum">    1273 </span>            : mono_assembly_load_references (MonoImage *image, MonoImageOpenStatus *status)
<span class="lineNum">    1274 </span>            : {
<span class="lineNum">    1275 </span>            :         /* This is a no-op now but it is part of the embedding API so we can't remove it */
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :         *status = MONO_IMAGE_OK;</span>
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1278 </span>            : 
<span class="lineNum">    1279 </span>            : typedef struct AssemblyLoadHook AssemblyLoadHook;
<span class="lineNum">    1280 </span>            : struct AssemblyLoadHook {
<span class="lineNum">    1281 </span>            :         AssemblyLoadHook *next;
<span class="lineNum">    1282 </span>            :         MonoAssemblyLoadFunc func;
<span class="lineNum">    1283 </span>            :         gpointer user_data;
<span class="lineNum">    1284 </span>            : };
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span>            : AssemblyLoadHook *assembly_load_hook = NULL;
<a name="1287"><span class="lineNum">    1287 </span>            : </a>
<span class="lineNum">    1288 </span>            : void
<span class="lineNum">    1289 </span>            : mono_assembly_invoke_load_hook (MonoAssembly *ass)
<span class="lineNum">    1290 </span>            : {
<span class="lineNum">    1291 </span>            :         AssemblyLoadHook *hook;
<span class="lineNum">    1292 </span>            : 
<span class="lineNum">    1293 </span><span class="lineCov">     430068 :         for (hook = assembly_load_hook; hook; hook = hook-&gt;next) {</span>
<span class="lineNum">    1294 </span><span class="lineCov">     141793 :                 hook-&gt;func (ass, hook-&gt;user_data);</span>
<span class="lineNum">    1295 </span><span class="lineCov">     141793 :         }</span>
<span class="lineNum">    1296 </span><span class="lineCov">      73241 : }</span>
<a name="1297"><span class="lineNum">    1297 </span>            : </a>
<span class="lineNum">    1298 </span>            : void
<span class="lineNum">    1299 </span>            : mono_install_assembly_load_hook (MonoAssemblyLoadFunc func, gpointer user_data)
<span class="lineNum">    1300 </span>            : {
<span class="lineNum">    1301 </span>            :         AssemblyLoadHook *hook;
<span class="lineNum">    1302 </span>            :         
<span class="lineNum">    1303 </span><span class="lineCov">      19737 :         g_return_if_fail (func != NULL);</span>
<span class="lineNum">    1304 </span>            : 
<span class="lineNum">    1305 </span><span class="lineCov">       6579 :         hook = g_new0 (AssemblyLoadHook, 1);</span>
<span class="lineNum">    1306 </span><span class="lineCov">       6579 :         hook-&gt;func = func;</span>
<span class="lineNum">    1307 </span><span class="lineCov">       6579 :         hook-&gt;user_data = user_data;</span>
<span class="lineNum">    1308 </span><span class="lineCov">       6579 :         hook-&gt;next = assembly_load_hook;</span>
<span class="lineNum">    1309 </span><span class="lineCov">       6579 :         assembly_load_hook = hook;</span>
<span class="lineNum">    1310 </span><span class="lineCov">      13158 : }</span>
<a name="1311"><span class="lineNum">    1311 </span>            : </a>
<span class="lineNum">    1312 </span>            : static void
<span class="lineNum">    1313 </span>            : free_assembly_load_hooks (void)
<span class="lineNum">    1314 </span>            : {
<span class="lineNum">    1315 </span>            :         AssemblyLoadHook *hook, *next;
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span><span class="lineCov">      19650 :         for (hook = assembly_load_hook; hook; hook = next) {</span>
<span class="lineNum">    1318 </span><span class="lineCov">       6553 :                 next = hook-&gt;next;</span>
<span class="lineNum">    1319 </span><span class="lineCov">       6553 :                 g_free (hook);</span>
<span class="lineNum">    1320 </span><span class="lineCov">       6553 :         }</span>
<span class="lineNum">    1321 </span><span class="lineCov">       3272 : }</span>
<span class="lineNum">    1322 </span>            : 
<span class="lineNum">    1323 </span>            : typedef struct AssemblySearchHook AssemblySearchHook;
<span class="lineNum">    1324 </span>            : struct AssemblySearchHook {
<span class="lineNum">    1325 </span>            :         AssemblySearchHook *next;
<span class="lineNum">    1326 </span>            :         MonoAssemblySearchFunc func;
<span class="lineNum">    1327 </span>            :         gboolean refonly;
<span class="lineNum">    1328 </span>            :         gboolean postload;
<span class="lineNum">    1329 </span>            :         gpointer user_data;
<span class="lineNum">    1330 </span>            : };
<span class="lineNum">    1331 </span>            : 
<span class="lineNum">    1332 </span>            : AssemblySearchHook *assembly_search_hook = NULL;
<a name="1333"><span class="lineNum">    1333 </span>            : </a>
<span class="lineNum">    1334 </span>            : static MonoAssembly*
<span class="lineNum">    1335 </span>            : mono_assembly_invoke_search_hook_internal (MonoAssemblyName *aname, MonoAssembly *requesting, gboolean refonly, gboolean postload)
<span class="lineNum">    1336 </span>            : {
<span class="lineNum">    1337 </span>            :         AssemblySearchHook *hook;
<span class="lineNum">    1338 </span>            : 
<span class="lineNum">    1339 </span><span class="lineCov">    1689524 :         for (hook = assembly_search_hook; hook; hook = hook-&gt;next) {</span>
<span class="lineNum">    1340 </span><span class="lineCov">    1105889 :                 if ((hook-&gt;refonly == refonly) &amp;&amp; (hook-&gt;postload == postload)) {</span>
<span class="lineNum">    1341 </span>            :                         MonoAssembly *ass;
<span class="lineNum">    1342 </span>            :                         /**
<span class="lineNum">    1343 </span>            :                           * A little explanation is in order here.
<span class="lineNum">    1344 </span>            :                           *
<span class="lineNum">    1345 </span>            :                           * The default postload search hook needs to know the requesting assembly to report it to managed code.
<span class="lineNum">    1346 </span>            :                           * The embedding API exposes a search hook that doesn't take such argument.
<span class="lineNum">    1347 </span>            :                           *
<span class="lineNum">    1348 </span>            :                           * The original fix would call the default search hook before all the registered ones and pass
<span class="lineNum">    1349 </span>            :                           * the requesting assembly to it. It works but broke a very suddle embedding API aspect that some users
<span class="lineNum">    1350 </span>            :                           * rely on. Which is the ordering between user hooks and the default runtime hook.
<span class="lineNum">    1351 </span>            :                           *
<span class="lineNum">    1352 </span>            :                           * Registering the hook after mono_jit_init would let your hook run before the default one and
<span class="lineNum">    1353 </span>            :                           * when using it to handle non standard app layouts this could save your app from a massive amount
<span class="lineNum">    1354 </span>            :                           * of syscalls that the default hook does when probing all sorts of places. Slow targets with horrible IO
<span class="lineNum">    1355 </span>            :                           * are all using this trick and if we broke this assumption they would be very disapointed at us.
<span class="lineNum">    1356 </span>            :                           *
<span class="lineNum">    1357 </span>            :                           * So what's the fix? We register the default hook using regular means and special case it when iterating
<span class="lineNum">    1358 </span>            :                           * over the registered hooks. This preserves ordering and enables managed resolve hooks to get the requesting
<span class="lineNum">    1359 </span>            :                           * assembly.
<span class="lineNum">    1360 </span>            :                           */
<span class="lineNum">    1361 </span><span class="lineCov">     184321 :                         if (hook-&gt;func == (void*)mono_domain_assembly_postload_search)</span>
<span class="lineNum">    1362 </span><span class="lineCov">         39 :                                 ass = mono_domain_assembly_postload_search (aname, requesting, refonly);</span>
<span class="lineNum">    1363 </span>            :                         else
<span class="lineNum">    1364 </span><span class="lineCov">     184283 :                                 ass = hook-&gt;func (aname, hook-&gt;user_data);</span>
<span class="lineNum">    1365 </span><span class="lineCov">     184323 :                         if (ass)</span>
<span class="lineNum">    1366 </span><span class="lineCov">      81756 :                                 return ass;</span>
<span class="lineNum">    1367 </span><span class="lineCov">     102567 :                 }</span>
<span class="lineNum">    1368 </span><span class="lineCov">     655503 :         }</span>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span><span class="lineCov">     107507 :         return NULL;</span>
<span class="lineNum">    1371 </span><span class="lineCov">     189263 : }</span>
<a name="1372"><span class="lineNum">    1372 </span>            : </a>
<span class="lineNum">    1373 </span>            : MonoAssembly*
<span class="lineNum">    1374 </span>            : mono_assembly_invoke_search_hook (MonoAssemblyName *aname)
<span class="lineNum">    1375 </span>            : {
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :         return mono_assembly_invoke_search_hook_internal (aname, NULL, FALSE, FALSE);</span>
<span class="lineNum">    1377 </span>            : }
<a name="1378"><span class="lineNum">    1378 </span>            : </a>
<span class="lineNum">    1379 </span>            : static void
<span class="lineNum">    1380 </span>            : mono_install_assembly_search_hook_internal (MonoAssemblySearchFunc func, gpointer user_data, gboolean refonly, gboolean postload)
<span class="lineNum">    1381 </span>            : {
<span class="lineNum">    1382 </span>            :         AssemblySearchHook *hook;
<span class="lineNum">    1383 </span>            :         
<span class="lineNum">    1384 </span><span class="lineCov">      39420 :         g_return_if_fail (func != NULL);</span>
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span><span class="lineCov">      13140 :         hook = g_new0 (AssemblySearchHook, 1);</span>
<span class="lineNum">    1387 </span><span class="lineCov">      13140 :         hook-&gt;func = func;</span>
<span class="lineNum">    1388 </span><span class="lineCov">      13140 :         hook-&gt;user_data = user_data;</span>
<span class="lineNum">    1389 </span><span class="lineCov">      13140 :         hook-&gt;refonly = refonly;</span>
<span class="lineNum">    1390 </span><span class="lineCov">      13140 :         hook-&gt;postload = postload;</span>
<span class="lineNum">    1391 </span><span class="lineCov">      13140 :         hook-&gt;next = assembly_search_hook;</span>
<span class="lineNum">    1392 </span><span class="lineCov">      13140 :         assembly_search_hook = hook;</span>
<span class="lineNum">    1393 </span><span class="lineCov">      26280 : }</span>
<a name="1394"><span class="lineNum">    1394 </span>            : </a>
<span class="lineNum">    1395 </span>            : void          
<span class="lineNum">    1396 </span>            : mono_install_assembly_search_hook (MonoAssemblySearchFunc func, gpointer user_data)
<span class="lineNum">    1397 </span>            : {
<span class="lineNum">    1398 </span><span class="lineCov">       3285 :         mono_install_assembly_search_hook_internal (func, user_data, FALSE, FALSE);</span>
<span class="lineNum">    1399 </span><span class="lineCov">       3285 : }       </span>
<a name="1400"><span class="lineNum">    1400 </span>            : </a>
<span class="lineNum">    1401 </span>            : static void
<span class="lineNum">    1402 </span>            : free_assembly_search_hooks (void)
<span class="lineNum">    1403 </span>            : {
<span class="lineNum">    1404 </span>            :         AssemblySearchHook *hook, *next;
<span class="lineNum">    1405 </span>            : 
<span class="lineNum">    1406 </span><span class="lineCov">      32720 :         for (hook = assembly_search_hook; hook; hook = next) {</span>
<span class="lineNum">    1407 </span><span class="lineCov">      13088 :                 next = hook-&gt;next;</span>
<span class="lineNum">    1408 </span><span class="lineCov">      13088 :                 g_free (hook);</span>
<span class="lineNum">    1409 </span><span class="lineCov">      13088 :         }</span>
<span class="lineNum">    1410 </span><span class="lineCov">       3272 : }</span>
<a name="1411"><span class="lineNum">    1411 </span>            : </a>
<span class="lineNum">    1412 </span>            : void
<span class="lineNum">    1413 </span>            : mono_install_assembly_refonly_search_hook (MonoAssemblySearchFunc func, gpointer user_data)
<span class="lineNum">    1414 </span>            : {
<span class="lineNum">    1415 </span><span class="lineCov">       3285 :         mono_install_assembly_search_hook_internal (func, user_data, TRUE, FALSE);</span>
<span class="lineNum">    1416 </span><span class="lineCov">       3285 : }</span>
<a name="1417"><span class="lineNum">    1417 </span>            : </a>
<span class="lineNum">    1418 </span>            : void          
<span class="lineNum">    1419 </span>            : mono_install_assembly_postload_search_hook (MonoAssemblySearchFunc func, gpointer user_data)
<span class="lineNum">    1420 </span>            : {
<span class="lineNum">    1421 </span><span class="lineCov">       3285 :         mono_install_assembly_search_hook_internal (func, user_data, FALSE, TRUE);</span>
<span class="lineNum">    1422 </span><span class="lineCov">       3285 : }       </span>
<a name="1423"><span class="lineNum">    1423 </span>            : </a>
<span class="lineNum">    1424 </span>            : void
<span class="lineNum">    1425 </span>            : mono_install_assembly_postload_refonly_search_hook (MonoAssemblySearchFunc func, gpointer user_data)
<span class="lineNum">    1426 </span>            : {
<span class="lineNum">    1427 </span><span class="lineCov">       3285 :         mono_install_assembly_search_hook_internal (func, user_data, TRUE, TRUE);</span>
<span class="lineNum">    1428 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">    1429 </span>            : 
<span class="lineNum">    1430 </span>            : typedef struct AssemblyPreLoadHook AssemblyPreLoadHook;
<span class="lineNum">    1431 </span>            : struct AssemblyPreLoadHook {
<span class="lineNum">    1432 </span>            :         AssemblyPreLoadHook *next;
<span class="lineNum">    1433 </span>            :         MonoAssemblyPreLoadFunc func;
<span class="lineNum">    1434 </span>            :         gpointer user_data;
<span class="lineNum">    1435 </span>            : };
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span>            : static AssemblyPreLoadHook *assembly_preload_hook = NULL;
<span class="lineNum">    1438 </span>            : static AssemblyPreLoadHook *assembly_refonly_preload_hook = NULL;
<a name="1439"><span class="lineNum">    1439 </span>            : </a>
<span class="lineNum">    1440 </span>            : static MonoAssembly *
<span class="lineNum">    1441 </span>            : invoke_assembly_preload_hook (MonoAssemblyName *aname, gchar **assemblies_path)
<span class="lineNum">    1442 </span>            : {
<span class="lineNum">    1443 </span>            :         AssemblyPreLoadHook *hook;
<span class="lineNum">    1444 </span>            :         MonoAssembly *assembly;
<span class="lineNum">    1445 </span>            : 
<span class="lineNum">    1446 </span><span class="lineCov">     233024 :         for (hook = assembly_preload_hook; hook; hook = hook-&gt;next) {</span>
<span class="lineNum">    1447 </span><span class="lineCov">      61871 :                 assembly = hook-&gt;func (aname, assemblies_path, hook-&gt;user_data);</span>
<span class="lineNum">    1448 </span><span class="lineCov">      61871 :                 if (assembly != NULL)</span>
<span class="lineNum">    1449 </span><span class="lineCov">      13827 :                         return assembly;</span>
<span class="lineNum">    1450 </span><span class="lineCov">      48044 :         }</span>
<span class="lineNum">    1451 </span>            : 
<span class="lineNum">    1452 </span><span class="lineCov">      54640 :         return NULL;</span>
<span class="lineNum">    1453 </span><span class="lineCov">      68467 : }</span>
<a name="1454"><span class="lineNum">    1454 </span>            : </a>
<span class="lineNum">    1455 </span>            : static MonoAssembly *
<span class="lineNum">    1456 </span>            : invoke_assembly_refonly_preload_hook (MonoAssemblyName *aname, gchar **assemblies_path)
<span class="lineNum">    1457 </span>            : {
<span class="lineNum">    1458 </span>            :         AssemblyPreLoadHook *hook;
<span class="lineNum">    1459 </span>            :         MonoAssembly *assembly;
<span class="lineNum">    1460 </span>            : 
<span class="lineNum">    1461 </span><span class="lineCov">         40 :         for (hook = assembly_refonly_preload_hook; hook; hook = hook-&gt;next) {</span>
<span class="lineNum">    1462 </span><span class="lineCov">         18 :                 assembly = hook-&gt;func (aname, assemblies_path, hook-&gt;user_data);</span>
<span class="lineNum">    1463 </span><span class="lineCov">         18 :                 if (assembly != NULL)</span>
<span class="lineNum">    1464 </span><span class="lineCov">         16 :                         return assembly;</span>
<span class="lineNum">    1465 </span><span class="lineCov">          2 :         }</span>
<span class="lineNum">    1466 </span>            : 
<span class="lineNum">    1467 </span><span class="lineCov">          2 :         return NULL;</span>
<span class="lineNum">    1468 </span><span class="lineCov">         18 : }</span>
<a name="1469"><span class="lineNum">    1469 </span>            : </a>
<span class="lineNum">    1470 </span>            : void
<span class="lineNum">    1471 </span>            : mono_install_assembly_preload_hook (MonoAssemblyPreLoadFunc func, gpointer user_data)
<span class="lineNum">    1472 </span>            : {
<span class="lineNum">    1473 </span>            :         AssemblyPreLoadHook *hook;
<span class="lineNum">    1474 </span>            :         
<span class="lineNum">    1475 </span><span class="lineCov">       9855 :         g_return_if_fail (func != NULL);</span>
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span><span class="lineCov">       3285 :         hook = g_new0 (AssemblyPreLoadHook, 1);</span>
<span class="lineNum">    1478 </span><span class="lineCov">       3285 :         hook-&gt;func = func;</span>
<span class="lineNum">    1479 </span><span class="lineCov">       3285 :         hook-&gt;user_data = user_data;</span>
<span class="lineNum">    1480 </span><span class="lineCov">       3285 :         hook-&gt;next = assembly_preload_hook;</span>
<span class="lineNum">    1481 </span><span class="lineCov">       3285 :         assembly_preload_hook = hook;</span>
<span class="lineNum">    1482 </span><span class="lineCov">       6570 : }</span>
<a name="1483"><span class="lineNum">    1483 </span>            : </a>
<span class="lineNum">    1484 </span>            : void
<span class="lineNum">    1485 </span>            : mono_install_assembly_refonly_preload_hook (MonoAssemblyPreLoadFunc func, gpointer user_data)
<span class="lineNum">    1486 </span>            : {
<span class="lineNum">    1487 </span>            :         AssemblyPreLoadHook *hook;
<span class="lineNum">    1488 </span>            :         
<span class="lineNum">    1489 </span><span class="lineCov">       9855 :         g_return_if_fail (func != NULL);</span>
<span class="lineNum">    1490 </span>            : 
<span class="lineNum">    1491 </span><span class="lineCov">       3285 :         hook = g_new0 (AssemblyPreLoadHook, 1);</span>
<span class="lineNum">    1492 </span><span class="lineCov">       3285 :         hook-&gt;func = func;</span>
<span class="lineNum">    1493 </span><span class="lineCov">       3285 :         hook-&gt;user_data = user_data;</span>
<span class="lineNum">    1494 </span><span class="lineCov">       3285 :         hook-&gt;next = assembly_refonly_preload_hook;</span>
<span class="lineNum">    1495 </span><span class="lineCov">       3285 :         assembly_refonly_preload_hook = hook;</span>
<span class="lineNum">    1496 </span><span class="lineCov">       6570 : }</span>
<a name="1497"><span class="lineNum">    1497 </span>            : </a>
<span class="lineNum">    1498 </span>            : static void
<span class="lineNum">    1499 </span>            : free_assembly_preload_hooks (void)
<span class="lineNum">    1500 </span>            : {
<span class="lineNum">    1501 </span>            :         AssemblyPreLoadHook *hook, *next;
<span class="lineNum">    1502 </span>            : 
<span class="lineNum">    1503 </span><span class="lineCov">      13088 :         for (hook = assembly_preload_hook; hook; hook = next) {</span>
<span class="lineNum">    1504 </span><span class="lineCov">       3272 :                 next = hook-&gt;next;</span>
<span class="lineNum">    1505 </span><span class="lineCov">       3272 :                 g_free (hook);</span>
<span class="lineNum">    1506 </span><span class="lineCov">       3272 :         }</span>
<span class="lineNum">    1507 </span>            : 
<span class="lineNum">    1508 </span><span class="lineCov">      13088 :         for (hook = assembly_refonly_preload_hook; hook; hook = next) {</span>
<span class="lineNum">    1509 </span><span class="lineCov">       3272 :                 next = hook-&gt;next;</span>
<span class="lineNum">    1510 </span><span class="lineCov">       3272 :                 g_free (hook);</span>
<span class="lineNum">    1511 </span><span class="lineCov">       3272 :         }</span>
<span class="lineNum">    1512 </span><span class="lineCov">       3272 : }</span>
<a name="1513"><span class="lineNum">    1513 </span>            : </a>
<span class="lineNum">    1514 </span>            : static gchar *
<span class="lineNum">    1515 </span>            : absolute_dir (const gchar *filename)
<span class="lineNum">    1516 </span>            : {
<span class="lineNum">    1517 </span>            :         gchar *cwd;
<span class="lineNum">    1518 </span>            :         gchar *mixed;
<span class="lineNum">    1519 </span>            :         gchar **parts;
<span class="lineNum">    1520 </span>            :         gchar *part;
<span class="lineNum">    1521 </span>            :         GList *list, *tmp;
<span class="lineNum">    1522 </span>            :         GString *result;
<span class="lineNum">    1523 </span>            :         gchar *res;
<span class="lineNum">    1524 </span>            :         gint i;
<span class="lineNum">    1525 </span>            : 
<span class="lineNum">    1526 </span><span class="lineCov">      43933 :         if (g_path_is_absolute (filename)) {</span>
<span class="lineNum">    1527 </span><span class="lineCov">      41825 :                 part = g_path_get_dirname (filename);</span>
<span class="lineNum">    1528 </span><span class="lineCov">      41825 :                 res = g_strconcat (part, G_DIR_SEPARATOR_S, NULL);</span>
<span class="lineNum">    1529 </span><span class="lineCov">      41825 :                 g_free (part);</span>
<span class="lineNum">    1530 </span><span class="lineCov">      41825 :                 return res;</span>
<span class="lineNum">    1531 </span>            :         }
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span><span class="lineCov">       2108 :         cwd = g_get_current_dir ();</span>
<span class="lineNum">    1534 </span><span class="lineCov">       2108 :         mixed = g_build_filename (cwd, filename, NULL);</span>
<span class="lineNum">    1535 </span><span class="lineCov">       2108 :         parts = g_strsplit (mixed, G_DIR_SEPARATOR_S, 0);</span>
<span class="lineNum">    1536 </span><span class="lineCov">       2108 :         g_free (mixed);</span>
<span class="lineNum">    1537 </span><span class="lineCov">       2108 :         g_free (cwd);</span>
<span class="lineNum">    1538 </span>            : 
<span class="lineNum">    1539 </span><span class="lineCov">       2108 :         list = NULL;</span>
<span class="lineNum">    1540 </span><span class="lineCov">      45880 :         for (i = 0; (part = parts [i]) != NULL; i++) {</span>
<span class="lineNum">    1541 </span><span class="lineCov">      20832 :                 if (!strcmp (part, &quot;.&quot;))</span>
<span class="lineNum">    1542 </span><span class="lineCov">        530 :                         continue;</span>
<span class="lineNum">    1543 </span>            : 
<span class="lineNum">    1544 </span><span class="lineCov">      20302 :                 if (!strcmp (part, &quot;..&quot;)) {</span>
<span class="lineNum">    1545 </span><span class="lineCov">       2410 :                         if (list &amp;&amp; list-&gt;next) /* Don't remove root */</span>
<span class="lineNum">    1546 </span><span class="lineCov">       1205 :                                 list = g_list_delete_link (list, list);</span>
<span class="lineNum">    1547 </span><span class="lineCov">       1205 :                 } else {</span>
<span class="lineNum">    1548 </span><span class="lineCov">      19097 :                         list = g_list_prepend (list, part);</span>
<span class="lineNum">    1549 </span>            :                 }
<span class="lineNum">    1550 </span><span class="lineCov">      20302 :         }</span>
<span class="lineNum">    1551 </span>            : 
<span class="lineNum">    1552 </span><span class="lineCov">       2108 :         result = g_string_new (&quot;&quot;);</span>
<span class="lineNum">    1553 </span><span class="lineCov">       2108 :         list = g_list_reverse (list);</span>
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            :         /* Ignores last data pointer, which should be the filename */
<span class="lineNum">    1556 </span><span class="lineCov">      71568 :         for (tmp = list; tmp &amp;&amp; tmp-&gt;next != NULL; tmp = tmp-&gt;next){</span>
<span class="lineNum">    1557 </span><span class="lineCov">      15784 :                 if (tmp-&gt;data)</span>
<span class="lineNum">    1558 </span><span class="lineCov">      15784 :                         g_string_append_printf (result, &quot;%s%c&quot;, (char *) tmp-&gt;data,</span>
<span class="lineNum">    1559 </span>            :                                                                 G_DIR_SEPARATOR);
<span class="lineNum">    1560 </span><span class="lineCov">      15784 :         }</span>
<span class="lineNum">    1561 </span>            : 
<span class="lineNum">    1562 </span><span class="lineCov">       2108 :         res = result-&gt;str;</span>
<span class="lineNum">    1563 </span><span class="lineCov">       2108 :         g_string_free (result, FALSE);</span>
<span class="lineNum">    1564 </span><span class="lineCov">       2108 :         g_list_free (list);</span>
<span class="lineNum">    1565 </span><span class="lineCov">       2108 :         g_strfreev (parts);</span>
<span class="lineNum">    1566 </span><span class="lineCov">       2108 :         if (*res == '\0') {</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                 g_free (res);</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :                 return g_strdup (&quot;.&quot;);</span>
<span class="lineNum">    1569 </span>            :         }
<span class="lineNum">    1570 </span>            : 
<span class="lineNum">    1571 </span><span class="lineCov">       2108 :         return res;</span>
<span class="lineNum">    1572 </span><span class="lineCov">      43933 : }</span>
<span class="lineNum">    1573 </span>            : 
<span class="lineNum">    1574 </span>            : /** 
<span class="lineNum">    1575 </span>            :  * mono_assembly_open_from_bundle:
<span class="lineNum">    1576 </span>            :  * @filename: Filename requested
<span class="lineNum">    1577 </span>            :  * @status: return status code
<span class="lineNum">    1578 </span>            :  *
<span class="lineNum">    1579 </span>            :  * This routine tries to open the assembly specified by `filename' from the
<span class="lineNum">    1580 </span>            :  * defined bundles, if found, returns the MonoImage for it, if not found
<span class="lineNum">    1581 </span>            :  * returns NULL
<a name="1582"><span class="lineNum">    1582 </span>            :  */</a>
<span class="lineNum">    1583 </span>            : MonoImage *
<span class="lineNum">    1584 </span>            : mono_assembly_open_from_bundle (const char *filename, MonoImageOpenStatus *status, gboolean refonly)
<span class="lineNum">    1585 </span>            : {
<span class="lineNum">    1586 </span>            :         int i;
<span class="lineNum">    1587 </span>            :         char *name;
<span class="lineNum">    1588 </span>            :         gchar *lowercase_filename;
<span class="lineNum">    1589 </span><span class="lineCov">       3285 :         MonoImage *image = NULL;</span>
<span class="lineNum">    1590 </span><span class="lineCov">       3285 :         gboolean is_satellite = FALSE;</span>
<span class="lineNum">    1591 </span>            :         /*
<span class="lineNum">    1592 </span>            :          * we do a very simple search for bundled assemblies: it's not a general 
<span class="lineNum">    1593 </span>            :          * purpose assembly loading mechanism.
<span class="lineNum">    1594 </span>            :          */
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span><span class="lineCov">       3285 :         if (!bundles)</span>
<span class="lineNum">    1597 </span><span class="lineCov">       3285 :                 return NULL;</span>
<span class="lineNum">    1598 </span>            : 
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :         lowercase_filename = g_utf8_strdown (filename, -1);</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :         is_satellite = g_str_has_suffix (lowercase_filename, &quot;.resources.dll&quot;);</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :         g_free (lowercase_filename);</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :         name = g_path_get_basename (filename);</span>
<span class="lineNum">    1603 </span><span class="lineNoCov">          0 :         mono_assemblies_lock ();</span>
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :         for (i = 0; !image &amp;&amp; bundles [i]; ++i) {</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :                 if (strcmp (bundles [i]-&gt;name, is_satellite ? filename : name) == 0) {</span>
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :                         image = mono_image_open_from_data_with_name ((char*)bundles [i]-&gt;data, bundles [i]-&gt;size, FALSE, status, refonly, name);</span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1608 </span>            :                 }
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :         if (image) {</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :                 mono_image_addref (image);</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Assembly Loader loaded assembly from bundle: '%s'.&quot;, is_satellite ? filename : name);</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :                 g_free (name);</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :                 return image;</span>
<span class="lineNum">    1616 </span>            :         }
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :         g_free (name);</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1619 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span>            : /**
<span class="lineNum">    1622 </span>            :  * mono_assemblies_open_full:
<span class="lineNum">    1623 </span>            :  * @filename: the file to load
<span class="lineNum">    1624 </span>            :  * @status: return status code 
<span class="lineNum">    1625 </span>            :  * @refonly: Whether this assembly is being opened in &quot;reflection-only&quot; mode.
<span class="lineNum">    1626 </span>            : * 
<span class="lineNum">    1627 </span>            :  * This loads an assembly from the specified @filename.   The @filename allows
<span class="lineNum">    1628 </span>            :  * a local URL (starting with a file:// prefix).  If a file prefix is used, the
<span class="lineNum">    1629 </span>            :  * filename is interpreted as a URL, and the filename is URL-decoded.   Otherwise the file
<span class="lineNum">    1630 </span>            :  * is treated as a local path.
<span class="lineNum">    1631 </span>            :  *
<span class="lineNum">    1632 </span>            :  * First, an attempt is made to load the assembly from the bundled executable (for those
<span class="lineNum">    1633 </span>            :  * deployments that have been done with the `mkbundle` tool or for scenarios where the
<span class="lineNum">    1634 </span>            :  * assembly has been registered as an embedded assembly).   If this is not the case, then
<span class="lineNum">    1635 </span>            :  * the assembly is loaded from disk using `api:mono_image_open_full`.
<span class="lineNum">    1636 </span>            :  *
<span class="lineNum">    1637 </span>            :  * If the pointed assembly does not live in the Global Assembly Cache, a shadow copy of
<span class="lineNum">    1638 </span>            :  * the assembly is made.
<span class="lineNum">    1639 </span>            :  *
<span class="lineNum">    1640 </span>            :  * If @refonly is set to true, then the assembly is loaded purely for inspection with
<span class="lineNum">    1641 </span>            :  * the `System.Reflection` API.
<span class="lineNum">    1642 </span>            :  *
<span class="lineNum">    1643 </span>            :  * Returns: NULL on error, with the @status set to an error code, or a pointer
<span class="lineNum">    1644 </span>            :  * to the assembly.
<a name="1645"><span class="lineNum">    1645 </span>            :  */</a>
<span class="lineNum">    1646 </span>            : MonoAssembly *
<span class="lineNum">    1647 </span>            : mono_assembly_open_full (const char *filename, MonoImageOpenStatus *status, gboolean refonly)
<span class="lineNum">    1648 </span>            : {
<span class="lineNum">    1649 </span>            :         MonoImage *image;
<span class="lineNum">    1650 </span>            :         MonoAssembly *ass;
<span class="lineNum">    1651 </span>            :         MonoImageOpenStatus def_status;
<span class="lineNum">    1652 </span>            :         gchar *fname;
<span class="lineNum">    1653 </span>            :         gchar *new_fname;
<span class="lineNum">    1654 </span>            :         gboolean loaded_from_bundle;
<span class="lineNum">    1655 </span>            :         
<span class="lineNum">    1656 </span><span class="lineCov">     510380 :         g_return_val_if_fail (filename != NULL, NULL);</span>
<span class="lineNum">    1657 </span>            : 
<span class="lineNum">    1658 </span><span class="lineCov">     170128 :         if (!status)</span>
<span class="lineNum">    1659 </span><span class="lineCov">      24202 :                 status = &amp;def_status;</span>
<span class="lineNum">    1660 </span><span class="lineCov">     170121 :         *status = MONO_IMAGE_OK;</span>
<span class="lineNum">    1661 </span>            : 
<span class="lineNum">    1662 </span><span class="lineCov">     170121 :         if (strncmp (filename, &quot;file://&quot;, 7) == 0) {</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :                 GError *error = NULL;</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :                 gchar *uri = (gchar *) filename;</span>
<span class="lineNum">    1665 </span>            :                 gchar *tmpuri;
<span class="lineNum">    1666 </span>            : 
<span class="lineNum">    1667 </span>            :                 /*
<span class="lineNum">    1668 </span>            :                  * MS allows file://c:/... and fails on file://localhost/c:/... 
<span class="lineNum">    1669 </span>            :                  * They also throw an IndexOutOfRangeException if &quot;file://&quot;
<span class="lineNum">    1670 </span>            :                  */
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :                 if (uri [7] != '/')</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :                         uri = g_strdup_printf (&quot;file:///%s&quot;, uri + 7);</span>
<span class="lineNum">    1673 </span>            :         
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :                 tmpuri = uri;</span>
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :                 uri = mono_escape_uri_string (tmpuri);</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 :                 fname = g_filename_from_uri (uri, NULL, &amp;error);</span>
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :                 g_free (uri);</span>
<span class="lineNum">    1678 </span>            : 
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :                 if (tmpuri != filename)</span>
<span class="lineNum">    1680 </span><span class="lineNoCov">          0 :                         g_free (tmpuri);</span>
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :                 if (error != NULL) {</span>
<span class="lineNum">    1683 </span><span class="lineNoCov">          0 :                         g_warning (&quot;%s\n&quot;, error-&gt;message);</span>
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :                         g_error_free (error);</span>
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :                         fname = g_strdup (filename);</span>
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1688 </span><span class="lineCov">     170119 :                 fname = g_strdup (filename);</span>
<span class="lineNum">    1689 </span>            :         }
<span class="lineNum">    1690 </span>            : 
<span class="lineNum">    1691 </span><span class="lineCov">     170119 :         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1692 </span><span class="lineCov">     170119 :                         &quot;Assembly Loader probing location: '%s'.&quot;, fname);</span>
<span class="lineNum">    1693 </span>            : 
<span class="lineNum">    1694 </span><span class="lineCov">     170119 :         new_fname = NULL;</span>
<span class="lineNum">    1695 </span><span class="lineCov">     170119 :         if (!mono_assembly_is_in_gac (fname)) {</span>
<span class="lineNum">    1696 </span>            :                 MonoError error;
<span class="lineNum">    1697 </span><span class="lineCov">     122810 :                 new_fname = mono_make_shadow_copy (fname, &amp;error);</span>
<span class="lineNum">    1698 </span><span class="lineCov">     122810 :                 if (!is_ok (&amp;error)) {</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :                         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :                                     &quot;Assembly Loader shadow copy error: %s.&quot;, mono_error_get_message (&amp;error));</span>
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    1702 </span><span class="lineNoCov">          0 :                         *status = MONO_IMAGE_IMAGE_INVALID;</span>
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :                         g_free (fname);</span>
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1705 </span>            :                 }
<span class="lineNum">    1706 </span><span class="lineCov">     122810 :         }</span>
<span class="lineNum">    1707 </span><span class="lineCov">     292931 :         if (new_fname &amp;&amp; new_fname != fname) {</span>
<span class="lineNum">    1708 </span><span class="lineCov">          1 :                 g_free (fname);</span>
<span class="lineNum">    1709 </span><span class="lineCov">          1 :                 fname = new_fname;</span>
<span class="lineNum">    1710 </span><span class="lineCov">          1 :                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1711 </span><span class="lineCov">          1 :                             &quot;Assembly Loader shadow-copied assembly to: '%s'.&quot;, fname);</span>
<span class="lineNum">    1712 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">    1713 </span>            :         
<span class="lineNum">    1714 </span><span class="lineCov">     170113 :         image = NULL;</span>
<span class="lineNum">    1715 </span>            : 
<span class="lineNum">    1716 </span>            :         // If VM built with mkbundle
<span class="lineNum">    1717 </span><span class="lineCov">     170113 :         loaded_from_bundle = FALSE;</span>
<span class="lineNum">    1718 </span><span class="lineCov">     170113 :         if (bundles != NULL) {</span>
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 :                 image = mono_assembly_open_from_bundle (fname, status, refonly);</span>
<span class="lineNum">    1720 </span><span class="lineNoCov">          0 :                 loaded_from_bundle = image != NULL;</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1722 </span>            : 
<span class="lineNum">    1723 </span><span class="lineCov">     170115 :         if (!image)</span>
<span class="lineNum">    1724 </span><span class="lineCov">     170117 :                 image = mono_image_open_full (fname, status, refonly);</span>
<span class="lineNum">    1725 </span>            : 
<span class="lineNum">    1726 </span><span class="lineCov">     170135 :         if (!image){</span>
<span class="lineNum">    1727 </span><span class="lineCov">      96900 :                 if (*status == MONO_IMAGE_OK)</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :                         *status = MONO_IMAGE_ERROR_ERRNO;</span>
<span class="lineNum">    1729 </span><span class="lineCov">      96899 :                 g_free (fname);</span>
<span class="lineNum">    1730 </span><span class="lineCov">      96899 :                 return NULL;</span>
<span class="lineNum">    1731 </span>            :         }
<span class="lineNum">    1732 </span>            : 
<span class="lineNum">    1733 </span><span class="lineCov">      73236 :         if (image-&gt;assembly) {</span>
<span class="lineNum">    1734 </span>            :                 /* Already loaded by another appdomain */
<span class="lineNum">    1735 </span><span class="lineCov">      29307 :                 mono_assembly_invoke_load_hook (image-&gt;assembly);</span>
<span class="lineNum">    1736 </span><span class="lineCov">      29307 :                 mono_image_close (image);</span>
<span class="lineNum">    1737 </span><span class="lineCov">      29307 :                 g_free (fname);</span>
<span class="lineNum">    1738 </span><span class="lineCov">      29307 :                 return image-&gt;assembly;</span>
<span class="lineNum">    1739 </span>            :         }
<span class="lineNum">    1740 </span>            : 
<span class="lineNum">    1741 </span><span class="lineCov">      43929 :         ass = mono_assembly_load_from_full (image, fname, status, refonly);</span>
<span class="lineNum">    1742 </span>            : 
<span class="lineNum">    1743 </span><span class="lineCov">      43929 :         if (ass) {</span>
<span class="lineNum">    1744 </span><span class="lineCov">      43919 :                 if (!loaded_from_bundle)</span>
<span class="lineNum">    1745 </span><span class="lineCov">      43919 :                         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY,</span>
<span class="lineNum">    1746 </span><span class="lineCov">      43919 :                                 &quot;Assembly Loader loaded assembly from location: '%s'.&quot;, filename);</span>
<span class="lineNum">    1747 </span><span class="lineCov">      43919 :                 if (!refonly)</span>
<span class="lineNum">    1748 </span><span class="lineCov">      43903 :                         mono_config_for_assembly (ass-&gt;image);</span>
<span class="lineNum">    1749 </span><span class="lineCov">      43919 :         }</span>
<span class="lineNum">    1750 </span>            : 
<span class="lineNum">    1751 </span>            :         /* Clear the reference added by mono_image_open */
<span class="lineNum">    1752 </span><span class="lineCov">      43929 :         mono_image_close (image);</span>
<span class="lineNum">    1753 </span>            :         
<span class="lineNum">    1754 </span><span class="lineCov">      43929 :         g_free (fname);</span>
<span class="lineNum">    1755 </span>            : 
<span class="lineNum">    1756 </span><span class="lineCov">      43929 :         return ass;</span>
<span class="lineNum">    1757 </span><span class="lineCov">     170135 : }</span>
<a name="1758"><span class="lineNum">    1758 </span>            : </a>
<span class="lineNum">    1759 </span>            : static void
<span class="lineNum">    1760 </span>            : free_item (gpointer val, gpointer user_data)
<span class="lineNum">    1761 </span>            : {
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :         g_free (val);</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1764 </span>            : 
<span class="lineNum">    1765 </span>            : /**
<span class="lineNum">    1766 </span>            :  * mono_assembly_load_friends:
<span class="lineNum">    1767 </span>            :  * @ass: an assembly
<span class="lineNum">    1768 </span>            :  *
<span class="lineNum">    1769 </span>            :  * Load the list of friend assemblies that are allowed to access
<span class="lineNum">    1770 </span>            :  * the assembly's internal types and members. They are stored as assembly
<span class="lineNum">    1771 </span>            :  * names in custom attributes.
<span class="lineNum">    1772 </span>            :  *
<span class="lineNum">    1773 </span>            :  * This is an internal method, we need this because when we load mscorlib
<span class="lineNum">    1774 </span>            :  * we do not have the internals visible cattr loaded yet,
<span class="lineNum">    1775 </span>            :  * so we need to load these after we initialize the runtime. 
<span class="lineNum">    1776 </span>            :  *
<span class="lineNum">    1777 </span>            :  * LOCKING: Acquires the assemblies lock plus the loader lock.
<a name="1778"><span class="lineNum">    1778 </span>            :  */</a>
<span class="lineNum">    1779 </span>            : void
<span class="lineNum">    1780 </span>            : mono_assembly_load_friends (MonoAssembly* ass)
<span class="lineNum">    1781 </span>            : {
<span class="lineNum">    1782 </span>            :         MonoError error;
<span class="lineNum">    1783 </span>            :         int i;
<span class="lineNum">    1784 </span>            :         MonoCustomAttrInfo* attrs;
<span class="lineNum">    1785 </span>            :         GSList *list;
<span class="lineNum">    1786 </span>            : 
<span class="lineNum">    1787 </span><span class="lineCov">    9296450 :         if (ass-&gt;friend_assembly_names_inited)</span>
<span class="lineNum">    1788 </span><span class="lineCov">    9292168 :                 return;</span>
<span class="lineNum">    1789 </span>            : 
<span class="lineNum">    1790 </span><span class="lineCov">       4457 :         attrs = mono_custom_attrs_from_assembly_checked (ass, FALSE, &amp;error);</span>
<span class="lineNum">    1791 </span><span class="lineCov">       4457 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    1792 </span><span class="lineCov">       4457 :         if (!attrs) {</span>
<span class="lineNum">    1793 </span><span class="lineNoCov">          0 :                 mono_assemblies_lock ();</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :                 ass-&gt;friend_assembly_names_inited = TRUE;</span>
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :                 mono_assemblies_unlock ();</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1797 </span>            :         }
<span class="lineNum">    1798 </span>            : 
<span class="lineNum">    1799 </span><span class="lineCov">       4457 :         mono_assemblies_lock ();</span>
<span class="lineNum">    1800 </span><span class="lineCov">       4457 :         if (ass-&gt;friend_assembly_names_inited) {</span>
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :                 mono_assemblies_unlock ();</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1803 </span>            :         }
<span class="lineNum">    1804 </span><span class="lineCov">       4457 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    1805 </span>            : 
<span class="lineNum">    1806 </span><span class="lineCov">       4457 :         list = NULL;</span>
<span class="lineNum">    1807 </span>            :         /* 
<span class="lineNum">    1808 </span>            :          * We build the list outside the assemblies lock, the worse that can happen
<span class="lineNum">    1809 </span>            :          * is that we'll need to free the allocated list.
<span class="lineNum">    1810 </span>            :          */
<span class="lineNum">    1811 </span><span class="lineCov">     331842 :         for (i = 0; i &lt; attrs-&gt;num_attrs; ++i) {</span>
<span class="lineNum">    1812 </span><span class="lineCov">     161464 :                 MonoCustomAttrEntry *attr = &amp;attrs-&gt;attrs [i];</span>
<span class="lineNum">    1813 </span>            :                 MonoAssemblyName *aname;
<span class="lineNum">    1814 </span>            :                 const gchar *data;
<span class="lineNum">    1815 </span>            :                 /* Do some sanity checking */
<span class="lineNum">    1816 </span><span class="lineCov">     322928 :                 if (!attr-&gt;ctor || attr-&gt;ctor-&gt;klass != mono_class_try_get_internals_visible_class ())</span>
<span class="lineNum">    1817 </span><span class="lineCov">      87311 :                         continue;</span>
<span class="lineNum">    1818 </span><span class="lineCov">      74153 :                 if (attr-&gt;data_size &lt; 4)</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1820 </span><span class="lineCov">      74153 :                 data = (const char*)attr-&gt;data;</span>
<span class="lineNum">    1821 </span>            :                 /* 0xFF means null string, see custom attr format */
<span class="lineNum">    1822 </span><span class="lineCov">     222459 :                 if (data [0] != 1 || data [1] != 0 || (data [2] &amp; 0xFF) == 0xFF)</span>
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1824 </span><span class="lineCov">      74153 :                 mono_metadata_decode_value (data + 2, &amp;data);</span>
<span class="lineNum">    1825 </span><span class="lineCov">      74153 :                 aname = g_new0 (MonoAssemblyName, 1);</span>
<span class="lineNum">    1826 </span>            :                 /*g_print (&quot;friend ass: %s\n&quot;, data);*/
<span class="lineNum">    1827 </span><span class="lineCov">      74153 :                 if (mono_assembly_name_parse_full (data, aname, TRUE, NULL, NULL)) {</span>
<span class="lineNum">    1828 </span><span class="lineCov">      74149 :                         list = g_slist_prepend (list, aname);</span>
<span class="lineNum">    1829 </span><span class="lineCov">      74149 :                 } else {</span>
<span class="lineNum">    1830 </span><span class="lineCov">          4 :                         g_free (aname);</span>
<span class="lineNum">    1831 </span>            :                 }
<span class="lineNum">    1832 </span><span class="lineCov">      74153 :         }</span>
<span class="lineNum">    1833 </span><span class="lineCov">       4457 :         mono_custom_attrs_free (attrs);</span>
<span class="lineNum">    1834 </span>            : 
<span class="lineNum">    1835 </span><span class="lineCov">       4457 :         mono_assemblies_lock ();</span>
<span class="lineNum">    1836 </span><span class="lineCov">       4457 :         if (ass-&gt;friend_assembly_names_inited) {</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :                 mono_assemblies_unlock ();</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :                 g_slist_foreach (list, free_item, NULL);</span>
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 :                 g_slist_free (list);</span>
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1841 </span>            :         }
<span class="lineNum">    1842 </span><span class="lineCov">       4457 :         ass-&gt;friend_assembly_names = list;</span>
<span class="lineNum">    1843 </span>            : 
<span class="lineNum">    1844 </span>            :         /* Because of the double checked locking pattern above */
<span class="lineNum">    1845 </span><span class="lineCov">       4457 :         mono_memory_barrier ();</span>
<span class="lineNum">    1846 </span><span class="lineCov">       4457 :         ass-&gt;friend_assembly_names_inited = TRUE;</span>
<span class="lineNum">    1847 </span><span class="lineCov">       4457 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    1848 </span><span class="lineCov">    9301007 : }</span>
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span>            : struct HasReferenceAssemblyAttributeIterData {
<span class="lineNum">    1851 </span>            :         gboolean has_attr;
<span class="lineNum">    1852 </span>            : };
<a name="1853"><span class="lineNum">    1853 </span>            : </a>
<span class="lineNum">    1854 </span>            : static gboolean
<span class="lineNum">    1855 </span>            : has_reference_assembly_attribute_iterator (MonoImage *image, guint32 typeref_scope_token, const char *nspace, const char *name, guint32 method_token, gpointer user_data)
<span class="lineNum">    1856 </span>            : {
<span class="lineNum">    1857 </span><span class="lineCov">     679354 :         gboolean stop_scanning = FALSE;</span>
<span class="lineNum">    1858 </span><span class="lineCov">     679354 :         struct HasReferenceAssemblyAttributeIterData *iter_data = (struct HasReferenceAssemblyAttributeIterData*)user_data;</span>
<span class="lineNum">    1859 </span>            : 
<span class="lineNum">    1860 </span><span class="lineCov">     679366 :         if (!strcmp (name, &quot;ReferenceAssemblyAttribute&quot;) &amp;&amp; !strcmp (nspace, &quot;System.Runtime.CompilerServices&quot;)) {</span>
<span class="lineNum">    1861 </span>            :                 /* Note we don't check the assembly name, same as coreCLR. */
<span class="lineNum">    1862 </span><span class="lineCov">         12 :                 iter_data-&gt;has_attr = TRUE;</span>
<span class="lineNum">    1863 </span><span class="lineCov">         12 :                 stop_scanning = TRUE;</span>
<span class="lineNum">    1864 </span><span class="lineCov">         12 :         }</span>
<span class="lineNum">    1865 </span>            : 
<span class="lineNum">    1866 </span><span class="lineCov">     679354 :         return stop_scanning;</span>
<span class="lineNum">    1867 </span>            : }
<span class="lineNum">    1868 </span>            : 
<span class="lineNum">    1869 </span>            : /**
<span class="lineNum">    1870 </span>            :  * mono_assembly_has_reference_assembly_attribute:
<span class="lineNum">    1871 </span>            :  * @assembly: a MonoAssembly
<span class="lineNum">    1872 </span>            :  * @error: set on error.
<span class="lineNum">    1873 </span>            :  *
<span class="lineNum">    1874 </span>            :  * Returns TRUE if @assembly has the System.Runtime.CompilerServices.ReferenceAssemblyAttribute set.
<span class="lineNum">    1875 </span>            :  * On error returns FALSE and sets @error.
<a name="1876"><span class="lineNum">    1876 </span>            :  */</a>
<span class="lineNum">    1877 </span>            : gboolean
<span class="lineNum">    1878 </span>            : mono_assembly_has_reference_assembly_attribute (MonoAssembly *assembly, MonoError *error)
<span class="lineNum">    1879 </span>            : {
<span class="lineNum">    1880 </span><span class="lineCov">      43914 :         mono_error_init (error);</span>
<span class="lineNum">    1881 </span>            : 
<span class="lineNum">    1882 </span>            :         /*
<span class="lineNum">    1883 </span>            :          * This might be called during assembly loading, so do everything using the low-level
<span class="lineNum">    1884 </span>            :          * metadata APIs.
<span class="lineNum">    1885 </span>            :          */
<span class="lineNum">    1886 </span>            : 
<span class="lineNum">    1887 </span><span class="lineCov">      43914 :         struct HasReferenceAssemblyAttributeIterData iter_data = { FALSE };</span>
<span class="lineNum">    1888 </span>            : 
<span class="lineNum">    1889 </span><span class="lineCov">      43914 :         mono_assembly_metadata_foreach_custom_attr (assembly, &amp;has_reference_assembly_attribute_iterator, &amp;iter_data);</span>
<span class="lineNum">    1890 </span>            : 
<span class="lineNum">    1891 </span><span class="lineCov">      43914 :         return iter_data.has_attr;</span>
<span class="lineNum">    1892 </span>            : }
<span class="lineNum">    1893 </span>            : 
<span class="lineNum">    1894 </span>            : /**
<span class="lineNum">    1895 </span>            :  * mono_assembly_open:
<span class="lineNum">    1896 </span>            :  * @filename: Opens the assembly pointed out by this name
<span class="lineNum">    1897 </span>            :  * @status: return status code
<span class="lineNum">    1898 </span>            :  *
<span class="lineNum">    1899 </span>            :  * This loads an assembly from the specified @filename.   The @filename allows
<span class="lineNum">    1900 </span>            :  * a local URL (starting with a file:// prefix).  If a file prefix is used, the
<span class="lineNum">    1901 </span>            :  * filename is interpreted as a URL, and the filename is URL-decoded.   Otherwise the file
<span class="lineNum">    1902 </span>            :  * is treated as a local path.
<span class="lineNum">    1903 </span>            :  *
<span class="lineNum">    1904 </span>            :  * First, an attempt is made to load the assembly from the bundled executable (for those
<span class="lineNum">    1905 </span>            :  * deployments that have been done with the `mkbundle` tool or for scenarios where the
<span class="lineNum">    1906 </span>            :  * assembly has been registered as an embedded assembly).   If this is not the case, then
<span class="lineNum">    1907 </span>            :  * the assembly is loaded from disk using `api:mono_image_open_full`.
<span class="lineNum">    1908 </span>            :  *
<span class="lineNum">    1909 </span>            :  * If the pointed assembly does not live in the Global Assembly Cache, a shadow copy of
<span class="lineNum">    1910 </span>            :  * the assembly is made.
<span class="lineNum">    1911 </span>            :  *
<span class="lineNum">    1912 </span>            :  * Return: a pointer to the MonoAssembly if @filename contains a valid
<span class="lineNum">    1913 </span>            :  * assembly or NULL on error.  Details about the error are stored in the
<span class="lineNum">    1914 </span>            :  * @status variable.
<a name="1915"><span class="lineNum">    1915 </span>            :  */</a>
<span class="lineNum">    1916 </span>            : MonoAssembly *
<span class="lineNum">    1917 </span>            : mono_assembly_open (const char *filename, MonoImageOpenStatus *status)
<span class="lineNum">    1918 </span>            : {
<span class="lineNum">    1919 </span><span class="lineCov">       6614 :         return mono_assembly_open_full (filename, status, FALSE);</span>
<span class="lineNum">    1920 </span>            : }
<span class="lineNum">    1921 </span>            : 
<span class="lineNum">    1922 </span>            : /**
<span class="lineNum">    1923 </span>            :  * mono_assembly_load_from_full:
<span class="lineNum">    1924 </span>            :  * @image: Image to load the assembly from
<span class="lineNum">    1925 </span>            :  * @fname: assembly name to associate with the assembly
<span class="lineNum">    1926 </span>            :  * @status: returns the status condition
<span class="lineNum">    1927 </span>            :  * @refonly: Whether this assembly is being opened in &quot;reflection-only&quot; mode.
<span class="lineNum">    1928 </span>            :  *
<span class="lineNum">    1929 </span>            :  * If the provided @image has an assembly reference, it will process the given
<span class="lineNum">    1930 </span>            :  * image as an assembly with the given name.
<span class="lineNum">    1931 </span>            :  *
<span class="lineNum">    1932 </span>            :  * Most likely you want to use the `api:mono_assembly_load_full` method instead.
<span class="lineNum">    1933 </span>            :  *
<span class="lineNum">    1934 </span>            :  * Returns: A valid pointer to a `MonoAssembly*` on success and the @status will be
<span class="lineNum">    1935 </span>            :  * set to #MONO_IMAGE_OK;  or NULL on error.
<span class="lineNum">    1936 </span>            :  *
<span class="lineNum">    1937 </span>            :  * If there is an error loading the assembly the @status will indicate the
<span class="lineNum">    1938 </span>            :  * reason with @status being set to `MONO_IMAGE_INVALID` if the
<span class="lineNum">    1939 </span>            :  * image did not contain an assembly reference table.
<a name="1940"><span class="lineNum">    1940 </span>            :  */</a>
<span class="lineNum">    1941 </span>            : MonoAssembly *
<span class="lineNum">    1942 </span>            : mono_assembly_load_from_full (MonoImage *image, const char*fname, 
<span class="lineNum">    1943 </span>            :                               MonoImageOpenStatus *status, gboolean refonly)
<span class="lineNum">    1944 </span>            : {
<span class="lineNum">    1945 </span>            :         MonoAssembly *ass, *ass2;
<span class="lineNum">    1946 </span>            :         char *base_dir;
<span class="lineNum">    1947 </span>            : 
<span class="lineNum">    1948 </span><span class="lineCov">      43933 :         if (!image-&gt;tables [MONO_TABLE_ASSEMBLY].rows) {</span>
<span class="lineNum">    1949 </span>            :                 /* 'image' doesn't have a manifest -- maybe someone is trying to Assembly.Load a .netmodule */
<span class="lineNum">    1950 </span><span class="lineNoCov">          0 :                 *status = MONO_IMAGE_IMAGE_INVALID;</span>
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1952 </span>            :         }
<span class="lineNum">    1953 </span>            : 
<span class="lineNum">    1954 </span>            : #if defined (HOST_WIN32)
<span class="lineNum">    1955 </span>            :         {
<span class="lineNum">    1956 </span>            :                 gchar *tmp_fn;
<span class="lineNum">    1957 </span>            :                 int i;
<span class="lineNum">    1958 </span>            : 
<span class="lineNum">    1959 </span>            :                 tmp_fn = g_strdup (fname);
<span class="lineNum">    1960 </span>            :                 for (i = strlen (tmp_fn) - 1; i &gt;= 0; i--) {
<span class="lineNum">    1961 </span>            :                         if (tmp_fn [i] == '/')
<span class="lineNum">    1962 </span>            :                                 tmp_fn [i] = '\\';
<span class="lineNum">    1963 </span>            :                 }
<span class="lineNum">    1964 </span>            : 
<span class="lineNum">    1965 </span>            :                 base_dir = absolute_dir (tmp_fn);
<span class="lineNum">    1966 </span>            :                 g_free (tmp_fn);
<span class="lineNum">    1967 </span>            :         }
<span class="lineNum">    1968 </span>            : #else
<span class="lineNum">    1969 </span><span class="lineCov">      43932 :         base_dir = absolute_dir (fname);</span>
<span class="lineNum">    1970 </span>            : #endif
<span class="lineNum">    1971 </span>            : 
<span class="lineNum">    1972 </span>            :         /*
<span class="lineNum">    1973 </span>            :          * Create assembly struct, and enter it into the assembly cache
<span class="lineNum">    1974 </span>            :          */
<span class="lineNum">    1975 </span><span class="lineCov">      43932 :         ass = g_new0 (MonoAssembly, 1);</span>
<span class="lineNum">    1976 </span><span class="lineCov">      43932 :         ass-&gt;basedir = base_dir;</span>
<span class="lineNum">    1977 </span><span class="lineCov">      43932 :         ass-&gt;ref_only = refonly;</span>
<span class="lineNum">    1978 </span><span class="lineCov">      43932 :         ass-&gt;image = image;</span>
<span class="lineNum">    1979 </span>            : 
<span class="lineNum">    1980 </span><span class="lineCov">      43932 :         mono_profiler_assembly_event (ass, MONO_PROFILE_START_LOAD);</span>
<span class="lineNum">    1981 </span>            : 
<span class="lineNum">    1982 </span><span class="lineCov">      43932 :         mono_assembly_fill_assembly_name (image, &amp;ass-&gt;aname);</span>
<span class="lineNum">    1983 </span>            : 
<span class="lineNum">    1984 </span><span class="lineCov">      84578 :         if (mono_defaults.corlib &amp;&amp; strcmp (ass-&gt;aname.name, &quot;mscorlib&quot;) == 0) {</span>
<span class="lineNum">    1985 </span>            :                 // MS.NET doesn't support loading other mscorlibs
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :                 g_free (ass);</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :                 g_free (base_dir);</span>
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :                 mono_image_addref (mono_defaults.corlib);</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :                 *status = MONO_IMAGE_OK;</span>
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :                 return mono_defaults.corlib-&gt;assembly;</span>
<span class="lineNum">    1991 </span>            :         }
<span class="lineNum">    1992 </span>            : 
<span class="lineNum">    1993 </span>            :         /* Add a non-temporary reference because of ass-&gt;image */
<span class="lineNum">    1994 </span><span class="lineCov">      43931 :         mono_image_addref (image);</span>
<span class="lineNum">    1995 </span>            : 
<span class="lineNum">    1996 </span><span class="lineCov">      43931 :         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Image addref %s[%p] -&gt; %s[%p]: %d&quot;, ass-&gt;aname.name, ass, image-&gt;name, image, image-&gt;ref_count);</span>
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span>            :         /* 
<span class="lineNum">    1999 </span>            :          * The load hooks might take locks so we can't call them while holding the
<span class="lineNum">    2000 </span>            :          * assemblies lock.
<span class="lineNum">    2001 </span>            :          */
<span class="lineNum">    2002 </span><span class="lineCov">      43931 :         if (ass-&gt;aname.name) {</span>
<span class="lineNum">    2003 </span><span class="lineCov">      43933 :                 ass2 = mono_assembly_invoke_search_hook_internal (&amp;ass-&gt;aname, NULL, refonly, FALSE);</span>
<span class="lineNum">    2004 </span><span class="lineCov">      43933 :                 if (ass2) {</span>
<span class="lineNum">    2005 </span><span class="lineCov">          9 :                         g_free (ass);</span>
<span class="lineNum">    2006 </span><span class="lineCov">          9 :                         g_free (base_dir);</span>
<span class="lineNum">    2007 </span><span class="lineCov">          9 :                         mono_image_close (image);</span>
<span class="lineNum">    2008 </span><span class="lineCov">          9 :                         *status = MONO_IMAGE_OK;</span>
<span class="lineNum">    2009 </span><span class="lineCov">          9 :                         return ass2;</span>
<span class="lineNum">    2010 </span>            :                 }
<span class="lineNum">    2011 </span><span class="lineCov">      43924 :         }</span>
<span class="lineNum">    2012 </span>            : 
<span class="lineNum">    2013 </span>            :         /* We need to check for ReferenceAssmeblyAttribute before we
<span class="lineNum">    2014 </span>            :          * mark the assembly as loaded and before we fire the load
<span class="lineNum">    2015 </span>            :          * hook. Otherwise mono_domain_fire_assembly_load () in
<span class="lineNum">    2016 </span>            :          * appdomain.c will cache a mapping from the assembly name to
<span class="lineNum">    2017 </span>            :          * this image and we won't be able to look for a different
<span class="lineNum">    2018 </span>            :          * candidate. */
<span class="lineNum">    2019 </span>            : 
<span class="lineNum">    2020 </span><span class="lineCov">      43924 :         if (!refonly) {</span>
<span class="lineNum">    2021 </span>            :                 MonoError refasm_error;
<span class="lineNum">    2022 </span><span class="lineCov">      43908 :                 if (mono_assembly_has_reference_assembly_attribute (ass, &amp;refasm_error)) {</span>
<span class="lineNum">    2023 </span><span class="lineCov">         12 :                         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Image for assembly '%s' (%s) has ReferenceAssemblyAttribute, skipping&quot;, ass-&gt;aname.name, image-&gt;name);</span>
<span class="lineNum">    2024 </span><span class="lineCov">         12 :                         g_free (ass);</span>
<span class="lineNum">    2025 </span><span class="lineCov">         12 :                         g_free (base_dir);</span>
<span class="lineNum">    2026 </span><span class="lineCov">         12 :                         mono_image_close (image);</span>
<span class="lineNum">    2027 </span><span class="lineCov">         12 :                         *status = MONO_IMAGE_IMAGE_INVALID;</span>
<span class="lineNum">    2028 </span><span class="lineCov">         12 :                         return NULL;</span>
<span class="lineNum">    2029 </span>            :                 }
<span class="lineNum">    2030 </span><span class="lineCov">      43896 :                 mono_error_cleanup (&amp;refasm_error);</span>
<span class="lineNum">    2031 </span><span class="lineCov">      43896 :         }</span>
<span class="lineNum">    2032 </span>            : 
<span class="lineNum">    2033 </span><span class="lineCov">      43912 :         mono_assemblies_lock ();</span>
<span class="lineNum">    2034 </span>            : 
<span class="lineNum">    2035 </span><span class="lineCov">      43912 :         if (image-&gt;assembly) {</span>
<span class="lineNum">    2036 </span>            :                 /*
<span class="lineNum">    2037 </span>            :                  * This means another thread has already loaded the assembly, but not yet
<span class="lineNum">    2038 </span>            :                  * called the load hooks so the search hook can't find the assembly.
<span class="lineNum">    2039 </span>            :                  */
<span class="lineNum">    2040 </span><span class="lineCov">         26 :                 mono_assemblies_unlock ();</span>
<span class="lineNum">    2041 </span><span class="lineCov">         26 :                 ass2 = image-&gt;assembly;</span>
<span class="lineNum">    2042 </span><span class="lineCov">         26 :                 g_free (ass);</span>
<span class="lineNum">    2043 </span><span class="lineCov">         26 :                 g_free (base_dir);</span>
<span class="lineNum">    2044 </span><span class="lineCov">         26 :                 mono_image_close (image);</span>
<span class="lineNum">    2045 </span><span class="lineCov">         26 :                 *status = MONO_IMAGE_OK;</span>
<span class="lineNum">    2046 </span><span class="lineCov">         26 :                 return ass2;</span>
<span class="lineNum">    2047 </span>            :         }
<span class="lineNum">    2048 </span>            : 
<span class="lineNum">    2049 </span><span class="lineCov">      43886 :         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Prepared to set up assembly '%s' (%s)&quot;, ass-&gt;aname.name, image-&gt;name);</span>
<span class="lineNum">    2050 </span>            : 
<span class="lineNum">    2051 </span><span class="lineCov">      43886 :         image-&gt;assembly = ass;</span>
<span class="lineNum">    2052 </span>            : 
<span class="lineNum">    2053 </span><span class="lineCov">      43886 :         loaded_assemblies = g_list_prepend (loaded_assemblies, ass);</span>
<span class="lineNum">    2054 </span><span class="lineCov">      43886 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    2055 </span>            : 
<span class="lineNum">    2056 </span>            : #ifdef HOST_WIN32
<span class="lineNum">    2057 </span>            :         if (image-&gt;is_module_handle)
<span class="lineNum">    2058 </span>            :                 mono_image_fixup_vtable (image);
<span class="lineNum">    2059 </span>            : #endif
<span class="lineNum">    2060 </span>            : 
<span class="lineNum">    2061 </span><span class="lineCov">      43886 :         mono_assembly_invoke_load_hook (ass);</span>
<span class="lineNum">    2062 </span>            : 
<span class="lineNum">    2063 </span><span class="lineCov">      43886 :         mono_profiler_assembly_loaded (ass, MONO_PROFILE_OK);</span>
<span class="lineNum">    2064 </span>            :         
<span class="lineNum">    2065 </span><span class="lineCov">      43886 :         return ass;</span>
<span class="lineNum">    2066 </span><span class="lineCov">      43933 : }</span>
<span class="lineNum">    2067 </span>            : 
<span class="lineNum">    2068 </span>            : /**
<span class="lineNum">    2069 </span>            :  * mono_assembly_load_from:
<span class="lineNum">    2070 </span>            :  * @image: Image to load the assembly from
<span class="lineNum">    2071 </span>            :  * @fname: assembly name to associate with the assembly
<span class="lineNum">    2072 </span>            :  * @status: return status code
<span class="lineNum">    2073 </span>            :  *
<span class="lineNum">    2074 </span>            :  * If the provided @image has an assembly reference, it will process the given
<span class="lineNum">    2075 </span>            :  * image as an assembly with the given name.
<span class="lineNum">    2076 </span>            :  *
<span class="lineNum">    2077 </span>            :  * Most likely you want to use the `api:mono_assembly_load_full` method instead.
<span class="lineNum">    2078 </span>            :  *
<span class="lineNum">    2079 </span>            :  * This is equivalent to calling `api:mono_assembly_load_from_full` with the
<span class="lineNum">    2080 </span>            :  * @refonly parameter set to FALSE.
<span class="lineNum">    2081 </span>            :  * Returns: A valid pointer to a `MonoAssembly*` on success and the @status will be
<span class="lineNum">    2082 </span>            :  * set to #MONO_IMAGE_OK;  or NULL on error.
<span class="lineNum">    2083 </span>            :  *
<span class="lineNum">    2084 </span>            :  * If there is an error loading the assembly the @status will indicate the
<span class="lineNum">    2085 </span>            :  * reason with @status being set to `MONO_IMAGE_INVALID` if the
<span class="lineNum">    2086 </span>            :  * image did not contain an assembly reference table.
<span class="lineNum">    2087 </span>            :  
<a name="2088"><span class="lineNum">    2088 </span>            :  */</a>
<span class="lineNum">    2089 </span>            : MonoAssembly *
<span class="lineNum">    2090 </span>            : mono_assembly_load_from (MonoImage *image, const char *fname,
<span class="lineNum">    2091 </span>            :                          MonoImageOpenStatus *status)
<span class="lineNum">    2092 </span>            : {
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :         return mono_assembly_load_from_full (image, fname, status, FALSE);</span>
<span class="lineNum">    2094 </span>            : }
<span class="lineNum">    2095 </span>            : 
<span class="lineNum">    2096 </span>            : /**
<span class="lineNum">    2097 </span>            :  * mono_assembly_name_free:
<span class="lineNum">    2098 </span>            :  * @aname: assembly name to free
<span class="lineNum">    2099 </span>            :  * 
<span class="lineNum">    2100 </span>            :  * Frees the provided assembly name object.
<span class="lineNum">    2101 </span>            :  * (it does not frees the object itself, only the name members).
<a name="2102"><span class="lineNum">    2102 </span>            :  */</a>
<span class="lineNum">    2103 </span>            : void
<span class="lineNum">    2104 </span>            : mono_assembly_name_free (MonoAssemblyName *aname)
<span class="lineNum">    2105 </span>            : {
<span class="lineNum">    2106 </span><span class="lineCov">      87122 :         if (aname == NULL)</span>
<span class="lineNum">    2107 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    2108 </span>            : 
<span class="lineNum">    2109 </span><span class="lineCov">      87122 :         g_free ((void *) aname-&gt;name);</span>
<span class="lineNum">    2110 </span><span class="lineCov">      87122 :         g_free ((void *) aname-&gt;culture);</span>
<span class="lineNum">    2111 </span><span class="lineCov">      87122 :         g_free ((void *) aname-&gt;hash_value);</span>
<span class="lineNum">    2112 </span><span class="lineCov">      87122 :         g_free ((guint8*) aname-&gt;public_key);</span>
<span class="lineNum">    2113 </span><span class="lineCov">     174244 : }</span>
<a name="2114"><span class="lineNum">    2114 </span>            : </a>
<span class="lineNum">    2115 </span>            : static gboolean
<span class="lineNum">    2116 </span>            : parse_public_key (const gchar *key, gchar** pubkey, gboolean *is_ecma)
<span class="lineNum">    2117 </span>            : {
<span class="lineNum">    2118 </span>            :         const gchar *pkey;
<span class="lineNum">    2119 </span>            :         gchar header [16], val, *arr;
<span class="lineNum">    2120 </span>            :         gint i, j, offset, bitlen, keylen, pkeylen;
<span class="lineNum">    2121 </span>            :         
<span class="lineNum">    2122 </span><span class="lineCov">      74153 :         keylen = strlen (key) &gt;&gt; 1;</span>
<span class="lineNum">    2123 </span><span class="lineCov">      74153 :         if (keylen &lt; 1)</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2125 </span>            : 
<span class="lineNum">    2126 </span>            :         /* allow the ECMA standard key */
<span class="lineNum">    2127 </span><span class="lineCov">      74153 :         if (strcmp (key, &quot;00000000000000000400000000000000&quot;) == 0) {</span>
<span class="lineNum">    2128 </span><span class="lineCov">      16433 :                 if (pubkey) {</span>
<span class="lineNum">    2129 </span><span class="lineCov">      16433 :                         *pubkey = g_strdup (key);</span>
<span class="lineNum">    2130 </span><span class="lineCov">      16433 :                         *is_ecma = TRUE;</span>
<span class="lineNum">    2131 </span><span class="lineCov">      16433 :                 }</span>
<span class="lineNum">    2132 </span><span class="lineCov">      16433 :                 return TRUE;</span>
<span class="lineNum">    2133 </span>            :         }
<span class="lineNum">    2134 </span><span class="lineCov">      57720 :         *is_ecma = FALSE;</span>
<span class="lineNum">    2135 </span><span class="lineCov">      57720 :         val = g_ascii_xdigit_value (key [0]) &lt;&lt; 4;</span>
<span class="lineNum">    2136 </span><span class="lineCov">      57720 :         val |= g_ascii_xdigit_value (key [1]);</span>
<span class="lineNum">    2137 </span><span class="lineCov">      57720 :         switch (val) {</span>
<span class="lineNum">    2138 </span>            :                 case 0x00:
<span class="lineNum">    2139 </span><span class="lineCov">      57720 :                         if (keylen &lt; 13)</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :                                 return FALSE;</span>
<span class="lineNum">    2141 </span><span class="lineCov">      57720 :                         val = g_ascii_xdigit_value (key [24]);</span>
<span class="lineNum">    2142 </span><span class="lineCov">      57720 :                         val |= g_ascii_xdigit_value (key [25]);</span>
<span class="lineNum">    2143 </span><span class="lineCov">      57720 :                         if (val != 0x06)</span>
<span class="lineNum">    2144 </span><span class="lineCov">          4 :                                 return FALSE;</span>
<span class="lineNum">    2145 </span><span class="lineCov">      57716 :                         pkey = key + 24;</span>
<span class="lineNum">    2146 </span><span class="lineCov">      57716 :                         break;</span>
<span class="lineNum">    2147 </span>            :                 case 0x06:
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :                         pkey = key;</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2150 </span>            :                 default:
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :                         return FALSE;</span>
<span class="lineNum">    2152 </span>            :         }
<span class="lineNum">    2153 </span>            :                 
<span class="lineNum">    2154 </span>            :         /* We need the first 16 bytes
<span class="lineNum">    2155 </span>            :         * to check whether this key is valid or not */
<span class="lineNum">    2156 </span><span class="lineCov">      57716 :         pkeylen = strlen (pkey) &gt;&gt; 1;</span>
<span class="lineNum">    2157 </span><span class="lineCov">      57716 :         if (pkeylen &lt; 16)</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2159 </span>            :                 
<span class="lineNum">    2160 </span><span class="lineCov">    1962344 :         for (i = 0, j = 0; i &lt; 16; i++) {</span>
<span class="lineNum">    2161 </span><span class="lineCov">     923456 :                 header [i] = g_ascii_xdigit_value (pkey [j++]) &lt;&lt; 4;</span>
<span class="lineNum">    2162 </span><span class="lineCov">     923456 :                 header [i] |= g_ascii_xdigit_value (pkey [j++]);</span>
<span class="lineNum">    2163 </span><span class="lineCov">     923456 :         }</span>
<span class="lineNum">    2164 </span>            : 
<span class="lineNum">    2165 </span><span class="lineCov">     115432 :         if (header [0] != 0x06 || /* PUBLICKEYBLOB (0x06) */</span>
<span class="lineNum">    2166 </span><span class="lineCov">      57716 :                         header [1] != 0x02 || /* Version (0x02) */</span>
<span class="lineNum">    2167 </span><span class="lineCov">      57716 :                         header [2] != 0x00 || /* Reserved (word) */</span>
<span class="lineNum">    2168 </span><span class="lineCov">      57716 :                         header [3] != 0x00 ||</span>
<span class="lineNum">    2169 </span><span class="lineCov">      57716 :                         (guint)(read32 (header + 8)) != 0x31415352) /* DWORD magic = RSA1 */</span>
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2171 </span>            : 
<span class="lineNum">    2172 </span>            :         /* Based on this length, we _should_ be able to know if the length is right */
<span class="lineNum">    2173 </span><span class="lineCov">      57716 :         bitlen = read32 (header + 12) &gt;&gt; 3;</span>
<span class="lineNum">    2174 </span><span class="lineCov">      57716 :         if ((bitlen + 16 + 4) != pkeylen)</span>
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2176 </span>            : 
<span class="lineNum">    2177 </span>            :         /* parsing is OK and the public key itself is not requested back */
<span class="lineNum">    2178 </span><span class="lineCov">      57716 :         if (!pubkey)</span>
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :                 return TRUE;</span>
<span class="lineNum">    2180 </span>            :                 
<span class="lineNum">    2181 </span>            :         /* Encode the size of the blob */
<span class="lineNum">    2182 </span><span class="lineCov">      57716 :         offset = 0;</span>
<span class="lineNum">    2183 </span><span class="lineCov">      57716 :         if (keylen &lt;= 127) {</span>
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :                 arr = (gchar *)g_malloc (keylen + 1);</span>
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :                 arr [offset++] = keylen;</span>
<span class="lineNum">    2186 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    2187 </span><span class="lineCov">      57716 :                 arr = (gchar *)g_malloc (keylen + 2);</span>
<span class="lineNum">    2188 </span><span class="lineCov">      57716 :                 arr [offset++] = 0x80; /* 10bs */</span>
<span class="lineNum">    2189 </span><span class="lineCov">      57716 :                 arr [offset++] = keylen;</span>
<span class="lineNum">    2190 </span>            :         }
<span class="lineNum">    2191 </span>            :                 
<span class="lineNum">    2192 </span><span class="lineCov">   18584552 :         for (i = offset, j = 0; i &lt; keylen + offset; i++) {</span>
<span class="lineNum">    2193 </span><span class="lineCov">    9234560 :                 arr [i] = g_ascii_xdigit_value (key [j++]) &lt;&lt; 4;</span>
<span class="lineNum">    2194 </span><span class="lineCov">    9234560 :                 arr [i] |= g_ascii_xdigit_value (key [j++]);</span>
<span class="lineNum">    2195 </span><span class="lineCov">    9234560 :         }</span>
<span class="lineNum">    2196 </span>            : 
<span class="lineNum">    2197 </span><span class="lineCov">      57716 :         *pubkey = arr;</span>
<span class="lineNum">    2198 </span>            : 
<span class="lineNum">    2199 </span><span class="lineCov">      57716 :         return TRUE;</span>
<span class="lineNum">    2200 </span><span class="lineCov">      74153 : }</span>
<a name="2201"><span class="lineNum">    2201 </span>            : </a>
<span class="lineNum">    2202 </span>            : static gboolean
<span class="lineNum">    2203 </span>            : build_assembly_name (const char *name, const char *version, const char *culture, const char *token, const char *key, guint32 flags, guint32 arch, MonoAssemblyName *aname, gboolean save_public_key)
<span class="lineNum">    2204 </span>            : {
<span class="lineNum">    2205 </span>            :         gint major, minor, build, revision;
<span class="lineNum">    2206 </span>            :         gint len;
<span class="lineNum">    2207 </span>            :         gint version_parts;
<span class="lineNum">    2208 </span>            :         gchar *pkey, *pkeyptr, *encoded, tok [8];
<span class="lineNum">    2209 </span>            : 
<span class="lineNum">    2210 </span><span class="lineCov">      87234 :         memset (aname, 0, sizeof (MonoAssemblyName));</span>
<span class="lineNum">    2211 </span>            : 
<span class="lineNum">    2212 </span><span class="lineCov">      87234 :         if (version) {</span>
<span class="lineNum">    2213 </span><span class="lineCov">       8096 :                 version_parts = sscanf (version, &quot;%u.%u.%u.%u&quot;, &amp;major, &amp;minor, &amp;build, &amp;revision);</span>
<span class="lineNum">    2214 </span><span class="lineCov">      16192 :                 if (version_parts &lt; 2 || version_parts &gt; 4)</span>
<span class="lineNum">    2215 </span><span class="lineNoCov">          0 :                         return FALSE;</span>
<span class="lineNum">    2216 </span>            : 
<span class="lineNum">    2217 </span>            :                 /* FIXME: we should set build &amp; revision to -1 (instead of 0)
<span class="lineNum">    2218 </span>            :                 if these are not set in the version string. That way, later on,
<span class="lineNum">    2219 </span>            :                 we can still determine if these were specified. */
<span class="lineNum">    2220 </span><span class="lineCov">       8096 :                 aname-&gt;major = major;</span>
<span class="lineNum">    2221 </span><span class="lineCov">       8096 :                 aname-&gt;minor = minor;</span>
<span class="lineNum">    2222 </span><span class="lineCov">       8096 :                 if (version_parts &gt;= 3)</span>
<span class="lineNum">    2223 </span><span class="lineCov">       8097 :                         aname-&gt;build = build;</span>
<span class="lineNum">    2224 </span>            :                 else
<span class="lineNum">    2225 </span><span class="lineNoCov">          0 :                         aname-&gt;build = 0;</span>
<span class="lineNum">    2226 </span><span class="lineCov">       8097 :                 if (version_parts == 4)</span>
<span class="lineNum">    2227 </span><span class="lineCov">       8097 :                         aname-&gt;revision = revision;</span>
<span class="lineNum">    2228 </span>            :                 else
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :                         aname-&gt;revision = 0;</span>
<span class="lineNum">    2230 </span><span class="lineCov">       8097 :         }</span>
<span class="lineNum">    2231 </span>            :         
<span class="lineNum">    2232 </span><span class="lineCov">      87233 :         aname-&gt;flags = flags;</span>
<span class="lineNum">    2233 </span><span class="lineCov">      87233 :         aname-&gt;arch = arch;</span>
<span class="lineNum">    2234 </span><span class="lineCov">      87233 :         aname-&gt;name = g_strdup (name);</span>
<span class="lineNum">    2235 </span>            :         
<span class="lineNum">    2236 </span><span class="lineCov">      87233 :         if (culture) {</span>
<span class="lineNum">    2237 </span><span class="lineCov">       8097 :                 if (g_ascii_strcasecmp (culture, &quot;neutral&quot;) == 0)</span>
<span class="lineNum">    2238 </span><span class="lineCov">       7797 :                         aname-&gt;culture = g_strdup (&quot;&quot;);</span>
<span class="lineNum">    2239 </span>            :                 else
<span class="lineNum">    2240 </span><span class="lineCov">        300 :                         aname-&gt;culture = g_strdup (culture);</span>
<span class="lineNum">    2241 </span><span class="lineCov">       8097 :         }</span>
<span class="lineNum">    2242 </span>            :         
<span class="lineNum">    2243 </span><span class="lineCov">      95331 :         if (token &amp;&amp; strncmp (token, &quot;null&quot;, 4) != 0) {</span>
<span class="lineNum">    2244 </span>            :                 char *lower;
<span class="lineNum">    2245 </span>            : 
<span class="lineNum">    2246 </span>            :                 /* the constant includes the ending NULL, hence the -1 */
<span class="lineNum">    2247 </span><span class="lineCov">       7513 :                 if (strlen (token) != (MONO_PUBLIC_KEY_TOKEN_LENGTH - 1)) {</span>
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :                         mono_assembly_name_free (aname);</span>
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :                         return FALSE;</span>
<span class="lineNum">    2250 </span>            :                 }
<span class="lineNum">    2251 </span><span class="lineCov">       7513 :                 lower = g_ascii_strdown (token, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    2252 </span><span class="lineCov">       7513 :                 g_strlcpy ((char*)aname-&gt;public_key_token, lower, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    2253 </span><span class="lineCov">       7513 :                 g_free (lower);</span>
<span class="lineNum">    2254 </span><span class="lineCov">       7513 :         }</span>
<span class="lineNum">    2255 </span>            : 
<span class="lineNum">    2256 </span><span class="lineCov">      87234 :         if (key) {</span>
<span class="lineNum">    2257 </span>            :                 gboolean is_ecma;
<span class="lineNum">    2258 </span><span class="lineCov">     148306 :                 if (strcmp (key, &quot;null&quot;) == 0 || !parse_public_key (key, &amp;pkey, &amp;is_ecma)) {</span>
<span class="lineNum">    2259 </span><span class="lineCov">          4 :                         mono_assembly_name_free (aname);</span>
<span class="lineNum">    2260 </span><span class="lineCov">          4 :                         return FALSE;</span>
<span class="lineNum">    2261 </span>            :                 }
<span class="lineNum">    2262 </span>            : 
<span class="lineNum">    2263 </span><span class="lineCov">      74149 :                 if (is_ecma) {</span>
<span class="lineNum">    2264 </span><span class="lineCov">      16433 :                         if (save_public_key)</span>
<span class="lineNum">    2265 </span><span class="lineCov">      16433 :                                 aname-&gt;public_key = (guint8*)pkey;</span>
<span class="lineNum">    2266 </span>            :                         else
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :                                 g_free (pkey);</span>
<span class="lineNum">    2268 </span><span class="lineCov">      16433 :                         g_strlcpy ((gchar*)aname-&gt;public_key_token, &quot;b77a5c561934e089&quot;, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    2269 </span><span class="lineCov">      16433 :                         return TRUE;</span>
<span class="lineNum">    2270 </span>            :                 }
<span class="lineNum">    2271 </span>            :                 
<span class="lineNum">    2272 </span><span class="lineCov">      57716 :                 len = mono_metadata_decode_blob_size ((const gchar *) pkey, (const gchar **) &amp;pkeyptr);</span>
<span class="lineNum">    2273 </span>            :                 // We also need to generate the key token
<span class="lineNum">    2274 </span><span class="lineCov">      57716 :                 mono_digest_get_public_token ((guchar*) tok, (guint8*) pkeyptr, len);</span>
<span class="lineNum">    2275 </span><span class="lineCov">      57716 :                 encoded = encode_public_tok ((guchar*) tok, 8);</span>
<span class="lineNum">    2276 </span><span class="lineCov">      57716 :                 g_strlcpy ((gchar*)aname-&gt;public_key_token, encoded, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    2277 </span><span class="lineCov">      57716 :                 g_free (encoded);</span>
<span class="lineNum">    2278 </span>            : 
<span class="lineNum">    2279 </span><span class="lineCov">      57716 :                 if (save_public_key)</span>
<span class="lineNum">    2280 </span><span class="lineCov">      57716 :                         aname-&gt;public_key = (guint8*) pkey;</span>
<span class="lineNum">    2281 </span>            :                 else
<span class="lineNum">    2282 </span><span class="lineNoCov">          0 :                         g_free (pkey);</span>
<span class="lineNum">    2283 </span><span class="lineCov">      57716 :         }</span>
<span class="lineNum">    2284 </span>            : 
<span class="lineNum">    2285 </span><span class="lineCov">      70797 :         return TRUE;</span>
<span class="lineNum">    2286 </span><span class="lineCov">      87234 : }</span>
<a name="2287"><span class="lineNum">    2287 </span>            : </a>
<span class="lineNum">    2288 </span>            : static gboolean
<span class="lineNum">    2289 </span>            : parse_assembly_directory_name (const char *name, const char *dirname, MonoAssemblyName *aname)
<span class="lineNum">    2290 </span>            : {
<span class="lineNum">    2291 </span>            :         gchar **parts;
<span class="lineNum">    2292 </span>            :         gboolean res;
<span class="lineNum">    2293 </span>            :         
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :         parts = g_strsplit (dirname, &quot;_&quot;, 3);</span>
<span class="lineNum">    2295 </span><span class="lineNoCov">          0 :         if (!parts || !parts[0] || !parts[1] || !parts[2]) {</span>
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :                 g_strfreev (parts);</span>
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2298 </span>            :         }
<span class="lineNum">    2299 </span>            :         
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :         res = build_assembly_name (name, parts[0], parts[1], parts[2], NULL, 0, 0, aname, FALSE);</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :         g_strfreev (parts);</span>
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :         return res;</span>
<span class="lineNum">    2303 </span><span class="lineNoCov">          0 : }</span>
<a name="2304"><span class="lineNum">    2304 </span>            : </a>
<span class="lineNum">    2305 </span>            : static gboolean
<span class="lineNum">    2306 </span>            : split_key_value (const gchar *pair, gchar **key, guint32 *keylen, gchar **value)
<span class="lineNum">    2307 </span>            : {
<span class="lineNum">    2308 </span><span class="lineCov">      98444 :         char *eqsign = strchr (pair, '=');</span>
<span class="lineNum">    2309 </span><span class="lineCov">      98444 :         if (!eqsign) {</span>
<span class="lineNum">    2310 </span><span class="lineNoCov">          0 :                 *key = NULL;</span>
<span class="lineNum">    2311 </span><span class="lineNoCov">          0 :                 *keylen = 0;</span>
<span class="lineNum">    2312 </span><span class="lineNoCov">          0 :                 *value = NULL;</span>
<span class="lineNum">    2313 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2314 </span>            :         }
<span class="lineNum">    2315 </span>            : 
<span class="lineNum">    2316 </span><span class="lineCov">      98444 :         *key = (gchar*)pair;</span>
<span class="lineNum">    2317 </span><span class="lineCov">      98444 :         *keylen = eqsign - *key;</span>
<span class="lineNum">    2318 </span><span class="lineCov">     393776 :         while (*keylen &gt; 0 &amp;&amp; g_ascii_isspace ((*key) [*keylen - 1]))</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :                 (*keylen)--;</span>
<span class="lineNum">    2320 </span><span class="lineCov">      98444 :         *value = g_strstrip (eqsign + 1);</span>
<span class="lineNum">    2321 </span><span class="lineCov">      98444 :         return TRUE;</span>
<span class="lineNum">    2322 </span><span class="lineCov">      98444 : }</span>
<a name="2323"><span class="lineNum">    2323 </span>            : </a>
<span class="lineNum">    2324 </span>            : gboolean
<span class="lineNum">    2325 </span>            : mono_assembly_name_parse_full (const char *name, MonoAssemblyName *aname, gboolean save_public_key, gboolean *is_version_defined, gboolean *is_token_defined)
<span class="lineNum">    2326 </span>            : {
<span class="lineNum">    2327 </span>            :         gchar *dllname;
<span class="lineNum">    2328 </span>            :         gchar *dllname_uq;
<span class="lineNum">    2329 </span><span class="lineCov">      87234 :         gchar *version = NULL;</span>
<span class="lineNum">    2330 </span>            :         gchar *version_uq;
<span class="lineNum">    2331 </span><span class="lineCov">      87234 :         gchar *culture = NULL;</span>
<span class="lineNum">    2332 </span>            :         gchar *culture_uq;
<span class="lineNum">    2333 </span><span class="lineCov">      87234 :         gchar *token = NULL;</span>
<span class="lineNum">    2334 </span>            :         gchar *token_uq;
<span class="lineNum">    2335 </span><span class="lineCov">      87234 :         gchar *key = NULL;</span>
<span class="lineNum">    2336 </span>            :         gchar *key_uq;
<span class="lineNum">    2337 </span><span class="lineCov">      87234 :         gchar *retargetable = NULL;</span>
<span class="lineNum">    2338 </span>            :         gchar *retargetable_uq;
<span class="lineNum">    2339 </span>            :         gchar *procarch;
<span class="lineNum">    2340 </span>            :         gchar *procarch_uq;
<span class="lineNum">    2341 </span>            :         gboolean res;
<span class="lineNum">    2342 </span>            :         gchar *value, *part_name;
<span class="lineNum">    2343 </span>            :         guint32 part_name_len;
<span class="lineNum">    2344 </span>            :         gchar **parts;
<span class="lineNum">    2345 </span>            :         gchar **tmp;
<span class="lineNum">    2346 </span>            :         gboolean version_defined;
<span class="lineNum">    2347 </span>            :         gboolean token_defined;
<span class="lineNum">    2348 </span><span class="lineCov">      87234 :         guint32 flags = 0;</span>
<span class="lineNum">    2349 </span><span class="lineCov">      87234 :         guint32 arch = MONO_PROCESSOR_ARCHITECTURE_NONE;</span>
<span class="lineNum">    2350 </span>            : 
<span class="lineNum">    2351 </span><span class="lineCov">      87234 :         if (!is_version_defined)</span>
<span class="lineNum">    2352 </span><span class="lineCov">      83649 :                 is_version_defined = &amp;version_defined;</span>
<span class="lineNum">    2353 </span><span class="lineCov">      87234 :         *is_version_defined = FALSE;</span>
<span class="lineNum">    2354 </span><span class="lineCov">      87234 :         if (!is_token_defined)</span>
<span class="lineNum">    2355 </span><span class="lineCov">      83649 :                 is_token_defined = &amp;token_defined;</span>
<span class="lineNum">    2356 </span><span class="lineCov">      87234 :         *is_token_defined = FALSE;</span>
<span class="lineNum">    2357 </span>            :         
<span class="lineNum">    2358 </span><span class="lineCov">      87234 :         parts = tmp = g_strsplit (name, &quot;,&quot;, 6);</span>
<span class="lineNum">    2359 </span><span class="lineCov">     174468 :         if (!tmp || !*tmp) {</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :                 g_strfreev (tmp);</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2362 </span>            :         }
<span class="lineNum">    2363 </span>            : 
<span class="lineNum">    2364 </span><span class="lineCov">      87234 :         dllname = g_strstrip (*tmp);</span>
<span class="lineNum">    2365 </span>            :         
<span class="lineNum">    2366 </span><span class="lineCov">      87234 :         tmp++;</span>
<span class="lineNum">    2367 </span>            : 
<span class="lineNum">    2368 </span><span class="lineCov">     272912 :         while (*tmp) {</span>
<span class="lineNum">    2369 </span><span class="lineCov">      98444 :                 if (!split_key_value (g_strstrip (*tmp), &amp;part_name, &amp;part_name_len, &amp;value))</span>
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :                         goto cleanup_and_fail;</span>
<span class="lineNum">    2371 </span>            : 
<span class="lineNum">    2372 </span><span class="lineCov">     114638 :                 if (part_name_len == 7 &amp;&amp; !g_ascii_strncasecmp (part_name, &quot;Version&quot;, part_name_len)) {</span>
<span class="lineNum">    2373 </span><span class="lineCov">       8097 :                         *is_version_defined = TRUE;</span>
<span class="lineNum">    2374 </span><span class="lineCov">       8097 :                         version = value;</span>
<span class="lineNum">    2375 </span><span class="lineCov">       8097 :                         if (strlen (version) == 0) {</span>
<span class="lineNum">    2376 </span><span class="lineNoCov">          0 :                                 goto cleanup_and_fail;</span>
<span class="lineNum">    2377 </span>            :                         }
<span class="lineNum">    2378 </span><span class="lineCov">       8097 :                         tmp++;</span>
<span class="lineNum">    2379 </span><span class="lineCov">       8097 :                         continue;</span>
<span class="lineNum">    2380 </span>            :                 }
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span><span class="lineCov">      98444 :                 if (part_name_len == 7 &amp;&amp; !g_ascii_strncasecmp (part_name, &quot;Culture&quot;, part_name_len)) {</span>
<span class="lineNum">    2383 </span><span class="lineCov">       8097 :                         culture = value;</span>
<span class="lineNum">    2384 </span><span class="lineCov">       8097 :                         if (strlen (culture) == 0) {</span>
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :                                 goto cleanup_and_fail;</span>
<span class="lineNum">    2386 </span>            :                         }
<span class="lineNum">    2387 </span><span class="lineCov">       8097 :                         tmp++;</span>
<span class="lineNum">    2388 </span><span class="lineCov">       8097 :                         continue;</span>
<span class="lineNum">    2389 </span>            :                 }
<span class="lineNum">    2390 </span>            : 
<span class="lineNum">    2391 </span><span class="lineCov">      90347 :                 if (part_name_len == 14 &amp;&amp; !g_ascii_strncasecmp (part_name, &quot;PublicKeyToken&quot;, part_name_len)) {</span>
<span class="lineNum">    2392 </span><span class="lineCov">       8097 :                         *is_token_defined = TRUE;</span>
<span class="lineNum">    2393 </span><span class="lineCov">       8097 :                         token = value;</span>
<span class="lineNum">    2394 </span><span class="lineCov">       8097 :                         if (strlen (token) == 0) {</span>
<span class="lineNum">    2395 </span><span class="lineNoCov">          0 :                                 goto cleanup_and_fail;</span>
<span class="lineNum">    2396 </span>            :                         }
<span class="lineNum">    2397 </span><span class="lineCov">       8097 :                         tmp++;</span>
<span class="lineNum">    2398 </span><span class="lineCov">       8097 :                         continue;</span>
<span class="lineNum">    2399 </span>            :                 }
<span class="lineNum">    2400 </span>            : 
<span class="lineNum">    2401 </span><span class="lineCov">     148306 :                 if (part_name_len == 9 &amp;&amp; !g_ascii_strncasecmp (part_name, &quot;PublicKey&quot;, part_name_len)) {</span>
<span class="lineNum">    2402 </span><span class="lineCov">      74153 :                         key = value;</span>
<span class="lineNum">    2403 </span><span class="lineCov">      74153 :                         if (strlen (key) == 0) {</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :                                 goto cleanup_and_fail;</span>
<span class="lineNum">    2405 </span>            :                         }
<span class="lineNum">    2406 </span><span class="lineCov">      74153 :                         tmp++;</span>
<span class="lineNum">    2407 </span><span class="lineCov">      74153 :                         continue;</span>
<span class="lineNum">    2408 </span>            :                 }
<span class="lineNum">    2409 </span>            : 
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :                 if (part_name_len == 12 &amp;&amp; !g_ascii_strncasecmp (part_name, &quot;Retargetable&quot;, part_name_len)) {</span>
<span class="lineNum">    2411 </span><span class="lineNoCov">          0 :                         retargetable = value;</span>
<span class="lineNum">    2412 </span><span class="lineNoCov">          0 :                         retargetable_uq = unquote (retargetable);</span>
<span class="lineNum">    2413 </span><span class="lineNoCov">          0 :                         if (retargetable_uq != NULL)</span>
<span class="lineNum">    2414 </span><span class="lineNoCov">          0 :                                 retargetable = retargetable_uq;</span>
<span class="lineNum">    2415 </span>            : 
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :                         if (!g_ascii_strcasecmp (retargetable, &quot;yes&quot;)) {</span>
<span class="lineNum">    2417 </span><span class="lineNoCov">          0 :                                 flags |= ASSEMBLYREF_RETARGETABLE_FLAG;</span>
<span class="lineNum">    2418 </span><span class="lineNoCov">          0 :                         } else if (g_ascii_strcasecmp (retargetable, &quot;no&quot;)) {</span>
<span class="lineNum">    2419 </span><span class="lineNoCov">          0 :                                 g_free (retargetable_uq);</span>
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :                                 goto cleanup_and_fail;</span>
<span class="lineNum">    2421 </span>            :                         }
<span class="lineNum">    2422 </span>            : 
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :                         g_free (retargetable_uq);</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :                         tmp++;</span>
<span class="lineNum">    2425 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2426 </span>            :                 }
<span class="lineNum">    2427 </span>            : 
<span class="lineNum">    2428 </span><span class="lineNoCov">          0 :                 if (part_name_len == 21 &amp;&amp; !g_ascii_strncasecmp (part_name, &quot;ProcessorArchitecture&quot;, part_name_len)) {</span>
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :                         procarch = value;</span>
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :                         procarch_uq = unquote (procarch);</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :                         if (procarch_uq != NULL)</span>
<span class="lineNum">    2432 </span><span class="lineNoCov">          0 :                                 procarch = procarch_uq;</span>
<span class="lineNum">    2433 </span>            : 
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :                         if (!g_ascii_strcasecmp (procarch, &quot;MSIL&quot;))</span>
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :                                 arch = MONO_PROCESSOR_ARCHITECTURE_MSIL;</span>
<span class="lineNum">    2436 </span><span class="lineNoCov">          0 :                         else if (!g_ascii_strcasecmp (procarch, &quot;X86&quot;))</span>
<span class="lineNum">    2437 </span><span class="lineNoCov">          0 :                                 arch = MONO_PROCESSOR_ARCHITECTURE_X86;</span>
<span class="lineNum">    2438 </span><span class="lineNoCov">          0 :                         else if (!g_ascii_strcasecmp (procarch, &quot;IA64&quot;))</span>
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :                                 arch = MONO_PROCESSOR_ARCHITECTURE_IA64;</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :                         else if (!g_ascii_strcasecmp (procarch, &quot;AMD64&quot;))</span>
<span class="lineNum">    2441 </span><span class="lineNoCov">          0 :                                 arch = MONO_PROCESSOR_ARCHITECTURE_AMD64;</span>
<span class="lineNum">    2442 </span>            :                         else {
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :                                 g_free (procarch_uq);</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :                                 goto cleanup_and_fail;</span>
<span class="lineNum">    2445 </span>            :                         }
<span class="lineNum">    2446 </span>            : 
<span class="lineNum">    2447 </span><span class="lineNoCov">          0 :                         g_free (procarch_uq);</span>
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :                         tmp++;</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2450 </span>            :                 }
<span class="lineNum">    2451 </span>            : 
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 :                 g_strfreev (parts);</span>
<span class="lineNum">    2453 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2454 </span>            :         }
<span class="lineNum">    2455 </span>            : 
<span class="lineNum">    2456 </span>            :         /* if retargetable flag is set, then we must have a fully qualified name */
<span class="lineNum">    2457 </span><span class="lineCov">      87234 :         if (retargetable != NULL &amp;&amp; (version == NULL || culture == NULL || (key == NULL &amp;&amp; token == NULL))) {</span>
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :                 goto cleanup_and_fail;</span>
<span class="lineNum">    2459 </span>            :         }
<span class="lineNum">    2460 </span>            : 
<span class="lineNum">    2461 </span><span class="lineCov">      87234 :         dllname_uq = unquote (dllname);</span>
<span class="lineNum">    2462 </span><span class="lineCov">      87234 :         version_uq = unquote (version);</span>
<span class="lineNum">    2463 </span><span class="lineCov">      87234 :         culture_uq = unquote (culture);</span>
<span class="lineNum">    2464 </span><span class="lineCov">      87234 :         token_uq = unquote (token);</span>
<span class="lineNum">    2465 </span><span class="lineCov">      87234 :         key_uq = unquote (key);</span>
<span class="lineNum">    2466 </span>            : 
<span class="lineNum">    2467 </span><span class="lineCov">      87234 :         res = build_assembly_name (</span>
<span class="lineNum">    2468 </span><span class="lineCov">     261702 :                 dllname_uq == NULL ? dllname : dllname_uq,</span>
<span class="lineNum">    2469 </span><span class="lineCov">     261702 :                 version_uq == NULL ? version : version_uq,</span>
<span class="lineNum">    2470 </span><span class="lineCov">     261702 :                 culture_uq == NULL ? culture : culture_uq,</span>
<span class="lineNum">    2471 </span><span class="lineCov">     261702 :                 token_uq == NULL ? token : token_uq,</span>
<span class="lineNum">    2472 </span><span class="lineCov">     261702 :                 key_uq == NULL ? key : key_uq,</span>
<span class="lineNum">    2473 </span><span class="lineCov">      87234 :                 flags, arch, aname, save_public_key);</span>
<span class="lineNum">    2474 </span>            : 
<span class="lineNum">    2475 </span><span class="lineCov">      87234 :         g_free (dllname_uq);</span>
<span class="lineNum">    2476 </span><span class="lineCov">      87234 :         g_free (version_uq);</span>
<span class="lineNum">    2477 </span><span class="lineCov">      87234 :         g_free (culture_uq);</span>
<span class="lineNum">    2478 </span><span class="lineCov">      87234 :         g_free (token_uq);</span>
<span class="lineNum">    2479 </span><span class="lineCov">      87234 :         g_free (key_uq);</span>
<span class="lineNum">    2480 </span>            : 
<span class="lineNum">    2481 </span><span class="lineCov">      87234 :         g_strfreev (parts);</span>
<span class="lineNum">    2482 </span><span class="lineCov">      87234 :         return res;</span>
<span class="lineNum">    2483 </span>            : 
<span class="lineNum">    2484 </span>            : cleanup_and_fail:
<span class="lineNum">    2485 </span><span class="lineNoCov">          0 :         g_strfreev (parts);</span>
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">    2487 </span><span class="lineCov">      87234 : }</span>
<a name="2488"><span class="lineNum">    2488 </span>            : </a>
<span class="lineNum">    2489 </span>            : static char*
<span class="lineNum">    2490 </span>            : unquote (const char *str)
<span class="lineNum">    2491 </span>            : {
<span class="lineNum">    2492 </span>            :         gint slen;
<span class="lineNum">    2493 </span>            :         const char *end;
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span><span class="lineCov">     436168 :         if (str == NULL)</span>
<span class="lineNum">    2496 </span><span class="lineCov">     250492 :                 return NULL;</span>
<span class="lineNum">    2497 </span>            : 
<span class="lineNum">    2498 </span><span class="lineCov">     185675 :         slen = strlen (str);</span>
<span class="lineNum">    2499 </span><span class="lineCov">     185675 :         if (slen &lt; 2)</span>
<span class="lineNum">    2500 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2501 </span>            : 
<span class="lineNum">    2502 </span><span class="lineCov">     371350 :         if (*str != '\'' &amp;&amp; *str != '\&quot;')</span>
<span class="lineNum">    2503 </span><span class="lineCov">     185675 :                 return NULL;</span>
<span class="lineNum">    2504 </span>            : 
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :         end = str + slen - 1;</span>
<span class="lineNum">    2506 </span><span class="lineNoCov">          0 :         if (*str != *end)</span>
<span class="lineNum">    2507 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2508 </span>            : 
<span class="lineNum">    2509 </span><span class="lineNoCov">          0 :         return g_strndup (str + 1, slen - 2);</span>
<span class="lineNum">    2510 </span><span class="lineCov">     436166 : }</span>
<span class="lineNum">    2511 </span>            : 
<span class="lineNum">    2512 </span>            : /**
<span class="lineNum">    2513 </span>            :  * mono_assembly_name_parse:
<span class="lineNum">    2514 </span>            :  * @name: name to parse
<span class="lineNum">    2515 </span>            :  * @aname: the destination assembly name
<span class="lineNum">    2516 </span>            :  * 
<span class="lineNum">    2517 </span>            :  * Parses an assembly qualified type name and assigns the name,
<span class="lineNum">    2518 </span>            :  * version, culture and token to the provided assembly name object.
<span class="lineNum">    2519 </span>            :  *
<span class="lineNum">    2520 </span>            :  * Returns: TRUE if the name could be parsed.
<a name="2521"><span class="lineNum">    2521 </span>            :  */</a>
<span class="lineNum">    2522 </span>            : gboolean
<span class="lineNum">    2523 </span>            : mono_assembly_name_parse (const char *name, MonoAssemblyName *aname)
<span class="lineNum">    2524 </span>            : {
<span class="lineNum">    2525 </span><span class="lineCov">       9496 :         return mono_assembly_name_parse_full (name, aname, FALSE, NULL, NULL);</span>
<span class="lineNum">    2526 </span>            : }
<span class="lineNum">    2527 </span>            : 
<span class="lineNum">    2528 </span>            : /**
<span class="lineNum">    2529 </span>            :  * mono_assembly_name_new:
<span class="lineNum">    2530 </span>            :  * @name: name to parse
<span class="lineNum">    2531 </span>            :  *
<span class="lineNum">    2532 </span>            :  * Allocate a new MonoAssemblyName and fill its values from the
<span class="lineNum">    2533 </span>            :  * passed @name.
<span class="lineNum">    2534 </span>            :  *
<span class="lineNum">    2535 </span>            :  * Returns: a newly allocated structure or NULL if there was any failure.
<a name="2536"><span class="lineNum">    2536 </span>            :  */</a>
<span class="lineNum">    2537 </span>            : MonoAssemblyName*
<span class="lineNum">    2538 </span>            : mono_assembly_name_new (const char *name)
<span class="lineNum">    2539 </span>            : {
<span class="lineNum">    2540 </span><span class="lineCov">       4940 :         MonoAssemblyName *aname = g_new0 (MonoAssemblyName, 1);</span>
<span class="lineNum">    2541 </span><span class="lineCov">       4940 :         if (mono_assembly_name_parse (name, aname))</span>
<span class="lineNum">    2542 </span><span class="lineCov">       4940 :                 return aname;</span>
<span class="lineNum">    2543 </span><span class="lineNoCov">          0 :         g_free (aname);</span>
<span class="lineNum">    2544 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    2545 </span><span class="lineCov">       4940 : }</span>
<a name="2546"><span class="lineNum">    2546 </span>            : </a>
<span class="lineNum">    2547 </span>            : const char*
<span class="lineNum">    2548 </span>            : mono_assembly_name_get_name (MonoAssemblyName *aname)
<span class="lineNum">    2549 </span>            : {
<span class="lineNum">    2550 </span><span class="lineNoCov">          0 :         return aname-&gt;name;</span>
<span class="lineNum">    2551 </span>            : }
<a name="2552"><span class="lineNum">    2552 </span>            : </a>
<span class="lineNum">    2553 </span>            : const char*
<span class="lineNum">    2554 </span>            : mono_assembly_name_get_culture (MonoAssemblyName *aname)
<span class="lineNum">    2555 </span>            : {
<span class="lineNum">    2556 </span><span class="lineNoCov">          0 :         return aname-&gt;culture;</span>
<span class="lineNum">    2557 </span>            : }
<a name="2558"><span class="lineNum">    2558 </span>            : </a>
<span class="lineNum">    2559 </span>            : mono_byte*
<span class="lineNum">    2560 </span>            : mono_assembly_name_get_pubkeytoken (MonoAssemblyName *aname)
<span class="lineNum">    2561 </span>            : {
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :         if (aname-&gt;public_key_token [0])</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :                 return aname-&gt;public_key_token;</span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 : }</span>
<a name="2566"><span class="lineNum">    2566 </span>            : </a>
<span class="lineNum">    2567 </span>            : uint16_t
<span class="lineNum">    2568 </span>            : mono_assembly_name_get_version (MonoAssemblyName *aname, uint16_t *minor, uint16_t *build, uint16_t *revision)
<span class="lineNum">    2569 </span>            : {
<span class="lineNum">    2570 </span><span class="lineNoCov">          0 :         if (minor)</span>
<span class="lineNum">    2571 </span><span class="lineNoCov">          0 :                 *minor = aname-&gt;minor;</span>
<span class="lineNum">    2572 </span><span class="lineNoCov">          0 :         if (build)</span>
<span class="lineNum">    2573 </span><span class="lineNoCov">          0 :                 *build = aname-&gt;build;</span>
<span class="lineNum">    2574 </span><span class="lineNoCov">          0 :         if (revision)</span>
<span class="lineNum">    2575 </span><span class="lineNoCov">          0 :                 *revision = aname-&gt;revision;</span>
<span class="lineNum">    2576 </span><span class="lineNoCov">          0 :         return aname-&gt;major;</span>
<span class="lineNum">    2577 </span>            : }
<a name="2578"><span class="lineNum">    2578 </span>            : </a>
<span class="lineNum">    2579 </span>            : static MonoAssembly*
<span class="lineNum">    2580 </span>            : probe_for_partial_name (const char *basepath, const char *fullname, MonoAssemblyName *aname, MonoImageOpenStatus *status)
<span class="lineNum">    2581 </span>            : {
<span class="lineNum">    2582 </span><span class="lineCov">          5 :         gchar *fullpath = NULL;</span>
<span class="lineNum">    2583 </span>            :         GDir *dirhandle;
<span class="lineNum">    2584 </span>            :         const char* direntry;
<span class="lineNum">    2585 </span>            :         MonoAssemblyName gac_aname;
<span class="lineNum">    2586 </span><span class="lineCov">          5 :         gint major=-1, minor=0, build=0, revision=0;</span>
<span class="lineNum">    2587 </span>            :         gboolean exact_version;
<span class="lineNum">    2588 </span>            :         
<span class="lineNum">    2589 </span><span class="lineCov">          5 :         dirhandle = g_dir_open (basepath, 0, NULL);</span>
<span class="lineNum">    2590 </span><span class="lineCov">          5 :         if (!dirhandle)</span>
<span class="lineNum">    2591 </span><span class="lineCov">          5 :                 return NULL;</span>
<span class="lineNum">    2592 </span>            :                 
<span class="lineNum">    2593 </span><span class="lineNoCov">          0 :         exact_version = (aname-&gt;major | aname-&gt;minor | aname-&gt;build | aname-&gt;revision) != 0;</span>
<span class="lineNum">    2594 </span>            : 
<span class="lineNum">    2595 </span><span class="lineNoCov">          0 :         while ((direntry = g_dir_read_name (dirhandle))) {</span>
<span class="lineNum">    2596 </span><span class="lineNoCov">          0 :                 gboolean match = TRUE;</span>
<span class="lineNum">    2597 </span>            :                 
<span class="lineNum">    2598 </span><span class="lineNoCov">          0 :                 if(!parse_assembly_directory_name (aname-&gt;name, direntry, &amp;gac_aname))</span>
<span class="lineNum">    2599 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2600 </span>            :                 
<span class="lineNum">    2601 </span><span class="lineNoCov">          0 :                 if (aname-&gt;culture != NULL &amp;&amp; strcmp (aname-&gt;culture, gac_aname.culture) != 0)</span>
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 :                         match = FALSE;</span>
<span class="lineNum">    2603 </span>            :                         
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :                 if (match &amp;&amp; strlen ((char*)aname-&gt;public_key_token) &gt; 0 &amp;&amp; </span>
<span class="lineNum">    2605 </span><span class="lineNoCov">          0 :                                 !mono_public_tokens_are_equal (aname-&gt;public_key_token, gac_aname.public_key_token))</span>
<span class="lineNum">    2606 </span><span class="lineNoCov">          0 :                         match = FALSE;</span>
<span class="lineNum">    2607 </span>            :                 
<span class="lineNum">    2608 </span><span class="lineNoCov">          0 :                 if (match) {</span>
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :                         if (exact_version) {</span>
<span class="lineNum">    2610 </span><span class="lineNoCov">          0 :                                 match = (aname-&gt;major == gac_aname.major &amp;&amp; aname-&gt;minor == gac_aname.minor &amp;&amp;</span>
<span class="lineNum">    2611 </span><span class="lineNoCov">          0 :                                                  aname-&gt;build == gac_aname.build &amp;&amp; aname-&gt;revision == gac_aname.revision); </span>
<span class="lineNum">    2612 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 :                         else if (gac_aname.major &lt; major)</span>
<span class="lineNum">    2614 </span><span class="lineNoCov">          0 :                                 match = FALSE;</span>
<span class="lineNum">    2615 </span><span class="lineNoCov">          0 :                         else if (gac_aname.major == major) {</span>
<span class="lineNum">    2616 </span><span class="lineNoCov">          0 :                                 if (gac_aname.minor &lt; minor)</span>
<span class="lineNum">    2617 </span><span class="lineNoCov">          0 :                                         match = FALSE;</span>
<span class="lineNum">    2618 </span><span class="lineNoCov">          0 :                                 else if (gac_aname.minor == minor) {</span>
<span class="lineNum">    2619 </span><span class="lineNoCov">          0 :                                         if (gac_aname.build &lt; build)</span>
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :                                                 match = FALSE;</span>
<span class="lineNum">    2621 </span><span class="lineNoCov">          0 :                                         else if (gac_aname.build == build &amp;&amp; gac_aname.revision &lt;= revision)</span>
<span class="lineNum">    2622 </span><span class="lineNoCov">          0 :                                                 match = FALSE; </span>
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">    2624 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    2625 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2626 </span>            :                 
<span class="lineNum">    2627 </span><span class="lineNoCov">          0 :                 if (match) {</span>
<span class="lineNum">    2628 </span><span class="lineNoCov">          0 :                         major = gac_aname.major;</span>
<span class="lineNum">    2629 </span><span class="lineNoCov">          0 :                         minor = gac_aname.minor;</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :                         build = gac_aname.build;</span>
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :                         revision = gac_aname.revision;</span>
<span class="lineNum">    2632 </span><span class="lineNoCov">          0 :                         g_free (fullpath);</span>
<span class="lineNum">    2633 </span><span class="lineNoCov">          0 :                         fullpath = g_build_path (G_DIR_SEPARATOR_S, basepath, direntry, fullname, NULL);</span>
<span class="lineNum">    2634 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2635 </span>            : 
<span class="lineNum">    2636 </span><span class="lineNoCov">          0 :                 mono_assembly_name_free (&amp;gac_aname);</span>
<span class="lineNum">    2637 </span>            :         }
<span class="lineNum">    2638 </span>            :         
<span class="lineNum">    2639 </span><span class="lineNoCov">          0 :         g_dir_close (dirhandle);</span>
<span class="lineNum">    2640 </span>            :         
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 :         if (fullpath == NULL)</span>
<span class="lineNum">    2642 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2643 </span>            :         else {
<span class="lineNum">    2644 </span><span class="lineNoCov">          0 :                 MonoAssembly *res = mono_assembly_open (fullpath, status);</span>
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :                 g_free (fullpath);</span>
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    2647 </span>            :         }
<span class="lineNum">    2648 </span><span class="lineCov">          5 : }</span>
<span class="lineNum">    2649 </span>            : 
<span class="lineNum">    2650 </span>            : /**
<span class="lineNum">    2651 </span>            :  * mono_assembly_load_with_partial_name:
<span class="lineNum">    2652 </span>            :  * @name: an assembly name that is then parsed by `api:mono_assembly_name_parse`.
<span class="lineNum">    2653 </span>            :  * @status: return status code
<span class="lineNum">    2654 </span>            :  *
<span class="lineNum">    2655 </span>            :  * Loads a Mono Assembly from a name.  The name is parsed using `api:mono_assembly_name_parse`,
<span class="lineNum">    2656 </span>            :  * so it might contain a qualified type name, version, culture and token.
<span class="lineNum">    2657 </span>            :  *
<span class="lineNum">    2658 </span>            :  * This will load the assembly from the file whose name is derived from the assembly name
<span class="lineNum">    2659 </span>            :  * by appending the .dll extension.
<span class="lineNum">    2660 </span>            :  *
<span class="lineNum">    2661 </span>            :  * The assembly is loaded from either one of the extra Global Assembly Caches specified
<span class="lineNum">    2662 </span>            :  * by the extra GAC paths (specified by the `MONO_GAC_PREFIX` environment variable) or
<span class="lineNum">    2663 </span>            :  * if that fails from the GAC.
<span class="lineNum">    2664 </span>            :  *
<span class="lineNum">    2665 </span>            :  * Returns: NULL on failure, or a pointer to a MonoAssembly on success.   
<a name="2666"><span class="lineNum">    2666 </span>            :  */</a>
<span class="lineNum">    2667 </span>            : MonoAssembly*
<span class="lineNum">    2668 </span>            : mono_assembly_load_with_partial_name (const char *name, MonoImageOpenStatus *status)
<span class="lineNum">    2669 </span>            : {
<span class="lineNum">    2670 </span>            :         MonoError error;
<span class="lineNum">    2671 </span>            :         MonoAssembly *res;
<span class="lineNum">    2672 </span>            :         MonoAssemblyName *aname, base_name;
<span class="lineNum">    2673 </span>            :         MonoAssemblyName mapped_aname;
<span class="lineNum">    2674 </span>            :         gchar *fullname, *gacpath;
<span class="lineNum">    2675 </span>            :         gchar **paths;
<span class="lineNum">    2676 </span>            : 
<span class="lineNum">    2677 </span><span class="lineCov">       2811 :         memset (&amp;base_name, 0, sizeof (MonoAssemblyName));</span>
<span class="lineNum">    2678 </span><span class="lineCov">       2811 :         aname = &amp;base_name;</span>
<span class="lineNum">    2679 </span>            : 
<span class="lineNum">    2680 </span><span class="lineCov">       2811 :         if (!mono_assembly_name_parse (name, aname))</span>
<span class="lineNum">    2681 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    2682 </span>            : 
<span class="lineNum">    2683 </span>            :         /* 
<span class="lineNum">    2684 </span>            :          * If no specific version has been requested, make sure we load the
<span class="lineNum">    2685 </span>            :          * correct version for system assemblies.
<span class="lineNum">    2686 </span>            :          */ 
<span class="lineNum">    2687 </span><span class="lineCov">       2811 :         if ((aname-&gt;major | aname-&gt;minor | aname-&gt;build | aname-&gt;revision) == 0)</span>
<span class="lineNum">    2688 </span><span class="lineCov">          7 :                 aname = mono_assembly_remap_version (aname, &amp;mapped_aname);</span>
<span class="lineNum">    2689 </span>            :         
<span class="lineNum">    2690 </span><span class="lineCov">       2811 :         res = mono_assembly_loaded (aname);</span>
<span class="lineNum">    2691 </span><span class="lineCov">       2811 :         if (res) {</span>
<span class="lineNum">    2692 </span><span class="lineCov">       2806 :                 mono_assembly_name_free (aname);</span>
<span class="lineNum">    2693 </span><span class="lineCov">       2806 :                 return res;</span>
<span class="lineNum">    2694 </span>            :         }
<span class="lineNum">    2695 </span>            : 
<span class="lineNum">    2696 </span><span class="lineCov">          5 :         res = invoke_assembly_preload_hook (aname, assemblies_path);</span>
<span class="lineNum">    2697 </span><span class="lineCov">          5 :         if (res) {</span>
<span class="lineNum">    2698 </span><span class="lineNoCov">          0 :                 res-&gt;in_gac = FALSE;</span>
<span class="lineNum">    2699 </span><span class="lineNoCov">          0 :                 mono_assembly_name_free (aname);</span>
<span class="lineNum">    2700 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    2701 </span>            :         }
<span class="lineNum">    2702 </span>            : 
<span class="lineNum">    2703 </span><span class="lineCov">          5 :         fullname = g_strdup_printf (&quot;%s.dll&quot;, aname-&gt;name);</span>
<span class="lineNum">    2704 </span>            : 
<span class="lineNum">    2705 </span><span class="lineCov">          5 :         if (extra_gac_paths) {</span>
<span class="lineNum">    2706 </span><span class="lineNoCov">          0 :                 paths = extra_gac_paths;</span>
<span class="lineNum">    2707 </span><span class="lineNoCov">          0 :                 while (!res &amp;&amp; *paths) {</span>
<span class="lineNum">    2708 </span><span class="lineNoCov">          0 :                         gacpath = g_build_path (G_DIR_SEPARATOR_S, *paths, &quot;lib&quot;, &quot;mono&quot;, &quot;gac&quot;, aname-&gt;name, NULL);</span>
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :                         res = probe_for_partial_name (gacpath, fullname, aname, status);</span>
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 :                         g_free (gacpath);</span>
<span class="lineNum">    2711 </span><span class="lineNoCov">          0 :                         paths++;</span>
<span class="lineNum">    2712 </span>            :                 }
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2714 </span>            : 
<span class="lineNum">    2715 </span><span class="lineCov">          5 :         if (res) {</span>
<span class="lineNum">    2716 </span><span class="lineNoCov">          0 :                 res-&gt;in_gac = TRUE;</span>
<span class="lineNum">    2717 </span><span class="lineNoCov">          0 :                 g_free (fullname);</span>
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :                 mono_assembly_name_free (aname);</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :                 return res;</span>
<span class="lineNum">    2720 </span>            :         }
<span class="lineNum">    2721 </span>            : 
<span class="lineNum">    2722 </span><span class="lineCov">          5 :         gacpath = g_build_path (G_DIR_SEPARATOR_S, mono_assembly_getrootdir (), &quot;mono&quot;, &quot;gac&quot;, aname-&gt;name, NULL);</span>
<span class="lineNum">    2723 </span><span class="lineCov">          5 :         res = probe_for_partial_name (gacpath, fullname, aname, status);</span>
<span class="lineNum">    2724 </span><span class="lineCov">          5 :         g_free (gacpath);</span>
<span class="lineNum">    2725 </span>            : 
<span class="lineNum">    2726 </span><span class="lineCov">          5 :         g_free (fullname);</span>
<span class="lineNum">    2727 </span><span class="lineCov">          5 :         mono_assembly_name_free (aname);</span>
<span class="lineNum">    2728 </span>            : 
<span class="lineNum">    2729 </span><span class="lineCov">          5 :         if (res)</span>
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :                 res-&gt;in_gac = TRUE;</span>
<span class="lineNum">    2731 </span>            :         else {
<span class="lineNum">    2732 </span><span class="lineCov">          5 :                 MonoDomain *domain = mono_domain_get ();</span>
<span class="lineNum">    2733 </span>            : 
<span class="lineNum">    2734 </span><span class="lineCov">          5 :                 res = mono_try_assembly_resolve (domain, name, NULL, FALSE, &amp;error);</span>
<span class="lineNum">    2735 </span><span class="lineCov">          5 :                 if (!is_ok (&amp;error)) {</span>
<span class="lineNum">    2736 </span><span class="lineNoCov">          0 :                         mono_error_cleanup (&amp;error);</span>
<span class="lineNum">    2737 </span><span class="lineNoCov">          0 :                         if (*status == MONO_IMAGE_OK)</span>
<span class="lineNum">    2738 </span><span class="lineNoCov">          0 :                                 *status = MONO_IMAGE_IMAGE_INVALID;</span>
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2740 </span>            :         }
<span class="lineNum">    2741 </span>            : 
<span class="lineNum">    2742 </span><span class="lineCov">          5 :         return res;</span>
<span class="lineNum">    2743 </span><span class="lineCov">       2811 : }</span>
<a name="2744"><span class="lineNum">    2744 </span>            : </a>
<span class="lineNum">    2745 </span>            : static MonoBoolean
<span class="lineNum">    2746 </span>            : mono_assembly_is_in_gac (const gchar *filename)
<span class="lineNum">    2747 </span>            : {
<span class="lineNum">    2748 </span>            :         const gchar *rootdir;
<span class="lineNum">    2749 </span>            :         gchar *gp;
<span class="lineNum">    2750 </span>            :         gchar **paths;
<span class="lineNum">    2751 </span>            : 
<span class="lineNum">    2752 </span><span class="lineCov">     170125 :         if (filename == NULL)</span>
<span class="lineNum">    2753 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2754 </span>            : 
<span class="lineNum">    2755 </span><span class="lineCov">     510377 :         for (paths = extra_gac_paths; paths &amp;&amp; *paths; paths++) {</span>
<span class="lineNum">    2756 </span><span class="lineNoCov">          0 :                 if (strstr (*paths, filename) != *paths)</span>
<span class="lineNum">    2757 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2758 </span>            : 
<span class="lineNum">    2759 </span><span class="lineNoCov">          0 :                 gp = (gchar *) (filename + strlen (*paths));</span>
<span class="lineNum">    2760 </span><span class="lineNoCov">          0 :                 if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2762 </span><span class="lineNoCov">          0 :                 gp++;</span>
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :                 if (strncmp (gp, &quot;lib&quot;, 3))</span>
<span class="lineNum">    2764 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2765 </span><span class="lineNoCov">          0 :                 gp += 3;</span>
<span class="lineNum">    2766 </span><span class="lineNoCov">          0 :                 if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2767 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2768 </span><span class="lineNoCov">          0 :                 gp++;</span>
<span class="lineNum">    2769 </span><span class="lineNoCov">          0 :                 if (strncmp (gp, &quot;mono&quot;, 4))</span>
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :                 gp += 4;</span>
<span class="lineNum">    2772 </span><span class="lineNoCov">          0 :                 if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2774 </span><span class="lineNoCov">          0 :                 gp++;</span>
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :                 if (strncmp (gp, &quot;gac&quot;, 3))</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :                 gp += 3;</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :                 if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2780 </span>            : 
<span class="lineNum">    2781 </span><span class="lineNoCov">          0 :                 return TRUE;</span>
<span class="lineNum">    2782 </span>            :         }
<span class="lineNum">    2783 </span>            : 
<span class="lineNum">    2784 </span><span class="lineCov">     170120 :         rootdir = mono_assembly_getrootdir ();</span>
<span class="lineNum">    2785 </span><span class="lineCov">     170120 :         if (strstr (filename, rootdir) != filename)</span>
<span class="lineNum">    2786 </span><span class="lineCov">      76258 :                 return FALSE;</span>
<span class="lineNum">    2787 </span>            : 
<span class="lineNum">    2788 </span><span class="lineCov">      93861 :         gp = (gchar *) (filename + strlen (rootdir));</span>
<span class="lineNum">    2789 </span><span class="lineCov">      93861 :         if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2790 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2791 </span><span class="lineCov">      93869 :         gp++;</span>
<span class="lineNum">    2792 </span><span class="lineCov">      93869 :         if (strncmp (gp, &quot;mono&quot;, 4))</span>
<span class="lineNum">    2793 </span><span class="lineCov">      46544 :                 return FALSE;</span>
<span class="lineNum">    2794 </span><span class="lineCov">      47329 :         gp += 4;</span>
<span class="lineNum">    2795 </span><span class="lineCov">      47329 :         if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2796 </span><span class="lineCov">          6 :                 return FALSE;</span>
<span class="lineNum">    2797 </span><span class="lineCov">      47315 :         gp++;</span>
<span class="lineNum">    2798 </span><span class="lineCov">      47315 :         if (strncmp (gp, &quot;gac&quot;, 3))</span>
<span class="lineNum">    2799 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2800 </span><span class="lineCov">      47319 :         gp += 3;</span>
<span class="lineNum">    2801 </span><span class="lineCov">      47319 :         if (*gp != G_DIR_SEPARATOR)</span>
<span class="lineNum">    2802 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2803 </span><span class="lineCov">      47320 :         return TRUE;</span>
<span class="lineNum">    2804 </span><span class="lineCov">     170130 : }</span>
<a name="2805"><span class="lineNum">    2805 </span>            : </a>
<span class="lineNum">    2806 </span>            : static MonoImage*
<span class="lineNum">    2807 </span>            : mono_assembly_load_publisher_policy (MonoAssemblyName *aname)
<span class="lineNum">    2808 </span>            : {
<span class="lineNum">    2809 </span>            :         MonoImage *image;
<span class="lineNum">    2810 </span>            :         gchar *filename, *pname, *name, *culture, *version, *fullpath, *subpath;
<span class="lineNum">    2811 </span>            :         gchar **paths;
<span class="lineNum">    2812 </span>            :         gint32 len;
<span class="lineNum">    2813 </span>            : 
<span class="lineNum">    2814 </span><span class="lineCov">      39532 :         if (strstr (aname-&gt;name, &quot;.dll&quot;)) {</span>
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :                 len = strlen (aname-&gt;name) - 4;</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :                 name = (gchar *)g_malloc (len + 1);</span>
<span class="lineNum">    2817 </span><span class="lineNoCov">          0 :                 strncpy (name, aname-&gt;name, len);</span>
<span class="lineNum">    2818 </span><span class="lineNoCov">          0 :                 name[len] = 0;</span>
<span class="lineNum">    2819 </span><span class="lineNoCov">          0 :         } else</span>
<span class="lineNum">    2820 </span><span class="lineCov">      39532 :                 name = g_strdup (aname-&gt;name);</span>
<span class="lineNum">    2821 </span>            :         
<span class="lineNum">    2822 </span><span class="lineCov">      39532 :         if (aname-&gt;culture)</span>
<span class="lineNum">    2823 </span><span class="lineCov">      31462 :                 culture = g_utf8_strdown (aname-&gt;culture, -1);</span>
<span class="lineNum">    2824 </span>            :         else
<span class="lineNum">    2825 </span><span class="lineCov">       8070 :                 culture = g_strdup (&quot;&quot;);</span>
<span class="lineNum">    2826 </span>            :         
<span class="lineNum">    2827 </span><span class="lineCov">      39530 :         pname = g_strdup_printf (&quot;policy.%d.%d.%s&quot;, aname-&gt;major, aname-&gt;minor, name);</span>
<span class="lineNum">    2828 </span><span class="lineCov">      39530 :         version = g_strdup_printf (&quot;0.0.0.0_%s_%s&quot;, culture, aname-&gt;public_key_token);</span>
<span class="lineNum">    2829 </span><span class="lineCov">      39530 :         g_free (name);</span>
<span class="lineNum">    2830 </span><span class="lineCov">      39530 :         g_free (culture);</span>
<span class="lineNum">    2831 </span>            :         
<span class="lineNum">    2832 </span><span class="lineCov">      39530 :         filename = g_strconcat (pname, &quot;.dll&quot;, NULL);</span>
<span class="lineNum">    2833 </span><span class="lineCov">      39530 :         subpath = g_build_path (G_DIR_SEPARATOR_S, pname, version, filename, NULL);</span>
<span class="lineNum">    2834 </span><span class="lineCov">      39530 :         g_free (pname);</span>
<span class="lineNum">    2835 </span><span class="lineCov">      39530 :         g_free (version);</span>
<span class="lineNum">    2836 </span><span class="lineCov">      39530 :         g_free (filename);</span>
<span class="lineNum">    2837 </span>            : 
<span class="lineNum">    2838 </span><span class="lineCov">      39530 :         image = NULL;</span>
<span class="lineNum">    2839 </span><span class="lineCov">      39530 :         if (extra_gac_paths) {</span>
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :                 paths = extra_gac_paths;</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :                 while (!image &amp;&amp; *paths) {</span>
<span class="lineNum">    2842 </span><span class="lineNoCov">          0 :                         fullpath = g_build_path (G_DIR_SEPARATOR_S, *paths,</span>
<span class="lineNum">    2843 </span><span class="lineNoCov">          0 :                                         &quot;lib&quot;, &quot;mono&quot;, &quot;gac&quot;, subpath, NULL);</span>
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :                         image = mono_image_open (fullpath, NULL);</span>
<span class="lineNum">    2845 </span><span class="lineNoCov">          0 :                         g_free (fullpath);</span>
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :                         paths++;</span>
<span class="lineNum">    2847 </span>            :                 }
<span class="lineNum">    2848 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2849 </span>            : 
<span class="lineNum">    2850 </span><span class="lineCov">      39529 :         if (image) {</span>
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :                 g_free (subpath);</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :                 return image;</span>
<span class="lineNum">    2853 </span>            :         }
<span class="lineNum">    2854 </span>            : 
<span class="lineNum">    2855 </span><span class="lineCov">      79056 :         fullpath = g_build_path (G_DIR_SEPARATOR_S, mono_assembly_getrootdir (), </span>
<span class="lineNum">    2856 </span><span class="lineCov">      39528 :                         &quot;mono&quot;, &quot;gac&quot;, subpath, NULL);</span>
<span class="lineNum">    2857 </span><span class="lineCov">      39528 :         image = mono_image_open (fullpath, NULL);</span>
<span class="lineNum">    2858 </span><span class="lineCov">      39528 :         g_free (subpath);</span>
<span class="lineNum">    2859 </span><span class="lineCov">      39528 :         g_free (fullpath);</span>
<span class="lineNum">    2860 </span>            :         
<span class="lineNum">    2861 </span><span class="lineCov">      39528 :         return image;</span>
<span class="lineNum">    2862 </span><span class="lineCov">      39529 : }</span>
<a name="2863"><span class="lineNum">    2863 </span>            : </a>
<span class="lineNum">    2864 </span>            : static MonoAssemblyName*
<span class="lineNum">    2865 </span>            : mono_assembly_bind_version (MonoAssemblyBindingInfo *info, MonoAssemblyName *aname, MonoAssemblyName *dest_name)
<span class="lineNum">    2866 </span>            : {
<span class="lineNum">    2867 </span><span class="lineCov">       8321 :         memcpy (dest_name, aname, sizeof (MonoAssemblyName));</span>
<span class="lineNum">    2868 </span><span class="lineCov">       8321 :         dest_name-&gt;major = info-&gt;new_version.major;</span>
<span class="lineNum">    2869 </span><span class="lineCov">       8321 :         dest_name-&gt;minor = info-&gt;new_version.minor;</span>
<span class="lineNum">    2870 </span><span class="lineCov">       8321 :         dest_name-&gt;build = info-&gt;new_version.build;</span>
<span class="lineNum">    2871 </span><span class="lineCov">       8321 :         dest_name-&gt;revision = info-&gt;new_version.revision;</span>
<span class="lineNum">    2872 </span>            :         
<span class="lineNum">    2873 </span><span class="lineCov">       8321 :         return dest_name;</span>
<span class="lineNum">    2874 </span>            : }
<span class="lineNum">    2875 </span>            : 
<a name="2876"><span class="lineNum">    2876 </span>            : /* LOCKING: assembly_binding lock must be held */</a>
<span class="lineNum">    2877 </span>            : static MonoAssemblyBindingInfo*
<span class="lineNum">    2878 </span>            : search_binding_loaded (MonoAssemblyName *aname)
<span class="lineNum">    2879 </span>            : {
<span class="lineNum">    2880 </span>            :         GSList *tmp;
<span class="lineNum">    2881 </span>            : 
<span class="lineNum">    2882 </span><span class="lineCov">    5018912 :         for (tmp = loaded_assembly_bindings; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    2883 </span><span class="lineCov">    2422305 :                 MonoAssemblyBindingInfo *info = (MonoAssemblyBindingInfo *)tmp-&gt;data;</span>
<span class="lineNum">    2884 </span><span class="lineCov">    2422305 :                 if (assembly_binding_maps_name (info, aname))</span>
<span class="lineNum">    2885 </span><span class="lineCov">      92592 :                         return info;</span>
<span class="lineNum">    2886 </span><span class="lineCov">    2329713 :         }</span>
<span class="lineNum">    2887 </span>            : 
<span class="lineNum">    2888 </span><span class="lineCov">      87151 :         return NULL;</span>
<span class="lineNum">    2889 </span><span class="lineCov">     179743 : }</span>
<a name="2890"><span class="lineNum">    2890 </span>            : </a>
<span class="lineNum">    2891 </span>            : static inline gboolean
<span class="lineNum">    2892 </span>            : info_compare_versions (AssemblyVersionSet *left, AssemblyVersionSet *right)
<span class="lineNum">    2893 </span>            : {
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :         if (left-&gt;major != right-&gt;major || left-&gt;minor != right-&gt;minor ||</span>
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :             left-&gt;build != right-&gt;build || left-&gt;revision != right-&gt;revision)</span>
<span class="lineNum">    2896 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2897 </span>            : 
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :         return TRUE;</span>
<span class="lineNum">    2899 </span><span class="lineNoCov">          0 : }</span>
<a name="2900"><span class="lineNum">    2900 </span>            : </a>
<span class="lineNum">    2901 </span>            : static inline gboolean
<span class="lineNum">    2902 </span>            : info_versions_equal (MonoAssemblyBindingInfo *left, MonoAssemblyBindingInfo *right)
<span class="lineNum">    2903 </span>            : {
<span class="lineNum">    2904 </span><span class="lineNoCov">          0 :         if (left-&gt;has_old_version_bottom != right-&gt;has_old_version_bottom)</span>
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2906 </span>            : 
<span class="lineNum">    2907 </span><span class="lineNoCov">          0 :         if (left-&gt;has_old_version_top != right-&gt;has_old_version_top)</span>
<span class="lineNum">    2908 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2909 </span>            : 
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :         if (left-&gt;has_new_version != right-&gt;has_new_version)</span>
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2912 </span>            : 
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :         if (left-&gt;has_old_version_bottom &amp;&amp; !info_compare_versions (&amp;left-&gt;old_version_bottom, &amp;right-&gt;old_version_bottom))</span>
<span class="lineNum">    2914 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2915 </span>            : 
<span class="lineNum">    2916 </span><span class="lineNoCov">          0 :         if (left-&gt;has_old_version_top &amp;&amp; !info_compare_versions (&amp;left-&gt;old_version_top, &amp;right-&gt;old_version_top))</span>
<span class="lineNum">    2917 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2918 </span>            : 
<span class="lineNum">    2919 </span><span class="lineNoCov">          0 :         if (left-&gt;has_new_version &amp;&amp; !info_compare_versions (&amp;left-&gt;new_version, &amp;right-&gt;new_version))</span>
<span class="lineNum">    2920 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2921 </span>            : 
<span class="lineNum">    2922 </span><span class="lineNoCov">          0 :         return TRUE;</span>
<span class="lineNum">    2923 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2924 </span>            : 
<a name="2925"><span class="lineNum">    2925 </span>            : /* LOCKING: assumes all the necessary locks are held */</a>
<span class="lineNum">    2926 </span>            : static void
<span class="lineNum">    2927 </span>            : assembly_binding_info_parsed (MonoAssemblyBindingInfo *info, void *user_data)
<span class="lineNum">    2928 </span>            : {
<span class="lineNum">    2929 </span>            :         MonoAssemblyBindingInfo *info_copy;
<span class="lineNum">    2930 </span>            :         GSList *tmp;
<span class="lineNum">    2931 </span>            :         MonoAssemblyBindingInfo *info_tmp;
<span class="lineNum">    2932 </span><span class="lineCov">       6246 :         MonoDomain *domain = (MonoDomain*)user_data;</span>
<span class="lineNum">    2933 </span>            : 
<span class="lineNum">    2934 </span><span class="lineCov">       6246 :         if (!domain)</span>
<span class="lineNum">    2935 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    2936 </span>            : 
<span class="lineNum">    2937 </span><span class="lineCov">      43722 :         for (tmp = domain-&gt;assembly_bindings; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    2938 </span><span class="lineCov">      15615 :                 info_tmp = (MonoAssemblyBindingInfo *)tmp-&gt;data;</span>
<span class="lineNum">    2939 </span><span class="lineCov">      15615 :                 if (strcmp (info-&gt;name, info_tmp-&gt;name) == 0 &amp;&amp; info_versions_equal (info, info_tmp))</span>
<span class="lineNum">    2940 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    2941 </span><span class="lineCov">      15615 :         }</span>
<span class="lineNum">    2942 </span>            : 
<span class="lineNum">    2943 </span><span class="lineCov">       6246 :         info_copy = (MonoAssemblyBindingInfo *)mono_mempool_alloc0 (domain-&gt;mp, sizeof (MonoAssemblyBindingInfo));</span>
<span class="lineNum">    2944 </span><span class="lineCov">       6246 :         memcpy (info_copy, info, sizeof (MonoAssemblyBindingInfo));</span>
<span class="lineNum">    2945 </span><span class="lineCov">       6246 :         if (info-&gt;name)</span>
<span class="lineNum">    2946 </span><span class="lineCov">       6246 :                 info_copy-&gt;name = mono_mempool_strdup (domain-&gt;mp, info-&gt;name);</span>
<span class="lineNum">    2947 </span><span class="lineCov">       6246 :         if (info-&gt;culture)</span>
<span class="lineNum">    2948 </span><span class="lineCov">       6246 :                 info_copy-&gt;culture = mono_mempool_strdup (domain-&gt;mp, info-&gt;culture);</span>
<span class="lineNum">    2949 </span>            : 
<span class="lineNum">    2950 </span><span class="lineCov">       6246 :         domain-&gt;assembly_bindings = g_slist_append_mempool (domain-&gt;mp, domain-&gt;assembly_bindings, info_copy);</span>
<span class="lineNum">    2951 </span><span class="lineCov">      12492 : }</span>
<a name="2952"><span class="lineNum">    2952 </span>            : </a>
<span class="lineNum">    2953 </span>            : static int
<span class="lineNum">    2954 </span>            : get_version_number (int major, int minor)
<span class="lineNum">    2955 </span>            : {
<span class="lineNum">    2956 </span><span class="lineCov">      24963 :         return major * 256 + minor;</span>
<span class="lineNum">    2957 </span>            : }
<a name="2958"><span class="lineNum">    2958 </span>            : </a>
<span class="lineNum">    2959 </span>            : static inline gboolean
<span class="lineNum">    2960 </span>            : info_major_minor_in_range (MonoAssemblyBindingInfo *info, MonoAssemblyName *aname)
<span class="lineNum">    2961 </span>            : {
<span class="lineNum">    2962 </span><span class="lineCov">       8321 :         int aname_version_number = get_version_number (aname-&gt;major, aname-&gt;minor);</span>
<span class="lineNum">    2963 </span><span class="lineCov">       8321 :         if (!info-&gt;has_old_version_bottom)</span>
<span class="lineNum">    2964 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2965 </span>            : 
<span class="lineNum">    2966 </span><span class="lineCov">       8321 :         if (get_version_number (info-&gt;old_version_bottom.major, info-&gt;old_version_bottom.minor) &gt; aname_version_number)</span>
<span class="lineNum">    2967 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2968 </span>            : 
<span class="lineNum">    2969 </span><span class="lineCov">      16642 :         if (info-&gt;has_old_version_top &amp;&amp; get_version_number (info-&gt;old_version_top.major, info-&gt;old_version_top.minor) &lt; aname_version_number)</span>
<span class="lineNum">    2970 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    2971 </span>            : 
<span class="lineNum">    2972 </span>            :         /* This is not the nicest way to do it, but it's a by-product of the way parsing is done */
<span class="lineNum">    2973 </span><span class="lineCov">       8321 :         info-&gt;major = aname-&gt;major;</span>
<span class="lineNum">    2974 </span><span class="lineCov">       8321 :         info-&gt;minor = aname-&gt;minor;</span>
<span class="lineNum">    2975 </span>            : 
<span class="lineNum">    2976 </span><span class="lineCov">       8321 :         return TRUE;</span>
<span class="lineNum">    2977 </span><span class="lineCov">       8321 : }</span>
<span class="lineNum">    2978 </span>            : 
<a name="2979"><span class="lineNum">    2979 </span>            : /* LOCKING: Assumes that we are already locked - both loader and domain locks */</a>
<span class="lineNum">    2980 </span>            : static MonoAssemblyBindingInfo*
<span class="lineNum">    2981 </span>            : get_per_domain_assembly_binding_info (MonoDomain *domain, MonoAssemblyName *aname)
<span class="lineNum">    2982 </span>            : {
<span class="lineNum">    2983 </span>            :         MonoAssemblyBindingInfo *info;
<span class="lineNum">    2984 </span>            :         GSList *list;
<span class="lineNum">    2985 </span>            : 
<span class="lineNum">    2986 </span><span class="lineCov">      78663 :         if (!domain-&gt;assembly_bindings)</span>
<span class="lineNum">    2987 </span><span class="lineCov">      12414 :                 return NULL;</span>
<span class="lineNum">    2988 </span>            : 
<span class="lineNum">    2989 </span><span class="lineCov">      66249 :         info = NULL;</span>
<span class="lineNum">    2990 </span><span class="lineCov">     881536 :         for (list = domain-&gt;assembly_bindings; list; list = list-&gt;next) {</span>
<span class="lineNum">    2991 </span><span class="lineCov">     382840 :                 info = (MonoAssemblyBindingInfo *)list-&gt;data;</span>
<span class="lineNum">    2992 </span><span class="lineCov">     774001 :                 if (info &amp;&amp; !strcmp (aname-&gt;name, info-&gt;name) &amp;&amp; info_major_minor_in_range (info, aname))</span>
<span class="lineNum">    2993 </span><span class="lineCov">       8321 :                         break;</span>
<span class="lineNum">    2994 </span><span class="lineCov">     374519 :                 info = NULL;</span>
<span class="lineNum">    2995 </span><span class="lineCov">     374519 :         }</span>
<span class="lineNum">    2996 </span>            : 
<span class="lineNum">    2997 </span><span class="lineCov">      66249 :         if (info) {</span>
<span class="lineNum">    2998 </span><span class="lineCov">      33284 :                 if (info-&gt;name &amp;&amp; info-&gt;public_key_token [0] &amp;&amp; info-&gt;has_old_version_bottom &amp;&amp;</span>
<span class="lineNum">    2999 </span><span class="lineCov">      16642 :                     info-&gt;has_new_version &amp;&amp; assembly_binding_maps_name (info, aname))</span>
<span class="lineNum">    3000 </span><span class="lineCov">       8321 :                         info-&gt;is_valid = TRUE;</span>
<span class="lineNum">    3001 </span>            :                 else
<span class="lineNum">    3002 </span><span class="lineNoCov">          0 :                         info-&gt;is_valid = FALSE;</span>
<span class="lineNum">    3003 </span><span class="lineCov">       8321 :         }</span>
<span class="lineNum">    3004 </span>            : 
<span class="lineNum">    3005 </span><span class="lineCov">      66249 :         return info;</span>
<span class="lineNum">    3006 </span><span class="lineCov">      78663 : }</span>
<a name="3007"><span class="lineNum">    3007 </span>            : </a>
<span class="lineNum">    3008 </span>            : static MonoAssemblyName*
<span class="lineNum">    3009 </span>            : mono_assembly_apply_binding (MonoAssemblyName *aname, MonoAssemblyName *dest_name)
<span class="lineNum">    3010 </span>            : {
<span class="lineNum">    3011 </span>            :         MonoError error;
<span class="lineNum">    3012 </span>            :         MonoAssemblyBindingInfo *info, *info2;
<span class="lineNum">    3013 </span>            :         MonoImage *ppimage;
<span class="lineNum">    3014 </span>            :         MonoDomain *domain;
<span class="lineNum">    3015 </span>            : 
<span class="lineNum">    3016 </span><span class="lineCov">     142403 :         if (aname-&gt;public_key_token [0] == 0)</span>
<span class="lineNum">    3017 </span><span class="lineCov">       2319 :                 return aname;</span>
<span class="lineNum">    3018 </span>            : 
<span class="lineNum">    3019 </span><span class="lineCov">     140086 :         domain = mono_domain_get ();</span>
<span class="lineNum">    3020 </span>            : 
<span class="lineNum">    3021 </span><span class="lineCov">     140086 :         mono_assembly_binding_lock ();</span>
<span class="lineNum">    3022 </span><span class="lineCov">     140086 :         info = search_binding_loaded (aname);</span>
<span class="lineNum">    3023 </span><span class="lineCov">     140086 :         mono_assembly_binding_unlock ();</span>
<span class="lineNum">    3024 </span>            : 
<span class="lineNum">    3025 </span><span class="lineCov">     140086 :         if (!info) {</span>
<span class="lineNum">    3026 </span><span class="lineCov">      47853 :                 mono_domain_lock (domain);</span>
<span class="lineNum">    3027 </span><span class="lineCov">      47853 :                 info = get_per_domain_assembly_binding_info (domain, aname);</span>
<span class="lineNum">    3028 </span><span class="lineCov">      47853 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    3029 </span><span class="lineCov">      47853 :         }</span>
<span class="lineNum">    3030 </span>            : 
<span class="lineNum">    3031 </span><span class="lineCov">     140086 :         if (info) {</span>
<span class="lineNum">    3032 </span><span class="lineCov">     100428 :                 if (!check_policy_versions (info, aname))</span>
<span class="lineNum">    3033 </span><span class="lineCov">      92232 :                         return aname;</span>
<span class="lineNum">    3034 </span>            :                 
<span class="lineNum">    3035 </span><span class="lineCov">       8196 :                 mono_assembly_bind_version (info, aname, dest_name);</span>
<span class="lineNum">    3036 </span><span class="lineCov">       8196 :                 return dest_name;</span>
<span class="lineNum">    3037 </span>            :         }
<span class="lineNum">    3038 </span>            : 
<span class="lineNum">    3039 </span><span class="lineCov">     117316 :         if (domain &amp;&amp; domain-&gt;setup &amp;&amp; domain-&gt;setup-&gt;configuration_file) {</span>
<span class="lineNum">    3040 </span><span class="lineCov">      30810 :                 mono_domain_lock (domain);</span>
<span class="lineNum">    3041 </span><span class="lineCov">      30810 :                 if (!domain-&gt;assembly_bindings_parsed) {</span>
<span class="lineNum">    3042 </span><span class="lineCov">       1776 :                         gchar *domain_config_file_name = mono_string_to_utf8_checked (domain-&gt;setup-&gt;configuration_file, &amp;error);</span>
<span class="lineNum">    3043 </span>            :                         /* expect this to succeed because mono_domain_set_options_from_config () did
<span class="lineNum">    3044 </span>            :                          * the same thing when the domain was created. */
<span class="lineNum">    3045 </span><span class="lineCov">       1776 :                         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    3046 </span>            : 
<span class="lineNum">    3047 </span><span class="lineCov">       1776 :                         gchar *domain_config_file_path = mono_portability_find_file (domain_config_file_name, TRUE);</span>
<span class="lineNum">    3048 </span>            : 
<span class="lineNum">    3049 </span><span class="lineCov">       1776 :                         if (!domain_config_file_path)</span>
<span class="lineNum">    3050 </span><span class="lineCov">        734 :                                 domain_config_file_path = domain_config_file_name;</span>
<span class="lineNum">    3051 </span>            :                         
<span class="lineNum">    3052 </span><span class="lineCov">       1776 :                         mono_config_parse_assembly_bindings (domain_config_file_path, aname-&gt;major, aname-&gt;minor, domain, assembly_binding_info_parsed);</span>
<span class="lineNum">    3053 </span><span class="lineCov">       1776 :                         domain-&gt;assembly_bindings_parsed = TRUE;</span>
<span class="lineNum">    3054 </span><span class="lineCov">       1776 :                         if (domain_config_file_name != domain_config_file_path)</span>
<span class="lineNum">    3055 </span><span class="lineCov">       1042 :                                 g_free (domain_config_file_name);</span>
<span class="lineNum">    3056 </span><span class="lineCov">       1776 :                         g_free (domain_config_file_path);</span>
<span class="lineNum">    3057 </span><span class="lineCov">       1776 :                 }</span>
<span class="lineNum">    3058 </span>            : 
<span class="lineNum">    3059 </span><span class="lineCov">      30810 :                 info2 = get_per_domain_assembly_binding_info (domain, aname);</span>
<span class="lineNum">    3060 </span>            : 
<span class="lineNum">    3061 </span><span class="lineCov">      30810 :                 if (info2) {</span>
<span class="lineNum">    3062 </span><span class="lineCov">        125 :                         info = (MonoAssemblyBindingInfo *)g_memdup (info2, sizeof (MonoAssemblyBindingInfo));</span>
<span class="lineNum">    3063 </span><span class="lineCov">        125 :                         info-&gt;name = g_strdup (info2-&gt;name);</span>
<span class="lineNum">    3064 </span><span class="lineCov">        125 :                         info-&gt;culture = g_strdup (info2-&gt;culture);</span>
<span class="lineNum">    3065 </span><span class="lineCov">        125 :                         info-&gt;domain_id = domain-&gt;domain_id;</span>
<span class="lineNum">    3066 </span><span class="lineCov">        125 :                 }</span>
<span class="lineNum">    3067 </span>            : 
<span class="lineNum">    3068 </span><span class="lineCov">      30810 :                 mono_domain_unlock (domain);</span>
<span class="lineNum">    3069 </span><span class="lineCov">      30810 :         }</span>
<span class="lineNum">    3070 </span>            : 
<span class="lineNum">    3071 </span><span class="lineCov">      39657 :         if (!info) {</span>
<span class="lineNum">    3072 </span><span class="lineCov">      39532 :                 info = g_new0 (MonoAssemblyBindingInfo, 1);</span>
<span class="lineNum">    3073 </span><span class="lineCov">      39532 :                 info-&gt;major = aname-&gt;major;</span>
<span class="lineNum">    3074 </span><span class="lineCov">      39532 :                 info-&gt;minor = aname-&gt;minor;</span>
<span class="lineNum">    3075 </span><span class="lineCov">      39532 :         }</span>
<span class="lineNum">    3076 </span>            : 
<span class="lineNum">    3077 </span><span class="lineCov">      39657 :         if (!info-&gt;is_valid) {</span>
<span class="lineNum">    3078 </span><span class="lineCov">      39528 :                 ppimage = mono_assembly_load_publisher_policy (aname);</span>
<span class="lineNum">    3079 </span><span class="lineCov">      39528 :                 if (ppimage) {</span>
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :                         get_publisher_policy_info (ppimage, aname, info);</span>
<span class="lineNum">    3081 </span><span class="lineNoCov">          0 :                         mono_image_close (ppimage);</span>
<span class="lineNum">    3082 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    3083 </span><span class="lineCov">      39528 :         }</span>
<span class="lineNum">    3084 </span>            : 
<span class="lineNum">    3085 </span>            :         /* Define default error value if needed */
<span class="lineNum">    3086 </span><span class="lineCov">      39653 :         if (!info-&gt;is_valid) {</span>
<span class="lineNum">    3087 </span><span class="lineCov">      39529 :                 info-&gt;name = g_strdup (aname-&gt;name);</span>
<span class="lineNum">    3088 </span><span class="lineCov">      39529 :                 info-&gt;culture = g_strdup (aname-&gt;culture);</span>
<span class="lineNum">    3089 </span><span class="lineCov">      39529 :                 g_strlcpy ((char *)info-&gt;public_key_token, (const char *)aname-&gt;public_key_token, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    3090 </span><span class="lineCov">      39529 :         }</span>
<span class="lineNum">    3091 </span>            :         
<span class="lineNum">    3092 </span><span class="lineCov">      39657 :         mono_assembly_binding_lock ();</span>
<span class="lineNum">    3093 </span><span class="lineCov">      39657 :         info2 = search_binding_loaded (aname);</span>
<span class="lineNum">    3094 </span><span class="lineCov">      39657 :         if (info2) {</span>
<span class="lineNum">    3095 </span>            :                 /* This binding was added by another thread 
<span class="lineNum">    3096 </span>            :                  * before us */
<span class="lineNum">    3097 </span><span class="lineCov">        359 :                 mono_assembly_binding_info_free (info);</span>
<span class="lineNum">    3098 </span><span class="lineCov">        359 :                 g_free (info);</span>
<span class="lineNum">    3099 </span>            :                 
<span class="lineNum">    3100 </span><span class="lineCov">        359 :                 info = info2;</span>
<span class="lineNum">    3101 </span><span class="lineCov">        359 :         } else</span>
<span class="lineNum">    3102 </span><span class="lineCov">      39298 :                 loaded_assembly_bindings = g_slist_prepend (loaded_assembly_bindings, info);</span>
<span class="lineNum">    3103 </span>            :                 
<span class="lineNum">    3104 </span><span class="lineCov">      39657 :         mono_assembly_binding_unlock ();</span>
<span class="lineNum">    3105 </span>            :         
<span class="lineNum">    3106 </span><span class="lineCov">      39782 :         if (!info-&gt;is_valid || !check_policy_versions (info, aname))</span>
<span class="lineNum">    3107 </span><span class="lineCov">      39532 :                 return aname;</span>
<span class="lineNum">    3108 </span>            : 
<span class="lineNum">    3109 </span><span class="lineCov">        125 :         mono_assembly_bind_version (info, aname, dest_name);</span>
<span class="lineNum">    3110 </span><span class="lineCov">        125 :         return dest_name;</span>
<span class="lineNum">    3111 </span><span class="lineCov">     142405 : }</span>
<span class="lineNum">    3112 </span>            : 
<span class="lineNum">    3113 </span>            : /**
<span class="lineNum">    3114 </span>            :  * mono_assembly_load_from_gac
<span class="lineNum">    3115 </span>            :  *
<span class="lineNum">    3116 </span>            :  * @aname: The assembly name object
<a name="3117"><span class="lineNum">    3117 </span>            :  */</a>
<span class="lineNum">    3118 </span>            : static MonoAssembly*
<span class="lineNum">    3119 </span>            : mono_assembly_load_from_gac (MonoAssemblyName *aname,  gchar *filename, MonoImageOpenStatus *status, MonoBoolean refonly)
<span class="lineNum">    3120 </span>            : {
<span class="lineNum">    3121 </span><span class="lineCov">      48387 :         MonoAssembly *result = NULL;</span>
<span class="lineNum">    3122 </span>            :         gchar *name, *version, *culture, *fullpath, *subpath;
<span class="lineNum">    3123 </span>            :         gint32 len;
<span class="lineNum">    3124 </span>            :         gchar **paths;
<span class="lineNum">    3125 </span>            :         char *pubtok;
<span class="lineNum">    3126 </span>            : 
<span class="lineNum">    3127 </span><span class="lineCov">      48387 :         if (aname-&gt;public_key_token [0] == 0) {</span>
<span class="lineNum">    3128 </span><span class="lineCov">       1067 :                 return NULL;</span>
<span class="lineNum">    3129 </span>            :         }
<span class="lineNum">    3130 </span>            : 
<span class="lineNum">    3131 </span><span class="lineCov">      47322 :         if (strstr (aname-&gt;name, &quot;.dll&quot;)) {</span>
<span class="lineNum">    3132 </span><span class="lineNoCov">          0 :                 len = strlen (filename) - 4;</span>
<span class="lineNum">    3133 </span><span class="lineNoCov">          0 :                 name = (gchar *)g_malloc (len + 1);</span>
<span class="lineNum">    3134 </span><span class="lineNoCov">          0 :                 strncpy (name, aname-&gt;name, len);</span>
<span class="lineNum">    3135 </span><span class="lineNoCov">          0 :                 name[len] = 0;</span>
<span class="lineNum">    3136 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    3137 </span><span class="lineCov">      47321 :                 name = g_strdup (aname-&gt;name);</span>
<span class="lineNum">    3138 </span>            :         }
<span class="lineNum">    3139 </span>            : 
<span class="lineNum">    3140 </span><span class="lineCov">      47327 :         if (aname-&gt;culture) {</span>
<span class="lineNum">    3141 </span><span class="lineCov">      45494 :                 culture = g_utf8_strdown (aname-&gt;culture, -1);</span>
<span class="lineNum">    3142 </span><span class="lineCov">      45494 :         } else {</span>
<span class="lineNum">    3143 </span><span class="lineCov">       1832 :                 culture = g_strdup (&quot;&quot;);</span>
<span class="lineNum">    3144 </span>            :         }
<span class="lineNum">    3145 </span>            : 
<span class="lineNum">    3146 </span><span class="lineCov">      47327 :         pubtok = g_ascii_strdown ((char*)aname-&gt;public_key_token, MONO_PUBLIC_KEY_TOKEN_LENGTH);</span>
<span class="lineNum">    3147 </span><span class="lineCov">      94654 :         version = g_strdup_printf (&quot;%d.%d.%d.%d_%s_%s&quot;, aname-&gt;major,</span>
<span class="lineNum">    3148 </span><span class="lineCov">      47327 :                         aname-&gt;minor, aname-&gt;build, aname-&gt;revision,</span>
<span class="lineNum">    3149 </span><span class="lineCov">      47327 :                         culture, pubtok);</span>
<span class="lineNum">    3150 </span><span class="lineCov">      47327 :         g_free (pubtok);</span>
<span class="lineNum">    3151 </span>            :         
<span class="lineNum">    3152 </span><span class="lineCov">      47327 :         subpath = g_build_path (G_DIR_SEPARATOR_S, name, version, filename, NULL);</span>
<span class="lineNum">    3153 </span><span class="lineCov">      47327 :         g_free (name);</span>
<span class="lineNum">    3154 </span><span class="lineCov">      47327 :         g_free (version);</span>
<span class="lineNum">    3155 </span><span class="lineCov">      47327 :         g_free (culture);</span>
<span class="lineNum">    3156 </span>            : 
<span class="lineNum">    3157 </span><span class="lineCov">      47327 :         if (extra_gac_paths) {</span>
<span class="lineNum">    3158 </span><span class="lineNoCov">          0 :                 paths = extra_gac_paths;</span>
<span class="lineNum">    3159 </span><span class="lineNoCov">          0 :                 while (!result &amp;&amp; *paths) {</span>
<span class="lineNum">    3160 </span><span class="lineNoCov">          0 :                         fullpath = g_build_path (G_DIR_SEPARATOR_S, *paths, &quot;lib&quot;, &quot;mono&quot;, &quot;gac&quot;, subpath, NULL);</span>
<span class="lineNum">    3161 </span><span class="lineNoCov">          0 :                         result = mono_assembly_open_full (fullpath, status, refonly);</span>
<span class="lineNum">    3162 </span><span class="lineNoCov">          0 :                         g_free (fullpath);</span>
<span class="lineNum">    3163 </span><span class="lineNoCov">          0 :                         paths++;</span>
<span class="lineNum">    3164 </span>            :                 }
<span class="lineNum">    3165 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3166 </span>            : 
<span class="lineNum">    3167 </span><span class="lineCov">      47324 :         if (result) {</span>
<span class="lineNum">    3168 </span><span class="lineNoCov">          0 :                 result-&gt;in_gac = TRUE;</span>
<span class="lineNum">    3169 </span><span class="lineNoCov">          0 :                 g_free (subpath);</span>
<span class="lineNum">    3170 </span><span class="lineNoCov">          0 :                 return result;</span>
<span class="lineNum">    3171 </span>            :         }
<span class="lineNum">    3172 </span>            : 
<span class="lineNum">    3173 </span><span class="lineCov">      94656 :         fullpath = g_build_path (G_DIR_SEPARATOR_S, mono_assembly_getrootdir (),</span>
<span class="lineNum">    3174 </span><span class="lineCov">      47328 :                         &quot;mono&quot;, &quot;gac&quot;, subpath, NULL);</span>
<span class="lineNum">    3175 </span><span class="lineCov">      47328 :         result = mono_assembly_open_full (fullpath, status, refonly);</span>
<span class="lineNum">    3176 </span><span class="lineCov">      47328 :         g_free (fullpath);</span>
<span class="lineNum">    3177 </span>            : 
<span class="lineNum">    3178 </span><span class="lineCov">      47328 :         if (result)</span>
<span class="lineNum">    3179 </span><span class="lineNoCov">          0 :                 result-&gt;in_gac = TRUE;</span>
<span class="lineNum">    3180 </span>            :         
<span class="lineNum">    3181 </span><span class="lineCov">      47328 :         g_free (subpath);</span>
<span class="lineNum">    3182 </span>            : 
<span class="lineNum">    3183 </span><span class="lineCov">      47328 :         return result;</span>
<span class="lineNum">    3184 </span><span class="lineCov">      48395 : }</span>
<a name="3185"><span class="lineNum">    3185 </span>            : </a>
<span class="lineNum">    3186 </span>            : MonoAssembly*
<span class="lineNum">    3187 </span>            : mono_assembly_load_corlib (const MonoRuntimeInfo *runtime, MonoImageOpenStatus *status)
<span class="lineNum">    3188 </span>            : {
<span class="lineNum">    3189 </span>            :         char *corlib_file;
<span class="lineNum">    3190 </span>            :         MonoAssemblyName *aname;
<span class="lineNum">    3191 </span>            : 
<span class="lineNum">    3192 </span><span class="lineCov">       4940 :         if (corlib) {</span>
<span class="lineNum">    3193 </span>            :                 /* g_print (&quot;corlib already loaded\n&quot;); */
<span class="lineNum">    3194 </span><span class="lineNoCov">          0 :                 return corlib;</span>
<span class="lineNum">    3195 </span>            :         }
<span class="lineNum">    3196 </span>            : 
<span class="lineNum">    3197 </span>            :         // In native client, Corlib is embedded in the executable as static variable corlibData
<span class="lineNum">    3198 </span>            : #if defined(__native_client__)
<span class="lineNum">    3199 </span>            :         if (corlibData != NULL &amp;&amp; corlibSize != 0) {
<span class="lineNum">    3200 </span>            :                 int status = 0;
<span class="lineNum">    3201 </span>            :                 /* First &quot;FALSE&quot; instructs mono not to make a copy. */
<span class="lineNum">    3202 </span>            :                 /* Second &quot;FALSE&quot; says this is not just a ref.      */
<span class="lineNum">    3203 </span>            :                 MonoImage* image = mono_image_open_from_data_full (corlibData, corlibSize, FALSE, &amp;status, FALSE);
<span class="lineNum">    3204 </span>            :                 if (image == NULL || status != 0)
<span class="lineNum">    3205 </span>            :                         g_print(&quot;mono_image_open_from_data_full failed: %d\n&quot;, status);
<span class="lineNum">    3206 </span>            :                 corlib = mono_assembly_load_from_full (image, &quot;mscorlib&quot;, &amp;status, FALSE);
<span class="lineNum">    3207 </span>            :                 if (corlib == NULL || status != 0)
<span class="lineNum">    3208 </span>            :                         g_print (&quot;mono_assembly_load_from_full failed: %d\n&quot;, status);
<span class="lineNum">    3209 </span>            :                 if (corlib)
<span class="lineNum">    3210 </span>            :                         return corlib;
<span class="lineNum">    3211 </span>            :         }
<span class="lineNum">    3212 </span>            : #endif
<span class="lineNum">    3213 </span>            : 
<span class="lineNum">    3214 </span>            :         // A nonstandard preload hook may provide a special mscorlib assembly
<span class="lineNum">    3215 </span><span class="lineCov">       4940 :         aname = mono_assembly_name_new (&quot;mscorlib.dll&quot;);</span>
<span class="lineNum">    3216 </span><span class="lineCov">       4940 :         corlib = invoke_assembly_preload_hook (aname, assemblies_path);</span>
<span class="lineNum">    3217 </span><span class="lineCov">       4940 :         mono_assembly_name_free (aname);</span>
<span class="lineNum">    3218 </span><span class="lineCov">       4940 :         g_free (aname);</span>
<span class="lineNum">    3219 </span><span class="lineCov">       4940 :         if (corlib != NULL)</span>
<span class="lineNum">    3220 </span><span class="lineNoCov">          0 :                 goto return_corlib_and_facades;</span>
<span class="lineNum">    3221 </span>            : 
<span class="lineNum">    3222 </span>            :         // This unusual directory layout can occur if mono is being built and run out of its own source repo
<span class="lineNum">    3223 </span><span class="lineCov">       4940 :         if (assemblies_path) { // Custom assemblies path set via MONO_PATH or mono_set_assemblies_path</span>
<span class="lineNum">    3224 </span><span class="lineCov">       4940 :                 corlib = load_in_path (&quot;mscorlib.dll&quot;, (const char**)assemblies_path, status, FALSE);</span>
<span class="lineNum">    3225 </span><span class="lineCov">       4940 :                 if (corlib)</span>
<span class="lineNum">    3226 </span><span class="lineCov">       4940 :                         goto return_corlib_and_facades;</span>
<span class="lineNum">    3227 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3228 </span>            : 
<span class="lineNum">    3229 </span>            :         /* Normal case: Load corlib from mono/&lt;version&gt; */
<span class="lineNum">    3230 </span><span class="lineNoCov">          0 :         corlib_file = g_build_filename (&quot;mono&quot;, runtime-&gt;framework_version, &quot;mscorlib.dll&quot;, NULL);</span>
<span class="lineNum">    3231 </span><span class="lineNoCov">          0 :         if (assemblies_path) { // Custom assemblies path</span>
<span class="lineNum">    3232 </span><span class="lineNoCov">          0 :                 corlib = load_in_path (corlib_file, (const char**)assemblies_path, status, FALSE);</span>
<span class="lineNum">    3233 </span><span class="lineNoCov">          0 :                 if (corlib) {</span>
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :                         g_free (corlib_file);</span>
<span class="lineNum">    3235 </span><span class="lineNoCov">          0 :                         goto return_corlib_and_facades;</span>
<span class="lineNum">    3236 </span>            :                 }
<span class="lineNum">    3237 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :         corlib = load_in_path (corlib_file, default_path, status, FALSE);</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :         g_free (corlib_file);</span>
<span class="lineNum">    3240 </span>            : 
<span class="lineNum">    3241 </span>            : return_corlib_and_facades:
<span class="lineNum">    3242 </span><span class="lineCov">       9880 :         if (corlib &amp;&amp; !strcmp (runtime-&gt;framework_version, &quot;4.5&quot;))  // FIXME: stop hardcoding 4.5 here</span>
<span class="lineNum">    3243 </span><span class="lineCov">       4940 :                 default_path [1] = g_strdup_printf (&quot;%s/Facades&quot;, corlib-&gt;basedir);</span>
<span class="lineNum">    3244 </span>            :                 
<span class="lineNum">    3245 </span><span class="lineCov">       4940 :         return corlib;</span>
<span class="lineNum">    3246 </span><span class="lineCov">       4940 : }</span>
<a name="3247"><span class="lineNum">    3247 </span>            : </a>
<span class="lineNum">    3248 </span>            : static MonoAssembly*
<span class="lineNum">    3249 </span>            : prevent_reference_assembly_from_running (MonoAssembly* candidate, gboolean refonly)
<span class="lineNum">    3250 </span>            : {
<span class="lineNum">    3251 </span>            :         MonoError refasm_error;
<span class="lineNum">    3252 </span><span class="lineCov">         39 :         mono_error_init (&amp;refasm_error);</span>
<span class="lineNum">    3253 </span><span class="lineCov">         51 :         if (candidate &amp;&amp; !refonly &amp;&amp; mono_assembly_has_reference_assembly_attribute (candidate, &amp;refasm_error)) {</span>
<span class="lineNum">    3254 </span><span class="lineNoCov">          0 :                 candidate = NULL;</span>
<span class="lineNum">    3255 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3256 </span><span class="lineCov">         39 :         mono_error_cleanup (&amp;refasm_error);</span>
<span class="lineNum">    3257 </span><span class="lineCov">         39 :         return candidate;</span>
<span class="lineNum">    3258 </span>            : }
<span class="lineNum">    3259 </span>            : 
<a name="3260"><span class="lineNum">    3260 </span>            : </a>
<span class="lineNum">    3261 </span>            : MonoAssembly*
<span class="lineNum">    3262 </span>            : mono_assembly_load_full_nosearch (MonoAssemblyName *aname, 
<span class="lineNum">    3263 </span>            :                                                                   const char       *basedir, 
<span class="lineNum">    3264 </span>            :                                                                   MonoImageOpenStatus *status,
<span class="lineNum">    3265 </span>            :                                                                   gboolean refonly)
<span class="lineNum">    3266 </span>            : {
<span class="lineNum">    3267 </span>            :         MonoAssembly *result;
<span class="lineNum">    3268 </span>            :         char *fullpath, *filename;
<span class="lineNum">    3269 </span>            :         MonoAssemblyName maped_aname;
<span class="lineNum">    3270 </span>            :         MonoAssemblyName maped_name_pp;
<span class="lineNum">    3271 </span>            :         int ext_index;
<span class="lineNum">    3272 </span>            :         const char *ext;
<span class="lineNum">    3273 </span>            :         int len;
<span class="lineNum">    3274 </span>            : 
<span class="lineNum">    3275 </span><span class="lineCov">     142427 :         aname = mono_assembly_remap_version (aname, &amp;maped_aname);</span>
<span class="lineNum">    3276 </span>            :         
<span class="lineNum">    3277 </span>            :         /* Reflection only assemblies don't get assembly binding */
<span class="lineNum">    3278 </span><span class="lineCov">     142427 :         if (!refonly)</span>
<span class="lineNum">    3279 </span><span class="lineCov">     142402 :                 aname = mono_assembly_apply_binding (aname, &amp;maped_name_pp);</span>
<span class="lineNum">    3280 </span>            :         
<span class="lineNum">    3281 </span><span class="lineCov">     142431 :         result = mono_assembly_loaded_full (aname, refonly);</span>
<span class="lineNum">    3282 </span><span class="lineCov">     142431 :         if (result)</span>
<span class="lineNum">    3283 </span><span class="lineCov">      78890 :                 return result;</span>
<span class="lineNum">    3284 </span>            : 
<span class="lineNum">    3285 </span><span class="lineCov">     190622 :         result = refonly ? invoke_assembly_refonly_preload_hook (aname, assemblies_path) : invoke_assembly_preload_hook (aname, assemblies_path);</span>
<span class="lineNum">    3286 </span><span class="lineCov">      63540 :         if (result) {</span>
<span class="lineNum">    3287 </span><span class="lineCov">      13843 :                 result-&gt;in_gac = FALSE;</span>
<span class="lineNum">    3288 </span><span class="lineCov">      13843 :                 return result;</span>
<span class="lineNum">    3289 </span>            :         }
<span class="lineNum">    3290 </span>            : 
<span class="lineNum">    3291 </span>            :         /* Currently we retrieve the loaded corlib for reflection 
<span class="lineNum">    3292 </span>            :          * only requests, like a common reflection only assembly 
<span class="lineNum">    3293 </span>            :          */
<span class="lineNum">    3294 </span><span class="lineCov">      97726 :         if (strcmp (aname-&gt;name, &quot;mscorlib&quot;) == 0 || strcmp (aname-&gt;name, &quot;mscorlib.dll&quot;) == 0) {</span>
<span class="lineNum">    3295 </span><span class="lineCov">       1655 :                 return mono_assembly_load_corlib (mono_get_runtime_info (), status);</span>
<span class="lineNum">    3296 </span>            :         }
<span class="lineNum">    3297 </span>            : 
<span class="lineNum">    3298 </span><span class="lineCov">      48034 :         len = strlen (aname-&gt;name);</span>
<span class="lineNum">    3299 </span><span class="lineCov">      97479 :         for (ext_index = 0; ext_index &lt; 2; ext_index ++) {</span>
<span class="lineNum">    3300 </span><span class="lineCov">      48389 :                 ext = ext_index == 0 ? &quot;.dll&quot; : &quot;.exe&quot;;</span>
<span class="lineNum">    3301 </span><span class="lineCov">     145135 :                 if (len &gt; 4 &amp;&amp; (!strcmp (aname-&gt;name + len - 4, &quot;.dll&quot;) || !strcmp (aname-&gt;name + len - 4, &quot;.exe&quot;))) {</span>
<span class="lineNum">    3302 </span><span class="lineNoCov">          0 :                         filename = g_strdup (aname-&gt;name);</span>
<span class="lineNum">    3303 </span>            :                         /* Don't try appending .dll/.exe if it already has one of those extensions */
<span class="lineNum">    3304 </span><span class="lineNoCov">          0 :                         ext_index++;</span>
<span class="lineNum">    3305 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    3306 </span><span class="lineCov">      48384 :                         filename = g_strconcat (aname-&gt;name, ext, NULL);</span>
<span class="lineNum">    3307 </span>            :                 }
<span class="lineNum">    3308 </span>            : 
<span class="lineNum">    3309 </span><span class="lineCov">      48394 :                 result = mono_assembly_load_from_gac (aname, filename, status, refonly);</span>
<span class="lineNum">    3310 </span><span class="lineCov">      48394 :                 if (result) {</span>
<span class="lineNum">    3311 </span><span class="lineNoCov">          0 :                         g_free (filename);</span>
<span class="lineNum">    3312 </span><span class="lineNoCov">          0 :                         return result;</span>
<span class="lineNum">    3313 </span>            :                 }
<span class="lineNum">    3314 </span>            : 
<span class="lineNum">    3315 </span><span class="lineCov">      48394 :                 if (basedir) {</span>
<span class="lineNum">    3316 </span><span class="lineCov">       3860 :                         fullpath = g_build_filename (basedir, filename, NULL);</span>
<span class="lineNum">    3317 </span><span class="lineCov">       3860 :                         result = mono_assembly_open_full (fullpath, status, refonly);</span>
<span class="lineNum">    3318 </span><span class="lineCov">       3860 :                         g_free (fullpath);</span>
<span class="lineNum">    3319 </span><span class="lineCov">       3860 :                         if (result) {</span>
<span class="lineNum">    3320 </span><span class="lineCov">       1844 :                                 result-&gt;in_gac = FALSE;</span>
<span class="lineNum">    3321 </span><span class="lineCov">       1844 :                                 g_free (filename);</span>
<span class="lineNum">    3322 </span><span class="lineCov">       1844 :                                 return result;</span>
<span class="lineNum">    3323 </span>            :                         }
<span class="lineNum">    3324 </span><span class="lineCov">       2016 :                 }</span>
<span class="lineNum">    3325 </span>            : 
<span class="lineNum">    3326 </span><span class="lineCov">      46550 :                 result = load_in_path (filename, default_path, status, refonly);</span>
<span class="lineNum">    3327 </span><span class="lineCov">      46550 :                 if (result)</span>
<span class="lineNum">    3328 </span><span class="lineCov">      45846 :                         result-&gt;in_gac = FALSE;</span>
<span class="lineNum">    3329 </span><span class="lineCov">      46551 :                 g_free (filename);</span>
<span class="lineNum">    3330 </span><span class="lineCov">      46551 :                 if (result)</span>
<span class="lineNum">    3331 </span><span class="lineCov">      45847 :                         return result;</span>
<span class="lineNum">    3332 </span><span class="lineCov">        704 :         }</span>
<span class="lineNum">    3333 </span>            : 
<span class="lineNum">    3334 </span><span class="lineCov">        352 :         return result;</span>
<span class="lineNum">    3335 </span><span class="lineCov">     142431 : }</span>
<a name="3336"><span class="lineNum">    3336 </span>            : </a>
<span class="lineNum">    3337 </span>            : MonoAssembly*
<span class="lineNum">    3338 </span>            : mono_assembly_load_full_internal (MonoAssemblyName *aname, MonoAssembly *requesting, const char *basedir, MonoImageOpenStatus *status, gboolean refonly)
<span class="lineNum">    3339 </span>            : {
<span class="lineNum">    3340 </span><span class="lineCov">     140685 :         MonoAssembly *result = mono_assembly_load_full_nosearch (aname, basedir, status, refonly);</span>
<span class="lineNum">    3341 </span>            : 
<span class="lineNum">    3342 </span><span class="lineCov">     140685 :         if (!result) {</span>
<span class="lineNum">    3343 </span>            :                 /* Try a postload search hook */
<span class="lineNum">    3344 </span><span class="lineCov">         39 :                 result = mono_assembly_invoke_search_hook_internal (aname, requesting, refonly, TRUE);</span>
<span class="lineNum">    3345 </span><span class="lineCov">         39 :                 result = prevent_reference_assembly_from_running (result, refonly);</span>
<span class="lineNum">    3346 </span><span class="lineCov">         39 :         }</span>
<span class="lineNum">    3347 </span><span class="lineCov">     140685 :         return result;</span>
<span class="lineNum">    3348 </span>            : }
<span class="lineNum">    3349 </span>            : 
<span class="lineNum">    3350 </span>            : /**
<span class="lineNum">    3351 </span>            :  * mono_assembly_load_full:
<span class="lineNum">    3352 </span>            :  * @aname: A MonoAssemblyName with the assembly name to load.
<span class="lineNum">    3353 </span>            :  * @basedir: A directory to look up the assembly at.
<span class="lineNum">    3354 </span>            :  * @status: a pointer to a MonoImageOpenStatus to return the status of the load operation
<span class="lineNum">    3355 </span>            :  * @refonly: Whether this assembly is being opened in &quot;reflection-only&quot; mode.
<span class="lineNum">    3356 </span>            :  *
<span class="lineNum">    3357 </span>            :  * Loads the assembly referenced by @aname, if the value of @basedir is not NULL, it
<span class="lineNum">    3358 </span>            :  * attempts to load the assembly from that directory before probing the standard locations.
<span class="lineNum">    3359 </span>            :  *
<span class="lineNum">    3360 </span>            :  * If the assembly is being opened in reflection-only mode (@refonly set to TRUE) then no 
<span class="lineNum">    3361 </span>            :  * assembly binding takes place.
<span class="lineNum">    3362 </span>            :  *
<span class="lineNum">    3363 </span>            :  * Returns: the assembly referenced by @aname loaded or NULL on error.   On error the
<span class="lineNum">    3364 </span>            :  * value pointed by status is updated with an error code.
<a name="3365"><span class="lineNum">    3365 </span>            :  */</a>
<span class="lineNum">    3366 </span>            : MonoAssembly*
<span class="lineNum">    3367 </span>            : mono_assembly_load_full (MonoAssemblyName *aname, const char *basedir, MonoImageOpenStatus *status, gboolean refonly)
<span class="lineNum">    3368 </span>            : {
<span class="lineNum">    3369 </span><span class="lineNoCov">          0 :         return mono_assembly_load_full_internal (aname, NULL, basedir, status, refonly);</span>
<span class="lineNum">    3370 </span>            : }
<span class="lineNum">    3371 </span>            : 
<span class="lineNum">    3372 </span>            : /**
<span class="lineNum">    3373 </span>            :  * mono_assembly_load:
<span class="lineNum">    3374 </span>            :  * @aname: A MonoAssemblyName with the assembly name to load.
<span class="lineNum">    3375 </span>            :  * @basedir: A directory to look up the assembly at.
<span class="lineNum">    3376 </span>            :  * @status: a pointer to a MonoImageOpenStatus to return the status of the load operation
<span class="lineNum">    3377 </span>            :  *
<span class="lineNum">    3378 </span>            :  * Loads the assembly referenced by @aname, if the value of @basedir is not NULL, it
<span class="lineNum">    3379 </span>            :  * attempts to load the assembly from that directory before probing the standard locations.
<span class="lineNum">    3380 </span>            :  *
<span class="lineNum">    3381 </span>            :  * Returns: the assembly referenced by @aname loaded or NULL on error.   On error the
<span class="lineNum">    3382 </span>            :  * value pointed by status is updated with an error code.
<a name="3383"><span class="lineNum">    3383 </span>            :  */</a>
<span class="lineNum">    3384 </span>            : MonoAssembly*
<span class="lineNum">    3385 </span>            : mono_assembly_load (MonoAssemblyName *aname, const char *basedir, MonoImageOpenStatus *status)
<span class="lineNum">    3386 </span>            : {
<span class="lineNum">    3387 </span><span class="lineCov">      24547 :         return mono_assembly_load_full_internal (aname, NULL, basedir, status, FALSE);</span>
<span class="lineNum">    3388 </span>            : }
<span class="lineNum">    3389 </span>            : 
<span class="lineNum">    3390 </span>            : /**
<span class="lineNum">    3391 </span>            :  * mono_assembly_loaded_full:
<span class="lineNum">    3392 </span>            :  * @aname: an assembly to look for.
<span class="lineNum">    3393 </span>            :  * @refonly: Whether this assembly is being opened in &quot;reflection-only&quot; mode.
<span class="lineNum">    3394 </span>            :  *
<span class="lineNum">    3395 </span>            :  * This is used to determine if the specified assembly has been loaded
<span class="lineNum">    3396 </span>            :  * Returns: NULL If the given @aname assembly has not been loaded, or a pointer to
<span class="lineNum">    3397 </span>            :  * a `MonoAssembly` that matches the `MonoAssemblyName` specified.
<a name="3398"><span class="lineNum">    3398 </span>            :  */</a>
<span class="lineNum">    3399 </span>            : MonoAssembly*
<span class="lineNum">    3400 </span>            : mono_assembly_loaded_full (MonoAssemblyName *aname, gboolean refonly)
<span class="lineNum">    3401 </span>            : {
<span class="lineNum">    3402 </span>            :         MonoAssembly *res;
<span class="lineNum">    3403 </span>            :         MonoAssemblyName maped_aname;
<span class="lineNum">    3404 </span>            : 
<span class="lineNum">    3405 </span><span class="lineCov">     145290 :         aname = mono_assembly_remap_version (aname, &amp;maped_aname);</span>
<span class="lineNum">    3406 </span>            : 
<span class="lineNum">    3407 </span><span class="lineCov">     145290 :         res = mono_assembly_invoke_search_hook_internal (aname, NULL, refonly, FALSE);</span>
<span class="lineNum">    3408 </span>            : 
<span class="lineNum">    3409 </span><span class="lineCov">     145290 :         return res;</span>
<span class="lineNum">    3410 </span>            : }
<span class="lineNum">    3411 </span>            : 
<span class="lineNum">    3412 </span>            : /**
<span class="lineNum">    3413 </span>            :  * mono_assembly_loaded:
<span class="lineNum">    3414 </span>            :  * @aname: an assembly to look for.
<span class="lineNum">    3415 </span>            :  *
<span class="lineNum">    3416 </span>            :  * This is used to determine if the specified assembly has been loaded
<span class="lineNum">    3417 </span>            :  
<span class="lineNum">    3418 </span>            :  * Returns: NULL If the given @aname assembly has not been loaded, or a pointer to
<span class="lineNum">    3419 </span>            :  * a `MonoAssembly` that matches the `MonoAssemblyName` specified.
<a name="3420"><span class="lineNum">    3420 </span>            :  */</a>
<span class="lineNum">    3421 </span>            : MonoAssembly*
<span class="lineNum">    3422 </span>            : mono_assembly_loaded (MonoAssemblyName *aname)
<span class="lineNum">    3423 </span>            : {
<span class="lineNum">    3424 </span><span class="lineCov">       2858 :         return mono_assembly_loaded_full (aname, FALSE);</span>
<span class="lineNum">    3425 </span>            : }
<a name="3426"><span class="lineNum">    3426 </span>            : </a>
<span class="lineNum">    3427 </span>            : void
<span class="lineNum">    3428 </span>            : mono_assembly_release_gc_roots (MonoAssembly *assembly)
<span class="lineNum">    3429 </span>            : {
<span class="lineNum">    3430 </span><span class="lineCov">      89302 :         if (assembly == NULL || assembly == REFERENCE_MISSING)</span>
<span class="lineNum">    3431 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    3432 </span>            : 
<span class="lineNum">    3433 </span><span class="lineCov">      44651 :         if (assembly_is_dynamic (assembly)) {</span>
<span class="lineNum">    3434 </span>            :                 int i;
<span class="lineNum">    3435 </span><span class="lineCov">         48 :                 MonoDynamicImage *dynimg = (MonoDynamicImage *)assembly-&gt;image;</span>
<span class="lineNum">    3436 </span><span class="lineCov">        192 :                 for (i = 0; i &lt; dynimg-&gt;image.module_count; ++i)</span>
<span class="lineNum">    3437 </span><span class="lineCov">         48 :                         mono_dynamic_image_release_gc_roots ((MonoDynamicImage *)dynimg-&gt;image.modules [i]);</span>
<span class="lineNum">    3438 </span><span class="lineCov">         48 :                 mono_dynamic_image_release_gc_roots (dynimg);</span>
<span class="lineNum">    3439 </span><span class="lineCov">         48 :         }</span>
<span class="lineNum">    3440 </span><span class="lineCov">      44651 : }</span>
<span class="lineNum">    3441 </span>            : 
<span class="lineNum">    3442 </span>            : /*
<span class="lineNum">    3443 </span>            :  * Returns whether mono_assembly_close_finish() must be called as
<span class="lineNum">    3444 </span>            :  * well.  See comment for mono_image_close_except_pools() for why we
<span class="lineNum">    3445 </span>            :  * unload in two steps.
<a name="3446"><span class="lineNum">    3446 </span>            :  */</a>
<span class="lineNum">    3447 </span>            : gboolean
<span class="lineNum">    3448 </span>            : mono_assembly_close_except_image_pools (MonoAssembly *assembly)
<span class="lineNum">    3449 </span>            : {
<span class="lineNum">    3450 </span>            :         GSList *tmp;
<span class="lineNum">    3451 </span><span class="lineCov">     475092 :         g_return_val_if_fail (assembly != NULL, FALSE);</span>
<span class="lineNum">    3452 </span>            : 
<span class="lineNum">    3453 </span><span class="lineCov">     158364 :         if (assembly == REFERENCE_MISSING)</span>
<span class="lineNum">    3454 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    3455 </span>            : 
<span class="lineNum">    3456 </span>            :         /* Might be 0 already */
<span class="lineNum">    3457 </span><span class="lineCov">     158364 :         if (InterlockedDecrement (&amp;assembly-&gt;ref_count) &gt; 0)</span>
<span class="lineNum">    3458 </span><span class="lineCov">     114682 :                 return FALSE;</span>
<span class="lineNum">    3459 </span>            : 
<span class="lineNum">    3460 </span><span class="lineCov">      43682 :         mono_profiler_assembly_event (assembly, MONO_PROFILE_START_UNLOAD);</span>
<span class="lineNum">    3461 </span>            : 
<span class="lineNum">    3462 </span><span class="lineCov">      43682 :         mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Unloading assembly %s [%p].&quot;, assembly-&gt;aname.name, assembly);</span>
<span class="lineNum">    3463 </span>            : 
<span class="lineNum">    3464 </span><span class="lineCov">      43682 :         mono_debug_close_image (assembly-&gt;image);</span>
<span class="lineNum">    3465 </span>            : 
<span class="lineNum">    3466 </span><span class="lineCov">      43682 :         mono_assemblies_lock ();</span>
<span class="lineNum">    3467 </span><span class="lineCov">      43682 :         loaded_assemblies = g_list_remove (loaded_assemblies, assembly);</span>
<span class="lineNum">    3468 </span><span class="lineCov">      43682 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    3469 </span>            : 
<span class="lineNum">    3470 </span><span class="lineCov">      43682 :         assembly-&gt;image-&gt;assembly = NULL;</span>
<span class="lineNum">    3471 </span>            : 
<span class="lineNum">    3472 </span><span class="lineCov">      43682 :         if (!mono_image_close_except_pools (assembly-&gt;image))</span>
<span class="lineNum">    3473 </span><span class="lineCov">       3244 :                 assembly-&gt;image = NULL;</span>
<span class="lineNum">    3474 </span>            : 
<span class="lineNum">    3475 </span><span class="lineCov">     234838 :         for (tmp = assembly-&gt;friend_assembly_names; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    3476 </span><span class="lineCov">      73737 :                 MonoAssemblyName *fname = (MonoAssemblyName *)tmp-&gt;data;</span>
<span class="lineNum">    3477 </span><span class="lineCov">      73737 :                 mono_assembly_name_free (fname);</span>
<span class="lineNum">    3478 </span><span class="lineCov">      73737 :                 g_free (fname);</span>
<span class="lineNum">    3479 </span><span class="lineCov">      73737 :         }</span>
<span class="lineNum">    3480 </span><span class="lineCov">      43682 :         g_slist_free (assembly-&gt;friend_assembly_names);</span>
<span class="lineNum">    3481 </span><span class="lineCov">      43682 :         g_free (assembly-&gt;basedir);</span>
<span class="lineNum">    3482 </span>            : 
<span class="lineNum">    3483 </span><span class="lineCov">      43682 :         mono_profiler_assembly_event (assembly, MONO_PROFILE_END_UNLOAD);</span>
<span class="lineNum">    3484 </span>            : 
<span class="lineNum">    3485 </span><span class="lineCov">      43682 :         return TRUE;</span>
<span class="lineNum">    3486 </span><span class="lineCov">     158364 : }</span>
<a name="3487"><span class="lineNum">    3487 </span>            : </a>
<span class="lineNum">    3488 </span>            : void
<span class="lineNum">    3489 </span>            : mono_assembly_close_finish (MonoAssembly *assembly)
<span class="lineNum">    3490 </span>            : {
<span class="lineNum">    3491 </span><span class="lineCov">     218410 :         g_assert (assembly &amp;&amp; assembly != REFERENCE_MISSING);</span>
<span class="lineNum">    3492 </span>            : 
<span class="lineNum">    3493 </span><span class="lineCov">      43682 :         if (assembly-&gt;image)</span>
<span class="lineNum">    3494 </span><span class="lineCov">      40438 :                 mono_image_close_finish (assembly-&gt;image);</span>
<span class="lineNum">    3495 </span>            : 
<span class="lineNum">    3496 </span><span class="lineCov">      43682 :         if (assembly_is_dynamic (assembly)) {</span>
<span class="lineNum">    3497 </span><span class="lineCov">         48 :                 g_free ((char*)assembly-&gt;aname.culture);</span>
<span class="lineNum">    3498 </span><span class="lineCov">         48 :         } else {</span>
<span class="lineNum">    3499 </span><span class="lineCov">      43634 :                 g_free (assembly);</span>
<span class="lineNum">    3500 </span>            :         }
<span class="lineNum">    3501 </span><span class="lineCov">      43682 : }</span>
<span class="lineNum">    3502 </span>            : 
<span class="lineNum">    3503 </span>            : /**
<span class="lineNum">    3504 </span>            :  * mono_assembly_close:
<span class="lineNum">    3505 </span>            :  * @assembly: the assembly to release.
<span class="lineNum">    3506 </span>            :  *
<span class="lineNum">    3507 </span>            :  * This method releases a reference to the @assembly.  The assembly is
<span class="lineNum">    3508 </span>            :  * only released when all the outstanding references to it are released.
<a name="3509"><span class="lineNum">    3509 </span>            :  */</a>
<span class="lineNum">    3510 </span>            : void
<span class="lineNum">    3511 </span>            : mono_assembly_close (MonoAssembly *assembly)
<span class="lineNum">    3512 </span>            : {
<span class="lineNum">    3513 </span><span class="lineNoCov">          0 :         if (mono_assembly_close_except_image_pools (assembly))</span>
<span class="lineNum">    3514 </span><span class="lineNoCov">          0 :                 mono_assembly_close_finish (assembly);</span>
<span class="lineNum">    3515 </span><span class="lineNoCov">          0 : }</span>
<a name="3516"><span class="lineNum">    3516 </span>            : </a>
<span class="lineNum">    3517 </span>            : MonoImage*
<span class="lineNum">    3518 </span>            : mono_assembly_load_module (MonoAssembly *assembly, guint32 idx)
<span class="lineNum">    3519 </span>            : {
<span class="lineNum">    3520 </span>            :         MonoError error;
<span class="lineNum">    3521 </span><span class="lineNoCov">          0 :         MonoImage *result = mono_assembly_load_module_checked (assembly, idx, &amp;error);</span>
<span class="lineNum">    3522 </span><span class="lineNoCov">          0 :         mono_error_assert_ok (&amp;error);</span>
<span class="lineNum">    3523 </span><span class="lineNoCov">          0 :         return result;</span>
<span class="lineNum">    3524 </span>            : }
<a name="3525"><span class="lineNum">    3525 </span>            : </a>
<span class="lineNum">    3526 </span>            : MONO_API MonoImage*
<span class="lineNum">    3527 </span>            : mono_assembly_load_module_checked (MonoAssembly *assembly, uint32_t idx, MonoError *error)
<span class="lineNum">    3528 </span>            : {
<span class="lineNum">    3529 </span><span class="lineCov">          1 :         return mono_image_load_file_for_image_checked (assembly-&gt;image, idx, error);</span>
<span class="lineNum">    3530 </span>            : }
<span class="lineNum">    3531 </span>            : 
<span class="lineNum">    3532 </span>            : 
<span class="lineNum">    3533 </span>            : /**
<span class="lineNum">    3534 </span>            :  * mono_assembly_foreach:
<span class="lineNum">    3535 </span>            :  * @func: function to invoke for each assembly loaded
<span class="lineNum">    3536 </span>            :  * @user_data: data passed to the callback
<span class="lineNum">    3537 </span>            :  *
<span class="lineNum">    3538 </span>            :  * Invokes the provided @func callback for each assembly loaded into
<span class="lineNum">    3539 </span>            :  * the runtime.   The first parameter passed to the callback  is the
<span class="lineNum">    3540 </span>            :  * `MonoAssembly*`, and the second parameter is the @user_data.
<span class="lineNum">    3541 </span>            :  *
<span class="lineNum">    3542 </span>            :  * This is done for all assemblies loaded in the runtime, not just
<span class="lineNum">    3543 </span>            :  * those loaded in the current application domain.
<a name="3544"><span class="lineNum">    3544 </span>            :  */</a>
<span class="lineNum">    3545 </span>            : void
<span class="lineNum">    3546 </span>            : mono_assembly_foreach (GFunc func, gpointer user_data)
<span class="lineNum">    3547 </span>            : {
<span class="lineNum">    3548 </span>            :         GList *copy;
<span class="lineNum">    3549 </span>            : 
<span class="lineNum">    3550 </span>            :         /*
<span class="lineNum">    3551 </span>            :          * We make a copy of the list to avoid calling the callback inside the 
<span class="lineNum">    3552 </span>            :          * lock, which could lead to deadlocks.
<span class="lineNum">    3553 </span>            :          */
<span class="lineNum">    3554 </span><span class="lineNoCov">          0 :         mono_assemblies_lock ();</span>
<span class="lineNum">    3555 </span><span class="lineNoCov">          0 :         copy = g_list_copy (loaded_assemblies);</span>
<span class="lineNum">    3556 </span><span class="lineNoCov">          0 :         mono_assemblies_unlock ();</span>
<span class="lineNum">    3557 </span>            : 
<span class="lineNum">    3558 </span><span class="lineNoCov">          0 :         g_list_foreach (loaded_assemblies, func, user_data);</span>
<span class="lineNum">    3559 </span>            : 
<span class="lineNum">    3560 </span><span class="lineNoCov">          0 :         g_list_free (copy);</span>
<span class="lineNum">    3561 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3562 </span>            : 
<span class="lineNum">    3563 </span>            : /**
<span class="lineNum">    3564 </span>            :  * mono_assemblies_cleanup:
<span class="lineNum">    3565 </span>            :  *
<span class="lineNum">    3566 </span>            :  * Free all resources used by this module.
<a name="3567"><span class="lineNum">    3567 </span>            :  */</a>
<span class="lineNum">    3568 </span>            : void
<span class="lineNum">    3569 </span>            : mono_assemblies_cleanup (void)
<span class="lineNum">    3570 </span>            : {
<span class="lineNum">    3571 </span>            :         GSList *l;
<span class="lineNum">    3572 </span>            : 
<span class="lineNum">    3573 </span><span class="lineCov">       3272 :         mono_os_mutex_destroy (&amp;assemblies_mutex);</span>
<span class="lineNum">    3574 </span><span class="lineCov">       3272 :         mono_os_mutex_destroy (&amp;assembly_binding_mutex);</span>
<span class="lineNum">    3575 </span>            : 
<span class="lineNum">    3576 </span><span class="lineCov">      85110 :         for (l = loaded_assembly_bindings; l; l = l-&gt;next) {</span>
<span class="lineNum">    3577 </span><span class="lineCov">      39283 :                 MonoAssemblyBindingInfo *info = (MonoAssemblyBindingInfo *)l-&gt;data;</span>
<span class="lineNum">    3578 </span>            : 
<span class="lineNum">    3579 </span><span class="lineCov">      39283 :                 mono_assembly_binding_info_free (info);</span>
<span class="lineNum">    3580 </span><span class="lineCov">      39283 :                 g_free (info);</span>
<span class="lineNum">    3581 </span><span class="lineCov">      39283 :         }</span>
<span class="lineNum">    3582 </span><span class="lineCov">       3272 :         g_slist_free (loaded_assembly_bindings);</span>
<span class="lineNum">    3583 </span>            : 
<span class="lineNum">    3584 </span><span class="lineCov">       3272 :         free_assembly_load_hooks ();</span>
<span class="lineNum">    3585 </span><span class="lineCov">       3272 :         free_assembly_search_hooks ();</span>
<span class="lineNum">    3586 </span><span class="lineCov">       3272 :         free_assembly_preload_hooks ();</span>
<span class="lineNum">    3587 </span><span class="lineCov">       3272 : }</span>
<span class="lineNum">    3588 </span>            : 
<a name="3589"><span class="lineNum">    3589 </span>            : /*LOCKING takes the assembly_binding lock*/</a>
<span class="lineNum">    3590 </span>            : void
<span class="lineNum">    3591 </span>            : mono_assembly_cleanup_domain_bindings (guint32 domain_id)
<span class="lineNum">    3592 </span>            : {
<span class="lineNum">    3593 </span>            :         GSList **iter;
<span class="lineNum">    3594 </span>            : 
<span class="lineNum">    3595 </span><span class="lineCov">        213 :         mono_assembly_binding_lock ();</span>
<span class="lineNum">    3596 </span><span class="lineCov">        213 :         iter = &amp;loaded_assembly_bindings;</span>
<span class="lineNum">    3597 </span><span class="lineCov">       1684 :         while (*iter) {</span>
<span class="lineNum">    3598 </span><span class="lineCov">        629 :                 GSList *l = *iter;</span>
<span class="lineNum">    3599 </span><span class="lineCov">        629 :                 MonoAssemblyBindingInfo *info = (MonoAssemblyBindingInfo *)l-&gt;data;</span>
<span class="lineNum">    3600 </span>            : 
<span class="lineNum">    3601 </span><span class="lineCov">        629 :                 if (info-&gt;domain_id == domain_id) {</span>
<span class="lineNum">    3602 </span><span class="lineNoCov">          0 :                         *iter = l-&gt;next;</span>
<span class="lineNum">    3603 </span><span class="lineNoCov">          0 :                         mono_assembly_binding_info_free (info);</span>
<span class="lineNum">    3604 </span><span class="lineNoCov">          0 :                         g_free (info);</span>
<span class="lineNum">    3605 </span><span class="lineNoCov">          0 :                         g_slist_free_1 (l);</span>
<span class="lineNum">    3606 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    3607 </span><span class="lineCov">        629 :                         iter = &amp;l-&gt;next;</span>
<span class="lineNum">    3608 </span>            :                 }
<span class="lineNum">    3609 </span>            :         }
<span class="lineNum">    3610 </span><span class="lineCov">        213 :         mono_assembly_binding_unlock ();</span>
<span class="lineNum">    3611 </span><span class="lineCov">        213 : }</span>
<span class="lineNum">    3612 </span>            : 
<span class="lineNum">    3613 </span>            : /*
<span class="lineNum">    3614 </span>            :  * Holds the assembly of the application, for
<span class="lineNum">    3615 </span>            :  * System.Diagnostics.Process::MainModule
<span class="lineNum">    3616 </span>            :  */
<span class="lineNum">    3617 </span>            : static MonoAssembly *main_assembly=NULL;
<a name="3618"><span class="lineNum">    3618 </span>            : </a>
<span class="lineNum">    3619 </span>            : void
<span class="lineNum">    3620 </span>            : mono_assembly_set_main (MonoAssembly *assembly)
<span class="lineNum">    3621 </span>            : {
<span class="lineNum">    3622 </span><span class="lineCov">       3274 :         main_assembly = assembly;</span>
<span class="lineNum">    3623 </span><span class="lineCov">       3274 : }</span>
<span class="lineNum">    3624 </span>            : 
<span class="lineNum">    3625 </span>            : /**
<span class="lineNum">    3626 </span>            :  * mono_assembly_get_main:
<span class="lineNum">    3627 </span>            :  *
<span class="lineNum">    3628 </span>            :  * Returns: the assembly for the application, the first assembly that is loaded by the VM
<a name="3629"><span class="lineNum">    3629 </span>            :  */</a>
<span class="lineNum">    3630 </span>            : MonoAssembly *
<span class="lineNum">    3631 </span>            : mono_assembly_get_main (void)
<span class="lineNum">    3632 </span>            : {
<span class="lineNum">    3633 </span><span class="lineNoCov">          0 :         return (main_assembly);</span>
<span class="lineNum">    3634 </span>            : }
<span class="lineNum">    3635 </span>            : 
<span class="lineNum">    3636 </span>            : /**
<span class="lineNum">    3637 </span>            :  * mono_assembly_get_image:
<span class="lineNum">    3638 </span>            :  * @assembly: The assembly to retrieve the image from
<span class="lineNum">    3639 </span>            :  *
<span class="lineNum">    3640 </span>            :  * Returns: the MonoImage associated with this assembly.
<a name="3641"><span class="lineNum">    3641 </span>            :  */</a>
<span class="lineNum">    3642 </span>            : MonoImage*
<span class="lineNum">    3643 </span>            : mono_assembly_get_image (MonoAssembly *assembly)
<span class="lineNum">    3644 </span>            : {
<span class="lineNum">    3645 </span><span class="lineCov">       6862 :         return assembly-&gt;image;</span>
<span class="lineNum">    3646 </span>            : }
<span class="lineNum">    3647 </span>            : 
<span class="lineNum">    3648 </span>            : /**
<span class="lineNum">    3649 </span>            :  * mono_assembly_get_name:
<span class="lineNum">    3650 </span>            :  * @assembly: The assembly to retrieve the name from
<span class="lineNum">    3651 </span>            :  *
<span class="lineNum">    3652 </span>            :  * The returned name's lifetime is the same as @assembly's.
<span class="lineNum">    3653 </span>            :  *
<span class="lineNum">    3654 </span>            :  * Returns: the MonoAssemblyName associated with this assembly.
<a name="3655"><span class="lineNum">    3655 </span>            :  */</a>
<span class="lineNum">    3656 </span>            : MonoAssemblyName *
<span class="lineNum">    3657 </span>            : mono_assembly_get_name (MonoAssembly *assembly)
<span class="lineNum">    3658 </span>            : {
<span class="lineNum">    3659 </span><span class="lineCov">         36 :         return &amp;assembly-&gt;aname;</span>
<span class="lineNum">    3660 </span>            : }
<a name="3661"><span class="lineNum">    3661 </span>            : </a>
<span class="lineNum">    3662 </span>            : void
<span class="lineNum">    3663 </span>            : mono_register_bundled_assemblies (const MonoBundledAssembly **assemblies)
<span class="lineNum">    3664 </span>            : {
<span class="lineNum">    3665 </span><span class="lineNoCov">          0 :         bundles = assemblies;</span>
<span class="lineNum">    3666 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3667 </span>            : 
<span class="lineNum">    3668 </span>            : #define MONO_DECLSEC_FORMAT_10          0x3C
<span class="lineNum">    3669 </span>            : #define MONO_DECLSEC_FORMAT_20          0x2E
<span class="lineNum">    3670 </span>            : #define MONO_DECLSEC_FIELD              0x53
<span class="lineNum">    3671 </span>            : #define MONO_DECLSEC_PROPERTY           0x54
<span class="lineNum">    3672 </span>            : 
<span class="lineNum">    3673 </span>            : #define SKIP_VISIBILITY_XML_ATTRIBUTE (&quot;\&quot;SkipVerification\&quot;&quot;)
<span class="lineNum">    3674 </span>            : #define SKIP_VISIBILITY_ATTRIBUTE_NAME (&quot;System.Security.Permissions.SecurityPermissionAttribute&quot;)
<span class="lineNum">    3675 </span>            : #define SKIP_VISIBILITY_ATTRIBUTE_SIZE (sizeof (SKIP_VISIBILITY_ATTRIBUTE_NAME) - 1)
<span class="lineNum">    3676 </span>            : #define SKIP_VISIBILITY_PROPERTY_NAME (&quot;SkipVerification&quot;)
<span class="lineNum">    3677 </span>            : #define SKIP_VISIBILITY_PROPERTY_SIZE (sizeof (SKIP_VISIBILITY_PROPERTY_NAME) - 1)
<a name="3678"><span class="lineNum">    3678 </span>            : </a>
<span class="lineNum">    3679 </span>            : static gboolean
<span class="lineNum">    3680 </span>            : mono_assembly_try_decode_skip_verification_param (const char *p, const char **resp, gboolean *abort_decoding)
<span class="lineNum">    3681 </span>            : {
<span class="lineNum">    3682 </span>            :         int len;
<span class="lineNum">    3683 </span><span class="lineCov">       4744 :         switch (*p++) {</span>
<span class="lineNum">    3684 </span>            :         case MONO_DECLSEC_PROPERTY:
<span class="lineNum">    3685 </span><span class="lineCov">       4744 :                 break;</span>
<span class="lineNum">    3686 </span>            :         case MONO_DECLSEC_FIELD:
<span class="lineNum">    3687 </span>            :         default:
<span class="lineNum">    3688 </span><span class="lineNoCov">          0 :                 *abort_decoding = TRUE;</span>
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    3690 </span>            :                 break;
<span class="lineNum">    3691 </span>            :         }
<span class="lineNum">    3692 </span>            : 
<span class="lineNum">    3693 </span><span class="lineCov">       4744 :         if (*p++ != MONO_TYPE_BOOLEAN) {</span>
<span class="lineNum">    3694 </span><span class="lineNoCov">          0 :                 *abort_decoding = TRUE;</span>
<span class="lineNum">    3695 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    3696 </span>            :         }
<span class="lineNum">    3697 </span>            :                 
<span class="lineNum">    3698 </span>            :         /* property name length */
<span class="lineNum">    3699 </span><span class="lineCov">       4744 :         len = mono_metadata_decode_value (p, &amp;p);</span>
<span class="lineNum">    3700 </span>            : 
<span class="lineNum">    3701 </span><span class="lineCov">       9488 :         if (len &gt;= SKIP_VISIBILITY_PROPERTY_SIZE &amp;&amp; !memcmp (p, SKIP_VISIBILITY_PROPERTY_NAME, SKIP_VISIBILITY_PROPERTY_SIZE)) {</span>
<span class="lineNum">    3702 </span><span class="lineCov">       4744 :                 p += len;</span>
<span class="lineNum">    3703 </span><span class="lineCov">       4744 :                 return *p;</span>
<span class="lineNum">    3704 </span>            :         }
<span class="lineNum">    3705 </span><span class="lineNoCov">          0 :         p += len + 1;</span>
<span class="lineNum">    3706 </span>            : 
<span class="lineNum">    3707 </span><span class="lineNoCov">          0 :         *resp = p;</span>
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">    3709 </span><span class="lineCov">       4744 : }</span>
<a name="3710"><span class="lineNum">    3710 </span>            : </a>
<span class="lineNum">    3711 </span>            : static gboolean
<span class="lineNum">    3712 </span>            : mono_assembly_try_decode_skip_verification (const char *p, const char *endn)
<span class="lineNum">    3713 </span>            : {
<span class="lineNum">    3714 </span>            :         int i, j, num, len, params_len;
<span class="lineNum">    3715 </span>            : 
<span class="lineNum">    3716 </span><span class="lineCov">       4744 :         if (*p == MONO_DECLSEC_FORMAT_10) {</span>
<span class="lineNum">    3717 </span>            :                 gsize read, written;
<span class="lineNum">    3718 </span><span class="lineNoCov">          0 :                 char *res = g_convert (p, endn - p, &quot;UTF-8&quot;, &quot;UTF-16LE&quot;, &amp;read, &amp;written, NULL);</span>
<span class="lineNum">    3719 </span><span class="lineNoCov">          0 :                 if (res) {</span>
<span class="lineNum">    3720 </span><span class="lineNoCov">          0 :                         gboolean found = strstr (res, SKIP_VISIBILITY_XML_ATTRIBUTE) != NULL;</span>
<span class="lineNum">    3721 </span><span class="lineNoCov">          0 :                         g_free (res);</span>
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 :                         return found;</span>
<span class="lineNum">    3723 </span>            :                 }
<span class="lineNum">    3724 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    3725 </span>            :         }
<span class="lineNum">    3726 </span><span class="lineCov">       4744 :         if (*p++ != MONO_DECLSEC_FORMAT_20)</span>
<span class="lineNum">    3727 </span><span class="lineNoCov">          0 :                 return FALSE;</span>
<span class="lineNum">    3728 </span>            : 
<span class="lineNum">    3729 </span>            :         /* number of encoded permission attributes */
<span class="lineNum">    3730 </span><span class="lineCov">       4744 :         num = mono_metadata_decode_value (p, &amp;p);</span>
<span class="lineNum">    3731 </span><span class="lineCov">       9488 :         for (i = 0; i &lt; num; ++i) {</span>
<span class="lineNum">    3732 </span><span class="lineCov">       4744 :                 gboolean is_valid = FALSE;</span>
<span class="lineNum">    3733 </span><span class="lineCov">       4744 :                 gboolean abort_decoding = FALSE;</span>
<span class="lineNum">    3734 </span>            : 
<span class="lineNum">    3735 </span>            :                 /* attribute name length */
<span class="lineNum">    3736 </span><span class="lineCov">       4744 :                 len =  mono_metadata_decode_value (p, &amp;p);</span>
<span class="lineNum">    3737 </span>            : 
<span class="lineNum">    3738 </span>            :                 /* We don't really need to fully decode the type. Comparing the name is enough */
<span class="lineNum">    3739 </span><span class="lineCov">      14232 :                 is_valid = len &gt;= SKIP_VISIBILITY_ATTRIBUTE_SIZE &amp;&amp; !memcmp (p, SKIP_VISIBILITY_ATTRIBUTE_NAME, SKIP_VISIBILITY_ATTRIBUTE_SIZE);</span>
<span class="lineNum">    3740 </span>            : 
<span class="lineNum">    3741 </span><span class="lineCov">       4744 :                 p += len;</span>
<span class="lineNum">    3742 </span>            : 
<span class="lineNum">    3743 </span>            :                 /*size of the params table*/
<span class="lineNum">    3744 </span><span class="lineCov">       4744 :                 params_len =  mono_metadata_decode_value (p, &amp;p);</span>
<span class="lineNum">    3745 </span><span class="lineCov">       4744 :                 if (is_valid) {</span>
<span class="lineNum">    3746 </span><span class="lineCov">       4744 :                         const char *params_end = p + params_len;</span>
<span class="lineNum">    3747 </span>            :                         
<span class="lineNum">    3748 </span>            :                         /* number of parameters */
<span class="lineNum">    3749 </span><span class="lineCov">       4744 :                         len = mono_metadata_decode_value (p, &amp;p);</span>
<span class="lineNum">    3750 </span>            :         
<span class="lineNum">    3751 </span><span class="lineCov">       9488 :                         for (j = 0; j &lt; len; ++j) {</span>
<span class="lineNum">    3752 </span><span class="lineCov">       4744 :                                 if (mono_assembly_try_decode_skip_verification_param (p, &amp;p, &amp;abort_decoding))</span>
<span class="lineNum">    3753 </span><span class="lineCov">       4744 :                                         return TRUE;</span>
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 :                                 if (abort_decoding)</span>
<span class="lineNum">    3755 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">    3756 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    3757 </span><span class="lineNoCov">          0 :                         p = params_end;</span>
<span class="lineNum">    3758 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    3759 </span><span class="lineNoCov">          0 :                         p += params_len;</span>
<span class="lineNum">    3760 </span>            :                 }
<span class="lineNum">    3761 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3762 </span>            :         
<span class="lineNum">    3763 </span><span class="lineNoCov">          0 :         return FALSE;</span>
<span class="lineNum">    3764 </span><span class="lineCov">       4744 : }</span>
<span class="lineNum">    3765 </span>            : 
<a name="3766"><span class="lineNum">    3766 </span>            : </a>
<span class="lineNum">    3767 </span>            : gboolean
<span class="lineNum">    3768 </span>            : mono_assembly_has_skip_verification (MonoAssembly *assembly)
<span class="lineNum">    3769 </span>            : {
<span class="lineNum">    3770 </span>            :         MonoTableInfo *t;       
<span class="lineNum">    3771 </span>            :         guint32 cols [MONO_DECL_SECURITY_SIZE];
<span class="lineNum">    3772 </span>            :         const char *blob;
<span class="lineNum">    3773 </span>            :         int i, len;
<span class="lineNum">    3774 </span>            : 
<span class="lineNum">    3775 </span><span class="lineCov">   35957235 :         if (MONO_SECMAN_FLAG_INIT (assembly-&gt;skipverification))</span>
<span class="lineNum">    3776 </span><span class="lineCov">   35950038 :                 return MONO_SECMAN_FLAG_GET_VALUE (assembly-&gt;skipverification);</span>
<span class="lineNum">    3777 </span>            : 
<span class="lineNum">    3778 </span><span class="lineCov">      12452 :         t = &amp;assembly-&gt;image-&gt;tables [MONO_TABLE_DECLSECURITY];</span>
<span class="lineNum">    3779 </span>            : 
<span class="lineNum">    3780 </span><span class="lineCov">      24950 :         for (i = 0; i &lt; t-&gt;rows; ++i) {</span>
<span class="lineNum">    3781 </span><span class="lineCov">       4767 :                 mono_metadata_decode_row (t, i, cols, MONO_DECL_SECURITY_SIZE);</span>
<span class="lineNum">    3782 </span><span class="lineCov">       4767 :                 if ((cols [MONO_DECL_SECURITY_PARENT] &amp; MONO_HAS_DECL_SECURITY_MASK) != MONO_HAS_DECL_SECURITY_ASSEMBLY)</span>
<span class="lineNum">    3783 </span><span class="lineCov">         23 :                         continue;</span>
<span class="lineNum">    3784 </span><span class="lineCov">       4744 :                 if (cols [MONO_DECL_SECURITY_ACTION] != SECURITY_ACTION_REQMIN)</span>
<span class="lineNum">    3785 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    3786 </span>            : 
<span class="lineNum">    3787 </span><span class="lineCov">       4744 :                 blob = mono_metadata_blob_heap (assembly-&gt;image, cols [MONO_DECL_SECURITY_PERMISSIONSET]);</span>
<span class="lineNum">    3788 </span><span class="lineCov">       4744 :                 len = mono_metadata_decode_blob_size (blob, &amp;blob);</span>
<span class="lineNum">    3789 </span><span class="lineCov">       4744 :                 if (!len)</span>
<span class="lineNum">    3790 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    3791 </span>            : 
<span class="lineNum">    3792 </span><span class="lineCov">       4744 :                 if (mono_assembly_try_decode_skip_verification (blob, blob + len)) {</span>
<span class="lineNum">    3793 </span><span class="lineCov">       9488 :                         MONO_SECMAN_FLAG_SET_VALUE (assembly-&gt;skipverification, TRUE);</span>
<span class="lineNum">    3794 </span><span class="lineCov">       4744 :                         return TRUE;</span>
<span class="lineNum">    3795 </span>            :                 }
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    3797 </span>            : 
<span class="lineNum">    3798 </span><span class="lineCov">      15416 :         MONO_SECMAN_FLAG_SET_VALUE (assembly-&gt;skipverification, FALSE);</span>
<span class="lineNum">    3799 </span><span class="lineCov">       7708 :         return FALSE;</span>
<span class="lineNum">    3800 </span><span class="lineCov">   35956210 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
