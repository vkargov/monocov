<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mono.info - metadata/domain.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">metadata</a> - domain.c<span style="font-size: 80%;"> (source / <a href="domain.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mono.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">622</td>
            <td class="headerCovTableEntry">761</td>
            <td class="headerCovTableEntryMed">81.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-01-18 17:24:17</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">54</td>
            <td class="headerCovTableEntry">78</td>
            <td class="headerCovTableEntryLo">69.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  * domain.c: MonoDomain functions
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Author:
<span class="lineNum">       5 </span>            :  *      Dietmar Maurer (dietmar@ximian.com)
<span class="lineNum">       6 </span>            :  *      Patrik Torstensson
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  * Copyright 2001-2003 Ximian, Inc (http://www.ximian.com)
<span class="lineNum">       9 </span>            :  * Copyright 2004-2009 Novell, Inc (http://www.novell.com)
<span class="lineNum">      10 </span>            :  * Copyright 2011-2012 Xamarin, Inc (http://www.xamarin.com)
<span class="lineNum">      11 </span>            :  * Licensed under the MIT license. See LICENSE file in the project root for full license information.
<span class="lineNum">      12 </span>            :  */
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : #include &lt;config.h&gt;
<span class="lineNum">      15 </span>            : #include &lt;glib.h&gt;
<span class="lineNum">      16 </span>            : #include &lt;string.h&gt;
<span class="lineNum">      17 </span>            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #include &lt;mono/metadata/gc-internals.h&gt;
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : #include &lt;mono/utils/atomic.h&gt;
<span class="lineNum">      22 </span>            : #include &lt;mono/utils/mono-compiler.h&gt;
<span class="lineNum">      23 </span>            : #include &lt;mono/utils/mono-logger-internals.h&gt;
<span class="lineNum">      24 </span>            : #include &lt;mono/utils/mono-membar.h&gt;
<span class="lineNum">      25 </span>            : #include &lt;mono/utils/mono-counters.h&gt;
<span class="lineNum">      26 </span>            : #include &lt;mono/utils/hazard-pointer.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;mono/utils/mono-tls.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;mono/utils/mono-mmap.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;mono/utils/mono-threads.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;mono/metadata/object.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;mono/metadata/object-internals.h&gt;
<span class="lineNum">      32 </span>            : #include &lt;mono/metadata/domain-internals.h&gt;
<span class="lineNum">      33 </span>            : #include &lt;mono/metadata/class-internals.h&gt;
<span class="lineNum">      34 </span>            : #include &lt;mono/metadata/assembly.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;mono/metadata/exception.h&gt;
<span class="lineNum">      36 </span>            : #include &lt;mono/metadata/metadata-internals.h&gt;
<span class="lineNum">      37 </span>            : #include &lt;mono/metadata/gc-internals.h&gt;
<span class="lineNum">      38 </span>            : #include &lt;mono/metadata/appdomain.h&gt;
<span class="lineNum">      39 </span>            : #include &lt;mono/metadata/mono-debug-debugger.h&gt;
<span class="lineNum">      40 </span>            : #include &lt;mono/metadata/mono-config.h&gt;
<span class="lineNum">      41 </span>            : #include &lt;mono/metadata/threads-types.h&gt;
<span class="lineNum">      42 </span>            : #include &lt;mono/metadata/runtime.h&gt;
<span class="lineNum">      43 </span>            : #include &lt;mono/metadata/w32mutex.h&gt;
<span class="lineNum">      44 </span>            : #include &lt;mono/metadata/w32semaphore.h&gt;
<span class="lineNum">      45 </span>            : #include &lt;mono/metadata/w32event.h&gt;
<span class="lineNum">      46 </span>            : #include &lt;mono/metadata/w32process.h&gt;
<span class="lineNum">      47 </span>            : #include &lt;metadata/threads.h&gt;
<span class="lineNum">      48 </span>            : #include &lt;metadata/profiler-private.h&gt;
<span class="lineNum">      49 </span>            : #include &lt;mono/metadata/coree.h&gt;
<span class="lineNum">      50 </span>            : #include &lt;mono/io-layer/io-layer.h&gt;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : //#define DEBUG_DOMAIN_UNLOAD 1
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : #define GET_APPDOMAIN() ((MonoDomain*)mono_tls_get_domain ())
<span class="lineNum">      55 </span>            : #define SET_APPDOMAIN(x) do { \
<span class="lineNum">      56 </span>            :         MonoThreadInfo *info; \
<span class="lineNum">      57 </span>            :         mono_tls_set_domain (x); \
<span class="lineNum">      58 </span>            :         info = mono_thread_info_current (); \
<span class="lineNum">      59 </span>            :         if (info) \
<span class="lineNum">      60 </span>            :                 mono_thread_info_tls_set (info, TLS_KEY_DOMAIN, (x));   \
<span class="lineNum">      61 </span>            : } while (FALSE)
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            : #define GET_APPCONTEXT() (mono_thread_internal_current ()-&gt;current_appcontext)
<span class="lineNum">      64 </span>            : #define SET_APPCONTEXT(x) MONO_OBJECT_SETREF (mono_thread_internal_current (), current_appcontext, (x))
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : static guint16 appdomain_list_size = 0;
<span class="lineNum">      67 </span>            : static guint16 appdomain_next = 0;
<span class="lineNum">      68 </span>            : static MonoDomain **appdomains_list = NULL;
<span class="lineNum">      69 </span>            : static MonoImage *exe_image;
<span class="lineNum">      70 </span>            : static gboolean debug_domain_unload;
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : gboolean mono_dont_free_domains;
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : #define mono_appdomains_lock() mono_coop_mutex_lock (&amp;appdomains_mutex)
<span class="lineNum">      75 </span>            : #define mono_appdomains_unlock() mono_coop_mutex_unlock (&amp;appdomains_mutex)
<span class="lineNum">      76 </span>            : static MonoCoopMutex appdomains_mutex;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : static MonoDomain *mono_root_domain = NULL;
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            : /* some statistics */
<span class="lineNum">      81 </span>            : static int max_domain_code_size = 0;
<span class="lineNum">      82 </span>            : static int max_domain_code_alloc = 0;
<span class="lineNum">      83 </span>            : static int total_domain_code_alloc = 0;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            : /* AppConfigInfo: Information about runtime versions supported by an 
<span class="lineNum">      86 </span>            :  * aplication.
<span class="lineNum">      87 </span>            :  */
<span class="lineNum">      88 </span>            : typedef struct {
<span class="lineNum">      89 </span>            :         GSList *supported_runtimes;
<span class="lineNum">      90 </span>            :         char *required_runtime;
<span class="lineNum">      91 </span>            :         int configuration_count;
<span class="lineNum">      92 </span>            :         int startup_count;
<span class="lineNum">      93 </span>            : } AppConfigInfo;
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : static const MonoRuntimeInfo *current_runtime = NULL;
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            : /* This is the list of runtime versions supported by this JIT.
<span class="lineNum">      98 </span>            :  */
<span class="lineNum">      99 </span>            : static const MonoRuntimeInfo supported_runtimes[] = {
<span class="lineNum">     100 </span>            :         {&quot;v4.0.30319&quot;,&quot;4.5&quot;, { {4,0,0,0}, {10,0,0,0}, {4,0,0,0}, {4,0,0,0} } },
<span class="lineNum">     101 </span>            :         {&quot;mobile&quot;,    &quot;2.1&quot;, { {2,0,5,0}, {10,0,0,0}, {2,0,5,0}, {2,0,5,0} } },
<span class="lineNum">     102 </span>            :         {&quot;moonlight&quot;, &quot;2.1&quot;, { {2,0,5,0}, { 9,0,0,0}, {3,5,0,0}, {3,0,0,0} } },
<span class="lineNum">     103 </span>            : };
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            : /* The stable runtime version */
<span class="lineNum">     107 </span>            : #define DEFAULT_RUNTIME_VERSION &quot;v4.0.30319&quot;
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span>            : /* Callbacks installed by the JIT */
<span class="lineNum">     110 </span>            : static MonoCreateDomainFunc create_domain_hook;
<span class="lineNum">     111 </span>            : static MonoFreeDomainFunc free_domain_hook;
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : /* AOT cache configuration */
<span class="lineNum">     114 </span>            : static MonoAotCacheConfig aot_cache_config;
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            : static void
<span class="lineNum">     117 </span>            : get_runtimes_from_exe (const char *exe_file, MonoImage **exe_image, const MonoRuntimeInfo** runtimes);
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span>            : static const MonoRuntimeInfo*
<span class="lineNum">     120 </span>            : get_runtime_by_version (const char *version);
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span>            : #define ALIGN_TO(val,align) ((((guint64)val) + ((align) - 1)) &amp; ~((align) - 1))
<span class="lineNum">     123 </span>            : #define ALIGN_PTR_TO(ptr,align) (gpointer)((((gssize)(ptr)) + (align - 1)) &amp; (~(align - 1)))
<a name="124"><span class="lineNum">     124 </span>            : </a>
<span class="lineNum">     125 </span>            : static LockFreeMempool*
<span class="lineNum">     126 </span>            : lock_free_mempool_new (void)
<span class="lineNum">     127 </span>            : {
<span class="lineNum">     128 </span><span class="lineCov">       3538 :         return g_new0 (LockFreeMempool, 1);</span>
<span class="lineNum">     129 </span>            : }
<a name="130"><span class="lineNum">     130 </span>            : </a>
<span class="lineNum">     131 </span>            : static void
<span class="lineNum">     132 </span>            : lock_free_mempool_free (LockFreeMempool *mp)
<span class="lineNum">     133 </span>            : {
<span class="lineNum">     134 </span>            :         LockFreeMempoolChunk *chunk, *next;
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span><span class="lineCov">       3485 :         chunk = mp-&gt;chunks;</span>
<span class="lineNum">     137 </span><span class="lineCov">       7040 :         while (chunk) {</span>
<span class="lineNum">     138 </span><span class="lineCov">         35 :                 next = (LockFreeMempoolChunk *)chunk-&gt;prev;</span>
<span class="lineNum">     139 </span><span class="lineCov">         35 :                 mono_vfree (chunk, mono_pagesize (), MONO_MEM_ACCOUNT_DOMAIN);</span>
<span class="lineNum">     140 </span><span class="lineCov">         35 :                 chunk = next;</span>
<span class="lineNum">     141 </span>            :         }
<span class="lineNum">     142 </span><span class="lineCov">       3485 :         g_free (mp);</span>
<span class="lineNum">     143 </span><span class="lineCov">       3485 : }</span>
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            : /*
<span class="lineNum">     146 </span>            :  * This is async safe
<a name="147"><span class="lineNum">     147 </span>            :  */</a>
<span class="lineNum">     148 </span>            : static LockFreeMempoolChunk*
<span class="lineNum">     149 </span>            : lock_free_mempool_chunk_new (LockFreeMempool *mp, int len)
<span class="lineNum">     150 </span>            : {
<span class="lineNum">     151 </span>            :         LockFreeMempoolChunk *chunk, *prev;
<span class="lineNum">     152 </span>            :         int size;
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span><span class="lineCov">         35 :         size = mono_pagesize ();</span>
<span class="lineNum">     155 </span><span class="lineCov">         70 :         while (size - sizeof (LockFreeMempoolChunk) &lt; len)</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                 size += mono_pagesize ();</span>
<span class="lineNum">     157 </span><span class="lineCov">         35 :         chunk = (LockFreeMempoolChunk *)mono_valloc (0, size, MONO_MMAP_READ|MONO_MMAP_WRITE, MONO_MEM_ACCOUNT_DOMAIN);</span>
<span class="lineNum">     158 </span><span class="lineCov">        105 :         g_assert (chunk);</span>
<span class="lineNum">     159 </span><span class="lineCov">         35 :         chunk-&gt;mem = (guint8 *)ALIGN_PTR_TO ((char*)chunk + sizeof (LockFreeMempoolChunk), 16);</span>
<span class="lineNum">     160 </span><span class="lineCov">         35 :         chunk-&gt;size = ((char*)chunk + size) - (char*)chunk-&gt;mem;</span>
<span class="lineNum">     161 </span><span class="lineCov">         35 :         chunk-&gt;pos = 0;</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :         /* Add to list of chunks lock-free */
<span class="lineNum">     164 </span><span class="lineCov">         35 :         while (TRUE) {</span>
<span class="lineNum">     165 </span><span class="lineCov">         35 :                 prev = mp-&gt;chunks;</span>
<span class="lineNum">     166 </span><span class="lineCov">         35 :                 if (InterlockedCompareExchangePointer ((volatile gpointer*)&amp;mp-&gt;chunks, chunk, prev) == prev)</span>
<span class="lineNum">     167 </span><span class="lineCov">         35 :                         break;</span>
<span class="lineNum">     168 </span>            :         }
<span class="lineNum">     169 </span><span class="lineCov">         35 :         chunk-&gt;prev = prev;</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineCov">         35 :         return chunk;</span>
<span class="lineNum">     172 </span>            : }
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            : /*
<span class="lineNum">     175 </span>            :  * This is async safe
<a name="176"><span class="lineNum">     176 </span>            :  */</a>
<span class="lineNum">     177 </span>            : static gpointer
<span class="lineNum">     178 </span>            : lock_free_mempool_alloc0 (LockFreeMempool *mp, guint size)
<span class="lineNum">     179 </span>            : {
<span class="lineNum">     180 </span>            :         LockFreeMempoolChunk *chunk;
<span class="lineNum">     181 </span>            :         gpointer res;
<span class="lineNum">     182 </span>            :         int oldpos;
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :         // FIXME: Free the allocator
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineCov">        284 :         size = ALIGN_TO (size, 8);</span>
<span class="lineNum">     187 </span><span class="lineCov">        284 :         chunk = mp-&gt;current;</span>
<span class="lineNum">     188 </span><span class="lineCov">        284 :         if (!chunk) {</span>
<span class="lineNum">     189 </span><span class="lineCov">         35 :                 chunk = lock_free_mempool_chunk_new (mp, size);</span>
<span class="lineNum">     190 </span><span class="lineCov">         35 :                 mono_memory_barrier ();</span>
<span class="lineNum">     191 </span>            :                 /* Publish */
<span class="lineNum">     192 </span><span class="lineCov">         35 :                 mp-&gt;current = chunk;</span>
<span class="lineNum">     193 </span><span class="lineCov">         35 :         }</span>
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :         /* The code below is lock-free, 'chunk' is shared state */
<span class="lineNum">     196 </span><span class="lineCov">        284 :         oldpos = InterlockedExchangeAdd (&amp;chunk-&gt;pos, size);</span>
<span class="lineNum">     197 </span><span class="lineCov">        284 :         if (oldpos + size &gt; chunk-&gt;size) {</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :                 chunk = lock_free_mempool_chunk_new (mp, size);</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :                 g_assert (chunk-&gt;pos + size &lt;= chunk-&gt;size);</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :                 res = chunk-&gt;mem;</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :                 chunk-&gt;pos += size;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :                 mono_memory_barrier ();</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                 mp-&gt;current = chunk;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     205 </span><span class="lineCov">        284 :                 res = (char*)chunk-&gt;mem + oldpos;</span>
<span class="lineNum">     206 </span>            :         }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineCov">        284 :         return res;</span>
<span class="lineNum">     209 </span>            : }
<a name="210"><span class="lineNum">     210 </span>            : </a>
<span class="lineNum">     211 </span>            : void
<span class="lineNum">     212 </span>            : mono_install_create_domain_hook (MonoCreateDomainFunc func)
<span class="lineNum">     213 </span>            : {
<span class="lineNum">     214 </span><span class="lineCov">       3285 :         create_domain_hook = func;</span>
<span class="lineNum">     215 </span><span class="lineCov">       3285 : }</span>
<a name="216"><span class="lineNum">     216 </span>            : </a>
<span class="lineNum">     217 </span>            : void
<span class="lineNum">     218 </span>            : mono_install_free_domain_hook (MonoFreeDomainFunc func)
<span class="lineNum">     219 </span>            : {
<span class="lineNum">     220 </span><span class="lineCov">       3285 :         free_domain_hook = func;</span>
<span class="lineNum">     221 </span><span class="lineCov">       3285 : }</span>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span>            : /**
<span class="lineNum">     224 </span>            :  * mono_string_equal:
<span class="lineNum">     225 </span>            :  * @s1: First string to compare
<span class="lineNum">     226 </span>            :  * @s2: Second string to compare
<span class="lineNum">     227 </span>            :  *
<span class="lineNum">     228 </span>            :  * Compares two `MonoString*` instances ordinally for equality.
<span class="lineNum">     229 </span>            :  *
<span class="lineNum">     230 </span>            :  * Returns FALSE if the strings differ.
<a name="231"><span class="lineNum">     231 </span>            :  */</a>
<span class="lineNum">     232 </span>            : gboolean
<span class="lineNum">     233 </span>            : mono_string_equal (MonoString *s1, MonoString *s2)
<span class="lineNum">     234 </span>            : {
<span class="lineNum">     235 </span><span class="lineCov">   14280533 :         int l1 = mono_string_length (s1);</span>
<span class="lineNum">     236 </span><span class="lineCov">   14280533 :         int l2 = mono_string_length (s2);</span>
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineCov">   14280533 :         if (s1 == s2)</span>
<span class="lineNum">     239 </span><span class="lineCov">         15 :                 return TRUE;</span>
<span class="lineNum">     240 </span><span class="lineCov">   14280518 :         if (l1 != l2)</span>
<span class="lineNum">     241 </span><span class="lineCov">   11990511 :                 return FALSE;</span>
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span><span class="lineCov">    2290007 :         return memcmp (mono_string_chars (s1), mono_string_chars (s2), l1 * 2) == 0; </span>
<span class="lineNum">     244 </span><span class="lineCov">   14280533 : }</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            : /**
<span class="lineNum">     247 </span>            :  * mono_string_hash:
<span class="lineNum">     248 </span>            :  * @s: the string to hash
<span class="lineNum">     249 </span>            :  *
<span class="lineNum">     250 </span>            :  * Compute the hash for a `MonoString*`
<span class="lineNum">     251 </span>            :  * Returns the hash for the string.
<a name="252"><span class="lineNum">     252 </span>            :  */</a>
<span class="lineNum">     253 </span>            : guint
<span class="lineNum">     254 </span>            : mono_string_hash (MonoString *s)
<span class="lineNum">     255 </span>            : {
<span class="lineNum">     256 </span><span class="lineCov">   10556730 :         const guint16 *p = mono_string_chars (s);</span>
<span class="lineNum">     257 </span><span class="lineCov">   10556730 :         int i, len = mono_string_length (s);</span>
<span class="lineNum">     258 </span><span class="lineCov">   10556730 :         guint h = 0;</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineCov">  381794524 :         for (i = 0; i &lt; len; i++) {</span>
<span class="lineNum">     261 </span><span class="lineCov">  180340532 :                 h = (h &lt;&lt; 5) - h + *p;</span>
<span class="lineNum">     262 </span><span class="lineCov">  180340532 :                 p++;</span>
<span class="lineNum">     263 </span><span class="lineCov">  180340532 :         }</span>
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineCov">   10556730 :         return h;       </span>
<span class="lineNum">     266 </span>            : }
<a name="267"><span class="lineNum">     267 </span>            : </a>
<span class="lineNum">     268 </span>            : static gboolean
<span class="lineNum">     269 </span>            : mono_ptrarray_equal (gpointer *s1, gpointer *s2)
<span class="lineNum">     270 </span>            : {
<span class="lineNum">     271 </span><span class="lineCov">       2741 :         int len = GPOINTER_TO_INT (s1 [0]);</span>
<span class="lineNum">     272 </span><span class="lineCov">       2741 :         if (len != GPOINTER_TO_INT (s2 [0]))</span>
<span class="lineNum">     273 </span><span class="lineCov">       1802 :                 return FALSE;</span>
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineCov">        939 :         return memcmp (s1 + 1, s2 + 1, len * sizeof(gpointer)) == 0; </span>
<span class="lineNum">     276 </span><span class="lineCov">       2741 : }</span>
<a name="277"><span class="lineNum">     277 </span>            : </a>
<span class="lineNum">     278 </span>            : static guint
<span class="lineNum">     279 </span>            : mono_ptrarray_hash (gpointer *s)
<span class="lineNum">     280 </span>            : {
<span class="lineNum">     281 </span>            :         int i;
<span class="lineNum">     282 </span><span class="lineCov">       2689 :         int len = GPOINTER_TO_INT (s [0]);</span>
<span class="lineNum">     283 </span><span class="lineCov">       2689 :         guint hash = 0;</span>
<span class="lineNum">     284 </span>            :         
<span class="lineNum">     285 </span><span class="lineCov">     454342 :         for (i = 1; i &lt; len; i++)</span>
<span class="lineNum">     286 </span><span class="lineCov">     224482 :                 hash += GPOINTER_TO_UINT (s [i]);</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineCov">       2689 :         return hash;    </span>
<span class="lineNum">     289 </span>            : }
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            : /*
<span class="lineNum">     292 </span>            :  * Allocate an id for domain and set domain-&gt;domain_id.
<span class="lineNum">     293 </span>            :  * LOCKING: must be called while holding appdomains_mutex.
<span class="lineNum">     294 </span>            :  * We try to assign low numbers to the domain, so it can be used
<span class="lineNum">     295 </span>            :  * as an index in data tables to lookup domain-specific info
<span class="lineNum">     296 </span>            :  * with minimal memory overhead. We also try not to reuse the
<span class="lineNum">     297 </span>            :  * same id too quickly (to help debugging).
<a name="298"><span class="lineNum">     298 </span>            :  */</a>
<span class="lineNum">     299 </span>            : static int
<span class="lineNum">     300 </span>            : domain_id_alloc (MonoDomain *domain)
<span class="lineNum">     301 </span>            : {
<span class="lineNum">     302 </span><span class="lineCov">       3538 :         int id = -1, i;</span>
<span class="lineNum">     303 </span><span class="lineCov">       3538 :         if (!appdomains_list) {</span>
<span class="lineNum">     304 </span><span class="lineCov">       3285 :                 appdomain_list_size = 2;</span>
<span class="lineNum">     305 </span><span class="lineCov">       3285 :                 appdomains_list = (MonoDomain **)mono_gc_alloc_fixed (appdomain_list_size * sizeof (void*), MONO_GC_DESCRIPTOR_NULL, MONO_ROOT_SOURCE_DOMAIN, &quot;domains list&quot;);</span>
<span class="lineNum">     306 </span><span class="lineCov">       3285 :         }</span>
<span class="lineNum">     307 </span><span class="lineCov">       7594 :         for (i = appdomain_next; i &lt; appdomain_list_size; ++i) {</span>
<span class="lineNum">     308 </span><span class="lineCov">       3738 :                 if (!appdomains_list [i]) {</span>
<span class="lineNum">     309 </span><span class="lineCov">       3479 :                         id = i;</span>
<span class="lineNum">     310 </span><span class="lineCov">       3479 :                         break;</span>
<span class="lineNum">     311 </span>            :                 }
<span class="lineNum">     312 </span><span class="lineCov">        259 :         }</span>
<span class="lineNum">     313 </span><span class="lineCov">       3538 :         if (id == -1) {</span>
<span class="lineNum">     314 </span><span class="lineCov">        344 :                 for (i = 0; i &lt; appdomain_next; ++i) {</span>
<span class="lineNum">     315 </span><span class="lineCov">        165 :                         if (!appdomains_list [i]) {</span>
<span class="lineNum">     316 </span><span class="lineCov">         52 :                                 id = i;</span>
<span class="lineNum">     317 </span><span class="lineCov">         52 :                                 break;</span>
<span class="lineNum">     318 </span>            :                         }
<span class="lineNum">     319 </span><span class="lineCov">        113 :                 }</span>
<span class="lineNum">     320 </span><span class="lineCov">         59 :         }</span>
<span class="lineNum">     321 </span><span class="lineCov">       3538 :         if (id == -1) {</span>
<span class="lineNum">     322 </span>            :                 MonoDomain **new_list;
<span class="lineNum">     323 </span><span class="lineCov">          7 :                 int new_size = appdomain_list_size * 2;</span>
<span class="lineNum">     324 </span><span class="lineCov">          7 :                 if (new_size &gt;= (1 &lt;&lt; 16))</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :                         g_assert_not_reached ();</span>
<span class="lineNum">     326 </span><span class="lineCov">          7 :                 id = appdomain_list_size;</span>
<span class="lineNum">     327 </span><span class="lineCov">          7 :                 new_list = (MonoDomain **)mono_gc_alloc_fixed (new_size * sizeof (void*), MONO_GC_DESCRIPTOR_NULL, MONO_ROOT_SOURCE_DOMAIN, &quot;domains list&quot;);</span>
<span class="lineNum">     328 </span><span class="lineCov">          7 :                 memcpy (new_list, appdomains_list, appdomain_list_size * sizeof (void*));</span>
<span class="lineNum">     329 </span><span class="lineCov">          7 :                 mono_gc_free_fixed (appdomains_list);</span>
<span class="lineNum">     330 </span><span class="lineCov">          7 :                 appdomains_list = new_list;</span>
<span class="lineNum">     331 </span><span class="lineCov">          7 :                 appdomain_list_size = new_size;</span>
<span class="lineNum">     332 </span><span class="lineCov">          7 :         }</span>
<span class="lineNum">     333 </span><span class="lineCov">       3538 :         domain-&gt;domain_id = id;</span>
<span class="lineNum">     334 </span><span class="lineCov">       3538 :         appdomains_list [id] = domain;</span>
<span class="lineNum">     335 </span><span class="lineCov">       3538 :         appdomain_next++;</span>
<span class="lineNum">     336 </span><span class="lineCov">       3538 :         if (appdomain_next &gt; appdomain_list_size)</span>
<span class="lineNum">     337 </span><span class="lineCov">         36 :                 appdomain_next = 0;</span>
<span class="lineNum">     338 </span><span class="lineCov">       3538 :         return id;</span>
<span class="lineNum">     339 </span>            : }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            : static gsize domain_gc_bitmap [sizeof(MonoDomain)/4/32 + 1];
<span class="lineNum">     342 </span>            : static MonoGCDescriptor domain_gc_desc = MONO_GC_DESCRIPTOR_NULL;
<span class="lineNum">     343 </span>            : static guint32 domain_shadow_serial = 0L;
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span>            : /**
<span class="lineNum">     346 </span>            :  * mono_domain_create:
<span class="lineNum">     347 </span>            :  *
<span class="lineNum">     348 </span>            :  * Creates a new application domain, the unmanaged representation
<span class="lineNum">     349 </span>            :  * of the actual domain.   Usually you will want to create the
<span class="lineNum">     350 </span>            :  *
<span class="lineNum">     351 </span>            :  * Application domains provide an isolation facilty for assemblies.   You
<span class="lineNum">     352 </span>            :  * can load assemblies and execute code in them that will not be visible
<span class="lineNum">     353 </span>            :  * to other application domains.   This is a runtime-based virtualization
<span class="lineNum">     354 </span>            :  * technology.
<span class="lineNum">     355 </span>            :  *
<span class="lineNum">     356 </span>            :  * It is possible to unload domains, which unloads the assemblies and
<span class="lineNum">     357 </span>            :  * data that was allocated in that domain.
<span class="lineNum">     358 </span>            :  *
<span class="lineNum">     359 </span>            :  * When a domain is created a mempool is allocated for domain-specific
<span class="lineNum">     360 </span>            :  * structures, along a dedicated code manager to hold code that is
<span class="lineNum">     361 </span>            :  * associated with the domain.
<span class="lineNum">     362 </span>            :  *
<span class="lineNum">     363 </span>            :  * Returns: New initialized MonoDomain, with no configuration or assemblies
<span class="lineNum">     364 </span>            :  * loaded into it.
<a name="365"><span class="lineNum">     365 </span>            :  */</a>
<span class="lineNum">     366 </span>            : MonoDomain *
<span class="lineNum">     367 </span>            : mono_domain_create (void)
<span class="lineNum">     368 </span>            : {
<span class="lineNum">     369 </span>            :         MonoDomain *domain;
<span class="lineNum">     370 </span>            :         guint32 shadow_serial;
<span class="lineNum">     371 </span>            :   
<span class="lineNum">     372 </span><span class="lineCov">       3538 :         mono_appdomains_lock ();</span>
<span class="lineNum">     373 </span><span class="lineCov">       3538 :         shadow_serial = domain_shadow_serial++;</span>
<span class="lineNum">     374 </span>            :   
<span class="lineNum">     375 </span><span class="lineCov">       3538 :         if (!domain_gc_desc) {</span>
<span class="lineNum">     376 </span><span class="lineCov">       3285 :                 unsigned int i, bit = 0;</span>
<span class="lineNum">     377 </span><span class="lineCov">      72270 :                 for (i = G_STRUCT_OFFSET (MonoDomain, MONO_DOMAIN_FIRST_OBJECT); i &lt; G_STRUCT_OFFSET (MonoDomain, MONO_DOMAIN_FIRST_GC_TRACKED); i += sizeof (gpointer)) {</span>
<span class="lineNum">     378 </span><span class="lineCov">      32850 :                         bit = i / sizeof (gpointer);</span>
<span class="lineNum">     379 </span><span class="lineCov">      32850 :                         domain_gc_bitmap [bit / 32] |= (gsize) 1 &lt;&lt; (bit % 32);</span>
<span class="lineNum">     380 </span><span class="lineCov">      32850 :                 }</span>
<span class="lineNum">     381 </span><span class="lineCov">       3285 :                 domain_gc_desc = mono_gc_make_descr_from_bitmap ((gsize*)domain_gc_bitmap, bit + 1);</span>
<span class="lineNum">     382 </span><span class="lineCov">       3285 :         }</span>
<span class="lineNum">     383 </span><span class="lineCov">       3538 :         mono_appdomains_unlock ();</span>
<span class="lineNum">     384 </span>            : 
<span class="lineNum">     385 </span>            : #ifdef HAVE_BOEHM_GC
<span class="lineNum">     386 </span>            :         /*
<span class="lineNum">     387 </span>            :          * Boehm doesn't like roots inside GC allocated objects, and alloc_fixed returns
<span class="lineNum">     388 </span>            :          * a GC_MALLOC-ed object, contrary to the api docs. This causes random crashes when
<span class="lineNum">     389 </span>            :          * running the corlib test suite.
<span class="lineNum">     390 </span>            :          * To solve this, we pass a NULL descriptor, and don't register roots.
<span class="lineNum">     391 </span>            :          */
<span class="lineNum">     392 </span>            :         domain = (MonoDomain *)mono_gc_alloc_fixed (sizeof (MonoDomain), NULL, MONO_ROOT_SOURCE_DOMAIN, &quot;domain object&quot;);
<span class="lineNum">     393 </span>            : #else
<span class="lineNum">     394 </span><span class="lineCov">       3538 :         domain = (MonoDomain *)mono_gc_alloc_fixed (sizeof (MonoDomain), domain_gc_desc, MONO_ROOT_SOURCE_DOMAIN, &quot;domain object&quot;);</span>
<span class="lineNum">     395 </span><span class="lineCov">       3538 :         mono_gc_register_root ((char*)&amp;(domain-&gt;MONO_DOMAIN_FIRST_GC_TRACKED), G_STRUCT_OFFSET (MonoDomain, MONO_DOMAIN_LAST_GC_TRACKED) - G_STRUCT_OFFSET (MonoDomain, MONO_DOMAIN_FIRST_GC_TRACKED), MONO_GC_DESCRIPTOR_NULL, MONO_ROOT_SOURCE_DOMAIN, &quot;misc domain fields&quot;);</span>
<span class="lineNum">     396 </span>            : #endif
<span class="lineNum">     397 </span><span class="lineCov">       3538 :         domain-&gt;shadow_serial = shadow_serial;</span>
<span class="lineNum">     398 </span><span class="lineCov">       3538 :         domain-&gt;domain = NULL;</span>
<span class="lineNum">     399 </span><span class="lineCov">       3538 :         domain-&gt;setup = NULL;</span>
<span class="lineNum">     400 </span><span class="lineCov">       3538 :         domain-&gt;friendly_name = NULL;</span>
<span class="lineNum">     401 </span><span class="lineCov">       3538 :         domain-&gt;search_path = NULL;</span>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineCov">       3538 :         mono_profiler_appdomain_event (domain, MONO_PROFILE_START_LOAD);</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineCov">       3538 :         domain-&gt;mp = mono_mempool_new ();</span>
<span class="lineNum">     406 </span><span class="lineCov">       3538 :         domain-&gt;code_mp = mono_code_manager_new ();</span>
<span class="lineNum">     407 </span><span class="lineCov">       3538 :         domain-&gt;lock_free_mp = lock_free_mempool_new ();</span>
<span class="lineNum">     408 </span><span class="lineCov">       3538 :         domain-&gt;env = mono_g_hash_table_new_type ((GHashFunc)mono_string_hash, (GCompareFunc)mono_string_equal, MONO_HASH_KEY_VALUE_GC, MONO_ROOT_SOURCE_DOMAIN, &quot;domain environment variables table&quot;);</span>
<span class="lineNum">     409 </span><span class="lineCov">       3538 :         domain-&gt;domain_assemblies = NULL;</span>
<span class="lineNum">     410 </span><span class="lineCov">       3538 :         domain-&gt;assembly_bindings = NULL;</span>
<span class="lineNum">     411 </span><span class="lineCov">       3538 :         domain-&gt;assembly_bindings_parsed = FALSE;</span>
<span class="lineNum">     412 </span><span class="lineCov">       3538 :         domain-&gt;class_vtable_array = g_ptr_array_new ();</span>
<span class="lineNum">     413 </span><span class="lineCov">       3538 :         domain-&gt;proxy_vtable_hash = g_hash_table_new ((GHashFunc)mono_ptrarray_hash, (GCompareFunc)mono_ptrarray_equal);</span>
<span class="lineNum">     414 </span><span class="lineCov">       3538 :         domain-&gt;static_data_array = NULL;</span>
<span class="lineNum">     415 </span><span class="lineCov">       3538 :         mono_jit_code_hash_init (&amp;domain-&gt;jit_code_hash);</span>
<span class="lineNum">     416 </span><span class="lineCov">       3538 :         domain-&gt;ldstr_table = mono_g_hash_table_new_type ((GHashFunc)mono_string_hash, (GCompareFunc)mono_string_equal, MONO_HASH_KEY_VALUE_GC, MONO_ROOT_SOURCE_DOMAIN, &quot;domain string constants table&quot;);</span>
<span class="lineNum">     417 </span><span class="lineCov">       3538 :         domain-&gt;num_jit_info_tables = 1;</span>
<span class="lineNum">     418 </span><span class="lineCov">       3538 :         domain-&gt;jit_info_table = mono_jit_info_table_new (domain);</span>
<span class="lineNum">     419 </span><span class="lineCov">       3538 :         domain-&gt;jit_info_free_queue = NULL;</span>
<span class="lineNum">     420 </span><span class="lineCov">       3538 :         domain-&gt;finalizable_objects_hash = g_hash_table_new (mono_aligned_addr_hash, NULL);</span>
<span class="lineNum">     421 </span><span class="lineCov">       3538 :         domain-&gt;ftnptrs_hash = g_hash_table_new (mono_aligned_addr_hash, NULL);</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineCov">       3538 :         mono_coop_mutex_init_recursive (&amp;domain-&gt;lock);</span>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineCov">       3538 :         mono_os_mutex_init_recursive (&amp;domain-&gt;assemblies_lock);</span>
<span class="lineNum">     426 </span><span class="lineCov">       3538 :         mono_os_mutex_init_recursive (&amp;domain-&gt;jit_code_hash_lock);</span>
<span class="lineNum">     427 </span><span class="lineCov">       3538 :         mono_os_mutex_init_recursive (&amp;domain-&gt;finalizable_objects_hash_lock);</span>
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineCov">       3538 :         domain-&gt;method_rgctx_hash = NULL;</span>
<span class="lineNum">     430 </span>            : 
<span class="lineNum">     431 </span><span class="lineCov">       3538 :         mono_appdomains_lock ();</span>
<span class="lineNum">     432 </span><span class="lineCov">       3538 :         domain_id_alloc (domain);</span>
<span class="lineNum">     433 </span><span class="lineCov">       3538 :         mono_appdomains_unlock ();</span>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">     436 </span><span class="lineCov">       3538 :         mono_perfcounters-&gt;loader_appdomains++;</span>
<span class="lineNum">     437 </span><span class="lineCov">       3538 :         mono_perfcounters-&gt;loader_total_appdomains++;</span>
<span class="lineNum">     438 </span>            : #endif
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineCov">       3538 :         mono_debug_domain_create (domain);</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span><span class="lineCov">       3538 :         if (create_domain_hook)</span>
<span class="lineNum">     443 </span><span class="lineCov">       3538 :                 create_domain_hook (domain);</span>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">       3538 :         mono_profiler_appdomain_loaded (domain, MONO_PROFILE_OK);</span>
<span class="lineNum">     446 </span>            :         
<span class="lineNum">     447 </span><span class="lineCov">       3538 :         return domain;</span>
<span class="lineNum">     448 </span>            : }
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span>            : /**
<span class="lineNum">     451 </span>            :  * mono_init_internal:
<span class="lineNum">     452 </span>            :  * 
<span class="lineNum">     453 </span>            :  * Creates the initial application domain and initializes the mono_defaults
<span class="lineNum">     454 </span>            :  * structure.
<span class="lineNum">     455 </span>            :  * This function is guaranteed to not run any IL code.
<span class="lineNum">     456 </span>            :  * If exe_filename is not NULL, the method will determine the required runtime
<span class="lineNum">     457 </span>            :  * from the exe configuration file or the version PE field.
<span class="lineNum">     458 </span>            :  * If runtime_version is not NULL, that runtime version will be used.
<span class="lineNum">     459 </span>            :  * Either exe_filename or runtime_version must be provided.
<span class="lineNum">     460 </span>            :  *
<span class="lineNum">     461 </span>            :  * Returns: the initial domain.
<a name="462"><span class="lineNum">     462 </span>            :  */</a>
<span class="lineNum">     463 </span>            : static MonoDomain *
<span class="lineNum">     464 </span>            : mono_init_internal (const char *filename, const char *exe_filename, const char *runtime_version)
<span class="lineNum">     465 </span>            : {
<span class="lineNum">     466 </span>            :         static MonoDomain *domain = NULL;
<span class="lineNum">     467 </span><span class="lineCov">       3285 :         MonoAssembly *ass = NULL;</span>
<span class="lineNum">     468 </span><span class="lineCov">       3285 :         MonoImageOpenStatus status = MONO_IMAGE_OK;</span>
<span class="lineNum">     469 </span><span class="lineCov">       3285 :         const MonoRuntimeInfo* runtimes [G_N_ELEMENTS (supported_runtimes) + 1] = { NULL };</span>
<span class="lineNum">     470 </span>            :         int n, dummy;
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            : #ifdef DEBUG_DOMAIN_UNLOAD
<span class="lineNum">     473 </span>            :         debug_domain_unload = TRUE;
<span class="lineNum">     474 </span>            : #endif
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineCov">       3285 :         if (domain)</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                 g_assert_not_reached ();</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            : #if defined(HOST_WIN32) &amp;&amp; G_HAVE_API_SUPPORT(HAVE_CLASSIC_WINAPI_SUPPORT)
<span class="lineNum">     480 </span>            :         /* Avoid system error message boxes. */
<span class="lineNum">     481 </span>            :         SetErrorMode (SEM_FAILCRITICALERRORS | SEM_NOOPENFILEERRORBOX);
<span class="lineNum">     482 </span>            : #endif
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span>            : #ifndef HOST_WIN32
<span class="lineNum">     485 </span><span class="lineCov">       3285 :         mono_w32handle_init ();</span>
<span class="lineNum">     486 </span><span class="lineCov">       3285 :         mono_w32handle_namespace_init ();</span>
<span class="lineNum">     487 </span><span class="lineCov">       3285 :         wapi_init ();</span>
<span class="lineNum">     488 </span>            : #endif
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineCov">       3285 :         mono_w32mutex_init ();</span>
<span class="lineNum">     491 </span><span class="lineCov">       3285 :         mono_w32semaphore_init ();</span>
<span class="lineNum">     492 </span><span class="lineCov">       3285 :         mono_w32event_init ();</span>
<span class="lineNum">     493 </span><span class="lineCov">       3285 :         mono_w32process_init ();</span>
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">     496 </span><span class="lineCov">       3285 :         mono_perfcounters_init ();</span>
<span class="lineNum">     497 </span>            : #endif
<span class="lineNum">     498 </span><span class="lineCov">       3285 :         mono_counters_init ();</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;Max native code in a domain&quot;, MONO_COUNTER_INT|MONO_COUNTER_JIT, &amp;max_domain_code_size);</span>
<span class="lineNum">     501 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;Max code space allocated in a domain&quot;, MONO_COUNTER_INT|MONO_COUNTER_JIT, &amp;max_domain_code_alloc);</span>
<span class="lineNum">     502 </span><span class="lineCov">       3285 :         mono_counters_register (&quot;Total code space allocated&quot;, MONO_COUNTER_INT|MONO_COUNTER_JIT, &amp;total_domain_code_alloc);</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">       3285 :         mono_gc_base_init ();</span>
<span class="lineNum">     505 </span><span class="lineCov">       3285 :         mono_thread_info_attach (&amp;dummy);</span>
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineCov">       3285 :         mono_coop_mutex_init_recursive (&amp;appdomains_mutex);</span>
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span><span class="lineCov">       3285 :         mono_metadata_init ();</span>
<span class="lineNum">     510 </span><span class="lineCov">       3285 :         mono_images_init ();</span>
<span class="lineNum">     511 </span><span class="lineCov">       3285 :         mono_assemblies_init ();</span>
<span class="lineNum">     512 </span><span class="lineCov">       3285 :         mono_classes_init ();</span>
<span class="lineNum">     513 </span><span class="lineCov">       3285 :         mono_loader_init ();</span>
<span class="lineNum">     514 </span><span class="lineCov">       3285 :         mono_reflection_init ();</span>
<span class="lineNum">     515 </span><span class="lineCov">       3285 :         mono_runtime_init_tls ();</span>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span>            :         /* FIXME: When should we release this memory? */
<span class="lineNum">     518 </span><span class="lineCov">       9855 :         MONO_GC_REGISTER_ROOT_FIXED (appdomains_list, MONO_ROOT_SOURCE_DOMAIN, &quot;domains list&quot;);</span>
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineCov">       3285 :         domain = mono_domain_create ();</span>
<span class="lineNum">     521 </span><span class="lineCov">       3285 :         mono_root_domain = domain;</span>
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span><span class="lineCov">      13140 :         SET_APPDOMAIN (domain);</span>
<span class="lineNum">     524 </span>            :         
<span class="lineNum">     525 </span>            :         /* Get a list of runtimes supported by the exe */
<span class="lineNum">     526 </span><span class="lineCov">       3285 :         if (exe_filename != NULL) {</span>
<span class="lineNum">     527 </span>            :                 /*
<span class="lineNum">     528 </span>            :                  * This function will load the exe file as a MonoImage. We need to close it, but
<span class="lineNum">     529 </span>            :                  * that would mean it would be reloaded later. So instead, we save it to
<span class="lineNum">     530 </span>            :                  * exe_image, and close it during shutdown.
<span class="lineNum">     531 </span>            :                  */
<span class="lineNum">     532 </span><span class="lineCov">       3285 :                 get_runtimes_from_exe (exe_filename, &amp;exe_image, runtimes);</span>
<span class="lineNum">     533 </span>            : #ifdef HOST_WIN32
<span class="lineNum">     534 </span>            :                 if (!exe_image) {
<span class="lineNum">     535 </span>            :                         exe_image = mono_assembly_open_from_bundle (exe_filename, NULL, FALSE);
<span class="lineNum">     536 </span>            :                         if (!exe_image)
<span class="lineNum">     537 </span>            :                                 exe_image = mono_image_open (exe_filename, NULL);
<span class="lineNum">     538 </span>            :                 }
<span class="lineNum">     539 </span>            :                 mono_fixup_exe_image (exe_image);
<span class="lineNum">     540 </span>            : #endif
<span class="lineNum">     541 </span><span class="lineCov">       3285 :         } else if (runtime_version != NULL) {</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :                 runtimes [0] = get_runtime_by_version (runtime_version);</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                 runtimes [1] = NULL;</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineCov">       3285 :         if (runtimes [0] == NULL) {</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :                 const MonoRuntimeInfo *default_runtime = get_runtime_by_version (DEFAULT_RUNTIME_VERSION);</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :                 runtimes [0] = default_runtime;</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :                 runtimes [1] = NULL;</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :                 g_print (&quot;WARNING: The runtime version supported by this application is unavailable.\n&quot;);</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                 g_print (&quot;Using default runtime: %s\n&quot;, default_runtime-&gt;runtime_version); </span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span>            :         /* The selected runtime will be the first one for which there is a mscrolib.dll */
<span class="lineNum">     555 </span><span class="lineCov">      22995 :         for (n = 0; runtimes [n] != NULL &amp;&amp; ass == NULL; n++) {</span>
<span class="lineNum">     556 </span><span class="lineCov">       3285 :                 current_runtime = runtimes [n];</span>
<span class="lineNum">     557 </span><span class="lineCov">       3285 :                 ass = mono_assembly_load_corlib (current_runtime, &amp;status);</span>
<span class="lineNum">     558 </span><span class="lineCov">       3285 :                 if (status != MONO_IMAGE_OK &amp;&amp; status != MONO_IMAGE_ERROR_ERRNO)</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span><span class="lineCov">       3285 :         }</span>
<span class="lineNum">     562 </span>            :         
<span class="lineNum">     563 </span><span class="lineCov">       6570 :         if ((status != MONO_IMAGE_OK) || (ass == NULL)) {</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :                 switch (status){</span>
<span class="lineNum">     565 </span>            :                 case MONO_IMAGE_ERROR_ERRNO: {
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                         char *corlib_file = g_build_filename (mono_assembly_getrootdir (), &quot;mono&quot;, current_runtime-&gt;framework_version, &quot;mscorlib.dll&quot;, NULL);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :                         g_print (&quot;The assembly mscorlib.dll was not found or could not be loaded.\n&quot;);</span>
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :                         g_print (&quot;It should have been installed in the `%s' directory.\n&quot;, corlib_file);</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :                         g_free (corlib_file);</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     571 </span>            :                 }
<span class="lineNum">     572 </span>            :                 case MONO_IMAGE_IMAGE_INVALID:
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                         g_print (&quot;The file %s/mscorlib.dll is an invalid CIL image\n&quot;,</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :                                  mono_assembly_getrootdir ());</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     576 </span>            :                 case MONO_IMAGE_MISSING_ASSEMBLYREF:
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :                         g_print (&quot;Missing assembly reference in %s/mscorlib.dll\n&quot;,</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :                                  mono_assembly_getrootdir ());</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     580 </span>            :                 case MONO_IMAGE_OK:
<span class="lineNum">     581 </span>            :                         /* to suppress compiler warning */
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     583 </span>            :                 }
<span class="lineNum">     584 </span>            :                 
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :                 exit (1);</span>
<span class="lineNum">     586 </span>            :         }
<span class="lineNum">     587 </span><span class="lineCov">       3285 :         mono_defaults.corlib = mono_assembly_get_image (ass);</span>
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span><span class="lineCov">       3285 :         mono_defaults.object_class = mono_class_load_from_name (</span>
<span class="lineNum">     590 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Object&quot;);</span>
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineCov">       3285 :         mono_defaults.void_class = mono_class_load_from_name (</span>
<span class="lineNum">     593 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Void&quot;);</span>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineCov">       3285 :         mono_defaults.boolean_class = mono_class_load_from_name (</span>
<span class="lineNum">     596 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Boolean&quot;);</span>
<span class="lineNum">     597 </span>            : 
<span class="lineNum">     598 </span><span class="lineCov">       3285 :         mono_defaults.byte_class = mono_class_load_from_name (</span>
<span class="lineNum">     599 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Byte&quot;);</span>
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineCov">       3285 :         mono_defaults.sbyte_class = mono_class_load_from_name (</span>
<span class="lineNum">     602 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;SByte&quot;);</span>
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span><span class="lineCov">       3285 :         mono_defaults.int16_class = mono_class_load_from_name (</span>
<span class="lineNum">     605 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Int16&quot;);</span>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">       3285 :         mono_defaults.uint16_class = mono_class_load_from_name (</span>
<span class="lineNum">     608 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;UInt16&quot;);</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineCov">       3285 :         mono_defaults.int32_class = mono_class_load_from_name (</span>
<span class="lineNum">     611 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Int32&quot;);</span>
<span class="lineNum">     612 </span>            : 
<span class="lineNum">     613 </span><span class="lineCov">       3285 :         mono_defaults.uint32_class = mono_class_load_from_name (</span>
<span class="lineNum">     614 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;UInt32&quot;);</span>
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span><span class="lineCov">       3285 :         mono_defaults.uint_class = mono_class_load_from_name (</span>
<span class="lineNum">     617 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;UIntPtr&quot;);</span>
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineCov">       3285 :         mono_defaults.int_class = mono_class_load_from_name (</span>
<span class="lineNum">     620 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;IntPtr&quot;);</span>
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span><span class="lineCov">       3285 :         mono_defaults.int64_class = mono_class_load_from_name (</span>
<span class="lineNum">     623 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Int64&quot;);</span>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span><span class="lineCov">       3285 :         mono_defaults.uint64_class = mono_class_load_from_name (</span>
<span class="lineNum">     626 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;UInt64&quot;);</span>
<span class="lineNum">     627 </span>            : 
<span class="lineNum">     628 </span><span class="lineCov">       3285 :         mono_defaults.single_class = mono_class_load_from_name (</span>
<span class="lineNum">     629 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Single&quot;);</span>
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineCov">       3285 :         mono_defaults.double_class = mono_class_load_from_name (</span>
<span class="lineNum">     632 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Double&quot;);</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span><span class="lineCov">       3285 :         mono_defaults.char_class = mono_class_load_from_name (</span>
<span class="lineNum">     635 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Char&quot;);</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">       3285 :         mono_defaults.string_class = mono_class_load_from_name (</span>
<span class="lineNum">     638 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;String&quot;);</span>
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span><span class="lineCov">       3285 :         mono_defaults.enum_class = mono_class_load_from_name (</span>
<span class="lineNum">     641 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Enum&quot;);</span>
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">       3285 :         mono_defaults.array_class = mono_class_load_from_name (</span>
<span class="lineNum">     644 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Array&quot;);</span>
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span><span class="lineCov">       3285 :         mono_defaults.delegate_class = mono_class_load_from_name (</span>
<span class="lineNum">     647 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Delegate&quot;);</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineCov">       3285 :         mono_defaults.multicastdelegate_class = mono_class_load_from_name (</span>
<span class="lineNum">     650 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;MulticastDelegate&quot;);</span>
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineCov">       3285 :         mono_defaults.asyncresult_class = mono_class_load_from_name (</span>
<span class="lineNum">     653 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.Remoting.Messaging&quot;, </span>
<span class="lineNum">     654 </span>            :                 &quot;AsyncResult&quot;);
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineCov">       3285 :         mono_defaults.manualresetevent_class = mono_class_load_from_name (</span>
<span class="lineNum">     657 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Threading&quot;, &quot;ManualResetEvent&quot;);</span>
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span><span class="lineCov">       3285 :         mono_defaults.typehandle_class = mono_class_load_from_name (</span>
<span class="lineNum">     660 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;RuntimeTypeHandle&quot;);</span>
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineCov">       3285 :         mono_defaults.methodhandle_class = mono_class_load_from_name (</span>
<span class="lineNum">     663 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;RuntimeMethodHandle&quot;);</span>
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span><span class="lineCov">       3285 :         mono_defaults.fieldhandle_class = mono_class_load_from_name (</span>
<span class="lineNum">     666 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;RuntimeFieldHandle&quot;);</span>
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span><span class="lineCov">       3285 :         mono_defaults.systemtype_class = mono_class_load_from_name (</span>
<span class="lineNum">     669 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Type&quot;);</span>
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span><span class="lineCov">       3285 :         mono_defaults.runtimetype_class = mono_class_load_from_name (</span>
<span class="lineNum">     672 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;RuntimeType&quot;);</span>
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span><span class="lineCov">       3285 :         mono_defaults.exception_class = mono_class_load_from_name (</span>
<span class="lineNum">     675 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Exception&quot;);</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span><span class="lineCov">       3285 :         mono_defaults.threadabortexception_class = mono_class_load_from_name (</span>
<span class="lineNum">     678 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Threading&quot;, &quot;ThreadAbortException&quot;);</span>
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span><span class="lineCov">       3285 :         mono_defaults.thread_class = mono_class_load_from_name (</span>
<span class="lineNum">     681 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Threading&quot;, &quot;Thread&quot;);</span>
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineCov">       3285 :         mono_defaults.internal_thread_class = mono_class_load_from_name (</span>
<span class="lineNum">     684 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Threading&quot;, &quot;InternalThread&quot;);</span>
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span><span class="lineCov">       3285 :         mono_defaults.appdomain_class = mono_class_load_from_name (</span>
<span class="lineNum">     687 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;AppDomain&quot;);</span>
<span class="lineNum">     688 </span>            : 
<span class="lineNum">     689 </span>            : #ifndef DISABLE_REMOTING
<span class="lineNum">     690 </span><span class="lineCov">       3285 :         mono_defaults.transparent_proxy_class = mono_class_load_from_name (</span>
<span class="lineNum">     691 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.Remoting.Proxies&quot;, &quot;TransparentProxy&quot;);</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineCov">       3285 :         mono_defaults.real_proxy_class = mono_class_load_from_name (</span>
<span class="lineNum">     694 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.Remoting.Proxies&quot;, &quot;RealProxy&quot;);</span>
<span class="lineNum">     695 </span>            : 
<span class="lineNum">     696 </span><span class="lineCov">       3285 :         mono_defaults.marshalbyrefobject_class =  mono_class_load_from_name (</span>
<span class="lineNum">     697 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;MarshalByRefObject&quot;);</span>
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span><span class="lineCov">       3285 :         mono_defaults.iremotingtypeinfo_class = mono_class_load_from_name (</span>
<span class="lineNum">     700 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.Remoting&quot;, &quot;IRemotingTypeInfo&quot;);</span>
<span class="lineNum">     701 </span>            : 
<span class="lineNum">     702 </span>            : #endif
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span><span class="lineCov">       3285 :         mono_defaults.mono_method_message_class = mono_class_load_from_name (</span>
<span class="lineNum">     705 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.Remoting.Messaging&quot;, &quot;MonoMethodMessage&quot;);</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span><span class="lineCov">       3285 :         mono_defaults.field_info_class = mono_class_load_from_name (</span>
<span class="lineNum">     708 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Reflection&quot;, &quot;FieldInfo&quot;);</span>
<span class="lineNum">     709 </span>            : 
<span class="lineNum">     710 </span><span class="lineCov">       3285 :         mono_defaults.method_info_class = mono_class_load_from_name (</span>
<span class="lineNum">     711 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Reflection&quot;, &quot;MethodInfo&quot;);</span>
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span><span class="lineCov">       3285 :         mono_defaults.stringbuilder_class = mono_class_load_from_name (</span>
<span class="lineNum">     714 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Text&quot;, &quot;StringBuilder&quot;);</span>
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span><span class="lineCov">       3285 :         mono_defaults.math_class = mono_class_load_from_name (</span>
<span class="lineNum">     717 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Math&quot;);</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineCov">       3285 :         mono_defaults.stack_frame_class = mono_class_load_from_name (</span>
<span class="lineNum">     720 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Diagnostics&quot;, &quot;StackFrame&quot;);</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineCov">       3285 :         mono_defaults.stack_trace_class = mono_class_load_from_name (</span>
<span class="lineNum">     723 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Diagnostics&quot;, &quot;StackTrace&quot;);</span>
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span><span class="lineCov">       3285 :         mono_defaults.marshal_class = mono_class_load_from_name (</span>
<span class="lineNum">     726 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.InteropServices&quot;, &quot;Marshal&quot;);</span>
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span><span class="lineCov">       3285 :         mono_defaults.typed_reference_class = mono_class_load_from_name (</span>
<span class="lineNum">     729 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;TypedReference&quot;);</span>
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineCov">       3285 :         mono_defaults.argumenthandle_class = mono_class_load_from_name (</span>
<span class="lineNum">     732 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;RuntimeArgumentHandle&quot;);</span>
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span><span class="lineCov">       3285 :         mono_defaults.monitor_class = mono_class_load_from_name (</span>
<span class="lineNum">     735 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Threading&quot;, &quot;Monitor&quot;);</span>
<span class="lineNum">     736 </span>            :         /*
<span class="lineNum">     737 </span>            :         Not using GENERATE_TRY_GET_CLASS_WITH_CACHE_DECL as this type is heavily checked by sgen when computing finalization.
<span class="lineNum">     738 </span>            :         */
<span class="lineNum">     739 </span><span class="lineCov">       3285 :         mono_defaults.critical_finalizer_object = mono_class_try_load_from_name (mono_defaults.corlib,</span>
<span class="lineNum">     740 </span>            :                         &quot;System.Runtime.ConstrainedExecution&quot;, &quot;CriticalFinalizerObject&quot;);
<span class="lineNum">     741 </span>            : 
<span class="lineNum">     742 </span><span class="lineCov">       3285 :         mono_assembly_load_friends (ass);</span>
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span><span class="lineCov">       3285 :         mono_defaults.handleref_class = mono_class_try_load_from_name (</span>
<span class="lineNum">     745 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Runtime.InteropServices&quot;, &quot;HandleRef&quot;);</span>
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span><span class="lineCov">       3285 :         mono_defaults.attribute_class = mono_class_load_from_name (</span>
<span class="lineNum">     748 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Attribute&quot;);</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span><span class="lineCov">       3285 :         mono_defaults.customattribute_data_class = mono_class_load_from_name (</span>
<span class="lineNum">     751 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Reflection&quot;, &quot;CustomAttributeData&quot;);</span>
<span class="lineNum">     752 </span>            : 
<span class="lineNum">     753 </span><span class="lineCov">       3285 :         mono_class_init (mono_defaults.array_class);</span>
<span class="lineNum">     754 </span><span class="lineCov">       3285 :         mono_defaults.generic_nullable_class = mono_class_load_from_name (</span>
<span class="lineNum">     755 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System&quot;, &quot;Nullable`1&quot;);</span>
<span class="lineNum">     756 </span><span class="lineCov">       3285 :         mono_defaults.generic_ilist_class = mono_class_load_from_name (</span>
<span class="lineNum">     757 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Collections.Generic&quot;, &quot;IList`1&quot;);</span>
<span class="lineNum">     758 </span><span class="lineCov">       3285 :         mono_defaults.generic_ireadonlylist_class = mono_class_load_from_name (</span>
<span class="lineNum">     759 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Collections.Generic&quot;, &quot;IReadOnlyList`1&quot;);</span>
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span><span class="lineCov">       3285 :         mono_defaults.threadpool_wait_callback_class = mono_class_load_from_name (</span>
<span class="lineNum">     762 </span><span class="lineCov">       3285 :                 mono_defaults.corlib, &quot;System.Threading&quot;, &quot;_ThreadPoolWaitCallback&quot;);</span>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineCov">       3285 :         mono_defaults.threadpool_perform_wait_callback_method = mono_class_get_method_from_name (</span>
<span class="lineNum">     765 </span><span class="lineCov">       3285 :                 mono_defaults.threadpool_wait_callback_class, &quot;PerformWaitCallback&quot;, 0);</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineCov">       3285 :         domain-&gt;friendly_name = g_path_get_basename (filename);</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineCov">       3285 :         mono_profiler_appdomain_name (domain, domain-&gt;friendly_name);</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineCov">       3285 :         return domain;</span>
<span class="lineNum">     772 </span>            : }
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span>            : /**
<span class="lineNum">     775 </span>            :  * mono_init:
<span class="lineNum">     776 </span>            :  * 
<span class="lineNum">     777 </span>            :  * Creates the initial application domain and initializes the mono_defaults
<span class="lineNum">     778 </span>            :  * structure.
<span class="lineNum">     779 </span>            :  *
<span class="lineNum">     780 </span>            :  * This function is guaranteed to not run any IL code.
<span class="lineNum">     781 </span>            :  * The runtime is initialized using the default runtime version.
<span class="lineNum">     782 </span>            :  *
<span class="lineNum">     783 </span>            :  * Returns: the initial domain.
<a name="784"><span class="lineNum">     784 </span>            :  */</a>
<span class="lineNum">     785 </span>            : MonoDomain *
<span class="lineNum">     786 </span>            : mono_init (const char *domain_name)
<span class="lineNum">     787 </span>            : {
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :         return mono_init_internal (domain_name, NULL, DEFAULT_RUNTIME_VERSION);</span>
<span class="lineNum">     789 </span>            : }
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span>            : /**
<span class="lineNum">     792 </span>            :  * mono_init_from_assembly:
<span class="lineNum">     793 </span>            :  * @domain_name: name to give to the initial domain
<span class="lineNum">     794 </span>            :  * @filename: filename to load on startup
<span class="lineNum">     795 </span>            :  *
<span class="lineNum">     796 </span>            :  * Used by the runtime, users should use mono_jit_init instead.
<span class="lineNum">     797 </span>            :  *
<span class="lineNum">     798 </span>            :  * Creates the initial application domain and initializes the mono_defaults
<span class="lineNum">     799 </span>            :  * structure.
<span class="lineNum">     800 </span>            :  * This function is guaranteed to not run any IL code.
<span class="lineNum">     801 </span>            :  * The runtime is initialized using the runtime version required by the
<span class="lineNum">     802 </span>            :  * provided executable. The version is determined by looking at the exe 
<span class="lineNum">     803 </span>            :  * configuration file and the version PE field)
<span class="lineNum">     804 </span>            :  *
<span class="lineNum">     805 </span>            :  * Returns: the initial domain.
<a name="806"><span class="lineNum">     806 </span>            :  */</a>
<span class="lineNum">     807 </span>            : MonoDomain *
<span class="lineNum">     808 </span>            : mono_init_from_assembly (const char *domain_name, const char *filename)
<span class="lineNum">     809 </span>            : {
<span class="lineNum">     810 </span><span class="lineCov">       3285 :         return mono_init_internal (domain_name, filename, NULL);</span>
<span class="lineNum">     811 </span>            : }
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            : /**
<span class="lineNum">     814 </span>            :  * mono_init_version:
<span class="lineNum">     815 </span>            :  * 
<span class="lineNum">     816 </span>            :  * Used by the runtime, users should use mono_jit_init instead.
<span class="lineNum">     817 </span>            :  * 
<span class="lineNum">     818 </span>            :  * Creates the initial application domain and initializes the mono_defaults
<span class="lineNum">     819 </span>            :  * structure.
<span class="lineNum">     820 </span>            :  *
<span class="lineNum">     821 </span>            :  * This function is guaranteed to not run any IL code.
<span class="lineNum">     822 </span>            :  * The runtime is initialized using the provided rutime version.
<span class="lineNum">     823 </span>            :  *
<span class="lineNum">     824 </span>            :  * Returns: the initial domain.
<a name="825"><span class="lineNum">     825 </span>            :  */</a>
<span class="lineNum">     826 </span>            : MonoDomain *
<span class="lineNum">     827 </span>            : mono_init_version (const char *domain_name, const char *version)
<span class="lineNum">     828 </span>            : {
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :         return mono_init_internal (domain_name, NULL, version);</span>
<span class="lineNum">     830 </span>            : }
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span>            : /**
<span class="lineNum">     833 </span>            :  * mono_cleanup:
<span class="lineNum">     834 </span>            :  *
<span class="lineNum">     835 </span>            :  * Cleans up all metadata modules. 
<a name="836"><span class="lineNum">     836 </span>            :  */</a>
<span class="lineNum">     837 </span>            : void
<span class="lineNum">     838 </span>            : mono_cleanup (void)
<span class="lineNum">     839 </span>            : {
<span class="lineNum">     840 </span><span class="lineCov">       3272 :         mono_close_exe_image ();</span>
<span class="lineNum">     841 </span>            : 
<span class="lineNum">     842 </span><span class="lineCov">       3272 :         mono_defaults.corlib = NULL;</span>
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span><span class="lineCov">       3272 :         mono_config_cleanup ();</span>
<span class="lineNum">     845 </span><span class="lineCov">       3272 :         mono_loader_cleanup ();</span>
<span class="lineNum">     846 </span><span class="lineCov">       3272 :         mono_classes_cleanup ();</span>
<span class="lineNum">     847 </span><span class="lineCov">       3272 :         mono_assemblies_cleanup ();</span>
<span class="lineNum">     848 </span><span class="lineCov">       3272 :         mono_debug_cleanup ();</span>
<span class="lineNum">     849 </span><span class="lineCov">       3272 :         mono_images_cleanup ();</span>
<span class="lineNum">     850 </span><span class="lineCov">       3272 :         mono_metadata_cleanup ();</span>
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span><span class="lineCov">       3272 :         mono_coop_mutex_destroy (&amp;appdomains_mutex);</span>
<span class="lineNum">     853 </span>            : 
<span class="lineNum">     854 </span><span class="lineCov">       3272 :         mono_w32process_cleanup ();</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span>            : #ifndef HOST_WIN32
<span class="lineNum">     857 </span><span class="lineCov">       3272 :         wapi_cleanup ();</span>
<span class="lineNum">     858 </span>            : #endif
<span class="lineNum">     859 </span><span class="lineCov">       3272 : }</span>
<a name="860"><span class="lineNum">     860 </span>            : </a>
<span class="lineNum">     861 </span>            : void
<span class="lineNum">     862 </span>            : mono_close_exe_image (void)
<span class="lineNum">     863 </span>            : {
<span class="lineNum">     864 </span><span class="lineCov">       3272 :         if (exe_image)</span>
<span class="lineNum">     865 </span><span class="lineCov">       3272 :                 mono_image_close (exe_image);</span>
<span class="lineNum">     866 </span><span class="lineCov">       3272 : }</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span>            : /**
<span class="lineNum">     869 </span>            :  * mono_get_root_domain:
<span class="lineNum">     870 </span>            :  *
<span class="lineNum">     871 </span>            :  * The root AppDomain is the initial domain created by the runtime when it is
<span class="lineNum">     872 </span>            :  * initialized.  Programs execute on this AppDomain, but can create new ones
<span class="lineNum">     873 </span>            :  * later.   Currently there is no unmanaged API to create new AppDomains, this
<span class="lineNum">     874 </span>            :  * must be done from managed code.
<span class="lineNum">     875 </span>            :  *
<span class="lineNum">     876 </span>            :  * Returns: the root appdomain, to obtain the current domain, use mono_domain_get ()
<a name="877"><span class="lineNum">     877 </span>            :  */</a>
<span class="lineNum">     878 </span>            : MonoDomain*
<span class="lineNum">     879 </span>            : mono_get_root_domain (void)
<span class="lineNum">     880 </span>            : {
<span class="lineNum">     881 </span><span class="lineCov">   56359891 :         return mono_root_domain;</span>
<span class="lineNum">     882 </span>            : }
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span>            : /**
<span class="lineNum">     885 </span>            :  * mono_domain_get:
<span class="lineNum">     886 </span>            :  *
<span class="lineNum">     887 </span>            :  * This method returns the value of the current MonoDomain that this thread
<span class="lineNum">     888 </span>            :  * and code are running under.   To obtain the root domain use
<span class="lineNum">     889 </span>            :  * mono_get_root_domain() API.
<span class="lineNum">     890 </span>            :  *
<span class="lineNum">     891 </span>            :  * Returns: the current domain
<a name="892"><span class="lineNum">     892 </span>            :  */</a>
<span class="lineNum">     893 </span>            : MonoDomain *
<span class="lineNum">     894 </span>            : mono_domain_get ()
<span class="lineNum">     895 </span>            : {
<span class="lineNum">     896 </span><span class="lineCov">  207629007 :         return GET_APPDOMAIN ();</span>
<span class="lineNum">     897 </span>            : }
<a name="898"><span class="lineNum">     898 </span>            : </a>
<span class="lineNum">     899 </span>            : void
<span class="lineNum">     900 </span>            : mono_domain_unset (void)
<span class="lineNum">     901 </span>            : {
<span class="lineNum">     902 </span><span class="lineCov">     133845 :         SET_APPDOMAIN (NULL);</span>
<span class="lineNum">     903 </span><span class="lineCov">      33458 : }</span>
<a name="904"><span class="lineNum">     904 </span>            : </a>
<span class="lineNum">     905 </span>            : void
<span class="lineNum">     906 </span>            : mono_domain_set_internal_with_options (MonoDomain *domain, gboolean migrate_exception)
<span class="lineNum">     907 </span>            : {
<span class="lineNum">     908 </span>            :         MonoInternalThread *thread;
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineCov">    5964844 :         if (mono_domain_get () == domain)</span>
<span class="lineNum">     911 </span><span class="lineCov">    5938597 :                 return;</span>
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span><span class="lineCov">     105351 :         SET_APPDOMAIN (domain);</span>
<span class="lineNum">     914 </span><span class="lineCov">      52674 :         SET_APPCONTEXT (domain-&gt;default_context);</span>
<span class="lineNum">     915 </span>            : 
<span class="lineNum">     916 </span><span class="lineCov">      26338 :         if (migrate_exception) {</span>
<span class="lineNum">     917 </span><span class="lineCov">      25830 :                 thread = mono_thread_internal_current ();</span>
<span class="lineNum">     918 </span><span class="lineCov">      25830 :                 if (!thread-&gt;abort_exc)</span>
<span class="lineNum">     919 </span><span class="lineCov">      25825 :                         return;</span>
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span><span class="lineCov">         15 :                 g_assert (thread-&gt;abort_exc-&gt;object.vtable-&gt;domain != domain);</span>
<span class="lineNum">     922 </span><span class="lineCov">         10 :                 MONO_OBJECT_SETREF (thread, abort_exc, mono_get_exception_thread_abort ());</span>
<span class="lineNum">     923 </span><span class="lineCov">         15 :                 g_assert (thread-&gt;abort_exc-&gt;object.vtable-&gt;domain == domain);</span>
<span class="lineNum">     924 </span><span class="lineCov">          5 :         }</span>
<span class="lineNum">     925 </span><span class="lineCov">    5964881 : }</span>
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span>            : /**
<span class="lineNum">     928 </span>            :  * mono_domain_set_internal:
<span class="lineNum">     929 </span>            :  * @domain: the new domain
<span class="lineNum">     930 </span>            :  *
<span class="lineNum">     931 </span>            :  * Sets the current domain to @domain.
<a name="932"><span class="lineNum">     932 </span>            :  */</a>
<span class="lineNum">     933 </span>            : void
<span class="lineNum">     934 </span>            : mono_domain_set_internal (MonoDomain *domain)
<span class="lineNum">     935 </span>            : {
<span class="lineNum">     936 </span><span class="lineCov">    5964923 :         mono_domain_set_internal_with_options (domain, TRUE);</span>
<span class="lineNum">     937 </span><span class="lineCov">    5964923 : }</span>
<span class="lineNum">     938 </span>            : 
<span class="lineNum">     939 </span>            : /**
<span class="lineNum">     940 </span>            :  * mono_domain_foreach:
<span class="lineNum">     941 </span>            :  * @func: function to invoke with the domain data
<span class="lineNum">     942 </span>            :  * @user_data: user-defined pointer that is passed to the supplied @func fo reach domain
<span class="lineNum">     943 </span>            :  *
<span class="lineNum">     944 </span>            :  * Use this method to safely iterate over all the loaded application
<span class="lineNum">     945 </span>            :  * domains in the current runtime.   The provided @func is invoked with a
<span class="lineNum">     946 </span>            :  * pointer to the MonoDomain and is given the value of the @user_data
<span class="lineNum">     947 </span>            :  * parameter which can be used to pass state to your called routine.
<a name="948"><span class="lineNum">     948 </span>            :  */</a>
<span class="lineNum">     949 </span>            : void
<span class="lineNum">     950 </span>            : mono_domain_foreach (MonoDomainFunc func, gpointer user_data)
<span class="lineNum">     951 </span>            : {
<span class="lineNum">     952 </span>            :         int i, size;
<span class="lineNum">     953 </span>            :         MonoDomain **copy;
<span class="lineNum">     954 </span>            : 
<span class="lineNum">     955 </span>            :         /*
<span class="lineNum">     956 </span>            :          * Create a copy of the data to avoid calling the user callback
<span class="lineNum">     957 </span>            :          * inside the lock because that could lead to deadlocks.
<span class="lineNum">     958 </span>            :          * We can do this because this function is not perf. critical.
<span class="lineNum">     959 </span>            :          */
<span class="lineNum">     960 </span><span class="lineCov">       3268 :         mono_appdomains_lock ();</span>
<span class="lineNum">     961 </span><span class="lineCov">       3268 :         size = appdomain_list_size;</span>
<span class="lineNum">     962 </span><span class="lineCov">       3268 :         copy = (MonoDomain **)mono_gc_alloc_fixed (appdomain_list_size * sizeof (void*), MONO_GC_DESCRIPTOR_NULL, MONO_ROOT_SOURCE_DOMAIN, &quot;temporary domains list&quot;);</span>
<span class="lineNum">     963 </span><span class="lineCov">       3268 :         memcpy (copy, appdomains_list, appdomain_list_size * sizeof (void*));</span>
<span class="lineNum">     964 </span><span class="lineCov">       3268 :         mono_appdomains_unlock ();</span>
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineCov">      19652 :         for (i = 0; i &lt; size; ++i) {</span>
<span class="lineNum">     967 </span><span class="lineCov">       6558 :                 if (copy [i])</span>
<span class="lineNum">     968 </span><span class="lineCov">       3306 :                         func (copy [i], user_data);</span>
<span class="lineNum">     969 </span><span class="lineCov">       6558 :         }</span>
<span class="lineNum">     970 </span>            : 
<span class="lineNum">     971 </span><span class="lineCov">       3268 :         mono_gc_free_fixed (copy);</span>
<span class="lineNum">     972 </span><span class="lineCov">       3268 : }</span>
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            : /**
<span class="lineNum">     975 </span>            :  * mono_domain_assembly_open:
<span class="lineNum">     976 </span>            :  * @domain: the application domain
<span class="lineNum">     977 </span>            :  * @name: file name of the assembly
<span class="lineNum">     978 </span>            :  *
<span class="lineNum">     979 </span>            :  * fixme: maybe we should integrate this with mono_assembly_open ??
<a name="980"><span class="lineNum">     980 </span>            :  */</a>
<span class="lineNum">     981 </span>            : MonoAssembly *
<span class="lineNum">     982 </span>            : mono_domain_assembly_open (MonoDomain *domain, const char *name)
<span class="lineNum">     983 </span>            : {
<span class="lineNum">     984 </span>            :         MonoDomain *current;
<span class="lineNum">     985 </span>            :         MonoAssembly *ass;
<span class="lineNum">     986 </span>            :         GSList *tmp;
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span><span class="lineCov">      13124 :         mono_domain_assemblies_lock (domain);</span>
<span class="lineNum">     989 </span><span class="lineCov">      28850 :         for (tmp = domain-&gt;domain_assemblies; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">     990 </span><span class="lineCov">      11144 :                 ass = (MonoAssembly *)tmp-&gt;data;</span>
<span class="lineNum">     991 </span><span class="lineCov">      11144 :                 if (strcmp (name, ass-&gt;aname.name) == 0) {</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                         mono_domain_assemblies_unlock (domain);</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                         return ass;</span>
<span class="lineNum">     994 </span>            :                 }
<span class="lineNum">     995 </span><span class="lineCov">      11144 :         }</span>
<span class="lineNum">     996 </span><span class="lineCov">      13124 :         mono_domain_assemblies_unlock (domain);</span>
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span><span class="lineCov">       3281 :         if (domain != mono_domain_get ()) {</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :                 current = mono_domain_get ();</span>
<span class="lineNum">    1000 </span>            : 
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :                 mono_domain_set (domain, FALSE);</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :                 ass = mono_assembly_open (name, NULL);</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :                 mono_domain_set (current, FALSE);</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1005 </span><span class="lineCov">       3281 :                 ass = mono_assembly_open (name, NULL);</span>
<span class="lineNum">    1006 </span>            :         }
<span class="lineNum">    1007 </span>            : 
<span class="lineNum">    1008 </span><span class="lineCov">       3281 :         return ass;</span>
<span class="lineNum">    1009 </span><span class="lineCov">       3281 : }</span>
<a name="1010"><span class="lineNum">    1010 </span>            : </a>
<span class="lineNum">    1011 </span>            : static void
<span class="lineNum">    1012 </span>            : unregister_vtable_reflection_type (MonoVTable *vtable)
<span class="lineNum">    1013 </span>            : {
<span class="lineNum">    1014 </span><span class="lineCov">    4657725 :         MonoObject *type = (MonoObject *)vtable-&gt;type;</span>
<span class="lineNum">    1015 </span>            : 
<span class="lineNum">    1016 </span><span class="lineCov">    4657725 :         if (type-&gt;vtable-&gt;klass != mono_defaults.runtimetype_class)</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                 MONO_GC_UNREGISTER_ROOT_IF_MOVING (vtable-&gt;type);</span>
<span class="lineNum">    1018 </span><span class="lineCov">    4657725 : }</span>
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span>            : /**
<span class="lineNum">    1021 </span>            :  * mono_domain_free:
<span class="lineNum">    1022 </span>            :  * @domain: the domain to release
<span class="lineNum">    1023 </span>            :  * @force: if true, it allows the root domain to be released (used at shutdown only).
<span class="lineNum">    1024 </span>            :  *
<span class="lineNum">    1025 </span>            :  * This releases the resources associated with the specific domain.
<span class="lineNum">    1026 </span>            :  * This is a low-level function that is invoked by the AppDomain infrastructure
<span class="lineNum">    1027 </span>            :  * when necessary.
<a name="1028"><span class="lineNum">    1028 </span>            :  */</a>
<span class="lineNum">    1029 </span>            : void
<span class="lineNum">    1030 </span>            : mono_domain_free (MonoDomain *domain, gboolean force)
<span class="lineNum">    1031 </span>            : {
<span class="lineNum">    1032 </span>            :         int code_size, code_alloc;
<span class="lineNum">    1033 </span>            :         GSList *tmp;
<span class="lineNum">    1034 </span>            :         gpointer *p;
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span><span class="lineCov">       6757 :         if ((domain == mono_root_domain) &amp;&amp; !force) {</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :                 g_warning (&quot;cant unload root domain&quot;);</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1039 </span>            :         }
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span><span class="lineCov">       3485 :         if (mono_dont_free_domains)</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span><span class="lineCov">       3485 :         mono_profiler_appdomain_event (domain, MONO_PROFILE_START_UNLOAD);</span>
<span class="lineNum">    1045 </span>            : 
<span class="lineNum">    1046 </span><span class="lineCov">       3485 :         mono_debug_domain_unload (domain);</span>
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span><span class="lineCov">       3485 :         mono_appdomains_lock ();</span>
<span class="lineNum">    1049 </span><span class="lineCov">       3485 :         appdomains_list [domain-&gt;domain_id] = NULL;</span>
<span class="lineNum">    1050 </span><span class="lineCov">       3485 :         mono_appdomains_unlock ();</span>
<span class="lineNum">    1051 </span>            : 
<span class="lineNum">    1052 </span>            :         /* must do this early as it accesses fields and types */
<span class="lineNum">    1053 </span><span class="lineCov">       3485 :         if (domain-&gt;special_static_fields) {</span>
<span class="lineNum">    1054 </span><span class="lineCov">       3485 :                 mono_alloc_special_static_data_free (domain-&gt;special_static_fields);</span>
<span class="lineNum">    1055 </span><span class="lineCov">       3485 :                 g_hash_table_destroy (domain-&gt;special_static_fields);</span>
<span class="lineNum">    1056 </span><span class="lineCov">       3485 :                 domain-&gt;special_static_fields = NULL;</span>
<span class="lineNum">    1057 </span><span class="lineCov">       3485 :         }</span>
<span class="lineNum">    1058 </span>            : 
<span class="lineNum">    1059 </span>            :         /*
<span class="lineNum">    1060 </span>            :          * We must destroy all these hash tables here because they
<span class="lineNum">    1061 </span>            :          * contain references to managed objects belonging to the
<span class="lineNum">    1062 </span>            :          * domain.  Once we let the GC clear the domain there must be
<span class="lineNum">    1063 </span>            :          * no more such references, or we'll crash if a collection
<span class="lineNum">    1064 </span>            :          * occurs.
<span class="lineNum">    1065 </span>            :          */
<span class="lineNum">    1066 </span><span class="lineCov">       3485 :         mono_g_hash_table_destroy (domain-&gt;ldstr_table);</span>
<span class="lineNum">    1067 </span><span class="lineCov">       3485 :         domain-&gt;ldstr_table = NULL;</span>
<span class="lineNum">    1068 </span>            : 
<span class="lineNum">    1069 </span><span class="lineCov">       3485 :         mono_g_hash_table_destroy (domain-&gt;env);</span>
<span class="lineNum">    1070 </span><span class="lineCov">       3485 :         domain-&gt;env = NULL;</span>
<span class="lineNum">    1071 </span>            : 
<span class="lineNum">    1072 </span><span class="lineCov">       3485 :         mono_reflection_cleanup_domain (domain);</span>
<span class="lineNum">    1073 </span>            : 
<span class="lineNum">    1074 </span>            :         /* This must be done before type_hash is freed */
<span class="lineNum">    1075 </span><span class="lineCov">       3485 :         if (domain-&gt;class_vtable_array) {</span>
<span class="lineNum">    1076 </span>            :                 int i;
<span class="lineNum">    1077 </span><span class="lineCov">    9322420 :                 for (i = 0; i &lt; domain-&gt;class_vtable_array-&gt;len; ++i)</span>
<span class="lineNum">    1078 </span><span class="lineCov">    4657725 :                         unregister_vtable_reflection_type ((MonoVTable *)g_ptr_array_index (domain-&gt;class_vtable_array, i));</span>
<span class="lineNum">    1079 </span><span class="lineCov">       3485 :         }</span>
<span class="lineNum">    1080 </span>            : 
<span class="lineNum">    1081 </span><span class="lineCov">       3485 :         if (domain-&gt;type_hash) {</span>
<span class="lineNum">    1082 </span><span class="lineCov">       3485 :                 mono_g_hash_table_destroy (domain-&gt;type_hash);</span>
<span class="lineNum">    1083 </span><span class="lineCov">       3485 :                 domain-&gt;type_hash = NULL;</span>
<span class="lineNum">    1084 </span><span class="lineCov">       3485 :         }</span>
<span class="lineNum">    1085 </span><span class="lineCov">       3485 :         if (domain-&gt;type_init_exception_hash) {</span>
<span class="lineNum">    1086 </span><span class="lineCov">         11 :                 mono_g_hash_table_destroy (domain-&gt;type_init_exception_hash);</span>
<span class="lineNum">    1087 </span><span class="lineCov">         11 :                 domain-&gt;type_init_exception_hash = NULL;</span>
<span class="lineNum">    1088 </span><span class="lineCov">         11 :         }</span>
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span><span class="lineCov">      96272 :         for (tmp = domain-&gt;domain_assemblies; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    1091 </span><span class="lineCov">      44651 :                 MonoAssembly *ass = (MonoAssembly *)tmp-&gt;data;</span>
<span class="lineNum">    1092 </span><span class="lineCov">      44651 :                 mono_assembly_release_gc_roots (ass);</span>
<span class="lineNum">    1093 </span><span class="lineCov">      44651 :         }</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span>            :         /* Have to zero out reference fields since they will be invalidated by the clear_domain () call below */
<span class="lineNum">    1096 </span><span class="lineCov">      76670 :         for (p = (gpointer*)&amp;domain-&gt;MONO_DOMAIN_FIRST_OBJECT; p &lt; (gpointer*)&amp;domain-&gt;MONO_DOMAIN_FIRST_GC_TRACKED; ++p)</span>
<span class="lineNum">    1097 </span><span class="lineCov">      34850 :                 *p = NULL;</span>
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span>            :         /* This needs to be done before closing assemblies */
<span class="lineNum">    1100 </span><span class="lineCov">       3485 :         mono_gc_clear_domain (domain);</span>
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span>            :         /* Close dynamic assemblies first, since they have no ref count */
<span class="lineNum">    1103 </span><span class="lineCov">      96272 :         for (tmp = domain-&gt;domain_assemblies; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    1104 </span><span class="lineCov">      44651 :                 MonoAssembly *ass = (MonoAssembly *)tmp-&gt;data;</span>
<span class="lineNum">    1105 </span><span class="lineCov">      89302 :                 if (!ass-&gt;image || !image_is_dynamic (ass-&gt;image))</span>
<span class="lineNum">    1106 </span><span class="lineCov">      44603 :                         continue;</span>
<span class="lineNum">    1107 </span><span class="lineCov">         48 :                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Unloading domain %s[%p], assembly %s[%p], ref_count=%d&quot;, domain-&gt;friendly_name, domain, ass-&gt;aname.name, ass, ass-&gt;ref_count);</span>
<span class="lineNum">    1108 </span><span class="lineCov">         48 :                 if (!mono_assembly_close_except_image_pools (ass))</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                         tmp-&gt;data = NULL;</span>
<span class="lineNum">    1110 </span><span class="lineCov">         48 :         }</span>
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span><span class="lineCov">      96272 :         for (tmp = domain-&gt;domain_assemblies; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    1113 </span><span class="lineCov">      44651 :                 MonoAssembly *ass = (MonoAssembly *)tmp-&gt;data;</span>
<span class="lineNum">    1114 </span><span class="lineCov">      44651 :                 if (!ass)</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1116 </span><span class="lineCov">      89302 :                 if (!ass-&gt;image || image_is_dynamic (ass-&gt;image))</span>
<span class="lineNum">    1117 </span><span class="lineCov">         48 :                         continue;</span>
<span class="lineNum">    1118 </span><span class="lineCov">      44603 :                 mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_ASSEMBLY, &quot;Unloading domain %s[%p], assembly %s[%p], ref_count=%d&quot;, domain-&gt;friendly_name, domain, ass-&gt;aname.name, ass, ass-&gt;ref_count);</span>
<span class="lineNum">    1119 </span><span class="lineCov">      44603 :                 if (!mono_assembly_close_except_image_pools (ass))</span>
<span class="lineNum">    1120 </span><span class="lineCov">      40023 :                         tmp-&gt;data = NULL;</span>
<span class="lineNum">    1121 </span><span class="lineCov">      44603 :         }</span>
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span><span class="lineCov">      96272 :         for (tmp = domain-&gt;domain_assemblies; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    1124 </span><span class="lineCov">      44651 :                 MonoAssembly *ass = (MonoAssembly *)tmp-&gt;data;</span>
<span class="lineNum">    1125 </span><span class="lineCov">      44651 :                 if (ass)</span>
<span class="lineNum">    1126 </span><span class="lineCov">       4628 :                         mono_assembly_close_finish (ass);</span>
<span class="lineNum">    1127 </span><span class="lineCov">      44651 :         }</span>
<span class="lineNum">    1128 </span><span class="lineCov">       3485 :         g_slist_free (domain-&gt;domain_assemblies);</span>
<span class="lineNum">    1129 </span><span class="lineCov">       3485 :         domain-&gt;domain_assemblies = NULL;</span>
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span>            :         /* 
<span class="lineNum">    1132 </span>            :          * Send this after the assemblies have been unloaded and the domain is still in a 
<span class="lineNum">    1133 </span>            :          * usable state.
<span class="lineNum">    1134 </span>            :          */
<span class="lineNum">    1135 </span><span class="lineCov">       3485 :         mono_profiler_appdomain_event (domain, MONO_PROFILE_END_UNLOAD);</span>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineCov">       3485 :         if (free_domain_hook)</span>
<span class="lineNum">    1138 </span><span class="lineCov">       3485 :                 free_domain_hook (domain);</span>
<span class="lineNum">    1139 </span>            : 
<span class="lineNum">    1140 </span>            :         /* FIXME: free delegate_hash_table when it's used */
<span class="lineNum">    1141 </span><span class="lineCov">       3485 :         if (domain-&gt;search_path) {</span>
<span class="lineNum">    1142 </span><span class="lineCov">       2093 :                 g_strfreev (domain-&gt;search_path);</span>
<span class="lineNum">    1143 </span><span class="lineCov">       2093 :                 domain-&gt;search_path = NULL;</span>
<span class="lineNum">    1144 </span><span class="lineCov">       2093 :         }</span>
<span class="lineNum">    1145 </span><span class="lineCov">       3485 :         domain-&gt;create_proxy_for_type_method = NULL;</span>
<span class="lineNum">    1146 </span><span class="lineCov">       3485 :         domain-&gt;private_invoke_method = NULL;</span>
<span class="lineNum">    1147 </span><span class="lineCov">       3485 :         domain-&gt;default_context = NULL;</span>
<span class="lineNum">    1148 </span><span class="lineCov">       3485 :         domain-&gt;out_of_memory_ex = NULL;</span>
<span class="lineNum">    1149 </span><span class="lineCov">       3485 :         domain-&gt;null_reference_ex = NULL;</span>
<span class="lineNum">    1150 </span><span class="lineCov">       3485 :         domain-&gt;stack_overflow_ex = NULL;</span>
<span class="lineNum">    1151 </span><span class="lineCov">       3485 :         domain-&gt;ephemeron_tombstone = NULL;</span>
<span class="lineNum">    1152 </span><span class="lineCov">       3485 :         domain-&gt;entry_assembly = NULL;</span>
<span class="lineNum">    1153 </span>            : 
<span class="lineNum">    1154 </span><span class="lineCov">       3485 :         g_free (domain-&gt;friendly_name);</span>
<span class="lineNum">    1155 </span><span class="lineCov">       3485 :         domain-&gt;friendly_name = NULL;</span>
<span class="lineNum">    1156 </span><span class="lineCov">       3485 :         g_ptr_array_free (domain-&gt;class_vtable_array, TRUE);</span>
<span class="lineNum">    1157 </span><span class="lineCov">       3485 :         domain-&gt;class_vtable_array = NULL;</span>
<span class="lineNum">    1158 </span><span class="lineCov">       3485 :         g_hash_table_destroy (domain-&gt;proxy_vtable_hash);</span>
<span class="lineNum">    1159 </span><span class="lineCov">       3485 :         domain-&gt;proxy_vtable_hash = NULL;</span>
<span class="lineNum">    1160 </span><span class="lineCov">       3485 :         if (domain-&gt;static_data_array) {</span>
<span class="lineNum">    1161 </span><span class="lineCov">       3485 :                 mono_gc_free_fixed (domain-&gt;static_data_array);</span>
<span class="lineNum">    1162 </span><span class="lineCov">       3485 :                 domain-&gt;static_data_array = NULL;</span>
<span class="lineNum">    1163 </span><span class="lineCov">       3485 :         }</span>
<span class="lineNum">    1164 </span><span class="lineCov">       3485 :         mono_internal_hash_table_destroy (&amp;domain-&gt;jit_code_hash);</span>
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span>            :         /*
<span class="lineNum">    1167 </span>            :          * There might still be jit info tables of this domain which
<span class="lineNum">    1168 </span>            :          * are not freed.  Since the domain cannot be in use anymore,
<span class="lineNum">    1169 </span>            :          * this will free them.
<span class="lineNum">    1170 </span>            :          */
<span class="lineNum">    1171 </span><span class="lineCov">       3485 :         mono_thread_hazardous_try_free_all ();</span>
<span class="lineNum">    1172 </span><span class="lineCov">       3485 :         if (domain-&gt;aot_modules)</span>
<span class="lineNum">    1173 </span><span class="lineCov">       2558 :                 mono_jit_info_table_free (domain-&gt;aot_modules);</span>
<span class="lineNum">    1174 </span><span class="lineCov">      10455 :         g_assert (domain-&gt;num_jit_info_tables == 1);</span>
<span class="lineNum">    1175 </span><span class="lineCov">       3485 :         mono_jit_info_table_free (domain-&gt;jit_info_table);</span>
<span class="lineNum">    1176 </span><span class="lineCov">       3485 :         domain-&gt;jit_info_table = NULL;</span>
<span class="lineNum">    1177 </span><span class="lineCov">      10455 :         g_assert (!domain-&gt;jit_info_free_queue);</span>
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span>            :         /* collect statistics */
<span class="lineNum">    1180 </span><span class="lineCov">       3485 :         code_alloc = mono_code_manager_size (domain-&gt;code_mp, &amp;code_size);</span>
<span class="lineNum">    1181 </span><span class="lineCov">       3485 :         total_domain_code_alloc += code_alloc;</span>
<span class="lineNum">    1182 </span><span class="lineCov">      10455 :         max_domain_code_alloc = MAX (max_domain_code_alloc, code_alloc);</span>
<span class="lineNum">    1183 </span><span class="lineCov">      10455 :         max_domain_code_size = MAX (max_domain_code_size, code_size);</span>
<span class="lineNum">    1184 </span>            : 
<span class="lineNum">    1185 </span><span class="lineCov">       3485 :         if (debug_domain_unload) {</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                 mono_mempool_invalidate (domain-&gt;mp);</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                 mono_code_manager_invalidate (domain-&gt;code_mp);</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1189 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">    1190 </span><span class="lineCov">       3485 :                 mono_perfcounters-&gt;loader_bytes -= mono_mempool_get_allocated (domain-&gt;mp);</span>
<span class="lineNum">    1191 </span>            : #endif
<span class="lineNum">    1192 </span><span class="lineCov">       3485 :                 mono_mempool_destroy (domain-&gt;mp);</span>
<span class="lineNum">    1193 </span><span class="lineCov">       3485 :                 domain-&gt;mp = NULL;</span>
<span class="lineNum">    1194 </span><span class="lineCov">       3485 :                 mono_code_manager_destroy (domain-&gt;code_mp);</span>
<span class="lineNum">    1195 </span><span class="lineCov">       3485 :                 domain-&gt;code_mp = NULL;</span>
<span class="lineNum">    1196 </span>            :         }
<span class="lineNum">    1197 </span><span class="lineCov">       3485 :         lock_free_mempool_free (domain-&gt;lock_free_mp);</span>
<span class="lineNum">    1198 </span><span class="lineCov">       3485 :         domain-&gt;lock_free_mp = NULL;</span>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineCov">       3485 :         g_hash_table_destroy (domain-&gt;finalizable_objects_hash);</span>
<span class="lineNum">    1201 </span><span class="lineCov">       3485 :         domain-&gt;finalizable_objects_hash = NULL;</span>
<span class="lineNum">    1202 </span><span class="lineCov">       3485 :         if (domain-&gt;method_rgctx_hash) {</span>
<span class="lineNum">    1203 </span><span class="lineCov">       3468 :                 g_hash_table_destroy (domain-&gt;method_rgctx_hash);</span>
<span class="lineNum">    1204 </span><span class="lineCov">       3468 :                 domain-&gt;method_rgctx_hash = NULL;</span>
<span class="lineNum">    1205 </span><span class="lineCov">       3468 :         }</span>
<span class="lineNum">    1206 </span><span class="lineCov">       3485 :         if (domain-&gt;generic_virtual_cases) {</span>
<span class="lineNum">    1207 </span><span class="lineCov">       2594 :                 g_hash_table_destroy (domain-&gt;generic_virtual_cases);</span>
<span class="lineNum">    1208 </span><span class="lineCov">       2594 :                 domain-&gt;generic_virtual_cases = NULL;</span>
<span class="lineNum">    1209 </span><span class="lineCov">       2594 :         }</span>
<span class="lineNum">    1210 </span><span class="lineCov">       3485 :         if (domain-&gt;ftnptrs_hash) {</span>
<span class="lineNum">    1211 </span><span class="lineCov">       3485 :                 g_hash_table_destroy (domain-&gt;ftnptrs_hash);</span>
<span class="lineNum">    1212 </span><span class="lineCov">       3485 :                 domain-&gt;ftnptrs_hash = NULL;</span>
<span class="lineNum">    1213 </span><span class="lineCov">       3485 :         }</span>
<span class="lineNum">    1214 </span><span class="lineCov">       3485 :         if (domain-&gt;method_to_dyn_method) {</span>
<span class="lineNum">    1215 </span><span class="lineCov">         18 :                 g_hash_table_destroy (domain-&gt;method_to_dyn_method);</span>
<span class="lineNum">    1216 </span><span class="lineCov">         18 :                 domain-&gt;method_to_dyn_method = NULL;</span>
<span class="lineNum">    1217 </span><span class="lineCov">         18 :         }</span>
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span><span class="lineCov">       3485 :         mono_os_mutex_destroy (&amp;domain-&gt;finalizable_objects_hash_lock);</span>
<span class="lineNum">    1220 </span><span class="lineCov">       3485 :         mono_os_mutex_destroy (&amp;domain-&gt;assemblies_lock);</span>
<span class="lineNum">    1221 </span><span class="lineCov">       3485 :         mono_os_mutex_destroy (&amp;domain-&gt;jit_code_hash_lock);</span>
<span class="lineNum">    1222 </span>            : 
<span class="lineNum">    1223 </span><span class="lineCov">       3485 :         mono_coop_mutex_destroy (&amp;domain-&gt;lock);</span>
<span class="lineNum">    1224 </span>            : 
<span class="lineNum">    1225 </span><span class="lineCov">       3485 :         domain-&gt;setup = NULL;</span>
<span class="lineNum">    1226 </span>            : 
<span class="lineNum">    1227 </span><span class="lineCov">       3485 :         mono_gc_deregister_root ((char*)&amp;(domain-&gt;MONO_DOMAIN_FIRST_GC_TRACKED));</span>
<span class="lineNum">    1228 </span>            : 
<span class="lineNum">    1229 </span>            :         /* FIXME: anything else required ? */
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span><span class="lineCov">       3485 :         mono_gc_free_fixed (domain);</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">    1234 </span><span class="lineCov">       3485 :         mono_perfcounters-&gt;loader_appdomains--;</span>
<span class="lineNum">    1235 </span>            : #endif
<span class="lineNum">    1236 </span>            : 
<span class="lineNum">    1237 </span><span class="lineCov">       3485 :         if (domain == mono_root_domain)</span>
<span class="lineNum">    1238 </span><span class="lineCov">       3272 :                 mono_root_domain = NULL;</span>
<span class="lineNum">    1239 </span><span class="lineCov">       3485 : }</span>
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span>            : /**
<span class="lineNum">    1242 </span>            :  * mono_domain_get_by_id:
<span class="lineNum">    1243 </span>            :  * @domainid: the ID
<span class="lineNum">    1244 </span>            :  *
<span class="lineNum">    1245 </span>            :  * Returns: the domain for a specific domain id.
<a name="1246"><span class="lineNum">    1246 </span>            :  */</a>
<span class="lineNum">    1247 </span>            : MonoDomain * 
<span class="lineNum">    1248 </span>            : mono_domain_get_by_id (gint32 domainid) 
<span class="lineNum">    1249 </span>            : {
<span class="lineNum">    1250 </span>            :         MonoDomain * domain;
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span><span class="lineCov">       3825 :         mono_appdomains_lock ();</span>
<span class="lineNum">    1253 </span><span class="lineCov">       3825 :         if (domainid &lt; appdomain_list_size)</span>
<span class="lineNum">    1254 </span><span class="lineCov">       3825 :                 domain = appdomains_list [domainid];</span>
<span class="lineNum">    1255 </span>            :         else
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :                 domain = NULL;</span>
<span class="lineNum">    1257 </span><span class="lineCov">       3825 :         mono_appdomains_unlock ();</span>
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span><span class="lineCov">       3825 :         return domain;</span>
<span class="lineNum">    1260 </span>            : }
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span>            : /*
<span class="lineNum">    1263 </span>            :  * mono_domain_get_id:
<span class="lineNum">    1264 </span>            :  *
<span class="lineNum">    1265 </span>            :  * A domain ID is guaranteed to be unique for as long as the domain
<span class="lineNum">    1266 </span>            :  * using it is alive. It may be reused later once the domain has been
<span class="lineNum">    1267 </span>            :  * unloaded.
<span class="lineNum">    1268 </span>            :  *
<span class="lineNum">    1269 </span>            :  * Returns: The unique ID for @domain.
<a name="1270"><span class="lineNum">    1270 </span>            :  */</a>
<span class="lineNum">    1271 </span>            : gint32
<span class="lineNum">    1272 </span>            : mono_domain_get_id (MonoDomain *domain)
<span class="lineNum">    1273 </span>            : {
<span class="lineNum">    1274 </span><span class="lineCov">         36 :         return domain-&gt;domain_id;</span>
<span class="lineNum">    1275 </span>            : }
<span class="lineNum">    1276 </span>            : 
<span class="lineNum">    1277 </span>            : /*
<span class="lineNum">    1278 </span>            :  * mono_domain_get_friendly_name:
<span class="lineNum">    1279 </span>            :  *
<span class="lineNum">    1280 </span>            :  * The returned string's lifetime is the same as @domain's. Consider
<span class="lineNum">    1281 </span>            :  * copying it if you need to store it somewhere.
<span class="lineNum">    1282 </span>            :  *
<span class="lineNum">    1283 </span>            :  * Returns: The friendly name of @domain. Can be NULL if not yet set.
<a name="1284"><span class="lineNum">    1284 </span>            :  */</a>
<span class="lineNum">    1285 </span>            : const char *
<span class="lineNum">    1286 </span>            : mono_domain_get_friendly_name (MonoDomain *domain)
<span class="lineNum">    1287 </span>            : {
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :         return domain-&gt;friendly_name;</span>
<span class="lineNum">    1289 </span>            : }
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span>            : /*
<span class="lineNum">    1292 </span>            :  * mono_domain_alloc:
<span class="lineNum">    1293 </span>            :  *
<span class="lineNum">    1294 </span>            :  * LOCKING: Acquires the domain lock.
<a name="1295"><span class="lineNum">    1295 </span>            :  */</a>
<span class="lineNum">    1296 </span>            : gpointer
<span class="lineNum">    1297 </span>            : mono_domain_alloc (MonoDomain *domain, guint size)
<span class="lineNum">    1298 </span>            : {
<span class="lineNum">    1299 </span>            :         gpointer res;
<span class="lineNum">    1300 </span>            : 
<span class="lineNum">    1301 </span><span class="lineCov">     749229 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1302 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">    1303 </span><span class="lineCov">     749229 :         mono_perfcounters-&gt;loader_bytes += size;</span>
<span class="lineNum">    1304 </span>            : #endif
<span class="lineNum">    1305 </span><span class="lineCov">     749229 :         res = mono_mempool_alloc (domain-&gt;mp, size);</span>
<span class="lineNum">    1306 </span><span class="lineCov">     749229 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1307 </span>            : 
<span class="lineNum">    1308 </span><span class="lineCov">     749229 :         return res;</span>
<span class="lineNum">    1309 </span>            : }
<span class="lineNum">    1310 </span>            : 
<span class="lineNum">    1311 </span>            : /*
<span class="lineNum">    1312 </span>            :  * mono_domain_alloc0:
<span class="lineNum">    1313 </span>            :  *
<span class="lineNum">    1314 </span>            :  * LOCKING: Acquires the domain lock.
<a name="1315"><span class="lineNum">    1315 </span>            :  */</a>
<span class="lineNum">    1316 </span>            : gpointer
<span class="lineNum">    1317 </span>            : mono_domain_alloc0 (MonoDomain *domain, guint size)
<span class="lineNum">    1318 </span>            : {
<span class="lineNum">    1319 </span>            :         gpointer res;
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineCov">   27955972 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1322 </span>            : #ifndef DISABLE_PERFCOUNTERS
<span class="lineNum">    1323 </span><span class="lineCov">   27955972 :         mono_perfcounters-&gt;loader_bytes += size;</span>
<span class="lineNum">    1324 </span>            : #endif
<span class="lineNum">    1325 </span><span class="lineCov">   27955972 :         res = mono_mempool_alloc0 (domain-&gt;mp, size);</span>
<span class="lineNum">    1326 </span><span class="lineCov">   27955972 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1327 </span>            : 
<span class="lineNum">    1328 </span><span class="lineCov">   27955972 :         return res;</span>
<span class="lineNum">    1329 </span>            : }
<a name="1330"><span class="lineNum">    1330 </span>            : </a>
<span class="lineNum">    1331 </span>            : gpointer
<span class="lineNum">    1332 </span>            : mono_domain_alloc0_lock_free (MonoDomain *domain, guint size)
<span class="lineNum">    1333 </span>            : {
<span class="lineNum">    1334 </span><span class="lineCov">        284 :         return lock_free_mempool_alloc0 (domain-&gt;lock_free_mp, size);</span>
<span class="lineNum">    1335 </span>            : }
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span>            : /*
<span class="lineNum">    1338 </span>            :  * mono_domain_code_reserve:
<span class="lineNum">    1339 </span>            :  *
<span class="lineNum">    1340 </span>            :  * LOCKING: Acquires the domain lock.
<a name="1341"><span class="lineNum">    1341 </span>            :  */</a>
<span class="lineNum">    1342 </span>            : void*
<span class="lineNum">    1343 </span>            : mono_domain_code_reserve (MonoDomain *domain, int size)
<span class="lineNum">    1344 </span>            : {
<span class="lineNum">    1345 </span>            :         gpointer res;
<span class="lineNum">    1346 </span>            : 
<span class="lineNum">    1347 </span><span class="lineCov">   17407180 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1348 </span><span class="lineCov">   17407180 :         res = mono_code_manager_reserve (domain-&gt;code_mp, size);</span>
<span class="lineNum">    1349 </span><span class="lineCov">   17407180 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1350 </span>            : 
<span class="lineNum">    1351 </span><span class="lineCov">   17407180 :         return res;</span>
<span class="lineNum">    1352 </span>            : }
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span>            : /*
<span class="lineNum">    1355 </span>            :  * mono_domain_code_reserve_align:
<span class="lineNum">    1356 </span>            :  *
<span class="lineNum">    1357 </span>            :  * LOCKING: Acquires the domain lock.
<a name="1358"><span class="lineNum">    1358 </span>            :  */</a>
<span class="lineNum">    1359 </span>            : void*
<span class="lineNum">    1360 </span>            : mono_domain_code_reserve_align (MonoDomain *domain, int size, int alignment)
<span class="lineNum">    1361 </span>            : {
<span class="lineNum">    1362 </span>            :         gpointer res;
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span><span class="lineCov">   15463082 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1365 </span><span class="lineCov">   15463082 :         res = mono_code_manager_reserve_align (domain-&gt;code_mp, size, alignment);</span>
<span class="lineNum">    1366 </span><span class="lineCov">   15463082 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1367 </span>            : 
<span class="lineNum">    1368 </span><span class="lineCov">   15463082 :         return res;</span>
<span class="lineNum">    1369 </span>            : }
<span class="lineNum">    1370 </span>            : 
<span class="lineNum">    1371 </span>            : /*
<span class="lineNum">    1372 </span>            :  * mono_domain_code_commit:
<span class="lineNum">    1373 </span>            :  *
<span class="lineNum">    1374 </span>            :  * LOCKING: Acquires the domain lock.
<a name="1375"><span class="lineNum">    1375 </span>            :  */</a>
<span class="lineNum">    1376 </span>            : void
<span class="lineNum">    1377 </span>            : mono_domain_code_commit (MonoDomain *domain, void *data, int size, int newsize)
<span class="lineNum">    1378 </span>            : {
<span class="lineNum">    1379 </span><span class="lineCov">   14274278 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1380 </span><span class="lineCov">   14274278 :         mono_code_manager_commit (domain-&gt;code_mp, data, size, newsize);</span>
<span class="lineNum">    1381 </span><span class="lineCov">   14274278 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1382 </span><span class="lineCov">   14274278 : }</span>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span>            : /*
<span class="lineNum">    1385 </span>            :  * mono_domain_code_foreach:
<span class="lineNum">    1386 </span>            :  * Iterate over the code thunks of the code manager of @domain.
<span class="lineNum">    1387 </span>            :  * 
<span class="lineNum">    1388 </span>            :  * The @func callback MUST not take any locks. If it really needs to, it must respect
<span class="lineNum">    1389 </span>            :  * the locking rules of the runtime: http://www.mono-project.com/Mono:Runtime:Documentation:ThreadSafety 
<span class="lineNum">    1390 </span>            :  * LOCKING: Acquires the domain lock.
<span class="lineNum">    1391 </span>            :  */
<a name="1392"><span class="lineNum">    1392 </span>            : </a>
<span class="lineNum">    1393 </span>            : void
<span class="lineNum">    1394 </span>            : mono_domain_code_foreach (MonoDomain *domain, MonoCodeManagerFunc func, void *user_data)
<span class="lineNum">    1395 </span>            : {
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :         mono_domain_lock (domain);</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :         mono_code_manager_foreach (domain-&gt;code_mp, func, user_data);</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :         mono_domain_unlock (domain);</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1400 </span>            : 
<a name="1401"><span class="lineNum">    1401 </span>            : </a>
<span class="lineNum">    1402 </span>            : void 
<span class="lineNum">    1403 </span>            : mono_context_set (MonoAppContext * new_context)
<span class="lineNum">    1404 </span>            : {
<span class="lineNum">    1405 </span><span class="lineCov">       9586 :         SET_APPCONTEXT (new_context);</span>
<span class="lineNum">    1406 </span><span class="lineCov">       4793 : }</span>
<span class="lineNum">    1407 </span>            : 
<span class="lineNum">    1408 </span>            : /**
<span class="lineNum">    1409 </span>            :  * mono_context_get:
<span class="lineNum">    1410 </span>            :  *
<span class="lineNum">    1411 </span>            :  * Returns: the current Mono Application Context.
<a name="1412"><span class="lineNum">    1412 </span>            :  */</a>
<span class="lineNum">    1413 </span>            : MonoAppContext * 
<span class="lineNum">    1414 </span>            : mono_context_get (void)
<span class="lineNum">    1415 </span>            : {
<span class="lineNum">    1416 </span><span class="lineCov">       3234 :         return GET_APPCONTEXT ();</span>
<span class="lineNum">    1417 </span>            : }
<span class="lineNum">    1418 </span>            : 
<span class="lineNum">    1419 </span>            : /**
<span class="lineNum">    1420 </span>            :  * mono_context_get_id:
<span class="lineNum">    1421 </span>            :  * @context: the context to operate on.
<span class="lineNum">    1422 </span>            :  *
<span class="lineNum">    1423 </span>            :  * Context IDs are guaranteed to be unique for the duration of a Mono
<span class="lineNum">    1424 </span>            :  * process; they are never reused.
<span class="lineNum">    1425 </span>            :  *
<span class="lineNum">    1426 </span>            :  * Returns: The unique ID for @context.
<a name="1427"><span class="lineNum">    1427 </span>            :  */</a>
<span class="lineNum">    1428 </span>            : gint32
<span class="lineNum">    1429 </span>            : mono_context_get_id (MonoAppContext *context)
<span class="lineNum">    1430 </span>            : {
<span class="lineNum">    1431 </span><span class="lineCov">         36 :         return context-&gt;context_id;</span>
<span class="lineNum">    1432 </span>            : }
<span class="lineNum">    1433 </span>            : 
<span class="lineNum">    1434 </span>            : /**
<span class="lineNum">    1435 </span>            :  * mono_context_get_domain_id:
<span class="lineNum">    1436 </span>            :  * @context: the context to operate on.
<span class="lineNum">    1437 </span>            :  *
<span class="lineNum">    1438 </span>            :  * Returns: The ID of the domain that @context was created in.
<a name="1439"><span class="lineNum">    1439 </span>            :  */</a>
<span class="lineNum">    1440 </span>            : gint32
<span class="lineNum">    1441 </span>            : mono_context_get_domain_id (MonoAppContext *context)
<span class="lineNum">    1442 </span>            : {
<span class="lineNum">    1443 </span><span class="lineCov">         36 :         return context-&gt;domain_id;</span>
<span class="lineNum">    1444 </span>            : }
<span class="lineNum">    1445 </span>            : 
<a name="1446"><span class="lineNum">    1446 </span>            : /* LOCKING: the caller holds the lock for this domain */</a>
<span class="lineNum">    1447 </span>            : void
<span class="lineNum">    1448 </span>            : mono_domain_add_class_static_data (MonoDomain *domain, MonoClass *klass, gpointer data, guint32 *bitmap)
<span class="lineNum">    1449 </span>            : {
<span class="lineNum">    1450 </span>            :         /* Note [Domain Static Data Array]:
<span class="lineNum">    1451 </span>            :          *
<span class="lineNum">    1452 </span>            :          * Entry 0 in the array is the index of the next free slot.
<span class="lineNum">    1453 </span>            :          * Entry 1 is the total size of the array.
<span class="lineNum">    1454 </span>            :          */
<span class="lineNum">    1455 </span>            :         int next;
<span class="lineNum">    1456 </span><span class="lineCov">    1108377 :         if (domain-&gt;static_data_array) {</span>
<span class="lineNum">    1457 </span><span class="lineCov">    1104839 :                 int size = GPOINTER_TO_INT (domain-&gt;static_data_array [1]);</span>
<span class="lineNum">    1458 </span><span class="lineCov">    1104839 :                 next = GPOINTER_TO_INT (domain-&gt;static_data_array [0]);</span>
<span class="lineNum">    1459 </span><span class="lineCov">    1104839 :                 if (next &gt;= size) {</span>
<span class="lineNum">    1460 </span>            :                         /* 'data' is allocated by alloc_fixed */
<span class="lineNum">    1461 </span><span class="lineCov">      24879 :                         gpointer *new_array = (gpointer *)mono_gc_alloc_fixed (sizeof (gpointer) * (size * 2), MONO_GC_ROOT_DESCR_FOR_FIXED (size * 2), MONO_ROOT_SOURCE_DOMAIN, &quot;static field list&quot;);</span>
<span class="lineNum">    1462 </span><span class="lineCov">       8293 :                         mono_gc_memmove_aligned (new_array, domain-&gt;static_data_array, sizeof (gpointer) * size);</span>
<span class="lineNum">    1463 </span><span class="lineCov">       8293 :                         size *= 2;</span>
<span class="lineNum">    1464 </span><span class="lineCov">       8293 :                         new_array [1] = GINT_TO_POINTER (size);</span>
<span class="lineNum">    1465 </span><span class="lineCov">       8293 :                         mono_gc_free_fixed (domain-&gt;static_data_array);</span>
<span class="lineNum">    1466 </span><span class="lineCov">       8293 :                         domain-&gt;static_data_array = new_array;</span>
<span class="lineNum">    1467 </span><span class="lineCov">       8293 :                 }</span>
<span class="lineNum">    1468 </span><span class="lineCov">    1104839 :         } else {</span>
<span class="lineNum">    1469 </span><span class="lineCov">       3538 :                 int size = 32;</span>
<span class="lineNum">    1470 </span><span class="lineCov">      10614 :                 gpointer *new_array = (gpointer *)mono_gc_alloc_fixed (sizeof (gpointer) * size, MONO_GC_ROOT_DESCR_FOR_FIXED (size), MONO_ROOT_SOURCE_DOMAIN, &quot;static field list&quot;);</span>
<span class="lineNum">    1471 </span><span class="lineCov">       3538 :                 next = 2;</span>
<span class="lineNum">    1472 </span><span class="lineCov">       3538 :                 new_array [0] = GINT_TO_POINTER (next);</span>
<span class="lineNum">    1473 </span><span class="lineCov">       3538 :                 new_array [1] = GINT_TO_POINTER (size);</span>
<span class="lineNum">    1474 </span><span class="lineCov">       3538 :                 domain-&gt;static_data_array = new_array;</span>
<span class="lineNum">    1475 </span>            :         }
<span class="lineNum">    1476 </span><span class="lineCov">    1108377 :         domain-&gt;static_data_array [next++] = data;</span>
<span class="lineNum">    1477 </span><span class="lineCov">    1108377 :         domain-&gt;static_data_array [0] = GINT_TO_POINTER (next);</span>
<span class="lineNum">    1478 </span><span class="lineCov">    1108377 : }</span>
<span class="lineNum">    1479 </span>            : 
<span class="lineNum">    1480 </span>            : /**
<span class="lineNum">    1481 </span>            :  * mono_get_corlib:
<span class="lineNum">    1482 </span>            :  *
<span class="lineNum">    1483 </span>            :  * Use this function to get the `MonoImage*` for the mscorlib.dll assembly
<span class="lineNum">    1484 </span>            :  *
<span class="lineNum">    1485 </span>            :  * Returns: The MonoImage for mscorlib.dll
<a name="1486"><span class="lineNum">    1486 </span>            :  */</a>
<span class="lineNum">    1487 </span>            : MonoImage*
<span class="lineNum">    1488 </span>            : mono_get_corlib (void)
<span class="lineNum">    1489 </span>            : {
<span class="lineNum">    1490 </span><span class="lineCov">    1236492 :         return mono_defaults.corlib;</span>
<span class="lineNum">    1491 </span>            : }
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span>            : /**
<span class="lineNum">    1494 </span>            :  * mono_get_object_class:
<span class="lineNum">    1495 </span>            :  *
<span class="lineNum">    1496 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Object`.
<span class="lineNum">    1497 </span>            :  *
<span class="lineNum">    1498 </span>            :  * Returns: The `MonoClass*` for the `System.Object` type.
<a name="1499"><span class="lineNum">    1499 </span>            :  */</a>
<span class="lineNum">    1500 </span>            : MonoClass*
<span class="lineNum">    1501 </span>            : mono_get_object_class (void)
<span class="lineNum">    1502 </span>            : {
<span class="lineNum">    1503 </span><span class="lineCov">      49716 :         return mono_defaults.object_class;</span>
<span class="lineNum">    1504 </span>            : }
<span class="lineNum">    1505 </span>            : 
<span class="lineNum">    1506 </span>            : /**
<span class="lineNum">    1507 </span>            :  * mono_get_byte_class:
<span class="lineNum">    1508 </span>            :  *
<span class="lineNum">    1509 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Byte`.
<span class="lineNum">    1510 </span>            :  *
<span class="lineNum">    1511 </span>            :  * Returns: The `MonoClass*` for the `System.Byte` type.
<a name="1512"><span class="lineNum">    1512 </span>            :  */</a>
<span class="lineNum">    1513 </span>            : MonoClass*
<span class="lineNum">    1514 </span>            : mono_get_byte_class (void)
<span class="lineNum">    1515 </span>            : {
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :         return mono_defaults.byte_class;</span>
<span class="lineNum">    1517 </span>            : }
<span class="lineNum">    1518 </span>            : 
<span class="lineNum">    1519 </span>            : /**
<span class="lineNum">    1520 </span>            :  * mono_get_void_class:
<span class="lineNum">    1521 </span>            :  *
<span class="lineNum">    1522 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Void`.
<span class="lineNum">    1523 </span>            :  *
<span class="lineNum">    1524 </span>            :  * Returns: The `MonoClass*` for the `System.Void` type.
<a name="1525"><span class="lineNum">    1525 </span>            :  */</a>
<span class="lineNum">    1526 </span>            : MonoClass*
<span class="lineNum">    1527 </span>            : mono_get_void_class (void)
<span class="lineNum">    1528 </span>            : {
<span class="lineNum">    1529 </span><span class="lineCov">        856 :         return mono_defaults.void_class;</span>
<span class="lineNum">    1530 </span>            : }
<span class="lineNum">    1531 </span>            : 
<span class="lineNum">    1532 </span>            : /**
<span class="lineNum">    1533 </span>            :  * mono_get_boolean_class:
<span class="lineNum">    1534 </span>            :  *
<span class="lineNum">    1535 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Boolean`.
<span class="lineNum">    1536 </span>            :  *
<span class="lineNum">    1537 </span>            :  * Returns: The `MonoClass*` for the `System.Boolean` type.
<a name="1538"><span class="lineNum">    1538 </span>            :  */</a>
<span class="lineNum">    1539 </span>            : MonoClass*
<span class="lineNum">    1540 </span>            : mono_get_boolean_class (void)
<span class="lineNum">    1541 </span>            : {
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :         return mono_defaults.boolean_class;</span>
<span class="lineNum">    1543 </span>            : }
<span class="lineNum">    1544 </span>            : 
<span class="lineNum">    1545 </span>            : /**
<span class="lineNum">    1546 </span>            :  * mono_get_sbyte_class:
<span class="lineNum">    1547 </span>            :  *
<span class="lineNum">    1548 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.SByte`.
<span class="lineNum">    1549 </span>            :  *
<span class="lineNum">    1550 </span>            :  * Returns: The `MonoClass*` for the `System.SByte` type.
<a name="1551"><span class="lineNum">    1551 </span>            :  */</a>
<span class="lineNum">    1552 </span>            : MonoClass*
<span class="lineNum">    1553 </span>            : mono_get_sbyte_class (void)
<span class="lineNum">    1554 </span>            : {
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :         return mono_defaults.sbyte_class;</span>
<span class="lineNum">    1556 </span>            : }
<span class="lineNum">    1557 </span>            : 
<span class="lineNum">    1558 </span>            : /**
<span class="lineNum">    1559 </span>            :  * mono_get_int16_class:
<span class="lineNum">    1560 </span>            :  *
<span class="lineNum">    1561 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Int16`.
<span class="lineNum">    1562 </span>            :  *
<span class="lineNum">    1563 </span>            :  * Returns: The `MonoClass*` for the `System.Int16` type.
<a name="1564"><span class="lineNum">    1564 </span>            :  */</a>
<span class="lineNum">    1565 </span>            : MonoClass*
<span class="lineNum">    1566 </span>            : mono_get_int16_class (void)
<span class="lineNum">    1567 </span>            : {
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :         return mono_defaults.int16_class;</span>
<span class="lineNum">    1569 </span>            : }
<span class="lineNum">    1570 </span>            : 
<span class="lineNum">    1571 </span>            : /**
<span class="lineNum">    1572 </span>            :  * mono_get_uint16_class:
<span class="lineNum">    1573 </span>            :  *
<span class="lineNum">    1574 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.UInt16`.
<span class="lineNum">    1575 </span>            :  *
<span class="lineNum">    1576 </span>            :  * Returns: The `MonoClass*` for the `System.UInt16` type.
<a name="1577"><span class="lineNum">    1577 </span>            :  */</a>
<span class="lineNum">    1578 </span>            : MonoClass*
<span class="lineNum">    1579 </span>            : mono_get_uint16_class (void)
<span class="lineNum">    1580 </span>            : {
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :         return mono_defaults.uint16_class;</span>
<span class="lineNum">    1582 </span>            : }
<span class="lineNum">    1583 </span>            : 
<span class="lineNum">    1584 </span>            : /**
<span class="lineNum">    1585 </span>            :  * mono_get_int32_class:
<span class="lineNum">    1586 </span>            :  *
<span class="lineNum">    1587 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Int32`.
<span class="lineNum">    1588 </span>            :  *
<span class="lineNum">    1589 </span>            :  * Returns: The `MonoClass*` for the `System.Int32` type.
<a name="1590"><span class="lineNum">    1590 </span>            :  */</a>
<span class="lineNum">    1591 </span>            : MonoClass*
<span class="lineNum">    1592 </span>            : mono_get_int32_class (void)
<span class="lineNum">    1593 </span>            : {
<span class="lineNum">    1594 </span><span class="lineCov">       1928 :         return mono_defaults.int32_class;</span>
<span class="lineNum">    1595 </span>            : }
<span class="lineNum">    1596 </span>            : 
<span class="lineNum">    1597 </span>            : /**
<span class="lineNum">    1598 </span>            :  * mono_get_uint32_class:
<span class="lineNum">    1599 </span>            :  *
<span class="lineNum">    1600 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.UInt32`.
<span class="lineNum">    1601 </span>            :  *
<span class="lineNum">    1602 </span>            :  * Returns: The `MonoClass*` for the `System.UInt32` type.
<a name="1603"><span class="lineNum">    1603 </span>            :  */</a>
<span class="lineNum">    1604 </span>            : MonoClass*
<span class="lineNum">    1605 </span>            : mono_get_uint32_class (void)
<span class="lineNum">    1606 </span>            : {
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :         return mono_defaults.uint32_class;</span>
<span class="lineNum">    1608 </span>            : }
<span class="lineNum">    1609 </span>            : 
<span class="lineNum">    1610 </span>            : /**
<span class="lineNum">    1611 </span>            :  * mono_get_intptr_class:
<span class="lineNum">    1612 </span>            :  *
<span class="lineNum">    1613 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.IntPtr`.
<span class="lineNum">    1614 </span>            :  *
<span class="lineNum">    1615 </span>            :  * Returns: The `MonoClass*` for the `System.IntPtr` type.
<a name="1616"><span class="lineNum">    1616 </span>            :  */</a>
<span class="lineNum">    1617 </span>            : MonoClass*
<span class="lineNum">    1618 </span>            : mono_get_intptr_class (void)
<span class="lineNum">    1619 </span>            : {
<span class="lineNum">    1620 </span><span class="lineCov">     357007 :         return mono_defaults.int_class;</span>
<span class="lineNum">    1621 </span>            : }
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span>            : /**
<span class="lineNum">    1624 </span>            :  * mono_get_uintptr_class:
<span class="lineNum">    1625 </span>            :  *
<span class="lineNum">    1626 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.UIntPtr`.
<span class="lineNum">    1627 </span>            :  *
<span class="lineNum">    1628 </span>            :  * Returns: The `MonoClass*` for the `System.UIntPtr` type.
<a name="1629"><span class="lineNum">    1629 </span>            :  */</a>
<span class="lineNum">    1630 </span>            : MonoClass*
<span class="lineNum">    1631 </span>            : mono_get_uintptr_class (void)
<span class="lineNum">    1632 </span>            : {
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :         return mono_defaults.uint_class;</span>
<span class="lineNum">    1634 </span>            : }
<span class="lineNum">    1635 </span>            : 
<span class="lineNum">    1636 </span>            : /**
<span class="lineNum">    1637 </span>            :  * mono_get_int64_class:
<span class="lineNum">    1638 </span>            :  *
<span class="lineNum">    1639 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Int64`.
<span class="lineNum">    1640 </span>            :  *
<span class="lineNum">    1641 </span>            :  * Returns: The `MonoClass*` for the `System.Int64` type.
<a name="1642"><span class="lineNum">    1642 </span>            :  */</a>
<span class="lineNum">    1643 </span>            : MonoClass*
<span class="lineNum">    1644 </span>            : mono_get_int64_class (void)
<span class="lineNum">    1645 </span>            : {
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :         return mono_defaults.int64_class;</span>
<span class="lineNum">    1647 </span>            : }
<span class="lineNum">    1648 </span>            : 
<span class="lineNum">    1649 </span>            : /**
<span class="lineNum">    1650 </span>            :  * mono_get_uint64_class:
<span class="lineNum">    1651 </span>            :  *
<span class="lineNum">    1652 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.UInt64`.
<span class="lineNum">    1653 </span>            :  *
<span class="lineNum">    1654 </span>            :  * Returns: The `MonoClass*` for the `System.UInt64` type.
<a name="1655"><span class="lineNum">    1655 </span>            :  */</a>
<span class="lineNum">    1656 </span>            : MonoClass*
<span class="lineNum">    1657 </span>            : mono_get_uint64_class (void)
<span class="lineNum">    1658 </span>            : {
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :         return mono_defaults.uint64_class;</span>
<span class="lineNum">    1660 </span>            : }
<span class="lineNum">    1661 </span>            : 
<span class="lineNum">    1662 </span>            : /**
<span class="lineNum">    1663 </span>            :  * mono_get_single_class:
<span class="lineNum">    1664 </span>            :  *
<span class="lineNum">    1665 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Single` (32-bit floating points).
<span class="lineNum">    1666 </span>            :  *
<span class="lineNum">    1667 </span>            :  * Returns: The `MonoClass*` for the `System.Single` type.
<a name="1668"><span class="lineNum">    1668 </span>            :  */</a>
<span class="lineNum">    1669 </span>            : MonoClass*
<span class="lineNum">    1670 </span>            : mono_get_single_class (void)
<span class="lineNum">    1671 </span>            : {
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :         return mono_defaults.single_class;</span>
<span class="lineNum">    1673 </span>            : }
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span>            : /**
<span class="lineNum">    1676 </span>            :  * mono_get_double_class:
<span class="lineNum">    1677 </span>            :  *
<span class="lineNum">    1678 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Double` (64-bit floating points).
<span class="lineNum">    1679 </span>            :  *
<span class="lineNum">    1680 </span>            :  * Returns: The `MonoClass*` for the `System.Double` type.
<a name="1681"><span class="lineNum">    1681 </span>            :  */</a>
<span class="lineNum">    1682 </span>            : MonoClass*
<span class="lineNum">    1683 </span>            : mono_get_double_class (void)
<span class="lineNum">    1684 </span>            : {
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :         return mono_defaults.double_class;</span>
<span class="lineNum">    1686 </span>            : }
<span class="lineNum">    1687 </span>            : 
<span class="lineNum">    1688 </span>            : /**
<span class="lineNum">    1689 </span>            :  * mono_get_char_class:
<span class="lineNum">    1690 </span>            :  *
<span class="lineNum">    1691 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Char`.
<span class="lineNum">    1692 </span>            :  *
<span class="lineNum">    1693 </span>            :  * Returns: The `MonoClass*` for the `System.Char` type.
<a name="1694"><span class="lineNum">    1694 </span>            :  */</a>
<span class="lineNum">    1695 </span>            : MonoClass*
<span class="lineNum">    1696 </span>            : mono_get_char_class (void)
<span class="lineNum">    1697 </span>            : {
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :         return mono_defaults.char_class;</span>
<span class="lineNum">    1699 </span>            : }
<span class="lineNum">    1700 </span>            : 
<span class="lineNum">    1701 </span>            : /**
<span class="lineNum">    1702 </span>            :  * mono_get_string_class:
<span class="lineNum">    1703 </span>            :  *
<span class="lineNum">    1704 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.String`.
<span class="lineNum">    1705 </span>            :  *
<span class="lineNum">    1706 </span>            :  * Returns: The `MonoClass*` for the `System.String` type.
<a name="1707"><span class="lineNum">    1707 </span>            :  */</a>
<span class="lineNum">    1708 </span>            : MonoClass*
<span class="lineNum">    1709 </span>            : mono_get_string_class (void)
<span class="lineNum">    1710 </span>            : {
<span class="lineNum">    1711 </span><span class="lineCov">       4982 :         return mono_defaults.string_class;</span>
<span class="lineNum">    1712 </span>            : }
<span class="lineNum">    1713 </span>            : 
<span class="lineNum">    1714 </span>            : /**
<span class="lineNum">    1715 </span>            :  * mono_get_enum_class:
<span class="lineNum">    1716 </span>            :  *
<span class="lineNum">    1717 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Enum`.
<span class="lineNum">    1718 </span>            :  *
<span class="lineNum">    1719 </span>            :  * Returns: The `MonoClass*` for the `System.Enum` type.
<a name="1720"><span class="lineNum">    1720 </span>            :  */</a>
<span class="lineNum">    1721 </span>            : MonoClass*
<span class="lineNum">    1722 </span>            : mono_get_enum_class (void)
<span class="lineNum">    1723 </span>            : {
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :         return mono_defaults.enum_class;</span>
<span class="lineNum">    1725 </span>            : }
<span class="lineNum">    1726 </span>            : 
<span class="lineNum">    1727 </span>            : /**
<span class="lineNum">    1728 </span>            :  * mono_get_array_class:
<span class="lineNum">    1729 </span>            :  *
<span class="lineNum">    1730 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Array`.
<span class="lineNum">    1731 </span>            :  *
<span class="lineNum">    1732 </span>            :  * Returns: The `MonoClass*` for the `System.Array` type.
<a name="1733"><span class="lineNum">    1733 </span>            :  */</a>
<span class="lineNum">    1734 </span>            : MonoClass*
<span class="lineNum">    1735 </span>            : mono_get_array_class (void)
<span class="lineNum">    1736 </span>            : {
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :         return mono_defaults.array_class;</span>
<span class="lineNum">    1738 </span>            : }
<span class="lineNum">    1739 </span>            : 
<span class="lineNum">    1740 </span>            : /**
<span class="lineNum">    1741 </span>            :  * mono_get_thread_class:
<span class="lineNum">    1742 </span>            :  *
<span class="lineNum">    1743 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Threading.Thread`.
<span class="lineNum">    1744 </span>            :  *
<span class="lineNum">    1745 </span>            :  * Returns: The `MonoClass*` for the `System.Threading.Thread` type.
<a name="1746"><span class="lineNum">    1746 </span>            :  */</a>
<span class="lineNum">    1747 </span>            : MonoClass*
<span class="lineNum">    1748 </span>            : mono_get_thread_class (void)
<span class="lineNum">    1749 </span>            : {
<span class="lineNum">    1750 </span><span class="lineNoCov">          0 :         return mono_defaults.thread_class;</span>
<span class="lineNum">    1751 </span>            : }
<span class="lineNum">    1752 </span>            : 
<span class="lineNum">    1753 </span>            : /**
<span class="lineNum">    1754 </span>            :  * mono_get_exception_class:
<span class="lineNum">    1755 </span>            :  *
<span class="lineNum">    1756 </span>            :  * Use this function to get the `MonoClass*` that the runtime is using for `System.Exception`.
<span class="lineNum">    1757 </span>            :  *
<span class="lineNum">    1758 </span>            :  * Returns: The `MonoClass*` for the `` type.
<a name="1759"><span class="lineNum">    1759 </span>            :  */</a>
<span class="lineNum">    1760 </span>            : MonoClass*
<span class="lineNum">    1761 </span>            : mono_get_exception_class (void)
<span class="lineNum">    1762 </span>            : {
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :         return mono_defaults.exception_class;</span>
<span class="lineNum">    1764 </span>            : }
<a name="1765"><span class="lineNum">    1765 </span>            : </a>
<span class="lineNum">    1766 </span>            : 
<span class="lineNum">    1767 </span>            : static char* get_attribute_value (const gchar **attribute_names, 
<span class="lineNum">    1768 </span>            :                                         const gchar **attribute_values, 
<span class="lineNum">    1769 </span>            :                                         const char *att_name)
<span class="lineNum">    1770 </span>            : {
<span class="lineNum">    1771 </span>            :         int n;
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :         for (n=0; attribute_names[n] != NULL; n++) {</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :                 if (strcmp (attribute_names[n], att_name) == 0)</span>
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :                         return g_strdup (attribute_values[n]);</span>
<span class="lineNum">    1775 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="1777"><span class="lineNum">    1777 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1778 </span>            : 
<span class="lineNum">    1779 </span>            : static void start_element (GMarkupParseContext *context, 
<span class="lineNum">    1780 </span>            :                            const gchar         *element_name,
<span class="lineNum">    1781 </span>            :                            const gchar        **attribute_names,
<span class="lineNum">    1782 </span>            :                            const gchar        **attribute_values,
<span class="lineNum">    1783 </span>            :                            gpointer             user_data,
<span class="lineNum">    1784 </span>            :                            GError             **error)
<span class="lineNum">    1785 </span>            : {
<span class="lineNum">    1786 </span><span class="lineCov">      29185 :         AppConfigInfo* app_config = (AppConfigInfo*) user_data;</span>
<span class="lineNum">    1787 </span>            :         
<span class="lineNum">    1788 </span><span class="lineCov">      29185 :         if (strcmp (element_name, &quot;configuration&quot;) == 0) {</span>
<span class="lineNum">    1789 </span><span class="lineCov">       1045 :                 app_config-&gt;configuration_count++;</span>
<span class="lineNum">    1790 </span><span class="lineCov">       1045 :                 return;</span>
<span class="lineNum">    1791 </span>            :         }
<span class="lineNum">    1792 </span><span class="lineCov">      28140 :         if (strcmp (element_name, &quot;startup&quot;) == 0) {</span>
<span class="lineNum">    1793 </span><span class="lineNoCov">          0 :                 app_config-&gt;startup_count++;</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1795 </span>            :         }
<span class="lineNum">    1796 </span>            :         
<span class="lineNum">    1797 </span><span class="lineCov">      56280 :         if (app_config-&gt;configuration_count != 1 || app_config-&gt;startup_count != 1)</span>
<span class="lineNum">    1798 </span><span class="lineCov">      28140 :                 return;</span>
<span class="lineNum">    1799 </span>            :         
<span class="lineNum">    1800 </span><span class="lineNoCov">          0 :         if (strcmp (element_name, &quot;requiredRuntime&quot;) == 0) {</span>
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :                 app_config-&gt;required_runtime = get_attribute_value (attribute_names, attribute_values, &quot;version&quot;);</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :         } else if (strcmp (element_name, &quot;supportedRuntime&quot;) == 0) {</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :                 char *version = get_attribute_value (attribute_names, attribute_values, &quot;version&quot;);</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :                 app_config-&gt;supported_runtimes = g_slist_append (app_config-&gt;supported_runtimes, version);</span>
<span class="lineNum">    1805 </span><span class="lineNoCov">          0 :         }</span>
<a name="1806"><span class="lineNum">    1806 </span><span class="lineCov">      29185 : }</span></a>
<span class="lineNum">    1807 </span>            : 
<span class="lineNum">    1808 </span>            : static void end_element   (GMarkupParseContext *context,
<span class="lineNum">    1809 </span>            :                            const gchar         *element_name,
<span class="lineNum">    1810 </span>            :                            gpointer             user_data,
<span class="lineNum">    1811 </span>            :                            GError             **error)
<span class="lineNum">    1812 </span>            : {
<span class="lineNum">    1813 </span><span class="lineCov">      29185 :         AppConfigInfo* app_config = (AppConfigInfo*) user_data;</span>
<span class="lineNum">    1814 </span>            :         
<span class="lineNum">    1815 </span><span class="lineCov">      29185 :         if (strcmp (element_name, &quot;configuration&quot;) == 0) {</span>
<span class="lineNum">    1816 </span><span class="lineCov">       1045 :                 app_config-&gt;configuration_count--;</span>
<span class="lineNum">    1817 </span><span class="lineCov">      29185 :         } else if (strcmp (element_name, &quot;startup&quot;) == 0) {</span>
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :                 app_config-&gt;startup_count--;</span>
<span class="lineNum">    1819 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1820 </span><span class="lineCov">      29185 : }</span>
<span class="lineNum">    1821 </span>            : 
<span class="lineNum">    1822 </span>            : static const GMarkupParser 
<span class="lineNum">    1823 </span>            : mono_parser = {
<span class="lineNum">    1824 </span>            :         start_element,
<span class="lineNum">    1825 </span>            :         end_element,
<span class="lineNum">    1826 </span>            :         NULL,
<span class="lineNum">    1827 </span>            :         NULL,
<span class="lineNum">    1828 </span>            :         NULL
<span class="lineNum">    1829 </span>            : };
<a name="1830"><span class="lineNum">    1830 </span>            : </a>
<span class="lineNum">    1831 </span>            : static AppConfigInfo *
<span class="lineNum">    1832 </span>            : app_config_parse (const char *exe_filename)
<span class="lineNum">    1833 </span>            : {
<span class="lineNum">    1834 </span>            :         AppConfigInfo *app_config;
<span class="lineNum">    1835 </span>            :         GMarkupParseContext *context;
<span class="lineNum">    1836 </span>            :         char *text;
<span class="lineNum">    1837 </span>            :         gsize len;
<span class="lineNum">    1838 </span>            :         const char *bundled_config;
<span class="lineNum">    1839 </span>            :         char *config_filename;
<span class="lineNum">    1840 </span>            : 
<span class="lineNum">    1841 </span><span class="lineCov">       3285 :         bundled_config = mono_config_string_for_assembly_file (exe_filename);</span>
<span class="lineNum">    1842 </span>            : 
<span class="lineNum">    1843 </span><span class="lineCov">       3285 :         if (bundled_config) {</span>
<span class="lineNum">    1844 </span><span class="lineNoCov">          0 :                 text = g_strdup (bundled_config);</span>
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 :                 len = strlen (text);</span>
<span class="lineNum">    1846 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1847 </span><span class="lineCov">       3285 :                 config_filename = g_strconcat (exe_filename, &quot;.config&quot;, NULL);</span>
<span class="lineNum">    1848 </span>            : 
<span class="lineNum">    1849 </span><span class="lineCov">       3285 :                 if (!g_file_get_contents (config_filename, &amp;text, &amp;len, NULL)) {</span>
<span class="lineNum">    1850 </span><span class="lineCov">       2240 :                         g_free (config_filename);</span>
<span class="lineNum">    1851 </span><span class="lineCov">       2240 :                         return NULL;</span>
<span class="lineNum">    1852 </span>            :                 }
<span class="lineNum">    1853 </span><span class="lineCov">       1045 :                 g_free (config_filename);</span>
<span class="lineNum">    1854 </span>            :         }
<span class="lineNum">    1855 </span>            : 
<span class="lineNum">    1856 </span><span class="lineCov">       1045 :         app_config = g_new0 (AppConfigInfo, 1);</span>
<span class="lineNum">    1857 </span>            : 
<span class="lineNum">    1858 </span><span class="lineCov">       1045 :         context = g_markup_parse_context_new (&amp;mono_parser, (GMarkupParseFlags)0, app_config, NULL);</span>
<span class="lineNum">    1859 </span><span class="lineCov">       1045 :         if (g_markup_parse_context_parse (context, text, len, NULL)) {</span>
<span class="lineNum">    1860 </span><span class="lineCov">       1045 :                 g_markup_parse_context_end_parse (context, NULL);</span>
<span class="lineNum">    1861 </span><span class="lineCov">       1045 :         }</span>
<span class="lineNum">    1862 </span><span class="lineCov">       1045 :         g_markup_parse_context_free (context);</span>
<span class="lineNum">    1863 </span><span class="lineCov">       1045 :         g_free (text);</span>
<span class="lineNum">    1864 </span><span class="lineCov">       1045 :         return app_config;</span>
<span class="lineNum">    1865 </span><span class="lineCov">       3285 : }</span>
<a name="1866"><span class="lineNum">    1866 </span>            : </a>
<span class="lineNum">    1867 </span>            : static void 
<span class="lineNum">    1868 </span>            : app_config_free (AppConfigInfo* app_config)
<span class="lineNum">    1869 </span>            : {
<span class="lineNum">    1870 </span>            :         char *rt;
<span class="lineNum">    1871 </span><span class="lineCov">       1045 :         GSList *list = app_config-&gt;supported_runtimes;</span>
<span class="lineNum">    1872 </span><span class="lineCov">       2090 :         while (list != NULL) {</span>
<span class="lineNum">    1873 </span><span class="lineNoCov">          0 :                 rt = (char*)list-&gt;data;</span>
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 :                 g_free (rt);</span>
<span class="lineNum">    1875 </span><span class="lineNoCov">          0 :                 list = g_slist_next (list);</span>
<span class="lineNum">    1876 </span>            :         }
<span class="lineNum">    1877 </span><span class="lineCov">       1045 :         g_slist_free (app_config-&gt;supported_runtimes);</span>
<span class="lineNum">    1878 </span><span class="lineCov">       1045 :         g_free (app_config-&gt;required_runtime);</span>
<span class="lineNum">    1879 </span><span class="lineCov">       1045 :         g_free (app_config);</span>
<span class="lineNum">    1880 </span><span class="lineCov">       1045 : }</span>
<span class="lineNum">    1881 </span>            : 
<a name="1882"><span class="lineNum">    1882 </span>            : </a>
<span class="lineNum">    1883 </span>            : static const MonoRuntimeInfo*
<span class="lineNum">    1884 </span>            : get_runtime_by_version (const char *version)
<span class="lineNum">    1885 </span>            : {
<span class="lineNum">    1886 </span>            :         int n;
<span class="lineNum">    1887 </span><span class="lineCov">       3285 :         int max = G_N_ELEMENTS (supported_runtimes);</span>
<span class="lineNum">    1888 </span>            :         int vlen;
<span class="lineNum">    1889 </span>            : 
<span class="lineNum">    1890 </span><span class="lineCov">       3285 :         if (!version)</span>
<span class="lineNum">    1891 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1892 </span>            : 
<span class="lineNum">    1893 </span><span class="lineCov">       6570 :         for (n=0; n&lt;max; n++) {</span>
<span class="lineNum">    1894 </span><span class="lineCov">       3285 :                 if (strcmp (version, supported_runtimes[n].runtime_version) == 0)</span>
<span class="lineNum">    1895 </span><span class="lineCov">       3285 :                         return &amp;supported_runtimes[n];</span>
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1897 </span>            :         
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 :         vlen = strlen (version);</span>
<span class="lineNum">    1899 </span><span class="lineNoCov">          0 :         if (vlen &gt;= 4 &amp;&amp; version [1] - '0' &gt;= 4) {</span>
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :                 for (n=0; n&lt;max; n++) {</span>
<span class="lineNum">    1901 </span><span class="lineNoCov">          0 :                         if (strncmp (version, supported_runtimes[n].runtime_version, 4) == 0)</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :                                 return &amp;supported_runtimes[n];</span>
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1905 </span>            :         
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1907 </span><span class="lineCov">       3285 : }</span>
<a name="1908"><span class="lineNum">    1908 </span>            : </a>
<span class="lineNum">    1909 </span>            : static void
<span class="lineNum">    1910 </span>            : get_runtimes_from_exe (const char *exe_file, MonoImage **exe_image, const MonoRuntimeInfo** runtimes)
<span class="lineNum">    1911 </span>            : {
<span class="lineNum">    1912 </span>            :         AppConfigInfo* app_config;
<span class="lineNum">    1913 </span>            :         char *version;
<span class="lineNum">    1914 </span><span class="lineCov">       3285 :         const MonoRuntimeInfo* runtime = NULL;</span>
<span class="lineNum">    1915 </span><span class="lineCov">       3285 :         MonoImage *image = NULL;</span>
<span class="lineNum">    1916 </span>            :         
<span class="lineNum">    1917 </span><span class="lineCov">       3285 :         app_config = app_config_parse (exe_file);</span>
<span class="lineNum">    1918 </span>            :         
<span class="lineNum">    1919 </span><span class="lineCov">       3285 :         if (app_config != NULL) {</span>
<span class="lineNum">    1920 </span>            :                 /* Check supportedRuntime elements, if none is supported, fail.
<span class="lineNum">    1921 </span>            :                  * If there are no such elements, look for a requiredRuntime element.
<span class="lineNum">    1922 </span>            :                  */
<span class="lineNum">    1923 </span><span class="lineCov">       1045 :                 if (app_config-&gt;supported_runtimes != NULL) {</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :                         int n = 0;</span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :                         GSList *list = app_config-&gt;supported_runtimes;</span>
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :                         while (list != NULL) {</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :                                 version = (char*) list-&gt;data;</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :                                 runtime = get_runtime_by_version (version);</span>
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :                                 if (runtime != NULL)</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :                                         runtimes [n++] = runtime;</span>
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :                                 list = g_slist_next (list);</span>
<span class="lineNum">    1932 </span>            :                         }
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :                         runtimes [n] = NULL;</span>
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :                         app_config_free (app_config);</span>
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1936 </span>            :                 }
<span class="lineNum">    1937 </span>            :                 
<span class="lineNum">    1938 </span>            :                 /* Check the requiredRuntime element. This is for 1.0 apps only. */
<span class="lineNum">    1939 </span><span class="lineCov">       1045 :                 if (app_config-&gt;required_runtime != NULL) {</span>
<span class="lineNum">    1940 </span><span class="lineNoCov">          0 :                         runtimes [0] = get_runtime_by_version (app_config-&gt;required_runtime);</span>
<span class="lineNum">    1941 </span><span class="lineNoCov">          0 :                         runtimes [1] = NULL;</span>
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :                         app_config_free (app_config);</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1944 </span>            :                 }
<span class="lineNum">    1945 </span><span class="lineCov">       1045 :                 app_config_free (app_config);</span>
<span class="lineNum">    1946 </span><span class="lineCov">       1045 :         }</span>
<span class="lineNum">    1947 </span>            :         
<span class="lineNum">    1948 </span>            :         /* Look for a runtime with the exact version */
<span class="lineNum">    1949 </span><span class="lineCov">       3285 :         image = mono_assembly_open_from_bundle (exe_file, NULL, FALSE);</span>
<span class="lineNum">    1950 </span>            : 
<span class="lineNum">    1951 </span><span class="lineCov">       3285 :         if (image == NULL)</span>
<span class="lineNum">    1952 </span><span class="lineCov">       3285 :                 image = mono_image_open (exe_file, NULL);</span>
<span class="lineNum">    1953 </span>            : 
<span class="lineNum">    1954 </span><span class="lineCov">       3285 :         if (image == NULL) {</span>
<span class="lineNum">    1955 </span>            :                 /* The image is wrong or the file was not found. In this case return
<span class="lineNum">    1956 </span>            :                  * a default runtime and leave to the initialization method the work of
<span class="lineNum">    1957 </span>            :                  * reporting the error.
<span class="lineNum">    1958 </span>            :                  */
<span class="lineNum">    1959 </span><span class="lineNoCov">          0 :                 runtimes [0] = get_runtime_by_version (DEFAULT_RUNTIME_VERSION);</span>
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :                 runtimes [1] = NULL;</span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1962 </span>            :         }
<span class="lineNum">    1963 </span>            : 
<span class="lineNum">    1964 </span><span class="lineCov">       3285 :         *exe_image = image;</span>
<span class="lineNum">    1965 </span>            : 
<span class="lineNum">    1966 </span><span class="lineCov">       3285 :         runtimes [0] = get_runtime_by_version (image-&gt;version);</span>
<span class="lineNum">    1967 </span><span class="lineCov">       3285 :         runtimes [1] = NULL;</span>
<span class="lineNum">    1968 </span><span class="lineCov">       6570 : }</span>
<span class="lineNum">    1969 </span>            : 
<span class="lineNum">    1970 </span>            : 
<span class="lineNum">    1971 </span>            : /**
<span class="lineNum">    1972 </span>            :  * mono_get_runtime_info:
<span class="lineNum">    1973 </span>            :  *
<span class="lineNum">    1974 </span>            :  * Returns: the version of the current runtime instance.
<a name="1975"><span class="lineNum">    1975 </span>            :  */</a>
<span class="lineNum">    1976 </span>            : const MonoRuntimeInfo*
<span class="lineNum">    1977 </span>            : mono_get_runtime_info (void)
<span class="lineNum">    1978 </span>            : {
<span class="lineNum">    1979 </span><span class="lineCov">     292008 :         return current_runtime;</span>
<span class="lineNum">    1980 </span>            : }
<span class="lineNum">    1981 </span>            : 
<span class="lineNum">    1982 </span>            : /**
<span class="lineNum">    1983 </span>            :  * mono_framework_version:
<span class="lineNum">    1984 </span>            :  *
<span class="lineNum">    1985 </span>            :  * Return the major version of the framework curently executing.
<a name="1986"><span class="lineNum">    1986 </span>            :  */</a>
<span class="lineNum">    1987 </span>            : int
<span class="lineNum">    1988 </span>            : mono_framework_version (void)
<span class="lineNum">    1989 </span>            : {
<span class="lineNum">    1990 </span><span class="lineNoCov">          0 :         return current_runtime-&gt;framework_version [0] - '0';</span>
<span class="lineNum">    1991 </span>            : }
<a name="1992"><span class="lineNum">    1992 </span>            : </a>
<span class="lineNum">    1993 </span>            : void
<span class="lineNum">    1994 </span>            : mono_enable_debug_domain_unload (gboolean enable)
<span class="lineNum">    1995 </span>            : {
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :         debug_domain_unload = enable;</span>
<span class="lineNum">    1997 </span><span class="lineNoCov">          0 : }</span>
<a name="1998"><span class="lineNum">    1998 </span>            : </a>
<span class="lineNum">    1999 </span>            : MonoAotCacheConfig *
<span class="lineNum">    2000 </span>            : mono_get_aot_cache_config (void)
<span class="lineNum">    2001 </span>            : {
<span class="lineNum">    2002 </span><span class="lineCov">      72158 :         return &amp;aot_cache_config;</span>
<span class="lineNum">    2003 </span>            : }
<a name="2004"><span class="lineNum">    2004 </span>            : </a>
<span class="lineNum">    2005 </span>            : void
<span class="lineNum">    2006 </span>            : mono_domain_lock (MonoDomain *domain)
<span class="lineNum">    2007 </span>            : {
<span class="lineNum">    2008 </span><span class="lineCov">  981178788 :         mono_locks_coop_acquire (&amp;domain-&gt;lock, DomainLock);</span>
<span class="lineNum">    2009 </span><span class="lineCov">  245349706 : }</span>
<a name="2010"><span class="lineNum">    2010 </span>            : </a>
<span class="lineNum">    2011 </span>            : void
<span class="lineNum">    2012 </span>            : mono_domain_unlock (MonoDomain *domain)
<span class="lineNum">    2013 </span>            : {
<span class="lineNum">    2014 </span><span class="lineCov">  981379401 :         mono_locks_coop_release (&amp;domain-&gt;lock, DomainLock);</span>
<span class="lineNum">    2015 </span><span class="lineCov">  245346533 : }</span>
<a name="2016"><span class="lineNum">    2016 </span>            : </a>
<span class="lineNum">    2017 </span>            : GPtrArray*
<span class="lineNum">    2018 </span>            : mono_domain_get_assemblies (MonoDomain *domain, gboolean refonly)
<span class="lineNum">    2019 </span>            : {
<span class="lineNum">    2020 </span>            :         GSList *tmp;
<span class="lineNum">    2021 </span>            :         GPtrArray *assemblies;
<span class="lineNum">    2022 </span>            :         MonoAssembly *ass;
<span class="lineNum">    2023 </span>            : 
<span class="lineNum">    2024 </span><span class="lineNoCov">          0 :         assemblies = g_ptr_array_new ();</span>
<span class="lineNum">    2025 </span><span class="lineNoCov">          0 :         mono_domain_assemblies_lock (domain);</span>
<span class="lineNum">    2026 </span><span class="lineNoCov">          0 :         for (tmp = domain-&gt;domain_assemblies; tmp; tmp = tmp-&gt;next) {</span>
<span class="lineNum">    2027 </span><span class="lineNoCov">          0 :                 ass = (MonoAssembly *)tmp-&gt;data;</span>
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :                 if (refonly != ass-&gt;ref_only)</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2030 </span><span class="lineNoCov">          0 :                 if (ass-&gt;corlib_internal)</span>
<span class="lineNum">    2031 </span><span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 :                 g_ptr_array_add (assemblies, ass);</span>
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :         mono_domain_assemblies_unlock (domain);</span>
<span class="lineNum">    2035 </span><span class="lineNoCov">          0 :         return assemblies;</span>
<span class="lineNum">    2036 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
